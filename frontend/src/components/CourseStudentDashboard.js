import React, { useState, useEffect, useMemo, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Area, AreaChart, CartesianGrid, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts';
import dayjs from 'dayjs';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import { DateTimePicker } from '@mui/x-date-pickers/DateTimePicker';
import { API_BASE_URL } from '../config/api';
import TaskDetailModal from './TaskDetailModal';
import RevisionModal from './RevisionModal';
import CompletedTaskModal from './CompletedTaskModal';
import EvaluationModal from './EvaluationModal';
import ProjectEvaluationModal from './ProjectEvaluationModal';
import EvaluationDetailModal from './EvaluationDetailModal';
import {
  FaHome, 
  FaPaperclip, 
  FaLock,
  FaSort,
  FaWind,
  FaExternalLinkAlt,
  FaUserGraduate,
  FaCheckCircle,
  FaBars,
  FaArrowLeft,
  FaProjectDiagram, 
  FaTasks, 
  FaEdit,
  FaUsers, 
  FaGraduationCap, 
  FaBullhorn, 
  FaBell, 
  FaClipboardList,
  FaChevronDown,
  FaClock,
  FaCalendarAlt,
  FaUser,
  FaChartBar,
  FaChartLine,
  FaComments,
  FaArrowRight,
  FaTimes,
  FaUserPlus,
  FaPlus,
  FaUserCheck,
  FaSearch,
  FaChevronUp,
  FaCheck,
  FaBookmark,
  FaShare,
  FaCheckDouble,
  FaLayerGroup,
  FaWindowMaximize,
  FaCog,
  FaEnvelope,
  FaEnvelopeOpen,
  FaFilter,
  FaExclamationTriangle,
  FaBan,
  FaFileAlt,
  FaCloudUploadAlt,
  FaUpload,
  FaFile,
  FaChevronRight,
  FaChevronLeft,
  FaUndo,
  FaRedo,
  FaCommentAlt,
  FaCommentSlash,
  FaPaperPlane,
  FaUserTie,
  FaInfoCircle,
  FaHistory,
  FaComment,
  FaSpinner,
  FaStar,
  FaDownload,
  FaChalkboardTeacher,
  FaBook,
  FaCode,
  FaEye,
  FaExclamationCircle,
  FaCalendar,
  FaClipboardCheck,
  FaPlay,
  FaStop,
  FaHandPointRight,
  FaClipboard,
  FaPause,
  FaListCheck,
  FaFilePdf,
  FaEyeSlash,
  FaTrash,
  FaInbox,
  FaFolder,
  FaSyncAlt,
  FaTimesCircle
} from 'react-icons/fa';
import './CourseStudentDashboard.css';
import './TaskManagement.css';
import './EnhancedSubmissions.css';
import { apiConfig, apiCall } from '../config/api';
import { AppSidebar } from './app-sidebar';
import { ChartAreaInteractive } from './chart-area-interactive';
import { DataTable } from './data-table';
import { SectionCards } from './section-cards';
import { SiteHeader } from './site-header';
import { SidebarProvider, SidebarInset } from './ui/sidebar';
import { Separator } from './ui/separator';
import { SidebarTrigger } from './ui/sidebar';
import Squares from './Squares';
import data from '../data.json';
import Gantt from 'frappe-gantt';
import html2canvas from 'html2canvas';

// Suppress ResizeObserver loop completed notification error
// This is a known issue with React and ResizeObserver that doesn't affect functionality
const originalError = console.error;
if (typeof window !== 'undefined') {
  console.error = (...args) => {
    if (
      typeof args[0] === 'string' &&
      args[0].includes('ResizeObserver loop completed with undelivered notifications')
    ) {
      return;
    }
    originalError.call(console, ...args);
  };
}

// Helper function to get profile image URLs (backend already provides proper URLs)
const getProfileImageUrl = (student) => {
  if (!student?.profile_image_url) return null;
  
  // Backend already provides proper Supabase URLs, use them directly
  return student.profile_image_url;
};

// Helper function to format file types for display
const formatFileTypes = (fileTypes) => {
  if (!fileTypes || fileTypes === '[]' || (Array.isArray(fileTypes) && fileTypes.length === 0)) {
    return 'Any file type allowed';
  }
  
  try {
    const typesArray = typeof fileTypes === 'string' ? JSON.parse(fileTypes) : fileTypes;
    if (!Array.isArray(typesArray) || typesArray.length === 0) {
      return 'Any file type allowed';
    }
    
    // Format as readable list
    if (typesArray.length <= 3) {
      return typesArray.join(', ');
    } else {
      return `${typesArray.slice(0, 3).join(', ')}, +${typesArray.length - 3} more`;
    }
  } catch (e) {
    return 'Any file type allowed';
  }
};

const getNavItems = (userRole) => {
  const regularItems = [
    { id: 'course-overview', label: 'Course Overview', icon: FaHome },
    { id: 'project-dashboard', label: 'Task Dashboard', icon: FaProjectDiagram },
    { id: 'my-group', label: 'My Group', icon: FaUsers },
    { id: 'my-grades', label: 'My Grades', icon: FaGraduationCap },
    { id: 'announcements', label: 'Announcements', icon: FaBullhorn },
    { id: 'notifications', label: 'Notifications', icon: FaBell },
    { id: 'evaluations', label: 'Evaluations', icon: FaClipboardList }
  ];

  const leaderItems = userRole === 'leader' ? [
    { id: 'submission-checking', label: 'Submission Checking', icon: FaClipboardCheck },
    { id: 'task-assignment', label: 'Task Assignment', icon: FaClipboardList },
    { id: 'deliverables-submission', label: 'Deliverables Submission', icon: FaFileAlt }
  ] : [];

  return { regularItems, leaderItems };
};

// Modal Loading Component
const ModalLoadingOverlay = ({ isVisible }) => {
  if (!isVisible) return null;
  
  return (
    <div style={{
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      borderRadius: '20px'
    }}>
      <div style={{
        width: '40px',
        height: '40px',
        border: '3px solid #f3f3f3',
        borderTop: '3px solid #34656D', // To-Do color
        borderRadius: '50%',
        animation: 'spin 1s linear infinite',
        marginBottom: '1rem'
      }}></div>
      <div style={{
        fontSize: '1rem',
        fontWeight: '600',
        color: '#34656D',
        textAlign: 'center'
      }}>
        Loading...
      </div>
    </div>
  );
};

// Member Phase Task Card Component
const MemberPhaseTaskCard = ({ member, phase, projectId, downloadFile }) => {
  const [memberTasks, setMemberTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isExpanded, setIsExpanded] = useState(false);

  useEffect(() => {
    const fetchMemberTasks = async () => {
      if (!projectId || !member.student_id || !phase.id) return;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(
          `${apiConfig.baseURL}/api/student-leader/projects/${projectId}/members/${member.student_id}/submissions`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (response.ok) {
          const tasks = await response.json();
          console.log(`üîç [DEBUG] Raw tasks data for ${member.name}:`, tasks);
          
          // Check if this is Project Completion
          const isProjectCompletion = phase.isProjectCompletion || phase.phase_number === 'project-completion';
          
          let phaseTasks;
          if (isProjectCompletion) {
            // For Project Completion: Show ALL tasks from ALL phases (not just approved ones)
            // Show the BEST submission for each task using the same priority as backend:
            // 1. Approved revisions, 2. Approved originals, 3. Latest revisions, 4. Latest originals, 5. No submission
            phaseTasks = tasks.filter(task => {
              // Include any task that has a submission (any status) or has been assigned
              const hasSubmission = task.hasSubmission || task.submission;
              const hasStatus = task.status && task.status !== 'no_submission';
              console.log(`üîç [DEBUG] Project Completion - Task ${task.task_title}: phase=${task.phase_info?.phase_number}, status=${task.status}, hasSubmission=${hasSubmission}, submissionType=${task.submissionType}`);
              return true; // Include all tasks for Project Completion to show complete overview
            });
            console.log(`üîç [DEBUG] Found ${phaseTasks.length} total tasks for ${member.name} in Project Completion (all phases)`);
          } else {
            // For regular phases: Only show completed/approved tasks for this specific phase
            phaseTasks = tasks.filter(task => {
              const isCorrectPhase = task.phase_info && task.phase_info.phase_number === phase.phase_number;
              const isCompleted = task.status === 'completed'; // Task is completed when submission is approved
              console.log(`üîç [DEBUG] Phase ${phase.phase_number} - Task ${task.task_title}: phase=${task.phase_info?.phase_number}, status=${task.status}, isCorrectPhase=${isCorrectPhase}, isCompleted=${isCompleted}`);
              return isCorrectPhase && isCompleted;
            });
            console.log(`üîç [DEBUG] Found ${phaseTasks.length} completed tasks for ${member.name} in phase ${phase.phase_number}`);
          }
          
          setMemberTasks(phaseTasks);
        } else {
          console.warn('Failed to fetch member tasks');
          setMemberTasks([]);
        }
      } catch (error) {
        console.error('Error fetching member tasks:', error);
        setMemberTasks([]);
      } finally {
        setLoading(false);
      }
    };

    fetchMemberTasks();
  }, [projectId, member.student_id, phase.id, phase.phase_number]);

  if (loading) {
    return (
      <div className="member-dropdown-card">
        <div className="member-dropdown-header">
          <div className="member-info-row">
            <div className="member-avatar">
              <div className="avatar-circle">
                {member.name?.charAt(0) || '?'}
              </div>
            </div>
            <div className="member-details">
              <span className="member-name">{member.name}</span>
              <span className="member-role">{member.role}</span>
            </div>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              color: '#872341',
              fontSize: '14px'
            }}>
              <div style={{
                width: '16px',
                height: '16px',
                border: '2px solid #872341',
                borderTopColor: 'transparent',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite'
              }}></div>
              Loading...
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="member-dropdown-card">
      <div 
        className="member-dropdown-header" 
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="member-info-row">
          <div className="member-avatar">
            <div className="avatar-circle">
              {member.name?.charAt(0) || '?'}
            </div>
          </div>
          <div className="member-details">
            <span className="member-name">{member.name}</span>
            <span className="member-role">{member.role}</span>
          </div>
          <div className="submission-count">
            {phase.isProjectCompletion ? (
              `${memberTasks.length} task${memberTasks.length !== 1 ? 's' : ''}`
            ) : (
              `${memberTasks.length} approved task${memberTasks.length !== 1 ? 's' : ''}`
            )}
          </div>
          <FaChevronDown className={`dropdown-icon ${isExpanded ? 'expanded' : ''}`} />
        </div>
      </div>
      
      {isExpanded && (
        <div className="member-dropdown-content">
          {memberTasks.length > 0 ? (
            <div className="submissions-list">
              {memberTasks.map((task, index) => (
                <div key={task.task_id || index} className="submission-item">
                  <div className="submission-header">
                    <h4 className="task-title">{task.task_title}</h4>
                    <div className={`task-status status-pill ${
                      task.status === 'completed' || task.status === 'approved' ? 'status-approved' :
                      task.status === 'revision_requested' ? 'status-revision' :
                      task.status === 'submitted' || task.status === 'pending' ? 'status-pending' :
                      'status-missing'
                    }`}>
                      {task.status === 'completed' ? 'approved' :
                       task.status === 'approved' ? 'approved' :
                       task.status === 'revision_requested' ? 'needs revision' :
                       task.status === 'submitted' || task.status === 'pending' ? 'pending review' :
                       task.submissionType === 'no_submission' ? 'no submission' : task.status || 'unknown'}
                    </div>
                    {task.submissionType && phase.isProjectCompletion && (
                      <div className="submission-priority">
                        {task.submissionType === 'approved_revision' ? '‚úÖ Best: Approved Revision' :
                         task.submissionType === 'approved_original' ? '‚úÖ Best: Approved Original' :
                         task.submissionType === 'latest_revision' ? 'üìù Latest Revision' :
                         task.submissionType === 'latest_original' ? 'üìã Latest Original' :
                         '‚ùå No Submission'}
                      </div>
                    )}
                  </div>
                  {task.submitted_at && (
                    <p className="submission-date">
                      Submitted: {new Date(task.submitted_at).toLocaleDateString()}
                    </p>
                  )}
                  {task.file_urls && task.file_urls.length > 0 ? (
                    <div className="download-section">
                      {task.file_urls.map((fileUrl, fileIndex) => (
                        <button
                          key={fileIndex}
                          className="simple-download-button"
                          onClick={() => downloadFile(fileUrl, `${task.task_title}_file_${fileIndex + 1}`)}
                          title={`Download file ${fileIndex + 1}`}
                        >
                          <FaDownload className="download-icon" />
                          Download File
                        </button>
                      ))}
                    </div>
                  ) : (
                    <p className="no-files-message">No files submitted</p>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <div className="no-submissions-message">
              {phase.isProjectCompletion ? (
                "No tasks assigned to this member across all phases"
              ) : (
                `No approved tasks for Phase ${phase.phase_number}`
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

const CourseStudentDashboard = () => {

  const { courseId } = useParams();
  const navigate = useNavigate();
  
  // State management
  const [activeTab, setActiveTab] = useState('course-overview');

  // Helper function to get page title based on active tab
  const getPageTitle = () => {
    const titles = {
      'course-overview': 'Course Overview',
      'project-dashboard': 'Task Dashboard',
      'my-group': 'My Group',
      'my-grades': 'My Grades',
      'announcements': 'Announcements',
      'notifications': 'Notifications',
      'evaluations': 'Evaluations',
      'submission-checking': 'Submission Checking',
      'task-assignment': 'Task Assignment',
      'deliverables-submission': 'Deliverables Submission'
    };
    const title = titles[activeTab] || 'Course Dashboard';
    console.log('üéØ Page Title Update - activeTab:', activeTab, 'title:', title);
    return title;
  };
  
  // Submission Review states
  const [submissionReviewView, setSubmissionReviewView] = useState({
    loading: false,
    selectedProject: null,
    selectedMember: null,
    submissions: [],
    availableProjects: [],
    availableMembers: [],
    filters: {
      status: 'all', // all, pending, approved, revision_requested
      member: 'all',
      phase: 'all'
    },
    sortBy: 'submission_date',
    sortOrder: 'desc'
  });
  // Dropdown states for submission review
  const [showSubmissionProjectDropdown, setShowSubmissionProjectDropdown] = useState(false);
  const [showSubmissionMemberDropdown, setShowSubmissionMemberDropdown] = useState(false);
  const [selectedProject, setSelectedProject] = useState(null);
  const [currentPhase, setCurrentPhase] = useState(null);
  const [viewedPhase, setViewedPhase] = useState(null); // Phase currently being viewed in dashboard
  const [isProjectSwitching, setIsProjectSwitching] = useState(false); // Flag to prevent phase detection during project switch
  const [showProjectDropdown, setShowProjectDropdown] = useState(false);
  const [showMemberModal, setShowMemberModal] = useState(false);
  const [selectedMember, setSelectedMember] = useState(null);
  const [showProjectPhases, setShowProjectPhases] = useState(false);
  const [showPhaseModal, setShowPhaseModal] = useState(false);
  const [selectedPhaseForModal, setSelectedPhaseForModal] = useState(null);
  const [showSortDropdown, setShowSortDropdown] = useState(false);
  const [sortBy, setSortBy] = useState('dueDate');

  // Separate dropdown states for each column
  const [showTodoSortDropdown, setShowTodoSortDropdown] = useState(false);
  const [showPendingSortDropdown, setShowPendingSortDropdown] = useState(false);
  const [showTasksSortDropdown, setShowTasksSortDropdown] = useState(false);
  const [showRevisionSortDropdown, setShowRevisionSortDropdown] = useState(false);
  const [showCompletedSortDropdown, setShowCompletedSortDropdown] = useState(false);
  const [showOverviewTasksSortDropdown, setShowOverviewTasksSortDropdown] = useState(false);
  
  // Course Overview Tasks filter state
  const [showOverviewTasksFilterDropdown, setShowOverviewTasksFilterDropdown] = useState(false);
  const [overviewTasksFilter, setOverviewTasksFilter] = useState('all');

  // Task detail modal state
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);
  const [selectedPhase, setSelectedPhase] = useState(null);
  const [taskModalSource, setTaskModalSource] = useState(null); // 'todo', 'pending', 'revision', 'completed'

  // Revision modal state
  const [showRevisionModal, setShowRevisionModal] = useState(false);
  const [selectedRevisionTask, setSelectedRevisionTask] = useState(null);
  const [selectedRevisionSubmissionId, setSelectedRevisionSubmissionId] = useState(null);

  // Completed modal state
  const [showCompletedModal, setShowCompletedModal] = useState(false);
  const [selectedCompletedTask, setSelectedCompletedTask] = useState(null);

  // Evaluation modal state
  const [showEvaluationModal, setShowEvaluationModal] = useState(false);
  const [selectedEvaluation, setSelectedEvaluation] = useState(null);

  // Project evaluation modal state
  const [showProjectEvalModal, setShowProjectEvalModal] = useState(false);
  const [selectedProjectEvaluation, setSelectedProjectEvaluation] = useState(null);

  // Evaluation detail modal state (new for Evaluations tab)
  const [showEvaluationDetailModal, setShowEvaluationDetailModal] = useState(false);
  const [selectedEvaluationDetail, setSelectedEvaluationDetail] = useState(null);

  // Phase Rubric and Evaluation Form modal states
  const [showPhaseRubricModal, setShowPhaseRubricModal] = useState(false);
  const [showPhaseEvalFormModal, setShowPhaseEvalFormModal] = useState(false);
  const [phaseRubricData, setPhaseRubricData] = useState(null);
  const [phaseEvalFormData, setPhaseEvalFormData] = useState(null);
  const [rubricLoading, setRubricLoading] = useState(false);
  const [evalFormLoading, setEvalFormLoading] = useState(false);
  const [currentRubricPhase, setCurrentRubricPhase] = useState(null);
  const [currentEvalFormPhase, setCurrentEvalFormPhase] = useState(null);

  // Breathe phase modal state
  const [showBreatheModal, setShowBreatheModal] = useState(false);
  const [selectedBreathePhase, setSelectedBreathePhase] = useState(null);

  // Extension Request modal states
  const [showExtensionRequestModal, setShowExtensionRequestModal] = useState(false);
  const [extensionRequestReason, setExtensionRequestReason] = useState('');
  const [submittingExtensionRequest, setSubmittingExtensionRequest] = useState(false);

  // Gantt Chart Modals - Separate from other modals
  const [showGanttPhaseModal, setShowGanttPhaseModal] = useState(false);
  const [ganttSelectedPhase, setGanttSelectedPhase] = useState(null);

  const [showGanttTaskModal, setShowGanttTaskModal] = useState(false);
  const [ganttSelectedTask, setGanttSelectedTask] = useState(null);
  const [ganttSelectedPhaseForTask, setGanttSelectedPhaseForTask] = useState(null);
  const [ganttSelectedMemberForTask, setGanttSelectedMemberForTask] = useState(null);

  const [showGanttEvalModal, setShowGanttEvalModal] = useState(false);
  const [ganttSelectedEval, setGanttSelectedEval] = useState(null);
  const [ganttEvalType, setGanttEvalType] = useState(null); // 'phase' or 'project'

  // Add click outside handler for sort dropdowns
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Don't interfere with phase selector or navigation buttons
      if (event.target.closest('.phase-circle') || 
          event.target.closest('.phase-nav-button') || 
          event.target.closest('.phase-navigation-row') ||
          event.target.closest('.reset-to-current-phase-btn')) {
        return;
      }
      
      if (showSortDropdown && !event.target.closest('.sort-dropdown-container')) {
        setShowSortDropdown(false);
      }
      if (showTodoSortDropdown && !event.target.closest('.todo-sort-dropdown-container')) {
        setShowTodoSortDropdown(false);
      }
      if (showPendingSortDropdown && !event.target.closest('.pending-sort-dropdown-container')) {
        setShowPendingSortDropdown(false);
      }
      if (showTasksSortDropdown && !event.target.closest('.tasks-sort-dropdown-container')) {
        setShowTasksSortDropdown(false);
      }
      if (showRevisionSortDropdown && !event.target.closest('.revision-sort-dropdown-container')) {
        setShowRevisionSortDropdown(false);
      }
      if (showCompletedSortDropdown && !event.target.closest('.completed-sort-dropdown-container')) {
        setShowCompletedSortDropdown(false);
      }
      // Handle main project dashboard dropdown
      if (showProjectDropdown && !event.target.closest('.project-dropdown-wrapper')) {
        setShowProjectDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showSortDropdown, showTodoSortDropdown, showPendingSortDropdown, showTasksSortDropdown, showRevisionSortDropdown, showCompletedSortDropdown, showProjectDropdown]);



  // Add these states to your existing state declarations
  const [selectedTodoProject, setSelectedTodoProject] = useState(null);
  const [showTodoDropdown, setShowTodoDropdown] = useState(false);
  const [todoActivities, setTodoActivities] = useState([]);
  const [selectedActivity, setSelectedActivity] = useState(null);
  const [activityView, setActivityView] = useState('submissions'); // 'submissions' or 'feedback'
  const [activeFilter, setActiveFilter] = useState('Active');
  const [todoLoading, setTodoLoading] = useState(false);

  // Sidebar toggle state
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

  // Add these states to your existing state declarations in CourseStudentDashboard component
  const [selectedTodoPhase, setSelectedTodoPhase] = useState(null);
  const [showPhaseDropdown, setShowPhaseDropdown] = useState(false);
  const [availablePhases, setAvailablePhases] = useState([]);
  const [phaseFilterMode, setPhaseFilterMode] = useState('all');

  // Add these states to your existing state declarations
  const [selectedGroupProject, setSelectedGroupProject] = useState(null);
  const [showGroupProjectDropdown, setShowGroupProjectDropdown] = useState(false);
  const [selectedGroupPhase, setSelectedGroupPhase] = useState(null);
  const [showGroupPhaseDropdown, setShowGroupPhaseDropdown] = useState(false);
  const [groupAvailablePhases, setGroupAvailablePhases] = useState([]);
  const [groupPhaseFilterMode, setGroupPhaseFilterMode] = useState('all');
  const [selectedGroupMember, setSelectedGroupMember] = useState(null);
  const [memberAssignedTasks, setMemberAssignedTasks] = useState([]);
  const [memberSubmissions, setMemberSubmissions] = useState([]);
  const [showSubmissionModal, setShowSubmissionModal] = useState(false);
  const [selectedSubmission, setSelectedSubmission] = useState(null);
  const [feedbackText, setFeedbackText] = useState('');
  
  // Group members state
  const [groupMembers, setGroupMembers] = useState([]);
  const [sortedGroupMembers, setSortedGroupMembers] = useState([]);
  const [currentMemberPage, setCurrentMemberPage] = useState(0);
  const [activeGroupTab, setActiveGroupTab] = useState('overview');
  
  // ‚úÖ Activities Tab - Feedback View States
  const [activitiesView, setActivitiesView] = useState('feedbackView'); // 'feedbackView', 'tasks', 'phaseSubmissions'
  const [selectedActivitiesProject, setSelectedActivitiesProject] = useState(null);
  const [selectedActivitiesPhase, setSelectedActivitiesPhase] = useState(null);
  const [showActivitiesProjectDropdown, setShowActivitiesProjectDropdown] = useState(false);
  const [showActivitiesPhaseDropdown, setShowActivitiesPhaseDropdown] = useState(false);
  const [activitiesPhases, setActivitiesPhases] = useState([]);
  
  // Phase Submissions View States
  const [activitiesPhaseSubmissions, setActivitiesPhaseSubmissions] = useState([]);
  const [selectedPhaseSubmission, setSelectedPhaseSubmission] = useState(null);
  const [loadingPhaseSubmissionsView, setLoadingPhaseSubmissionsView] = useState(false);
  const [expandedMemberSubmissions, setExpandedMemberSubmissions] = useState({});
  
  // Feedback View - Task Submissions
  const [groupTaskSubmissions, setGroupTaskSubmissions] = useState([]);
  const [allGroupTasks, setAllGroupTasks] = useState([]); // NEW: All tasks assigned to group members
  const [selectedTaskSubmission, setSelectedTaskSubmission] = useState(null);
  const [selectedAttempt, setSelectedAttempt] = useState(null);
  const [taskSubmissionDetails, setTaskSubmissionDetails] = useState(null);
  const [submissionFeedbacks, setSubmissionFeedbacks] = useState([]);
  const [submissionSearchTerm, setSubmissionSearchTerm] = useState('');
  const [submissionSortBy, setSubmissionSortBy] = useState('date'); // 'date', 'member', 'status'
  const [loadingActivities, setLoadingActivities] = useState(false);
  
  // New group feedback submission states
  const [groupFeedbackText, setGroupFeedbackText] = useState('');
  const [submittingGroupFeedback, setSubmittingGroupFeedback] = useState(false);
  
  // Project Progress States
  const [projectProgressData, setProjectProgressData] = useState({
    phaseSubmissions: [],
    projectSubmission: null,
    loading: false
  });
  
  const [selectedGanttProject, setSelectedGanttProject] = useState(null);
  const [selectedGanttPhase, setSelectedGanttPhase] = useState(null);
  const [showGanttProjectDropdown, setShowGanttProjectDropdown] = useState(false);
  const [showGanttPhaseDropdown, setShowGanttPhaseDropdown] = useState(false);
  const [ganttTasks, setGanttTasks] = useState([]);
  const [ganttLoading, setGanttLoading] = useState(false);
  
  // Phase visibility toggles - track which phases are visible in overview mode
  const [visiblePhases, setVisiblePhases] = useState(new Set());
  
  // Container width measurement for adaptive Gantt chart sizing
  const ganttContainerRef = useRef(null);
  const [ganttContainerWidth, setGanttContainerWidth] = useState(null);
  
  // Resizable name column width
  const [nameColumnWidth, setNameColumnWidth] = useState(200);
  const [isResizing, setIsResizing] = useState(false);

  // Reports Tab Gantt Chart Reference
  const reportsGanttRef = useRef(null);
  const reportsGanttInstance = useRef(null);
  
  // Reports Tab Pie Chart Reference
  const reportsPieChartRef = useRef(null);
  
  // Reports Tab Task Assignment Table Reference
  const reportsTaskTableRef = useRef(null);

  // =================== GANTT CHART HELPER FUNCTIONS - ULTRA ENHANCED ===================
  
  // Get the date range for the Gantt chart timeline
  const getGanttDateRange = () => {
    if (!selectedGanttProject) return { start: null, end: null };
    
    let start, end;
    
    if (selectedGanttPhase) {
      // PHASE SELECTED: Use exact phase boundaries
      start = new Date(selectedGanttPhase.start_date);
      end = new Date(selectedGanttPhase.end_date);
      
      console.log('üìÖ Phase Date Range:', {
        phase: selectedGanttPhase.phase_number,
        start: start.toLocaleDateString(),
        end: end.toLocaleDateString()
      });
    } else {
      // OVERVIEW (All Phases): Use project boundaries
      start = new Date(selectedGanttProject.start_date || selectedGanttProject.created_at);
      end = new Date(selectedGanttProject.due_date);
      
      console.log('üìÖ Project Date Range (Overview):', {
        project: selectedGanttProject.title,
        start: start.toLocaleDateString(),
        end: end.toLocaleDateString()
      });
    }
    
    // Normalize to midnight
    start.setHours(0, 0, 0, 0);
    end.setHours(0, 0, 0, 0);
    
    return { start, end };
  };

  // Generate all days in the timeline (for date headers)
  const getGanttTimelineDays = () => {
    const { start, end } = getGanttDateRange();
    if (!start || !end) return [];
    
    const days = [];
    const current = new Date(start);
    current.setHours(0, 0, 0, 0);
    const endDate = new Date(end);
    endDate.setHours(0, 0, 0, 0);
    
    // Generate all days - no arbitrary limits
    while (current <= endDate) {
      days.push(new Date(current));
      current.setDate(current.getDate() + 1);
    }
    
    console.log('üìÖ Gantt Timeline Days:', {
      start: start.toLocaleDateString(),
      end: endDate.toLocaleDateString(),
      totalDays: days.length,
      scrollable: days.length > 30 ? 'YES' : 'NO'
    });
    
    return days;
  };

  // Get adaptive day width based on timeline duration and available space
  const getAdaptiveDayWidth = (containerWidth = null) => {
    const timelineDays = getGanttTimelineDays();
    const dayCount = timelineDays.length;
    
    if (!dayCount) return 100; // Fallback if no days
    
    // If we have a measured container width, calculate based on showing max 10 days at once
    if (containerWidth && containerWidth > 0 && dayCount > 0) {
      const availableWidth = containerWidth - nameColumnWidth;
      
      if (availableWidth > 0) {
        // Calculate width to show exactly 10 days at a time (or fewer if timeline is shorter)
        const visibleDays = Math.min(dayCount, 10);
        const calculatedWidth = availableWidth / visibleDays;
        
        // Set minimum bound for readability
        const minWidth = 80;
        
        const finalWidth = Math.max(minWidth, calculatedWidth);
        
        console.log('üìä Width calculation (10-day view):', {
          containerWidth,
          nameColumnWidth,
          availableWidth,
          totalDays: dayCount,
          visibleDays,
          widthPerDay: finalWidth,
          totalTimelineWidth: finalWidth * dayCount,
          needsScroll: dayCount > 10
        });
        
        return finalWidth;
      }
    }
    
    // Fallback: Auto-adjust width based on duration (only used if container not measured)
    console.log('‚ö†Ô∏è Using fallback width - container not measured');
    if (dayCount <= 3) return 300;
    if (dayCount <= 7) return 150;
    if (dayCount <= 14) return 100;
    if (dayCount <= 30) return 70;
    return 50;
  };

  // Calculate phase rows to prevent overlap - assigns each phase to a row
  const calculatePhaseRows = (phases, dayWidth) => {
    if (!phases || phases.length === 0) return [];
    
    // Sort phases by start day
    const sortedPhases = [...phases].sort((a, b) => a.startDay - b.startDay);
    
    // Track occupied rows: array of arrays, each inner array contains phases in that row
    const rows = [];
    
    sortedPhases.forEach(phase => {
      const phaseStart = phase.leftPos;
      const phaseEnd = phase.leftPos + phase.width;
      
      // Find the first row where this phase doesn't overlap with any existing phase
      let assignedRow = -1;
      for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
        const row = rows[rowIndex];
        let hasOverlap = false;
        
        for (const existingPhase of row) {
          const existingStart = existingPhase.leftPos;
          const existingEnd = existingPhase.leftPos + existingPhase.width;
          
          // Check for overlap (with 8px buffer)
          if (!(phaseEnd + 8 <= existingStart || phaseStart - 8 >= existingEnd)) {
            hasOverlap = true;
            break;
          }
        }
        
        if (!hasOverlap) {
          assignedRow = rowIndex;
          break;
        }
      }
      
      // If no suitable row found, create a new row
      if (assignedRow === -1) {
        assignedRow = rows.length;
        rows.push([]);
      }
      
      // Add phase to the assigned row
      rows[assignedRow].push({ ...phase, row: assignedRow });
    });
    
    // Flatten and return with row assignments
    return rows.flat();
  };

  // Get phases that occupy a specific day with their time percentages
  // Updated to support horizontal splitting for same-day transitions
  const getPhasesForDay = (day, phases, start) => {
    if (!phases || phases.length === 0) return [];
    
    const dayStart = new Date(day);
    dayStart.setHours(0, 0, 0, 0);
    const dayEnd = new Date(day);
    dayEnd.setHours(23, 59, 59, 999);
    
    const overlappingPhases = phases.map((phase, idx) => {
      const phaseStart = new Date(phase.start_date);
      const phaseEnd = new Date(phase.end_date);
      
      // Check if phase overlaps this day
      if (phaseEnd < dayStart || phaseStart > dayEnd) {
        return null;
      }
      
      // Calculate what percentage of the day this phase occupies (horizontally)
      const effectiveStart = phaseStart > dayStart ? phaseStart : dayStart;
      const effectiveEnd = phaseEnd < dayEnd ? phaseEnd : dayEnd;
      const dayDuration = dayEnd - dayStart;
      const phaseDuration = effectiveEnd - effectiveStart;
      const percentage = (phaseDuration / dayDuration) * 100;
      
      // Calculate horizontal position within the day (0-100%)
      const startOffset = phaseStart > dayStart ? 
        ((phaseStart - dayStart) / dayDuration) * 100 : 0;
      const endOffset = phaseEnd < dayEnd ?
        ((phaseEnd - dayStart) / dayDuration) * 100 : 100;
      
      return {
        ...phase,
        percentage,
        startOffset, // Horizontal start position (0-100%)
        endOffset,   // Horizontal end position (0-100%)
        colorIdx: idx,
        startsThisDay: phaseStart.toDateString() === day.toDateString(),
        endsThisDay: phaseEnd.toDateString() === day.toDateString()
      };
    }).filter(p => p !== null);
    
    // Sort by start time for proper horizontal layout
    return overlappingPhases.sort((a, b) => a.startOffset - b.startOffset);
  };

  // Calculate task position as pixels (not percentages) for scrollable timeline
  const getTaskPosition = (task, dayWidth) => {
    const { start, end } = getGanttDateRange();
    if (!start || !end || !task.due_date) {
      console.warn('‚ö†Ô∏è Missing date data for task:', task.title);
      return { left: '0px', width: `${dayWidth}px` }; // Default width matches day cell
    }
    
    // Task start: use created_at as the assignment date
    const taskStart = new Date(task.created_at);
    taskStart.setHours(0, 0, 0, 0);
    
    // Task end: use due_date
    const taskEnd = new Date(task.due_date);
    taskEnd.setHours(0, 0, 0, 0);
    
    const timelineStart = new Date(start);
    timelineStart.setHours(0, 0, 0, 0);
    
    const timelineEnd = new Date(end);
    timelineEnd.setHours(0, 0, 0, 0);
    
    // Calculate positions in pixels using adaptive day width
    const totalDays = Math.ceil((timelineEnd - timelineStart) / (1000 * 60 * 60 * 24));
    const taskStartDay = Math.max(0, Math.floor((taskStart - timelineStart) / (1000 * 60 * 60 * 24)));
    const taskDurationDays = Math.max(1, Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1); // +1 to include end date
    
    // Add small margin (4px) to align with date cell content
    const left = (taskStartDay * dayWidth) + 4;
    const width = (taskDurationDays * dayWidth) - 8; // -8 for 4px margin on each side
    
    console.log('üìä Task Position (Pixels):', {
      title: task.title,
      start: taskStart.toLocaleDateString(),
      end: taskEnd.toLocaleDateString(),
      startDay: taskStartDay,
      durationDays: taskDurationDays,
      dayWidth: `${dayWidth}px`,
      left: `${left}px`,
      width: `${width}px`
    });
    
    return { 
      left: `${left}px`, 
      width: `${width}px`,
      startDate: taskStart,
      endDate: taskEnd
    };
  };

  const getTaskStatusColor = (task) => {
    const now = new Date();
    const dueDate = task.due_date ? new Date(task.due_date) : null;
    
    // Check if task is completed (status can be 'completed', 'approved', or has successful submission)
    if (task.status === 'completed' || task.status === 'approved') {
      return '#10B981'; // Green
    }
    
    // Check if overdue
    if (dueDate && now > dueDate && task.status !== 'completed' && task.status !== 'approved') {
      return '#EF4444'; // Red
    }
    
    // Check if in progress or has revisions
    if (task.status === 'in_progress' || task.status === 'to_revise' || task.current_attempts > 0) {
      return '#F59E0B'; // Orange/Yellow
    }
    
    // Pending/Not started
    return '#6B7280'; // Gray
  };

  // Close dropdowns when clicking outside - Gantt chart only (other dropdowns handled later after state declarations)
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (!event.target.closest('.gantt-project-dropdown') && !event.target.closest('.gantt-phase-dropdown')) {
        setShowGanttProjectDropdown(false);
        setShowGanttPhaseDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // Measure Gantt container width when project/phase changes
  useEffect(() => {
    if (ganttContainerRef.current) {
      let resizeTimeout; // Debounce timer for resize events
      
      // Small delay to ensure container is fully rendered
      const measureWidth = () => {
        if (ganttContainerRef.current) {
          const width = ganttContainerRef.current.offsetWidth;
          if (width > 100) {  // Only set if valid
            setGanttContainerWidth(width);
            console.log('üìè Gantt container width measured:', width);
          }
        }
      };
      
      // Immediate measurement
      measureWidth();
      
      // Delayed measurement to catch late renders
      const timer = setTimeout(measureWidth, 100);
      
      // Add ResizeObserver to track container size changes with debouncing
      const resizeObserver = new ResizeObserver((entries) => {
        // Clear any pending resize timeout
        if (resizeTimeout) {
          clearTimeout(resizeTimeout);
        }
        
        // Debounce the resize event to prevent excessive updates
        resizeTimeout = setTimeout(() => {
          for (let entry of entries) {
            const newWidth = entry.contentRect.width;
            // Only update if width is valid (not 0) to prevent collapse during resizing
            if (newWidth > 100) {
              console.log('üìè Gantt container resized to:', newWidth);
              setGanttContainerWidth(newWidth);
            }
          }
        }, 150); // Wait 150ms before processing resize
      });
      
      resizeObserver.observe(ganttContainerRef.current);
      
      // Cleanup
      return () => {
        clearTimeout(timer);
        if (resizeTimeout) {
          clearTimeout(resizeTimeout);
        }
        resizeObserver.disconnect();
      };
    }
  }, [selectedGanttProject, selectedGanttPhase]);

  // Initialize all phases as visible when project is selected
  useEffect(() => {
    if (selectedGanttProject && selectedGanttProject.project_phases) {
      const allPhaseIds = new Set(selectedGanttProject.project_phases.map(p => p.id));
      setVisiblePhases(allPhaseIds);
    }
  }, [selectedGanttProject]);

  // Function to load tasks for Gantt chart
  const loadGanttTasks = async (projectId, phaseId = null) => {
    try {
      setGanttLoading(true);
      console.log('üîÑ Loading Gantt tasks for project:', projectId, 'phase:', phaseId);
      
      const token = localStorage.getItem('token');
      if (!token) {
        console.error('‚ùå No token found');
        return;
      }

      // Use the existing working endpoint for assigned tasks
      const tasksResponse = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/assigned-tasks`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (tasksResponse.ok) {
        const tasksData = await tasksResponse.json();
        console.log('‚úÖ Gantt tasks loaded - Full Response:', tasksData);
        console.log('‚úÖ Response type:', typeof tasksData);
        console.log('‚úÖ Is Array?:', Array.isArray(tasksData));
        
        let allTasks = [];
        
        // Handle multiple possible response structures
        if (Array.isArray(tasksData)) {
          allTasks = tasksData;
          console.log('‚úÖ Using direct array format');
        } else if (tasksData.success && tasksData.tasks) {
          allTasks = tasksData.tasks;
          console.log('‚úÖ Using success.tasks format');
        } else if (tasksData.data) {
          allTasks = Array.isArray(tasksData.data) ? tasksData.data : tasksData.data.tasks || [];
          console.log('‚úÖ Using data format');
        } else if (tasksData.tasks) {
          allTasks = tasksData.tasks;
          console.log('‚úÖ Using tasks format');
        }

        console.log('üîç All tasks extracted:', allTasks.length, allTasks);
        if (allTasks.length > 0) {
          console.log('üîç First task structure:', allTasks[0]);
          console.log('üîç First task keys:', Object.keys(allTasks[0]));
          console.log('üîç Task phase info:', allTasks.map(t => ({
            title: t.title,
            phase_id: t.phase_id,
            project_phase_id: t.project_phase_id,
            phase_number: t.phase_number,
            project_phases: t.project_phases
          })));
        }

        // Filter by phase if specified
        let filteredTasks = allTasks;
        if (phaseId && selectedGanttPhase) {
          console.log('üîç Filtering for phase:', {
            phaseId,
            phaseName: selectedGanttPhase.title,
            phaseNumber: selectedGanttPhase.phase_number
          });
          
          filteredTasks = allTasks.filter(task => {
            // The API returns project_phases as a nested object (not an array!)
            // Structure: { id, title, start_date, end_date }
            const taskPhaseId = task.project_phases?.id || task.phase_id || task.project_phase_id;
            
            const matches = taskPhaseId === phaseId;
            
            console.log('üîç Task phase check:', {
              taskTitle: task.title,
              taskPhaseId,
              taskPhaseName: task.project_phases?.title || task.phase_name,
              selectedPhaseId: phaseId,
              selectedPhaseName: selectedGanttPhase.title,
              matches
            });
            
            return matches;
          });
          
          console.log(`‚úÖ Filtered ${filteredTasks.length} tasks for phase "${selectedGanttPhase.title}"`);
          filteredTasks.forEach(t => console.log(`  - ${t.title}`));
        } else {
          console.log('üîç No phase filter - showing all', allTasks.length, 'tasks');
        }

        console.log('üîç Final filtered tasks for Gantt:', filteredTasks.length);
        console.log('üîç Group members:', groupData?.members?.length, groupData?.members);
        console.log('üîç Member IDs:', groupData?.members?.map(m => ({ id: m.id, student_id: m.student_id, name: m.name })));
        console.log('üîç Task assignments:', filteredTasks.map(t => ({ id: t.id, title: t.title, assigned_to: t.assigned_to, assigned_member_id: t.assigned_member_id })));
        
        setGanttTasks(filteredTasks);
      } else {
        console.error('‚ùå Failed to load tasks:', tasksResponse.status);
        setGanttTasks([]);
      }
    } catch (error) {
      console.error('‚ùå Error loading Gantt tasks:', error);
      setGanttTasks([]);
    } finally {
      setGanttLoading(false);
    }
  };

  // Function to load project-specific data for Gantt chart
  const loadGanttProjectData = async (projectId) => {
    try {
      console.log('üîÑ Loading Gantt project data for:', projectId);
      const token = localStorage.getItem('token');
      
      if (!token) {
        console.error('‚ùå No token found');
        return;
      }

      // Try multiple endpoints to get project with phases
      let projectData = null;
      
      // First try the Project Dashboard endpoint which has all the data we need
      try {
        const dashboardResponse = await fetch(`${apiConfig.baseURL}/api/student/projects/${projectId}/dashboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (dashboardResponse.ok) {
          const dashboardData = await dashboardResponse.json();
          console.log('‚úÖ Dashboard project data:', dashboardData);
          if (dashboardData.project) {
            projectData = dashboardData.project;
            projectData.project_evaluation_forms = dashboardData.project.project_evaluation_forms || [];
            console.log('‚úÖ Phase with evaluation data:', projectData.project_phases?.[0]);
            console.log('‚úÖ Evaluation fields:', {
              eval_available: projectData.project_phases?.[0]?.evaluation_available_from,
              eval_due: projectData.project_phases?.[0]?.evaluation_due_date,
              breathe_start: projectData.project_phases?.[0]?.breathe_start_date,
              breathe_end: projectData.project_phases?.[0]?.breathe_end_date
            });
          }
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Dashboard endpoint failed, trying student-leader endpoint...');
      }
      
      // Fallback to student-leader endpoint
      if (!projectData || !projectData.project_phases?.length) {
      try {
        const response = await apiCall(`${apiConfig.endpoints.studentLeader.projects}/${projectId}`);
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Detailed project data:', data);
          if (data.success && data.project) {
            projectData = data.project;
          }
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Detailed endpoint failed, trying alternative...');
        }
      }

      // If no phases found, try the phases endpoint directly
      if (!projectData?.project_phases || projectData.project_phases.length === 0) {
        try {
          console.log('üîÑ Trying phases endpoint...');
          const phasesResponse = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/phases`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (phasesResponse.ok) {
            const phasesData = await phasesResponse.json();
            console.log('‚úÖ Phases data:', phasesData);
            if (phasesData.success && phasesData.phases) {
              // Merge phases into project data
              if (projectData) {
                projectData.project_phases = phasesData.phases;
              } else {
                // Create project data from activeProjects if detailed endpoint failed
                const baseProject = activeProjects.find(p => p.id === projectId);
                if (baseProject) {
                  projectData = { ...baseProject, project_phases: phasesData.phases };
                }
              }
            }
          }
        } catch (error) {
          console.log('‚ö†Ô∏è Phases endpoint failed, trying phases-with-submissions...');
          try {
            const phasesWithSubmissionsResponse = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/phases-with-submissions`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (phasesWithSubmissionsResponse.ok) {
              const phasesWithSubmissionsData = await phasesWithSubmissionsResponse.json();
              console.log('‚úÖ Phases with submissions data:', phasesWithSubmissionsData);
              if (phasesWithSubmissionsData.success && phasesWithSubmissionsData.phases) {
                // Merge phases into project data
                if (projectData) {
                  projectData.project_phases = phasesWithSubmissionsData.phases;
                } else {
                  const baseProject = activeProjects.find(p => p.id === projectId);
                  if (baseProject) {
                    projectData = { ...baseProject, project_phases: phasesWithSubmissionsData.phases };
                  }
                }
              }
            }
          } catch (secondError) {
            console.log('‚ö†Ô∏è All phases endpoints failed:', secondError);
          }
        }
      }

      if (projectData) {
        setSelectedGanttProject(projectData);
        console.log('‚úÖ Selected Gantt project updated with phases:', projectData);
        // Load tasks for the project
        await loadGanttTasks(projectId);
      } else {
        console.error('‚ùå Could not load project data with phases');
      }
    } catch (error) {
      console.error('‚ùå Error loading Gantt project data:', error);
    }
  };
  const [loadingMembers, setLoadingMembers] = useState(false);
  const [submittingFeedback, setSubmittingFeedback] = useState(false);
  const [newFeedback, setNewFeedback] = useState('');
  const [submitFeedbackLoading, setSubmitFeedbackLoading] = useState(false);

  // ‚úÖ ADD: Missing grades states at component level
  const [selectedGradeProject, setSelectedGradeProject] = useState(null);
  const [showGradeDropdown, setShowGradeDropdown] = useState(false);
  const [gradesOverview, setGradesOverview] = useState([]);
  const [detailedGrades, setDetailedGrades] = useState(null);
  const [gradesViewMode, setGradesViewMode] = useState('wide'); // 'project', 'phase', or 'wide' - default to wide for card view
  const [gradesViewFilter, setGradesViewFilter] = useState('project'); // Which data to show: 'project' or 'phase' // 'project' or 'phase' (for non-wide modes)
  const [gradesSearchQuery, setGradesSearchQuery] = useState('');
  const [gradesSortBy, setGradesSortBy] = useState('project'); // 'project', 'date', 'highest', 'lowest'
  const [allProjects, setAllProjects] = useState([]); // All projects for wide view

  // ‚úÖ Canvas-style submission loading
  const [submissionLoading, setSubmissionLoading] = useState(false);
  const [gradesLoading, setGradesLoading] = useState(false);
  const [expandedPhase, setExpandedPhase] = useState(null);
  const [expandedEvaluation, setExpandedEvaluation] = useState(null);
  


  // Data states - DECLARE THESE FIRST
  const [courseData, setCourseData] = useState(null);
  const [projects, setProjects] = useState([]);
  const [groupData, setGroupData] = useState(null);
  const [myTasks, setMyTasks] = useState([]);
  const [activityStats, setActivityStats] = useState({});
  const [recentFeedbacks, setRecentFeedbacks] = useState([]);
  const [recentSubmissions, setRecentSubmissions] = useState([]);
  const [recentActivityLoading, setRecentActivityLoading] = useState(false);
  
  // ‚úÖ NEW: Loading states for Course Overview cards
  const [announcementsLoading, setAnnouncementsLoading] = useState(false);
  const [feedbacksLoading, setFeedbacksLoading] = useState(false);
  const [overviewTasksLoading, setOverviewTasksLoading] = useState(false);
  
  const [announcements, setAnnouncements] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [unreadNotifications, setUnreadNotifications] = useState(0);
  const [grades, setGrades] = useState([]);
  
  // ‚úÖ ADD: User profile state
  const [userProfile, setUserProfile] = useState(null);
  const [profileLoading, setProfileLoading] = useState(false);
  
  // Gantt Chart Modals
  const [showProjectDetailsModal, setShowProjectDetailsModal] = useState(false);
  const [showPhaseDetailsModal, setShowPhaseDetailsModal] = useState(false);
  const [selectedModalPhase, setSelectedModalPhase] = useState(null);
 
// ‚úÖ FIX: Make userRole reactive to groupData changes
const userRole = useMemo(() => {
  const role = (groupData?.role || '').toLowerCase();
  console.log('üîç Debug - Group Data:', groupData);
  console.log('üîç Debug - Group Data Role:', groupData?.role);
  console.log('üîç Debug - Computed User Role:', role === 'leader' ? 'leader' : 'member');
  return role === 'leader' ? 'leader' : 'member';
}, [groupData]);

const navItems = useMemo(() => getNavItems(userRole), [userRole]);



  // ‚úÖ FIXED: Initialize these AFTER announcements and notifications are declared
  const [filteredNotifications, setFilteredNotifications] = useState([]);
  const [notificationFilter, setNotificationFilter] = useState('all');
  const [showUnreadOnly, setShowUnreadOnly] = useState(false);
  const [expandedNotification, setExpandedNotification] = useState(null);
  const [notificationSearchQuery, setNotificationSearchQuery] = useState('');
  const [showClearAllModal, setShowClearAllModal] = useState(false);

  // announcements
  const [filteredAnnouncements, setFilteredAnnouncements] = useState([]);
  const [announcementFilter, setAnnouncementFilter] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [expandedAnnouncement, setExpandedAnnouncement] = useState(null);
  



  // Evaluations
  const [selectedEvaluationProject, setSelectedEvaluationProject] = useState(null);
  const [showEvaluationDropdown, setShowEvaluationDropdown] = useState(false);
  const [evaluationsData, setEvaluationsData] = useState(null);
  const [evaluationsLoading, setEvaluationsLoading] = useState(false);
  const [expandedGivenEvaluation, setExpandedGivenEvaluation] = useState(null);
  const [expandedReceivedEvaluation, setExpandedReceivedEvaluation] = useState(null)
  
  // NEW: Evaluation Tab Redesign States
  const [evaluationTypeToggle, setEvaluationTypeToggle] = useState('phase'); // 'phase' or 'project'
  const [evaluationViewFilter, setEvaluationViewFilter] = useState('received'); // 'received' or 'given'

  // LEADER ASSIGN TASK
    const [selectedAssignProject, setSelectedAssignProject] = useState(null);
    const [showAssignProjectDropdown, setShowAssignProjectDropdown] = useState(false);
    const [selectedAssignMember, setSelectedAssignMember] = useState(null);
    const [selectedAssignPhase, setSelectedAssignPhase] = useState(null);
    const [showAssignPhaseDropdown, setShowAssignPhaseDropdown] = useState(false);
    const [availableAssignPhases, setAvailableAssignPhases] = useState([]);
    const [currentActivePhase, setCurrentActivePhase] = useState(null);
    const [taskForm, setTaskForm] = useState({
      title: '',
      description: '',
      max_attempts: 1,
      due_date: '',
      due_time: '',
      file_types_allowed: [],
      available_until_date: '',
      available_until_time: ''
    });
    const [taskLimits, setTaskLimits] = useState({
      min_tasks: 0,
      max_tasks: 0
    });
    const [projectFileSettings, setProjectFileSettings] = useState({
      file_types_allowed: [],
      max_file_size_mb: 10
    });
    const [memberTaskCounts, setMemberTaskCounts] = useState({});
    const [submittingTask, setSubmittingTask] = useState(false);

    // TASK MANAGEMENT STATES
    const [currentTaskMode, setCurrentTaskMode] = useState(null); // 'assignment' or 'management'
    const [assignedTasks, setAssignedTasks] = useState([]);
    const [loadingAssignedTasks, setLoadingAssignedTasks] = useState(false);
    const [showEditTaskModal, setShowEditTaskModal] = useState(false);
    const [editingTask, setEditingTask] = useState(null);
    const [editTaskForm, setEditTaskForm] = useState({
      title: '',
      description: '',
      due_date: '',
      due_time: '',
      available_until_date: '',
      available_until_time: '',
      max_attempts: 1,
      file_types_allowed: []
    });
    const [updatingTask, setUpdatingTask] = useState(false);
    const [taskSubmissions, setTaskSubmissions] = useState([]);
    const [selectedTaskToEdit, setSelectedTaskToEdit] = useState(null);
    const [showTaskEditModal, setShowTaskEditModal] = useState(false);
    const [loadingTaskManagement, setLoadingTaskManagement] = useState(false);
    
    // Member filtering for task management
    const [selectedMemberForTasks, setSelectedMemberForTasks] = useState(null);
    const [filteredTasks, setFilteredTasks] = useState([]);

    const [expandedCategories, setExpandedCategories] = useState({});


    // Member Submission Leader
    const [memberSubmissionsView, setMemberSubmissionsView] = useState({
      selectedProject: null,
      selectedMember: null,
      selectedPhase: null,
      projectMembers: [],
      memberSubmissions: [],
      projectPhases: [],
      loading: false
    });

  // Submission Checking state
  const [submissionCheckingView, setSubmissionCheckingView] = useState({
    selectedProject: null,
    showProjectDropdown: false,
    loading: false,
    phases: [],
    selectedPhase: null,
    overviewData: {},
    detailsData: [],
    selectedSubmission: null,
    selectedTask: null,
    selectedAttempt: null
  });

  // Submission Checking sort states
  const [submissionCheckingSortBy, setSubmissionCheckingSortBy] = useState('date');
  const [showSubmissionCheckingSortDropdown, setShowSubmissionCheckingSortDropdown] = useState(false);

  // Notifications dropdown state
  const [showNotificationFilterDropdown, setShowNotificationFilterDropdown] = useState(false);

  // Task Assignment state
  const [taskAssignmentView, setTaskAssignmentView] = useState({
    selectedProject: null,
    showProjectDropdown: false,
    loading: false,
    selectedMember: null,
    selectedMemberFilter: 'all',
    groupMembers: [],
    projectPhases: [],
    assignedTasks: {}, // Format: { 'memberId-phaseId': count }
    phaseTasks: [], // Array of task objects for active phase
    activeTab: 'overview', // 'overview', 'assign', 'manage', 'extensions'
    taskForm: {
      title: '',
      description: '',
      phase_id: null,
      max_attempts: 1,
      due_date: '',
      due_time: '',
      available_until_date: '',
      available_until_time: '',
      file_types_allowed: []
    },
    extensionRequests: [], // Array of extension requests
    extensionRequestsLoading: false,
    selectedExtensionRequest: null,
    extensionStatusFilter: 'pending' // 'all', 'pending', 'approved', 'rejected'
  });

  // Extension Approval Modal State
  const [showExtensionApprovalModal, setShowExtensionApprovalModal] = useState(false);
  const [extensionApprovalForm, setExtensionApprovalForm] = useState({
    new_due_date: '',
    new_due_time: '',
    new_available_until_date: '',
    new_available_until_time: '',
    leader_notes: ''
  });
  const [approvingExtension, setApprovingExtension] = useState(false);

  // Extension Rejection Modal State
  const [showExtensionRejectionModal, setShowExtensionRejectionModal] = useState(false);
  const [extensionRejectionReason, setExtensionRejectionReason] = useState('');
  const [rejectingExtension, setRejectingExtension] = useState(false);

  // Task Modal State
  const [taskModal, setTaskModal] = useState({
    isOpen: false,
    task: null,
    isEditing: false,
    latestStatus: null,
    statusLoading: false
  });

  // Fetch tasks for active phase when manage tab is active
  useEffect(() => {
    const fetchPhaseTasks = async () => {
      if (taskAssignmentView.activeTab === 'manage' && taskAssignmentView.selectedProject) {
        // We'll get the active phase from the detectCurrentActiveWorkPhase function
        // which is defined later in the component
        const activePhase = taskAssignmentView.projectPhases?.find(phase => {
          const now = new Date();
          const startDate = new Date(phase.start_date);
          const endDate = new Date(phase.end_date);
          return now >= startDate && now <= endDate;
        });

        if (activePhase) {
          try {
            const token = localStorage.getItem('token');
            const response = await fetch(
              `${apiConfig.baseURL}/api/student-leader/projects/${taskAssignmentView.selectedProject.id}/phases/${activePhase.id}/tasks`,
              {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              }
            );

            if (!response.ok) throw new Error('Failed to fetch tasks');
            const data = await response.json();

            setTaskAssignmentView(prev => ({
              ...prev,
              phaseTasks: Array.isArray(data) ? data : (data.tasks || [])
            }));
          } catch (error) {
            console.error('Error fetching tasks:', error);
            alert('Failed to load tasks. Please try again.');
          }
        }
      }
    };

    fetchPhaseTasks();
  }, [taskAssignmentView.activeTab, taskAssignmentView.selectedProject]);

  // Load extension requests when switching to extensions tab
  useEffect(() => {
    if (taskAssignmentView.activeTab === 'extensions' && groupData?.group_id) {
      loadExtensionRequests(groupData.group_id);
    }
  }, [taskAssignmentView.activeTab, groupData?.group_id]);

  // File Type Categories for Task Assignment
  const fileTypeCategories = {
    'Documents': ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt', 'md'],
    'Images': ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff'],
    'Code': ['js', 'ts', 'html', 'css', 'py', 'java', 'cpp', 'c', 'php', 'json', 'xml'],
    'Media': ['mp4', 'avi', 'mov', 'wmv', 'mp3', 'wav', 'flac', 'aac'],
    'Archives': ['zip', 'rar', '7z', 'tar', 'gz'],
    'Data': ['csv', 'sql', 'xlsx', 'dbf'],
    'Design': ['psd', 'ai', 'eps', 'pptx'],
  };

  const [selectedFileTypeCategory, setSelectedFileTypeCategory] = useState(null);

  // Deliverables Submission state
  const [deliverablesView, setDeliverablesView] = useState({
    selectedProject: null,
    showProjectDropdown: false,
    loading: false,
    detailsLoading: false,
    phases: [],
    projectSubmission: null,
    selectedDeliverable: null, // Can be a phase or 'project'
    deliverableType: null // 'phase' or 'project'
  });


const [showMemberSubmissionsDropdown, setShowMemberSubmissionsDropdown] = useState(false);
const [showMemberPhaseDropdown, setShowMemberPhaseDropdown] = useState(false);




    const [activeProjects, setActiveProjects] = useState([]);
    const [selectedReportsProject, setSelectedReportsProject] = useState(null);
    const [showReportsProjectDropdown, setShowReportsProjectDropdown] = useState(false);
    const [selectedReportsGanttPhase, setSelectedReportsGanttPhase] = useState(null);
    const [showReportsGanttPhaseDropdown, setShowReportsGanttPhaseDropdown] = useState(false);
    
    // Deliverable Summary states
    const [selectedDeliverablePhase, setSelectedDeliverablePhase] = useState(null);
    const [showDeliverablePhaseDropdown, setShowDeliverablePhaseDropdown] = useState(false);
    const [selectedSubmissionStatusFilter, setSelectedSubmissionStatusFilter] = useState(null); // null = all, or 'completed', 'submitted', 'missed', 'late', 'revision'
    
    // Project Rubric and Evaluation Modal states
    const [showProjectRubricModal, setShowProjectRubricModal] = useState(false);
    const [showProjectEvaluationModal, setShowProjectEvaluationModal] = useState(false);
    const [projectRubricData, setProjectRubricData] = useState(null);
    const [projectEvaluationData, setProjectEvaluationData] = useState(null);
    const [deliverableFilter, setDeliverableFilter] = useState('all'); // 'all', 'completed', 'submitted', 'missed', 'late', 'revision'
    
    // Evaluation Summary states
    const [selectedEvaluationPhase, setSelectedEvaluationPhase] = useState(null);
    const [myEvaluationSubmissions, setMyEvaluationSubmissions] = useState([]); // Evaluations I gave to others
    const [myEvaluationSubmissionsLoading, setMyEvaluationSubmissionsLoading] = useState(false); // ‚úÖ Track loading state
    const [receivedEvaluations, setReceivedEvaluations] = useState([]); // Evaluations others gave to me
    const [selectedMemberEvaluation, setSelectedMemberEvaluation] = useState(null);
    const [evaluationScoresLoading, setEvaluationScoresLoading] = useState(false);
    const [groupMembersForEvaluation, setGroupMembersForEvaluation] = useState([]);
    const [showMemberEvaluationModal, setShowMemberEvaluationModal] = useState(false);

  // Group Stats states
  const [selectedGroupStat, setSelectedGroupStat] = useState('grade'); // 'grade', 'completion', 'activity'
  const [groupStats, setGroupStats] = useState({
    phaseGradeAverage: null,
    projectGradeAverage: null,
    taskCompletionRate: null,
    totalTasks: 0,
    completedTasks: 0,
    submissionActivity: {
      totalSubmissions: 0,
      onTimeSubmissions: 0,
      lateSubmissions: 0,
      pendingSubmissions: 0
    }
  });
  const [groupStatsLoading, setGroupStatsLoading] = useState(false);











  // Loading and error states
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Close additional project and phase dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Assign Tasks dropdown
      if (showAssignProjectDropdown && !event.target.closest('.assign-project-selector')) {
        setShowAssignProjectDropdown(false);
      }
      // Task Assignment dropdown
      if (taskAssignmentView.showProjectDropdown && !event.target.closest('.project-dropdown-wrapper')) {
        setTaskAssignmentView(prev => ({ ...prev, showProjectDropdown: false }));
      }
      // Reports dropdown - now using proper class selector
      if (showReportsProjectDropdown && !event.target.closest('.reports-project-dropdown')) {
        setShowReportsProjectDropdown(false);
      }
      // Activities project dropdown - using proper class selector
      if (showActivitiesProjectDropdown && !event.target.closest('.activities-project-dropdown')) {
        setShowActivitiesProjectDropdown(false);
      }
      // Activities phase dropdown - using proper class selector
      if (showActivitiesPhaseDropdown && !event.target.closest('.activities-phase-dropdown')) {
        setShowActivitiesPhaseDropdown(false);
      }
      // TODO section dropdowns
      if (showTodoDropdown && !event.target.closest('.todo-project-selector')) {
        setShowTodoDropdown(false);
      }
      if (showPhaseDropdown && !event.target.closest('.todo-phase-selector')) {
        setShowPhaseDropdown(false);
      }
      // Deliverable phase dropdown
      if (showDeliverablePhaseDropdown && !event.target.closest('.deliverable-phase-dropdown')) {
        setShowDeliverablePhaseDropdown(false);
      }
      // Submission Checking dropdown
      if (submissionCheckingView.showProjectDropdown && !event.target.closest('.project-dropdown-wrapper')) {
        setSubmissionCheckingView(prev => ({
          ...prev,
          showProjectDropdown: false
        }));
      }
      // Deliverables Submission dropdown
      if (deliverablesView.showProjectDropdown && !event.target.closest('.submission-checking-dropdown-container')) {
        setDeliverablesView(prev => ({
          ...prev,
          showProjectDropdown: false
        }));
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showAssignProjectDropdown, showReportsProjectDropdown, showActivitiesProjectDropdown, showActivitiesPhaseDropdown, showTodoDropdown, showPhaseDropdown, showDeliverablePhaseDropdown, taskAssignmentView.showProjectDropdown]);














  // ‚úÖ Load submission history for selected activity
  const loadSubmissionHistory = async (taskId) => {
    try {
      const response = await apiCall(apiConfig.endpoints.tasks.submissionHistory(taskId));
      
      if (!response.ok) {
        throw new Error('Failed to load submission history');
      }
      
      const result = await response.json();
      return result.attempts || [];
    } catch (error) {
      console.error('Error loading submission history:', error);
      return [];
    }
  };

  // ‚úÖ Submit feedback on a submission
  const submitFeedback = async (submissionId, feedbackText, submissionType = 'original') => {
    try {
      const response = await apiCall(apiConfig.endpoints.tasks.feedback, {
        method: 'POST',
        body: JSON.stringify({
          submission_id: submissionId,
          feedback_text: feedbackText,
          submission_type: submissionType
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to submit feedback');
      }
      
      const result = await response.json();
      return result.feedback;
    } catch (error) {
      console.error('Error submitting feedback:', error);
      throw error;
    }
  };

  // Download file function for member task submissions
  const downloadFile = async (fileUrl, fileName) => {
    try {
      // Check if fileUrl is a full URL or just a path
      let fullFileUrl = fileUrl;
      
      // If it's just a file path, we need to construct the full URL
      if (!fileUrl.startsWith('http')) {
        // This might be just a filename or partial path from the database
        console.log('‚ö†Ô∏è File URL appears to be a path, not a full URL:', fileUrl);
        
        // For now, try to use it as is and let the backend handle the URL reconstruction
        // The backend download endpoint should be able to handle partial paths
        fullFileUrl = fileUrl;
      }
      
      console.log('üì• Attempting to download:', fullFileUrl);
      
      const token = localStorage.getItem('token');
      const response = await fetch(
        `${apiConfig.baseURL}/api/student-leader/download-file?fileUrl=${encodeURIComponent(fullFileUrl)}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      );

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Download failed with response:', errorText);
        throw new Error('Failed to download file');
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName || 'downloaded_file';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      
      console.log('‚úÖ File downloaded successfully:', fileName);
    } catch (error) {
      console.error('Download error:', error);
      alert('Failed to download file. Please try again.');
    }
  };

  // ‚úÖ UPDATED: Load grades overview function - fetches from backend API
  // Grade Extraction Logic:
  // - GROUP GRADE: Extracted from the "grade" column in project_deliverable_submissions/phase_deliverable_submissions
  // - INDIVIDUAL GRADE: Extracted from member_tasks[].individual_grade for the current logged-in user
  const loadGradesOverview = async () => {
    try {
      setGradesLoading(true);
      const token = localStorage.getItem('token');
      const urlToCall = `${apiConfig.baseURL}/api/student/grades/overview`;

      console.log('üìä Loading grades overview from:', urlToCall);
      console.log('üìä API Base URL:', apiConfig.baseURL);
      console.log('üìä Has token:', !!token);

      // Fetch grades overview from backend API (new endpoint)
      const response = await fetch(urlToCall, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log('üìä Response status:', response.status);
      console.log('üìä Response ok:', response.ok);
      console.log('üìä Response URL:', response.url);
      console.log('üìä Response headers:', {
        contentType: response.headers.get('content-type'),
        contentLength: response.headers.get('content-length')
      });

      if (!response.ok) {
        const errorData = await response.text();
        console.error('üí• Grades API error:', response.status, errorData);
        throw new Error(`Failed to load grades: ${response.status}`);
      }

      const data = await response.json();
      console.log('‚úÖ Grades overview loaded:', data?.length || 0, 'grades');
      console.log('‚úÖ Data type check - is array:', Array.isArray(data));
      console.log('üìã Grade data:', data);
      console.log('üìã First item keys:', Object.keys(data?.[0] || {}));
      console.log('üìã First item full:', JSON.stringify(data?.[0], null, 2));
      
      // ‚úÖ CRITICAL DEBUG: Check all PROJECT type grades
      const projectGrades = data.filter(g => g.type === 'project');
      console.log('üîç [API RESPONSE] Total PROJECT grades:', projectGrades.length);
      projectGrades.forEach(grade => {
        console.log(`üîç [API RESPONSE] Project: ${grade.projectTitle} (${grade.projectId})`);
        console.log(`   - Group Grade: ${grade.groupGrade}`);
        console.log(`   - Individual Grade: ${grade.individualGrade}`);
        console.log(`   - Status: ${grade.status}`);
        console.log(`   - Full object:`, grade);
      });
      
      // Check what fields exist in first item
      if (data && data.length > 0) {
        const firstItem = data[0];
        console.log('üîç CRITICAL - First item has:');
        console.log('   - id:', firstItem.id);
        console.log('   - projectId:', firstItem.projectId);
        console.log('   - groupGrade:', firstItem.groupGrade);
        console.log('   - title:', firstItem.title);
        console.log('   - rubric:', firstItem.rubric);
        console.log('   - course_id:', firstItem.course_id);
      }
      
      setGradesOverview(data || []);
      setGradesLoading(false);
    } catch (error) {
      console.error('üí• Error loading grades overview:', error);
      setGradesOverview([]);
      setGradesLoading(false);
    }
  };

  // ‚úÖ UPDATED: Load detailed grades function - fetches from backend API (matching Professor Dashboard)
  // Grade Extraction Logic:
  // - GROUP GRADE: Extracted from the "grade" column in submissions
  // - INDIVIDUAL GRADE: Extracted from member_tasks[].individual_grade for the current logged-in user
  const loadDetailedGrades = async (projectId) => {
    try {
      setGradesLoading(true);
      const token = localStorage.getItem('token');

      // Fetch detailed grades from backend API (new endpoint)
      const response = await fetch(
        `${apiConfig.baseURL}/api/student/grades/project/${projectId}`,
        {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!response.ok) {
        throw new Error(`Failed to load detailed grades: ${response.status}`);
      }

      const data = await response.json();
      
      setDetailedGrades(data);
      setGradesLoading(false);
    } catch (error) {
      console.error('Error loading detailed grades:', error);
      setDetailedGrades(null);
      setGradesLoading(false);
    }
  };

// Load Group Stats - fetches grade averages, task completion, and submission activity
const loadGroupStats = async () => {
  try {
    setGroupStatsLoading(true);
    const token = localStorage.getItem('token');

    if (!token || !groupData || !groupData.group_id) {
      console.error('Missing required data for loading group stats');
      setGroupStatsLoading(false);
      return;
    }

    // Find the leader's student_id from groupData
    const leader = groupData.members?.find(member => member.role?.toLowerCase() === 'leader');

    if (!leader) {
      console.error('No leader found in group data');
      setGroupStatsLoading(false);
      return;
    }

    console.log('üìä Loading group stats for group:', groupData.group_id, 'leader:', leader.student_id);

    // Fetch group stats from backend API
    const response = await fetch(
      `${apiConfig.baseURL}/api/student/group-stats/${groupData.group_id}?leaderId=${leader.student_id}`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );

    if (!response.ok) {
      throw new Error(`Failed to load group stats: ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ Group stats loaded:', data);

    setGroupStats({
      phaseGradeAverage: data.phaseGradeAverage || null,
      projectGradeAverage: data.projectGradeAverage || null,
      taskCompletionRate: data.taskCompletionRate || null,
      totalTasks: data.totalTasks || 0,
      completedTasks: data.completedTasks || 0,
      submissionActivity: data.submissionActivity || {
        totalSubmissions: 0,
        onTimeSubmissions: 0,
        lateSubmissions: 0,
        pendingSubmissions: 0
      }
    });

    setGroupStatsLoading(false);
  } catch (error) {
    console.error('üí• Error loading group stats:', error);
    setGroupStatsLoading(false);
  }
};

// Load group stats when viewing "My Group" section
useEffect(() => {
  if (activeTab === 'my-group' && groupData && groupData.group_id) {
    loadGroupStats();
  }
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [activeTab, groupData]);

// In your dashboard header, add this button
const renderDashboardHeader = () => (
  <div className="dashboard-header-with-back">
    <button
      className="back-to-dashboard-btn"
      onClick={() => navigate('/dashboard')}
    >
      <FaArrowLeft />
      Back to Dashboard
    </button>
    <div className="dashboard-header">
      {/* Your existing header content */}
    </div>
  </div>
);
// ‚úÖ ADD: Load evaluations data function
// Add this function to load evaluations data
const loadEvaluationsData = async () => {
  try {
    setEvaluationsLoading(true);
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('user');
    
    if (!token || !userData) {
      console.error('No authentication token or user data found');
      setEvaluationsLoading(false);
      return;
    }

    const user = JSON.parse(userData);
    
    // Fetch evaluations based on current toggle state
    const response = await fetch(
      `${API_BASE_URL}/api/evaluations/student/${user.id}?type=${evaluationTypeToggle}&view=${evaluationViewFilter}`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log(`üìä ${evaluationViewFilter} ${evaluationTypeToggle} evaluations loaded:`, result);
    
    if (result.success) {
      setEvaluationsData(result.data || []);
    } else {
      setEvaluationsData([]);
    }
    
    setEvaluationsLoading(false);
  } catch (error) {
    console.error('‚ùå Error loading evaluations:', error);
    setEvaluationsData([]);
    setEvaluationsLoading(false);
  }
};

// Reload evaluations when toggle states change
useEffect(() => {
  const userData = localStorage.getItem('user');
  if (userData && activeTab === 'evaluations') {
    loadEvaluationsData();
  }
}, [evaluationTypeToggle, evaluationViewFilter, activeTab]);

const handleEvaluationProjectChange = async (project) => {
  setSelectedEvaluationProject(project);
  setShowEvaluationDropdown(false);
  setExpandedGivenEvaluation(null);
  setExpandedReceivedEvaluation(null);
  
  // No longer needed - evaluations are loaded via useEffect based on toggles
};

// ‚úÖ ADD: Load Activities data functions
const loadActivitiesProjectData = async (projectId) => {
  try {
    console.log('üîÑ Loading Activities project data for:', projectId);
    setLoadingActivities(true);
    const token = localStorage.getItem('token');
    
    if (!token) {
      console.error('‚ùå No token found');
      setLoadingActivities(false);
      return null;
    }

    // Get project data from activeProjects first
    let projectData = activeProjects.find(p => p.id === projectId);
    
    // Try to load phases for this project
    if (projectData) {
      try {
        console.log('üîÑ Trying phases endpoint...');
        const phasesResponse = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/phases`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (phasesResponse.ok) {
          const phasesData = await phasesResponse.json();
          console.log('‚úÖ Phases data:', phasesData);
          if (phasesData.success && phasesData.phases) {
            // Merge phases into project data
            if (projectData) {
              projectData.project_phases = phasesData.phases;
            } else {
              // Create project data from activeProjects if detailed endpoint failed
              const baseProject = activeProjects.find(p => p.id === projectId);
              if (baseProject) {
                projectData = { ...baseProject, project_phases: phasesData.phases };
              }
            }
          }
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Phases endpoint failed, trying phases-with-submissions...');
        try {
          const phasesWithSubmissionsResponse = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/phases-with-submissions`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (phasesWithSubmissionsResponse.ok) {
            const phasesWithSubmissionsData = await phasesWithSubmissionsResponse.json();
            console.log('‚úÖ Phases with submissions data:', phasesWithSubmissionsData);
            if (phasesWithSubmissionsData.success && phasesWithSubmissionsData.phases) {
              // Merge phases into project data
              if (projectData) {
                projectData.project_phases = phasesWithSubmissionsData.phases;
              } else {
                const baseProject = activeProjects.find(p => p.id === projectId);
                if (baseProject) {
                  projectData = { ...baseProject, project_phases: phasesWithSubmissionsData.phases };
                }
              }
            }
          }
        } catch (secondError) {
          console.log('‚ö†Ô∏è All phases endpoints failed:', secondError);
        }
      }
    }

    // If still no project data, use activeProjects as fallback
    if (!projectData && activeProjects) {
      const baseProject = activeProjects.find(p => p.id === projectId);
      if (baseProject) {
        projectData = { ...baseProject, project_phases: [] };
        console.log('üìù Using base project from activeProjects:', projectData);
      }
    }

    console.log('üì¶ Final project data:', projectData);
    setLoadingActivities(false);
    
    return { 
      project: projectData, 
      phases: projectData?.project_phases || [] 
    };
  } catch (error) {
    console.error('‚ùå Error loading activities project data:', error);
    setLoadingActivities(false);
    return null;
  }
};

const loadGroupTaskSubmissions = async (phaseId = null, projectId = null) => {
  try {
    console.log('üîÑ Loading group task submissions for phase:', phaseId);
    setLoadingActivities(true);
    const token = localStorage.getItem('token');
    
    const currentProject = projectId || selectedActivitiesProject;
    
    if (!currentProject) {
      console.log('‚ö†Ô∏è No project selected');
      setGroupTaskSubmissions([]);
      setLoadingActivities(false);
      return;
    }

    if (!groupData || !groupData.members) {
      console.log('‚ö†Ô∏è No group data available');
      setGroupTaskSubmissions([]);
      setLoadingActivities(false);
      return;
    }

    console.log('üìä Group members:', groupData.members.length);

    // Fetch ALL tasks for group members in this project
    const allSubmissions = [];
    
    try {
      // Use the /api/student/group-tasks-submissions endpoint to get group member tasks with submissions
      const projectId = typeof currentProject === 'object' ? currentProject.id : currentProject;
      let url = `${apiConfig.baseURL}/api/student/group-tasks-submissions?projectId=${projectId}`;
      if (phaseId) {
        url += `&phaseId=${phaseId}`;
      }

      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        const tasks = data.tasks || [];
        console.log(`‚úÖ Tasks loaded:`, tasks.length);
        
        // Process each task and its submissions
        tasks.forEach(task => {
          // Filter by phase if specified (redundant since backend filters, but keeping for safety)
          if (phaseId && task.phase_id !== phaseId) {
            return;
          }
          
          // Group by task and student, not individual submissions
          if (task.task_submissions && task.task_submissions.length > 0) {
            // Group submissions by the student who submitted them
            task.task_submissions.forEach(submission => {
              const studentId = submission.submitted_by;
              
              // Find the member in the group
              const member = groupData.members.find(m => 
                (m.student_id || m.id) === studentId
              );
              
              if (!member) return; // Skip if not a group member
              
              // Find if we already have this task for this student
              let existingTask = allSubmissions.find(t => 
                t.task_id === task.id && t.student_id === studentId
              );
              
              if (!existingTask) {
                // Get profile image URL from submission data (includes studentaccounts join)
                let profileImageUrl = null;
                if (submission.studentaccounts && submission.studentaccounts.profile_image_url) {
                  const imagePath = submission.studentaccounts.profile_image_url;
                  if (imagePath.startsWith('http')) {
                    profileImageUrl = imagePath;
                  } else {
                    profileImageUrl = `https://qorkowgfjjuwxelumuut.supabase.co/storage/v1/object/public/studentaccounts/${imagePath}`;
                  }
                } else if (member.avatar_url || member.profile_image_url) {
                  // Fallback to member data if available
                  const imagePath = member.avatar_url || member.profile_image_url;
                  if (imagePath.startsWith('http')) {
                    profileImageUrl = imagePath;
                  } else {
                    profileImageUrl = `https://qorkowgfjjuwxelumuut.supabase.co/storage/v1/object/public/studentaccounts/${imagePath}`;
                  }
                }
                
                // Get phase info from activitiesPhases if available
                const phaseInfo = activitiesPhases.find(p => p.id === task.phase_id);
                
                // Create new task entry for this student
                existingTask = {
                  task_id: task.id,
                  task_title: task.title,
                  task_description: task.description,
                  due_date: task.due_date,
                  available_until: task.available_until,
                  max_attempts: task.max_attempts,
                  file_types_allowed: task.file_types_allowed,
                  assigned_by: task.assigned_by,
                  phase_id: task.phase_id,
                  phase_number: phaseInfo?.phase_number || null,
                  phase_title: phaseInfo?.title || null,
                  student_id: studentId,
                  student_name: member.name || `${member.first_name || ''} ${member.last_name || ''}`.trim(),
                  student_first_name: member.first_name || member.name?.split(' ')[0] || 'Unknown',
                  student_last_name: member.last_name || member.name?.split(' ').slice(1).join(' ') || '',
                  profile_image_url: profileImageUrl,
                  submissions: [],
                  latest_submission: null
                };
                allSubmissions.push(existingTask);
              }
              
              // Add this submission to the task's submissions array
              // Parse file_urls if it's a JSON string and use backend API for download
              let fileUrls = [];
              if (submission.file_urls) {
                try {
                  let parsedUrls = typeof submission.file_urls === 'string' 
                    ? JSON.parse(submission.file_urls) 
                    : submission.file_urls;
                  
                  if (!Array.isArray(parsedUrls)) {
                    parsedUrls = [];
                  }
                  
                  // Use backend API endpoint for file downloads (handles authentication and access control)
                  fileUrls = parsedUrls.map(path => {
                    // If already a full URL, return as is
                    if (path.startsWith('http') || path.startsWith('/api/files')) {
                      return path;
                    }
                    // Otherwise, use backend API endpoint
                    return `/api/files/task-submissions/${path}`;
                  });
                } catch (e) {
                  console.error('Error parsing file_urls:', e);
                  fileUrls = [];
                }
              }
              
              // Check if this attempt already exists (prevent duplicates)
              const existingSubmission = existingTask.submissions.find(
                s => s.attempt_number === submission.attempt_number
              );
              
              if (!existingSubmission) {
                existingTask.submissions.push({
                  id: submission.id,
                  attempt_number: submission.attempt_number,
                  submission_date: submission.submission_date || submission.created_at,
                  submission_text: submission.submission_text,
                  file_urls: fileUrls,
                  status: submission.status,
                  review_comments: submission.review_comments,
                  reviewed_by: submission.reviewed_by,
                  reviewed_at: submission.reviewed_at
                });
              }
              
              // Update latest submission
              if (!existingTask.latest_submission || 
                  submission.attempt_number > existingTask.latest_submission.attempt_number) {
                existingTask.latest_submission = submission;
              }
            });
          }
        });
        
        // Sort submissions by attempt number descending for each task
        allSubmissions.forEach(taskGroup => {
          taskGroup.submissions.sort((a, b) => b.attempt_number - a.attempt_number);
        });
      }
    } catch (fetchError) {
      console.error(`‚ùå Error fetching tasks:`, fetchError);
    }
    
    console.log('‚úÖ Total task groups collected:', allSubmissions.length);
    setGroupTaskSubmissions(allSubmissions);
    setLoadingActivities(false);
  } catch (error) {
    console.error('‚ùå Error loading group task submissions:', error);
    setGroupTaskSubmissions([]);
    setLoadingActivities(false);
  }
};

// NEW: Load ALL tasks assigned to group members (regardless of submission status)
const loadAllGroupTasks = async (projectId, phaseId = null) => {
  try {
    console.log('üîÑ Loading ALL group tasks for project:', projectId, 'phase:', phaseId);
    const token = localStorage.getItem('token');
    
    if (!projectId) {
      setAllGroupTasks([]);
      return;
    }
    
    // Get member IDs from groupMembers
    if (!groupMembers || groupMembers.length === 0) {
      console.log('‚ö†Ô∏è No group members available');
      setAllGroupTasks([]);
      return;
    }
    
    const memberIds = groupMembers.map(m => m.student_id).join(',');
    console.log('üìù Member IDs for query:', memberIds);
    
    let url = `${apiConfig.baseURL}/api/student/group-tasks?projectId=${projectId}&memberIds=${memberIds}`;
    if (phaseId) {
      url += `&phaseId=${phaseId}`;
    }
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ All group tasks loaded:', data.tasks?.length || 0);
      
      // Organize tasks by student
      const tasksByStudent = {};
      
      for (const task of data.tasks || []) {
        const studentId = task.assigned_to;
        
        if (!tasksByStudent[studentId]) {
          // Find member info from groupMembers
          const member = groupMembers?.find(m => m.student_id === studentId);
          
          tasksByStudent[studentId] = {
            student_id: studentId,
            student_name: member?.name || 'Unknown',
            student_first_name: member?.first_name || member?.name?.split(' ')[0] || 'Unknown',
            student_last_name: member?.last_name || member?.name?.split(' ').slice(1).join(' ') || '',
            profile_image_url: member?.profile_image_url || null,
            tasks: []
          };
        }
        
        tasksByStudent[studentId].tasks.push(task);
      }
      
      console.log('üìä Tasks organized by student:', Object.keys(tasksByStudent).length, 'students');
      setAllGroupTasks(Object.values(tasksByStudent));
    } else {
      console.error('‚ùå Failed to load group tasks:', response.status);
      setAllGroupTasks([]);
    }
  } catch (error) {
    console.error('‚ùå Error loading all group tasks:', error);
    setAllGroupTasks([]);
  }
};

// Load Project Progress Data (Phase Deliverable Submissions + Project Submission)
const loadProjectProgressData = async (projectId) => {
  try {
    console.log('üîÑ Loading project progress data for project:', projectId);
    setProjectProgressData(prev => ({ ...prev, loading: true }));
    
    const token = localStorage.getItem('token');
    // Use groupData.group_id (the actual group ID), not groupData.id (the membership record ID)
    const groupId = groupData?.group_id || groupData?.id;
    
    if (!token || !projectId || !groupId) {
      console.log('‚ö†Ô∏è Missing required data for progress loading');
      setProjectProgressData({ phaseSubmissions: [], projectSubmission: null, loading: false });
      return;
    }
    
    console.log('üìç Using group ID:', groupId);
    
    // Load phase deliverable submissions
    const phaseResponse = await fetch(
      `${apiConfig.baseURL}/api/student/projects/${projectId}/phase-deliverable-submissions?group_id=${groupId}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    // Load project deliverable submission
    const projectResponse = await fetch(
      `${apiConfig.baseURL}/api/student/projects/${projectId}/deliverable-submissions?group_id=${groupId}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    let phaseSubmissions = [];
    let projectSubmission = null;
    
    if (phaseResponse.ok) {
      const phaseData = await phaseResponse.json();
      phaseSubmissions = phaseData.submissions || phaseData.phaseSubmissions || [];
      console.log('‚úÖ Phase deliverable submissions loaded:', phaseSubmissions.length);
    } else {
      console.warn('‚ö†Ô∏è Failed to load phase submissions');
    }
    
    if (projectResponse.ok) {
      const projectData = await projectResponse.json();
      // Use the submissions array from the response
      const submissions = projectData.submissions || [];
      projectSubmission = submissions.length > 0 ? submissions[0] : null;
      console.log('‚úÖ Project deliverable submission loaded:', projectSubmission ? 'Yes' : 'No');
    } else {
      console.warn('‚ö†Ô∏è Failed to load project deliverable submission');
    }
    
    setProjectProgressData({
      phaseSubmissions,
      projectSubmission,
      loading: false
    });
    
  } catch (error) {
    console.error('‚ùå Error loading project progress data:', error);
    setProjectProgressData({ phaseSubmissions: [], projectSubmission: null, loading: false });
  }
};

const loadTaskSubmissionDetails = async (taskId) => {
  try {
    setLoadingActivities(true);
    const token = localStorage.getItem('token');
    
    const response = await fetch(`${apiConfig.baseURL}/api/student/tasks/${taskId}/submissions`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch task details: ${response.status}`);
    }
    
    const data = await response.json();
    setTaskSubmissionDetails(data);
    setLoadingActivities(false);
  } catch (error) {
    console.error('Error loading task submission details:', error);
    setTaskSubmissionDetails(null);
    setLoadingActivities(false);
  }
};

const loadSubmissionFeedbacks = async (taskId, attemptNumber) => {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`${apiConfig.baseURL}/api/tasks/${taskId}/attempts/${attemptNumber}/feedback`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch feedbacks: ${response.status}`);
    }
    
    const data = await response.json();
    // Transform feedback data to match our format
    const transformedFeedbacks = (data.feedback || []).map(feedback => ({
      id: feedback.id,
      reviewer_name: `${feedback.studentaccounts.first_name} ${feedback.studentaccounts.last_name}`,
      comment_text: feedback.feedback_text,
      created_at: feedback.created_at,
      rating: feedback.rating,
      is_from_leader: feedback.is_from_leader,
      profile_image_url: feedback.studentaccounts.profile_image_url
    }));
    setSubmissionFeedbacks(transformedFeedbacks);
  } catch (error) {
    console.error('Error loading submission feedbacks:', error);
    setSubmissionFeedbacks([]);
  }
};

// Load Phase Deliverable Submissions for Activities Tab
const loadActivitiesPhaseSubmissions = async (projectId = null) => {
  try {
    console.log('üîÑ Loading phase deliverable submissions for Activities tab');
    setLoadingPhaseSubmissionsView(true);
    const token = localStorage.getItem('token');
    
    const currentProject = projectId || selectedActivitiesProject;
    
    if (!currentProject) {
      console.log('‚ö†Ô∏è No project selected');
      setActivitiesPhaseSubmissions([]);
      setLoadingPhaseSubmissionsView(false);
      return;
    }

    const projectIdValue = typeof currentProject === 'object' ? currentProject.id : currentProject;
    
    // Get the correct group_id (from course_group_members.group_id, NOT .id which is membership ID)
    const groupId = groupData?.group_id || groupData?.id;
    
    if (!groupId) {
      console.log('‚ö†Ô∏è No group ID available');
      console.log('‚ö†Ô∏è groupData:', groupData);
      setActivitiesPhaseSubmissions([]);
      setLoadingPhaseSubmissionsView(false);
      return;
    }
    
    console.log('üìã Using group_id:', groupId, 'for project:', projectIdValue);
    console.log('üìã groupData:', groupData);
    
    // Fetch phase deliverable submissions for this group
    const response = await fetch(
      `${apiConfig.baseURL}/api/student/projects/${projectIdValue}/phase-deliverable-submissions?group_id=${groupId}`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (response.ok) {
      const data = await response.json();
      const submissions = data.submissions || [];
      console.log(`‚úÖ Phase deliverable submissions loaded:`, submissions.length);
      setActivitiesPhaseSubmissions(submissions);
      
      // Auto-select the first submission if available
      if (submissions.length > 0 && !selectedPhaseSubmission) {
        setSelectedPhaseSubmission(submissions[0]);
      }
    } else {
      console.error('‚ùå Failed to load phase deliverable submissions');
      setActivitiesPhaseSubmissions([]);
    }
    
    setLoadingPhaseSubmissionsView(false);
  } catch (error) {
    console.error('Error loading phase deliverable submissions:', error);
    setActivitiesPhaseSubmissions([]);
    setLoadingPhaseSubmissionsView(false);
  }
};

const handleActivitiesProjectChange = async (project) => {
  setSelectedActivitiesProject(project);
  setSelectedActivitiesPhase(null);
  setShowActivitiesProjectDropdown(false);
  
  if (project) {
    const data = await loadActivitiesProjectData(project.id);
    if (data && data.phases.length > 0) {
      // Store phases and auto-select first phase
      setActivitiesPhases(data.phases);
      setSelectedActivitiesPhase(data.phases[0]);
      await loadGroupTaskSubmissions(data.phases[0].id, project);
      await loadAllGroupTasks(project.id, data.phases[0].id); // NEW: Load all tasks
    } else {
      setActivitiesPhases([]);
    }
    
    // Load project progress data (phase submissions + project submission)
    await loadProjectProgressData(project.id);
  }
};

const handleActivitiesPhaseChange = async (phase) => {
  setSelectedActivitiesPhase(phase);
  setShowActivitiesPhaseDropdown(false);
  
  // Allow null phase to view project-level data
  if (phase && phase.id) {
    await loadGroupTaskSubmissions(phase.id, selectedActivitiesProject);
    await loadAllGroupTasks(selectedActivitiesProject?.id, phase.id);
  } else {
    // Load all submissions across all phases (pass null as phaseId)
    await loadGroupTaskSubmissions(null, selectedActivitiesProject);
    await loadAllGroupTasks(selectedActivitiesProject?.id, null);
  }
};

const handleTaskSubmissionClick = async (taskGroup) => {
  setSelectedTaskSubmission(taskGroup);
  // Reset feedback form
  setGroupFeedbackText('');
  // Auto-select the approved attempt if it exists, otherwise select the latest attempt
  if (taskGroup.submissions && taskGroup.submissions.length > 0) {
    // Look for approved attempt first
    const approvedAttempt = taskGroup.submissions.find(s => s.status === 'approved');
    const selectedAttemptData = approvedAttempt || taskGroup.submissions[0]; // Approved first, or latest
    setSelectedAttempt(selectedAttemptData);
    await loadSubmissionFeedbacks(taskGroup.task_id, selectedAttemptData.attempt_number);
  }
};

const handleAttemptChange = async (attempt) => {
  setSelectedAttempt(attempt);
  // Reset feedback form when changing attempts
  setGroupFeedbackText('');
  if (selectedTaskSubmission) {
    await loadSubmissionFeedbacks(selectedTaskSubmission.task_id, attempt.attempt_number);
  }
};

const handleSubmitGroupFeedback = async () => {
  if (!groupFeedbackText.trim() || !selectedTaskSubmission || !selectedAttempt) {
    alert('Please enter feedback text');
    return;
  }

  try {
    setSubmittingGroupFeedback(true);
    const token = localStorage.getItem('token');
    
    const response = await fetch(`${apiConfig.baseURL}/api/tasks/${selectedTaskSubmission.task_id}/attempts/${selectedAttempt.attempt_number}/feedback`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        feedback_text: groupFeedbackText,
        rating: null
      })
    });

    if (!response.ok) {
      throw new Error(`Failed to submit feedback: ${response.status}`);
    }

    // Reload feedbacks
    await loadSubmissionFeedbacks(selectedTaskSubmission.task_id, selectedAttempt.attempt_number);
    
    // Clear form
    setGroupFeedbackText('');
    
    alert('Feedback submitted successfully!');
  } catch (error) {
    console.error('Error submitting feedback:', error);
    alert('Failed to submit feedback. Please try again.');
  } finally {
    setSubmittingGroupFeedback(false);
  }
};

// Main content renderer based on activeTab
const renderContent = () => {
  switch (activeTab) {
    case 'course-overview':
      return renderCourseOverview();
    case 'project-dashboard':
      return renderProjectDashboard();
    case 'my-group':
      return renderMyGroup();
    case 'my-grades':
      return renderMyGrades();
    case 'announcements':
      return renderAnnouncements();
    case 'notifications':
      return renderNotifications();
    case 'evaluations':
      return renderEvaluations();
    case 'member-submissions':
      return renderMemberSubmissions();
    case 'submission-checking':
      return renderSubmissionChecking();
    case 'task-assignment':
      return renderTaskAssignment();
    case 'deliverables-submission':
      return renderDeliverablesSubmission();
    default:
      return renderCourseOverview();
  }
};

const handleBackToHome = () => {
  // Navigate to the appropriate dashboard based on user type
  const userData = localStorage.getItem('user');
  if (userData) {
    const user = JSON.parse(userData);
    if (user.userType === 'student') {
      navigate('/student-dashboard');
    } else if (user.userType === 'professor') {
      navigate('/professor-dashboard');
    } else if (user.userType === 'admin') {
      navigate('/admin');
    }
  } else {
    navigate('/');
  }
};





// ‚úÖ UPDATE: Enhanced handleGradeProjectChange function
const handleGradeProjectChange = async (project) => {
  if (project.id === 'overview') {
    setSelectedGradeProject(null);
    setDetailedGrades(null);
    setEvaluationsData(null);
  } else {
    setSelectedGradeProject(project);
    await Promise.all([
      loadDetailedGrades(project.id),
      loadEvaluationsData(project.id)
    ]);
  }
  setShowGradeDropdown(false);
};

  // ‚úÖ ADD: Calculate overall grade function at component level
  const calculateOverallGrade = (phaseGrades, taskGrades, finalGrade) => {
    let totalScore = 0;
    let totalWeight = 0;
    
    // Phase grades (40% weight)
    if (phaseGrades?.length > 0) {
      const phaseAvg = phaseGrades.reduce((sum, grade) => sum + (grade.final_phase_grade || 0), 0) / phaseGrades.length;
      totalScore += phaseAvg * 0.4;
      totalWeight += 0.4;
    }
    
    // Task grades (30% weight)
    if (taskGrades?.length > 0) {
      const taskAvg = taskGrades.reduce((sum, grade) => sum + (grade.grade || 0), 0) / taskGrades.length;
      totalScore += taskAvg * 0.3;
      totalWeight += 0.3;
    }
    
    // Final project grade (30% weight)
    if (finalGrade) {
      totalScore += finalGrade * 0.3;
      totalWeight += 0.3;
    }
    
    return totalWeight > 0 ? (totalScore / totalWeight * 100).toFixed(1) : 'N/A';
  };

  // ‚úÖ ADD: useEffect for loading grades overview
  useEffect(() => {
    loadGradesOverview();
  }, []);


// Add this to your useEffect to load active projects
// Update your loadActiveProjects function in CourseStudentDashboard.js
// Update your useEffect to load active projects
useEffect(() => {
  const loadActiveProjects = async () => {
    try {
      console.log('üîÑ Loading active projects...');
      const token = localStorage.getItem('token');
      
      if (!token) {
        console.error('‚ùå No token found');
        return;
      }
      
      const response = await apiCall(apiConfig.endpoints.studentLeader.projects);
      
      console.log('üìä Response status:', response.status);
      
      if (response.ok) {
        const data = await response.json(); // ‚úÖ Changed variable name to 'data'
        console.log('‚úÖ Projects loaded:', data);
        
        // ‚úÖ FIXED: Extract the projects array from the response
        if (data.success && Array.isArray(data.projects)) {
          setActiveProjects(data.projects); // ‚úÖ Use data.projects instead of data
          console.log('‚úÖ Active projects set:', data.projects);
          console.log('üîç First project structure:', data.projects[0]);
          console.log('üîç First project has phases?', data.projects[0]?.project_phases);
        } else {
          console.error('‚ùå Invalid response structure:', data);
          setActiveProjects([]); // ‚úÖ Set empty array as fallback
        }
      } else {
        const errorText = await response.text();
        console.error('‚ùå API Error:', response.status, errorText);
        setActiveProjects([]); // ‚úÖ Set empty array on error
      }
    } catch (error) {
      console.error('‚ùå Loading error:', error);
      setActiveProjects([]); // ‚úÖ Set empty array on error
    }
  };

  loadActiveProjects();
}, []);

// Fetch evaluation submissions when phase or project changes
useEffect(() => {
  console.log('üîÑ [FETCH SUBMISSIONS EFFECT] useEffect triggered, checking conditions...', {
    hasSelectedProject: !!selectedProject,
    groupId: selectedProject?.group_id,
    hasGroupId: !!selectedProject?.group_id,
    currentPhaseId: currentPhase?.id,
    viewedPhaseId: viewedPhase?.id,
    selectedProjectId: selectedProject?.id,
    condition1: !!selectedProject?.group_id,
    condition2: !!(currentPhase?.id || selectedProject?.id),
    bothConditions: !!(selectedProject?.group_id && (currentPhase?.id || selectedProject?.id))
  });
  
  if (selectedProject?.group_id && (currentPhase?.id || selectedProject?.id)) {
    // Use viewedPhase if available (user navigated), otherwise use currentPhase
    const phaseToCheck = viewedPhase || currentPhase;
    
    console.log('‚úÖ [FETCH SUBMISSIONS EFFECT] Conditions met! Triggering fetch:', {
      selectedProjectId: selectedProject?.id,
      groupId: selectedProject.group_id,
      phaseToCheckId: phaseToCheck?.id,
      viewedPhaseId: viewedPhase?.id,
      currentPhaseId: currentPhase?.id
    });
    
    // ‚úÖ FIX: Fetch ALL submissions (both phase and project) in ONE call
    // This prevents the second fetch from overwriting the first
    console.log('üîµüî∂ [FETCH SUBMISSIONS EFFECT] Fetching ALL submissions (phase + project)');
    fetchMyEvaluationSubmissions(selectedProject.group_id, null, null);
  } else {
    console.log('‚ö†Ô∏è [FETCH SUBMISSIONS EFFECT] Conditions NOT met, submissions not fetched');
  }
}, [selectedProject?.id, currentPhase?.id, viewedPhase]);

// Fetch group members function
const fetchGroupMembers = async (projectId) => {
  if (!projectId) return;
  
  setLoadingMembers(true);
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${apiConfig.baseURL}/api/student-leader/projects/${projectId}/members`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      console.log('üîç Raw API response:', data);
      
      // Handle different response structures
      let members = [];
      if (Array.isArray(data)) {
        // Direct array response
        members = data;
      } else if (data.success && Array.isArray(data.members)) {
        // Object with members array
        members = data.members;
      } else if (data.members && Array.isArray(data.members)) {
        // Object with members array (no success field)
        members = data.members;
      } else {
        console.error('‚ùå Invalid members data structure:', data);
        members = [];
      }
      
      // Normalize member data structure and construct profile image URLs
      const normalizedMembers = members.map(member => {
        // Construct proper profile image URL
        let profileImageUrl = null;
        if (member.avatar_url || member.profile_image_url) {
          const imagePath = member.avatar_url || member.profile_image_url;
          if (imagePath.startsWith('http')) {
            profileImageUrl = imagePath;
          } else {
            profileImageUrl = `https://qorkowgfjjuwxelumuut.supabase.co/storage/v1/object/public/studentaccounts/${imagePath}`;
          }
        }

        return {
          id: member.student_id || member.id,
          student_id: member.student_id || member.id,
          name: member.name || `${member.first_name || ''} ${member.last_name || ''}`.trim(),
          full_name: member.name || `${member.first_name || ''} ${member.last_name || ''}`.trim(),
          first_name: member.first_name,
          last_name: member.last_name,
          surname: member.last_name,
          email: member.email,
          avatar_url: member.avatar_url,
          profile_image_url: profileImageUrl,
          role: member.role,
          is_leader: member.role === 'leader',
          completed_tasks: member.completed_tasks || 0
        };
      });

      setGroupMembers(normalizedMembers);
      console.log('‚úÖ Group members loaded:', normalizedMembers);
    } else {
      console.error('‚ùå Failed to fetch group members:', response.status);
      setGroupMembers([]);
    }
  } catch (error) {
    console.error('‚ùå Error fetching group members:', error);
    setGroupMembers([]);
  } finally {
    setLoadingMembers(false);
  }
};

// Fetch Project Rubric Data
const fetchProjectRubric = async (projectId) => {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/api/student/projects/${projectId}/rubric`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      setProjectRubricData(data);
      console.log('‚úÖ Project rubric loaded:', data);
    } else if (response.status === 404) {
      console.log('‚ÑπÔ∏è No rubric found for this project');
      setProjectRubricData({ error: 'not_found' });
    } else {
      console.error('‚ùå Failed to fetch project rubric:', response.status);
      setProjectRubricData({ error: 'fetch_error' });
    }
  } catch (error) {
    console.error('‚ùå Error fetching project rubric:', error);
    setProjectRubricData({ error: 'fetch_error' });
  }
};

// Fetch Project Evaluation Data
const fetchProjectEvaluation = async (projectId) => {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/api/student/projects/${projectId}/evaluation-form`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      setProjectEvaluationData(data);
      console.log('‚úÖ Project evaluation loaded:', data);
    } else if (response.status === 404) {
      console.log('‚ÑπÔ∏è No evaluation form found for this project');
      setProjectEvaluationData({ error: 'not_found' });
    } else {
      console.error('‚ùå Failed to fetch project evaluation:', response.status);
      setProjectEvaluationData({ error: 'fetch_error' });
    }
  } catch (error) {
    console.error('‚ùå Error fetching project evaluation:', error);
    setProjectEvaluationData({ error: 'fetch_error' });
  }
};

// Fetch Phase Rubric Data
const fetchPhaseRubric = async (phaseId, setRubricData, setLoading) => {
  try {
    setLoading(true);
    const token = localStorage.getItem('token');
    const response = await fetch(`${apiConfig.baseURL}/api/student/phases/${phaseId}/rubric`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      setRubricData(data);
      console.log('‚úÖ Phase rubric loaded:', data);
    } else if (response.status === 404) {
      console.log('‚ÑπÔ∏è No rubric found for this phase');
      setRubricData({ error: 'not_found' });
    } else {
      console.error('‚ùå Failed to fetch phase rubric:', response.status);
      setRubricData({ error: 'fetch_error' });
    }
  } catch (error) {
    console.error('‚ùå Error fetching phase rubric:', error);
    setRubricData({ error: 'fetch_error' });
  } finally {
    setLoading(false);
  }
};

// Fetch Phase Evaluation Form Data
const fetchPhaseEvaluationForm = async (phaseId, setEvalFormData, setLoading) => {
  try {
    setLoading(true);
    const token = localStorage.getItem('token');
    const response = await fetch(`${apiConfig.baseURL}/api/student/phases/${phaseId}/evaluation-form`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      setEvalFormData(data);
      console.log('‚úÖ Phase evaluation form loaded:', data);
    } else if (response.status === 404) {
      console.log('‚ÑπÔ∏è No evaluation form found for this phase');
      setEvalFormData({ error: 'not_found' });
    } else {
      console.error('‚ùå Failed to fetch phase evaluation form:', response.status);
      setEvalFormData({ error: 'fetch_error' });
    }
  } catch (error) {
    console.error('‚ùå Error fetching phase evaluation form:', error);
    setEvalFormData({ error: 'fetch_error' });
  } finally {
    setLoading(false);
  }
};

// Fetch My Evaluation Submissions
const fetchMyEvaluationSubmissions = async (groupId, phaseId = null, projectId = null) => {
  try {
    // ‚úÖ FIX: Don't fetch if groupId is invalid
    if (!groupId) {
      console.log('‚ö†Ô∏è [FETCH SUBMISSIONS] No groupId provided, skipping fetch');
      setMyEvaluationSubmissions([]);
      setGroupMembersForEvaluation([]);
      return null;
    }
    
    setEvaluationScoresLoading(true);
    setMyEvaluationSubmissionsLoading(true); // ‚úÖ Set loading state
    const token = localStorage.getItem('token');
    
    let url = `${apiConfig.baseURL}/api/student/groups/${groupId}/evaluations/my-submissions?`;
    if (phaseId) {
      url += `phaseId=${phaseId}`;
    } else if (projectId) {
      url += `projectId=${projectId}`;
    }

    console.log('üîç [FETCH SUBMISSIONS] Fetching from:', url);
    console.log('üìä [FETCH SUBMISSIONS] Params - groupId:', groupId, 'phaseId:', phaseId, 'projectId:', projectId);

    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      console.log('üì¶ [FETCH SUBMISSIONS] Raw response data:', data);
      console.log('üì¶ [FETCH SUBMISSIONS] Submissions count:', data.submissions?.length || 0);
      
      // Add type field to distinguish phase vs project evaluations
      // ‚úÖ FIX: Use unique identifier fields to determine submission type
      // - Phase evaluations: have phase_evaluation_form_id
      // - Project evaluations: have project_evaluation_form_id  
      // - Regular evaluations: have evaluated_student_id
      const submissionsWithType = (data.submissions || []).map(sub => ({
        ...sub,
        type: sub.phase_evaluation_form_id ? 'phase_evaluation' : 
              (sub.project_evaluation_form_id ? 'project_evaluation' : 
               'regular_evaluation')
      }));
      
      console.log('üìä [FETCH SUBMISSIONS] Setting state with:', submissionsWithType.length, 'submissions');
      setMyEvaluationSubmissions(submissionsWithType);
      setGroupMembersForEvaluation(data.groupMembers || []);
      setMyEvaluationSubmissionsLoading(false); // ‚úÖ Clear loading state
      
      console.log('‚úÖ [FETCH SUBMISSIONS] My evaluation submissions loaded:', submissionsWithType.length, 'submissions');
      if (submissionsWithType.length > 0) {
        console.log('üìã [FETCH SUBMISSIONS] First submission:', submissionsWithType[0]);
      }
      return { ...data, submissions: submissionsWithType };
    } else if (response.status === 403) {
      // User doesn't have permission to this group - silently skip
      console.log('‚ÑπÔ∏è [FETCH SUBMISSIONS] No access to group evaluations (may not be in this group)');
      setMyEvaluationSubmissions([]);
      setGroupMembersForEvaluation([]);
      setMyEvaluationSubmissionsLoading(false);
      return null;
    } else {
      console.error('‚ùå [FETCH SUBMISSIONS] Failed to fetch evaluation submissions:', response.status);
      const errorData = await response.json().catch(() => ({}));
      console.error('‚ùå [FETCH SUBMISSIONS] Error response:', errorData);
      setMyEvaluationSubmissions([]);
      setGroupMembersForEvaluation([]);
      setMyEvaluationSubmissionsLoading(false); // ‚úÖ Clear loading state on error
      return null;
    }
  } catch (error) {
    console.error('‚ùå [FETCH SUBMISSIONS] Error fetching evaluation submissions:', error);
    setMyEvaluationSubmissionsLoading(false); // ‚úÖ Clear loading state on error
    setMyEvaluationSubmissions([]);
    setGroupMembersForEvaluation([]);
    return null;
  } finally {
    setEvaluationScoresLoading(false);
  }
};

// Fetch Received Evaluations (scores given TO me by others)
const fetchReceivedEvaluations = async (groupId, phaseId = null, projectId = null) => {
  try {
    setEvaluationScoresLoading(true);
    const token = localStorage.getItem('token');
    
    let url = `${API_BASE_URL}/api/student/groups/${groupId}/evaluations/received?`;
    if (phaseId) {
      url += `phaseId=${phaseId}`;
    } else if (projectId) {
      url += `projectId=${projectId}`;
    }

    console.log('üîç Fetching received evaluations from:', url);

    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      setReceivedEvaluations(data.submissions || []);
      // Only set groupMembers if we don't already have them OR if the returned list is not empty
      if ((groupMembersForEvaluation.length === 0 && data.groupMembers?.length > 0) || data.groupMembers?.length > 0) {
        setGroupMembersForEvaluation(data.groupMembers || []);
      }
      console.log('‚úÖ Received evaluations loaded:', data);
      console.log('üìù Group members from API:', data.groupMembers?.length || 0);
      return data;
    } else {
      console.error('‚ùå Failed to fetch received evaluations:', response.status);
      setReceivedEvaluations([]);
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error fetching received evaluations:', error);
    setReceivedEvaluations([]);
    setGroupMembersForEvaluation([]);
    return null;
  } finally {
    setEvaluationScoresLoading(false);
  }
};

// Fetch group members when on my-group tab
useEffect(() => {
  if (activeTab === 'my-group') {
    // Try to fetch from the first available project or use a default
    if (selectedGroupProject) {
      fetchGroupMembers(selectedGroupProject.id);
    } else if (projects.length > 0) {
      fetchGroupMembers(projects[0].id);
    }
  }
}, [activeTab]);

// Sort and center current user when members are loaded
useEffect(() => {
  if (groupMembers.length > 0) {
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    const currentUserId = currentUser.id || currentUser.student_id;
    
    // Sort members alphabetically by surname, but keep current user first
    const sortedMembers = [...groupMembers].sort((a, b) => {
      const aIsCurrentUser = (a.id || a.student_id) === currentUserId;
      const bIsCurrentUser = (b.id || b.student_id) === currentUserId;
      
      // Current user always comes first
      if (aIsCurrentUser && !bIsCurrentUser) return -1;
      if (!aIsCurrentUser && bIsCurrentUser) return 1;
      
      // For non-current users, sort alphabetically by surname
      if (!aIsCurrentUser && !bIsCurrentUser) {
        const aSurname = (a.surname || a.last_name || a.name?.split(' ').pop() || '').toLowerCase();
        const bSurname = (b.surname || b.last_name || b.name?.split(' ').pop() || '').toLowerCase();
        return aSurname.localeCompare(bSurname);
      }
      
      return 0;
    });
    
    // Update the sorted members
    setSortedGroupMembers(sortedMembers);
    
    // Center current user (they should be at index 0 after sorting)
    const currentUserIndex = sortedMembers.findIndex(member => 
      (member.id || member.student_id) === currentUserId
    );
    
    if (currentUserIndex !== -1) {
      const membersPerPage = 5;
      const targetPage = Math.floor(currentUserIndex / membersPerPage);
      setCurrentMemberPage(targetPage);
    }
  }
}, [groupMembers]);

// Fetch recent feedbacks and submissions
const fetchRecentActivity = async () => {
  try {
    console.log('üîÑ Fetching recent activity...');
    setRecentActivityLoading(true);
    const token = localStorage.getItem('token');
    
    // Fetch both in parallel for better performance
    const [feedbackResponse, submissionsResponse] = await Promise.all([
      fetch(`${apiConfig.baseURL}/api/student/recent-feedbacks`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }),
      fetch(`${apiConfig.baseURL}/api/student/recent-submissions`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
    ]);
    
    // Process feedback response
    console.log('üì• Feedback response status:', feedbackResponse.status);
    if (feedbackResponse.ok) {
      const feedbackData = await feedbackResponse.json();
      console.log('‚úÖ Feedback data:', feedbackData);
      setRecentFeedbacks(feedbackData.feedbacks || []);
    } else {
      console.error('‚ùå Feedback response not OK:', await feedbackResponse.text());
    }
    
    // Process submissions response
    console.log('üì• Submissions response status:', submissionsResponse.status);
    if (submissionsResponse.ok) {
      const submissionsData = await submissionsResponse.json();
      console.log('‚úÖ Submissions data:', submissionsData);
      setRecentSubmissions(submissionsData.submissions || []);
    } else {
      console.error('‚ùå Submissions response not OK:', await submissionsResponse.text());
    }
  } catch (error) {
    console.error('‚ùå Error fetching recent activity:', error);
  } finally {
    setRecentActivityLoading(false);
  }
};

// Load recent activity on mount and when on my-group tab
useEffect(() => {
  if (activeTab === 'my-group' || activeTab === 'course-overview') {
    fetchRecentActivity();
  }
}, [activeTab]);

// Fetch evaluation submissions when selectedEvaluationPhase changes
useEffect(() => {
  if (selectedEvaluationPhase && groupData?.id && activeTab === 'my-group') {
    const isProject = selectedEvaluationPhase === 'project';
    if (isProject && selectedReportsProject?.id) {
      // Fetch both: submissions I gave AND evaluations I received
      fetchMyEvaluationSubmissions(groupData.id, null, selectedReportsProject.id);
      fetchReceivedEvaluations(groupData.id, null, selectedReportsProject.id);
    } else if (!isProject && selectedEvaluationPhase?.id) {
      fetchMyEvaluationSubmissions(groupData.id, selectedEvaluationPhase.id, null);
      fetchReceivedEvaluations(groupData.id, selectedEvaluationPhase.id, null);
    }
  }
}, [selectedEvaluationPhase, groupData?.id, selectedReportsProject?.id, activeTab]);

// Sync Reports Project with Gantt Project when navigating to Reports tab
useEffect(() => {
  if (activeTab === 'my-group' && selectedReportsProject?.id) {
    console.log('üîÑ Syncing Reports project with Gantt state:', selectedReportsProject.id);
    // Load full project data to ensure evaluation dates are populated
    loadGanttProjectData(selectedReportsProject.id);
    // Load project progress data (includes phase submissions for pie chart)
    loadProjectProgressData(selectedReportsProject.id);
    setSelectedGanttPhase(null);
    setShowGanttProjectDropdown(false);
    // Reset all phases to visible when project changes
    const allPhaseIds = new Set(selectedReportsProject.project_phases?.map(p => p.id) || []);
    setVisiblePhases(allPhaseIds);
  }
}, [selectedReportsProject?.id, activeTab]);

// Load tasks for REPORTS tab when project changes
useEffect(() => {
  if (activeTab === 'my-group' && selectedGanttProject?.id && groupMembers.length > 0) {
    // Load ALL tasks from ALL phases by not passing phaseId
    console.log('üîÑ Loading all tasks for reports tab, project:', selectedGanttProject.id);
    loadAllGroupTasks(selectedGanttProject.id, null);
  }
}, [selectedGanttProject?.id, activeTab, groupMembers.length]);

// Load phase rubric and evaluation data when a phase is selected in Reports tab
useEffect(() => {
  if (selectedGanttPhase && activeGroupTab === 'reports') {
    console.log('üìã Loading phase rubric and evaluation data for phase:', selectedGanttPhase.id);
    
    // Load phase rubric
    fetch(`${apiConfig.baseURL}/api/student/phases/${selectedGanttPhase.id}/rubric`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data) {
          console.log('‚úÖ Phase rubric data loaded:', data);
          // Update selectedGanttPhase with rubric data
          selectedGanttPhase.is_custom_rubric = data.is_custom || false;
          selectedGanttPhase.rubric_file_url = data.custom_file_url || data.file_url || null;
          selectedGanttPhase.has_builtin_rubric = data.criteria ? data.criteria.length > 0 : false;
          setSelectedGanttPhase({...selectedGanttPhase}); // Force re-render
        }
      })
      .catch(err => console.log('Could not fetch phase rubric:', err));
    
    // Load phase evaluation form
    fetch(`${apiConfig.baseURL}/api/student/phases/${selectedGanttPhase.id}/evaluation-form`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data) {
          console.log('‚úÖ Phase evaluation data loaded:', data);
          // Update selectedGanttPhase with evaluation data
          selectedGanttPhase.is_custom_evaluation = data.is_custom || data.is_custom_evaluation || false;
          selectedGanttPhase.evaluation_form_file_url = data.custom_file_url || null;
          selectedGanttPhase.has_builtin_evaluation = data.criteria ? data.criteria.length > 0 : false;
          setSelectedGanttPhase({...selectedGanttPhase}); // Force re-render
        }
      })
      .catch(err => console.log('Could not fetch phase evaluation:', err));
  }
}, [selectedGanttPhase?.id, activeGroupTab]);

// Render Reports Tab Gantt Chart - just a placeholder, actual rendering in JSX
useEffect(() => {
  // This useEffect is intentionally empty - rendering is done in JSX below
  // The component will display the Gantt chart when rendering the reportsGanttRef div
}, []);




  // Filter notifications
  useEffect(() => {
    let filtered = notifications;
    
    // Filter by type
    if (notificationFilter !== 'all') {
      filtered = filtered.filter(notification => 
        (notification.notification_type || notification.type) === notificationFilter
      );
    }
    
    // Filter by read status
    if (showUnreadOnly) {
      filtered = filtered.filter(notification => !notification.is_read && !notification.read);
    }
    
    // Filter by search query
    if (notificationSearchQuery.trim()) {
      filtered = filtered.filter(notification =>
        notification.title?.toLowerCase().includes(notificationSearchQuery.toLowerCase()) ||
        notification.message?.toLowerCase().includes(notificationSearchQuery.toLowerCase()) ||
        (notification.metadata?.project_title?.toLowerCase().includes(notificationSearchQuery.toLowerCase())) ||
        (notification.metadata?.task_title?.toLowerCase().includes(notificationSearchQuery.toLowerCase())) ||
        (notification.details?.projectTitle?.toLowerCase().includes(notificationSearchQuery.toLowerCase())) ||
        (notification.details?.taskTitle?.toLowerCase().includes(notificationSearchQuery.toLowerCase()))
      );
    }
    
    setFilteredNotifications(filtered);
  }, [notifications, notificationFilter, showUnreadOnly, notificationSearchQuery]);


  useEffect(() => {
    let filtered = announcements;
    
    // Filter by type
    if (announcementFilter !== 'all') {
      filtered = filtered.filter(announcement => 
        announcement.type === announcementFilter
      );
    }
    
    // Filter by search query
    if (searchQuery.trim()) {
      filtered = filtered.filter(announcement =>
        announcement.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        announcement.content.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }
    
    setFilteredAnnouncements(filtered);
  }, [announcements, announcementFilter, searchQuery]);

  // Recalculate task counts when selected phase changes
  useEffect(() => {
    if (assignedTasks.length > 0 && groupMembers.length > 0) {
      const counts = calculateMemberTaskCounts(assignedTasks, groupMembers, selectedAssignPhase?.id);
      setMemberTaskCounts(counts);
    }
  }, [selectedAssignPhase, assignedTasks, groupMembers]);

  // Auto-refresh member submissions when phase selection changes
  useEffect(() => {
    if (memberSubmissionsView.selectedMember && memberSubmissionsView.selectedProject) {
      handleMemberSelection(memberSubmissionsView.selectedMember);
    }
  }, [memberSubmissionsView.selectedPhase]);

  // Utility functions
  const getTaskUrgencyColor = (dueDate) => {
    const now = new Date();
    const due = new Date(dueDate);
    const daysUntilDue = (due - now) / (1000 * 60 * 60 * 24);

    if (daysUntilDue < 0) return 'overdue';
    if (daysUntilDue <= 2) return 'due-soon';
    return 'on-time';
  };

  // ‚úÖ Group Project Change Handler
  const handleGroupProjectChange = async (project) => {
    setSelectedGroupProject(project);
    setShowGroupProjectDropdown(false);
    await loadGroupProjectData(project.id);
  };

  // ‚úÖ Load Group Project Data
  const loadGroupProjectData = async (projectId) => {
    try {
      const token = localStorage.getItem('token');
      
      // Get project phases
      const projectResponse = await apiCall(apiConfig.endpoints.student.projects.dashboard(projectId));
      
      const projectData = await projectResponse.json();
      
      if (projectData.project && projectData.project.project_phases) {
        const projectPhases = projectData.project.project_phases
          .map(phase => {
            const now = new Date();
            const phaseStart = new Date(phase.start_date);
            const phaseEnd = new Date(phase.end_date);
            
            let phaseStatus = 'upcoming';
            if (now >= phaseStart && now <= phaseEnd) {
              phaseStatus = 'active';
            } else if (now > phaseEnd) {
              phaseStatus = 'completed';
            }
            
            return {
              title: phase.title,
              phase_number: phase.phase_number,
              status: phaseStatus,
              start_date: phase.start_date,
              end_date: phase.end_date
            };
          })
          .sort((a, b) => a.phase_number - b.phase_number);
        
        setGroupAvailablePhases(projectPhases);
      } else {
        setGroupAvailablePhases([]);
      }
      
      // Reset member selection
      setSelectedGroupMember(null);
      setMemberAssignedTasks([]);
      setMemberSubmissions([]);
      setSelectedGroupPhase(null);
      setGroupPhaseFilterMode('all');
      
    } catch (error) {
      console.error('Error loading group project data:', error);
    }
  };

// Handler functions for Member Submissions
const handleProjectSelectionForSubmissions = async (e) => {
  const projectId = e.target.value;
  if (!projectId) {
    setMemberSubmissionsView(prev => ({
      ...prev,
      selectedProject: null,
      selectedMember: null,
      selectedPhase: null,
      projectMembers: [],
      memberSubmissions: [],
      projectPhases: []
    }));
    return;
  }

  setMemberSubmissionsView(prev => ({ ...prev, loading: true }));

  try {
    const token = localStorage.getItem('token');
    
    // Get project members and phases in parallel
    const [membersResponse, phasesResponse] = await Promise.all([
      apiCall(apiConfig.endpoints.studentLeader.projectMembers(projectId)),
      fetch(`/api/student-leader/projects/${projectId}/phases`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
    ]);
    
    if (!membersResponse.ok) throw new Error('Failed to fetch project members');
    const members = await membersResponse.json();

    let phases = [];
    if (phasesResponse.ok) {
      const phasesData = await phasesResponse.json();
      phases = phasesData.phases || [];
    } else {
      console.warn('Failed to fetch project phases:', phasesResponse.status);
    }

    setMemberSubmissionsView(prev => ({
      ...prev,
      selectedProject: projectId,
      selectedMember: null,
      selectedPhase: null,
      projectMembers: members,
      memberSubmissions: [],
      projectPhases: phases,
      loading: false
    }));
  } catch (error) {
    console.error('Error loading project members:', error);
    setMemberSubmissionsView(prev => ({ ...prev, loading: false }));
  }
};

const handleMemberSelection = async (member) => {
  setMemberSubmissionsView(prev => ({ ...prev, loading: true }));

  try {
    const token = localStorage.getItem('token');
    
    // Get member submissions for the selected project
    const submissionsResponse = await fetch(
      `/api/student-leader/member-submissions/${memberSubmissionsView.selectedProject}/${member.student_id}`,
      { headers: { 'Authorization': `Bearer ${token}` } }
    );
    
    if (!submissionsResponse.ok) throw new Error('Failed to fetch member submissions');
    const submissionsData = await submissionsResponse.json();

    // Filter submissions by selected phase if one is chosen
    let filteredTasks = submissionsData.tasks || [];
    if (memberSubmissionsView.selectedPhase) {
      filteredTasks = filteredTasks.filter(task => 
        task.phase_info && task.phase_info.phase_number === memberSubmissionsView.selectedPhase.phase_number
      );
    }

    setMemberSubmissionsView(prev => ({
      ...prev,
      selectedMember: member,
      memberSubmissions: filteredTasks.map(sub => ({ ...sub, newFeedback: sub.feedback || '' })),
      loading: false
    }));
  } catch (error) {
    console.error('Error loading member submissions:', error);
    setMemberSubmissionsView(prev => ({ ...prev, loading: false }));
  }
};

const handleFeedbackChange = (submissionId, feedback) => {
  setMemberSubmissionsView(prev => ({
    ...prev,
    memberSubmissions: prev.memberSubmissions.map(sub =>
      sub.id === submissionId ? { ...sub, newFeedback: feedback } : sub
    )
  }));
};

const handleAskToRevise = async (submissionId, feedback) => {
  try {
    const token = localStorage.getItem('token');
    
    // Clean the submission ID (remove any prefixes like "task-")
    const cleanSubmissionId = submissionId.replace(/^task-/, '');
    
    const response = await fetch(`/api/student-leader/submissions/${cleanSubmissionId}/ask-revise`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ feedback: feedback || 'Please revise this submission.' })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to ask for revision');
    }
    
    // Refresh both member submissions and todo activities
    await handleMemberSelection(memberSubmissionsView.selectedMember);
    
    // Refresh todo activities to update the status
    if (selectedProject) {
      await loadTodoData(selectedProject.id);
    }
    
    alert('Revision request sent successfully!');
  } catch (error) {
    console.error('Error asking for revision:', error);
    alert('Failed to send revision request: ' + error.message);
  }
};

const handleMarkAsComplete = async (submissionId, feedback) => {
  try {
    const token = localStorage.getItem('token');
    
    // Clean the submission ID (remove any prefixes like "task-")
    const cleanSubmissionId = submissionId.replace(/^task-/, '');
    
    const response = await fetch(`/api/student-leader/submissions/${cleanSubmissionId}/mark-complete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ feedback: feedback || 'Task completed successfully!' })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to mark as complete');
    }
    
    // Refresh both member submissions and todo activities
    await handleMemberSelection(memberSubmissionsView.selectedMember);
    
    // Refresh todo activities to update the status
    if (selectedProject) {
      await loadTodoData(selectedProject.id);
    }
    
    alert('Task marked as complete!');
  } catch (error) {
    console.error('Error marking as complete:', error);
    alert('Failed to mark task as complete: ' + error.message);
  }
};

// Missing handler functions for TaskSubmissionCard component
const handleApproveSubmission = async (submissionId, feedback, submissionType = 'original') => {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/api/student-leader/submissions/${submissionId}/approve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        feedback: feedback || '',
        submission_type: submissionType
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to approve submission');
    }
    
    // Show success message
    alert('Submission approved successfully!');
    
    // Refresh the member's submissions
    if (memberSubmissionsView.selectedMember) {
      await handleMemberSelection(memberSubmissionsView.selectedMember);
    }
    
    // Note: my-todo tab has been removed
    
  } catch (error) {
    console.error('Error approving submission:', error);
    alert(`Failed to approve submission: ${error.message}`);
  }
};

const handleRequestRevision = async (submissionId, feedback, submissionType = 'original') => {
  if (!feedback || feedback.trim() === '') {
    alert('Please provide feedback when requesting revision.');
    return;
  }
  
  try {
    const token = localStorage.getItem('token');
    
    // Determine the correct submission type for the API
    const apiSubmissionType = submissionType === 'revision' ? 'revision' : 'original';
    
    const response = await fetch(`/api/student-leader/submissions/${submissionId}/request-revision`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        feedback: feedback,
        submission_type: apiSubmissionType
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to request revision');
    }
    
    // Show success message
    alert('Revision requested successfully!');
    
    // Refresh the member's submissions
    if (memberSubmissionsView.selectedMember) {
      await handleMemberSelection(memberSubmissionsView.selectedMember);
    }
    
    // Note: my-todo tab has been removed
    
  } catch (error) {
    console.error('Error requesting revision:', error);
    alert(`Failed to request revision: ${error.message}`);
  }
};


const getStatusBadgeClass = (status) => {
  switch (status) {
    case 'completed': return 'bg-success';
    case 'needs_revision': return 'bg-warning';
    case 'submitted': return 'bg-info';
    case 'assigned': return 'bg-secondary';
    default: return 'bg-light text-dark';
  }
};

















  // ‚úÖ FIXED: Group Member Selection Handler
  const handleGroupMemberSelect = async (member) => {
    console.log('üîç Selected member:', member); // Debug log
    setSelectedGroupMember(member);
    
    // ‚úÖ FIXED: Use the correct student_id property
    const studentId = member.student_id || member.studentaccounts?.id;
    console.log('üîç Student ID for API call:', studentId); // Debug log
    
    if (studentId) {
      await loadMemberActivity(studentId);
    } else {
      console.error('‚ùå No student ID found for member:', member);
    }
  };

  // ‚úÖ FIXED: Load Member Activity with better error handling
  const loadMemberActivity = async (studentId) => {
    try {
      const token = localStorage.getItem('token');
      
      if (!selectedGroupProject) {
        console.error('‚ùå No selected group project');
        return;
      }
      
      if (!studentId) {
        console.error('‚ùå No student ID provided');
        return;
      }
      
      console.log('üìä Loading member activity for student:', studentId, 'project:', selectedGroupProject.id);
      
      // Get member's assigned tasks
      const tasksResponse = await fetch(
        `/api/student/member-tasks?studentId=${studentId}&projectId=${selectedGroupProject.id}`, 
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );
      
      console.log('üìä Tasks response status:', tasksResponse.status);
      
      if (!tasksResponse.ok) {
        const errorText = await tasksResponse.text();
        console.error('‚ùå Tasks API error:', tasksResponse.status, errorText);
        return;
      }
      
      const tasksData = await tasksResponse.json();
      console.log('üìä Tasks data received:', tasksData);
      
      // Filter tasks by phase if needed
      let filteredTasks = tasksData.tasks || [];
      if (groupPhaseFilterMode === 'phase-specific' && selectedGroupPhase) {
        filteredTasks = filteredTasks.filter(task => 
          task.phase_info?.phase_number === selectedGroupPhase.phase_number
        );
      }
      
      setMemberAssignedTasks(filteredTasks);
      setMemberSubmissions(tasksData.submissions || []);
      
    } catch (error) {
      console.error('‚ùå Error loading member activity:', error);
    }
  };

  // ‚úÖ Submission Click Handler
  const handleSubmissionClick = (submission) => {
    setSelectedSubmission(submission);
    setShowSubmissionModal(true);
    setFeedbackText('');
  };

  // ‚úÖ Submit Feedback Handler - Enhanced for chat interface
  const handleSubmitFeedback = async () => {
    const feedbackToSubmit = newFeedback || feedbackText;
    if (!feedbackToSubmit.trim() || !selectedSubmission) return;
    
    try {
      setSubmitFeedbackLoading(true);
      setSubmittingFeedback(true);
      
      // Determine if this is a revision submission or original submission
      const submissionType = selectedSubmission.is_revision || selectedSubmission.revision_attempt_number ? 'revision' : 'original';
      
      console.log('Submitting feedback:', {
        submission_id: selectedSubmission.id,
        submission_type: submissionType,
        feedback_text: feedbackToSubmit
      });
      
      // Use the correct API endpoint and pass submission_type
      const feedback = await submitFeedback(selectedSubmission.id, feedbackToSubmit, submissionType);
      
      if (feedback) {
        // Refresh member activity
        if (selectedGroupMember) {
          await loadMemberActivity(selectedGroupMember.studentaccounts.id);
        }
        // Clear feedback input
        setFeedbackText('');
        setNewFeedback('');
        alert('Feedback submitted successfully!');
      }
    } catch (error) {
      console.error('Error submitting feedback:', error);
      alert('Error submitting feedback');
    } finally {
      setSubmittingFeedback(false);
      setSubmitFeedbackLoading(false);
    }
  };

  // ‚úÖ NEW: Handle Recent Feedback Click - Navigate to Activities tab with auto-selection
  const handleRecentFeedbackClick = async (feedback) => {
    try {
      console.log('üìå Feedback clicked:', {
        task_id: feedback.task_id,
        project_id: feedback.project_id,
        project_name: feedback.project_name,
        phase_id: feedback.phase_id,
        phase_number: feedback.phase_number,
        feedback_text: feedback.feedback_text
      });

      // Step 1: Navigate to My Group tab
      setActiveTab('my-group');

      // Step 2: Switch to Activities sub-tab
      setActiveGroupTab('activities');

      // Step 3: Set Activities View to Feedback View
      setActivitiesView('feedbackView');

      // Step 4: Auto-select the project from feedback data
      if (feedback.project_id) {
        // Find the project in the activeProjects list
        const projectToSelect = activeProjects?.find(p => p.id === feedback.project_id);
        
        if (projectToSelect) {
          await handleActivitiesProjectChange(projectToSelect);
          console.log('‚úÖ Project selected:', projectToSelect.title);

          // Step 5: Auto-select the phase if available
          if (feedback.phase_id && feedback.phase_number) {
            // Wait a bit for phases to load
            setTimeout(() => {
              const phaseToSelect = activitiesPhases?.find(p => p.phase_number === feedback.phase_number);
              
              if (phaseToSelect) {
                handleActivitiesPhaseChange(phaseToSelect);
                console.log('‚úÖ Phase selected:', phaseToSelect.title);
              }
            }, 300);

            // Step 6: Auto-select the task submission after phase is set
            setTimeout(() => {
              if (feedback.task_id) {
                // Find the task in groupTaskSubmissions and auto-select it
                const taskSubmissionToSelect = groupTaskSubmissions?.find(
                  ts => ts.task_id === feedback.task_id
                );
                
                if (taskSubmissionToSelect) {
                  handleTaskSubmissionClick(taskSubmissionToSelect);
                  console.log('‚úÖ Task submission selected:', taskSubmissionToSelect.task_title);
                } else {
                  console.warn('‚ö†Ô∏è Task submission not found in list:', feedback.task_id);
                }
              }
            }, 600);
          } else {
            // No phase info - just select the task
            setTimeout(() => {
              if (feedback.task_id) {
                const taskSubmissionToSelect = groupTaskSubmissions?.find(
                  ts => ts.task_id === feedback.task_id
                );
                
                if (taskSubmissionToSelect) {
                  handleTaskSubmissionClick(taskSubmissionToSelect);
                  console.log('‚úÖ Task submission selected (no phase):', taskSubmissionToSelect.task_title);
                }
              }
            }, 300);
          }
        } else {
          console.warn('‚ö†Ô∏è Project not found in active projects:', feedback.project_id);
        }
      }
    } catch (error) {
      console.error('‚ùå Error handling recent feedback click:', error);
    }
  };

  // ‚úÖ FIXED: Enhanced loadTodoData function that works even without tasks
  const loadTodoData = async (projectId, showLoading = true) => {
    try {
      if (showLoading) {
      setTodoLoading(true);
      }
      const token = localStorage.getItem('token');
      
      console.log('üîç Loading todo data for project:', projectId);
      
      // Get tasks (might be empty, that's okay)
      const tasksResponse = await fetch(`/api/student/my-tasks?projectId=${projectId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
  const tasksData = await tasksResponse.json();
  console.log('üìù Tasks data received (raw):', tasksData);
  console.log('üîç Task statuses in raw data:', tasksData?.map?.(t => ({ 
    title: t.task_title || t.title, 
    status: t.status, 
    submissions: t.task_submissions?.length || 0,
    current_attempts: t.current_attempts
  })));

      // Robust extractor: try to find an array inside the response under common keys
      const extractArrayFromResponse = (resp) => {
        if (!resp) return [];
        if (Array.isArray(resp)) return resp;
        // common wrappers
        if (Array.isArray(resp.tasks)) return resp.tasks;
        if (Array.isArray(resp.data)) return resp.data;
        if (Array.isArray(resp.submissions)) return resp.submissions;
        // search first-level values for an array
        for (const key of Object.keys(resp)) {
          if (Array.isArray(resp[key])) return resp[key];
        }
        return [];
      };

      const normalizedTasks = extractArrayFromResponse(tasksData);
      if (normalizedTasks.length === 0 && tasksData && Object.keys(tasksData).length > 0) {
        console.warn('‚ö†Ô∏è loadTodoData: could not find array inside tasksData, keys:', Object.keys(tasksData));
      }
      
      console.log('üîç Normalized tasks:', normalizedTasks);
      console.log('üîç Task statuses after normalization:', normalizedTasks.map(t => ({ 
        title: t.task_title || t.title, 
        status: t.status, 
        submissions: t.task_submissions?.length || 0,
        current_attempts: t.current_attempts
      })));
      
      // Check specifically for tasks with 'to_revise' status
      const reviseTasks = normalizedTasks.filter(t => t.status === 'to_revise');
      console.log('üîç Tasks with to_revise status:', reviseTasks.length, reviseTasks.map(t => ({ 
        title: t.task_title || t.title, 
        status: t.status,
        id: t.id
      })));
      
      // ‚úÖ NEW: Get project phases directly from the project
      console.log('üîç Getting project phases from selected project...');
      
      const projectResponse = await fetch(`/api/student/projects/${projectId}/dashboard`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const projectData = await projectResponse.json();
      console.log('üìä Project dashboard data:', projectData);
      
      let projectPhases = [];
      if (projectData.project && projectData.project.project_phases) {
        console.log('üéØ Processing project phases:', projectData.project.project_phases);
        
        projectPhases = projectData.project.project_phases
          .map(phase => {
            const now = new Date();
            const phaseStart = new Date(phase.start_date);
            const phaseEnd = new Date(phase.end_date);
            
            let phaseStatus = 'upcoming';
            if (now >= phaseStart && now <= phaseEnd) {
              phaseStatus = 'active';
            } else if (now > phaseEnd) {
              phaseStatus = 'completed';
            }
            
            return {
              id: phase.id,
              title: phase.title,
              phase_number: phase.phase_number,
              status: phaseStatus,
              start_date: phase.start_date,
              end_date: phase.end_date
            };
          })
          .sort((a, b) => a.phase_number - b.phase_number);
        
        console.log('‚úÖ Available phases set:', projectPhases);
        setAvailablePhases(projectPhases);
      } else {
        console.log('‚ùå No project phases found in project data');
        setAvailablePhases([]);
      }
      
      // ‚úÖ FIX: Associate phase information with each task
      const tasksWithPhaseInfo = normalizedTasks.map(task => {
        // Find the phase this task belongs to based on phase_id
        const taskPhase = projectPhases.find(phase => phase.id === task.phase_id);
        
        if (taskPhase) {
          console.log(`üîç Task "${task.task_title || task.title}" assigned to phase ${taskPhase.phase_number}`);
          return {
            ...task,
            phase_info: {
              phase_number: taskPhase.phase_number,
              title: taskPhase.title,
              status: taskPhase.status
            },
            phase_number: taskPhase.phase_number,
            project_phases: {
              phase_number: taskPhase.phase_number,
              title: taskPhase.title,
              start_date: taskPhase.start_date,
              end_date: taskPhase.end_date
            }
          };
        } else {
          console.warn(`‚ö†Ô∏è Task "${task.task_title || task.title}" has no matching phase for phase_id: ${task.phase_id}`);
          console.warn(`‚ö†Ô∏è Available phase IDs:`, projectPhases.map(p => p.id));
          console.warn(`‚ö†Ô∏è Task phase_id type:`, typeof task.phase_id);
          
          // If no phase found, try to find by phase_number as fallback
          const fallbackPhase = projectPhases.find(phase => 
            String(phase.phase_number) === String(task.phase_number) ||
            String(phase.id) === String(task.phase_id)
          );
          
          if (fallbackPhase) {
            console.log(`üîç Task "${task.task_title || task.title}" assigned to phase ${fallbackPhase.phase_number} via fallback`);
            return {
              ...task,
              phase_info: {
                phase_number: fallbackPhase.phase_number,
                title: fallbackPhase.title,
                status: fallbackPhase.status
              },
              phase_number: fallbackPhase.phase_number,
              project_phases: {
                phase_number: fallbackPhase.phase_number,
                title: fallbackPhase.title,
                start_date: fallbackPhase.start_date,
                end_date: fallbackPhase.end_date
              }
            };
          }
          
          return task;
        }
      });
      
      console.log('üîç Tasks with phase info:', tasksWithPhaseInfo.map(t => ({
        title: t.task_title || t.title,
        phase_info: t.phase_info?.phase_number,
        phase_number: t.phase_number,
        project_phases: t.project_phases?.phase_number,
        phase_title: t.phase_info?.title || t.project_phases?.title
      })));
      
      console.log('üîç Available phases:', projectPhases.map(p => ({
        id: p.id,
        phase_number: p.phase_number,
        title: p.title,
        status: p.status
      })));
      
      setTodoActivities(tasksWithPhaseInfo);
      
      // Set selected activity if tasks exist. If no tasks found, keep previous selection
      if (normalizedTasks && normalizedTasks.length > 0) {
        setSelectedActivity(normalizedTasks[0]);
      }
      
      // Reset phase filter when project changes
      setSelectedTodoPhase(null);
      setPhaseFilterMode('all');
      
      setTodoLoading(false);
    } catch (error) {
      console.error('‚ùå Error loading todo data:', error);
      setTodoLoading(false);
    }
  };

  // ‚úÖ Alias function for loadTodoData to maintain compatibility
  const loadTodoActivities = async (projectId, phaseNumber = null) => {
    await loadTodoData(projectId);
  };

  // Add this function to handle todo project selection
  const handleTodoProjectChange = async (project) => {
    setSelectedTodoProject(project);
    setShowTodoDropdown(false);
    await loadTodoData(project.id);
  };

  // ‚úÖ NEW: Load ALL tasks from ALL active projects (for Course Overview - independent of project selection)
  const loadAllActiveProjectsTasksForOverview = async () => {
    try {
      setOverviewTasksLoading(true);
      const token = localStorage.getItem('token');
      
      console.log('üîç [Course Overview] Loading all tasks from all active projects...');
      
      // Get all projects (already in state)
      const safeProjects = Array.isArray(projects) ? projects : [];
      
      // Filter only active projects
      const activeProjectsList = safeProjects.filter(p => {
        if (!p.end_date) return true; // If no end_date, assume active
        const endDate = new Date(p.end_date);
        return endDate > new Date();
      });
      
      console.log(`üìä [Course Overview] Found ${activeProjectsList.length} active projects out of ${safeProjects.length} total`);
      
      if (activeProjectsList.length === 0) {
        console.warn('‚ö†Ô∏è [Course Overview] No active projects found');
        setTodoActivities([]);
        return;
      }
      
      // Fetch tasks for each active project
      const allTasks = [];
      
      for (const project of activeProjectsList) {
        try {
          const response = await fetch(`/api/student/my-tasks?projectId=${project.id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!response.ok) {
            console.warn(`‚ö†Ô∏è Failed to load tasks for project ${project.id}`);
            continue;
          }
          
          const tasksData = await response.json();
          
          // Extract array from response
          const extractArrayFromResponse = (resp) => {
            if (!resp) return [];
            if (Array.isArray(resp)) return resp;
            if (Array.isArray(resp.tasks)) return resp.tasks;
            if (Array.isArray(resp.data)) return resp.data;
            for (const key of Object.keys(resp)) {
              if (Array.isArray(resp[key])) return resp[key];
            }
            return [];
          };
          
          const normalizedTasks = extractArrayFromResponse(tasksData);
          
          // Get project phases for phase info
          const dashboardResponse = await fetch(`/api/student/projects/${project.id}/dashboard`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          const dashboardData = await dashboardResponse.json();
          const projectPhases = dashboardData.project?.project_phases || [];
          
          // Add project and phase info to each task
          const tasksWithProjectInfo = normalizedTasks.map(task => {
            const taskPhase = projectPhases.find(phase => phase.id === task.phase_id);
            
            return {
              ...task,
              project_id: project.id,
              project_name: project.title || project.name,
              course_id: project.course_id || courseId,
              phase_info: taskPhase ? {
                id: taskPhase.id,
                phase_number: taskPhase.phase_number,
                title: taskPhase.title,
                status: taskPhase.status
              } : null
            };
          });
          
          allTasks.push(...tasksWithProjectInfo);
          
          console.log(`‚úÖ [Course Overview] Loaded ${normalizedTasks.length} tasks from project: ${project.title}`);
        } catch (error) {
          console.error(`‚ùå Error loading tasks for project ${project.id}:`, error);
        }
      }
      
      console.log(`‚úÖ [Course Overview] Total tasks from all active projects: ${allTasks.length}`);
      console.log('üìä [Course Overview] Tasks summary:', allTasks.map(t => ({
        title: t.title || t.task_title,
        project: t.project_name,
        status: t.status
      })));
      
      setTodoActivities(allTasks);
    } catch (error) {
      console.error('‚ùå Error loading all active projects tasks:', error);
      setTodoActivities([]);
    } finally {
      setOverviewTasksLoading(false);
    }
  };

  // ‚úÖ NEW: Load ALL feedbacks from ALL active projects (for Course Overview - independent of project selection)
  const loadAllActiveProjectsFeedbacksForOverview = async () => {
    try {
      setFeedbacksLoading(true);
      const token = localStorage.getItem('token');
      
      console.log('üîç [Course Overview] Loading all feedbacks from all active projects...');
      
      // Get all projects (already in state)
      const safeProjects = Array.isArray(projects) ? projects : [];
      
      // Filter only active projects
      const activeProjectsList = safeProjects.filter(p => {
        if (!p.end_date) return true;
        const endDate = new Date(p.end_date);
        return endDate > new Date();
      });
      
      console.log(`üìä [Course Overview] Searching feedbacks in ${activeProjectsList.length} active projects`);
      
      if (activeProjectsList.length === 0) {
        console.warn('‚ö†Ô∏è [Course Overview] No active projects found for feedbacks');
        setRecentFeedbacks([]);
        return;
      }
      
      // Fetch feedbacks for each active project
      const allFeedbacks = [];
      
      for (const project of activeProjectsList) {
        try {
          // Try to fetch feedbacks from this project
          const response = await fetch(`${apiConfig.baseURL}/api/student/project/${project.id}/feedbacks`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!response.ok) {
            // Endpoint doesn't exist (404) or other error - skip silently
            if (response.status === 404) {
              // console.log(`‚ÑπÔ∏è Project-specific feedback endpoint not available for project ${project.id}`);
            } else {
              console.log(`‚ö†Ô∏è Project-specific feedback endpoint returned ${response.status} for project ${project.id}`);
            }
            continue;
          }
          
          const feedbacksData = await response.json();
          
          // Extract array from response
          const extractArrayFromResponse = (resp) => {
            if (!resp) return [];
            if (Array.isArray(resp)) return resp;
            if (Array.isArray(resp.feedbacks)) return resp.feedbacks;
            if (Array.isArray(resp.data)) return resp.data;
            for (const key of Object.keys(resp)) {
              if (Array.isArray(resp[key])) return resp[key];
            }
            return [];
          };
          
          const normalizedFeedbacks = extractArrayFromResponse(feedbacksData);
          
          // Add project info to each feedback
          const feedbacksWithProjectInfo = normalizedFeedbacks.map(feedback => ({
            ...feedback,
            project_id: project.id,
            project_name: project.title || project.name
          }));
          
          allFeedbacks.push(...feedbacksWithProjectInfo);
          
          console.log(`‚úÖ [Course Overview] Loaded ${normalizedFeedbacks.length} feedbacks from project: ${project.title}`);
        } catch (error) {
          console.error(`‚ö†Ô∏è Error loading feedbacks for project ${project.id}:`, error);
        }
      }
      
      // If no feedbacks from individual project endpoints, try the general endpoint
      if (allFeedbacks.length === 0) {
        console.log('üìù [Course Overview] Trying general recent feedbacks endpoint...');
        try {
          const response = await fetch(`${apiConfig.baseURL}/api/student/recent-feedbacks`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            const feedbacks = Array.isArray(data) ? data : (data.feedbacks || []);
            
            // Filter to only feedbacks from active projects
            const filteredFeedbacks = feedbacks.filter(f => {
              const projectIsActive = activeProjectsList.some(p => p.id === f.project_id);
              return projectIsActive;
            });
            
            // Sort by date (most recent first)
            const sortedFilteredFeedbacks = filteredFeedbacks.sort((a, b) => {
              const dateA = new Date(a.created_at || 0);
              const dateB = new Date(b.created_at || 0);
              return dateB - dateA;
            });
            
            console.log(`‚úÖ [Course Overview] Loaded ${sortedFilteredFeedbacks.length} feedbacks from general endpoint (from active projects only)`);
            setRecentFeedbacks(sortedFilteredFeedbacks.slice(0, 10));
            return;
          }
        } catch (error) {
          console.error('‚ö†Ô∏è Error with general feedbacks endpoint:', error);
        }
      }
      
      console.log(`‚úÖ [Course Overview] Total feedbacks from all active projects: ${allFeedbacks.length}`);
      console.log('üìä [Course Overview] Feedbacks summary:', allFeedbacks.map(f => ({
        task_title: f.task_title,
        project: f.project_name,
        feedback_type: f.feedback_type
      })));
      
      // Sort feedbacks by date (most recent first)
      const sortedFeedbacks = allFeedbacks.sort((a, b) => {
        const dateA = new Date(a.created_at || 0);
        const dateB = new Date(b.created_at || 0);
        return dateB - dateA;
      });
      
      setRecentFeedbacks(sortedFeedbacks.slice(0, 10)); // Limit to 10 most recent
    } catch (error) {
      console.error('‚ùå Error loading all active projects feedbacks:', error);
      setRecentFeedbacks([]);
    } finally {
      setFeedbacksLoading(false);
    }
  };

  // =================== SUBMISSION REVIEW DATA LOADING ===================
  
  // Load all submissions for review
  const loadSubmissionReviewData = async (projectId = null, memberId = null) => {
    try {
      setSubmissionReviewView(prev => ({ ...prev, loading: true }));
      const token = localStorage.getItem('token');
      
      console.log('üîç Loading submission review data for project:', projectId, 'member:', memberId);
      
      // Build query parameters
      const params = new URLSearchParams();
      if (projectId) params.append('projectId', projectId);
      if (memberId) params.append('memberId', memberId);
      
      const response = await fetch(`/api/student-leader/submission-review?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('üìã Submission review data received:', {
        submissions: data.submissions?.length || 0,
        projects: data.projects?.length || 0,
        members: data.members?.length || 0,
        taskIds: data.submissions?.map(s => s.task_id) || []
      });
      
      // Check for duplicate task_ids in frontend
      if (data.submissions) {
        const taskIds = data.submissions.map(s => s.task_id);
        const uniqueTaskIds = [...new Set(taskIds)];
        if (taskIds.length !== uniqueTaskIds.length) {
          console.log('‚ö†Ô∏è FRONTEND DUPLICATE TASK IDs:', {
            total: taskIds.length,
            unique: uniqueTaskIds.length,
            duplicates: taskIds.filter((id, index) => taskIds.indexOf(id) !== index)
          });
        }
      }
      
      // Deduplicate submissions by task_id (keep the first occurrence)
      const deduplicatedSubmissions = Array.isArray(data.submissions) ? 
        data.submissions.filter((submission, index, array) => 
          array.findIndex(s => s.task_id === submission.task_id) === index
        ) : [];

      setSubmissionReviewView(prev => ({
        ...prev,
        submissions: deduplicatedSubmissions,
        availableProjects: Array.isArray(data.projects) ? data.projects : [],
        availableMembers: Array.isArray(data.members) ? data.members : [],
        loading: false
      }));
      
    } catch (error) {
      console.error('‚ùå Error loading submission review data:', error);
      setSubmissionReviewView(prev => ({
        ...prev,
        loading: false,
        submissions: []
      }));
    }
  };

  // Load available projects for submission review
  const loadSubmissionReviewProjects = async () => {
    try {
      const token = localStorage.getItem('token');
      
      const response = await fetch('/api/student-leader/projects', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('üìã Available projects for submission review:', data);
      
      setSubmissionReviewView(prev => ({
        ...prev,
        availableProjects: Array.isArray(data) ? data : []
      }));
      
    } catch (error) {
      console.error('‚ùå Error loading submission review projects:', error);
    }
  };

  // Handle submission review project selection
  const handleSubmissionReviewProjectChange = async (project) => {
    setSubmissionReviewView(prev => ({
      ...prev,
      selectedProject: project,
      selectedMember: null // Reset member when project changes
    }));
    await loadSubmissionReviewData(project.id);
  };

  // Handle submission review member selection
  const handleSubmissionReviewMemberChange = async (member) => {
    setSubmissionReviewView(prev => ({
      ...prev,
      selectedMember: member
    }));
    await loadSubmissionReviewData(
      submissionReviewView.selectedProject?.id,
      member?.id
    );
  };

  // Handle submission approval
  const handleSubmissionApprove = async (submissionId, feedback, submissionType = 'original') => {
    try {
      const token = localStorage.getItem('token');
      
      console.log('‚úÖ Approving submission:', submissionId, 'type:', submissionType);
      
      const response = await fetch(`/api/student-leader/submissions/${submissionId}/approve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          feedback: feedback || '',
          submission_type: submissionType
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to approve submission');
      }
      
      console.log('‚úÖ Submission approved successfully');
      alert('Submission approved successfully!');
      
      // Refresh the submission data
      await loadSubmissionReviewData(
        submissionReviewView.selectedProject?.id,
        submissionReviewView.selectedMember?.id
      );
      
      // Also refresh the main dashboard data to update column positions
      await loadTodoData();
      
    } catch (error) {
      console.error('‚ùå Error approving submission:', error);
      alert(`Failed to approve submission: ${error.message}`);
    }
  };

  // Handle submission revision request
  const handleSubmissionRevisionRequest = async (submissionId, feedback, submissionType = 'original') => {
    try {
      const token = localStorage.getItem('token');
      
      if (!feedback || feedback.trim() === '') {
        alert('Please provide feedback when requesting revision.');
        return;
      }
      
      console.log('üîÑ Requesting revision for submission:', submissionId, 'type:', submissionType);
      
      const response = await fetch(`/api/student-leader/submissions/${submissionId}/request-revision`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          feedback: feedback,
          submission_type: submissionType
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to request revision');
      }
      
      console.log('‚úÖ Revision requested successfully');
      alert('Revision requested successfully!');
      
      // Refresh the submission data
      await loadSubmissionReviewData(
        submissionReviewView.selectedProject?.id,
        submissionReviewView.selectedMember?.id
      );
      
      // Also refresh the main dashboard data to update column positions
      await loadTodoData();
      
    } catch (error) {
      console.error('‚ùå Error requesting revision:', error);
      alert(`Failed to request revision: ${error.message}`);
    }
  };

  // Enhanced filtering to include phase filtering
  const getFilteredActivities = () => {
    // Ensure we always operate on an array
    const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);

    if (!source) return [];
    
    // üîß NEW: Phase-based filtering for task cards
    const phaseToFilter = viewedPhase || currentPhase;
    if (!phaseToFilter) {
      console.log('üîç [PHASE FILTER] No active phase - returning empty tasks');
      return [];
    }
    
    // BREATHE PHASE: Show nothing at all
    if (phaseToFilter.currentPhaseType === 'breathe') {
      console.log('üîç [PHASE FILTER] Breathe phase - returning empty tasks');
      return [];
    }
    
    // EVALUATION PHASE: Only show evaluation tasks (will be filtered in evaluation column)
    if (phaseToFilter.currentPhaseType === 'evaluation') {
      console.log('üîç [PHASE FILTER] Evaluation phase - returning empty tasks for regular columns');
      return [];
    }
    
    // WORK PHASE: Show normal task cards
    let filtered = source;
    
    // First filter by status using our enhanced status logic
    filtered = filtered.filter(activity => {
      const status = getActivityStatus(activity);
      
      // For "Active" filter, show 'active', 'late', and 'missed' tasks (To-Do column)
      if (activeFilter.toLowerCase() === 'active') {
        return status === 'active' || status === 'late' || status === 'missed';
      }
      
      return activeFilter.toLowerCase() === status;
    });
    
    // Filter by viewed phase if available, otherwise show all phases
    if (phaseToFilter) {
      console.log('üîç [PHASE DEBUG] Filtering by phase:', phaseToFilter.phase_number, phaseToFilter.title, 'ID:', phaseToFilter.id);
      console.log('üîç [PHASE DEBUG] Full phaseToFilter object:', phaseToFilter);
      console.log('üîç [PHASE DEBUG] Tasks before phase filter:', filtered.length);
      
      const beforeFilter = filtered.length;
      filtered = filtered.filter(activity => {
        // Check if task has any phase information at all
        const hasPhaseInfo = activity.phase_info?.phase_number || activity.phase_number || activity.project_phases?.phase_number;
        
        if (!hasPhaseInfo) {
          console.log(`üîç [PHASE DEBUG] Task "${activity.title || activity.task_title}" has no phase info - EXCLUDING`);
          return false;
        }
        
        const phaseMatch = String(activity.phase_info?.phase_number) === String(phaseToFilter.phase_number) ||
                          String(activity.phase_number) === String(phaseToFilter.phase_number) ||
                          String(activity.project_phases?.phase_number) === String(phaseToFilter.phase_number);
        
        console.log(`üîç [PHASE DEBUG] Task "${activity.title || activity.task_title}":`, {
          phase_info: activity.phase_info?.phase_number,
          phase_number: activity.phase_number,
          project_phases: activity.project_phases?.phase_number,
          phaseMatch,
          status: activity.status,
          phase_title: activity.phase_info?.title || activity.project_phases?.title
        });
        
        return phaseMatch;
      });
      
      console.log('üîç [PHASE DEBUG] Tasks after phase filter:', filtered.length, `(removed ${beforeFilter - filtered.length})`);
    }
    
    // Then filter by specific phase if manually selected
    if (phaseFilterMode === 'phase-specific' && selectedTodoPhase) {
      filtered = filtered.filter(activity => 
        activity.phase_info?.phase_number === selectedTodoPhase.phase_number ||
        activity.phase_number === selectedTodoPhase.phase_number ||
        activity.project_phases?.phase_number === selectedTodoPhase.phase_number
      );
    }
    
    return filtered;
  };

  // Helper function to get tasks for revision column
  const getRevisionTasks = () => {
    if (!Array.isArray(todoActivities)) {
      console.log('üîç getRevisionTasks: todoActivities is not an array:', todoActivities);
      return [];
    }
    
    // üîß NEW: Phase-based filtering for revision tasks
    const phaseToFilter = viewedPhase || currentPhase;
    if (!phaseToFilter) {
      console.log('üîç [REVISION FILTER] No active phase - returning empty revision tasks');
      return [];
    }
    
    // BREATHE PHASE: Show nothing
    if (phaseToFilter.currentPhaseType === 'breathe') {
      console.log('üîç [REVISION FILTER] Breathe phase - returning empty revision tasks');
      return [];
    }
    
    // EVALUATION PHASE: Show nothing in revision column
    if (phaseToFilter.currentPhaseType === 'evaluation') {
      console.log('üîç [REVISION FILTER] Evaluation phase - returning empty revision tasks');
      return [];
    }
    
    // WORK PHASE: Show revision tasks normally
    console.log('üîç getRevisionTasks: Total activities:', todoActivities.length);
    console.log('üîç getRevisionTasks: All task statuses:', todoActivities.map(t => ({ 
      title: t.task_title || t.title, 
      status: t.status,
      activityStatus: getActivityStatus(t)
    })));
    
    // Use the same filtering logic as getFilteredActivities but only for revision tasks
    const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);
    let filtered = source;
    
    // Filter by viewed phase if available, otherwise show all phases
    if (phaseToFilter) {
      filtered = filtered.filter(activity => {
        // Check if task has any phase information at all
        const hasPhaseInfo = activity.phase_info?.phase_number || activity.phase_number || activity.project_phases?.phase_number;
        
        if (!hasPhaseInfo) {
          return false;
        }
        
        const phaseMatch = String(activity.phase_info?.phase_number) === String(phaseToFilter.phase_number) ||
                          String(activity.phase_number) === String(phaseToFilter.phase_number) ||
                          String(activity.project_phases?.phase_number) === String(phaseToFilter.phase_number);
        
        return phaseMatch;
      });
    }
    
    // Then filter by specific phase if manually selected
    if (phaseFilterMode === 'phase-specific' && selectedTodoPhase) {
      filtered = filtered.filter(activity => 
        activity.phase_info?.phase_number === selectedTodoPhase.phase_number ||
        activity.phase_number === selectedTodoPhase.phase_number ||
        activity.project_phases?.phase_number === selectedTodoPhase.phase_number
      );
    }
    
    // Finally filter for revision tasks ONLY (not late tasks without submissions)
    const revisionTasks = filtered.filter(activity => {
      const status = getActivityStatus(activity);
      // Only show tasks that are actually in revision status (have been submitted and leader requested revision)
      const isRevision = status === 'revise';
      console.log(`üîç Task "${activity.task_title || activity.title}": status="${activity.status}", activityStatus="${status}", isRevision=${isRevision}`);
      return isRevision;
    });
    
    console.log('üîç getRevisionTasks: Found revision tasks:', revisionTasks.length);
    return revisionTasks;
  };

  // Helper function to get phase statistics
  const getPhaseStatistics = () => {
    // Normalize source
    const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);
    if (!source || !availablePhases) return {};

    const stats = {};

    availablePhases.forEach(phase => {
      const phaseTasks = source.filter(task => 
        task.phase_info?.phase_number === phase.phase_number
      );
      
      stats[phase.phase_number] = {
        total: phaseTasks.length,
        active: phaseTasks.filter(t => getActivityStatus(t) === 'active').length,
        pending: phaseTasks.filter(t => getActivityStatus(t) === 'pending').length,
        completed: phaseTasks.filter(t => getActivityStatus(t) === 'completed').length,
        revise: phaseTasks.filter(t => getActivityStatus(t) === 'revise').length,
        rejected: phaseTasks.filter(t => getActivityStatus(t) === 'rejected').length,
        missed: phaseTasks.filter(t => getActivityStatus(t) === 'missed').length,
        late: phaseTasks.filter(t => getActivityStatus(t) === 'late').length
      };
    });
    
    return stats;
  };

  // Add this function to get activity status for styling
  const getActivityStatus = (activity) => {
    const now = new Date();
    const dueDate = new Date(activity.due_date);
    const availableUntil = activity.available_until ? new Date(activity.available_until) : null;
    
    // PRIORITY 0: Check task's own status field first
    if (activity.status) {
      if (activity.status === 'completed' || activity.status === 'approved') {
        return 'completed';
      }
      if (activity.status === 'to_revise' || activity.status === 'revision_requested') {
        return 'revise';
      }
      if (activity.status === 'in_progress') {
        return 'active';
      }
      if (activity.status === 'rejected') {
        return 'rejected';
      }
      if (activity.status === 'extension_requested') {
        return 'extension_requested';
      }
      // If status is 'pending', continue to check submissions
    }
    
    // PRIORITY 1: Check revision submissions first (highest priority)
    if (activity.revision_submissions?.length > 0) {
      const latestRevision = activity.revision_submissions[0]; // Most recent revision
      
      if (latestRevision.status === 'approved') {
        return 'completed';
      }
      
      if (latestRevision.status === 'pending') {
        // Check if this is a re-revision (revision of a revision)
        if (isReRevision(activity)) {
          return 'revise'; // Re-revisions should show in revise column
        }
        return 'revise';
      }
      
      if (latestRevision.status === 'revision_requested') {
        return 'revise';
      }
    }
    
    // PRIORITY 2: Check original task submissions
    // BUT: If there are any revision submissions at all, even if latest isn't pending,
    // we should still treat as 'revise' if original was revision_requested
    if (activity.task_submissions?.length > 0) {
      const latestSubmission = activity.task_submissions[0]; // Most recent submission
      
      // If original submission was revision_requested AND there are revision submissions,
      // this means we're in a revision workflow, so return 'revise' not 'pending'
      if (latestSubmission.status === 'revision_requested' && activity.revision_submissions?.length > 0) {
        return 'revise';
      }
      
      switch (latestSubmission.status) {
        case 'pending':
          // Only return 'pending' if there are NO revision submissions
          // If there are revision submissions, we should be in 'revise' state
          if (activity.revision_submissions?.length > 0) {
            return 'revise';
          }
          return 'pending';
        case 'approved':
          return 'completed';
        case 'rejected':
          return 'rejected';
        case 'revision_requested':
          return 'revise';
        default:
          // Default: if there are revision submissions, treat as revise
          if (activity.revision_submissions?.length > 0) {
            return 'revise';
          }
          return 'pending';
      }
    }
    
    // PRIORITY 3: No submissions - check if task is late, missed, or active
    // If available_until is set, use it to determine missed
    // If not, use due_date to determine missed
    const deadline = availableUntil || dueDate;
    if (now > deadline) {
      return 'missed';
    }
    
    return 'active';
  };

  // Helper function to check if a task is a re-revision (revision of a revision)
  // A re-revision means: there are 2+ revision submissions OR the latest revision is revision_requested with previous revisions
  const isReRevision = (activity) => {
    // Check if there are revision submissions
    if (activity.revision_submissions?.length > 0) {
      const latestRevision = activity.revision_submissions[0];
      
      // If there are 2+ revision submissions, it's definitely a re-revision chain
      if (activity.revision_submissions.length > 1) {
        return true;
      }
      
      // If the latest revision is revision_requested and there's at least one previous revision,
      // it's a re-revision (leader requested revision of a revision)
      if ((latestRevision.status === 'revision_requested' || latestRevision.status === 'to_revise') && 
          activity.revision_submissions.length > 1) {
        return true;
      }
      
      // If there's at least one revision submission AND the original was revision_requested,
      // and the latest revision is revision_requested, it's a re-revision
      if ((latestRevision.status === 'revision_requested' || latestRevision.status === 'to_revise') &&
          activity.task_submissions?.length > 0) {
        const hasOriginalRevisionRequested = activity.task_submissions.some(
          sub => sub.status === 'revision_requested' || sub.status === 'to_revise'
        );
        if (hasOriginalRevisionRequested && activity.revision_submissions.length >= 1) {
          return true;
        }
      }
    }
    
    return false;
  };

  // Helper function to check if a task is late
  const isTaskLate = (activity) => {
    const now = new Date();
    const dueDate = new Date(activity.due_date);
    const availableUntil = activity.available_until ? new Date(activity.available_until) : null;
    
    // PRIORITY 1: Use database is_late field if available
    if (activity.task_submissions?.length > 0) {
      const latestSubmission = activity.task_submissions[0]; // Most recent submission
      if (latestSubmission.is_late !== undefined) {
        return latestSubmission.is_late;
      }
    }
    
    // PRIORITY 2: Check revision submissions for late status
    if (activity.revision_submissions?.length > 0) {
      const latestRevision = activity.revision_submissions[0];
      if (latestRevision.is_late !== undefined) {
        return latestRevision.is_late;
      }
    }
    
    // PRIORITY 3: Fallback to calculation if no database field
    if (!activity.task_submissions?.length) {
      return now > dueDate && (!availableUntil || now <= availableUntil);
    }
    
    // Check if any original submission was late
    const wasOriginallySubmittedLate = activity.task_submissions?.some(submission => {
      const submissionDate = new Date(submission.submission_date);
      return submissionDate > dueDate && (!availableUntil || submissionDate <= availableUntil);
    });
    
    return wasOriginallySubmittedLate;
  };

  // Helper function to check if task can be submitted
  const canSubmitTask = (activity) => {
    const now = new Date();
    const availableUntil = activity.available_until ? new Date(activity.available_until) : null;
    const status = getActivityStatus(activity);
    const attemptInfo = getAttemptInfo(activity);
    
    // Can't submit if missed deadline
    if (availableUntil && now > availableUntil) return false;
    
    // Can't submit if completed or pending review
    if (status === 'completed' || status === 'pending') return false;
    
    // Can't submit if exceeded attempts
    if (!attemptInfo.canSubmit) return false;
    
    // Can submit if active or needs revision
    return status === 'active' || status === 'revise';
  };

  // Helper function to get correct attempt count and max attempts
  const getAttemptInfo = (activity) => {
    const status = getActivityStatus(activity);
    
    // Count original submissions using database fields
    const originalSubmissions = activity.task_submissions || [];
    const totalOriginalSubmissions = originalSubmissions.length;
    const originalMaxAttempts = activity.max_attempts || 1;
    
    // Count revision submissions
    const revisionSubmissions = activity.revision_submissions || [];
    const totalRevisionSubmissions = revisionSubmissions.length;
    
    // If task needs revision, allow revision submissions
    if (status === 'revise') {
      return {
        currentAttempts: totalOriginalSubmissions,
        maxAttempts: originalMaxAttempts,
        canSubmit: true, // Allow revision submissions
        actual_submissions: totalOriginalSubmissions,
        max_attempts: originalMaxAttempts,
        revision_attempts: totalRevisionSubmissions
      };
    }
    
    // Normal case - check attempts
    const canSubmitByAttempts = totalOriginalSubmissions < originalMaxAttempts;
    
    return {
      currentAttempts: totalOriginalSubmissions,
      maxAttempts: originalMaxAttempts,
      canSubmit: canSubmitByAttempts,
      actual_submissions: totalOriginalSubmissions,
      max_attempts: originalMaxAttempts,
      revision_attempts: totalRevisionSubmissions
    };
  };

  // ‚úÖ Canvas-style file submission (no modal)
  const handleFileSubmission = async (activity, files) => {
    if (!files || files.length === 0) return;
    
    let allowedTypes = [];
    if (activity?.file_types_allowed) {
      // Handle both string and array formats
      if (typeof activity.file_types_allowed === 'string') {
        try {
          // Try to parse as JSON first
          allowedTypes = JSON.parse(activity.file_types_allowed).map(type => type.trim().toLowerCase());
        } catch {
          // If not JSON, split by comma
          allowedTypes = activity.file_types_allowed.split(',').map(type => type.trim().toLowerCase());
        }
      } else if (Array.isArray(activity.file_types_allowed)) {
        allowedTypes = activity.file_types_allowed.map(type => type.trim().toLowerCase());
      }
    }
    
    // Validate file types
    if (allowedTypes.length > 0) {
      const invalidFiles = files.filter(file => {
        const fileExt = file.name.split('.').pop().toLowerCase();
        return !allowedTypes.includes(fileExt);
      });
      
      if (invalidFiles.length > 0) {
        alert(`Invalid file types. Allowed types: ${allowedTypes.join(', ')}`);
        return;
      }
    }
    
    try {
      setSubmissionLoading(true);
      
      const token = localStorage.getItem('token');
      const formData = new FormData();
      files.forEach(file => formData.append('files', file));
      formData.append('submissionText', ''); // Canvas style has no text input
      
      const response = await apiCall(apiConfig.endpoints.tasks.submit(activity.id), {
        method: 'POST',
        body: formData
      });
      
      // Check if response is JSON
      const contentType = response.headers.get('content-type');
      let data;
      if (contentType && contentType.includes('application/json')) {
        data = await response.json();
      } else {
        // Handle non-JSON responses (like HTML error pages)
        const text = await response.text();
        throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
      }
      
      if (response.ok) {
        alert('Submission uploaded successfully!');
        // Refresh all data to update task status
        if (selectedTodoProject) {
          await refreshData('file-upload');
        }
      } else {
        throw new Error(data.message || 'Submission failed');
      }
    } catch (error) {
      console.error('Submission error:', error);
      alert('Failed to submit: ' + error.message);
    } finally {
      setSubmissionLoading(false);
    }
  };

  // ‚úÖ Revision submission function with improved error handling
  const handleRevisionSubmission = async (activity, files, submissionText = '') => {
    if (!files || files.length === 0) {
      alert('Please select files to submit for revision.');
      return;
    }
    
    console.log('Starting revision submission for task:', activity.id);
    console.log('Files to submit:', files.length);
    console.log('API URL:', `${apiConfig.baseURL}/api/tasks/submit`);
    
    try {
      setSubmissionLoading(true);
      
      const token = localStorage.getItem('token');
      if (!token) {
        throw new Error('No authentication token found. Please log in again.');
      }
      
      const formData = new FormData();
      
      // Add task_id and submission_text to form data
      formData.append('task_id', activity.id);
      formData.append('submission_text', submissionText || '');
      
      // Add files
      files.forEach((file, index) => {
        console.log(`Adding file ${index + 1}:`, file.name, file.size, 'bytes');
        formData.append('files', file);
      });
      
      console.log('Making API request...');
      
      // Submit revision using the tasks/submit endpoint
      // The backend automatically detects revisions based on task status
      const response = await fetch(`${apiConfig.baseURL}/api/tasks/submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', Object.fromEntries(response.headers.entries()));
      
      let data;
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        data = await response.json();
        console.log('Response data:', data);
      } else {
        const textData = await response.text();
        console.log('Response text:', textData);
        data = { error: `Server returned non-JSON response: ${textData}` };
      }
      
      if (response.ok) {
        alert('Revision submitted successfully! Your submission is now under review.');
        // Refresh all data to update task status
        if (selectedTodoProject) {
          await refreshData('revision-upload');
        }
      } else {
        const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
        throw new Error(errorMsg);
      }
      
    } catch (error) {
      console.error('Revision submission error details:', {
        message: error.message,
        stack: error.stack,
        name: error.name
      });
      
      let userMessage = 'Failed to submit revision: ';
      if (error.message.includes('fetch')) {
        userMessage += 'Cannot connect to server. Please check if the backend is running.';
      } else if (error.message.includes('token')) {
        userMessage += 'Authentication error. Please log in again.';
      } else {
        userMessage += error.message;
      }
      
      alert(userMessage);
    } finally {
      setSubmissionLoading(false);
    }
  };

  // ‚úÖ Extension Request Handler
  const handleExtensionRequest = async () => {
    if (!extensionRequestReason.trim()) {
      alert('Please provide a reason for the extension request');
      return;
    }

    if (!selectedTask) {
      alert('No task selected');
      return;
    }

    setSubmittingExtensionRequest(true);
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/student/tasks/${selectedTask.id}/request-extension`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reason: extensionRequestReason.trim()
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to submit extension request');
      }

      alert('Extension request submitted successfully! Your group leader will review it.');
      
      // Close modal and reset state
      setShowExtensionRequestModal(false);
      setExtensionRequestReason('');
      setShowTaskModal(false);
      
      // Reload tasks to reflect the new status
      if (viewedPhase && selectedProject) {
        await loadProjectSpecificData(selectedProject.id);
      }
      
    } catch (error) {
      console.error('Extension request error:', error);
      alert(error.message || 'Failed to submit extension request');
    } finally {
      setSubmittingExtensionRequest(false);
    }
  };

  // ‚úÖ ADD: Helper function to determine phase status
  const getPhaseStatus = (phase) => {
    const now = new Date();
    const start = new Date(phase.start_date);
    const end = new Date(phase.end_date);
    
    if (now < start) return 'upcoming';
    if (now >= start && now <= end) return 'active';
    if (now > end) return 'completed';
    return 'unknown';
  };

  const detectCurrentPhase = (phases) => {
    if (!phases || phases.length === 0) {
      console.log('üîç [PHASE DEBUG] No phases provided to detectCurrentPhase');
      setCurrentPhase(null);
      return;
    }

    console.log('üîç [PHASE DEBUG] Detecting current phase from phases:', phases.map(p => ({
      phase_number: p.phase_number,
      title: p.title,
      start_date: p.start_date,
      end_date: p.end_date,
      evaluation_available_from: p.evaluation_available_from,
      evaluation_due_date: p.evaluation_due_date,
      breathe_start_date: p.breathe_start_date,
      breathe_end_date: p.breathe_end_date
    })));

    const now = new Date();
    const activePhase = phases.find(phase => {
      const startDate = new Date(phase.start_date);
      const endDate = new Date(phase.end_date);
      
      // Check if we're in the evaluation phase window
      // Evaluation phase extends from evaluation_available_from to evaluation_due_date
      const evaluationAvailableFrom = phase.evaluation_available_from ? new Date(phase.evaluation_available_from) : null;
      const evaluationDueDate = phase.evaluation_due_date ? new Date(phase.evaluation_due_date) : null;
      
      // Check if we're in the breathe phase window
      // Breathe phase extends from breathe_start_date to breathe_end_date
      const breatheStartDate = phase.breathe_start_date ? new Date(phase.breathe_start_date) : null;
      const breatheEndDate = phase.breathe_end_date ? new Date(phase.breathe_end_date) : null;
      
      // Since database times are in UTC, compare with UTC time
      const nowUTC = new Date(now.toISOString());
      const startUTC = new Date(startDate.toISOString());
      const endUTC = new Date(endDate.toISOString());
      const evalStartUTC = evaluationAvailableFrom ? new Date(evaluationAvailableFrom.toISOString()) : null;
      const evalEndUTC = evaluationDueDate ? new Date(evaluationDueDate.toISOString()) : null;
      const breatheStartUTC = breatheStartDate ? new Date(breatheStartDate.toISOString()) : null;
      const breatheEndUTC = breatheEndDate ? new Date(breatheEndDate.toISOString()) : null;
      
      // Phase is active if:
      // 1. We're between phase start and end dates (work phase), OR
      // 2. We're between evaluation phase available_from and due_date (evaluation window), OR
      // 3. We're between breathe phase start and end dates (breathe window)
      const isActive = (nowUTC >= startUTC && nowUTC <= endUTC) ||
                       (evalStartUTC && evalEndUTC && nowUTC >= evalStartUTC && nowUTC <= evalEndUTC) ||
                       (breatheStartUTC && breatheEndUTC && nowUTC >= breatheStartUTC && nowUTC <= breatheEndUTC);
      
      console.log(`üîç [PHASE DEBUG] Phase ${phase.phase_number} (${phase.title}):`, {
        phaseWindow: {
          start: startUTC.toISOString(),
          end: endUTC.toISOString(),
          inPhaseWindow: nowUTC >= startUTC && nowUTC <= endUTC
        },
        evaluationWindow: {
          start: evalStartUTC?.toISOString() || 'Not set',
          end: evalEndUTC?.toISOString() || 'Not set',
          inEvalWindow: evalStartUTC && evalEndUTC && nowUTC >= evalStartUTC && nowUTC <= evalEndUTC
        },
        breatheWindow: {
          start: breatheStartUTC?.toISOString() || 'Not set',
          end: breatheEndUTC?.toISOString() || 'Not set',
          inBreatheWindow: breatheStartUTC && breatheEndUTC && nowUTC >= breatheStartUTC && nowUTC <= breatheEndUTC
        },
        now: now.toISOString(),
        nowUTC: nowUTC.toISOString(),
        isActive,
        timezoneOffset: now.getTimezoneOffset(),
        localTime: now.toLocaleString(),
        utcTime: nowUTC.toLocaleString()
      });
      
      return isActive;
    });

    console.log('üîç [PHASE DEBUG] Detected active phase:', activePhase?.phase_number, activePhase?.title);
    
    // Determine the phase type (work, evaluation, or breathe)
    if (activePhase) {
      const now = new Date();
      const nowUTC = new Date(now.toISOString());
      
      const evaluationAvailableFrom = activePhase.evaluation_available_from ? new Date(activePhase.evaluation_available_from) : null;
      const evaluationDueDate = activePhase.evaluation_due_date ? new Date(activePhase.evaluation_due_date) : null;
      const breatheStartDate = activePhase.breathe_start_date ? new Date(activePhase.breathe_start_date) : null;
      const breatheEndDate = activePhase.breathe_end_date ? new Date(activePhase.breathe_end_date) : null;
      
      const evalStartUTC = evaluationAvailableFrom ? new Date(evaluationAvailableFrom.toISOString()) : null;
      const evalEndUTC = evaluationDueDate ? new Date(evaluationDueDate.toISOString()) : null;
      const breatheStartUTC = breatheStartDate ? new Date(breatheStartDate.toISOString()) : null;
      const breatheEndUTC = breatheEndDate ? new Date(breatheEndDate.toISOString()) : null;
      
      // Check in order: evaluation ‚Üí breathe ‚Üí work
      if (evalStartUTC && evalEndUTC && nowUTC >= evalStartUTC && nowUTC <= evalEndUTC) {
        activePhase.currentPhaseType = 'evaluation';
      } else if (breatheStartUTC && breatheEndUTC && nowUTC >= breatheStartUTC && nowUTC <= breatheEndUTC) {
        activePhase.currentPhaseType = 'breathe';
      } else {
        activePhase.currentPhaseType = 'work';
      }
      
      console.log(`üîç [PHASE DEBUG] Phase type: ${activePhase.currentPhaseType}`);
    }
    
    setCurrentPhase(activePhase);
  };

  // Update the formatDate function to include time
  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const formatDateTime = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  };

  // ‚úÖ ADD: Load user profile data
  const loadUserProfile = async () => {
    try {
      setProfileLoading(true);
      const token = localStorage.getItem('token');
      
      const response = await fetch('/api/student/profile', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const profileData = await response.json();
        console.log('‚úÖ User profile loaded:', profileData);
        setUserProfile(profileData);
        
        // Update localStorage with current user data
        localStorage.setItem('userFirstName', profileData.first_name);
        localStorage.setItem('userLastName', profileData.last_name);
        localStorage.setItem('userEmail', profileData.email);
        localStorage.setItem('userFullName', profileData.full_name);
        localStorage.setItem('userStudentNumber', profileData.student_number);
        localStorage.setItem('userProgram', profileData.program);
        localStorage.setItem('userYearLevel', profileData.year_level);
        localStorage.setItem('userProfileImage', profileData.profile_image_url || '');
      } else {
        console.error('Failed to load user profile:', response.status);
        // Fallback to localStorage data if API fails
        const fallbackProfile = {
          first_name: localStorage.getItem('userFirstName') || 'Student',
          last_name: localStorage.getItem('userLastName') || '',
          full_name: localStorage.getItem('userFullName') || 'Student',
          email: localStorage.getItem('userEmail') || 'student@example.com',
          student_number: localStorage.getItem('userStudentNumber') || '',
          program: localStorage.getItem('userProgram') || '',
          year_level: localStorage.getItem('userYearLevel') || '',
          profile_image_url: localStorage.getItem('userProfileImage') || null
        };
        setUserProfile(fallbackProfile);
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
      // Fallback to localStorage data if API fails
      const fallbackProfile = {
        first_name: localStorage.getItem('userFirstName') || 'Student',
        last_name: localStorage.getItem('userLastName') || '',
        full_name: localStorage.getItem('userFullName') || 'Student',
        email: localStorage.getItem('userEmail') || 'student@example.com',
        student_number: localStorage.getItem('userStudentNumber') || '',
        program: localStorage.getItem('userProgram') || '',
        year_level: localStorage.getItem('userYearLevel') || '',
        profile_image_url: localStorage.getItem('userProfileImage') || null
      };
      setUserProfile(fallbackProfile);
    } finally {
      setProfileLoading(false);
    }
  };

  const loadDashboardData = async () => {
    try {
      setLoading(true);
      const token = localStorage.getItem('token');
      
      // Load course data and active projects
      console.log(`üîç [DEBUG] Making API calls...`);
      console.log(`üîç [DEBUG] Course Info API: /api/student/course/${courseId}/info`);
      console.log(`üîç [DEBUG] Projects API: /api/student/course/${courseId}/projects`);
      console.log(`üîç [DEBUG] Groups API: /api/student/dashboard/groups`);
      
      const [courseInfoResponse, projectsResponse, groupResponse] = await Promise.all([
        fetch(`/api/student/course/${courseId}/info`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch(`/api/student/course/${courseId}/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch(`/api/student/dashboard/groups`, {
          headers: { 'Authorization': `Bearer ${token}` }
        })
      ]);

      console.log('üì° API Response Status - Course Info:', courseInfoResponse.status);
      console.log('üì° API Response Status - Projects:', projectsResponse.status);
      console.log('üì° API Response Status - Groups:', groupResponse.status);

      const currentCourse = await courseInfoResponse.json();
      const projectsData = await projectsResponse.json();
      const groupDataResponse = await groupResponse.json();

      console.log('üìä [DEBUG] Groups API Response:', groupDataResponse);
      console.log('üìä [DEBUG] Groups API Response Success:', groupDataResponse.success);
      console.log('üìä [DEBUG] Groups API Response Data:', groupDataResponse.data);

      // Use the course info directly (it already has professor data from backend)
      console.log('üìä [DEBUG] Current course data:', currentCourse);
      console.log('üìä [DEBUG] Current course keys:', currentCourse ? Object.keys(currentCourse) : 'no course');
      console.log('üìä [DEBUG] Professor accounts:', currentCourse?.professoraccounts);
      console.log('üìä [DEBUG] Professor name field:', currentCourse?.professor_name);
      console.log('üìä [DEBUG] Professor ID:', currentCourse?.professor_id);
      setCourseData(currentCourse);

      // Use ALL projects, not just active ones (projects past due date still need to be accessible)
      console.log('üìä [DEBUG] Raw projects data:', projectsData);
      console.log('üìä [DEBUG] Total projects loaded:', projectsData.length);
      
      // Ensure projectsData is an array before setting state
      const safeProjectsData = Array.isArray(projectsData) ? projectsData : [];
      
      // Set all projects (not filtering by due date)
      setProjects(safeProjectsData);
      setActiveProjects(safeProjectsData); // Also set activeProjects so it's in sync
      setAllProjects(safeProjectsData); // Also populate allProjects for wide view
      
      // ‚úÖ DEBUG: Log the structure of returned projects
      console.log('üìä [PROJECTS DATA STRUCTURE] Raw projects:', safeProjectsData);
      if (safeProjectsData.length > 0) {
        console.log('üìä [PROJECTS DATA STRUCTURE] First project phases:', safeProjectsData[0].project_phases);
        if (safeProjectsData[0].project_phases && safeProjectsData[0].project_phases.length > 0) {
          console.log('üìä [PROJECTS DATA STRUCTURE] First phase structure:', safeProjectsData[0].project_phases[0]);
        }
      }
      
      // Set project with nearest due date as default
      if (safeProjectsData.length > 0) {
        const now = new Date();
        
        // Sort projects by due date (nearest first, including past dates)
        const sortedByDueDate = [...safeProjectsData].sort((a, b) => {
          const dateA = new Date(a.due_date);
          const dateB = new Date(b.due_date);
          return Math.abs(dateA - now) - Math.abs(dateB - now); // Sort by closest to current date
        });
        
        const nearestProject = sortedByDueDate[0];
        console.log('üìÖ [DEBUG] Selected nearest project:', {
          title: nearestProject.title,
          due_date: nearestProject.due_date,
          daysFromNow: Math.ceil((new Date(nearestProject.due_date) - now) / (1000 * 60 * 60 * 24)),
          hasGroupId: !!nearestProject.group_id
        });
        
        // ‚úÖ FIX: If project doesn't have group_id, try to get it from groupDataResponse
        if (!nearestProject.group_id && groupDataResponse.success && groupDataResponse.data) {
          const projectGroup = groupDataResponse.data.find(group => group.course_id === courseId);
          if (projectGroup) {
            // Use group_id field, NOT id (id is the membership ID)
            nearestProject.group_id = projectGroup.group_id || projectGroup.id;
            console.log('‚úÖ [DEBUG] Added group_id to project from groupDataResponse:', nearestProject.group_id);
          }
        }
        
        setSelectedProject(nearestProject);
        await loadProjectSpecificData(nearestProject.id);
      } else {
        console.warn('‚ö†Ô∏è [DEBUG] No projects found for this course');
        setActiveProjects([]); // Clear activeProjects if no projects
      }

      // ‚úÖ ENHANCED: Set group data for current course with proper role info
      if (groupDataResponse.success && groupDataResponse.data) {
        console.log('üîç [DEBUG] Looking for group with courseId:', courseId);
        console.log('üîç [DEBUG] Available groups:', groupDataResponse.data.map(g => ({ id: g.course_id, name: g.group_name })));
        
        const currentGroup = groupDataResponse.data.find(group => group.course_id === courseId);
        console.log('üîç [DEBUG] Found current group:', currentGroup);
        
        if (currentGroup) {
          console.log('‚úÖ [DEBUG] Group members:', currentGroup.members);
          setGroupData(currentGroup);
          console.log('‚úÖ Group data set:', currentGroup);
          console.log('‚úÖ Group role detected:', currentGroup?.role);
          console.log('‚úÖ Group position detected:', currentGroup?.position);
        } else {
          console.warn('‚ö†Ô∏è [DEBUG] No group found for courseId:', courseId);
        }
      } else {
        console.error('‚ùå Failed to load group data:', groupDataResponse);
      }

      // Load additional data
      await Promise.all([
        loadAnnouncements(),
        loadNotifications(),
        loadGradesOverview() // ‚úÖ Use NEW grades overview endpoint
      ]);
      
      setLoading(false);
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      setError('Failed to load dashboard data');
      setLoading(false);
    }
  };

  // Update the loadProjectSpecificData function in your existing file:
  const loadProjectSpecificData = async (projectId) => {
    try {
      const token = localStorage.getItem('token');
      
      const [dashboardResponse, tasksResponse] = await Promise.all([
        fetch(`/api/student/projects/${projectId}/dashboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch(`/api/student/my-tasks?projectId=${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        })
      ]);

      const dashboardData = await dashboardResponse.json();
      const tasksData = await tasksResponse.json();

      // üî¥ CRITICAL FIX: Update selectedProject with fresh data that includes flattened evaluation forms
      console.log('üì° [DASHBOARD DATA] Received project with phases:', dashboardData.project?.project_phases?.length);
      console.log('üì° [DASHBOARD DATA] Full project_phases:', JSON.stringify(dashboardData.project?.project_phases, null, 2));
      if (dashboardData.project?.project_phases) {
        console.log('üì° [DASHBOARD DATA] First phase evaluation dates:', {
          evaluation_available_from: dashboardData.project.project_phases[0]?.evaluation_available_from,
          evaluation_due_date: dashboardData.project.project_phases[0]?.evaluation_due_date
        });
        console.log('üì° [DASHBOARD DATA] First phase ALL KEYS:', Object.keys(dashboardData.project.project_phases[0]));
      }
      
      // üîß IMPORTANT: Merge dashboard data with current selectedProject to preserve all phases
      // This ensures we keep the full project data including all phases for navigation
      // ‚úÖ FIX: Add group_id from dashboardData.group (backend returns separate group object)
      const mergedProject = {
        ...selectedProject,  // Keep existing data (including all phases from initial load)
        ...dashboardData.project,  // Override with fresh data from dashboard endpoint
        // Use group_id from the group object (NOT id, which might be membership ID)
        group_id: dashboardData.group?.group_id || dashboardData.group?.id || selectedProject?.group_id,  // ‚úÖ Add group_id!
        project_phases: dashboardData.project?.project_phases || selectedProject?.project_phases  // Ensure phases are present
      };
      
      // üîç DEBUG: Log project_evaluation_forms
      console.log('üì° [MERGED PROJECT] project_evaluation_forms:', dashboardData.project?.project_evaluation_forms);
      console.log('üì° [MERGED PROJECT] All project fields:', Object.keys(dashboardData.project || {}));
      console.log('üì° [MERGED PROJECT] project_phases:', dashboardData.project?.project_phases?.map(p => ({
        phase_number: p.phase_number,
        evaluation_available_from: p.evaluation_available_from,
        evaluation_due_date: p.evaluation_due_date
      })));
      console.log('üì° [MERGED PROJECT] Total phases after merge:', mergedProject.project_phases?.length);
      console.log('üì° [MERGED PROJECT] Phase numbers:', mergedProject.project_phases?.map(p => p.phase_number));
      console.log('üì° [MERGED PROJECT] Phases with breathe info:', mergedProject.project_phases?.map(p => ({ 
        phase_number: p.phase_number, 
        has_breathe: !!p.breathe_start_date,
        breathe_start: p.breathe_start_date,
        breathe_end: p.breathe_end_date
      })));
      
      // ‚úÖ CRITICAL FIX: Only update selectedProject if the ID is the same (prevent race conditions)
      // This prevents the infinite loop where updating selectedProject triggers useEffect which calls this function again
      if (!selectedProject || selectedProject.id === projectId) {
        setSelectedProject(mergedProject);
      } else {
        console.log('‚ö†Ô∏è [LOAD PROJECT] Skipping update - project changed during load');
      }
      
      setGroupMembers(dashboardData.groupMembers || []);
      setMyTasks(tasksData || []);
      setActivityStats(dashboardData.stats || {});
      
      // Load recent feedback (you can implement this endpoint later)
      setRecentFeedbacks([]);

    } catch (error) {
      console.error('Error loading project data:', error);
    }
  };

// Add these handler functions to your component

const handleAssignProjectChange = async (project) => {
  setSelectedAssignProject(project);
  setShowAssignProjectDropdown(false);
  setSelectedAssignMember(null);
  setSelectedAssignPhase(null);
  setAvailableAssignPhases([]);
  setCurrentActivePhase(null);
  
  // Load task limits and member task counts
  await loadTaskAssignmentData(project.id);
};

// Add this new validation function for date/time restrictions
const validateDateTimeRestrictions = (type) => {
  if (!selectedAssignPhase || !selectedAssignPhase.start_date || !selectedAssignPhase.end_date) {
    return true;
  }
  
  const phaseStart = new Date(selectedAssignPhase.start_date);
  const phaseEnd = new Date(selectedAssignPhase.end_date);
  
  let inputDate, inputTime;
  
  if (type === 'due') {
    inputDate = document.getElementById('taskDueDate')?.value;
    inputTime = document.getElementById('taskDueTime')?.value;
  } else if (type === 'available') {
    inputDate = document.getElementById('taskAvailableUntil')?.value;
    inputTime = document.getElementById('taskAvailableUntilTime')?.value;
  }
  
  if (!inputDate || !inputTime) {
    return true; // Allow if incomplete
  }
  
  // Combine date and time to create a full datetime
  const selectedDateTime = new Date(`${inputDate}T${inputTime}`);
  
  // Check if the selected date/time is within the phase bounds
  if (selectedDateTime < phaseStart || selectedDateTime > phaseEnd) {
    const inputElement = type === 'due' ? 
      document.getElementById('taskDueDate') : 
      document.getElementById('taskAvailableUntil');
    
    if (inputElement) {
      inputElement.setCustomValidity(
        `Date and time must be between ${formatDateTime(selectedAssignPhase.start_date)} and ${formatDateTime(selectedAssignPhase.end_date)}`
      );
      inputElement.reportValidity();
    }
    return false;
  }
  
  // Additional validation: Available until should not be before due date
  if (type === 'available') {
    const dueDateElement = document.getElementById('taskDueDate');
    const dueTimeElement = document.getElementById('taskDueTime');
    
    if (dueDateElement && dueTimeElement && dueDateElement.value && dueTimeElement.value) {
      const dueDatetime = new Date(`${dueDateElement.value}T${dueTimeElement.value}`);
      if (selectedDateTime < dueDatetime) {
        const inputElement = document.getElementById('taskAvailableUntil');
        if (inputElement) {
          inputElement.setCustomValidity('Available until date and time must be at or after the due date and time.');
          inputElement.reportValidity();
        }
        return false;
      }
    }
  }
  
  // Clear any custom validity if the date/time is valid
  const inputElement = type === 'due' ? 
    document.getElementById('taskDueDate') : 
    document.getElementById('taskAvailableUntil');
  
  if (inputElement) {
    inputElement.setCustomValidity('');
  }
  
  return true;
};

const loadTaskAssignmentData = async (projectId) => {
  try {
    const token = localStorage.getItem('token');
    
    // Check if user is a leader first
    const isLeader = userRole === 'leader';
    
    console.log('üîç Debug - Loading task assignment data for project:', projectId);
    console.log('üîç Debug - User is leader:', isLeader);
    
    if (!isLeader) {
      console.log('User is not a leader, loading basic project data only');
      // Use the general dashboard endpoint for phase information
      const response = await fetch(`${API_BASE_URL}/api/student/projects/${projectId}/dashboard`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      const projectPhases = data.project?.project_phases || [];
      
      // Sort phases by phase number
      const sortedPhases = projectPhases.sort((a, b) => a.phase_number - b.phase_number);
      setAvailableAssignPhases(sortedPhases);
      
      // Determine current active phase
      const now = new Date();
      const activePhase = sortedPhases.find(phase => {
        const startDate = new Date(phase.start_date);
        const endDate = new Date(phase.end_date);
        
        // Since database times are in UTC, compare with UTC time
        const nowUTC = new Date(now.toISOString());
        const startUTC = new Date(startDate.toISOString());
        const endUTC = new Date(endDate.toISOString());
        
        return nowUTC >= startUTC && nowUTC <= endUTC;
      });
      setCurrentActivePhase(activePhase);
      
      // Set default values since non-leaders can't assign tasks
      setTaskLimits({ min_tasks: 0, max_tasks: 0 });
      setMemberTaskCounts({});
      return;
    }
    
    // For leaders, first try the leader-specific endpoint
    console.log('üîç Trying leader dashboard endpoint...');
    const leaderResponse = await fetch(`${API_BASE_URL}/api/student/projects/${projectId}/leader-dashboard`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (leaderResponse.ok) {
      console.log('‚úÖ Leader dashboard endpoint successful');
      const data = await leaderResponse.json();
      const projectPhases = data.project?.project_phases || [];
      
      // Sort phases by phase number
      const sortedPhases = projectPhases.sort((a, b) => a.phase_number - b.phase_number);
      setAvailableAssignPhases(sortedPhases);
      
      // Determine current active phase
      const now = new Date();
      const activePhase = sortedPhases.find(phase => {
        const startDate = new Date(phase.start_date);
        const endDate = new Date(phase.end_date);
        
        // Since database times are in UTC, compare with UTC time
        const nowUTC = new Date(now.toISOString());
        const startUTC = new Date(startDate.toISOString());
        const endUTC = new Date(endDate.toISOString());
        
        return nowUTC >= startUTC && nowUTC <= endUTC;
      });
      setCurrentActivePhase(activePhase);
      
      // Set task limits from project data
      setTaskLimits({
        min_tasks: data.project?.min_tasks_per_member || 0,
        max_tasks: data.project?.max_tasks_per_member || 10
      });
      
      // Set project file settings
      const fileTypesAllowed = data.project?.file_types_allowed ? 
        (typeof data.project.file_types_allowed === 'string' ? 
          JSON.parse(data.project.file_types_allowed) : 
          data.project.file_types_allowed) : 
        [];
      
      setProjectFileSettings({
        file_types_allowed: fileTypesAllowed,
        max_file_size_mb: data.project?.max_file_size_mb || 10
      });
      
      // Calculate current task counts for each member
      const taskCounts = {};
      data.groupMembers?.forEach(member => {
        const memberTasks = data.tasks?.filter(task => task.assigned_to === member.student_id) || [];
        taskCounts[member.student_id] = memberTasks.length;
      });
      setMemberTaskCounts(taskCounts);
      return;
    }
    
    if (leaderResponse.status === 403) {
      console.warn('‚ö†Ô∏è Leader access denied, falling back to general dashboard');
      console.log('üîç This might indicate the user is a leader in a different project or group');
      
      // Fallback to general dashboard for phase information
      const fallbackResponse = await fetch(`${API_BASE_URL}/api/student/projects/${projectId}/dashboard`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!fallbackResponse.ok) {
        throw new Error(`HTTP error! status: ${fallbackResponse.status}`);
      }
      
      const data = await fallbackResponse.json();
      const projectPhases = data.project?.project_phases || [];
      
      // Sort phases by phase number
      const sortedPhases = projectPhases.sort((a, b) => a.phase_number - b.phase_number);
      setAvailableAssignPhases(sortedPhases);
      
      // Determine current active phase
      const now = new Date();
      const activePhase = sortedPhases.find(phase => {
        const startDate = new Date(phase.start_date);
        const endDate = new Date(phase.end_date);
        
        // Since database times are in UTC, compare with UTC time
        const nowUTC = new Date(now.toISOString());
        const startUTC = new Date(startDate.toISOString());
        const endUTC = new Date(endDate.toISOString());
        
        return nowUTC >= startUTC && nowUTC <= endUTC;
      });
      setCurrentActivePhase(activePhase);
      
      // Set basic limits since we can't access leader-specific data
      setTaskLimits({
        min_tasks: data.project?.min_tasks_per_member || 0,
        max_tasks: data.project?.max_tasks_per_member || 10
      });
      
      // We can't get task counts without leader access, so set empty
      setMemberTaskCounts({});
      
      console.log('‚ö†Ô∏è Loaded basic project data, but task assignment functionality may be limited');
      return;
    }
    
    throw new Error(`Leader dashboard failed with status: ${leaderResponse.status}`);
    
  } catch (error) {
    console.error('Error loading task assignment data:', error);
    // Don't show alert immediately, let the UI handle the display
    // Set default values on error
    setTaskLimits({ min_tasks: 0, max_tasks: 0 });
    setProjectFileSettings({ file_types_allowed: [], max_file_size_mb: 10 });
    setMemberTaskCounts({});
    setAvailableAssignPhases([]);
    setCurrentActivePhase(null);
  }
};

const handleAssignMemberSelect = (member) => {
  setSelectedAssignMember(member);
  setSelectedAssignPhase(currentActivePhase); // Auto-select current active phase if available
  // Reset form when selecting new member
  setTaskForm({
    title: '',
    description: '',
    max_attempts: 1,
    due_date: '',
    due_time: '',
    file_types_allowed: [],
    available_until_date: '',
    available_until_time: ''
  });
};

const handleTaskSubmit = async (e) => {
  e.preventDefault();
  
  if (!selectedAssignMember || !selectedAssignProject || !selectedAssignPhase) {
    alert('Please select a project, phase, and member before creating a task.');
    return;
  }
  
  try {
    setSubmittingTask(true);
    const token = localStorage.getItem('token');
    
    // Combine date and time for due_date and available_until
    const dueDateTime = new Date(`${taskForm.due_date}T${taskForm.due_time}`).toISOString();
    const availableUntil = taskForm.available_until_date && taskForm.available_until_time 
      ? new Date(`${taskForm.available_until_date}T${taskForm.available_until_time}`).toISOString()
      : null;
    
    // Final validation: ensure available until is not before due date
    if (availableUntil && dueDateTime) {
      const dueDate = new Date(dueDateTime);
      const availableDate = new Date(availableUntil);
      
      if (availableDate < dueDate) {
        alert('Available until date and time cannot be before the due date and time.');
        setSubmittingTask(false);
        return;
      }
    }
    
    const response = await fetch(`${API_BASE_URL}/api/student/projects/${selectedAssignProject.id}/tasks`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        phaseId: selectedAssignPhase.id,
        assignedTo: selectedAssignMember.student_id,
        title: taskForm.title,
        description: taskForm.description,
        dueDate: dueDateTime,
        availableUntil: availableUntil,
        maxAttempts: taskForm.max_attempts,
        fileTypesAllowed: taskForm.file_types_allowed
      })
    });
    
    if (response.ok) {
      // Reset form
      setTaskForm({
        title: '',
        description: '',
        max_attempts: 1,
        due_date: '',
        due_time: '',
        file_types_allowed: [],
        available_until_date: '',
        available_until_time: ''
      });
      setSelectedAssignMember(null);
      setSelectedAssignPhase(null);
      
      alert('Task assigned successfully!');
      
      // Refresh data - both assignment data and tasks list
      await loadTaskAssignmentData(selectedAssignProject.id);
      console.log('üîÑ About to call loadAssignedTasksWithCounts...');
      await loadAssignedTasksWithCounts(selectedAssignProject.id);
      console.log('‚úÖ Both data loading functions completed');
    } else {
      const error = await response.json();
      alert(`Failed to assign task: ${error.error || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Error assigning task:', error);
    alert('Error assigning task');
  } finally {
    setSubmittingTask(false);
  }
};

// =================== TASK MANAGEMENT FUNCTIONS ===================

// Function to load all assigned tasks for a project
const loadAssignedTasks = async (projectId) => {
  try {
    setLoadingAssignedTasks(true);
    console.log('üîç Loading assigned tasks for project:', projectId);
    
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/api/student-leader/projects/${projectId}/assigned-tasks`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ Assigned tasks loaded:', data);
      setAssignedTasks(data.tasks || []);
    } else {
      console.error('‚ùå Failed to load assigned tasks');
      setAssignedTasks([]);
    }
  } catch (error) {
    console.error('üí• Error loading assigned tasks:', error);
    setAssignedTasks([]);
  } finally {
    setLoadingAssignedTasks(false);
  }
};

// Function to handle task mode change (Assignment vs Management)
const handleTaskModeChange = async (mode) => {
  console.log('üîÑ Switching to task mode:', mode);
  setCurrentTaskMode(mode);
  
  if (selectedAssignProject) {
    if (mode === 'management') {
      await loadAssignedTasksWithCounts(selectedAssignProject.id);
      setSelectedMemberForTasks('all');
    } else if (mode === 'assignment') {
      // Load tasks for assignment mode as well
      await loadAssignedTasksWithCounts(selectedAssignProject.id);
    }
  }
};

// Function to open task edit modal
const handleEditTask = async (task) => {
  console.log('‚úèÔ∏è Editing task:', task);
  
  // Load task submissions to check if task has been submitted to
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/api/student/tasks/${task.id}/submissions`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      const data = await response.json();
      setTaskSubmissions(data.submissions || []);
    } else {
      setTaskSubmissions([]);
    }
  } catch (error) {
    console.error('Error loading task submissions:', error);
    setTaskSubmissions([]);
  }
  
  // Parse dates for form
  const dueDate = task.due_date ? new Date(task.due_date) : null;
  const availableUntil = task.available_until ? new Date(task.available_until) : null;
  
  console.log('Task being edited:', {
    title: task.title,
    project_phases: task.project_phases,
    phase_info: {
      nested: task.project_phases,
      flat_name: task.phase_name,
      flat_start: task.phase_start_date,
      flat_end: task.phase_end_date
    }
  });
  
  setEditingTask(task);
  setEditTaskForm({
    title: task.title || '',
    description: task.description || '',
    due_date: dueDate ? dueDate.toISOString().split('T')[0] : '',
    due_time: dueDate ? dueDate.toTimeString().slice(0, 5) : '',
    available_until_date: availableUntil ? availableUntil.toISOString().split('T')[0] : '',
    available_until_time: availableUntil ? availableUntil.toTimeString().slice(0, 5) : '',
    max_attempts: task.max_attempts || 1,
    file_types_allowed: Array.isArray(task.file_types_allowed) 
      ? task.file_types_allowed 
      : (task.file_types_allowed ? [task.file_types_allowed] : [])
  });
  
  setShowEditTaskModal(true);
};

// Helper functions to get phase information from task objects
const getPhaseStartDate = (task) => {
  return task?.project_phases?.start_date || task?.phase_start_date;
};

const getPhaseEndDate = (task) => {
  return task?.project_phases?.end_date || task?.phase_end_date;
};

const getPhaseTitle = (task) => {
  return task?.project_phases?.title || task?.phase_name;
};

// Helper function to get time constraints for a specific date within phase boundaries
const getTimeConstraints = (selectedDate, task) => {
  const phaseStartDate = getPhaseStartDate(task);
  const phaseEndDate = getPhaseEndDate(task);
  
  if (!phaseStartDate || !phaseEndDate || !selectedDate) {
    return { min: undefined, max: undefined };
  }
  
  const phaseStart = new Date(phaseStartDate);
  const phaseEnd = new Date(phaseEndDate);
  const selectedDateObj = new Date(selectedDate);
  
  let minTime = undefined;
  let maxTime = undefined;
  
  // If selected date is the same as phase start date, set min time
  if (selectedDateObj.toDateString() === phaseStart.toDateString()) {
    minTime = phaseStart.toTimeString().slice(0, 5); // HH:MM format
  }
  
  // If selected date is the same as phase end date, set max time
  if (selectedDateObj.toDateString() === phaseEnd.toDateString()) {
    maxTime = phaseEnd.toTimeString().slice(0, 5); // HH:MM format
  }
  
  return { min: minTime, max: maxTime };
};

// Helper function to get time constraints for task assignment based on selected phase
const getPhaseTimeConstraints = (selectedDate, phase) => {
  if (!phase || !selectedDate) {
    return { min: undefined, max: undefined };
  }
  
  const phaseStart = new Date(phase.start_date);
  const phaseEnd = new Date(phase.end_date);
  const selectedDateObj = new Date(selectedDate);
  
  let minTime = undefined;
  let maxTime = undefined;
  
  // If selected date is the same as phase start date, set min time
  if (selectedDateObj.toDateString() === phaseStart.toDateString()) {
    minTime = phaseStart.toTimeString().slice(0, 5); // HH:MM format
  }
  
  // If selected date is the same as phase end date, set max time
  if (selectedDateObj.toDateString() === phaseEnd.toDateString()) {
    maxTime = phaseEnd.toTimeString().slice(0, 5); // HH:MM format
  }
  
  return { min: minTime, max: maxTime };
};

// Validation function for edit modal date/time restrictions
const validateEditDateTimeRestrictions = (type) => {
  // Get the phase information for the task being edited
  const phaseStartDate = getPhaseStartDate(editingTask);
  const phaseEndDate = getPhaseEndDate(editingTask);
  
  if (!phaseStartDate || !phaseEndDate) {
    console.warn('No phase information available for date validation');
    console.log('Task structure:', editingTask);
    return true; // Allow if no phase info available
  }

  const taskPhase = {
    start_date: phaseStartDate,
    end_date: phaseEndDate
  };
  
  const phaseStart = new Date(taskPhase.start_date);
  const phaseEnd = new Date(taskPhase.end_date);
  
  console.log('Phase bounds:', { start: phaseStart, end: phaseEnd });
  
  let inputDate, inputTime;
  
  if (type === 'due') {
    inputDate = editTaskForm.due_date;
    inputTime = editTaskForm.due_time;
  } else if (type === 'available') {
    inputDate = editTaskForm.available_until_date;
    inputTime = editTaskForm.available_until_time;
  }
  
  if (!inputDate || !inputTime) {
    return true; // Allow if incomplete
  }
  
  // Combine date and time to create a full datetime
  const selectedDateTime = new Date(`${inputDate}T${inputTime}`);
  console.log('Selected datetime:', selectedDateTime, 'Type:', type);
  
  // Check if the selected date/time is within the phase bounds
  if (selectedDateTime < phaseStart || selectedDateTime > phaseEnd) {
    alert(`${type === 'due' ? 'Due' : 'Available until'} date and time must be between ${formatDateTime(taskPhase.start_date)} and ${formatDateTime(taskPhase.end_date)}`);
    return false;
  }
  
  // Additional validation: Available until should not be before due date
  if (type === 'available') {
    const dueDatetime = new Date(`${editTaskForm.due_date}T${editTaskForm.due_time}`);
    if (selectedDateTime < dueDatetime) {
      alert('Available until date and time must be at or after the due date and time.');
      return false;
    }
  }
  
  return true;
};

// Function to handle task update
const handleUpdateTask = async (e) => {
  e.preventDefault();
  
  if (!editTaskForm.title || !editTaskForm.description || !editTaskForm.due_date || !editTaskForm.due_time) {
    alert('Please fill in all required fields: title, description, due date, and due time.');
    return;
  }
  
  // Validate that if available until date is provided, time should also be provided
  if (editTaskForm.available_until_date && !editTaskForm.available_until_time) {
    alert('Please provide both available until date and time.');
    return;
  }
  
  // Validate date/time restrictions based on phase bounds
  if (!validateEditDateTimeRestrictions('due')) {
    return;
  }
  
  if (editTaskForm.available_until_date && !validateEditDateTimeRestrictions('available')) {
    return;
  }
  
  // Check if task has submissions
  const hasSubmissions = taskSubmissions && taskSubmissions.length > 0;
  
  if (hasSubmissions) {
    const confirmUpdate = window.confirm(
      `This task has ${taskSubmissions.length} submission(s). ` +
      `Updating the task will notify the assigned member about the changes and may affect their work. ` +
      `Are you sure you want to continue?`
    );
    
    if (!confirmUpdate) {
      return;
    }
  }

  setUpdatingTask(true);
  
  try {
    const token = localStorage.getItem('token');
    
    // Combine date and time
    const dueDateTime = editTaskForm.due_date && editTaskForm.due_time 
      ? new Date(`${editTaskForm.due_date}T${editTaskForm.due_time}`).toISOString()
      : null;
    const availableUntil = editTaskForm.available_until_date && editTaskForm.available_until_time 
      ? new Date(`${editTaskForm.available_until_date}T${editTaskForm.available_until_time}`).toISOString()
      : null;

    // Final validation: ensure available until is not before due date
    if (availableUntil && dueDateTime) {
      const dueDate = new Date(dueDateTime);
      const availableDate = new Date(availableUntil);
      
      if (availableDate < dueDate) {
        alert('Available until date and time cannot be before the due date and time.');
        setUpdatingTask(false);
        return;
      }
    }

    const response = await fetch(`${API_BASE_URL}/api/student/tasks/${editingTask.id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: editTaskForm.title,
        description: editTaskForm.description,
        due_date: dueDateTime,
        available_until: availableUntil,
        max_attempts: editTaskForm.max_attempts,
        file_types_allowed: editTaskForm.file_types_allowed,
        has_existing_submissions: hasSubmissions
      })
    });

    if (response.ok) {
      const result = await response.json();
      alert(
        'Task updated successfully!' + 
        (result.notification_sent ? ' The assigned member has been notified.' : '')
      );
      setShowEditTaskModal(false);
      setEditingTask(null);
      
      // Refresh the assigned tasks list
      await loadAssignedTasksWithCounts(selectedAssignProject.id);
      // Maintain current member selection
      if (selectedMemberForTasks) {
        handleMemberSelectForTasks(selectedMemberForTasks);
      }
    } else {
      const error = await response.json();
      alert(`Failed to update task: ${error.error || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Error updating task:', error);
    alert('Error updating task');
  } finally {
    setUpdatingTask(false);
  }
};

// Function to close task mode and return to selection
const handleCloseTaskMode = () => {
  console.log('‚ùå Closing task mode');
  setCurrentTaskMode(null);
  setAssignedTasks([]);
  setSelectedTaskToEdit(null);
  setShowTaskEditModal(false);
};

// Function to handle task deletion
const handleDeleteTask = async (task) => {
  const confirmDelete = window.confirm(
    `Are you sure you want to delete the task "${task.title}"?` +
    (task.submissions_count > 0 
      ? ` This task has ${task.submissions_count} submission(s) and the assigned member will be notified.`
      : '')
  );
  
  if (!confirmDelete) {
    return;
  }

  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`${API_BASE_URL}/api/student/tasks/${task.id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const result = await response.json();
      alert(
        `Task deleted successfully!` + 
        (result.notification_sent ? ' The assigned member has been notified.' : '')
      );
      
      // Refresh the assigned tasks list
      await loadAssignedTasksWithCounts(selectedAssignProject.id);
      // Maintain current member selection
      if (selectedMemberForTasks) {
        handleMemberSelectForTasks(selectedMemberForTasks);
      }
    } else {
      const error = await response.json();
      alert(`Failed to delete task: ${error.error || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Error deleting task:', error);
    alert('Error deleting task');
  }
};

// Function to handle task edit form cancellation
const handleCancelEditTask = () => {
  setShowEditTaskModal(false);
  setEditingTask(null);
  setEditTaskForm({
    title: '',
    description: '',
    due_date: '',
    due_time: '',
    available_until_date: '',
    available_until_time: '',
    max_attempts: 1,
    file_types_allowed: []
  });
};

// Function to handle member selection for task filtering
const handleMemberSelectForTasks = (member) => {
  console.log('üë§ Selected member for task filtering:', member);
  setSelectedMemberForTasks(member);
  
  if (member === 'all') {
    setFilteredTasks(assignedTasks);
  } else {
    const memberTasks = assignedTasks.filter(task => task.assigned_to_id === member.student_id);
    setFilteredTasks(memberTasks);
  }
};

// Function to calculate task counts per member
const calculateMemberTaskCounts = (tasks, members, selectedPhaseId = null) => {
  const counts = {};
  
  members.forEach(member => {
    // Filter tasks by member and optionally by phase
    let memberTasks = tasks.filter(task => task.assigned_to_id === member.student_id);
    
    // If a specific phase is selected, only count tasks for that phase
    if (selectedPhaseId) {
      memberTasks = memberTasks.filter(task => task.phase_id === selectedPhaseId);
    }
    
    counts[member.student_id] = memberTasks.length;
  });
  
  return counts;
};

// Calculate task counts per phase for a specific member
const calculateMemberPhaseTaskCounts = (tasks, memberId, phases) => {
  const phaseCounts = {};
  
  phases.forEach(phase => {
    const phaseTaskCount = tasks.filter(task => 
      task.assigned_to_id === memberId && 
      task.phase_id === phase.id
    ).length;
    
    phaseCounts[phase.id] = phaseTaskCount;
  });
  
  return phaseCounts;
};

// Enhanced loadAssignedTasks to include member task counts
const loadAssignedTasksWithCounts = async (projectId) => {
  try {
    setLoadingAssignedTasks(true);
    console.log('üîç Loading assigned tasks with member counts for project:', projectId);
    
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/api/student-leader/projects/${projectId}/assigned-tasks`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ Assigned tasks loaded:', data);
      
      // Debug: Log phase info for first task
      if (data.tasks && data.tasks.length > 0) {
        console.log('üìã Sample task phase data:', {
          title: data.tasks[0].title,
          project_phases: data.tasks[0].project_phases,
          flat_phase_name: data.tasks[0].phase_name,
          flat_phase_start_date: data.tasks[0].phase_start_date,
          flat_phase_end_date: data.tasks[0].phase_end_date
        });
      }
      
      // Ensure file_types_allowed is always an array for each task
      const safeTasks = (data.tasks || []).map(task => ({
        ...task,
        file_types_allowed: Array.isArray(task.file_types_allowed) 
          ? task.file_types_allowed 
          : (task.file_types_allowed ? [task.file_types_allowed] : [])
      }));
      
      console.log('üîÑ Setting assignedTasks with:', safeTasks.length, 'tasks');
      console.log('üìã Task sample:', safeTasks[0]);
      setAssignedTasks(safeTasks);
      setFilteredTasks(safeTasks);
      
      // Calculate task counts for each member based on selected phase
      if (groupMembers.length > 0) {
        const counts = calculateMemberTaskCounts(safeTasks, groupMembers, selectedAssignPhase?.id);
        setMemberTaskCounts(counts);
      }
    } else {
      console.error('‚ùå Failed to load assigned tasks');
      setAssignedTasks([]);
      setFilteredTasks([]);
    }
  } catch (error) {
    console.error('üí• Error loading assigned tasks:', error);
    setAssignedTasks([]);
    setFilteredTasks([]);
  } finally {
    setLoadingAssignedTasks(false);
  }
};

// =================== EXTENSION REQUEST HANDLERS (LEADER) ===================

// Load extension requests for a group
const loadExtensionRequests = async (groupId) => {
  try {
    setTaskAssignmentView(prev => ({ ...prev, extensionRequestsLoading: true }));
    console.log('üìã Loading extension requests for group:', groupId);
    
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/student/group/${groupId}/extension-requests`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const requests = await response.json();
      console.log('‚úÖ Extension requests loaded:', requests);
      
      setTaskAssignmentView(prev => ({
        ...prev,
        extensionRequests: requests,
        extensionRequestsLoading: false
      }));
    } else {
      console.error('‚ùå Failed to load extension requests');
      setTaskAssignmentView(prev => ({
        ...prev,
        extensionRequests: [],
        extensionRequestsLoading: false
      }));
    }
  } catch (error) {
    console.error('üí• Error loading extension requests:', error);
    setTaskAssignmentView(prev => ({
      ...prev,
      extensionRequests: [],
      extensionRequestsLoading: false
    }));
  }
};

// Handle extension request selection for approval
const handleExtensionRequestSelect = (request) => {
  console.log('üîµ [APPROVE] Button clicked, request:', request);
  setTaskAssignmentView(prev => {
    const newState = { 
      ...prev, 
      selectedExtensionRequest: request
    };
    console.log('üîµ [APPROVE] Setting taskAssignmentView:', newState);
    return newState;
  });
  
  // Set the modal states separately
  setShowExtensionApprovalModal(true);
  
  // Pre-fill form with original dates
  setExtensionApprovalForm({
    new_due_date: request.original_due_date?.split('T')[0] || '',
    new_due_time: request.original_due_date?.split('T')[1]?.substring(0, 5) || '',
    new_available_until_date: request.original_available_until?.split('T')[0] || '',
    new_available_until_time: request.original_available_until?.split('T')[1]?.substring(0, 5) || '',
    leader_notes: ''
  });
};

// Handle extension request selection for rejection
const handleExtensionRequestReject = (request) => {
  console.log('üî¥ [REJECT] Button clicked, request:', request);
  setTaskAssignmentView(prev => {
    const newState = { 
      ...prev, 
      selectedExtensionRequest: request
    };
    console.log('üî¥ [REJECT] Setting taskAssignmentView:', newState);
    return newState;
  });
  
  // Set the modal states separately
  setShowExtensionRejectionModal(true);
  setExtensionRejectionReason('');
};

// Approve extension request
const handleApproveExtension = async () => {
  const request = taskAssignmentView.selectedExtensionRequest;
  if (!request) return;

  // Validate required fields
  if (!extensionApprovalForm.new_due_date) {
    alert('Please provide a new due date');
    return;
  }

  // Validate new due date is in the future
  const now = new Date();
  const newDueDate = new Date(extensionApprovalForm.new_due_date);
  if (newDueDate < now) {
    alert('New due date must be in the future');
    return;
  }

  // Validate available_until if provided
  if (extensionApprovalForm.new_available_until_date) {
    const newAvailableUntil = new Date(extensionApprovalForm.new_available_until_date);
    if (newAvailableUntil < newDueDate) {
      alert('Available until date must be after or equal to due date');
      return;
    }
  }

  setApprovingExtension(true);
  try {
    const token = localStorage.getItem('token');
    
    const requestBody = {
      new_due_date: `${extensionApprovalForm.new_due_date}T${extensionApprovalForm.new_due_time}:00`,
      leader_notes: extensionApprovalForm.leader_notes || null
    };
    
    // Only include available_until if it's set
    if (extensionApprovalForm.new_available_until_date) {
      requestBody.new_available_until = `${extensionApprovalForm.new_available_until_date}T${extensionApprovalForm.new_available_until_time}:00`;
    }
    
    const response = await fetch(`/api/student/extension-requests/${request.id}/approve`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to approve extension request');
    }

    alert('Extension request approved successfully!');
    
    // Close modal and reset state
    setShowExtensionApprovalModal(false);
    setTaskAssignmentView(prev => ({ 
      ...prev, 
      selectedExtensionRequest: null
    }));
    setExtensionApprovalForm({
      new_due_date: '',
      new_due_time: '',
      new_available_until_date: '',
      new_available_until_time: '',
      leader_notes: ''
    });
    
    // Reload extension requests
    if (groupData?.group_id) {
      await loadExtensionRequests(groupData.group_id);
    }
    
    // Reload task assignment data to show updated due dates
    if (taskAssignmentView.selectedProject) {
      const token = localStorage.getItem('token');
      
      // Reload group members
      const membersResponse = await fetch(
        `${apiConfig.baseURL}/api/task-assignment/projects/${taskAssignmentView.selectedProject.id}/members`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (membersResponse.ok) {
        const membersData = await membersResponse.json();
        
        // Reload phases
        const phasesResponse = await fetch(
          `${apiConfig.baseURL}/api/task-assignment/projects/${taskAssignmentView.selectedProject.id}/phases`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (phasesResponse.ok) {
          const phasesData = await phasesResponse.json();
          
          // Reload assigned tasks
          const tasksResponse = await fetch(
            `${apiConfig.baseURL}/api/student-leader/projects/${taskAssignmentView.selectedProject.id}/assigned-tasks`,
            {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            }
          );

          let assignedTasksMap = {};
          if (tasksResponse.ok) {
            const data = await tasksResponse.json();
            if (data.tasks && data.tasks.length > 0) {
              data.tasks.forEach(task => {
                const key = `${task.assigned_to_id}-${task.phase_id}`;
                assignedTasksMap[key] = (assignedTasksMap[key] || 0) + 1;
              });
            }
          }
          
          setTaskAssignmentView(prev => ({
            ...prev,
            groupMembers: membersData.members || [],
            projectPhases: phasesData.phases || [],
            assignedTasks: assignedTasksMap
          }));
        }
      }
    }
    
  } catch (error) {
    console.error('Extension approval error:', error);
    alert(error.message || 'Failed to approve extension request');
  } finally {
    setApprovingExtension(false);
  }
};

// Reject extension request
const handleRejectExtension = async () => {
  const request = taskAssignmentView.selectedExtensionRequest;
  if (!request) return;

  setRejectingExtension(true);
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/student/extension-requests/${request.id}/reject`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        rejection_reason: extensionRejectionReason.trim() || null
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to reject extension request');
    }

    alert('Extension request rejected');
    
    // Close modal and reload requests
    setShowExtensionRejectionModal(false);
    setTaskAssignmentView(prev => ({ ...prev, selectedExtensionRequest: null }));
    setExtensionRejectionReason('');
    
    // Reload extension requests
    if (groupData?.group_id) {
      await loadExtensionRequests(groupData.group_id);
    }
    
  } catch (error) {
    console.error('Extension rejection error:', error);
    alert(error.message || 'Failed to reject extension request');
  } finally {
    setRejectingExtension(false);
  }
};

// =================== END EXTENSION REQUEST HANDLERS ===================











  const loadAnnouncements = async () => {
    try {
      setAnnouncementsLoading(true);
      const token = localStorage.getItem('token');
      const response = await fetch('/api/student/announcements', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      setAnnouncements(data || []);
    } catch (error) {
      console.error('Error loading announcements:', error);
    } finally {
      setAnnouncementsLoading(false);
    }
  };

  const loadNotifications = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/notifications', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const result = await response.json();
      
      if (response.ok) {
        setNotifications(result.notifications || []);
        // Update unread count
        const unreadCount = result.notifications?.filter(n => !n.is_read).length || 0;
        setUnreadNotifications(unreadCount);
      } else {
        console.error('Error loading notifications:', result);
        setNotifications([]);
      }
    } catch (error) {
      console.error('Error loading notifications:', error);
      setNotifications([]);
    }
  };

  const loadGrades = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/student/grades', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      setGrades(data || []);
    } catch (error) {
      console.error('Error loading grades:', error);
    }
  };

  const loadRecentFeedbacks = async () => {
    try {
      setFeedbacksLoading(true);
      const token = localStorage.getItem('token');
      const response = await fetch('/api/student/recent-feedbacks', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const data = await response.json();
        // Handle both direct array and wrapped response
        const feedbacks = Array.isArray(data) ? data : (data.feedbacks || []);
        console.log('‚úÖ Recent feedbacks loaded:', feedbacks.length);
        setRecentFeedbacks(feedbacks.slice(0, 10)); // Limit to 10 most recent
      } else {
        console.error('Failed to load recent feedbacks:', response.status);
        setRecentFeedbacks([]);
      }
    } catch (error) {
      console.error('Error loading recent feedbacks:', error);
      setRecentFeedbacks([]);
    } finally {
      setFeedbacksLoading(false);
    }
  };

  // Load all user's tasks across all projects (for Course Overview)
  const loadAllUserTasks = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/student/all-my-tasks', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const data = await response.json();
        const tasks = data.tasks || data || [];
        console.log('‚úÖ All user tasks loaded:', tasks.length, 'tasks');
        
        // Set all tasks as todoActivities (don't filter by status - let getActivityStatus determine the actual status)
        // This ensures missed, late, and all other task statuses are included in the to-do column
        setTodoActivities(tasks);
      } else {
        console.error('Failed to load all user tasks:', response.status);
        setTodoActivities([]);
      }
    } catch (error) {
      console.error('Error loading all user tasks:', error);
      setTodoActivities([]);
    }
  };

  // Sidebar toggle function
  const toggleSidebar = () => {
    setSidebarCollapsed(!sidebarCollapsed);
  };

  // ‚úÖ NEW: Helper function to check if a project hasn't ended
  const isProjectOngoing = (project) => {
    if (!project?.due_date) return true; // If no due date, consider it ongoing
    
    const dueDate = new Date(project.due_date);
    const now = new Date();
    
    // Project is ongoing if the due date hasn't passed yet
    return dueDate > now;
  };

  // ‚úÖ NEW: Helper function to calculate sequential phase number (treating eval and breathe as separate phases)
  const getSequentialPhaseNumber = (phase, allPhases) => {
    if (!phase || !allPhases) return 1;
    
    // Sort phases by phase_number
    const sortedPhases = [...allPhases].sort((a, b) => a.phase_number - b.phase_number);
    
    let sequentialNumber = 0;
    
    for (const p of sortedPhases) {
      // Work phase
      sequentialNumber++;
      if (p.id === phase.id && phase.currentPhaseType === 'work') {
        return sequentialNumber;
      }
      
      // Evaluation phase (if exists)
      if (p.evaluation_available_from) {
        sequentialNumber++;
        if (p.id === phase.id && phase.currentPhaseType === 'evaluation') {
          return sequentialNumber;
        }
      }
      
      // Breathe phase (if exists)
      if (p.breathe_start_date) {
        sequentialNumber++;
        if (p.id === phase.id && phase.currentPhaseType === 'breathe') {
          return sequentialNumber;
        }
      }
    }
    
    return sequentialNumber;
  };

  // Sidebar navigation handler
  const handleNavItemClick = (itemId) => {
    // If sidebar is collapsed and a nav item is clicked, expand it
    if (sidebarCollapsed) {
      setSidebarCollapsed(false);
    }
    
    // If clicking Course Overview and already on it, refresh the content
    if (itemId === 'course-overview' && activeTab === 'course-overview') {
      console.log('üîÑ Refreshing Course Overview content');
      // Refresh all Course Overview data
      Promise.all([
        loadAllUserTasks(),
        loadAnnouncements(),
        loadNotifications(),
        loadRecentFeedbacks()
      ]).catch(error => {
        console.error('Error refreshing Course Overview:', error);
      });
    }
    
    // Set the active tab
    setActiveTab(itemId);
  };

  // Event handlers
  const handleProjectChange = async (project) => {
    console.log('üîÑ [PROJECT CHANGE] Changing to project:', project.title, 'group_id:', project.group_id);
    
    // ‚úÖ FIX: Ensure project has group_id before setting
    if (!project.group_id && groupData?.id) {
      project.group_id = groupData.id;
      console.log('‚úÖ [PROJECT CHANGE] Added group_id from groupData:', project.group_id);
    }
    
    // ‚úÖ CRITICAL FIX: Set flag to prevent phase detection from running on stale data
    setIsProjectSwitching(true);
    
    setSelectedProject(project);
    setShowProjectDropdown(false);
    
    // ‚úÖ CRITICAL FIX: Reset viewedPhase to null when changing projects
    // This ensures the phase detection logic will set the correct phase for the NEW project
    console.log('üîÑ [PROJECT CHANGE] Resetting phases and blocking phase detection during load');
    setViewedPhase(null);
    setCurrentPhase(null);
    
    await Promise.all([
      loadProjectSpecificData(project.id),
      loadTodoData(project.id),
      // Fetch evaluation submissions for both phase and project evaluations
      fetchMyEvaluationSubmissions(project.group_id || groupData?.id, null, project.id)
    ]);
    
    // ‚úÖ CRITICAL FIX: Clear flag after all data is loaded
    // This will trigger the phase detection useEffect to run with fresh data
    console.log('‚úÖ [PROJECT CHANGE] Data loaded, enabling phase detection');
    setIsProjectSwitching(false);
    
    // ‚úÖ NEW: Auto-navigate to current active phase
    // After data is loaded, detect the current active phase and navigate to it
    if (project.project_phases && project.project_phases.length > 0) {
      console.log('üéØ [PROJECT CHANGE] Auto-detecting current active phase...');
      
      const now = new Date();
      const activePhase = project.project_phases.find(phase => {
        const startDate = new Date(phase.start_date);
        const endDate = new Date(phase.end_date);
        
        const evaluationAvailableFrom = phase.evaluation_available_from ? new Date(phase.evaluation_available_from) : null;
        const evaluationDueDate = phase.evaluation_due_date ? new Date(phase.evaluation_due_date) : null;
        
        const breatheStartDate = phase.breathe_start_date ? new Date(phase.breathe_start_date) : null;
        const breatheEndDate = phase.breathe_end_date ? new Date(phase.breathe_end_date) : null;
        
        const nowUTC = new Date(now.toISOString());
        const startUTC = new Date(startDate.toISOString());
        const endUTC = new Date(endDate.toISOString());
        const evalStartUTC = evaluationAvailableFrom ? new Date(evaluationAvailableFrom.toISOString()) : null;
        const evalEndUTC = evaluationDueDate ? new Date(evaluationDueDate.toISOString()) : null;
        const breatheStartUTC = breatheStartDate ? new Date(breatheStartDate.toISOString()) : null;
        const breatheEndUTC = breatheEndDate ? new Date(breatheEndDate.toISOString()) : null;
        
        return (nowUTC >= startUTC && nowUTC <= endUTC) ||
               (evalStartUTC && evalEndUTC && nowUTC >= evalStartUTC && nowUTC <= evalEndUTC) ||
               (breatheStartUTC && breatheEndUTC && nowUTC >= breatheStartUTC && nowUTC <= breatheEndUTC);
      });
      
      if (activePhase) {
        // Determine phase type
        const now = new Date();
        const nowUTC = new Date(now.toISOString());
        
        const evaluationAvailableFrom = activePhase.evaluation_available_from ? new Date(activePhase.evaluation_available_from) : null;
        const evaluationDueDate = activePhase.evaluation_due_date ? new Date(activePhase.evaluation_due_date) : null;
        const breatheStartDate = activePhase.breathe_start_date ? new Date(activePhase.breathe_start_date) : null;
        const breatheEndDate = activePhase.breathe_end_date ? new Date(activePhase.breathe_end_date) : null;
        
        const evalStartUTC = evaluationAvailableFrom ? new Date(evaluationAvailableFrom.toISOString()) : null;
        const evalEndUTC = evaluationDueDate ? new Date(evaluationDueDate.toISOString()) : null;
        const breatheStartUTC = breatheStartDate ? new Date(breatheStartDate.toISOString()) : null;
        const breatheEndUTC = breatheEndDate ? new Date(breatheEndDate.toISOString()) : null;
        
        let phaseType = 'work';
        if (evalStartUTC && evalEndUTC && nowUTC >= evalStartUTC && nowUTC <= evalEndUTC) {
          phaseType = 'evaluation';
        } else if (breatheStartUTC && breatheEndUTC && nowUTC >= breatheStartUTC && nowUTC <= breatheEndUTC) {
          phaseType = 'breathe';
        }
        
        const phaseToNavigate = { ...activePhase, currentPhaseType: phaseType };
        console.log('üéØ [PROJECT CHANGE] Navigating to phase:', activePhase.phase_number, activePhase.title, 'Type:', phaseType);
        setCurrentPhase(phaseToNavigate);
        setViewedPhase(phaseToNavigate);
      } else {
        console.log('üéØ [PROJECT CHANGE] No active phase found, defaulting to first phase');
        const firstPhase = { ...project.project_phases[0], currentPhaseType: 'work' };
        setCurrentPhase(firstPhase);
        setViewedPhase(firstPhase);
      }
    }
  };

  // Enhanced refresh function
  const refreshData = async (source = 'auto') => {
    // Skip refresh if any modals are open to prevent conflicts
    if (showTaskModal || showRevisionModal || showCompletedModal || showMemberModal || showPhaseModal) {
      console.log(`üîÑ ${source} refresh skipped - modal is open`);
      return;
    }
    
    if (activeTab === 'project-dashboard' && selectedProject) {
      console.log(`üîÑ ${source} refresh - project dashboard`);
      await Promise.all([
        loadProjectSpecificData(selectedProject.id),
        loadTodoData(selectedProject.id, false) // Silent refresh - no loading indicator
      ]);
    }
  };

  // Phase navigation functions
  // These now support navigation through: Work Phase -> Evaluation Phase -> Breathe Phase -> Next Phase
  const navigateToPreviousPhase = () => {
    console.log('üîç navigateToPreviousPhase called');
    console.log('üîç navigateToPreviousPhase: selectedProject:', selectedProject?.title);
    console.log('üîç navigateToPreviousPhase: currentPhase:', currentPhase?.phase_number, 'type:', currentPhase?.currentPhaseType);
    console.log('üîç navigateToPreviousPhase: viewedPhase:', viewedPhase?.phase_number, 'type:', viewedPhase?.currentPhaseType);
    console.log('üîç navigateToPreviousPhase: ALL available phases:', selectedProject?.project_phases?.map(p => ({ id: p.id, phase_number: p.phase_number, title: p.title, has_eval: !!p.evaluation_available_from, has_breathe: !!p.breathe_start_date })));
    
    if (!selectedProject || !selectedProject.project_phases || selectedProject.project_phases.length === 0) {
      console.log('üîç navigateToPreviousPhase: No project or phases available');
      return;
    }
    
    const sortedPhases = [...selectedProject.project_phases].sort((a, b) => a.phase_number - b.phase_number);
    const phase = viewedPhase || currentPhase;
    const currentPhaseIdx = sortedPhases.findIndex(p => p.id === phase?.id);
    const currentPhaseType = phase?.currentPhaseType || 'work';
    
    console.log('üîç navigateToPreviousPhase: currentPhaseIdx:', currentPhaseIdx, 'currentPhaseType:', currentPhaseType, 'total phases:', sortedPhases.length);
    
    if (currentPhaseIdx === -1) {
      console.log('üîç navigateToPreviousPhase: Current phase not found, navigating to last phase');
      // Set to last phase with default 'work' type
      setViewedPhase({ ...sortedPhases[sortedPhases.length - 1], currentPhaseType: 'work' });
      return;
    }
    
    const currentPhaseObj = sortedPhases[currentPhaseIdx];
    
    // Navigate backwards within phase types: breathe -> eval -> work
    if (currentPhaseType === 'evaluation' || currentPhaseType === 'breathe') {
      // Within same phase: go back to work or previous phase type
      if (currentPhaseType === 'breathe') {
        // Go to evaluation (same phase)
        console.log('üîç navigateToPreviousPhase: Moving from breathe to evaluation (same phase)');
        setViewedPhase({ ...currentPhaseObj, currentPhaseType: 'evaluation' });
        // Reload evaluation submissions
        if (selectedProject?.group_id) {
          fetchMyEvaluationSubmissions(selectedProject.group_id, currentPhaseObj.id, null);
        }
      } else if (currentPhaseType === 'evaluation') {
        // Go to work phase (same phase)
        console.log('üîç navigateToPreviousPhase: Moving from evaluation to work (same phase)');
        setViewedPhase({ ...currentPhaseObj, currentPhaseType: 'work' });
      }
    } else {
      // In work phase - go to breathe of previous phase, or to previous phase's work
      if (currentPhaseIdx > 0) {
        const prevPhaseObj = sortedPhases[currentPhaseIdx - 1];
        if (prevPhaseObj.breathe_start_date) {
          console.log('üîç navigateToPreviousPhase: Moving to breathe phase of previous phase', prevPhaseObj.phase_number);
          setViewedPhase({ ...prevPhaseObj, currentPhaseType: 'breathe' });
        } else if (prevPhaseObj.evaluation_available_from) {
          console.log('üîç navigateToPreviousPhase: Moving to evaluation phase of previous phase', prevPhaseObj.phase_number);
          setViewedPhase({ ...prevPhaseObj, currentPhaseType: 'evaluation' });
          // Reload evaluation submissions
          if (selectedProject?.group_id) {
            fetchMyEvaluationSubmissions(selectedProject.group_id, prevPhaseObj.id, null);
          }
        } else {
          console.log('üîç navigateToPreviousPhase: Moving to work phase of previous phase', prevPhaseObj.phase_number);
          setViewedPhase({ ...prevPhaseObj, currentPhaseType: 'work' });
        }
      } else {
        console.log('üîç navigateToPreviousPhase: Already at first phase in work mode');
      }
    }
  };

  const navigateToNextPhase = () => {
    console.log('üîç navigateToNextPhase called');
    console.log('üîç navigateToNextPhase: selectedProject:', selectedProject?.title);
    console.log('üîç navigateToNextPhase: currentPhase:', currentPhase?.phase_number, 'type:', currentPhase?.currentPhaseType);
    console.log('üîç navigateToNextPhase: viewedPhase:', viewedPhase?.phase_number, 'type:', viewedPhase?.currentPhaseType);
    console.log('üîç navigateToNextPhase: ALL available phases:', selectedProject?.project_phases?.map(p => ({ id: p.id, phase_number: p.phase_number, title: p.title, has_eval: !!p.evaluation_available_from, has_breathe: !!p.breathe_start_date })));
    
    if (!selectedProject || !selectedProject.project_phases || selectedProject.project_phases.length === 0) {
      console.log('üîç navigateToNextPhase: No project or phases available');
      return;
    }
    
    const sortedPhases = [...selectedProject.project_phases].sort((a, b) => a.phase_number - b.phase_number);
    const phase = viewedPhase || currentPhase;
    const currentPhaseIdx = sortedPhases.findIndex(p => p.id === phase?.id);
    const currentPhaseType = phase?.currentPhaseType || 'work';
    
    console.log('üîç navigateToNextPhase: currentPhaseIdx:', currentPhaseIdx, 'currentPhaseType:', currentPhaseType, 'total phases:', sortedPhases.length);
    
    if (currentPhaseIdx === -1) {
      console.log('üîç navigateToNextPhase: Current phase not found, navigating to first phase');
      // Set to first phase with default 'work' type
      setViewedPhase({ ...sortedPhases[0], currentPhaseType: 'work' });
      return;
    }
    
    const currentPhaseObj = sortedPhases[currentPhaseIdx];
    
    // Navigate forwards within phase types: work -> eval -> breathe -> next work
    if (currentPhaseType === 'work') {
      // Go to evaluation (same phase)
      if (currentPhaseObj.evaluation_available_from) {
        console.log('üîç navigateToNextPhase: Moving from work to evaluation (same phase)');
        setViewedPhase({ ...currentPhaseObj, currentPhaseType: 'evaluation' });
        // Reload evaluation submissions
        if (selectedProject?.group_id) {
          fetchMyEvaluationSubmissions(selectedProject.group_id, currentPhaseObj.id, null);
        }
      } else if (currentPhaseIdx < sortedPhases.length - 1) {
        console.log('üîç navigateToNextPhase: No evaluation, moving to next phase');
        // Set next phase to 'work' type
        setViewedPhase({ ...sortedPhases[currentPhaseIdx + 1], currentPhaseType: 'work' });
      }
    } else if (currentPhaseType === 'evaluation') {
      // Go to breathe (same phase) or next phase
      if (currentPhaseObj.breathe_start_date) {
        console.log('üîç navigateToNextPhase: Moving from evaluation to breathe (same phase)');
        setViewedPhase({ ...currentPhaseObj, currentPhaseType: 'breathe' });
      } else if (currentPhaseIdx < sortedPhases.length - 1) {
        console.log('üîç navigateToNextPhase: No breathe phase, moving to next phase');
        // Set next phase to 'work' type
        setViewedPhase({ ...sortedPhases[currentPhaseIdx + 1], currentPhaseType: 'work' });
      } else {
        console.log('üîç navigateToNextPhase: Already at last phase in evaluation mode');
      }
    } else if (currentPhaseType === 'breathe') {
      // Go to next phase
      if (currentPhaseIdx < sortedPhases.length - 1) {
        console.log('üîç navigateToNextPhase: Moving from breathe to next phase work mode');
        // Explicitly set currentPhaseType to 'work' for the next phase
        setViewedPhase({ ...sortedPhases[currentPhaseIdx + 1], currentPhaseType: 'work' });
      } else {
        console.log('üîç navigateToNextPhase: Already at last phase in breathe mode');
      }
    }
  };

  const resetToCurrentPhase = () => {
    console.log('üîç resetToCurrentPhase called, currentPhase:', currentPhase?.phase_number);
    if (!currentPhase) {
      console.log('‚ö†Ô∏è resetToCurrentPhase: No active phase - cannot reset');
      return;
    }
    setViewedPhase(currentPhase);
  };

  const handleMemberClick = (member) => {
    setSelectedMember(member);
    setShowMemberModal(true);
  };

  // Handle phase click to open modal
  const handlePhaseClick = (phase) => {
    setSelectedPhaseForModal(phase);
    setShowPhaseModal(true);
  };

  const handleTaskClick = (task, project, phase, source = 'todo') => {
    // Close modal first to reset any internal state
    if (showTaskModal) {
      setShowTaskModal(false);
      setSelectedTask(null);
      setSelectedPhase(null);
      setTaskModalSource(null);
      // Use setTimeout to ensure modal closes before reopening with new data
      setTimeout(() => {
        setSelectedTask(task);
        setSelectedPhase(phase);
        setTaskModalSource(source);
        setShowTaskModal(true);
      }, 50);
    } else {
      setSelectedTask(task);
      setSelectedPhase(phase);
      setTaskModalSource(source);
      setShowTaskModal(true);
    }
  };

  const handleRevisionTaskClick = (task, project, phase, submissionId = null) => {
    console.log('Revision task clicked:', task);
    // Close modal first to reset any internal state
    if (showRevisionModal) {
      setShowRevisionModal(false);
      setSelectedRevisionTask(null);
      setSelectedRevisionSubmissionId(null);
      setSelectedPhase(null);
      // Use setTimeout to ensure modal closes before reopening with new data
      setTimeout(() => {
        setSelectedRevisionTask(task);
        setSelectedRevisionSubmissionId(submissionId);
        setSelectedPhase(phase);
        setShowRevisionModal(true);
      }, 50);
    } else {
      setSelectedRevisionTask(task);
      setSelectedRevisionSubmissionId(submissionId);
      setSelectedPhase(phase);
      setShowRevisionModal(true);
    }
  };

  const handleCompletedTaskClick = (task, project, phase) => {
    console.log('Completed task clicked:', task);
    console.log('Task projects data:', task.projects);
    console.log('Task phases data:', task.project_phases);
    
    // Close modal first to reset any internal state
    if (showCompletedModal) {
      setShowCompletedModal(false);
      setSelectedCompletedTask(null);
      setSelectedPhase(null);
      // Use setTimeout to ensure modal closes before reopening with new data
      setTimeout(() => {
        setSelectedCompletedTask(task);
        setSelectedPhase(task.project_phases || phase);
        setShowCompletedModal(true);
      }, 50);
    } else {
      setSelectedCompletedTask(task);
      setSelectedPhase(task.project_phases || phase);
      setShowCompletedModal(true);
    }
  };

  const handleEvaluationClick = (evaluation, project, phase) => {
    // If this is a project evaluation card, open project eval modal instead
    if (evaluation.type === 'project_evaluation') {
      setSelectedProjectEvaluation(evaluation);
      setShowProjectEvalModal(true);
      return;
    }
    
    // If this is a phase evaluation card, use the enriched data from the card itself
    let enrichedEvaluation = evaluation;
    
    if (evaluation.type === 'phase_evaluation') {
      enrichedEvaluation = {
        id: evaluation.id || `phase-eval-${evaluation.phase_id}`,
        title: evaluation.title,
        description: evaluation.description,
        status: evaluation.status,
        type: 'phase_evaluation',
        due_date: evaluation.due_date,
        available_from: evaluation.evaluation_available_from || evaluation.available_from,
        phase_id: evaluation.phase_id,
        group_id: evaluation.group_id || project?.group_id,
        is_custom_evaluation: evaluation.is_custom_evaluation || evaluation.evaluation_form_type === 'custom',
        criteria: evaluation.evaluation_criteria || [],
        total_points: evaluation.evaluation_total_points || 100,
        file_url: evaluation.evaluation_form_file_url,
        file_name: evaluation.evaluation_form_file_name,
        custom_file_url: evaluation.custom_file_url,
        custom_file_name: evaluation.custom_file_name,
        instructions: evaluation.instructions
      };
    }
    
    setSelectedEvaluation(enrichedEvaluation);
    setSelectedPhase(phase);
    setShowEvaluationModal(true);
  };

  const handleTaskTabClick = (taskId) => {
    setActiveTab('project-dashboard');
  };

  const handleFeedbackClick = () => {
    // Navigate to submission page - will be implemented based on your routing
    console.log('Navigate to submission page');
  };

  // Effects
 useEffect(() => {
  loadUserProfile(); // ‚úÖ ADD: Load user profile first
  loadDashboardData();
  // Debug log to see user role
  console.log('üîç Debug - User Role:', userRole);
  console.log('üîç Debug - Group Data:', groupData);
  
  // Call debug endpoint to understand user memberships
  const debugUserGroups = async () => {
    try {
      const response = await fetch('${API_BASE_URL}/api/student/debug/groups', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      if (response.ok) {
        const debugData = await response.json();
        console.log('üîç Debug - User Group Memberships:', debugData);
      }
    } catch (error) {
      console.log('üîç Debug endpoint failed:', error);
    }
  };
  
  debugUserGroups();
}, [courseId]);



  // ‚úÖ CRITICAL FIX: Detect current phase when project changes
  // Added check for isProjectSwitching to prevent phase detection on stale data during project switch
  // Trigger when: project ID changes, switching flag clears, OR when phases become available
  useEffect(() => {
    console.log('üîç [PHASE DETECTION useEffect] Triggered. isProjectSwitching:', isProjectSwitching, 'selectedProject:', selectedProject?.title, selectedProject?.id);
    
    if (selectedProject && selectedProject.project_phases && selectedProject.id && !isProjectSwitching) {
      console.log('üîç [PHASE DETECTION] Running detectCurrentPhase for project:', selectedProject.title, selectedProject.id);
      console.log('üîç [PHASE DETECTION] Phases available:', selectedProject.project_phases.map(p => p.phase_number));
      detectCurrentPhase(selectedProject.project_phases);
    } else if (isProjectSwitching) {
      console.log('‚è∏Ô∏è [PHASE DETECTION] Skipping - project is switching');
    } else {
      console.log('‚ö†Ô∏è [PHASE DETECTION] Skipping - missing data:', {
        hasProject: !!selectedProject,
        hasPhases: !!selectedProject?.project_phases,
        phasesCount: selectedProject?.project_phases?.length,
        hasId: !!selectedProject?.id
      });
    }
  }, [selectedProject?.id, selectedProject?.project_phases?.length, isProjectSwitching]); // Re-run when phases are loaded

  // Initialize viewedPhase when currentPhase changes
  // ‚úÖ CRITICAL FIX: Only update viewedPhase if it doesn't belong to current project
  useEffect(() => {
    console.log('üîç [PHASE INIT useEffect] Triggered. currentPhase:', currentPhase?.phase_number, currentPhase?.title, 'viewedPhase:', viewedPhase?.phase_number, viewedPhase?.title);
    
    if (currentPhase && selectedProject?.project_phases) {
      // Check if currentPhase belongs to the selectedProject
      const currentPhaseIsValid = selectedProject.project_phases.some(p => p.id === currentPhase.id);
      
      console.log('üîç [PHASE INIT] currentPhaseIsValid:', currentPhaseIsValid, 'for project:', selectedProject.title);
      
      if (currentPhaseIsValid) {
        // Check if viewedPhase belongs to a different project than currentPhase
        const isDifferentProject = viewedPhase && 
          !selectedProject.project_phases.some(p => p.id === viewedPhase.id);
        
        console.log('üîç [PHASE INIT] isDifferentProject:', isDifferentProject);
        
        if (!viewedPhase || isDifferentProject) {
          console.log('‚úÖ [PHASE INIT] Setting viewedPhase to currentPhase:', currentPhase.phase_number, currentPhase.title, 'Project:', selectedProject.title);
          console.log('‚úÖ [PHASE INIT] Reason:', !viewedPhase ? 'viewedPhase is null' : 'viewedPhase from different project');
          setViewedPhase(currentPhase);
        } else {
          console.log('‚è≠Ô∏è [PHASE INIT] Skipping - viewedPhase already correct');
        }
      } else {
        console.warn('‚ö†Ô∏è [PHASE INIT] currentPhase does not belong to selectedProject - waiting for correct phase detection');
      }
    } else {
      console.log('‚è∏Ô∏è [PHASE INIT] Skipping - missing data:', {
        hasCurrentPhase: !!currentPhase,
        hasProject: !!selectedProject,
        hasPhases: !!selectedProject?.project_phases
      });
    }
  }, [currentPhase, selectedProject?.id]);
  
  // Debug phase changes
  useEffect(() => {
    console.log('üîç [PHASE DEBUG] currentPhase changed:', currentPhase?.phase_number, currentPhase?.title);
  }, [currentPhase]);
  
  useEffect(() => {
    console.log('üîç [PHASE DEBUG] viewedPhase changed:', viewedPhase?.phase_number, viewedPhase?.title);
  }, [viewedPhase]);
  
  // Reload tasks when phase is navigated
  // ‚úÖ CRITICAL FIX: Don't reload during project switching to prevent race conditions
  useEffect(() => {
    if (selectedProject && viewedPhase && !isProjectSwitching) {
      console.log('üîç [PHASE NAVIGATION] Reloading tasks for phase:', viewedPhase?.phase_number, 'Type:', viewedPhase?.currentPhaseType);
      console.log('üîç [PHASE NAVIGATION] Full viewedPhase object:', viewedPhase);
      // Show loading indicator when navigating phases
      const reloadTasks = async () => {
        await loadTodoData(selectedProject.id, true);
      };
      reloadTasks();
    } else if (isProjectSwitching) {
      console.log('‚è∏Ô∏è [PHASE NAVIGATION] Skipping task reload - project is switching');
    }
  }, [viewedPhase?.id, viewedPhase?.currentPhaseType, selectedProject?.id, isProjectSwitching]);
  
  // Debug modal state changes
  useEffect(() => {
    console.log('üîç [MODAL DEBUG] showTaskModal changed:', showTaskModal);
    if (!showTaskModal) {
      console.log('üîç [MODAL DEBUG] Modal closed - checking phase selector state');
      console.log('üîç [MODAL DEBUG] selectedProject:', selectedProject?.title, selectedProject?.id);
      console.log('üîç [MODAL DEBUG] selectedProject.project_phases:', selectedProject?.project_phases);
      console.log('üîç [MODAL DEBUG] selectedProject.project_phases length:', selectedProject?.project_phases?.length);
      console.log('üîç [MODAL DEBUG] currentPhase:', currentPhase?.phase_number, currentPhase?.id);
      console.log('üîç [MODAL DEBUG] viewedPhase:', viewedPhase?.phase_number, viewedPhase?.id);
      console.log('üîç [MODAL DEBUG] showProjectPhases:', showProjectPhases);
      console.log('üîç [MODAL DEBUG] Phase selector should be clickable:', !!(selectedProject && (viewedPhase || currentPhase)));
      console.log('üîç [MODAL DEBUG] showProjectDropdown:', showProjectDropdown);
      console.log('üîç [MODAL DEBUG] selectedTask:', selectedTask?.title);
      console.log('üîç [MODAL DEBUG] selectedPhase:', selectedPhase?.phase_number);
      console.log('üîç [MODAL DEBUG] showPhaseModal:', showPhaseModal);
    }
  }, [showTaskModal]);
  
  useEffect(() => {
    console.log('üîç [PHASE DEBUG] showProjectPhases changed:', showProjectPhases);
    
    // üî¥ CRITICAL FIX: When timeline modal opens, fetch FRESH project data with evaluation forms
    if (showProjectPhases && selectedProject?.id) {
      console.log('üì° [TIMELINE MODAL] Fetching fresh project data for:', selectedProject.id);
      loadProjectSpecificData(selectedProject.id);
    }
  }, [showProjectPhases]);
  
  useEffect(() => {
    console.log('üîç [PROJECT DROPDOWN DEBUG] showProjectDropdown changed:', showProjectDropdown);
  }, [showProjectDropdown]);
  
  useEffect(() => {
    console.log('üîç [SELECTED PROJECT DEBUG] selectedProject changed:', selectedProject?.title, selectedProject?.id);
    console.log('üîç [SELECTED PROJECT DEBUG] selectedProject.project_phases:', selectedProject?.project_phases?.length);
    console.log('üîç [SELECTED PROJECT DEBUG] selectedProject keys:', selectedProject ? Object.keys(selectedProject) : 'null');
  }, [selectedProject]);

  // Load evaluation data when selectedTodoProject changes
  useEffect(() => {
    if (selectedTodoProject && selectedTodoProject.id) {
      loadEvaluationsData(selectedTodoProject.id);
    } else {
      setEvaluationsData([]);
    }
  }, [selectedTodoProject?.id]);

  // Load submission review data when tab is activated
  useEffect(() => {
    if (activeTab === 'submission-review' && userRole === 'leader') {
      loadSubmissionReviewProjects();
      loadSubmissionReviewData();
    }
  }, [activeTab, userRole]);

  // ‚úÖ NEW: Load all active projects tasks and feedbacks for Course Overview
  useEffect(() => {
    if (activeTab === 'course-overview' && projects.length > 0) {
      console.log('üîç [Course Overview] Tab activated - loading all active projects data');
      loadAllActiveProjectsTasksForOverview();
      loadAllActiveProjectsFeedbacksForOverview();
    }
  }, [activeTab, projects.length]);

  // Auto-refresh data when switching to project dashboard
  // ‚úÖ FIXED: Use ref to track if we've already loaded this project to prevent infinite loops
  const lastLoadedProjectRef = useRef(null);
  const lastLoadedTabRef = useRef(null);
  
  useEffect(() => {
    if (activeTab === 'project-dashboard' && selectedProject?.id) {
      // Only refresh if we actually switched tabs or projects
      const tabChanged = lastLoadedTabRef.current !== activeTab;
      const projectChanged = lastLoadedProjectRef.current !== selectedProject.id;
      
      if (tabChanged || projectChanged) {
        console.log('üîÑ Auto-refreshing Project Dashboard on tab switch', {
          tabChanged,
          projectChanged,
          projectId: selectedProject.id
        });
        
        lastLoadedTabRef.current = activeTab;
        lastLoadedProjectRef.current = selectedProject.id;
        
        // Use a small delay to ensure state is settled
        const timeoutId = setTimeout(() => {
          refreshData('tab-switch');
        }, 100);
        return () => clearTimeout(timeoutId);
      }
    }
  }, [activeTab, selectedProject?.id]);

  // Auto-refresh data when navigating through phases in project dashboard
  // ‚úÖ FIXED: Only refresh on actual phase navigation, not on every phase state change
  const lastViewedPhaseRef = useRef(null);
  
  useEffect(() => {
    if (activeTab === 'project-dashboard' && selectedProject?.id && viewedPhase?.id) {
      // Only refresh if the viewed phase actually changed
      const phaseKey = `${viewedPhase.id}-${viewedPhase.currentPhaseType || 'work'}`;
      const previousPhaseKey = lastViewedPhaseRef.current;
      
      if (previousPhaseKey !== phaseKey) {
        console.log('üîÑ Auto-refreshing Project Dashboard on phase navigation', {
          from: previousPhaseKey,
          to: phaseKey
        });
        
        lastViewedPhaseRef.current = phaseKey;
        
        // Use a small delay to ensure state is settled
        const timeoutId = setTimeout(() => {
          refreshData('phase-navigation');
        }, 100);
        return () => clearTimeout(timeoutId);
      }
    }
  }, [viewedPhase?.id, viewedPhase?.currentPhaseType, activeTab, selectedProject?.id]);

  // Note: my-todo tab has been removed

  // Periodic auto-refresh DISABLED to prevent interference with file submissions
  // useEffect(() => {
  //   const getRefreshInterval = () => {
  //     if (activeTab === 'project-dashboard') return 15000; // 15 seconds for project dashboard
  //     return 60000; // 1 minute for other tabs
  //   };

  //   const refreshInterval = setInterval(() => {
  //     refreshData('periodic');
  //   }, getRefreshInterval());

  //   return () => clearInterval(refreshInterval);
  // }, [activeTab, selectedProject?.id, selectedTodoProject?.id]);

  // Auto-refresh when window regains focus DISABLED to prevent interference
  // useEffect(() => {
  //   const handleFocus = () => {
  //     refreshData('window-focus');
  //   };

  //   window.addEventListener('focus', handleFocus);
  //   return () => window.removeEventListener('focus', handleFocus);
  // }, [activeTab, selectedProject?.id, selectedTodoProject?.id]);

  // Click outside handler for submission review dropdowns
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Don't interfere with phase selector or navigation buttons
      if (event.target.closest('.phase-circle') || 
          event.target.closest('.phase-nav-button') || 
          event.target.closest('.phase-navigation-row') ||
          event.target.closest('.reset-to-current-phase-btn')) {
        return;
      }
      
      if (showSubmissionProjectDropdown && !event.target.closest('.project-selector')) {
        setShowSubmissionProjectDropdown(false);
      }
      if (showSubmissionMemberDropdown && !event.target.closest('.member-selector')) {
        setShowSubmissionMemberDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showSubmissionProjectDropdown, showSubmissionMemberDropdown]);

  // Render functions
  const renderCourseOverview = () => {
    // Ensure projects is an array (defensive coding)
    const safeProjects = Array.isArray(projects) ? projects : [];
    const safeAnnouncements = Array.isArray(announcements) ? announcements : [];
    
    // Get active projects (where end_date hasn't passed)
    // If no projects loaded yet, don't filter by project (show all tasks)
    const activeProjectsList = safeProjects.filter(p => {
      if (!p.end_date) return true; // If no end_date, assume active
      const endDate = new Date(p.end_date);
      return endDate > new Date();
    });
    
    const activeProjectIds = safeProjects.length > 0 ? new Set(activeProjectsList.map(p => p.id)) : null;
    
    // Calculate student-specific stats
    const totalProjects = safeProjects.length;
    const activeProjects = activeProjectsList.length;
    const totalAnnouncements = safeAnnouncements.length;
    const unreadAnnouncements = safeAnnouncements.filter(a => !a.is_read).length;
    
    // Calculate task stats - only from active projects and for current user
    // If projects haven't loaded yet (activeProjectIds is null), show all tasks
    const userTasksFromActiveProjects = Array.isArray(todoActivities) ?
      todoActivities.filter(activity => {
        // If we don't have project data yet, show all tasks
        if (!activeProjectIds) return true;
        // Only include tasks from active projects
        return activeProjectIds.has(activity.project_id);
      }) : [];
    
    const pendingTasks = userTasksFromActiveProjects
      .filter(activity => {
        const status = getActivityStatus(activity);
        return status === 'active' || status === 'revise' || status === 'pending' || status === 'late';
      }).length;

    const completedTasks = userTasksFromActiveProjects
      .filter(activity => {
        const status = getActivityStatus(activity);
        return status === 'completed';
      }).length;

    const missedTasks = userTasksFromActiveProjects
      .filter(activity => {
        const status = getActivityStatus(activity);
        return status === 'missed' || status === 'rejected';
      }).length;

    // Calculate completion rate
    const totalTasks = userTasksFromActiveProjects.length;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // Get upcoming tasks from ALL active projects (not dependent on selectedProject)
    // Apply filter based on overviewTasksFilter state
    const upcomingTasks = userTasksFromActiveProjects
      .filter(activity => {
        const status = getActivityStatus(activity);
        
        // Apply filter based on selected option
        if (overviewTasksFilter === 'all') {
          // Show all tasks except rejected (include completed, pending, missed, late, revision, active)
          return status !== 'rejected';
        } else if (overviewTasksFilter === 'completed') {
          return status === 'completed';
        } else if (overviewTasksFilter === 'pending') {
          return status === 'pending' || status === 'active';
        } else if (overviewTasksFilter === 'missed') {
          return status === 'missed';
        } else if (overviewTasksFilter === 'late') {
          return status === 'late';
        } else if (overviewTasksFilter === 'revision') {
          return status === 'revise';
        }
        return true;
      })
      .sort((a, b) => new Date(a.due_date) - new Date(b.due_date))
      .slice(0, 9);

    // Get recent announcements
    const recentAnnouncements = safeAnnouncements.slice(0, 5);

    // DEBUG: Log task data for Course Overview
    console.log('üìä [Course Overview] Task Stats:', {
      totalTodoActivities: Array.isArray(todoActivities) ? todoActivities.length : 0,
      safeProjectsCount: safeProjects.length,
      activeProjectsCount: activeProjects,
      userTasksFromActiveProjects: userTasksFromActiveProjects.length,
      userTasksStatuses: userTasksFromActiveProjects.map(t => ({ title: t.title, status: t.status, activity_status: getActivityStatus(t) })),
      upcomingTasksCount: upcomingTasks.length,
      upcomingTasks: upcomingTasks.map(t => ({ title: t.title, project_id: t.project_id, due_date: t.due_date }))
    });

    return (
      <div className="course-overview-redesigned">
          {/* Welcome Message */}
          <div className="welcome-message-center">
            <h1 className="welcome-title-landing" style={{ color: 'white !important' }}>
              Welcome back, <span style={{ color: 'white !important'}}>
                {userProfile?.first_name || localStorage.getItem('userFirstName') || 'Student'}
              </span>!
            </h1>
            <p className="welcome-subtitle-landing" style={{ color: 'white !important', textShadow: '1px 1px 3px rgba(0,0,0,0.5)' }}>Here's what's happening with your course today</p>
          </div>





        {/* Quick Action Buttons */}
        <div className="quick-actions-section" style={{ 
          display: 'flex', 
          gap: '12px', 
          flexWrap: 'wrap', 
          marginBottom: '2rem',
          justifyContent: 'center',
          alignItems: 'center'
        }}>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => {
              const wasOnProjectDashboard = activeTab === 'project-dashboard';
              setActiveTab('project-dashboard');
              // Refresh data when navigating to Project Dashboard (only if not already on it)
              // The useEffect will handle refresh when switching tabs, so we only need to refresh
              // if we're already on project-dashboard and clicking again
              if (wasOnProjectDashboard && selectedProject) {
                console.log('üîÑ Manual refresh of Project Dashboard');
                setTimeout(() => {
                  refreshData('manual-refresh');
                }, 100);
              }
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaTasks />
            <span>View Tasks</span>
          </button>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => setActiveTab('my-group')}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaUsers />
            <span>View Group</span>
          </button>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => setActiveTab('evaluations')}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaClipboardList />
            <span>View Evaluation</span>
          </button>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => setActiveTab('my-grades')}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaGraduationCap />
            <span>View Grade</span>
          </button>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => setActiveTab('notifications')}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaBell />
            <span>View Notifications</span>
          </button>
          <button 
            style={{
              padding: '10px 20px',
              background: 'rgb(135, 35, 65)',
              backdropFilter: 'blur(10px) saturate(120%)',
              WebkitBackdropFilter: 'blur(10px) saturate(120%)',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '14px',
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.3s ease',
              boxShadow: 'rgba(0, 0, 0, 0.1) 0px 4px 12px',
              transform: 'translateY(0px)',
              cursor: 'pointer'
            }}
            onClick={() => setActiveTab('announcements')}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 6px 16px';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0px)';
              e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 4px 12px';
            }}
          >
            <FaBullhorn />
            <span>View Announcements</span>
          </button>
        </div>

        {/* Horizontal Line */}
        <div className="horizontal-divider"></div>

        {/* CSS Grid Layout - 5 Divs */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(5, 1fr)',
          gridTemplateRows: 'repeat(9, 1fr)',
          gap: '20px',
          minHeight: '700px'
        }}>
          {/* Div 1 - Tasks (grid-column: span 2, grid-row: span 2) */}
          <div style={{ 
            position: 'relative', 
            background: 'rgba(9, 18, 44, 0.15)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            overflow: 'hidden',
            gridColumn: 'span 2',
            gridRow: 'span 2',
            gridRowStart: 'span 4',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            <div style={{ padding: '1.5rem 1.5rem 1rem 1.5rem', borderBottom: '2px solid #872341', display: 'flex', justifyContent: 'space-between', alignItems: 'center', backgroundColor: '#ffffff' }}>
              <h3 style={{ color: '#872341', fontWeight: '700', margin: 0, fontSize: '1.1rem' }}>Tasks</h3>
              <div style={{ display: 'flex', gap: '0.5rem' }}>
                {/* Filter Dropdown */}
                <div 
                  style={{
                    position: 'relative',
                    backgroundColor: '#f5f5f5',
                    border: '2px solid #872341',
                    borderRadius: '8px',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.25rem',
                    fontSize: '0.8rem',
                    color: '#872341',
                    fontWeight: '600',
                    minWidth: '80px',
                    boxShadow: 'none',
                    transition: 'all 0.2s ease'
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    setShowOverviewTasksFilterDropdown(!showOverviewTasksFilterDropdown);
                    setShowOverviewTasksSortDropdown(false);
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#872341';
                    e.currentTarget.style.color = '#ffffff';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#f5f5f5';
                    e.currentTarget.style.color = '#872341';
                  }}
                >
                  <FaFilter style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                  Filter
                  <FaChevronDown style={{
                    fontSize: '0.6rem',
                    transform: showOverviewTasksFilterDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                    transition: 'transform 0.2s ease',
                    pointerEvents: 'none'
                  }} />
                  {showOverviewTasksFilterDropdown && (
                    <div style={{
                      position: 'absolute',
                      top: '100%',
                      right: 0,
                      backgroundColor: '#ffffff',
                      border: '1px solid #e0e0e0',
                      borderRadius: '8px',
                      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                      zIndex: 1002,
                      minWidth: '150px',
                      marginTop: '0.25rem'
                    }}>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: overviewTasksFilter === 'all' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('all');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        All
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: overviewTasksFilter === 'completed' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('completed');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        Completed
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: overviewTasksFilter === 'pending' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('pending');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        Pending
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: overviewTasksFilter === 'missed' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('missed');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        Missed
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: overviewTasksFilter === 'late' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('late');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        Late
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        backgroundColor: overviewTasksFilter === 'revision' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setOverviewTasksFilter('revision');
                        setShowOverviewTasksFilterDropdown(false);
                      }}>
                        Revision
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Sort Dropdown */}
                <div 
                  style={{
                    position: 'relative',
                    backgroundColor: '#f5f5f5',
                    border: '2px solid #872341',
                    borderRadius: '8px',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.25rem',
                    fontSize: '0.8rem',
                    color: '#872341',
                    fontWeight: '600',
                    minWidth: '80px',
                    boxShadow: 'none',
                    transition: 'all 0.2s ease'
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    setShowOverviewTasksSortDropdown(!showOverviewTasksSortDropdown);
                    setShowOverviewTasksFilterDropdown(false);
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#872341';
                    e.currentTarget.style.color = '#ffffff';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#f5f5f5';
                    e.currentTarget.style.color = '#872341';
                  }}
                >
                  <FaSort style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                  Sort
                  <FaChevronDown style={{
                    fontSize: '0.6rem',
                    transform: showOverviewTasksSortDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                    transition: 'transform 0.2s ease',
                    pointerEvents: 'none'
                  }} />
                  {showOverviewTasksSortDropdown && (
                    <div style={{
                      position: 'absolute',
                      top: '100%',
                      right: 0,
                      backgroundColor: '#ffffff',
                      border: '1px solid #e0e0e0',
                      borderRadius: '8px',
                      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                      zIndex: 1002,
                      minWidth: '150px',
                      marginTop: '0.25rem'
                    }}>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        borderBottom: '1px solid #f0f0f0',
                        backgroundColor: sortBy === 'dueDate' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setSortBy('dueDate');
                        setShowOverviewTasksSortDropdown(false);
                      }}>
                        Due Date
                      </div>
                      <div style={{
                        padding: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.8rem',
                        color: '#545555',
                        backgroundColor: sortBy === 'status' ? '#f8f9fa' : 'transparent'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setSortBy('status');
                        setShowOverviewTasksSortDropdown(false);
                      }}>
                        Status
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            <div style={{ padding: '1rem', flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: '0.5rem', maxHeight: 'calc(3 * 80px)' }}>
              {overviewTasksLoading ? (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: '1rem' }}>
                  <div style={{
                    width: '36px',
                    height: '36px',
                    border: '3px solid rgba(135, 35, 65, 0.2)',
                    borderTop: '3px solid #872341',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }}></div>
                  <p style={{ color: 'white', opacity: 0.6, fontSize: '0.85rem', margin: 0 }}>Loading tasks...</p>
                </div>
              ) : upcomingTasks.length > 0 ? (
                upcomingTasks
                  .sort((a, b) => new Date(a.due_date) - new Date(b.due_date))
                  .slice(0, 9)
                  .map((task, idx) => {
                    // Determine task status based on hierarchy: Not Submitted > Needs Revision > Pending > Completed
                    const getTaskStatus = () => {
                      const submissions = task.task_submissions || [];
                      const hasSubmission = submissions.length > 0;
                      
                      if (!hasSubmission) return { label: 'Not Submitted', priority: 1, color: '#FFFFFF', bgColor: '#EF4444' };
                      
                      const revisionCount = task.revision_submissions?.length || 0;
                      if (revisionCount > 0 && task.status === 'to_revise') {
                        return { label: 'Needs Revision', priority: 2, color: '#FFFFFF', bgColor: '#F59E0B' };
                      }
                      
                      if (task.status === 'pending' || task.status === 'active') {
                        return { label: 'Pending', priority: 3, color: '#FFFFFF', bgColor: '#3B82F6' };
                      }
                      
                      if (task.status === 'completed') {
                        return { label: 'Completed', priority: 4, color: '#FFFFFF', bgColor: '#10B981' };
                      }
                      
                      return { label: 'Pending', priority: 3, color: '#FFFFFF', bgColor: '#3B82F6' };
                    };

                    const taskStatus = getTaskStatus();
                    const daysUntilDue = Math.ceil((new Date(task.due_date) - new Date()) / (1000 * 60 * 60 * 24));
                    // Completed tasks should never show as overdue
                    const isOverdue = task.status !== 'completed' && daysUntilDue < 0;

                    const getStatusIcon = () => {
                      switch (taskStatus.priority) {
                        case 1: return <FaTimes style={{ fontSize: '0.8rem' }} />;
                        case 2: return <FaExclamationTriangle style={{ fontSize: '0.8rem' }} />;
                        case 3: return <FaClock style={{ fontSize: '0.8rem' }} />;
                        case 4: return <FaCheck style={{ fontSize: '0.8rem' }} />;
                        default: return <FaClock style={{ fontSize: '0.8rem' }} />;
                      }
                    };

                    return (
                      <div 
                        key={idx} 
                        onClick={() => {
                          // Navigate to Project Dashboard
                          setActiveTab('project-dashboard');
                          
                          // Set the project with all necessary info
                          const projectToSelect = {
                            id: task.project_id,
                            name: task.project_name || 'Project',
                            course_id: task.course_id,
                            title: task.project_name
                          };
                          
                          setSelectedProject(projectToSelect);
                          
                          // Set the phase if available
                          if (task.phase_info?.id) {
                            setCurrentPhase({
                              id: task.phase_info.id,
                              phase_number: task.phase_info.phase_number,
                              title: task.phase_info.title,
                              currentPhaseType: 'work'
                            });
                            setViewedPhase({
                              id: task.phase_info.id,
                              phase_number: task.phase_info.phase_number,
                              title: task.phase_info.title,
                              currentPhaseType: 'work'
                            });
                          }
                        }}
                        style={{ 
                          display: 'flex', 
                          flexDirection: 'column',
                          gap: '0.5rem', 
                          padding: '1rem 1.5rem',
                          background: 'rgb(255, 255, 255)',
                          borderRadius: '0px',
                          border: 'none',
                          borderBottom: '1px solid rgb(95, 95, 95)',
                          borderLeft: '4px solid rgb(190, 49, 68)',
                          cursor: 'pointer',
                          transition: '0.3s',
                          flexShrink: 0,
                          minHeight: '70px'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = '#F5F5F5';
                          e.currentTarget.style.borderLeftColor = '#872341';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = 'rgb(255, 255, 255)';
                          e.currentTarget.style.borderLeftColor = 'rgb(190, 49, 68)';
                        }}
                      >
                        {/* Header: Title and Status Badge */}
                        <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: '0.5rem', marginBottom: '0.5rem' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', flex: 1, minWidth: 0 }}>
                            <FaTasks style={{ color: '#872341', fontSize: '0.9rem', minWidth: '0.9rem' }} />
                            <p style={{ color: '#09122C', fontWeight: '600', margin: 0, flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', fontSize: '0.9rem' }}>
                              {task.title}
                            </p>
                          </div>
                          {/* Status Badge - Top Right */}
                          <span style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.3rem',
                            background: taskStatus.bgColor,
                            color: taskStatus.color,
                            padding: '0.35rem 0.6rem',
                            borderRadius: '4px',
                            fontSize: '0.7rem',
                            fontWeight: '600',
                            whiteSpace: 'nowrap',
                            flexShrink: 0
                          }}>
                            {getStatusIcon()}
                            {taskStatus.label}
                          </span>
                        </div>

                        {/* Due Date - Below Task Name */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', fontSize: '0.75rem', color: '#6B7280', fontWeight: '500', marginBottom: '0.5rem' }}>
                          <FaCalendarAlt style={{ fontSize: '0.65rem', flexShrink: 0 }} />
                          <span>
                            {taskStatus.priority === 4 
                              ? `Completed: ${new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ${new Date(task.due_date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`
                              : `Due: ${new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ${new Date(task.due_date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`
                            }
                          </span>
                        </div>

                        {/* Metadata Pills: Project and Phase */}
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', fontSize: '0.75rem' }}>
                          {task.project_name && (
                            <span style={{ 
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.3rem',
                              background: '#60A5FA', 
                              color: '#FFFFFF',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '4px',
                              whiteSpace: 'nowrap'
                            }}>
                              <FaProjectDiagram style={{ fontSize: '0.65rem' }} />
                              {task.project_name}
                            </span>
                          )}
                          {task.phase_info?.title && (
                            <span style={{ 
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.3rem',
                              background: '#F59E0B', 
                              color: '#FFFFFF',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '4px',
                              whiteSpace: 'nowrap'
                            }}>
                              <FaClipboardList style={{ fontSize: '0.65rem' }} />
                              {task.phase_info.title}
                            </span>
                          )}
                        </div>
                      </div>
                    );
                  })
              ) : (
                <p style={{ color: 'rgba(255, 255, 255, 0.7)', textAlign: 'center', padding: '2rem' }}>No pending tasks</p>
              )}
            </div>
          </div>

          {/* Div 2 - Notifications (grid-column: span 3, grid-row: span 2, grid-column-start: 3) */}
          <div style={{ 
            position: 'relative', 
            background: 'rgba(9, 18, 44, 0.15)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            overflow: 'hidden',
            gridColumn: 'span 3',
            gridRow: 'span 2',
            gridColumnStart: 'span 3',
            gridRowStart: 'span 4',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            <div style={{ padding: '1.5rem 1.5rem 1rem 1.5rem', borderBottom: '2px solid #872341', backgroundColor: '#ffffff' }}>
              <h3 style={{ color: '#872341', fontWeight: '700', margin: 0, fontSize: '1.1rem' }}>Notifications</h3>
            </div>
            <div style={{ padding: '1rem', flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: '0.5rem', maxHeight: 'calc(3 * 80px)' }}>
              {notifications.length > 0 ? (
                notifications.slice(0, 9).map((notif, idx) => (
                  <div 
                    key={idx} 
                    onClick={() => {
                      // Navigate to Notifications tab
                      setActiveTab('notifications');
                      // Expand the specific notification
                      setExpandedNotification(notif.id || idx);
                    }}
                    style={{ 
                      display: 'flex', 
                      alignItems: 'flex-start', 
                      gap: '0.75rem', 
                      padding: '1rem 1.5rem',
                      background: 'rgb(255, 255, 255)',
                      borderRadius: '0px',
                      border: 'none',
                      borderBottom: '1px solid rgb(95, 95, 95)',
                      borderLeft: '4px solid rgb(190, 49, 68)',
                      opacity: notif.is_read ? 0.7 : 1,
                      flexShrink: 0,
                      minHeight: '60px',
                      cursor: 'pointer',
                      transition: '0.3s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#F5F5F5';
                      e.currentTarget.style.borderLeftColor = '#872341';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                      e.currentTarget.style.borderLeftColor = 'rgb(190, 49, 68)';
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      width: '28px',
                      height: '28px',
                      minWidth: '28px',
                      borderRadius: '6px',
                      background: notif.type === 'overdue' ? '#EF4444' : 
                                 notif.type === 'due_soon' ? '#F59E0B' :
                                 '#3B82F6',
                      color: '#FFFFFF',
                      fontSize: '1rem'
                    }}>
                      {notif.type === 'overdue' ? <FaClock /> : 
                       notif.type === 'due_soon' ? <FaClock /> :
                       notif.type === 'feedback' ? <FaCommentAlt /> : <FaBullhorn />}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p style={{ color: '#09122C', fontWeight: '600', margin: 0, marginBottom: '0.25rem', fontSize: '0.9rem' }}>{notif.title || notif.type}</p>
                      <p style={{ color: '#09122C', opacity: 0.7, fontSize: '0.75rem', margin: 0, wordBreak: 'break-word' }}>{notif.message || notif.content}</p>
                      {notif.date && (
                        <span style={{ color: '#09122C', opacity: 0.6, fontSize: '0.7rem', marginTop: '0.25rem', display: 'inline-block' }}>
                          {new Date(notif.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                        </span>
                      )}
                    </div>
                  </div>
                ))
              ) : (
                <p style={{ color: 'rgba(255, 255, 255, 0.7)', textAlign: 'center', padding: '1rem' }}>No new notifications</p>
              )}
            </div>
          </div>

          {/* Div 3 - Announcements (grid-column: span 3, grid-row: span 3, grid-column-start: 3, grid-row-start: 3) */}
          <div style={{ 
            position: 'relative', 
            background: 'rgba(9, 18, 44, 0.15)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            overflow: 'hidden',
            gridColumn: 'span 3',
            gridRow: 'span 3',
            gridColumnStart: 'span 3',
            gridRowStart: 'span 4',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            <div style={{ padding: '1.5rem 1.5rem 1rem 1.5rem', borderBottom: '2px solid #872341', backgroundColor: '#ffffff', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h3 style={{ color: '#872341', fontWeight: '700', margin: 0, fontSize: '1.1rem' }}>Announcements</h3>
              {unreadAnnouncements > 0 && (
                <span style={{ color: '#09122C', fontWeight: '600', fontSize: '0.85rem', background: 'rgb(255, 255, 255)', padding: '0.25rem 0.5rem', borderRadius: '12px' }}>{unreadAnnouncements} new</span>
              )}
            </div>
            <div style={{ padding: '1rem', flex: 1, overflow: 'auto' }}>
              {announcementsLoading ? (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: '1rem' }}>
                  <div style={{
                    width: '36px',
                    height: '36px',
                    border: '3px solid rgba(135, 35, 65, 0.2)',
                    borderTop: '3px solid #872341',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }}></div>
                  <p style={{ color: '#09122C', opacity: 0.6, fontSize: '0.85rem', margin: 0 }}>Loading announcements...</p>
                </div>
              ) : recentAnnouncements.length > 0 ? (
                recentAnnouncements.map((announcement, idx) => (
                  <div key={idx} style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '0.75rem', 
                    padding: '1rem 1.5rem',
                    marginBottom: '0px',
                    background: 'rgb(255, 255, 255)',
                    borderRadius: '0px',
                    border: 'none',
                    borderBottom: '1px solid rgb(95, 95, 95)',
                    borderLeft: '4px solid rgb(190, 49, 68)',
                    transition: '0.3s',
                    cursor: 'pointer'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#E0E0E0';
                    e.currentTarget.style.borderLeftColor = '#872341';
                    e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                    e.currentTarget.style.borderLeftColor = 'rgb(190, 49, 68)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                  >
                    <FaBullhorn style={{ color: '#872341', fontSize: '1.2rem', minWidth: '1.2rem' }} />
                    <div style={{ flex: 1 }}>
                      <p style={{ color: '#09122C', fontWeight: '600', margin: 0, marginBottom: '0.25rem' }}>{announcement.title}</p>
                      <span style={{ color: '#09122C', opacity: 0.7, fontSize: '0.85rem' }}>
                        {new Date(announcement.created_at).toLocaleDateString('en-US', {
                          month: 'short',
                          day: 'numeric'
                        })}
                      </span>
                    </div>
                    <button 
                      style={{
                        background: 'rgba(135, 35, 65, 0.3)',
                        border: '1px solid #872341',
                        borderRadius: '6px',
                        padding: '0.5rem',
                        color: '#872341',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                      onClick={() => setActiveTab('announcements')}
                      title="View announcement"
                    >
                      <FaEye />
                    </button>
                  </div>
                ))
              ) : (
                <p style={{ color: 'rgba(255, 255, 255, 0.7)', textAlign: 'center', padding: '1rem' }}>No announcements yet</p>
              )}
            </div>
          </div>

          {/* Div 4 - Recent Feedbacks (grid-column: span 2, grid-row: span 3, grid-row-start: 3, grid-column-start: 1) */}
          <div style={{ 
            position: 'relative', 
            background: 'rgba(9, 18, 44, 0.15)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.5)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            overflow: 'hidden',
            gridColumn: 'span 2',
            gridRow: 'span 4',
            gridRowStart: 'span 4',
            gridColumnStart: 'span 2',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            <div style={{ padding: '1.5rem 1.5rem 1rem 1.5rem', borderBottom: '2px solid #872341', backgroundColor: '#ffffff' }}>
              <h3 style={{ color: '#872341', fontWeight: '700', margin: 0, fontSize: '1.1rem' }}>Recent Feedbacks</h3>
            </div>
            <div style={{ padding: '1rem', flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: '0.5rem', maxHeight: 'calc(3 * 80px)' }}>
              {feedbacksLoading ? (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: '1rem' }}>
                  <div style={{
                    width: '36px',
                    height: '36px',
                    border: '3px solid rgba(135, 35, 65, 0.2)',
                    borderTop: '3px solid #872341',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }}></div>
                  <p style={{ color: 'white', opacity: 0.6, fontSize: '0.85rem', margin: 0 }}>Loading feedbacks...</p>
                </div>
              ) : recentFeedbacks.length > 0 ? (
                recentFeedbacks.slice(0, 9).map((feedback, idx) => (
                  <div 
                    key={idx} 
                    onClick={() => handleRecentFeedbackClick(feedback)}
                    style={{ 
                      display: 'flex', 
                      flexDirection: 'column',
                      gap: '0.5rem', 
                      padding: '1rem 1.5rem',
                      background: 'rgb(255, 255, 255)',
                      borderRadius: '0px',
                      border: 'none',
                      borderBottom: '1px solid rgb(95, 95, 95)',
                      borderLeft: '4px solid rgb(190, 49, 68)',
                      cursor: 'pointer',
                      transition: '0.3s',
                      flexShrink: 0,
                      minHeight: '60px'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#F5F5F5';
                      e.currentTarget.style.borderLeftColor = '#872341';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = 'rgb(255, 255, 255)';
                      e.currentTarget.style.borderLeftColor = 'rgb(190, 49, 68)';
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '0.5rem' }}>
                      <div style={{ flex: 1, minWidth: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        <FaCommentAlt style={{ color: '#872341', fontSize: '0.9rem', minWidth: '0.9rem' }} />
                        <p style={{ color: '#09122C', fontWeight: '600', margin: 0, fontSize: '0.85rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {feedback.task_title || 'Unknown Task'}
                        </p>
                      </div>
                      <span style={{
                        background: 'rgba(168, 85, 247, 0.3)',
                        color: '#09122C',
                        padding: '0.25rem 0.5rem',
                        borderRadius: '4px',
                        fontSize: '0.65rem',
                        fontWeight: '600',
                        whiteSpace: 'nowrap',
                        flexShrink: 0
                      }}>
                        {feedback.feedback_by_name ? feedback.feedback_by_name.split(' ')[0] : 'Prof'}
                      </span>
                    </div>
                    <p style={{
                      color: '#09122C',
                      opacity: 0.7,
                      fontSize: '0.75rem',
                      margin: 0,
                      lineHeight: '1.3',
                      maxHeight: '2.6rem',
                      overflow: 'hidden',
                      display: '-webkit-box',
                      WebkitLineClamp: 2,
                      WebkitBoxOrient: 'vertical'
                    }}>
                      {feedback.feedback_text || 'No feedback text'}
                    </p>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '0.5rem' }}>
                      <span style={{ color: '#09122C', opacity: 0.6, fontSize: '0.7rem' }}>
                        {new Date(feedback.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                      </span>
                      {feedback.feedback_type && (
                        <span style={{
                          background: feedback.feedback_type === 'revision' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(16, 185, 129, 0.2)',
                          color: '#09122C',
                          padding: '0.2rem 0.4rem',
                          borderRadius: '3px',
                          fontSize: '0.65rem',
                          fontWeight: '600'
                        }}>
                          {feedback.feedback_type === 'revision' ? 'Revision' : 'Original'}
                        </span>
                      )}
                    </div>
                  </div>
                ))
              ) : (
                <p style={{ color: 'rgba(255, 255, 255, 0.7)', textAlign: 'center', padding: '2rem' }}>No recent feedbacks</p>
              )}
            </div>
          </div>

        </div>

        {/* Course Information Section */}
        
        {/* Course & Group Information Row */}

      </div>
    );
  };

  // Update the renderProjectDashboard function
  const renderProjectDashboard = () => {
    return (
      <div className="project-dashboard-revamped">
        {/* Show loading indicator instead of columns when loading */}
        {todoLoading ? (
          <div style={{
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            minHeight: '500px',
            width: '100%'
          }}>
            <div style={{textAlign: 'center'}}>
              <div style={{
                width: '40px',
                height: '40px',
                border: '3px solid #e0e0e0',
                borderTop: '3px solid #34656D',
                borderRadius: '50%',
                margin: '0 auto 1rem',
                animation: 'spin 1s linear infinite'
              }}></div>
              <div style={{
                fontSize: '1rem',
                color: '#718096',
                fontWeight: '500'
              }}>Loading tasks...</div>
            </div>
          </div>
        ) : (
          /* 5 Columns Layout - Remade from Ground Up */
          <div className="project-dashboard-columns-container-ultra-unique-2024">
          
          {/* Column 1 - To-Do */}
          <div className="my-group-card-with-crosshair project-dashboard-column-left-1-ultra-unique-2024" style={{padding: 0, display: 'flex', flexDirection: 'column', minHeight: '440px', maxHeight: '500px', flex: 1, background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0', overflow: 'hidden'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Header */}
            <div style={{
              padding: '1.5rem 1.5rem 1rem 1.5rem',
              borderRadius: '0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'relative',
              zIndex: 10,
              backgroundColor: '#ffffff',
              borderBottom: '2px solid #872341'
            }}>
              <h2 style={{fontWeight: '900', margin: 0, fontSize: '1.4rem', color: '#872341', textShadow: 'none', letterSpacing: '0.5px'}}>To-Do</h2>
              <div 
                className="todo-sort-dropdown-container"
                style={{
                  position: 'relative',
                  backgroundColor: '#f5f5f5',
                  border: '2px solid #872341',
                  borderRadius: '8px',
                  padding: '0.5rem 0.75rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.25rem',
                  fontSize: '0.8rem',
                  color: '#872341',
                  fontWeight: '600',
                  minWidth: '80px',
                  boxShadow: 'none',
                  transition: '0.2s',
                  zIndex: 11
                }}
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('Todo sort area clicked');
                  setShowTodoSortDropdown(!showTodoSortDropdown);
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#e8e8e8';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F7F7F7';
                }}
              >
                <FaSort style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                Sort
                <FaChevronDown style={{
                  fontSize: '0.6rem',
                  transform: showTodoSortDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                  transition: 'transform 0.2s ease',
                  pointerEvents: 'none'
                }} />
                {/* Sort Dropdown */}
                {showTodoSortDropdown && (
                  <div style={{
                    position: 'absolute',
                    top: '100%',
                    right: 0,
                    backgroundColor: '#ffffff',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    zIndex: 1002,
                    minWidth: '150px',
                    marginTop: '0.25rem'
                  }}>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'dueDate' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('dueDate');
                      setShowTodoSortDropdown(false);
                    }}>
                      Due Date
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'dateAssigned' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('dateAssigned');
                      setShowTodoSortDropdown(false);
                    }}>
                      Date Assigned
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'lastUpdated' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('lastUpdated');
                      setShowTodoSortDropdown(false);
                    }}>
                      Last Updated
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      backgroundColor: sortBy === 'completion' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('completion');
                      setShowTodoSortDropdown(false);
                    }}>
                      Completion %
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* Content */}
            <div style={{
              borderRadius: '0 0 20px 20px',
              padding: '1rem',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-start',
              minHeight: 'auto'
            }}>
              
              <div style={{flex: 1, marginBottom: '1rem'}}>
                {/* Render actual tasks */}
                {getFilteredActivities().length === 0 ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    alignItems: 'center',
                    padding: '2rem',
                    color: '#718096',
                    textAlign: 'center',
                    height: '100%'
                  }}>
                    <FaTasks style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                    <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No tasks assigned</div>
                    <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                      {selectedTodoProject ? 
                        `No tasks for ${selectedTodoProject.title}` : 
                        'Select a project to view tasks'
                      }
                    </div>
                  </div>
                ) : (
                  getFilteredActivities().slice(0, 5).map((task, index) => {
                    const status = getActivityStatus(task);
                    const statusColor = status === 'active' ? '#34656D' : 
                                      status === 'revise' ? '#f59e0b' : 
                                      status === 'completed' ? '#10b981' : 
                                      status === 'late' ? '#d97706' :
                                      status === 'missed' ? '#dc2626' : '#6b7280';
                    
                    return (
                      <div 
                        key={task.id || index}
                        style={{
                  backgroundColor: '#ffffff',
                  borderRadius: '20px',
                  padding: '1rem',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                  cursor: 'pointer',
                  minHeight: '120px',
                  display: 'flex',
                          flexDirection: 'column',
                          marginBottom: '0.75rem'
                          
                }}
                        onClick={() => {
                          if (task.type === 'phase_evaluation') {
                            handleEvaluationClick(task, selectedTodoProject, currentPhase);
                          } else {
                            handleTaskClick(task, selectedTodoProject, currentPhase, 'todo');
                          }
                        }}
                      >
                        {/* Task Title and Status */}
                  <div style={{
                    display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                    marginBottom: '0.5rem'
                  }}>
                    <h3 style={{
                      fontSize: '0.9rem',
                      fontWeight: 'bold',
                            color: '#545555',
                            margin: 0,
                            flex: 1,
                            lineHeight: '1.2'
                          }}>
                            {task.title || task.task_title || 'Untitled Task'}
                    </h3>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <div style={{
                              backgroundColor: statusColor,
                              color: 'white',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '12px',
                              fontSize: '0.7rem',
                              fontWeight: '500'
                            }}>
                              {status === 'active' ? 'Active' : 
                               status === 'revise' ? 'Revise' : 
                               status === 'completed' ? 'Done' : 
                               status === 'late' ? 'Late' :
                               status === 'missed' ? 'Missed' : status}
                            </div>
                          </div>
                  </div>
                  
                        {/* Task Description */}
                  <div style={{
                          marginBottom: '0.75rem',
                          flex: 1
                  }}>
                    <p style={{
                      fontSize: '0.8rem',
                      color: '#718096',
                      margin: 0,
                            lineHeight: '1.3',
                            display: '-webkit-box',
                            WebkitLineClamp: 2,
                            WebkitBoxOrient: 'vertical',
                            overflow: 'hidden'
                          }}>
                            {task.description || task.task_description || 'No description available'}
                    </p>
                  </div>
                  
                  {/* Due Date Section */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                          backgroundColor: statusColor,
                    borderRadius: '0 0 16px 16px',
                    padding: '0.5rem',
                    margin: '-1rem -1rem -1rem -1rem',
                    marginTop: 'auto'
                  }}>
                    <FaClock style={{
                      fontSize: '0.8rem',
                            color: '#ffffff'
                    }} />
                    <span style={{
                      fontSize: '0.8rem',
                            color: '#ffffff',
                      fontWeight: '500'
                    }}>
                            {task.due_date ? formatDateTime(task.due_date) : 'No due date'}
                    </span>
                  </div>
                </div>
                    );
                  })
                )}
              </div>
            </div>
          </div>
          
          {/* Column 2 - Progress */}
          <div className="my-group-card-with-crosshair project-dashboard-column-left-2-ultra-unique-2024" style={{padding: 0, display: 'flex', flexDirection: 'column', minHeight: '440px', maxHeight: '500px', flex: 1, background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0', overflow: 'hidden'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Header */}
            <div style={{
              padding: '1.5rem 1.5rem 1rem 1.5rem',
              borderRadius: '0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'relative',
              zIndex: 10,
              backgroundColor: '#ffffff',
              borderBottom: '2px solid #872341'
            }}>
              <h2 style={{fontWeight: '900', margin: 0, fontSize: '1.4rem', color: '#872341', textShadow: 'none', letterSpacing: '0.5px'}}>Pending</h2>
              <div 
                className="pending-sort-dropdown-container"
                  style={{
                  position: 'relative',
                    backgroundColor: '#f5f5f5',
                    border: '2px solid #872341',
                  borderRadius: '8px',
                  padding: '0.5rem 0.75rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.25rem',
                    fontSize: '0.8rem',
                    color: '#872341',
                  fontWeight: '600',
                  minWidth: '80px',
                    boxShadow: 'none',
                  transition: '0.2s',
                  zIndex: 11
                }}
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('Pending sort area clicked');
                  setShowPendingSortDropdown(!showPendingSortDropdown);
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#e8e8e8';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F7F7F7';
                }}
              >
                <FaSort style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                Sort
                <FaChevronDown style={{
                  fontSize: '0.6rem',
                  transform: showPendingSortDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                  transition: 'transform 0.2s ease',
                  pointerEvents: 'none'
                }} />
                {/* Sort Dropdown */}
                {showPendingSortDropdown && (
                  <div style={{
                    position: 'absolute',
                    top: '100%',
                    right: 0,
                    backgroundColor: '#ffffff',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    zIndex: 1002,
                    minWidth: '150px',
                    marginTop: '0.25rem'
                  }}>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'completion' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('completion');
                      setShowPendingSortDropdown(false);
                    }}>
                      Completion %
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'phase' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('phase');
                      setShowPendingSortDropdown(false);
                    }}>
                      Phase
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'deadline' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('deadline');
                      setShowPendingSortDropdown(false);
                    }}>
                      Deadline
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      backgroundColor: sortBy === 'priority' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('priority');
                      setShowPendingSortDropdown(false);
                    }}>
                      Priority
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* Content */}
            <div style={{
              borderRadius: '0 0 20px 20px',
              padding: '1rem',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-start',
              minHeight: 'auto'
            }}>
              
              <div style={{flex: 1, marginBottom: '1rem'}}>
                {/* Render pending tasks */}
                {(() => {
                  // üîß Phase-based filtering
                  const phaseToFilter = viewedPhase || currentPhase;
                  
                  // BREATHE PHASE: Show nothing
                  if (phaseToFilter?.currentPhaseType === 'breathe') {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaClock style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>Breathe Phase</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          No tasks during breathe period
                        </div>
                      </div>
                    );
                  }
                  
                  // EVALUATION PHASE: Show nothing in pending column
                  if (phaseToFilter?.currentPhaseType === 'evaluation') {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaClock style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>Evaluation Phase</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          Check Evaluation column
                        </div>
                      </div>
                    );
                  }
                  
                  // WORK PHASE: Show normal pending tasks
                  // Use the same filtering logic as getFilteredActivities but only for pending tasks
                  const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);
                  let filtered = source;
                  
                  // Filter by viewed phase (already defined above)
                  if (phaseToFilter) {
                    filtered = filtered.filter(activity => {
                      // Check if task has any phase information at all
                      const hasPhaseInfo = activity.phase_info?.phase_number || activity.phase_number || activity.project_phases?.phase_number;
                      
                      if (!hasPhaseInfo) {
                        return false;
                      }
                      
                      const phaseMatch = String(activity.phase_info?.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.project_phases?.phase_number) === String(phaseToFilter.phase_number);
                      
                      return phaseMatch;
                    });
                  }
                  
                  // Then filter by specific phase if manually selected
                  if (phaseFilterMode === 'phase-specific' && selectedTodoPhase) {
                    filtered = filtered.filter(activity => 
                      activity.phase_info?.phase_number === selectedTodoPhase.phase_number ||
                      activity.phase_number === selectedTodoPhase.phase_number ||
                      activity.project_phases?.phase_number === selectedTodoPhase.phase_number
                    );
                  }
                  
                  // Finally filter for pending tasks ONLY (not late tasks without submissions)
                  const pendingTasks = filtered.filter(activity => {
                    const status = getActivityStatus(activity);
                    // Only show tasks that are actually pending (have been submitted and waiting for review)
                    return status === 'pending';
                  });
                  
                  return pendingTasks.length === 0;
                })() ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    alignItems: 'center',
                    padding: '2rem',
                    color: '#718096',
                    textAlign: 'center',
                    height: '100%'
                  }}>
                    <FaClock style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                    <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No pending tasks</div>
                    <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                      Tasks under review will appear here
                    </div>
                  </div>
                ) : (() => {
                  // Use the same filtering logic as getFilteredActivities but only for pending tasks
                  const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);
                  let filtered = source;
                  
                  // Filter by viewed phase if available, otherwise show all phases
                  const phaseToFilter = viewedPhase || currentPhase;
                  if (phaseToFilter) {
                    filtered = filtered.filter(activity => {
                      // Check if task has any phase information at all
                      const hasPhaseInfo = activity.phase_info?.phase_number || activity.phase_number || activity.project_phases?.phase_number;
                      
                      if (!hasPhaseInfo) {
                        return false;
                      }
                      
                      const phaseMatch = String(activity.phase_info?.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.project_phases?.phase_number) === String(phaseToFilter.phase_number);
                      
                      return phaseMatch;
                    });
                  }
                  
                  // Then filter by specific phase if manually selected
                  if (phaseFilterMode === 'phase-specific' && selectedTodoPhase) {
                    filtered = filtered.filter(activity => 
                      activity.phase_info?.phase_number === selectedTodoPhase.phase_number ||
                      activity.phase_number === selectedTodoPhase.phase_number ||
                      activity.project_phases?.phase_number === selectedTodoPhase.phase_number
                    );
                  }
                  
                  // Finally filter for pending tasks ONLY (not late tasks without submissions)
                  const pendingTasks = filtered.filter(activity => {
                    const status = getActivityStatus(activity);
                    // Only show tasks that are actually pending (have been submitted and waiting for review)
                    return status === 'pending';
                  });
                  
                  return pendingTasks.slice(0, 5).map((task, index) => {
                      const status = getActivityStatus(task);
                      const statusColor = status === 'late' ? '#d97706' : '#f59e0b'; // Late or Pending color
                      
                      return (
                        <div 
                          key={task.id || index}
                          style={{
                            backgroundColor: '#ffffff',
                            borderRadius: '20px',
                            padding: '1rem',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                            cursor: 'pointer',
                            minHeight: '120px',
                            display: 'flex',
                            flexDirection: 'column',
                            marginBottom: '0.75rem'
                           
                          }}
                          onClick={() => {
                            if (task.type === 'phase_evaluation') {
                              handleEvaluationClick(task, selectedTodoProject, currentPhase);
                            } else {
                              handleTaskClick(task, selectedTodoProject, currentPhase, 'pending');
                            }
                          }}
                        >
                          {/* Task Title and Status */}
                          <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            marginBottom: '0.5rem'
                          }}>
                            <h3 style={{
                              fontSize: '0.9rem',
                              fontWeight: 'bold',
                              color: '#545555',
                              margin: 0,
                              flex: 1,
                              lineHeight: '1.2'
                            }}>
                              {task.title || task.task_title || 'Untitled Task'}
                            </h3>
                            <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                              <div style={{
                                backgroundColor: statusColor,
                                color: 'white',
                                padding: '0.25rem 0.5rem',
                                borderRadius: '12px',
                                fontSize: '0.7rem',
                                fontWeight: '500'
                              }}>
                                {status === 'late' ? 'Late' : 'Pending'}
                              </div>
                            </div>
                          </div>
                          
                          {/* Task Description */}
                          <div style={{
                            marginBottom: '0.75rem',
                            flex: 1
                          }}>
                            <p style={{
                              fontSize: '0.8rem',
                              color: '#718096',
                              margin: 0,
                              lineHeight: '1.3',
                              display: '-webkit-box',
                              WebkitLineClamp: 2,
                              WebkitBoxOrient: 'vertical',
                              overflow: 'hidden'
                            }}>
                              {task.description || task.task_description || 'No description available'}
                            </p>
                          </div>
                          
                          {/* Due Date Section */}
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            backgroundColor: statusColor,
                            borderRadius: '0 0 16px 16px',
                            padding: '0.5rem',
                            margin: '-1rem -1rem -1rem -1rem',
                            marginTop: 'auto'
                          }}>
                            <FaClock style={{
                              fontSize: '0.8rem',
                              color: '#ffffff'
                            }} />
                            <span style={{
                              fontSize: '0.8rem',
                              color: '#ffffff',
                              fontWeight: '500'
                            }}>
                              {task.due_date ? formatDateTime(task.due_date) : 'No due date'}
                            </span>
                          </div>
                        </div>
                      );
                    });
                })()
                }
              </div>
            </div>
          </div>
          
          {/* Column 3 - Evaluations */}
          <div className="my-group-card-with-crosshair project-dashboard-column-center-ultra-unique-2024" style={{padding: 0, display: 'flex', flexDirection: 'column', minHeight: '440px', maxHeight: '500px', flex: 1, background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0', overflow: 'hidden'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Header */}
            <div style={{
              padding: '1.5rem 1.5rem 1rem 1.5rem',
              borderRadius: '0',
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'center',
              position: 'relative',
              zIndex: 10,
              backgroundColor: '#ffffff',
              borderBottom: '2px solid #872341'
            }}>
              <h2 style={{fontWeight: '900', margin: 0, fontSize: '1.4rem', color: '#872341', textShadow: 'none', letterSpacing: '0.5px'}}>Evaluations</h2>
            </div>
            
            {/* Content */}
            <div style={{
              borderRadius: '0 0 20px 20px',
              padding: '1rem',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-start',
              minHeight: 'auto'
            }}>
              
              <div style={{flex: 1, marginBottom: '1rem'}}>
                {/* Render evaluation task cards */}
                {(() => {
                  // Use loaded evaluations data, or fall back to empty array
                  const allEvaluations = evaluationsData && Array.isArray(evaluationsData) ? evaluationsData : [];
                  
                  // Filter to show only 'active' evaluations (hide 'pending' or 'due' ones)
                  const displayEvaluations = allEvaluations.filter(e => e.status === 'active');
                  
                  // üîß FIX: Use viewedPhase (user-selected via navigation) instead of currentPhase
                  // Only show phase evaluation card if user is viewing an evaluation phase
                  let phaseBeingViewed = viewedPhase || currentPhase;
                  let phaseEvaluationCard = null;
                  let projectEvaluationCard = null;
                  
                  if (phaseBeingViewed && phaseBeingViewed.currentPhaseType === 'evaluation') {
                    // Check if evaluation is past due date
                    const now = new Date();
                    const dueDate = new Date(phaseBeingViewed.evaluation_due_date);
                    const isPastDue = now > dueDate;
                    
                    // Check if there's an existing submission for this phase evaluation
                    const phaseSubmission = myEvaluationSubmissions?.find(
                      sub => sub.phase_id === phaseBeingViewed.id && sub.type === 'phase_evaluation'
                    );
                    
                    // ‚úÖ DETAILED DEBUG: Show ALL phase submissions with their phase_ids
                    const allPhaseEvalSubmissions = myEvaluationSubmissions?.filter(s => s.type === 'phase_evaluation');
                    console.log('üîç [PHASE EVAL CARD] Checking submission:', {
                      phaseBeingViewed: phaseBeingViewed.id,
                      phaseBeingViewedNumber: phaseBeingViewed.phase_number,
                      phaseBeingViewedTitle: phaseBeingViewed.title,
                      myEvaluationSubmissions: myEvaluationSubmissions?.length,
                      phaseSubmission: phaseSubmission,
                      phaseSubmissionPhaseId: phaseSubmission?.phase_id,
                      phaseSubmissionMatches: phaseSubmission?.phase_id === phaseBeingViewed.id,
                      submissionsLoading: myEvaluationSubmissionsLoading, // ‚úÖ Add loading state to log
                      allSubmissions: myEvaluationSubmissions,
                      allPhaseSubmissions: allPhaseEvalSubmissions?.map(s => ({
                        id: s.id,
                        phase_id: s.phase_id,
                        matchesCurrentPhase: s.phase_id === phaseBeingViewed.id,
                        status: s.status,
                        submission_date: s.submission_date,
                        evaluated_members_count: Object.keys(s.evaluation_data?.evaluated_members || {}).length
                      }))
                    });
                    
                    // Check if there's a submitted evaluation in myEvaluationSubmissions
                    const hasSubmittedSubmission = myEvaluationSubmissions.some(
                      sub => sub.phase_id === phaseBeingViewed.id && 
                             sub.type === 'phase_evaluation' && 
                             sub.status === 'submitted'
                    );
                    
                    // ‚úÖ FIX: Only create card after submissions have loaded to prevent "active" flash
                    if (!myEvaluationSubmissionsLoading) {
                    phaseEvaluationCard = {
                      id: `phase-eval-${phaseBeingViewed.id}`,
                      title: `Phase ${phaseBeingViewed.phase_number}: ${phaseBeingViewed.title} Evaluation`,
                      description: `Submit your evaluation for Phase ${phaseBeingViewed.phase_number}`,
                      status: hasSubmittedSubmission || phaseSubmission?.status === 'submitted' ? 'submitted' : (isPastDue ? 'missed' : 'active'),
                      type: 'phase_evaluation',
                      due_date: phaseBeingViewed.evaluation_due_date,
                      evaluation_available_from: phaseBeingViewed.evaluation_available_from,
                      phase_id: phaseBeingViewed.id,
                      phase_number: phaseBeingViewed.phase_number,
                      phase_title: phaseBeingViewed.title,
                      group_id: selectedProject?.group_id,
                        phase_evaluation_form_id: phaseBeingViewed.phase_evaluation_form_id, // ‚úÖ ADD: Actual form ID for submission
                      is_custom_evaluation: phaseBeingViewed.evaluation_form_type === 'custom',
                      evaluation_form_type: phaseBeingViewed.evaluation_form_type,
                      evaluation_form_file_url: phaseBeingViewed.evaluation_form_file_url,
                      evaluation_form_file_name: phaseBeingViewed.evaluation_form_file_name,
                      evaluation_criteria: phaseBeingViewed.evaluation_criteria,
                      evaluation_total_points: phaseBeingViewed.evaluation_total_points,
                      submission_id: phaseSubmission?.id,
                      submission_data: phaseSubmission?.evaluation_data
                    };
                    }
                    
                    // ‚úÖ NEW: Check if this is the last evaluation phase and add project evaluation card
                    // FIX: Filter by phases that HAVE evaluation_available_from (not by currentPhaseType)
                    console.log('üîç [DEBUG PHASES] All phases in selectedProject:', selectedProject?.project_phases?.map(p => ({
                      phase_number: p.phase_number,
                      evaluation_available_from: p.evaluation_available_from,
                      evaluation_due_date: p.evaluation_due_date
                    })));
                    const phasesWithEvaluation = selectedProject?.project_phases?.filter(p => p.evaluation_available_from) || [];
                    console.log('üîç [DEBUG PHASES] Phases with evaluation_available_from:', phasesWithEvaluation.map(p => p.phase_number));
                    const maxEvaluationPhaseNumber = phasesWithEvaluation.length > 0 ? Math.max(...phasesWithEvaluation.map(p => p.phase_number)) : 0;
                    const isLastEvaluationPhase = phaseBeingViewed.phase_number === maxEvaluationPhaseNumber && maxEvaluationPhaseNumber > 0;
                    
                    console.log('üéØ [PROJECT EVAL CARD] isLastEvaluationPhase:', {
                      isLastEvaluationPhase,
                      currentPhaseNumber: phaseBeingViewed.phase_number,
                      phasesWithEvaluation: phasesWithEvaluation.map(p => p.phase_number),
                      maxEvaluationPhaseNumber,
                      hasProjectEvalForms: !!selectedProject?.project_evaluation_forms,
                      projectEvalFormsLength: selectedProject?.project_evaluation_forms?.length || 0,
                      projectEvalFormsContent: selectedProject?.project_evaluation_forms,
                      phaseEvaluationDates: {
                        eval_available_from: phaseBeingViewed.evaluation_available_from,
                        eval_due_date: phaseBeingViewed.evaluation_due_date
                      },
                      submissionsLoading: myEvaluationSubmissionsLoading // ‚úÖ Add loading state to log
                    });
                    // ‚úÖ FIX: Only create card after submissions have loaded to prevent "upcoming" flash
                    if (isLastEvaluationPhase && selectedProject?.project_evaluation_forms && selectedProject.project_evaluation_forms.length > 0 && !myEvaluationSubmissionsLoading) {
                      const projectEvalForm = selectedProject.project_evaluation_forms[0];
                      console.log('‚úÖ [PROJECT EVAL CARD] Conditions met! projectEvalForm:', projectEvalForm);
                      
                      // Check if there's an existing submission for this project evaluation
                      const projectSubmission = myEvaluationSubmissions?.find(
                        sub => sub.project_id === selectedProject.id && sub.type === 'project_evaluation'
                      );
                      
                      console.log('üîç [PROJECT EVAL CARD] Checking submission:', {
                        projectId: selectedProject.id,
                        myEvaluationSubmissions: myEvaluationSubmissions?.length,
                        projectSubmission: projectSubmission,
                        projectSubmissionStatus: projectSubmission?.status,
                        allSubmissions: myEvaluationSubmissions,
                        projectEvalSubmissions: myEvaluationSubmissions?.filter(s => s.type === 'project_evaluation')
                      });
                      
                      // Check if project evaluation is past due date
                      const projectDueDate = new Date(projectEvalForm.due_date);
                      const isProjectPastDue = now > projectDueDate;
                      
                      projectEvaluationCard = {
                        id: `project-eval-${selectedProject.id}`,
                        title: `Project Evaluation: ${selectedProject.project_title || selectedProject.title}`,
                        description: 'Submit your evaluation for the entire project',
                        status: projectSubmission?.status === 'submitted' ? 'submitted' : (isProjectPastDue ? 'missed' : 'active'),
                        type: 'project_evaluation',
                        due_date: projectEvalForm.due_date,
                        available_from: projectEvalForm.available_from,
                        evaluation_available_from: projectEvalForm.available_from,
                        project_id: selectedProject.id,
                        project_title: selectedProject.project_title || selectedProject.title,
                        group_id: selectedProject?.group_id,
                        project_evaluation_form_id: projectEvalForm.id, // ‚úÖ ADD: Actual form ID for submission
                        is_custom_evaluation: projectEvalForm.is_custom_evaluation,
                        evaluation_form_type: projectEvalForm.is_custom_evaluation ? 'custom' : 'builtin',
                        evaluation_form_file_url: projectEvalForm.custom_file_url,
                        evaluation_form_file_name: projectEvalForm.custom_file_name,
                        evaluation_criteria: projectEvalForm.criteria || [],
                        evaluation_total_points: projectEvalForm.total_points || 100,
                        submission_id: projectSubmission?.id,
                        submission_data: projectSubmission?.evaluation_data
                      };
                      console.log('‚úÖ [PROJECT EVAL CARD] Card created:', projectEvaluationCard);
                    } else {
                      console.log('‚ö†Ô∏è [PROJECT EVAL CARD] Card NOT created - detailed conditions:', {
                        isLastEvaluationPhase,
                        hasProjectEvalForms: !!selectedProject?.project_evaluation_forms,
                        projectEvalFormsLength: selectedProject?.project_evaluation_forms?.length || 0,
                        isValidLength: (selectedProject?.project_evaluation_forms?.length || 0) > 0,
                        allConditionsMet: isLastEvaluationPhase && selectedProject?.project_evaluation_forms && (selectedProject.project_evaluation_forms.length > 0)
                      });
                    }
                  }
                  
                  // In evaluation phase, ONLY show phase and project evaluation cards (not regular evaluations)
                  // In work phase, show all evaluations (phase, project, and regular)
                  // phaseBeingViewed is already declared above
                  const isInEvaluationPhase = phaseBeingViewed?.currentPhaseType === 'evaluation';
                  
                  let allDisplayEvaluations = [];
                  if (isInEvaluationPhase) {
                    // In evaluation phase: ONLY show phase and project evaluation cards
                    allDisplayEvaluations = [
                      ...(projectEvaluationCard ? [projectEvaluationCard] : []),
                      ...(phaseEvaluationCard ? [phaseEvaluationCard] : [])
                    ];
                    console.log('üîç [EVAL PHASE] Only showing phase/project eval cards, excluding regular evaluations');
                  } else {
                    // In work phase: show all evaluations (phase, project, and regular)
                    allDisplayEvaluations = [
                      ...(projectEvaluationCard ? [projectEvaluationCard] : []),
                      ...(phaseEvaluationCard ? [phaseEvaluationCard] : []),
                      ...displayEvaluations
                    ];
                  }
                  
                  console.log('üìä [EVALUATIONS DEBUG]', {
                    total: allEvaluations.length,
                    active: displayEvaluations.length,
                    projectEvaluationCard: projectEvaluationCard,
                    phaseEvaluationCard: phaseEvaluationCard,
                    allDisplayEvaluations: allDisplayEvaluations,
                    currentPhaseType: currentPhase?.currentPhaseType,
                    statuses: allEvaluations.map(e => e.status),
                    evaluations: allEvaluations
                  });
                  
                  const statusColor = (status) => {
                    switch(status) {
                      case 'active': return '#34656D'; // Teal
                      case 'due': return '#f59e0b'; // Orange
                      case 'pending': return '#f59e0b'; // Orange
                      case 'completed': return '#10b981'; // Green
                      case 'late': return '#d97706'; // Dark Orange
                      case 'missed': return '#dc2626'; // Red
                      default: return '#6b7280'; // Gray
                    }
                  };
                  
                  const getPhaseEvaluationStatus = (evaluation) => {
                    if (evaluation.type !== 'phase_evaluation' && evaluation.type !== 'project_evaluation') return evaluation.status;
                    
                    const now = new Date();
                    const availableFrom = evaluation.evaluation_available_from ? new Date(evaluation.evaluation_available_from) : null;
                    const dueDate = evaluation.due_date ? new Date(evaluation.due_date) : null;
                    
                    // If already submitted, return submitted
                    if (evaluation.status === 'submitted') return 'submitted';
                    
                    // If not yet available
                    if (availableFrom && now < availableFrom) return 'upcoming';
                    
                    // If past due date (and not submitted)
                    if (dueDate && now > dueDate) return 'missed';
                    
                    // If within the evaluation window OR no dates set (always available)
                    // Case 1: Both dates set and within window
                    if (availableFrom && dueDate && now >= availableFrom && now <= dueDate) return 'ongoing';
                    
                    // Case 2: Only dueDate set (available from start) and not past due
                    if (!availableFrom && dueDate && now <= dueDate) return 'ongoing';
                    
                    // Case 3: Only availableFrom set (no deadline) and already available
                    if (availableFrom && !dueDate && now >= availableFrom) return 'ongoing';
                    
                    // Case 4: No dates set at all (always available)
                    if (!availableFrom && !dueDate) return 'ongoing';
                    
                    return evaluation.status;
                  };
                  
                  // Get darker status-specific color for pills
                  const getStatusPillColor = (evaluation) => {
                    const evalStatus = getPhaseEvaluationStatus(evaluation);
                    
                    if (evaluation.type === 'project_evaluation') {
                      // Violet theme for project evaluations
                      switch(evalStatus) {
                        case 'upcoming': return '#a855f7'; // Light violet
                        case 'ongoing': return '#7c3aed'; // Darker violet
                        case 'submitted': return '#6d28d9'; // Even darker violet
                        case 'missed': return '#5b21b6'; // Darkest violet
                        default: return '#a855f7';
                      }
                    }
                    
                    // Pink theme for phase evaluations
                    switch(evalStatus) {
                      case 'upcoming': return '#ec4899'; // Pink for upcoming
                      case 'ongoing': return '#be185d'; // Darker pink for ongoing
                      case 'submitted': return '#831843'; // Even darker pink for submitted
                      case 'missed': return '#500724'; // Darkest pink for missed
                      default: return '#ec4899'; // Default pink
                    }
                  };
                  
                  const getEvaluationColor = (evaluation) => {
                    if (evaluation.type === 'project_evaluation') {
                      return '#a855f7'; // Violet for project evaluation
                    }
                    
                    // Pink for phase evaluation (all statuses use the same pink base)
                    return '#ec4899'; // Pink for phase evaluation
                  };
                  
                  return allDisplayEvaluations.length === 0 ? null : (
                    allDisplayEvaluations.map((evaluation, index) => {
                      const color = getEvaluationColor(evaluation);
                      const isProjectEval = evaluation.type === 'project_evaluation';
                      
                      return (
                        <div 
                          key={evaluation.id || index}
                          style={{
                            backgroundColor: '#ffffff',
                            borderRadius: '16px',
                            padding: '1rem',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            cursor: 'pointer',
                            minHeight: '120px',
                            display: 'flex',
                            flexDirection: 'column',
                            marginBottom: '0.75rem',
                            position: 'relative',
                            transition: 'all 0.2s ease'
                          }}
                          onClick={() => handleEvaluationClick(evaluation, selectedTodoProject, currentPhase)}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                            e.currentTarget.style.transform = 'translateY(0)';
                          }}
                        >
                          {/* Task Title and Status */}
                          <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            marginBottom: '0.5rem'
                          }}>
                            <h3 style={{
                              fontSize: '0.9rem',
                              fontWeight: 'bold',
                              color: '#1f2937',
                              margin: 0,
                              flex: 1,
                              lineHeight: '1.2'
                            }}>
                              {evaluation.title}
                            </h3>
                            {(isProjectEval || evaluation.type === 'phase_evaluation') && (
                              <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                <div style={{
                                  backgroundColor: getStatusPillColor(evaluation),
                                  color: 'white',
                                  padding: '0.25rem 0.5rem',
                                  borderRadius: '12px',
                                  fontSize: '0.7rem',
                                  fontWeight: '500',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.35rem'
                                }}>
                                  {getPhaseEvaluationStatus(evaluation) === 'upcoming' ? <FaClock style={{ fontSize: '0.65rem' }} /> : 
                                   getPhaseEvaluationStatus(evaluation) === 'ongoing' ? <FaClock style={{ fontSize: '0.65rem' }} /> : 
                                   getPhaseEvaluationStatus(evaluation) === 'submitted' ? <FaCheckDouble style={{ fontSize: '0.65rem' }} /> : 
                                   getPhaseEvaluationStatus(evaluation) === 'missed' ? <FaTimes style={{ fontSize: '0.65rem' }} /> : null}
                                  {getPhaseEvaluationStatus(evaluation) === 'upcoming' ? 'Upcoming' : 
                                   getPhaseEvaluationStatus(evaluation) === 'ongoing' ? 'Ongoing' : 
                                   getPhaseEvaluationStatus(evaluation) === 'submitted' ? 'Submitted' : 
                                   getPhaseEvaluationStatus(evaluation) === 'missed' ? 'Missed' : getPhaseEvaluationStatus(evaluation)}
                                </div>
                              </div>
                            )}
                          </div>
                          
                          {/* Task Description */}
                          <div style={{
                            marginBottom: '0.75rem',
                            flex: 1
                          }}>
                            <p style={{
                              fontSize: '0.8rem',
                              color: '#6b7280',
                              margin: 0,
                              lineHeight: '1.3',
                              display: '-webkit-box',
                              WebkitLineClamp: 2,
                              WebkitBoxOrient: 'vertical',
                              overflow: 'hidden',
                              fontWeight: '400'
                            }}>
                              {evaluation.description}
                            </p>
                          </div>
                          
                          {/* Status Bar Footer */}
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            backgroundColor: color,
                            borderRadius: '0 0 15px 15px',
                            padding: '0.5rem 0.75rem',
                            margin: '-1rem -1rem -1rem -1rem',
                            marginTop: 'auto'
                          }}>
                            <FaClock style={{
                              fontSize: '0.75rem',
                              color: '#ffffff'
                            }} />
                            <span style={{
                              fontSize: '0.75rem',
                              color: '#ffffff',
                              fontWeight: '500'
                            }}>
                              {formatDateTime(evaluation.due_date)}
                            </span>
                          </div>
                        </div>
                      );
                    })
                  );
                })()}
                {/* Empty state */}
                {(() => {
                  const allEvaluations = evaluationsData && Array.isArray(evaluationsData) ? evaluationsData : [];
                  const displayEvaluations = allEvaluations.filter(e => e.status === 'active');
                  const phaseBeingViewed = viewedPhase || currentPhase;
                  let hasEvaluationCards = false;
                  
                  if (phaseBeingViewed && phaseBeingViewed.currentPhaseType === 'evaluation') {
                    hasEvaluationCards = true;
                  }
                  
                  if (!hasEvaluationCards) {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaClipboardList style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No evaluations available</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem', color: '#718096'}}>
                          Evaluations will appear during evaluation phases
                        </div>
                      </div>
                    );
                  }
                  return null;
                })()}
              </div>
            </div>
          </div>
          
          {/* Column 4 - Team */}
          <div className="my-group-card-with-crosshair project-dashboard-column-right-1-ultra-unique-2024" style={{padding: 0, display: 'flex', flexDirection: 'column', minHeight: '440px', maxHeight: '500px', flex: 1, background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0', overflow: 'hidden'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Header */}
            <div style={{
              padding: '1.5rem 1.5rem 1rem 1.5rem',
              borderRadius: '0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'relative',
              zIndex: 10,
              backgroundColor: '#ffffff',
              borderBottom: '2px solid #872341'
            }}>
              <h2 style={{fontWeight: '900', margin: 0, fontSize: '1.4rem', color: '#872341', textShadow: 'none', letterSpacing: '0.5px'}}>Revision</h2>
              <div 
                className="revision-sort-dropdown-container"
                style={{
                  position: 'relative',
                  backgroundColor: '#f5f5f5',
                  border: '2px solid #872341',
                  borderRadius: '8px',
                  padding: '0.5rem 0.75rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.25rem',
                  fontSize: '0.8rem',
                  color: '#872341',
                  fontWeight: '600',
                  minWidth: '80px',
                  boxShadow: 'none',
                  transition: '0.2s',
                  zIndex: 11
                }}
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('Revision sort area clicked');
                  setShowRevisionSortDropdown(!showRevisionSortDropdown);
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#e8e8e8';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F7F7F7';
                }}
              >
                <FaSort style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                Sort
                <FaChevronDown style={{
                  fontSize: '0.6rem',
                  transform: showRevisionSortDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                  transition: 'transform 0.2s ease',
                  pointerEvents: 'none'
                }} />
                {/* Sort Dropdown */}
                {showRevisionSortDropdown && (
                  <div style={{
                    position: 'absolute',
                    top: '100%',
                    right: 0,
                    backgroundColor: '#ffffff',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    zIndex: 1002,
                    minWidth: '150px',
                    marginTop: '0.25rem'
                  }}>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'name' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('name');
                      setShowRevisionSortDropdown(false);
                    }}>
                      Name
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'role' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('role');
                      setShowRevisionSortDropdown(false);
                    }}>
                      Role
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'activity' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('activity');
                      setShowRevisionSortDropdown(false);
                    }}>
                      Activity
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      backgroundColor: sortBy === 'tasks' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('tasks');
                      setShowRevisionSortDropdown(false);
                    }}>
                      Tasks
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* Content */}
            <div style={{
              borderRadius: '0 0 20px 20px',
              padding: '1rem',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              gap: '0.75rem',
              overflowY: 'auto'
            }}>
              {getRevisionTasks().length > 0 ? (
                getRevisionTasks().map((task, index) => {
                  const status = getActivityStatus(task);
                  
                  // Determine status and color based on revision state
                  // Flow: Revise ‚Üí Waiting Decision ‚Üí Re-Revision ‚Üí Waiting Decision ‚Üí Re-Revision ‚Üí ... ‚Üí Completed
                  let statusText = 'Waiting Decision';
                  let statusColor = '#dc2626'; // Red for revision status
                  
                  // Check if there are revision submissions
                  const hasRevisionSubmissions = task.revision_submissions?.length > 0;
                  const latestRevision = hasRevisionSubmissions ? task.revision_submissions[0] : null;
                  const hasPendingRevision = latestRevision?.status === 'pending';
                  // Check if latest revision is revision_requested (in database it can be 'revision_requested' or 'to_revise')
                  const hasRevisionRequested = latestRevision?.status === 'revision_requested' || latestRevision?.status === 'to_revise';
                  
                  // Also check task.status (database field) - it remains 'to_revise' throughout the revision process
                  const taskStatusToRevise = task.status === 'to_revise' || task.status === 'revision_requested';
                  
                  // Check if original submission was revision_requested (in database it can be 'revision_requested' or 'to_revise')
                  const originalRevisionRequested = task.task_submissions?.some(
                    sub => sub.status === 'revision_requested' || sub.status === 'to_revise'
                  );
                  
                  // Flow logic based on database states:
                  // Database states remain: task.status = 'to_revise', revision_submissions[].status = 'revision_requested' or 'pending'
                  // 1. Original revision_requested, no revisions ‚Üí "Revise"
                  // 2. Member submits revision (pending) ‚Üí "Waiting Decision"
                  // 3. Leader requests revision again (revision_requested) ‚Üí "Re-Revision" (any revision being revised = re-revision)
                  // 4. Member submits again (pending) ‚Üí "Waiting Decision"
                  // 5. Repeat 3-4 until approved ‚Üí "Completed"
                  
                  if (hasPendingRevision) {
                    // Member has submitted a revision (pending leader review)
                    // Database: revision_submissions[0].status = 'pending'
                    statusText = 'Waiting Decision';
                    statusColor = '#dc2626'; // Red for pending
                  } else if (hasRevisionRequested) {
                    // Leader has requested revision but member hasn't submitted yet
                    // Database: revision_submissions[0].status = 'revision_requested' or 'to_revise'
                    // If there are ANY revision submissions with revision_requested, it means a revision is being revised
                    // So this is ALWAYS a re-revision if we have revision submissions
                    if (hasRevisionSubmissions) {
                      statusText = 'Re-Revision'; // Leader requested revision of a revision (any revision being revised = re-revision)
                    } else {
                      // This shouldn't happen (hasRevisionRequested but no revision_submissions), but fallback
                      statusText = 'Revise';
                    }
                    statusColor = '#dc2626'; // Red for revision requested
                  } else if (originalRevisionRequested && !hasRevisionSubmissions) {
                    // Original submission was revision_requested but no revisions submitted yet
                    // Database: task_submissions[0].status = 'revision_requested' or 'to_revise', no revision_submissions
                    statusText = 'Revise';
                    statusColor = '#dc2626'; // Red for revision requested
                  } else if (taskStatusToRevise && !hasRevisionSubmissions && originalRevisionRequested) {
                    // Task status is 'to_revise' but no revision submissions yet (fallback check)
                    statusText = 'Revise';
                    statusColor = '#dc2626'; // Red for revision requested
                  } else if (hasRevisionSubmissions) {
                    // Has revision submissions but latest is not pending or revision_requested (fallback)
                    statusText = 'Waiting Decision';
                    statusColor = '#dc2626'; // Red for pending
                  }
                  
                  return (
                    <div 
                      key={task.id || index}
                      style={{
                        backgroundColor: '#ffffff',
                        borderRadius: '20px',
                        padding: '1rem',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                        cursor: 'pointer',
                        minHeight: '120px',
                        display: 'flex',
                        flexDirection: 'column',
                        marginBottom: '0.75rem'
                       
                      }}
                      onClick={() => {
                        // Find the submission that needs to be revised
                        // Priority 1: Check revision submissions for the one marked revision_requested
                        let submissionId = null;
                        
                        if (task.revision_submissions?.length > 0) {
                          // For re-revisions, we need the original task submission ID (not the revision ID)
                          // because the backend expects original_submission_id from task_submissions table
                          // Find the original task submission that all revisions are based on
                          const originalTaskSubmission = task.task_submissions?.find(
                            sub => sub.id
                          );
                          if (originalTaskSubmission) {
                            submissionId = originalTaskSubmission.id;
                            console.log('üîç Re-revision detected - using original task submission ID:', submissionId);
                          } else {
                            // Fallback: if no original submission found, use first task submission
                            if (task.task_submissions?.length > 0) {
                              submissionId = task.task_submissions[0].id;
                              console.log('üîç Re-revision fallback - using first task submission ID:', submissionId);
                            }
                          }
                        } else if (task.task_submissions?.length > 0) {
                          // No revision submissions yet, find the original submission marked for revision
                          const revisionRequested = task.task_submissions.find(
                            sub => sub.status === 'revision_requested' || sub.status === 'to_revise'
                          );
                          if (revisionRequested) {
                            submissionId = revisionRequested.id;
                          } else {
                            // Fallback to most recent submission
                            submissionId = task.task_submissions[0].id;
                          }
                        }
                        
                        console.log('üîç Revision task click - Found submission ID:', submissionId);
                        handleRevisionTaskClick(task, selectedTodoProject, currentPhase, submissionId);
                      }}
                    >
                      {/* Task Title and Status */}
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'flex-start',
                        marginBottom: '0.5rem'
                      }}>
                        <h3 style={{
                            fontSize: '0.9rem',
                          fontWeight: 'bold',
                          color: '#545555',
                            margin: 0,
                          flex: 1,
                          lineHeight: '1.2'
                        }}>
                          {task.task_title || task.title || 'Untitled Task'}
                        </h3>
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                          <div style={{
                            backgroundColor: statusColor,
                            color: 'white',
                            padding: '0.25rem 0.5rem',
                            borderRadius: '12px',
                            fontSize: '0.7rem',
                            fontWeight: '500'
                          }}>
                            {statusText}
                          </div>
                        </div>
                      </div>
                      
                      {/* Task Description */}
                      <div style={{
                        marginBottom: '0.75rem',
                        flex: 1
                      }}>
                        <p style={{
                          fontSize: '0.8rem',
                          color: '#718096',
                          margin: 0,
                          lineHeight: '1.3',
                          display: '-webkit-box',
                          WebkitLineClamp: 2,
                          WebkitBoxOrient: 'vertical',
                          overflow: 'hidden'
                        }}>
                          {task.description || task.task_description || 'No description available'}
                        </p>
                      </div>
                      
                      {/* Due Date Section - Red Color Scheme */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        backgroundColor: '#dc2626', // Red background for revision
                        borderRadius: '0 0 16px 16px',
                        padding: '0.5rem',
                        margin: '-1rem -1rem -1rem -1rem',
                        marginTop: 'auto'
                      }}>
                        <FaClock style={{
                          fontSize: '0.8rem',
                          color: '#ffffff'
                        }} />
                        <span style={{
                          fontSize: '0.8rem',
                          color: '#ffffff',
                          fontWeight: '500'
                        }}>
                          {task.due_date ? formatDateTime(task.due_date) : 'No due date'}
                        </span>
                      </div>
                    </div>
                  );
                })
              ) : (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  justifyContent: 'center',
                  alignItems: 'center',
                  padding: '2rem',
                  color: '#718096',
                  textAlign: 'center',
                  height: '100%'
                }}>
                  <FaRedo style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                  <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No revisions required</div>
                  <div style={{fontSize: '0.8rem', marginTop: '0.25rem', color: '#718096'}}>
                    Revision tasks will appear here when needed
                  </div>
                </div>
              )}
            </div>
          </div>
          
          {/* Column 5 - Analytics */}
          <div className="my-group-card-with-crosshair project-dashboard-column-right-2-ultra-unique-2024" style={{padding: 0, display: 'flex', flexDirection: 'column', minHeight: '440px', maxHeight: '500px', flex: 1, background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0', overflow: 'hidden'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Header */}
            <div style={{
              padding: '1.5rem 1.5rem 1rem 1.5rem',
              borderRadius: '0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'relative',
              zIndex: 10,
              backgroundColor: '#ffffff',
              borderBottom: '2px solid #872341'
            }}>
              <h2 style={{fontWeight: '900', margin: 0, fontSize: '1.4rem', color: '#872341', textShadow: 'none', letterSpacing: '0.5px'}}>Completed</h2>
              <div 
                className="completed-sort-dropdown-container"
                  style={{
                  position: 'relative',
                    backgroundColor: '#f5f5f5',
                    border: '2px solid #872341',
                  borderRadius: '8px',
                  padding: '0.5rem 0.75rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.25rem',
                    fontSize: '0.8rem',
                    color: '#872341',
                  fontWeight: '600',
                  minWidth: '80px',
                    boxShadow: 'none',
                  transition: '0.2s',
                  zIndex: 11
                }}
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('Completed sort area clicked');
                  setShowCompletedSortDropdown(!showCompletedSortDropdown);
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#e8e8e8';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F7F7F7';
                }}
              >
                <FaSort style={{fontSize: '0.7rem', pointerEvents: 'none'}} />
                Sort
                <FaChevronDown style={{
                  fontSize: '0.6rem',
                  transform: showCompletedSortDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                  transition: 'transform 0.2s ease',
                  pointerEvents: 'none'
                }} />
                {/* Sort Dropdown */}
                {showCompletedSortDropdown && (
                  <div style={{
                    position: 'absolute',
                    top: '100%',
                    right: 0,
                    backgroundColor: '#ffffff',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    zIndex: 1002,
                    minWidth: '150px',
                    marginTop: '0.25rem'
                  }}>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'time' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('time');
                      setShowCompletedSortDropdown(false);
                    }}>
                      Time Period
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'metric' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('metric');
                      setShowCompletedSortDropdown(false);
                    }}>
                      Metric
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      borderBottom: '1px solid #f0f0f0',
                      backgroundColor: sortBy === 'trend' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('trend');
                      setShowCompletedSortDropdown(false);
                    }}>
                      Trend
                    </div>
                    <div style={{
                      padding: '0.5rem',
                      cursor: 'pointer',
                      fontSize: '0.8rem',
                      color: '#545555',
                      backgroundColor: sortBy === 'performance' ? '#f8f9fa' : 'transparent'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setSortBy('performance');
                      setShowCompletedSortDropdown(false);
                    }}>
                      Performance
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* Content */}
            <div style={{
              borderRadius: '0 0 20px 20px',
              padding: '1rem',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-start',
              minHeight: 'auto'
            }}>
              
              <div style={{flex: 1, marginBottom: '1rem'}}>
                {/* Render completed tasks */}
                {(() => {
                  // Use the same filtering logic as getFilteredActivities but only for completed tasks
                  const source = Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || []);
                  let filtered = source;
                  
                  // Filter by viewed phase if available, otherwise show all phases
                  // If no active phase exists, show nothing
                  const phaseToFilter = viewedPhase || currentPhase;
                  if (!phaseToFilter) {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaCheckCircle style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No active phase</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          Completed tasks will appear here when a phase is active
                        </div>
                      </div>
                    );
                  }
                  // Don't show completed tasks in evaluation or breathe phases - only in work phase
                  if (phaseToFilter.currentPhaseType === 'breathe') {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaCheckCircle style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>Breathe Phase</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          No tasks during breathe period
                        </div>
                      </div>
                    );
                  }
                  if (phaseToFilter.currentPhaseType === 'evaluation') {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaCheckCircle style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>Evaluation Phase</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          Check Evaluation column
                        </div>
                      </div>
                    );
                  }
                  if (phaseToFilter) {
                    filtered = filtered.filter(activity => {
                      // Check if task has any phase information at all
                      const hasPhaseInfo = activity.phase_info?.phase_number || activity.phase_number || activity.project_phases?.phase_number;
                      
                      if (!hasPhaseInfo) {
                        return false;
                      }
                      
                      const phaseMatch = String(activity.phase_info?.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.phase_number) === String(phaseToFilter.phase_number) ||
                                        String(activity.project_phases?.phase_number) === String(phaseToFilter.phase_number);
                      
                      return phaseMatch;
                    });
                  }
                  
                  // Then filter by specific phase if manually selected
                  if (phaseFilterMode === 'phase-specific' && selectedTodoPhase) {
                    filtered = filtered.filter(activity => 
                      activity.phase_info?.phase_number === selectedTodoPhase.phase_number ||
                      activity.phase_number === selectedTodoPhase.phase_number ||
                      activity.project_phases?.phase_number === selectedTodoPhase.phase_number
                    );
                  }
                  
                  // Finally filter for completed tasks ONLY (not late tasks without submissions)
                  const completedTasks = filtered.filter(activity => {
                      const status = getActivityStatus(activity);
                    // Only show tasks that are actually completed (have been submitted and approved)
                    const isCompleted = status === 'completed';
                    
                    console.log(`üîç [COMPLETED DEBUG] Task "${activity.title || activity.task_title}":`, {
                      phase_info: activity.phase_info?.phase_number,
                      phase_number: activity.phase_number,
                      project_phases: activity.project_phases?.phase_number,
                      status: activity.status,
                      activityStatus: status,
                      isCompleted
                    });
                    
                    return isCompleted;
                  });
                  
                  console.log(`üîç [COMPLETED DEBUG] Found ${completedTasks.length} completed tasks for phase ${phaseToFilter?.phase_number || 'all'}`);
                  
                  if (completedTasks.length === 0) {
                    return (
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: '2rem',
                        color: '#718096',
                        textAlign: 'center',
                        height: '100%'
                      }}>
                        <FaCheckCircle style={{fontSize: '3rem', marginBottom: '1rem', color: '#cbd5e0', opacity: 0.6}} />
                        <div style={{fontSize: '0.9rem', fontWeight: '500'}}>No completed tasks</div>
                        <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>
                          Completed tasks will appear here
                        </div>
                      </div>
                    );
                  }
                  
                  return completedTasks.slice(0, 5).map((task, index) => {
                    const status = getActivityStatus(task);
                    const statusColor = status === 'late' ? '#d97706' : '#10b981'; // Orange for late, green for completed
                    
                    return (
                      <div 
                        key={task.id || index}
                        style={{
                          backgroundColor: '#ffffff',
                          borderRadius: '20px',
                          padding: '1rem',
                          boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                          cursor: 'pointer',
                          minHeight: '120px',
                          display: 'flex',
                          flexDirection: 'column',
                          marginBottom: '0.75rem'
                        }}
                        onClick={() => handleCompletedTaskClick(task, selectedTodoProject, currentPhase)}
                      >
                        {/* Task Title and Status */}
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          marginBottom: '0.5rem'
                        }}>
                          <h3 style={{
                            fontSize: '0.9rem',
                            fontWeight: 'bold',
                            color: '#545555',
                            margin: 0,
                            flex: 1,
                            lineHeight: '1.2'
                          }}>
                            {task.title || task.task_title || 'Untitled Task'}
                          </h3>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <div style={{
                              backgroundColor: statusColor,
                              color: 'white',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '12px',
                              fontSize: '0.7rem',
                              fontWeight: '500'
                            }}>
                              {status === 'late' ? 'Late' : 'Done'}
                            </div>
                          </div>
                        </div>
                        
                        {/* Task Description */}
                        <div style={{
                          marginBottom: '0.75rem',
                          flex: 1
                        }}>
                          <p style={{
                            fontSize: '0.8rem',
                            color: '#718096',
                            margin: 0,
                            lineHeight: '1.3',
                            display: '-webkit-box',
                            WebkitLineClamp: 2,
                            WebkitBoxOrient: 'vertical',
                            overflow: 'hidden'
                          }}>
                            {task.description || task.task_description || 'No description available'}
                          </p>
                        </div>
                        
                        {/* Due Date Section */}
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          backgroundColor: statusColor,
                          borderRadius: '0 0 16px 16px',
                          padding: '0.5rem',
                          margin: '-1rem -1rem -1rem -1rem',
                          marginTop: 'auto'
                        }}>
                          <FaClock style={{
                            fontSize: '0.8rem',
                            color: '#ffffff'
                          }} />
                          <span style={{
                            fontSize: '0.8rem',
                            color: '#ffffff',
                            fontWeight: '500'
                          }}>
                            {task.due_date ? formatDateTime(task.due_date) : 'No due date'}
                          </span>
                        </div>
                      </div>
                    );
                  });
                })()}
              </div>
            </div>
          </div>
          
          </div>
        )}

        {/* Phase Timeline Modal - Moved to root level rendering */}
      </div>
    );
  };

  // Enhanced ToDo rendering with phase indicators
  const renderMyToDo = () => {
    const phaseStats = getPhaseStatistics();
    
    return (
      <div className="my-todo">
        <div className="todo-header">
          <h2>My ToDo</h2>
          
          {/* ‚úÖ ENHANCED: Project and Phase Selector Row */}
          <div className="todo-selectors-row">
            {/* Project Selector */}
            <div className="todo-project-selector">
              <label>Project:</label>
              <div 
                className="dropdown-trigger"
                onClick={() => setShowTodoDropdown(!showTodoDropdown)}
              >
                <span>{selectedTodoProject?.title || 'Select Project'}</span>
                <FaChevronDown className={`dropdown-icon ${showTodoDropdown ? 'open' : ''}`} />
              </div>
              
              {showTodoDropdown && (
                <div className="dropdown-menu">
                  {projects.map(project => (
                    <div 
                      key={project.id}
                      className="dropdown-item"
                      onClick={() => handleTodoProjectChange(project)}
                    >
                      <span>{project.title}</span>
                      <small>Due: {formatDateTime(project.due_date)}</small>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            {/* ‚úÖ PHASE SELECTOR - This should now work! */}
            {selectedTodoProject && availablePhases.length > 0 && (
              <div className="todo-phase-selector">
                <label>Phase:</label>
                <div 
                  className="dropdown-trigger"
                  onClick={() => setShowPhaseDropdown(!showPhaseDropdown)}
                >
                  <span>
                    {phaseFilterMode === 'all' ? 'All Phases' : 
                     selectedTodoPhase ? `Phase ${selectedTodoPhase.phase_number}: ${selectedTodoPhase.title}` : 
                     'Select Phase'}
                  </span>
                  <FaChevronDown className={`dropdown-icon ${showPhaseDropdown ? 'open' : ''}`} />
                </div>
                
                {showPhaseDropdown && (
                  <div className="dropdown-menu">
                    {/* All Phases Option */}
                    <div 
                      className={`dropdown-item ${phaseFilterMode === 'all' ? 'selected' : ''}`}
                      onClick={() => {
                        setPhaseFilterMode('all');
                        setSelectedTodoPhase(null);
                        setShowPhaseDropdown(false);
                      }}
                    >
                      <span>All Phases</span>
                      <small>{todoActivities?.length || 0} total tasks</small>
                    </div>
                    
                    <div className="dropdown-divider"></div>
                    
                    {/* Individual Phase Options */}
                    {availablePhases.map(phase => {
                      const stats = phaseStats[phase.phase_number] || {};
                      const isSelected = phaseFilterMode === 'phase-specific' && 
                                       selectedTodoPhase?.phase_number === phase.phase_number;
                      
                      return (
                        <div 
                          key={phase.phase_number}
                          className={`dropdown-item ${isSelected ? 'selected' : ''}`}
                          onClick={() => {
                            setPhaseFilterMode('phase-specific');
                            setSelectedTodoPhase(phase);
                            setShowPhaseDropdown(false);
                          }}
                        >
                          <div className="phase-dropdown-content">
                            <div className="phase-dropdown-header">
                              <span className={`phase-status-dot ${phase.status}`}></span>
                              <span className="phase-title">
                                Phase {phase.phase_number}: {phase.title}
                              </span>
                            </div>
                            <div className="phase-dropdown-stats">
                              <small>
                                {stats.total} tasks ‚Ä¢ {stats.active} active ‚Ä¢ {stats.completed} done
                              </small>
                            </div>
                            <div className="phase-dropdown-dates">
                              <small>
                                {formatDate(phase.start_date)} - {formatDate(phase.end_date)}
                              </small>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {selectedTodoProject && (
          <div className="todo-content">
            {/* ‚úÖ Phase Filter Summary */}
            
  {phaseFilterMode === 'phase-specific' && selectedTodoPhase && (
    <div className="compact-phase-filter">
      <div className="compact-phase-info">
        <FaProjectDiagram />
        <div className="compact-phase-details">
          <div className="compact-phase-title">
            <span>Phase {selectedTodoPhase.phase_number}: {selectedTodoPhase.title}</span>
            <span className={`compact-phase-status ${selectedTodoPhase.status}`}>
              {selectedTodoPhase.status.toUpperCase()}
            </span>
          </div>
          <div className="compact-phase-dates">
            <span><FaCalendarAlt /> {formatDate(selectedTodoPhase.start_date)}</span>
            <span><FaClock /> {formatDate(selectedTodoPhase.end_date)}</span>
          </div>
        </div>
      </div>
      <button 
        className="compact-clear-filter"
        onClick={() => {
          setPhaseFilterMode('all');
          setSelectedTodoPhase(null);
        }}
        title="Show all phases"
      >
        <FaTimes />
      </button>
    </div>
  )}
            
            <div className="todo-cards">
              {/* Activities List Card - Canvas Style */}
              <div className="todo-card activities-card canvas-style">
                <div className="canvas-card-header">
                  <div className="canvas-header-content">
                    <h3 className="canvas-title">
                      <FaTasks className="canvas-icon" />
                      Activities
                    </h3>
                    {phaseFilterMode === 'phase-specific' && selectedTodoPhase && (
                      <span className="canvas-phase-pill">
                        Phase {selectedTodoPhase.phase_number}
                      </span>
                    )}
                  </div>
                  
                  {/* Canvas-style Filter Pills */}
                  <div className="canvas-filter-pills">
                    {[
                      { key: 'Active', label: 'Active', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'active').length },
                      { key: 'Pending', label: 'Pending', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'pending').length },
                      { key: 'Revise', label: 'Revise', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'revise').length },
                      { key: 'Completed', label: 'Completed', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'completed').length },
                      { key: 'Rejected', label: 'Rejected', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'rejected').length },
                      { key: 'Late', label: 'Late', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'late').length },
                      { key: 'Missed', label: 'Missed', count: (Array.isArray(todoActivities) ? todoActivities : (todoActivities?.tasks || [])).filter(t => getActivityStatus(t) === 'missed').length }
                    ].map(filter => (
                      <button
                        key={filter.key}
                        className={`canvas-filter-pill ${activeFilter === filter.key ? 'active' : ''}`}
                        onClick={() => setActiveFilter(filter.key)}
                      >
                        <span className="pill-label">{filter.label}</span>
                        <span className="pill-count">{filter.count}</span>
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Activities List */}
                <div className="canvas-card-content">
                  <div className="canvas-activities-list">
                      {getFilteredActivities().map(activity => {
                        const activityStatus = getActivityStatus(activity);
                        const isLate = isTaskLate(activity);
                        const now = new Date();
                        const dueDate = new Date(activity.due_date);
                        
                        // Format due date in Canvas style
                        const dueDateFormatted = dueDate.toLocaleDateString('en-US', {
                          month: 'short',
                          day: 'numeric'
                        });
                        const dueTimeFormatted = dueDate.toLocaleTimeString('en-US', {
                          hour: 'numeric',
                          minute: '2-digit',
                          hour12: true
                        });
                        
                        return (
                          <div
                            key={activity.id}
                            className={`canvas-activity-item ${activityStatus} ${selectedActivity?.id === activity.id ? 'selected' : ''}`}
                            onClick={() => setSelectedActivity(activity)}
                          >
                            {/* Status Indicator */}
                            <div className={`canvas-status-indicator ${activityStatus}`}></div>
                            
                            <div className="canvas-activity-content">
                              <div className="canvas-activity-header">
                                <h4 className="canvas-activity-title">{activity.title}</h4>
                                <div className="canvas-activity-meta">
                                  <span className={`canvas-status-text ${activityStatus} ${isLate ? 'late' : ''}`}>
                                    {activityStatus === 'active' ? 'Not Submitted' : 
                                     activityStatus === 'pending' ? (isReRevision(activity) ? 'Re-Revision' : 'Under Review') :
                                     activityStatus === 'completed' ? 'Completed' :
                                     activityStatus === 'revise' ? 'Needs Revision' :
                                     activityStatus === 'rejected' ? 'Rejected' :
                                     activityStatus === 'missed' ? 'Missing' :
                                     activityStatus === 'extension_requested' ? 'Ext. Req.' : activityStatus}
                                    {isLate && activityStatus !== 'missed' && activityStatus !== 'extension_requested' ? ' (Late)' : ''}
                                  </span>
                                </div>
                              </div>
                              
                              <div className="canvas-activity-info">
                                {/* Phase info - only show if viewing all phases */}
                                {phaseFilterMode === 'all' && activity.phase_info && (
                                  <span className="canvas-phase-tag">
                                    Phase {activity.phase_info.phase_number}
                                  </span>
                                )}
                                
                                {/* Due date */}
                                <span className="canvas-due-date">
                                  <FaClock className="canvas-info-icon" />
                                  Due {dueDateFormatted} at {dueTimeFormatted}
                                </span>
                                
                                {/* Submission count */}
                                {activity.task_submissions?.length > 0 && (
                                  <span className="canvas-submission-count">
                                    <FaFile className="canvas-info-icon" />
                                    {activity.task_submissions.length} submission{activity.task_submissions.length !== 1 ? 's' : ''}
                                  </span>
                                )}
                              </div>
                            </div>
                            
                            <div className="canvas-activity-action">
                              <FaChevronRight className="canvas-expand-icon" />
                            </div>
                          </div>
                        );
                      })}
                      
                      {getFilteredActivities().length === 0 && (
                        <div className="canvas-no-activities">
                          {todoActivities.length === 0 ? (
                            <div className="canvas-empty-state">
                              <FaTasks size={48} className="canvas-empty-icon" />
                              <h3>No Tasks Yet</h3>
                              <p>No tasks have been assigned for this project.</p>
                            </div>
                          ) : (
                            <div className="canvas-filter-empty">
                              <FaFilter size={40} className="canvas-empty-icon" />
                              <h3>No {activeFilter} Tasks</h3>
                              <p>No tasks found in the {activeFilter.toLowerCase()} category.</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                </div>
              </div>

              {/* Activity Details Card - Enhanced with Feedback System */}
              <div className="todo-card activity-details-card canvas-style">
                <div className="canvas-card-header">
                  <div className="canvas-header-content">
                    <h3 className="canvas-title">
                      <FaClipboardList className="canvas-icon" />
                      Activity Details
                    </h3>
                  </div>
                </div>
                
                <div className="canvas-card-content">
                  {selectedActivity ? (
                    <div className="canvas-activity-details">
                      <div className="canvas-detail-header">
                        <h3 className="canvas-detail-title">{selectedActivity.title}</h3>
                        <span className={`canvas-detail-status ${getActivityStatus(selectedActivity)}`}>
                          {getActivityStatus(selectedActivity) === 'active' ? 'Not Submitted' : 
                           getActivityStatus(selectedActivity) === 'pending' ? (isReRevision(selectedActivity) ? 'Re-Revision' : 'Under Review') :
                           getActivityStatus(selectedActivity) === 'completed' ? 'Completed' :
                           getActivityStatus(selectedActivity) === 'revise' ? 'Needs Revision' :
                           getActivityStatus(selectedActivity) === 'rejected' ? 'Rejected' :
                           getActivityStatus(selectedActivity) === 'late' ? 'Late' :
                           getActivityStatus(selectedActivity) === 'missed' ? 'Missing' : getActivityStatus(selectedActivity)}
                        </span>
                      </div>
                      
                      {/* Description */}
                      {selectedActivity.description && (
                        <div className="canvas-detail-section">
                          <p className="canvas-description">{selectedActivity.description}</p>
                        </div>
                      )}
                      
                      {/* Basic Info */}
                      <div className="canvas-detail-section">
                        <div className="canvas-info-row">
                          <span className="canvas-info-label">Due Date:</span>
                          <span className="canvas-info-value">
                            <FaCalendarAlt className="canvas-info-icon" />
                            {formatDateTime(selectedActivity.due_date)}
                          </span>
                        </div>
                        
                        {selectedActivity.file_types_allowed && (
                          <div className="canvas-info-row">
                            <span className="canvas-info-label">File Types:</span>
                            <div className="canvas-file-types">
                              {(() => {
                                let fileTypes = [];
                                if (typeof selectedActivity.file_types_allowed === 'string') {
                                  try {
                                    fileTypes = JSON.parse(selectedActivity.file_types_allowed);
                                  } catch {
                                    fileTypes = selectedActivity.file_types_allowed.split(',').map(t => t.trim());
                                  }
                                } else if (Array.isArray(selectedActivity.file_types_allowed)) {
                                  fileTypes = selectedActivity.file_types_allowed;
                                }
                                
                                return fileTypes.length > 0 ? (
                                  fileTypes.map((type, index) => (
                                    <span key={index} className="canvas-file-type-pill">
                                      .{type.trim()}
                                    </span>
                                  ))
                                ) : (
                                  <span className="canvas-info-value">Any file type</span>
                                );
                              })()}
                            </div>
                          </div>
                        )}
                        
                        <div className="canvas-info-row">
                          <span className="canvas-info-label">Attempts:</span>
                          <span className="canvas-info-value">
                            {(() => {
                              const attemptInfo = getAttemptInfo(selectedActivity);
                              const status = getActivityStatus(selectedActivity);
                              let display = `${attemptInfo.currentAttempts} / ${attemptInfo.maxAttempts === Infinity ? '‚àû' : attemptInfo.maxAttempts}`;
                              if (status === 'revise' && attemptInfo.canSubmit) {
                                display += ' (revision allowed)';
                              }
                              return display;
                            })()}
                          </span>
                        </div>
                        
                        {selectedActivity.phase_info && (
                          <div className="canvas-info-row">
                            <span className="canvas-info-label">Phase:</span>
                            <span className="canvas-info-value">
                              <FaProjectDiagram className="canvas-info-icon" />
                              Phase {selectedActivity.phase_info.phase_number}: {selectedActivity.phase_info.title}
                            </span>
                          </div>
                        )}
                      </div>
                      
                      {/* ‚úÖ ENHANCED: Previous Submissions with Complete Attempt History */}
                      {selectedActivity && (
                        <AttemptHistorySection 
                          activity={selectedActivity}
                          onSubmitFeedback={submitFeedback}
                        />
                      )}
                      
                      {/* ‚úÖ ENHANCED: Submit Work Section with File Drop Zone */}
                      <div className="canvas-detail-section canvas-submit-section">
                        {canSubmitTask(selectedActivity) ? (
                          <div className="enhanced-submit-area">
                            <div className="submit-header">
                              <h4>
                                {getActivityStatus(selectedActivity) === 'revise' ? (
                                  <><FaEdit /> Submit Revision</>
                                ) : (
                                  <><FaUpload /> Submit Work</>
                                )}
                              </h4>
                              {getActivityStatus(selectedActivity) === 'revise' && (
                                <div className="revision-notice">
                                  <div className="revision-info">
                                    <FaExclamationTriangle className="warning-icon" />
                                    <span>Revision requested - please address the feedback and resubmit</span>
                                  </div>
                                </div>
                              )}
                            </div>
                            
                            <div className="file-submission-zone">
                              <div 
                                className="file-drop-area"
                                onClick={() => {
                                  const input = document.createElement('input');
                                  input.type = 'file';
                                  input.multiple = true;
                                  let allowedTypes = [];
                                  if (selectedActivity.file_types_allowed) {
                                    if (typeof selectedActivity.file_types_allowed === 'string') {
                                      try {
                                        allowedTypes = JSON.parse(selectedActivity.file_types_allowed);
                                      } catch {
                                        allowedTypes = selectedActivity.file_types_allowed.split(',').map(t => t.trim());
                                      }
                                    } else if (Array.isArray(selectedActivity.file_types_allowed)) {
                                      allowedTypes = selectedActivity.file_types_allowed;
                                    }
                                    if (allowedTypes.length > 0) {
                                      input.accept = allowedTypes.map(type => `.${type.trim()}`).join(',');
                                    }
                                  }
                                  input.onchange = async (e) => {
                                    const files = Array.from(e.target.files);
                                    if (files.length > 0) {
                                      const status = getActivityStatus(selectedActivity);
                                      if (status === 'revise') {
                                        await handleRevisionSubmission(selectedActivity, files);
                                      } else {
                                        await handleFileSubmission(selectedActivity, files);
                                      }
                                    }
                                  };
                                  input.click();
                                }}
                              >
                                <div className="drop-area-content">
                                  <FaCloudUploadAlt size={48} className="upload-icon" />
                                  <div className="upload-text">
                                    <h5>Click to select files</h5>
                                    <p>Choose files to submit for this task</p>
                                  </div>
                                  
                                  {/* File type restrictions */}
                                  {selectedActivity.file_types_allowed && (
                                    <div className="file-restrictions">
                                      <span>Allowed file types:</span>
                                      <div className="allowed-types">
                                        {(() => {
                                          let fileTypes = [];
                                          if (typeof selectedActivity.file_types_allowed === 'string') {
                                            try {
                                              fileTypes = JSON.parse(selectedActivity.file_types_allowed);
                                            } catch {
                                              fileTypes = selectedActivity.file_types_allowed.split(',').map(t => t.trim());
                                            }
                                          } else if (Array.isArray(selectedActivity.file_types_allowed)) {
                                            fileTypes = selectedActivity.file_types_allowed;
                                          }
                                          
                                          return fileTypes.map((type, index) => (
                                            <span key={index} className="file-type-badge">
                                              .{type.trim()}
                                            </span>
                                          ));
                                        })()}
                                      </div>
                                    </div>
                                  )}
                                </div>
                                
                                {submissionLoading && (
                                  <div className="submission-overlay">
                                    <div className="submission-progress">
                                      <FaSpinner className="spinning" />
                                      <span>Uploading files...</span>
                                    </div>
                                  </div>
                                )}
                              </div>
                              
                              {/* Attempt Info */}
                              <div className="attempt-info-bar">
                                <div className="attempt-details">
                                  <span className="attempt-count">
                                    Attempt {(() => {
                                      const attemptInfo = getAttemptInfo(selectedActivity);
                                      return `${attemptInfo.currentAttempts + 1} of ${attemptInfo.maxAttempts === Infinity ? '‚àû' : attemptInfo.maxAttempts}`;
                                    })()}
                                  </span>
                                  {getActivityStatus(selectedActivity) === 'revise' && (
                                    <span className="revision-badge">Revision</span>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="cannot-submit-info">
                            {(() => {
                              const status = getActivityStatus(selectedActivity);
                              const attemptInfo = getAttemptInfo(selectedActivity);
                              
                              if (status === 'completed') {
                                return (
                                  <div className="status-message completed">
                                    <FaCheckCircle />
                                    <div>
                                      <h4>Task Completed</h4>
                                      <p>This task has been completed and approved.</p>
                                    </div>
                                  </div>
                                );
                              }
                              
                              if (status === 'pending') {
                                return (
                                  <div className="status-message pending">
                                    <FaClock />
                                    <div>
                                      <h4>Under Review</h4>
                                      <p>Your submission is being reviewed. Please wait for feedback.</p>
                                    </div>
                                  </div>
                                );
                              }
                              
                              if (status === 'missed') {
                                return (
                                  <div className="status-message missed">
                                    <FaExclamationTriangle />
                                    <div>
                                      <h4>Submission Closed</h4>
                                      <p>The deadline for this task has passed.</p>
                                    </div>
                                  </div>
                                );
                              }
                              
                              if (!attemptInfo.canSubmit) {
                                return (
                                  <div className="status-message max-attempts">
                                    <FaBan />
                                    <div>
                                      <h4>Maximum Attempts Reached</h4>
                                      <p>You have used all {attemptInfo.maxAttempts} allowed attempts for this task.</p>
                                    </div>
                                  </div>
                                );
                              }
                              
                              return (
                                <div className="status-message default">
                                  <FaInfoCircle />
                                  <div>
                                    <h4>Cannot Submit</h4>
                                    <p>This task cannot be submitted at this time.</p>
                                  </div>
                                </div>
                              );
                            })()}
                          </div>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="canvas-no-activity-selected">
                      <FaTasks size={48} className="canvas-empty-icon" />
                      <h3>Select an Activity</h3>
                      <p>Choose an activity from the list to view its details</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        
        {!selectedTodoProject && (
          <div className="no-project-selected">
            <FaProjectDiagram size={48} />
            <h3>Select a Project</h3>
            <p>Choose a project from the dropdown to view your activities</p>
          </div>
        )}
      </div>
    );
  };

const renderMyGrades = () => {
  // If wide view mode is selected, render the wide view instead
  if (gradesViewMode === 'wide') {
    return renderMyGradesWideView();
  }

  // Helper function to get all grades based on view filter
  const getAllGrades = () => {
    if (!detailedGrades) return [];
    
    if (gradesViewFilter === 'project') {
      // Return project-level grades
      return detailedGrades.projectGrade ? [{
        id: detailedGrades.projectGrade.id,
        type: 'project',
        title: detailedGrades.project.title,
        groupGrade: detailedGrades.projectGrade.groupGrade,
        individualGrade: detailedGrades.projectGrade.individualGrade,
        maxGrade: detailedGrades.projectGrade.maxGrade,
        feedback: detailedGrades.projectGrade.feedback,
        gradedBy: detailedGrades.projectGrade.gradedBy || 'Professor',
        gradedAt: detailedGrades.projectGrade.gradedAt,
        status: detailedGrades.projectGrade.status
      }] : [];
    } else {
      // Return phase-level grades
      return (detailedGrades.phaseGrades || []).map(phase => ({
        id: phase.id,
        type: 'phase',
        title: `Phase ${phase.phaseNumber}: ${phase.phaseTitle}`,
        projectTitle: detailedGrades.project.title,
        groupGrade: phase.groupGrade,
        individualGrade: phase.individualGrade,
        maxGrade: phase.maxGrade,
        feedback: phase.feedback,
        gradedBy: phase.gradedBy || 'Professor',
        gradedAt: phase.gradedAt,
        status: phase.status
      }));
    }
  };

  // Filter and sort grades
  const getFilteredAndSortedGrades = () => {
    let grades = getAllGrades();
    
    // Apply search filter
    if (gradesSearchQuery) {
      grades = grades.filter(grade => 
        grade.title.toLowerCase().includes(gradesSearchQuery.toLowerCase()) ||
        (grade.projectTitle && grade.projectTitle.toLowerCase().includes(gradesSearchQuery.toLowerCase()))
      );
    }
    
    // Apply sorting
    switch (gradesSortBy) {
      case 'date':
        grades.sort((a, b) => new Date(b.gradedAt || 0) - new Date(a.gradedAt || 0));
        break;
      case 'highest':
        grades.sort((a, b) => (b.groupGrade || 0) - (a.groupGrade || 0));
        break;
      case 'lowest':
        grades.sort((a, b) => (a.groupGrade || 0) - (b.groupGrade || 0));
        break;
      case 'project':
      default:
        // Keep original order
        break;
    }
    
    return grades;
  };

  const filteredGrades = getFilteredAndSortedGrades();

  return (
    <div className="my-grades">
      {gradesLoading ? (
        <div className="loading-state">
          <div className="loading-spinner"></div>
          <p>Loading grades...</p>
        </div>
      ) : (
        <div className="grades-container">
          {/* Search and Sort Controls */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '16px',
            padding: '20px 24px',
            marginBottom: '16px'
          }}>
            {/* Search Field */}
            <div style={{
              flex: '0 1 400px',
              position: 'relative'
            }}>
              <input
                type="text"
                placeholder={`Search ${gradesViewFilter === 'project' ? 'projects' : 'phases'}...`}
                value={gradesSearchQuery}
                onChange={(e) => setGradesSearchQuery(e.target.value)}
                style={{
                  width: '100%',
                  padding: '10px 16px 10px 40px',
                  borderRadius: '24px',
                  border: '2px solid #e2e8f0',
                  fontSize: '14px',
                  outline: 'none',
                  transition: 'all 0.2s',
                  backgroundColor: '#f8f9fa'
                }}
                onFocus={(e) => {
                  e.target.style.borderColor = '#872341';
                  e.target.style.backgroundColor = '#ffffff';
                }}
                onBlur={(e) => {
                  e.target.style.borderColor = '#e2e8f0';
                  e.target.style.backgroundColor = '#f8f9fa';
                }}
              />
              <FaSearch style={{
                position: 'absolute',
                left: '14px',
                top: '50%',
                transform: 'translateY(-50%)',
                color: '#94a3b8',
                fontSize: '14px'
              }} />
            </div>

            {/* Sort Dropdown */}
            <div style={{
              position: 'relative'
            }}>
              <select
                value={gradesSortBy}
                onChange={(e) => setGradesSortBy(e.target.value)}
                style={{
                  padding: '10px 36px 10px 16px',
                  borderRadius: '24px',
                  border: '2px solid #e2e8f0',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#64748b',
                  backgroundColor: '#f8f9fa',
                  cursor: 'pointer',
                  outline: 'none',
                  appearance: 'none',
                  minWidth: '160px'
                }}
                onFocus={(e) => {
                  e.target.style.borderColor = '#872341';
                  e.target.style.backgroundColor = '#ffffff';
                }}
                onBlur={(e) => {
                  e.target.style.borderColor = '#e2e8f0';
                  e.target.style.backgroundColor = '#f8f9fa';
                }}
              >
                <option value="project">Sort by Project</option>
                <option value="date">Sort by Date</option>
                <option value="highest">Highest First</option>
                <option value="lowest">Lowest First</option>
              </select>
              <FaSort style={{
                position: 'absolute',
                right: '14px',
                top: '50%',
                transform: 'translateY(-50%)',
                color: '#94a3b8',
                fontSize: '14px',
                pointerEvents: 'none'
              }} />
            </div>
          </div>

          {/* Grades List */}
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '16px',
            padding: '0 24px 24px'
          }}>
            {filteredGrades.length > 0 ? filteredGrades.map(grade => (
              <div key={grade.id} style={{
                backgroundColor: '#ffffff',
                borderRadius: '0px',
                padding: '24px',
                display: 'flex',
                gap: '24px',
                border: 'none',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
              }}>
                {/* Left Section - Grades */}
                <div style={{
                  flex: '0 0 200px',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '16px'
                }}>
                  {/* Group Grade */}
                  <div style={{
                    backgroundColor: '#f8f9fa',
                    padding: '16px',
                    borderRadius: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      color: '#64748b',
                      fontWeight: '600',
                      marginBottom: '8px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px'
                    }}>
                      Group Grade
                    </div>
                    <div style={{
                      fontSize: '28px',
                      fontWeight: '700',
                      color: '#872341'
                    }}>
                      {grade.groupGrade || '--'}%
                    </div>
                  </div>

                  {/* Individual Grade */}
                  <div style={{
                    backgroundColor: '#f8f9fa',
                    padding: '16px',
                    borderRadius: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      color: '#64748b',
                      fontWeight: '600',
                      marginBottom: '8px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px'
                    }}>
                      Individual Grade
                    </div>
                    <div style={{
                      fontSize: '28px',
                      fontWeight: '700',
                      color: '#872341'
                    }}>
                      {grade.individualGrade || '--'}%
                    </div>
                  </div>
                </div>

                {/* Right Section - Details */}
                <div style={{
                  flex: 1,
                  display: 'flex',
                  flexDirection: 'column',
                  justifyContent: 'space-between'
                }}>
                  {/* Title and Info */}
                  <div>
                    <h3 style={{
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#1e293b',
                      marginBottom: '12px'
                    }}>
                      {grade.title}
                    </h3>
                    
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px',
                      fontSize: '14px',
                      color: '#64748b'
                    }}>
                      <div>
                        <span style={{ fontWeight: '600', color: '#475569' }}>Status:</span> {grade.status?.toUpperCase() || 'N/A'}
                      </div>
                      <div>
                        <span style={{ fontWeight: '600', color: '#475569' }}>Feedback:</span> {grade.feedback || 'No feedback provided'}
                      </div>
                    </div>
                  </div>

                  {/* View Button */}
                  <div style={{
                    display: 'flex',
                    justifyContent: 'flex-end',
                    marginTop: '16px'
                  }}>
                    <button
                      style={{
                        padding: '8px 20px',
                        backgroundColor: '#872341',
                        color: '#ffffff',
                        border: 'none',
                        borderRadius: '6px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = '#6d1d34';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = '#872341';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                      onClick={() => {
                        // TODO: Open detailed view modal
                        console.log('View details for grade:', grade.id);
                      }}
                    >
                      View
                      <FaArrowRight />
                    </button>
                  </div>
                </div>
              </div>
            )) : (
              <div style={{
                textAlign: 'center',
                padding: '60px 20px',
                color: '#94a3b8'
              }}>
                <FaGraduationCap size={48} style={{ marginBottom: '16px' }} />
                <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px' }}>   
                  No Grades Found
                </h3>
                <p style={{ fontSize: '14px' }}>
                  {gradesSearchQuery ? 'Try adjusting your search query' : 'No grades available yet'}
                </p>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// =================== RENDER MY GRADES WIDE VIEW ===================
const renderMyGradesWideView = () => {
  // DEBUG: Log the data to understand the mapping issue
  console.log('üéØ [RENDER GRADES] View Filter:', gradesViewFilter);
  console.log('üéØ [RENDER GRADES] All Projects Count:', allProjects?.length || 0);
  console.log('üéØ [RENDER GRADES] All Projects IDs:', allProjects?.map(p => ({ id: p.id, title: p.title })) || []);
  console.log('üéØ [RENDER GRADES] Grades Overview Count:', gradesOverview?.length || 0);
  console.log('üéØ [RENDER GRADES] Grades Overview Data:', gradesOverview);
  console.log('üéØ [RENDER GRADES] Grades Overview with Types:', gradesOverview?.map(g => ({ 
    projectId: g.projectId, 
    phaseId: g.phaseId, 
    type: g.type,
    projectTitle: g.projectTitle,
    phaseTitle: g.phaseTitle,
    groupGrade: g.groupGrade,
    individualGrade: g.individualGrade
  })) || []);

  // ‚úÖ Show ALL projects/phases from course, with grades ONLY from matching type
  const getWideViewCards = () => {
    if (gradesViewFilter === 'project') {
      // Show ALL projects from allProjects, with PROJECT DELIVERABLE grades ONLY (if available)
      if (!allProjects || allProjects.length === 0) {
        return [];
      }
      
      // ‚úÖ CRITICAL: Create a map for quick grade lookups by projectId, but ONLY for project-type grades
      const projectGradesMap = {};
      if (gradesOverview && gradesOverview.length > 0) {
        gradesOverview.forEach(grade => {
          console.log('üéØ [PROCESSING GRADE] Raw grade object:', {
            type: grade.type,
            projectId: grade.projectId,
            phaseId: grade.phaseId,
            projectTitle: grade.projectTitle,
            phaseTitle: grade.phaseTitle,
            groupGrade: grade.groupGrade,
            individualGrade: grade.individualGrade
          });
          
          // ‚úÖ CRITICAL FIX: Only map PROJECT deliverable grades (not phase grades)
          if (grade.type === 'project' && grade.projectId) {
            console.log('üéØ [PROJECT GRADES MAP] ‚úÖ Adding PROJECT grade for project:', grade.projectId, 'Type:', grade.type, 'Group Grade:', grade.groupGrade, 'Individual:', grade.individualGrade);
            projectGradesMap[grade.projectId] = grade;
          } else if (grade.type === 'phase') {
            console.log('üéØ [PROJECT GRADES MAP] ‚ùå SKIPPING PHASE grade - phaseId:', grade.phaseId, 'projectId:', grade.projectId, 'Grade:', grade.groupGrade);
          } else {
            console.log('üéØ [PROJECT GRADES MAP] ‚ö†Ô∏è UNKNOWN TYPE:', grade.type, 'projectId:', grade.projectId, 'phaseId:', grade.phaseId);
          }
        });
      }
      console.log('üéØ [PROJECT GRADES MAP] Final project grades map keys:', Object.keys(projectGradesMap));
      console.log('üéØ [PROJECT GRADES MAP] Full map:', projectGradesMap);
      
      // For each project, create a card with PROJECT DELIVERABLE grades if available
      const projectsWithGrades = allProjects.map(project => {
        const projectGrade = projectGradesMap[project.id];
        console.log('üéØ [PROJECT CARD] Project:', project.title, 'ID:', project.id, 'Found PROJECT Grade:', projectGrade ? 'YES' : 'NO');
        if (projectGrade) {
          console.log('   ‚îî‚îÄ Grade Details:', { group: projectGrade.groupGrade, individual: projectGrade.individualGrade, type: projectGrade.type });
        }
        
        return {
          id: projectGrade?.id || project.id,
          projectId: project.id,
          type: 'project',
          title: project.title,
          description: project.description,
          dueDate: project.due_date,
          status: project.status,
          groupGrade: projectGrade?.groupGrade || null,
          individualGrade: projectGrade?.individualGrade || null,
          maxGrade: projectGrade?.maxGrade || 100,
          gradedBy: projectGrade?.gradedBy || null,
          gradedAt: projectGrade?.gradedAt || null,
          feedback: projectGrade?.feedback || null
        };
      });
      return projectsWithGrades;
    } else {
      // Show ALL phases from allProjects, with PHASE DELIVERABLE grades ONLY (if available)
      if (!allProjects || allProjects.length === 0) {
        return [];
      }
      
      // ‚úÖ CRITICAL: Create a map of PHASE deliverable grades from gradesOverview
      const phaseGradesMap = {};
      if (gradesOverview && gradesOverview.length > 0) {
        gradesOverview.forEach(grade => {
          // ‚úÖ CRITICAL FIX: Only map PHASE deliverable grades (not project grades)
          if (grade.type === 'phase' && grade.phaseId) {
            console.log('üéØ [PHASE GRADES MAP] Adding PHASE grade for phase:', grade.phaseId, 'Type:', grade.type, 'Group Grade:', grade.groupGrade);
            phaseGradesMap[grade.phaseId] = grade;
          } else if (grade.type === 'project') {
            console.log('üéØ [PHASE GRADES MAP] SKIPPING PROJECT grade - projectId:', grade.projectId, 'Grade:', grade.groupGrade);
          }
        });
      }
      
      console.log('üéØ [PHASE GRADES MAP] Final phase grades map keys:', Object.keys(phaseGradesMap));
      console.log('üéØ [PHASE GRADES MAP] Full map:', phaseGradesMap);
      
      // Show all phases, with PHASE DELIVERABLE grades overlaid if available
      const allPhases = [];
      allProjects.forEach(project => {
        if (project.project_phases && Array.isArray(project.project_phases)) {
          project.project_phases.forEach(phase => {
            const phaseGrade = phaseGradesMap[phase.id];
            console.log('üéØ [PHASE CARD] Phase:', phase.title, 'ID:', phase.id, 'Found PHASE Grade:', phaseGrade ? 'YES' : 'NO');
            if (phaseGrade) {
              console.log('   ‚îî‚îÄ Grade Details:', { group: phaseGrade.groupGrade, individual: phaseGrade.individualGrade, type: phaseGrade.type });
            }
            
            allPhases.push({
              id: phaseGrade?.id || phase.id,
              type: 'phase',
              projectId: project.id,
              projectTitle: project.title,
              title: `Phase ${phase.phase_number}: ${phase.title}`,
              description: phase.description,
              startDate: phase.start_date,
              endDate: phase.end_date,
              status: phase.is_active ? 'active' : 'inactive',
              groupGrade: phaseGrade?.groupGrade || null,
              individualGrade: phaseGrade?.individualGrade || null,
              maxGrade: phaseGrade?.maxGrade || 100,
              gradedBy: phaseGrade?.gradedBy || null,
              gradedAt: phaseGrade?.gradedAt || null,
              feedback: phaseGrade?.feedback || null
            });
          });
        }
      });
      return allPhases;
    }
  };

  const cards = getWideViewCards();

  return (
    <div className="my-grades-wide-view" style={{
      width: '100%',
      padding: '24px',
      backgroundColor: 'transparent'
    }}>
      {/* Wide View Header with Info */}
      <div style={{
        marginBottom: '32px',
        paddingBottom: '0px',
        borderBottom: 'none',
        textAlign: 'center',
        marginTop: '80px'
      }}>
        <h2 style={{
          fontSize: '24px',
          fontWeight: '700',
          color: '#ffffff',
          marginBottom: '12px'
        }}>
          {gradesViewFilter === 'project' ? 'Projects Overview' : 'Phases Overview'}
        </h2>
        <p style={{
          fontSize: '15px',
          color: '#ffffff'
        }}>
          Viewing {cards.length} {gradesViewFilter === 'project' ? 'project' : 'phase'}{cards.length !== 1 ? 's' : ''}
        </p>
      </div>

      {/* Search and Sort Controls - Centered */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '16px',
        marginBottom: '32px',
        flexWrap: 'wrap'
      }}>
        {/* Search Field */}
        <div style={{
          flex: '0 1 400px',
          position: 'relative'
        }}>
          <input
            type="text"
            placeholder={`Search ${gradesViewFilter === 'project' ? 'projects' : 'phases'}...`}
            value={gradesSearchQuery}
            onChange={(e) => setGradesSearchQuery(e.target.value)}
            style={{
              width: '100%',
              padding: '12px 16px 12px 40px',
              borderRadius: '24px',
              border: '2px solid #e2e8f0',
              fontSize: '14px',
              outline: 'none',
              transition: 'all 0.2s',
              backgroundColor: '#f8f9fa'
            }}
            onFocus={(e) => {
              e.target.style.borderColor = '#872341';
              e.target.style.backgroundColor = '#ffffff';
            }}
            onBlur={(e) => {
              e.target.style.borderColor = '#e2e8f0';
              e.target.style.backgroundColor = '#f8f9fa';
            }}
          />
          <FaSearch style={{
            position: 'absolute',
            left: '14px',
            top: '50%',
            transform: 'translateY(-50%)',
            color: '#94a3b8',
            fontSize: '14px'
          }} />
        </div>

        {/* Sort Dropdown */}
        <div style={{
          position: 'relative'
        }}>
          <select
            value={gradesSortBy}
            onChange={(e) => setGradesSortBy(e.target.value)}
            style={{
              padding: '12px 36px 12px 16px',
              borderRadius: '24px',
              border: '2px solid #e2e8f0',
              fontSize: '14px',
              fontWeight: '500',
              color: '#64748b',
              backgroundColor: '#f8f9fa',
              cursor: 'pointer',
              outline: 'none',
              appearance: 'none',
              minWidth: '160px'
            }}
            onFocus={(e) => {
              e.target.style.borderColor = '#872341';
              e.target.style.backgroundColor = '#ffffff';
            }}
            onBlur={(e) => {
              e.target.style.borderColor = '#e2e8f0';
              e.target.style.backgroundColor = '#f8f9fa';
            }}
          >
            <option value="project">Sort by Project</option>
            <option value="date">Sort by Date</option>
            <option value="highest">Highest First</option>
            <option value="lowest">Lowest First</option>
          </select>
          <FaSort style={{
            position: 'absolute',
            right: '14px',
            top: '50%',
            transform: 'translateY(-50%)',
            color: '#94a3b8',
            fontSize: '14px',
            pointerEvents: 'none'
          }} />
        </div>
      </div>

      {/* Cards Grid */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(3, 1fr)',
        gap: '20px',
        width: '100%'
      }}>
        {cards.length > 0 ? cards.map(card => (
          <div 
            key={`${card.type}-${card.id}`}
            style={{
              backgroundColor: '#ffffff',
              borderRadius: '12px',
              overflow: 'hidden',
              boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
              border: '1px solid #e2e8f0',
              transition: 'all 0.3s ease',
              display: 'flex',
              minHeight: '240px'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
              e.currentTarget.style.transform = 'translateY(-4px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            {/* Left Side - Grades */}
            <div style={{
              flex: '0 0 200px',
              backgroundColor: '#f8f9fa',
              padding: '20px',
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'space-between',
              borderRight: '2px solid #e2e8f0'
            }}>
              {/* Top - Group Grade */}
              <div style={{
                textAlign: 'center'
              }}>
                <div style={{
                  fontSize: '11px',
                  color: '#64748b',
                  fontWeight: '700',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  marginBottom: '8px'
                }}>
                  Group Grade
                </div>
                <div style={{
                  fontSize: '32px',
                  fontWeight: '800',
                  color: card.groupGrade !== null && card.groupGrade !== undefined 
                    ? (card.groupGrade >= 75 ? '#059669' : card.groupGrade >= 50 ? '#f59e0b' : '#dc2626')
                    : '#cbd5e0',
                  marginBottom: '4px'
                }}>
                  {card.groupGrade !== null && card.groupGrade !== undefined ? `${card.groupGrade}%` : '--'}
                </div>
              </div>

              {/* Bottom - Individual Grade */}
              <div style={{
                textAlign: 'center',
                paddingTop: '16px',
                borderTop: '1px solid #e2e8f0'
              }}>
                <div style={{
                  fontSize: '11px',
                  color: '#64748b',
                  fontWeight: '700',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  marginBottom: '8px'
                }}>
                  Individual Grade
                </div>
                <div style={{
                  fontSize: '32px',
                  fontWeight: '800',
                  color: card.individualGrade !== null && card.individualGrade !== undefined 
                    ? (card.individualGrade >= 75 ? '#059669' : card.individualGrade >= 50 ? '#f59e0b' : '#dc2626')
                    : '#cbd5e0',
                  marginBottom: '4px'
                }}>
                  {card.individualGrade !== null && card.individualGrade !== undefined ? `${card.individualGrade}%` : '--'}
                </div>
              </div>
            </div>

            {/* Right Side - Details */}
            <div style={{
              flex: 1,
              padding: '20px',
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'space-between'
            }}>
              {/* Title and Metadata */}
              <div>
                <h3 style={{
                  fontSize: '16px',
                  fontWeight: '700',
                  color: '#1e293b',
                  marginBottom: '8px',
                  lineHeight: '1.4'
                }}>
                  {card.title}
                </h3>

                {/* Project Indicator Pill for Phase Cards */}
                {card.type === 'phase' && card.projectTitle && (
                  <div style={{
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: '6px',
                    padding: '4px 12px',
                    backgroundColor: '#f1f5f9',
                    borderRadius: '12px',
                    fontSize: '12px',
                    fontWeight: '600',
                    color: '#475569',
                    marginBottom: '12px',
                    border: '1px solid #e2e8f0'
                  }}>
                    <FaFolder style={{ fontSize: '11px', color: '#64748b' }} />
                    <span>Project: {card.projectTitle}</span>
                  </div>
                )}

                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '10px',
                  fontSize: '13px',
                  color: '#64748b',
                  marginTop: card.type === 'phase' ? '0' : '12px'
                }}>
                  {card.description && (
                    <div style={{
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      display: '-webkit-box',
                      WebkitLineClamp: 2,
                      WebkitBoxOrient: 'vertical'
                    }}>
                      <span style={{ fontWeight: '600', color: '#475569' }}>Description:</span> {card.description}
                    </div>
                  )}

                  {card.type === 'project' && card.dueDate && (
                    <div>
                      <span style={{ fontWeight: '600', color: '#475569' }}>Due:</span> {new Date(card.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </div>
                  )}

                  {card.type === 'phase' && (
                    <div>
                      <span style={{ fontWeight: '600', color: '#475569' }}>Period:</span> {new Date(card.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date(card.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                  )}

                  {card.finalGrade !== null && card.finalGrade !== undefined && (
                    <div style={{
                      padding: '8px 12px',
                      backgroundColor: card.finalGrade >= 75 ? '#ecfdf5' : card.finalGrade >= 50 ? '#fffbeb' : '#fef2f2',
                      borderRadius: '6px',
                      fontWeight: '600',
                      color: card.finalGrade >= 75 ? '#059669' : card.finalGrade >= 50 ? '#d97706' : '#dc2626'
                    }}>
                      Final Grade: {card.finalGrade}%
                    </div>
                  )}
                </div>
              </div>

              {/* Feedback Preview */}
              {card.feedback && (
                <div style={{
                  marginTop: '12px',
                  padding: '12px',
                  backgroundColor: '#fef8f2',
                  borderRadius: '4px',
                  fontSize: '13px',
                  color: '#92400e',
                  maxHeight: '60px',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  display: '-webkit-box',
                  WebkitLineClamp: 2,
                  WebkitBoxOrient: 'vertical'
                }}>
                  <strong>Feedback:</strong> {card.feedback}
                </div>
              )}
            </div>
          </div>
        )) : (
          <div style={{
            gridColumn: '1 / -1',
            textAlign: 'center',
            padding: '60px 20px',
            color: '#94a3b8'
          }}>
            <FaGraduationCap size={48} style={{ marginBottom: '16px', color: '#cbd5e0' }} />
            <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#64748b' }}>
              No {gradesViewFilter === 'project' ? 'Projects' : 'Phases'} Found
            </h3>
            <p style={{ fontSize: '14px', color: '#94a3b8' }}>
              {gradesViewFilter === 'project' 
                ? 'No projects available in this course'
                : 'No phases available yet'}
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

// =================== RENDER MY GRADES SECTION ===================




const renderAssignToDo = () => {
  // Check if user is a leader
  if (userRole !== 'leader') {
    return (
      <div className="access-denied">
        <div className="access-denied-content">
          <FaBan size={64} color="#f56565" />
          <h2>Access Denied</h2>
          <p>Only group leaders can access the task assignment feature.</p>
          <p>You are currently a <strong>{userRole}</strong> in your group.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="assign-todo">
      <div className="assign-todo-header">
        <h2>Assign Tasks to Members</h2>
       
        
        {/* Project Selector */}
        <div className="assign-project-selector">
          <label>Select Project:</label>
          <div 
            className="dropdown-trigger"
            onClick={() => setShowAssignProjectDropdown(!showAssignProjectDropdown)}
          >
            <span>{selectedAssignProject?.title || 'Select Project'}</span>
            <FaChevronDown className={`dropdown-icon ${showAssignProjectDropdown ? 'open' : ''}`} />
          </div>
          
          {showAssignProjectDropdown && (
            <div className="dropdown-menu">
              {projects.map(project => (
                <div 
                  key={project.id}
                  className="dropdown-item"
                  onClick={() => handleAssignProjectChange(project)}
                >
                  <span>{project.title}</span>
                  <small>Due: {formatDateTime(project.due_date)}</small>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {selectedAssignProject && (
        <div className="assign-content">
          {/* Current Active Phase Indicator */}
          {currentActivePhase && (
            <div className="current-phase-indicator">
              <div className="active-phase-timeline">
                <div className="phase-timeline-line"></div>
                <div className="active-phase-item">
                  <div className="active-phase-circle">
                    {currentActivePhase.phase_number}
                  </div>
                  <div className="active-phase-content">
                    <h3 className="active-phase-title">Current Phase: {currentActivePhase.title}</h3>
                    <div className="active-phase-dates">
                      {formatDate(currentActivePhase.start_date)} - {formatDate(currentActivePhase.end_date)}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Task Mode Selector - Only show when no mode is selected */}
          {!currentTaskMode && (
            <div className="task-mode-selector">
              <h3 className="mode-selector-title">Choose Task Operation</h3>
              <div className="mode-circles">
                <div 
                  className="mode-circle task-assignment-circle"
                  onClick={() => handleTaskModeChange('assignment')}
                >
                  <div className="mode-circle-icon">
                    <FaTasks />
                  </div>
                  <div className="mode-circle-label">Task Assignment</div>
                  <div className="mode-circle-desc">Create and assign new tasks</div>
                </div>
                <div 
                  className="mode-circle task-management-circle"
                  onClick={() => handleTaskModeChange('management')}
                >
                  <div className="mode-circle-icon">
                    <FaEdit />
                  </div>
                  <div className="mode-circle-label">Task Management</div>
                  <div className="mode-circle-desc">Edit and manage existing tasks</div>
                </div>
              </div>
            </div>
          )}

          {/* Task Assignment Mode */}
          {currentTaskMode === 'assignment' && (
            <div className="task-mode-content apple-style">
              <div className="apple-header">
                <h2>Task Assignment</h2>
                <button className="apple-close-btn" onClick={handleCloseTaskMode}>
                  <FaTimes />
                </button>
              </div>

              <div className="apple-content">
          <div className="assign-cards">
            {/* Combined Task Assignment Section */}
            <div className="assign-card combined-assignment-card">
              <div className="combined-content">
                {/* Left Side - Group Members */}
                <div className="members-section">
                  <div className="section-header-with-count">
                    <h4 className="section-title">Select Member</h4>
                  </div>
                  <div className="task-limits-with-count">
                    <div className="task-limits-simple">
                      Min: {taskLimits.min_tasks} | Max: {taskLimits.max_tasks} tasks per phase
                    </div>
                    <span className="members-count">({groupMembers.length} members)</span>
                  </div>
                  <div className="assignable-members-list">
                    {groupMembers.map(member => {
                      const taskCount = memberTaskCounts[member.student_id] || 0;
                      const isAtLimit = taskCount >= taskLimits.max_tasks;
                      const needsMoreTasks = taskCount < taskLimits.min_tasks;
                      
                      // Determine color class based on task count
                      let colorClass = '';
                      if (taskCount === 0) {
                        colorClass = 'no-tasks';
                      } else if (taskCount < taskLimits.min_tasks) {
                        // If close to minimum (within 1 task)
                        if (taskLimits.min_tasks - taskCount === 1) {
                          colorClass = 'nearing-minimum';
                        } else {
                          colorClass = 'no-tasks';
                        }
                      } else if (taskCount === taskLimits.min_tasks) {
                        colorClass = 'at-minimum';
                      } else if (taskCount > taskLimits.min_tasks && taskCount < taskLimits.max_tasks) {
                        colorClass = 'beyond-minimum';
                      } else {
                        colorClass = 'beyond-minimum'; // at or above max
                      }
                      
                      return (
                        <div
                          key={member.id}
                          className={`assignable-member-item ${selectedAssignMember?.id === member.id ? 'selected' : ''} ${colorClass} ${isAtLimit ? 'at-limit' : ''}`}
                          onClick={() => !isAtLimit && handleAssignMemberSelect(member)}
                        >
                          <div className="member-avatar">
                            {member.studentaccounts?.profile_image_url ? (
                              <img 
                                src={getProfileImageUrl(member.studentaccounts)} 
                                alt={member.studentaccounts.first_name}
                              />
                            ) : (
                              <FaUser />
                            )}
                          </div>
                          <div className="member-info">
                            <div className="member-name-simple">
                              {member.studentaccounts?.first_name} {member.studentaccounts?.last_name}
                            </div>
                            <div className="member-role">({member.position})</div>
                            {!isAtLimit && <div className="member-triangle">‚ñ∂</div>}
                            {isAtLimit && <FaBan className="member-blocked" />}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Divider Line */}
                <div className="section-divider"></div>

                {/* Right Side - Task Creation Form */}
                <div className="task-form-section">
                  <h2 className="section-title create-task-title">Create Task</h2>
                  
                  {selectedAssignMember ? (
                    <div className="task-creation-form">
                      {/* Simple Assigning to Section */}
                      <div className="assigning-to-simple">
                        {selectedAssignMember.studentaccounts?.profile_image_url ? (
                          <img 
                            src={getProfileImageUrl(selectedAssignMember.studentaccounts)} 
                            alt={selectedAssignMember.studentaccounts.first_name}
                            className="assignee-profile-image"
                          />
                        ) : (
                          <div className="assignee-profile-image">
                            <FaUser />
                          </div>
                        )}
                        <div className="assignee-info">
                          <div className="assigning-label">Assigning to:</div>
                          <div className="assignee-name">{selectedAssignMember.studentaccounts?.first_name} {selectedAssignMember.studentaccounts?.last_name}</div>
                        </div>
                      </div>

                      {/* Member Phase Overview */}
                      <div className="member-phase-overview-compact">
                        <div className="phase-overview-header-compact">
                          <span className="phase-overview-title">Task Count by Phase</span>
                        </div>
                        
                        <div className="phase-cards-container">
                          {availableAssignPhases.map(phase => {
                            const phaseTaskCount = assignedTasks.filter(task => {
                              // Check both possible field names for assigned_to
                              const assignedToMatch = (task.assigned_to_id === selectedAssignMember.student_id) || 
                                                    (task.assigned_to === selectedAssignMember.student_id);
                              
                              // Check both phase_id and project_phases.id for phase matching
                              const phaseMatch = (task.phase_id === phase.id) || (task.project_phases?.id === phase.id);
                              
                              return assignedToMatch && phaseMatch;
                            }).length;
                            
                            const maxTasks = taskLimits.max_tasks;
                            const canAssignMore = phaseTaskCount < maxTasks;
                            
                            return (
                              <div key={phase.id} className={`phase-card-compact ${canAssignMore ? 'available' : 'full'}`}>
                                <div className="phase-info">
                                  <span className="phase-number">P{phase.phase_number}</span>
                                  <span className="phase-title-compact">{phase.title}</span>
                                </div>
                                <span className={`task-count-badge-compact ${phaseTaskCount >= maxTasks ? 'at-limit' : ''}`}>
                                  {phaseTaskCount}/{maxTasks}
                                </span>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      <form onSubmit={handleTaskSubmit}>
                      
                      {/* Task Title */}
                      <div className="form-group">
                        <label htmlFor="taskTitle">Task Title *</label>
                        <input
                          type="text"
                          id="taskTitle"
                          value={taskForm.title}
                          onChange={(e) => setTaskForm({...taskForm, title: e.target.value})}
                          placeholder="Enter task title"
                          required
                        />
                      </div>

                      {/* Task Description */}
                      <div className="form-group">
                        <label htmlFor="taskDescription">Task Description *</label>
                        <textarea
                          id="taskDescription"
                          rows={4}
                          value={taskForm.description}
                          onChange={(e) => setTaskForm({...taskForm, description: e.target.value})}
                          placeholder="Enter detailed task description"
                          required
                        />
                      </div>

                      {/* Phase Selection */}
                      <div className="form-group">
                        <label htmlFor="taskPhase">Project Phase *</label>
                        <div className="phase-selector left-aligned">
                          <div 
                            className="dropdown-trigger"
                            onClick={() => setShowAssignPhaseDropdown(!showAssignPhaseDropdown)}
                          >
                            <span>
                              {selectedAssignPhase 
                                ? `Phase ${selectedAssignPhase.phase_number}: ${selectedAssignPhase.title}`
                                : 'Select Phase'
                              }
                            </span>
                            <FaChevronDown className={`dropdown-icon ${showAssignPhaseDropdown ? 'open' : ''}`} />
                          </div>
                          
                          {showAssignPhaseDropdown && (
                            <div className="dropdown-menu phase-dropdown">
                              {availableAssignPhases.map(phase => {
                                const now = new Date();
                                const startDate = new Date(phase.start_date);
                                const endDate = new Date(phase.end_date);
                                const isActive = now >= startDate && now <= endDate;
                                const isPast = now > endDate;
                                const isFuture = now < startDate;
                                
                                return (
                                  <div 
                                    key={phase.id}
                                    className={`dropdown-item phase-item ${isActive ? 'active' : isPast ? 'past disabled' : 'future'}`}
                                    onClick={() => {
                                      if (!isPast) {
                                        setSelectedAssignPhase(phase);
                                        setShowAssignPhaseDropdown(false);
                                      }
                                    }}
                                    style={{
                                      cursor: isPast ? 'not-allowed' : 'pointer',
                                      opacity: isPast ? 0.5 : 1
                                    }}
                                  >
                                    <div className="phase-item-content">
                                      <span className="phase-title">
                                        Phase {phase.phase_number}: {phase.title}
                                        {isPast && ' (Completed)'}
                                      </span>
                                      <small className="phase-dates">
                                        {formatDate(phase.start_date)} - {formatDate(phase.end_date)}
                                      </small>
                                      <span className={`phase-status-badge ${isActive ? 'active' : isPast ? 'past' : 'future'}`}>
                                        {isActive ? 'ACTIVE' : isPast ? 'COMPLETED' : 'UPCOMING'}
                                      </span>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Attempts */}
                      <div className="form-group">
                        <label htmlFor="maxAttempts">Maximum Attempts *</label>
                        <input
                          type="number"
                          id="maxAttempts"
                          min="1"
                          max="10"
                          value={taskForm.max_attempts}
                          onChange={(e) => setTaskForm({...taskForm, max_attempts: parseInt(e.target.value)})}
                          required
                        />
                      </div>

                      {/* Due Date and Time */}
                      <div className="form-row">
                        <div className="form-group">
                          <label htmlFor="dueDate">Due Date *</label>
                          <input
                            type="date"
                            id="taskDueDate"
                            min={selectedAssignPhase ? selectedAssignPhase.start_date.split('T')[0] : ''}
                            max={selectedAssignPhase ? selectedAssignPhase.end_date.split('T')[0] : ''}
                            value={taskForm.due_date}
                            onChange={(e) => {
                              const newDate = e.target.value;
                              const constraints = getPhaseTimeConstraints(newDate, selectedAssignPhase);
                              let newTime = taskForm.due_time;
                              
                              // Clear time if it's outside the valid range for the new date
                              if (newTime && ((constraints.min && newTime < constraints.min) || (constraints.max && newTime > constraints.max))) {
                                newTime = constraints.min || '';
                              }
                              
                              setTaskForm({
                                ...taskForm, 
                                due_date: newDate,
                                due_time: newTime
                              });
                              // Validate after a short delay to allow time input to be set
                              setTimeout(() => validateDateTimeRestrictions('due'), 100);
                            }}
                            required
                          />
                          {selectedAssignPhase && (
                            <small className="date-restriction-hint">
                              Must be between {formatDateTime(selectedAssignPhase.start_date)} and {formatDateTime(selectedAssignPhase.end_date)}
                            </small>
                          )}
                        </div>
                        <div className="form-group">
                          <label htmlFor="dueTime">Due Time *</label>
                          <input
                            type="time"
                            id="taskDueTime"
                            value={taskForm.due_time}
                            onChange={(e) => {
                              setTaskForm({...taskForm, due_time: e.target.value});
                              // Validate after a short delay to allow date input to be set
                              setTimeout(() => validateDateTimeRestrictions('due'), 100);
                            }}
                            min={getPhaseTimeConstraints(taskForm.due_date, selectedAssignPhase).min}
                            max={getPhaseTimeConstraints(taskForm.due_date, selectedAssignPhase).max}
                            required
                          />
                          {(() => {
                            const constraints = getPhaseTimeConstraints(taskForm.due_date, selectedAssignPhase);
                            return (constraints.min || constraints.max) && (
                              <small className="date-restriction-hint">
                                Time must be between {constraints.min || '00:00'} and {constraints.max || '23:59'} for this date
                              </small>
                            );
                          })()}
                        </div>
                      </div>

                      {/* Available Until */}
                      <div className="form-row">
                        <div className="form-group">
                          <label htmlFor="availableDate">Available Until Date</label>
                          <input
                            type="date"
                            id="taskAvailableUntil"
                            min={taskForm.due_date || (selectedAssignPhase ? selectedAssignPhase.start_date.split('T')[0] : '')}
                            max={selectedAssignPhase ? selectedAssignPhase.end_date.split('T')[0] : ''}
                            value={taskForm.available_until_date}
                            onChange={(e) => {
                              const newDate = e.target.value;
                              const constraints = getPhaseTimeConstraints(newDate, selectedAssignPhase);
                              let newTime = taskForm.available_until_time;
                              
                              // Clear time if it's outside the valid range for the new date
                              if (newTime && ((constraints.min && newTime < constraints.min) || (constraints.max && newTime > constraints.max))) {
                                newTime = constraints.min || '';
                              }
                              
                              setTaskForm({
                                ...taskForm, 
                                available_until_date: newDate,
                                available_until_time: newTime
                              });
                              // Validate after a short delay to allow time input to be set
                              setTimeout(() => validateDateTimeRestrictions('available'), 100);
                            }}
                          />
                          {selectedAssignPhase && (
                            <small className="date-restriction-hint">
                              Should be at or after due date, within phase period ({formatDateTime(selectedAssignPhase.start_date)} - {formatDateTime(selectedAssignPhase.end_date)})
                            </small>
                          )}
                        </div>
                        <div className="form-group">
                          <label htmlFor="availableTime">Available Until Time</label>
                          <input
                            type="time"
                            id="taskAvailableUntilTime"
                            value={taskForm.available_until_time}
                            onChange={(e) => {
                              setTaskForm({...taskForm, available_until_time: e.target.value});
                              // Validate after a short delay to allow date input to be set
                              setTimeout(() => validateDateTimeRestrictions('available'), 100);
                            }}
                            min={getPhaseTimeConstraints(taskForm.available_until_date, selectedAssignPhase).min}
                            max={getPhaseTimeConstraints(taskForm.available_until_date, selectedAssignPhase).max}
                          />
                          {(() => {
                            const constraints = getPhaseTimeConstraints(taskForm.available_until_date, selectedAssignPhase);
                            return (constraints.min || constraints.max) && (
                              <small className="date-restriction-hint">
                                Time must be between {constraints.min || '00:00'} and {constraints.max || '23:59'} for this date
                              </small>
                            );
                          })()}
                        </div>
                      </div>

                      {/* File Type Selection */}
                      <div className="form-group">
                        <label>Allowed File Types</label>
                        
                        {/* Quick Presets */}
                        <div className="file-type-presets">
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.length === 0 ? 'active' : ''}`}
                            onClick={() => setTaskForm({...taskForm, file_types_allowed: []})}
                          >
                            Any File Type
                          </button>
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.some(type => ['pdf', 'doc', 'docx', 'txt'].includes(type)) ? 'active' : ''}`}
                            onClick={() => {
                              const documentTypes = ['pdf', 'doc', 'docx', 'txt'];
                              const currentTypes = taskForm.file_types_allowed.filter(type => !documentTypes.includes(type));
                              const hasDocuments = taskForm.file_types_allowed.some(type => documentTypes.includes(type));
                              setTaskForm({
                                ...taskForm, 
                                file_types_allowed: hasDocuments ? currentTypes : [...currentTypes, ...documentTypes]
                              });
                            }}
                          >
                            Documents
                          </button>
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.some(type => ['jpg', 'png', 'gif', 'svg'].includes(type)) ? 'active' : ''}`}
                            onClick={() => {
                              const imageTypes = ['jpg', 'png', 'gif', 'svg'];
                              const currentTypes = taskForm.file_types_allowed.filter(type => !imageTypes.includes(type));
                              const hasImages = taskForm.file_types_allowed.some(type => imageTypes.includes(type));
                              setTaskForm({
                                ...taskForm, 
                                file_types_allowed: hasImages ? currentTypes : [...currentTypes, ...imageTypes]
                              });
                            }}
                          >
                            Images
                          </button>
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.some(type => ['js', 'py', 'html', 'css', 'java'].includes(type)) ? 'active' : ''}`}
                            onClick={() => {
                              const codeTypes = ['js', 'py', 'html', 'css', 'java'];
                              const currentTypes = taskForm.file_types_allowed.filter(type => !codeTypes.includes(type));
                              const hasCode = taskForm.file_types_allowed.some(type => codeTypes.includes(type));
                              setTaskForm({
                                ...taskForm, 
                                file_types_allowed: hasCode ? currentTypes : [...currentTypes, ...codeTypes]
                              });
                            }}
                          >
                            Code
                          </button>
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.some(type => ['mp4', 'mp3', 'avi', 'wav'].includes(type)) ? 'active' : ''}`}
                            onClick={() => {
                              const mediaTypes = ['mp4', 'mp3', 'avi', 'wav'];
                              const currentTypes = taskForm.file_types_allowed.filter(type => !mediaTypes.includes(type));
                              const hasMedia = taskForm.file_types_allowed.some(type => mediaTypes.includes(type));
                              setTaskForm({
                                ...taskForm, 
                                file_types_allowed: hasMedia ? currentTypes : [...currentTypes, ...mediaTypes]
                              });
                            }}
                          >
                            Media
                          </button>
                          <button
                            type="button"
                            className={`preset-btn ${taskForm.file_types_allowed.some(type => ['zip', 'xlsx', 'pptx'].includes(type)) ? 'active' : ''}`}
                            onClick={() => {
                              const otherTypes = ['zip', 'xlsx', 'pptx'];
                              const currentTypes = taskForm.file_types_allowed.filter(type => !otherTypes.includes(type));
                              const hasOther = taskForm.file_types_allowed.some(type => otherTypes.includes(type));
                              setTaskForm({
                                ...taskForm, 
                                file_types_allowed: hasOther ? currentTypes : [...currentTypes, ...otherTypes]
                              });
                            }}
                          >
                            Archives & Office
                          </button>
                          <button
                            type="button"
                            className={`preset-btn custom-btn ${expandedCategories.custom ? 'active' : ''}`}
                            onClick={() => {
                              // When custom is selected, ensure "Any file type" is unselected
                              if (!expandedCategories.custom && taskForm.file_types_allowed.length === 0) {
                                // If currently "Any File Type" is selected, we need to give it some initial selection
                                setTaskForm({...taskForm, file_types_allowed: ['pdf']});
                              }
                              setExpandedCategories(prev => ({ ...prev, custom: !prev.custom }));
                            }}
                          >
                            Custom
                          </button>
                        </div>

                        {/* Custom Options - directly under Custom button */}
                        {expandedCategories.custom && (
                          <div className="file-type-custom">
                            {Object.entries(fileTypeCategories).map(([category, extensions]) => (
                              <div key={category} className="compact-category">
                                <div 
                                  className="category-toggle"
                                  onClick={() => setExpandedCategories(prev => ({ ...prev, [category]: !prev[category] }))}
                                >
                                  <span className="toggle-icon">
                                    {expandedCategories[category] ? '‚ñº' : '‚ñ∂'}
                                  </span>
                                  <span className="category-name">{category}</span>
                                  <span className="selected-in-category">
                                    {extensions.filter(ext => taskForm.file_types_allowed.includes(ext)).length}/{extensions.length}
                                  </span>
                                </div>
                                
                                {expandedCategories[category] && (
                                  <div className="category-options">
                                    <div className="quick-actions">
                                      <button
                                        type="button"
                                        className="mini-btn"
                                        onClick={() => {
                                          const newTypes = [...new Set([...taskForm.file_types_allowed, ...extensions])];
                                          setTaskForm({...taskForm, file_types_allowed: newTypes});
                                        }}
                                      >
                                        Add All
                                      </button>
                                      <button
                                        type="button"
                                        className="mini-btn"
                                        onClick={() => {
                                          setTaskForm({
                                            ...taskForm,
                                            file_types_allowed: taskForm.file_types_allowed.filter(type => !extensions.includes(type))
                                          });
                                        }}
                                      >
                                        Remove All
                                      </button>
                                    </div>
                                    <div className="file-type-options">
                                      {extensions.map(ext => (
                                        <label key={ext} className="compact-checkbox">
                                          <input
                                            type="checkbox"
                                            checked={taskForm.file_types_allowed.includes(ext)}
                                            onChange={(e) => {
                                              if (e.target.checked) {
                                                setTaskForm({
                                                  ...taskForm,
                                                  file_types_allowed: [...taskForm.file_types_allowed, ext]
                                                });
                                              } else {
                                                setTaskForm({
                                                  ...taskForm,
                                                  file_types_allowed: taskForm.file_types_allowed.filter(type => type !== ext)
                                                });
                                              }
                                            }}
                                          />
                                          .{ext}
                                        </label>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}

                        {/* Integrated Selection Summary */}
                        {taskForm.file_types_allowed.length > 0 && (
                          <div className="integrated-selection">
                            <div className="selection-header">
                              <span className="selection-count">{taskForm.file_types_allowed.length} type{taskForm.file_types_allowed.length > 1 ? 's' : ''} selected:</span>
                            </div>
                            <div className="selected-file-badges">
                              {taskForm.file_types_allowed.map(type => (
                                <span key={type} className="mini-file-badge">.{type}</span>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* "Any file type allowed" moved to below file types selection */}
                        {taskForm.file_types_allowed.length === 0 && (
                          <div className="current-selection">
                            <div className="no-restrictions">
                              Any file type allowed
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Submit Button */}
                      <div className="form-actions">
                        <button
                          type="submit"
                          className="create-task-btn"
                          disabled={submittingTask || !selectedAssignPhase}
                        >
                          {submittingTask ? (
                            <>
                              <div className="loading-spinner"></div>
                              Creating Task...
                            </>
                          ) : (
                            <>
                              <FaPlus />
                              Create Task
                            </>
                          )}
                        </button>
                      </div>
                    </form>
                  </div>
                ) : (
                  <div className="no-member-selected">
                    <FaUserCheck size={32} />
                    <h4>Select a Member</h4>
                    <p>Choose a group member to assign a new task</p>
                  </div>
                )}
                </div>
              </div>
            </div>
          </div>
              </div>
            </div>
          )}

          {/* Task Management Mode */}
          {currentTaskMode === 'management' && (
            <div className="task-mode-content apple-style">
              <div className="apple-header">
                <h2>Task Management</h2>
                <button className="apple-close-btn" onClick={handleCloseTaskMode}>
                  <FaTimes />
                </button>
              </div>

              <div className="apple-content">
                {loadingAssignedTasks ? (
                  <div className="apple-loading">
                    <div className="apple-spinner"></div>
                    <p>Loading tasks...</p>
                  </div>
                ) : assignedTasks.length > 0 ? (
                  <div className="apple-layout">
                    {/* Team Filter Pills */}
                    <div className="team-filter-section">
                      <div className="filter-pills-container">
                        <div className="filter-pills">
                          <button 
                            className={`filter-pill ${selectedMemberForTasks === 'all' ? 'active' : ''}`}
                            onClick={() => handleMemberSelectForTasks('all')}
                          >
                            <span className="pill-icon">üë•</span>
                            All Team
                            <span className="pill-indicator">
                              {assignedTasks.length > 0 && (
                                <span className="task-indicator-dot"></span>
                              )}
                            </span>
                          </button>
                          
                          {groupMembers.map(member => {
                            const taskCount = memberTaskCounts[member.student_id] || 0;
                            const isUnderMinimum = taskLimits && taskCount < taskLimits.min_tasks;
                            const isAtMaximum = taskLimits && taskCount >= taskLimits.max_tasks;
                            
                            return (
                              <button 
                                key={member.student_id}
                                className={`filter-pill ${selectedMemberForTasks?.student_id === member.student_id ? 'active' : ''} ${isUnderMinimum ? 'under-minimum' : ''} ${isAtMaximum ? 'at-maximum' : ''}`}
                                onClick={() => handleMemberSelectForTasks(member)}
                              >
                                <div className="pill-avatar">
                                  {member.studentaccounts?.profile_image_url ? (
                                    <img 
                                      src={getProfileImageUrl(member.studentaccounts)} 
                                      alt={member.studentaccounts.first_name}
                                    />
                                  ) : (
                                    <span className="pill-initials">
                                      {member.studentaccounts.first_name?.charAt(0)}
                                      {member.studentaccounts.last_name?.charAt(0)}
                                    </span>
                                  )}
                                </div>
                                <span className="pill-name">
                                  {member.studentaccounts.first_name}
                                </span>
                                <div className="pill-indicators">
                                  {taskCount > 0 && <span className="pill-count">{taskCount}</span>}
                                  {isUnderMinimum && <span className="status-dot under-min" title={`Needs ${taskLimits.min_tasks - taskCount} more task${taskLimits.min_tasks - taskCount > 1 ? 's' : ''}`}>!</span>}
                                  {isAtMaximum && <span className="status-dot at-max" title="At maximum task limit">‚úì</span>}
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Task Limits Info */}
                      {taskLimits && (
                        <div className="task-limits-info">
                          <span className="limits-text">
                            Task limits: {taskLimits.min_tasks} - {taskLimits.max_tasks} per member
                          </span>
                        </div>
                      )}
                    </div>
                    
                    {/* Tasks Section */}
                    <div className="tasks-section">
                      <div className="section-title">
                        {selectedMemberForTasks === 'all' 
                          ? 'All Assigned Tasks'
                          : `${filteredTasks.length} assigned task${filteredTasks.length !== 1 ? 's' : ''} for ${selectedMemberForTasks?.studentaccounts?.first_name} ${selectedMemberForTasks?.studentaccounts?.last_name}`
                        }
                      </div>
                      
                      <div className="apple-tasks-grid">
                        {filteredTasks.map(task => (
                          <div 
                            key={task.id} 
                            className="apple-task-card clickable"
                            onClick={() => handleEditTask(task)}
                          >
                            <div className="task-header">
                              <h3>{task.title}</h3>
                              <div className="task-menu" onClick={(e) => e.stopPropagation()}>
                                <button 
                                  className="menu-btn edit"
                                  onClick={() => handleEditTask(task)}
                                  title="Edit task"
                                >
                                  <FaEdit />
                                </button>
                                <button 
                                  className="menu-btn delete"
                                  onClick={() => handleDeleteTask(task)}
                                  title="Delete task"
                                >
                                  <FaTimes />
                                </button>
                              </div>
                            </div>
                            
                            <div className="task-content">
                              <p className="task-desc">{task.description}</p>
                              
                              <div className="task-details">
                                <div className="detail-section">
                                  <h4 className="section-title">Assignment</h4>
                                  <div className="detail-row">
                                    <span className="detail-label">Assigned to</span>
                                    <span className="detail-value">{task.assigned_to_name}</span>
                                  </div>
                                  <div className="detail-row">
                                    <span className="detail-label">Status</span>
                                    <span className={`status-indicator ${
                                      task.submissions_count === 0 ? 'no-submission' : 
                                      task.status.toLowerCase().replace('_', '-')
                                    }`}>
                                      {task.submissions_count === 0 ? 'No Submission Yet' : 
                                       task.status.replace('_', ' ')}
                                    </span>
                                  </div>
                                  <div className="detail-row">
                                    <span className="detail-label">Submissions</span>
                                    <span className="detail-value submissions">{task.submissions_count}</span>
                                  </div>
                                </div>
                                
                                <div className="detail-section">
                                  <h4 className="section-title">Timeline</h4>
                                  <div className="detail-row">
                                    <span className="detail-label">Due date</span>
                                    <span className="detail-value">{formatDateTime(task.due_date)}</span>
                                  </div>
                                  {task.available_until && (
                                    <div className="detail-row">
                                      <span className="detail-label">Available until</span>
                                      <span className="detail-value">{formatDateTime(task.available_until)}</span>
                                    </div>
                                  )}
                                  {task.max_attempts && (
                                    <div className="detail-row">
                                      <span className="detail-label">Max attempts</span>
                                      <span className="detail-value">{task.max_attempts}</span>
                                    </div>
                                  )}
                                </div>
                                
                                {task.file_types_allowed && Array.isArray(task.file_types_allowed) && task.file_types_allowed.length > 0 && (
                                  <div className="detail-section">
                                    <h4 className="section-title">File Requirements</h4>
                                    <div className="detail-row">
                                      <span className="detail-label">Allowed types</span>
                                      <span className="detail-value file-types">{task.file_types_allowed.join(', ')}</span>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                            
                            <div className="task-click-hint">
                              <span>Click to edit</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="apple-empty-state">
                    <div className="empty-icon">üìã</div>
                    <h3>No tasks assigned yet</h3>
                    <p>Create your first task to get started</p>
                    <button 
                      className="apple-primary-btn"
                      onClick={() => handleTaskModeChange('assignment')}
                    >
                      Create First Task
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}
      
      {/* Modern Task Edit Modal */}
      {showEditTaskModal && editingTask && (
        <div className="modern-modal-overlay">
          <div className="modern-modal-content">
            <div className="modern-modal-header">
              <div className="modal-title-section">
                <h2>Edit Task</h2>
                <p className="modal-subtitle">{editingTask.title}</p>
              </div>
              <button className="modern-close-btn" onClick={handleCancelEditTask}>
                <FaTimes />
              </button>
            </div>
            
            <div className="modern-modal-body">
              <form onSubmit={handleUpdateTask} className="modern-edit-form">
                
                {/* Task Details */}
                <div className="form-section">
                  <div className="modern-form-group">
                    <label htmlFor="editTaskTitle">Task Title</label>
                    <input
                      type="text"
                      id="editTaskTitle"
                      className="modern-input"
                      value={editTaskForm.title}
                      onChange={(e) => setEditTaskForm({...editTaskForm, title: e.target.value})}
                      required
                      maxLength={100}
                      placeholder="Enter task title"
                    />
                  </div>

                  <div className="modern-form-group">
                    <label htmlFor="editTaskDescription">Description</label>
                    <textarea
                      id="editTaskDescription"
                      className="modern-textarea"
                      value={editTaskForm.description}
                      onChange={(e) => setEditTaskForm({...editTaskForm, description: e.target.value})}
                      required
                      rows={4}
                      maxLength={500}
                      placeholder="Describe the task requirements"
                    />
                  </div>

                  <div className="modern-form-group">
                    <label htmlFor="editTaskPhase">Phase</label>
                    <input
                      type="text"
                      id="editTaskPhase"
                      className="modern-input disabled-input"
                      value={editingTask?.phase_name || 'No phase assigned'}
                      disabled
                      readOnly
                    />
                    <small className="input-hint">Tasks are automatically assigned to the current project phase</small>
                  </div>

                  <div className="form-grid">
                    <div className="modern-form-group">
                      <label htmlFor="editDueDate">Due Date</label>
                      <input
                        type="date"
                        id="editDueDate"
                        className="modern-input"
                        value={editTaskForm.due_date}
                        onChange={(e) => {
                          console.log('Due date changed:', e.target.value);
                          const newDate = e.target.value;
                          const constraints = getTimeConstraints(newDate, editingTask);
                          let newTime = editTaskForm.due_time;
                          
                          // Clear time if it's outside the valid range for the new date
                          if (newTime && ((constraints.min && newTime < constraints.min) || (constraints.max && newTime > constraints.max))) {
                            newTime = constraints.min || '';
                          }
                          
                          setEditTaskForm({
                            ...editTaskForm, 
                            due_date: newDate,
                            due_time: newTime
                          });
                        }}
                        min={getPhaseStartDate(editingTask) ? new Date(getPhaseStartDate(editingTask)).toISOString().split('T')[0] : undefined}
                        max={getPhaseEndDate(editingTask) ? new Date(getPhaseEndDate(editingTask)).toISOString().split('T')[0] : undefined}
                        required
                      />
                      {getPhaseStartDate(editingTask) && getPhaseEndDate(editingTask) && (
                        <small className="input-hint">
                          Must be between {formatDate(getPhaseStartDate(editingTask))} and {formatDate(getPhaseEndDate(editingTask))}
                        </small>
                      )}
                    </div>
                    <div className="modern-form-group">
                      <label htmlFor="editDueTime">Due Time</label>
                      <input
                        type="time"
                        id="editDueTime"
                        className="modern-input"
                        value={editTaskForm.due_time}
                        onChange={(e) => {
                          console.log('Due time changed:', e.target.value);
                          setEditTaskForm({...editTaskForm, due_time: e.target.value});
                        }}
                        min={getTimeConstraints(editTaskForm.due_date, editingTask).min}
                        max={getTimeConstraints(editTaskForm.due_date, editingTask).max}
                        required
                      />
                      {(() => {
                        const constraints = getTimeConstraints(editTaskForm.due_date, editingTask);
                        return (constraints.min || constraints.max) && (
                          <small className="input-hint">
                            Time must be between {constraints.min || '00:00'} and {constraints.max || '23:59'} for this date
                          </small>
                        );
                      })()}
                    </div>
                  </div>

                  <div className="form-grid">
                    <div className="modern-form-group">
                      <label htmlFor="editAvailableDate">Available Until (Optional)</label>
                      <input
                        type="date"
                        id="editAvailableDate"
                        className="modern-input"
                        value={editTaskForm.available_until_date}
                        onChange={(e) => {
                          console.log('Available date changed:', e.target.value);
                          const newDate = e.target.value;
                          const constraints = getTimeConstraints(newDate, editingTask);
                          let newTime = editTaskForm.available_until_time;
                          
                          // Clear time if it's outside the valid range for the new date
                          if (newTime && ((constraints.min && newTime < constraints.min) || (constraints.max && newTime > constraints.max))) {
                            newTime = constraints.min || '';
                          }
                          
                          setEditTaskForm({
                            ...editTaskForm, 
                            available_until_date: newDate,
                            available_until_time: newTime
                          });
                        }}
                        min={editTaskForm.due_date || (getPhaseStartDate(editingTask) ? new Date(getPhaseStartDate(editingTask)).toISOString().split('T')[0] : undefined)}
                        max={getPhaseEndDate(editingTask) ? new Date(getPhaseEndDate(editingTask)).toISOString().split('T')[0] : undefined}
                      />
                      {getPhaseStartDate(editingTask) && getPhaseEndDate(editingTask) && (
                        <small className="input-hint">
                          Should be at or after due date, within phase period ({formatDate(getPhaseStartDate(editingTask))} - {formatDate(getPhaseEndDate(editingTask))})
                        </small>
                      )}
                    </div>
                    <div className="modern-form-group">
                      <label htmlFor="editAvailableTime">Available Until Time</label>
                      <input
                        type="time"
                        id="editAvailableTime"
                        className="modern-input"
                        value={editTaskForm.available_until_time}
                        onChange={(e) => {
                          console.log('Available time changed:', e.target.value);
                          setEditTaskForm({...editTaskForm, available_until_time: e.target.value});
                        }}
                        min={getTimeConstraints(editTaskForm.available_until_date, editingTask).min}
                        max={getTimeConstraints(editTaskForm.available_until_date, editingTask).max}
                      />
                      {(() => {
                        const constraints = getTimeConstraints(editTaskForm.available_until_date, editingTask);
                        return (constraints.min || constraints.max) && (
                          <small className="input-hint">
                            Time must be between {constraints.min || '00:00'} and {constraints.max || '23:59'} for this date
                          </small>
                        );
                      })()}
                    </div>
                  </div>

                  <div className="modern-form-group">
                    <label htmlFor="editMaxAttempts">Maximum Attempts</label>
                    <input
                      type="number"
                      id="editMaxAttempts"
                      className="modern-input"
                      min="1"
                      max="10"
                      value={editTaskForm.max_attempts}
                      onChange={(e) => setEditTaskForm({...editTaskForm, max_attempts: parseInt(e.target.value)})}
                      required
                    />
                  </div>
                </div>

                {/* File Types Section */}
                <div className="form-section">
                  <h3 className="simple-section-title">Allowed File Types</h3>
                  <p className="section-subtitle">Choose which file types members can submit</p>
                  
                  <div className="file-type-selection">
                    {/* Quick Presets */}
                    <div className="file-presets">
                      <button
                        type="button"
                        className={`preset-chip ${(!editTaskForm.file_types_allowed || editTaskForm.file_types_allowed.length === 0) ? 'active' : ''}`}
                        onClick={() => setEditTaskForm({...editTaskForm, file_types_allowed: []})}
                      >
                        Any File Type
                      </button>
                      
                      {Object.entries(fileTypeCategories).map(([category, extensions]) => (
                        <button
                          key={category}
                          type="button"
                          className={`preset-chip ${editTaskForm.file_types_allowed?.some(type => extensions.includes(type)) ? 'active' : ''}`}
                          onClick={() => {
                            const currentTypes = (editTaskForm.file_types_allowed || []).filter(type => !extensions.includes(type));
                            const hasTypes = (editTaskForm.file_types_allowed || []).some(type => extensions.includes(type));
                            setEditTaskForm({
                              ...editTaskForm, 
                              file_types_allowed: hasTypes ? currentTypes : [...currentTypes, ...extensions]
                            });
                          }}
                        >
                          {category === 'Documents' && 'üìÑ'} 
                          {category === 'Images' && 'üñºÔ∏è'} 
                          {category === 'Code' && 'üíª'} 
                          {category === 'Media' && 'üéµ'} 
                          {category === 'Other' && 'üì¶'} 
                          {category}
                        </button>
                      ))}
                      
                      <button
                        type="button"
                        className={`preset-chip custom-chip ${expandedCategories.editCustom ? 'active' : ''}`}
                        onClick={() => setExpandedCategories(prev => ({ ...prev, editCustom: !prev.editCustom }))}
                      >
                        ‚öôÔ∏è Custom
                      </button>
                    </div>

                    {/* Custom Options - shows when Custom is clicked */}
                    {expandedCategories.editCustom && (
                      <div className="custom-file-options">
                        <h4 className="custom-section-title">Select from categories or add custom types</h4>
                        {Object.entries(fileTypeCategories).map(([category, extensions]) => (
                          <div key={category} className="custom-category-section">
                            <div 
                              className="category-toggle"
                              onClick={() => setExpandedCategories(prev => ({ ...prev, [`edit${category}`]: !prev[`edit${category}`] }))}
                            >
                              <span className="toggle-icon">
                                {expandedCategories[`edit${category}`] ? '‚ñº' : '‚ñ∂'}
                              </span>
                              <span className="category-name">{category}</span>
                              <span className="selected-count">
                                {extensions.filter(ext => (editTaskForm.file_types_allowed || []).includes(ext)).length}/{extensions.length}
                              </span>
                            </div>
                            
                            {expandedCategories[`edit${category}`] && (
                              <div className="category-extensions">
                                <div className="quick-actions">
                                  <button
                                    type="button"
                                    className="mini-action-btn"
                                    onClick={() => {
                                      const newTypes = [...new Set([...(editTaskForm.file_types_allowed || []), ...extensions])];
                                      setEditTaskForm({...editTaskForm, file_types_allowed: newTypes});
                                    }}
                                  >
                                    Add All
                                  </button>
                                  <button
                                    type="button"
                                    className="mini-action-btn"
                                    onClick={() => {
                                      setEditTaskForm({
                                        ...editTaskForm,
                                        file_types_allowed: (editTaskForm.file_types_allowed || []).filter(type => !extensions.includes(type))
                                      });
                                    }}
                                  >
                                    Remove All
                                  </button>
                                </div>
                                <div className="extensions-grid">
                                  {extensions.map(ext => (
                                    <label key={ext} className="extension-checkbox">
                                      <input
                                        type="checkbox"
                                        checked={(editTaskForm.file_types_allowed || []).includes(ext)}
                                        onChange={(e) => {
                                          const currentTypes = editTaskForm.file_types_allowed || [];
                                          if (e.target.checked) {
                                            setEditTaskForm({
                                              ...editTaskForm,
                                              file_types_allowed: [...currentTypes, ext]
                                            });
                                          } else {
                                            setEditTaskForm({
                                              ...editTaskForm,
                                              file_types_allowed: currentTypes.filter(type => type !== ext)
                                            });
                                          }
                                        }}
                                      />
                                      <span className="extension-label">.{ext}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                        
                        {/* Custom File Type Input - only show when Custom is active */}
                        <div className="custom-type-input-section">
                          <h4 className="custom-input-title">Add Custom File Types</h4>
                          <input
                            type="text"
                            placeholder="Add custom file type (e.g., psd, ai)"
                            className="modern-input small"
                            onKeyPress={(e) => {
                              if (e.key === 'Enter') {
                                e.preventDefault();
                                const value = e.target.value.toLowerCase().replace('.', '');
                                if (value && !(editTaskForm.file_types_allowed || []).includes(value)) {
                                  setEditTaskForm({
                                    ...editTaskForm,
                                    file_types_allowed: [...(editTaskForm.file_types_allowed || []), value]
                                  });
                                  e.target.value = '';
                                }
                              }
                            }}
                          />
                          <small className="input-hint">Press Enter to add custom file type</small>
                        </div>
                      </div>
                    )}

                    {/* Selected File Types Display */}
                    {editTaskForm.file_types_allowed && editTaskForm.file_types_allowed.length > 0 && (
                      <div className="selected-types">
                        <p className="selected-label">Selected file types:</p>
                        <div className="selected-chips">
                          {editTaskForm.file_types_allowed.map(type => (
                            <span key={type} className="file-type-chip">
                              .{type}
                              <button
                                type="button"
                                onClick={() => {
                                  setEditTaskForm({
                                    ...editTaskForm,
                                    file_types_allowed: editTaskForm.file_types_allowed.filter(t => t !== type)
                                  });
                                }}
                                className="remove-type"
                              >
                                <FaTimes />
                              </button>
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Warning for existing submissions */}
                {editingTask.submissions_count > 0 && (
                  <div className="modern-warning">
                    <div className="warning-icon">
                      <FaExclamationTriangle />
                    </div>
                    <div className="warning-content">
                      <h4>Task has submissions</h4>
                      <p>This task has {editingTask.submissions_count} submission(s). The assigned member will be notified of any changes.</p>
                    </div>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="modern-modal-actions">
                  <button 
                    type="button" 
                    className="modern-btn secondary" 
                    onClick={handleCancelEditTask}
                  >
                    Cancel
                  </button>
                  <button 
                    type="submit" 
                    className="modern-btn primary" 
                    disabled={updatingTask}
                  >
                    {updatingTask ? (
                      <>
                        <div className="modern-spinner"></div>
                        Updating...
                      </>
                    ) : (
                      <>
                        <FaCheck />
                        Update Task
                      </>
                    )}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
      
      {!selectedAssignProject && (
        <div className="no-project-selected">
          <FaProjectDiagram size={48} />
          <h3>Select a Project</h3>
          <p>Choose a project to start assigning tasks to your team members</p>
        </div>
      )}
    </div>
  );
};



// Add Member Submissions section

// ‚úÖ ENHANCED: Member Submissions with Improved UI and Functionality
const renderMemberSubmissions = () => {
  // Check if user is a leader
  if (userRole !== 'leader') {
    return (
      <div className="member-submissions-access-denied">
        <div className="access-denied-content">
          <FaBan size={32} className="access-denied-icon" />
          <h3>Access Restricted</h3>
          <p>Only group leaders can view member submissions.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="member-submissions-enhanced">
      {/* Header */}
      <div className="member-submissions-header">
        <h2>Member Submissions</h2>
        <div className="header-subtitle">Review and manage your team's task submissions</div>
        
        {/* Project and Phase Selectors */}
        <div className="selectors-row">
          {/* Project Selector */}
          <div className="selector-container">
            <label>Project:</label>
            <div 
              className="dropdown-trigger"
              onClick={() => setShowMemberSubmissionsDropdown(!showMemberSubmissionsDropdown)}
            >
              <span>
                {memberSubmissionsView.selectedProject 
                  ? activeProjects.find(p => p.id === memberSubmissionsView.selectedProject)?.title || 'Select Project'
                  : 'Select Project'
                }
              </span>
              <FaChevronDown className={`dropdown-icon ${showMemberSubmissionsDropdown ? 'open' : ''}`} />
            </div>
            
            {showMemberSubmissionsDropdown && (
              <div className="dropdown-menu">
                {activeProjects.map(project => (
                  <div 
                    key={project.id}
                    className="dropdown-item"
                    onClick={() => {
                      handleProjectSelectionForSubmissions({ target: { value: project.id } });
                      setShowMemberSubmissionsDropdown(false);
                    }}
                  >
                    <div className="project-item-content">
                      <span className="project-title">{project.title}</span>
                      <small className="project-due">Due: {formatDateTime(project.due_date)}</small>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Phase Selector */}
          {memberSubmissionsView.selectedProject && (
            <div className="selector-container">
              <label>Phase:</label>
              <div 
                className="dropdown-trigger"
                onClick={() => setShowMemberPhaseDropdown(!showMemberPhaseDropdown)}
              >
                <span>
                  {memberSubmissionsView.selectedPhase 
                    ? `Phase ${memberSubmissionsView.selectedPhase.phase_number}: ${memberSubmissionsView.selectedPhase.title}`
                    : 'All Phases'
                  }
                </span>
                <FaChevronDown className={`dropdown-icon ${showMemberPhaseDropdown ? 'open' : ''}`} />
              </div>
              
              {showMemberPhaseDropdown && (
                <div className="dropdown-menu">
                  <div 
                    className="dropdown-item"
                    onClick={() => {
                      setMemberSubmissionsView(prev => ({ ...prev, selectedPhase: null }));
                      setShowMemberPhaseDropdown(false);
                    }}
                  >
                    <span>All Phases</span>
                  </div>
                  {memberSubmissionsView.projectPhases.map(phase => (
                    <div 
                      key={phase.phase_number}
                      className="dropdown-item"
                      onClick={() => {
                        setMemberSubmissionsView(prev => ({ ...prev, selectedPhase: phase }));
                        setShowMemberPhaseDropdown(false);
                      }}
                    >
                      <div className="phase-item-content">
                        <span className="phase-title">Phase {phase.phase_number}: {phase.title}</span>
                        <small className="phase-dates">
                          {formatDateTime(phase.start_date)} - {formatDateTime(phase.end_date)}
                        </small>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {memberSubmissionsView.selectedProject && (
        <div className="submissions-workspace">
          {/* Team Members Sidebar */}
          <div className="members-panel">
            <div className="panel-header">
              <h4><FaUsers /> Team Members</h4>
              <span className="member-count">{memberSubmissionsView.projectMembers.length}</span>
            </div>
            
            <div className="members-list">
              {memberSubmissionsView.loading ? (
                <div className="loading-state">
                  <div className="spinner"></div>
                  <span>Loading members...</span>
                </div>
              ) : (
                memberSubmissionsView.projectMembers.map(member => (
                  <div 
                    key={member.student_id}
                    className={`member-card ${
                      memberSubmissionsView.selectedMember?.student_id === member.student_id 
                        ? 'selected' 
                        : ''
                    }`}
                    onClick={() => handleMemberSelection(member)}
                  >
                    <div className="member-avatar">
                      {member.profile_image ? (
                        <img src={member.profile_image} alt={member.name} />
                      ) : (
                        <div className="avatar-placeholder">
                          {member.name.charAt(0).toUpperCase()}
                        </div>
                      )}
                    </div>
                    <div className="member-info">
                      <div className="member-name">{member.name}</div>
                      <div className="member-stats">
                        <span className="tasks-completed">{member.completed_tasks || 0} completed</span>
                        <span className="tasks-pending">{member.pending_tasks || 0} pending</span>
                      </div>
                    </div>
                    {memberSubmissionsView.selectedMember?.student_id === member.student_id && (
                      <div className="selected-indicator">
                        <FaCheck />
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Submissions Content */}
          <div className="submissions-main-content">
            {memberSubmissionsView.selectedMember ? (
              <>
                {/* Selected Member Header */}
                <div className="selected-member-header">
                  <div className="member-details">
                    <div className="member-avatar-large">
                      {memberSubmissionsView.selectedMember.profile_image ? (
                        <img src={memberSubmissionsView.selectedMember.profile_image} alt={memberSubmissionsView.selectedMember.name} />
                      ) : (
                        <div className="avatar-placeholder-large">
                          {memberSubmissionsView.selectedMember.name.charAt(0).toUpperCase()}
                        </div>
                      )}
                    </div>
                    <div className="member-info-detailed">
                      <h3>{memberSubmissionsView.selectedMember.name}</h3>
                      <p className="member-email">{memberSubmissionsView.selectedMember.email}</p>
                      <div className="member-stats-detailed">
                        <span className="stat-item">
                          <FaTasks /> {memberSubmissionsView.selectedMember.total_tasks || 0} Tasks
                        </span>
                        <span className="stat-item">
                          <FaCheckCircle /> {memberSubmissionsView.selectedMember.completed_tasks || 0} Completed
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Task Submissions */}
                <div className="task-submissions-section">
                  {memberSubmissionsView.loading ? (
                    <div className="loading-state">
                      <div className="spinner"></div>
                      <span>Loading submissions...</span>
                    </div>
                  ) : memberSubmissionsView.memberSubmissions.length > 0 ? (
                    <div className="submissions-grid">
                      {memberSubmissionsView.memberSubmissions.map(task => (
                        <TaskSubmissionCard 
                          key={task.id} 
                          task={task}
                          onApprove={handleApproveSubmission}
                          onRequestRevision={handleRequestRevision}
                          loading={memberSubmissionsView.loading}
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="empty-submissions">
                      <FaClipboardList size={48} />
                      <h4>No Task Submissions</h4>
                      <p>This member hasn't been assigned any tasks yet.</p>
                    </div>
                  )}
                </div>
              </>
            ) : (
              <div className="no-member-selected">
                <FaUserCheck size={48} />
                <h4>Select a Team Member</h4>
                <p>Choose a team member from the left panel to review their submissions.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {!memberSubmissionsView.selectedProject && (
        <div className="no-project-selected">
          <FaProjectDiagram size={48} />
          <h4>Select a Project</h4>
          <p>Choose a project to view team member submissions.</p>
        </div>
      )}
    </div>
  );
};

// ‚úÖ Enhanced Attempt History Section Component
const AttemptHistorySection = ({ activity, onSubmitFeedback }) => {
  const [submissionHistory, setSubmissionHistory] = useState([]);
  const [loadingHistory, setLoadingHistory] = useState(false);
  const [expandedAttempt, setExpandedAttempt] = useState(1); // Auto-expand first attempt for better UX
  const [feedbackInputs, setFeedbackInputs] = useState({});
  const [submittingFeedback, setSubmittingFeedback] = useState({});

  // Load submission history when activity changes
  useEffect(() => {
    if (activity?.id) {
      loadSubmissionHistoryForActivity();
    }
  }, [activity?.id]);

  const loadSubmissionHistoryForActivity = async () => {
    setLoadingHistory(true);
    try {
      const history = await loadSubmissionHistory(activity.id);
      setSubmissionHistory(history);
    } catch (error) {
      console.error('Error loading submission history:', error);
      setSubmissionHistory([]);
    } finally {
      setLoadingHistory(false);
    }
  };

  const handleFeedbackSubmit = async (submissionId, submissionType) => {
    const feedbackText = feedbackInputs[submissionId];
    if (!feedbackText || feedbackText.trim() === '') {
      alert('Please enter feedback before submitting.');
      return;
    }

    const feedbackKey = `${submissionId}_${submissionType}`;
    setSubmittingFeedback(prev => ({ ...prev, [feedbackKey]: true }));

    try {
      await onSubmitFeedback(submissionId, feedbackText, submissionType);
      
      // Clear the feedback input
      setFeedbackInputs(prev => ({ ...prev, [submissionId]: '' }));
      
      // Reload submission history to show new feedback
      await loadSubmissionHistoryForActivity();
      
      alert('Feedback submitted successfully!');
    } catch (error) {
      alert(`Failed to submit feedback: ${error.message}`);
    } finally {
      setSubmittingFeedback(prev => ({ ...prev, [feedbackKey]: false }));
    }
  };

  const getStatusBadgeClass = (status) => {
    switch (status) {
      case 'pending': return 'status-pending';
      case 'approved': return 'status-approved';
      case 'revision_requested': return 'status-revision';
      case 'completed': return 'status-completed';
      case 'rejected': return 'status-rejected';
      default: return 'status-default';
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'pending': return 'Under Review';
      case 'approved': return 'Approved';
      case 'revision_requested': return 'Revision Requested';
      case 'completed': return 'Completed';
      case 'rejected': return 'Rejected';
      default: return status?.replace('_', ' ') || 'Unknown';
    }
  };

  if (loadingHistory) {
    return (
      <div className="canvas-detail-section">
        <h4 className="canvas-section-title">Submission History</h4>
        <div className="loading-state">
          <div className="spinner"></div>
          <span>Loading submission history...</span>
        </div>
      </div>
    );
  }

  if (!submissionHistory || submissionHistory.length === 0) {
    return (
      <div className="canvas-detail-section">
        <h4 className="canvas-section-title">Submission History</h4>
        <div className="no-submissions-message">
          <FaInfoCircle />
          <span>No submissions yet. Submit your work using the button below.</span>
        </div>
      </div>
    );
  }

  return (
    <div className="canvas-detail-section attempt-history-section">
      <div className="section-header-new">
        <h4 className="section-title-new">
          <FaHistory /> Submission History
        </h4>
        <span className="attempt-count-badge">
          {submissionHistory.length} {submissionHistory.length === 1 ? 'Attempt' : 'Attempts'}
        </span>
      </div>

      <div className="attempts-container">
        {submissionHistory.map((attempt, attemptIndex) => (
          <div key={attempt.attempt_number} className="attempt-card">
            {/* Attempt Header */}
            <div className="attempt-card-header">
              <div className="attempt-title-section">
                <h5 className="attempt-title">Attempt {attempt.attempt_number}</h5>
                <span className="attempt-timestamp">
                  <FaClock /> {formatDateTime(attempt.original_submission.submitted_at)}
                </span>
              </div>
              <button 
                className={`expand-toggle ${expandedAttempt === attempt.attempt_number ? 'expanded' : ''}`}
                onClick={() => setExpandedAttempt(
                  expandedAttempt === attempt.attempt_number ? null : attempt.attempt_number
                )}
                aria-label={expandedAttempt === attempt.attempt_number ? 'Collapse' : 'Expand'}
              >
                <FaChevronDown className="expand-icon" />
              </button>
            </div>

            {/* Attempt Body */}
            {expandedAttempt === attempt.attempt_number && (
              <div className="attempt-card-body">
                {/* Original Submission Section */}
                <div className="submission-panel">
                  <div className="panel-header">
                    <div className="panel-title">
                      <FaFile className="panel-icon" />
                      <span>Original Submission</span>
                    </div>
                    <span className={`status-pill ${getStatusBadgeClass(attempt.original_submission.status)}`}>
                      {getStatusLabel(attempt.original_submission.status)}
                    </span>
                  </div>

                  <div className="panel-content">
                    {/* Submission Text */}
                    {attempt.original_submission.submission_text && (
                      <div className="content-section">
                        <label className="section-label">Description</label>
                        <p className="section-text">{attempt.original_submission.submission_text}</p>
                      </div>
                    )}

                    {/* Submitted Files */}
                    {attempt.original_submission.file_urls && attempt.original_submission.file_urls.length > 0 && (
                      <div className="content-section">
                        <label className="section-label">Submitted Files</label>
                        <div className="files-grid">
                          {attempt.original_submission.file_urls.map((url, index) => (
                            <a 
                              key={`original-file-${attempt.attempt_number}-${index}-${url.split('/').pop()}`}
                              href={url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="file-item"
                            >
                              <FaFileAlt className="file-icon" />
                              <span className="file-name">File {index + 1}</span>
                              <FaExternalLinkAlt className="external-icon" />
                            </a>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Leader's Feedback */}
                    {(attempt.original_submission.status === 'revision_requested' || attempt.original_submission.status === 'approved') && (
                      <div className="content-section leader-review-section">
                        <label className="section-label">
                          <FaUserTie className="label-icon" />
                          Leader's Review
                        </label>
                        <div className={`review-card ${attempt.original_submission.status === 'approved' ? 'approved' : 'revision'}`}>
                          <div className="review-badge-container">
                            <span className={`review-badge ${attempt.original_submission.status === 'approved' ? 'approved' : 'revision'}`}>
                              {attempt.original_submission.status === 'approved' ? (
                                <><FaCheckCircle /> Approved</>
                              ) : (
                                <><FaEdit /> Revision Requested</>
                              )}
                            </span>
                          </div>
                          <p className="review-message">
                            {attempt.original_submission.status === 'approved' 
                              ? 'Great work! This submission has been approved.' 
                              : 'Please address the feedback and submit a revision.'}
                          </p>
                        </div>
                      </div>
                    )}

                    {/* Team Feedback */}
                    <div className="content-section team-feedback-section">
                      <label className="section-label">
                        <FaComments className="label-icon" />
                        Team Feedback 
                        <span className="feedback-count">({attempt.feedback?.length || 0})</span>
                      </label>
                      
                      {attempt.feedback && attempt.feedback.length > 0 ? (
                        <div className="feedback-thread">
                          {attempt.feedback.map((feedback, index) => (
                            <div key={`feedback-${feedback.id || `${feedback.author_name}-${feedback.created_at}-${index}`}`} className="feedback-item">
                              <div className="feedback-avatar">
                                {feedback.author_profile_image ? (
                                  <img src={feedback.author_profile_image} alt={feedback.author_name} className="avatar-img" />
                                ) : (
                                  <div className="avatar-placeholder-new">
                                    {feedback.author_name.charAt(0).toUpperCase()}
                                  </div>
                                )}
                              </div>
                              <div className="feedback-body">
                                <div className="feedback-meta">
                                  <span className="feedback-author-name">{feedback.author_name}</span>
                                  <span className="feedback-timestamp">{formatDateTime(feedback.created_at)}</span>
                                </div>
                                <div className="feedback-text">
                                  {feedback.feedback_text}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="no-feedback-placeholder">
                          <FaComment className="placeholder-icon" />
                          <span>No team feedback yet</span>
                        </div>
                      )}

                      {/* Add Feedback */}
                      <div className="feedback-input-section">
                        <textarea
                          className="feedback-textarea"
                          placeholder="Add your feedback for this submission..."
                          value={feedbackInputs[attempt.original_submission.id] || ''}
                          onChange={(e) => setFeedbackInputs(prev => ({ 
                            ...prev, 
                            [attempt.original_submission.id]: e.target.value 
                          }))}
                          rows="3"
                        />
                        <button
                          className="submit-feedback-button"
                          onClick={() => handleFeedbackSubmit(attempt.original_submission.id, 'original')}
                          disabled={submittingFeedback[`${attempt.original_submission.id}_original`]}
                        >
                          {submittingFeedback[`${attempt.original_submission.id}_original`] ? (
                            <><FaSpinner className="spinning" /> Submitting...</>
                          ) : (
                            <><FaPaperPlane /> Submit Feedback</>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Revision Submissions */}
                {attempt.revisions && attempt.revisions.length > 0 && (
                  <div className="revisions-container">
                    {attempt.revisions.map((revision, revisionIndex) => (
                      <div key={revision.revision_number} className="submission-panel revision-panel">
                        <div className="panel-header">
                          <div className="panel-title">
                            <FaEdit className="panel-icon" />
                            <span>Revision {revision.revision_number}</span>
                          </div>
                          <span className={`status-pill ${getStatusBadgeClass(revision.status)}`}>
                            {getStatusLabel(revision.status)}
                          </span>
                        </div>

                        <div className="panel-content">
                          {/* Revision Timestamp */}
                          <div className="revision-meta">
                            <FaClock className="meta-icon" />
                            <span>Submitted {formatDateTime(revision.submitted_at)}</span>
                          </div>

                          {/* Revision Text */}
                          {revision.submission_text && (
                            <div className="content-section">
                              <label className="section-label">Description</label>
                              <p className="section-text">{revision.submission_text}</p>
                            </div>
                          )}

                          {/* Revision Files */}
                          {revision.file_urls && revision.file_urls.length > 0 && (
                            <div className="content-section">
                              <label className="section-label">Submitted Files</label>
                              <div className="files-grid">
                                {revision.file_urls.map((url, index) => (
                                  <a 
                                    key={`revision-file-${revision.revision_number}-${index}-${url.split('/').pop()}`}
                                    href={url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="file-item"
                                  >
                                    <FaFileAlt className="file-icon" />
                                    <span className="file-name">File {index + 1}</span>
                                    <FaExternalLinkAlt className="external-icon" />
                                  </a>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Leader's Review Comments */}
                          {revision.review_comments && (
                            <div className="content-section leader-review-section">
                              <label className="section-label">
                                <FaUserTie className="label-icon" />
                                Leader's Comments
                              </label>
                              <div className="review-card">
                                <p className="review-message">{revision.review_comments}</p>
                              </div>
                            </div>
                          )}

                          {/* Team Feedback for Revision */}
                          <div className="content-section team-feedback-section">
                            <label className="section-label">
                              <FaComments className="label-icon" />
                              Team Feedback
                              <span className="feedback-count">({revision.feedback?.length || 0})</span>
                            </label>
                            
                            {revision.feedback && revision.feedback.length > 0 ? (
                              <div className="feedback-thread">
                                {revision.feedback.map((feedback, index) => (
                                  <div key={`revision-feedback-${feedback.id || `${feedback.author_name}-${feedback.created_at}-${index}`}`} className="feedback-item">
                                    <div className="feedback-avatar">
                                      {feedback.author_profile_image ? (
                                        <img src={feedback.author_profile_image} alt={feedback.author_name} className="avatar-img" />
                                      ) : (
                                        <div className="avatar-placeholder-new">
                                          {feedback.author_name.charAt(0).toUpperCase()}
                                        </div>
                                      )}
                                    </div>
                                    <div className="feedback-body">
                                      <div className="feedback-meta">
                                        <span className="feedback-author-name">{feedback.author_name}</span>
                                        <span className="feedback-timestamp">{formatDateTime(feedback.created_at)}</span>
                                      </div>
                                      <div className="feedback-text">
                                        {feedback.feedback_text}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="no-feedback-placeholder">
                                <FaComment className="placeholder-icon" />
                                <span>No team feedback yet</span>
                              </div>
                            )}

                            {/* Add Feedback for Revision */}
                            <div className="feedback-input-section">
                              <textarea
                                className="feedback-textarea"
                                placeholder="Add your feedback for this revision..."
                                value={feedbackInputs[revision.id] || ''}
                                onChange={(e) => setFeedbackInputs(prev => ({ 
                                  ...prev, 
                                  [revision.id]: e.target.value 
                                }))}
                                rows="3"
                              />
                              <button
                                className="submit-feedback-button"
                                onClick={() => handleFeedbackSubmit(revision.id, 'revision')}
                                disabled={submittingFeedback[`${revision.id}_revision`]}
                              >
                                {submittingFeedback[`${revision.id}_revision`] ? (
                                  <><FaSpinner className="spinning" /> Submitting...</>
                                ) : (
                                  <><FaPaperPlane /> Submit Feedback</>
                                )}
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};

// ‚úÖ ENHANCED Individual Task Submission Card Component with Feedback System
const TaskSubmissionCard = ({ task, onApprove, onRequestRevision, loading }) => {
  const [expandedSection, setExpandedSection] = useState(null);
  const [feedbackText, setFeedbackText] = useState('');
  const [submittingAction, setSubmittingAction] = useState(false);

  const getStatusBadgeClass = (status) => {
    switch (status) {
      case 'pending': return 'status-pending';
      case 'approved': return 'status-approved';
      case 'revision_requested': return 'status-revision';
      case 'completed': return 'status-completed';
      case 'rejected': return 'status-rejected';
      default: return 'status-default';
    }
  };

  const getStatusLabel = (status, isRevision = false) => {
    switch (status) {
      case 'pending': return isRevision ? 'Waiting Decision' : 'Under Review';
      case 'approved': return 'Approved';
      case 'revision_requested': return 'Needs Revision';
      case 'completed': return 'Completed';
      case 'rejected': return 'Rejected';
      case 'not_submitted': return 'Not Submitted';
      default: return status?.replace('_', ' ') || 'Unknown';
    }
  };

  const getMostRecentSubmission = (task) => {
    console.log('üîç getMostRecentSubmission called for task:', task.task_title || task.title);
    console.log('üîç Task attempts:', task.attempts);
    
    if (!task.attempts || task.attempts.length === 0) {
      console.log('üîç No attempts found for task');
      return null;
    }
    
    const lastAttempt = task.attempts[task.attempts.length - 1];
    console.log('üîç Last attempt:', lastAttempt);
    
    if (lastAttempt.revisions && lastAttempt.revisions.length > 0) {
      const latestRevision = lastAttempt.revisions[lastAttempt.revisions.length - 1];
      console.log('üîç Returning latest revision:', latestRevision);
      return {
        ...latestRevision,
        type: 'revision',
        attempt_info: `Attempt ${lastAttempt.attempt_number} (Revision ${latestRevision.revision_number})`
      };
    }
    
    console.log('üîç Returning original submission:', lastAttempt.original_submission);
    return {
      ...lastAttempt.original_submission,
      type: 'original',
      attempt_info: `Attempt ${lastAttempt.attempt_number}`
    };
  };

  const mostRecentSubmission = getMostRecentSubmission(task);

  const handleApproveClick = async () => {
    console.log('üîç handleApproveClick called');
    console.log('üîç selectedAttempt:', submissionCheckingView.selectedAttempt);
    console.log('üîç feedbackText:', feedbackText);
    
    if (!submissionCheckingView.selectedAttempt) {
      console.log('üîç No selectedAttempt, returning');
      return;
    }
    
    setSubmittingAction(true);
    try {
      console.log('üîç Calling onApprove with:', submissionCheckingView.selectedAttempt.id, feedbackText, submissionCheckingView.selectedAttempt.type);
      await onApprove(submissionCheckingView.selectedAttempt.id, feedbackText, submissionCheckingView.selectedAttempt.type);
      setFeedbackText('');
      console.log('üîç Approve successful');
    } catch (error) {
      console.error('Error approving submission:', error);
    } finally {
      setSubmittingAction(false);
    }
  };

  const handleRequestRevisionClick = async () => {
    console.log('üîç handleRequestRevisionClick called');
    console.log('üîç selectedAttempt:', submissionCheckingView.selectedAttempt);
    console.log('üîç feedbackText:', feedbackText);
    
    if (!submissionCheckingView.selectedAttempt || !feedbackText.trim()) {
      alert('Please provide feedback when requesting revision.');
      return;
    }
    
    setSubmittingAction(true);
    try {
      console.log('üîç Calling onRequestRevision with:', submissionCheckingView.selectedAttempt.id, feedbackText, submissionCheckingView.selectedAttempt.type);
      await onRequestRevision(submissionCheckingView.selectedAttempt.id, feedbackText, submissionCheckingView.selectedAttempt.type);
      setFeedbackText('');
      console.log('üîç Request revision successful');
    } catch (error) {
      console.error('Error requesting revision:', error);
    } finally {
      setSubmittingAction(false);
    }
  };

  return (
    <div className="enhanced-task-card">
      {/* Card Header */}
      <div className="task-card-header">
        <div className="task-info">
          <h4 className="task-title">{task.title}</h4>
          <div className="task-metadata">
            <span className="task-due">
              <FaClock /> Due: {formatDateTime(task.due_date)}
            </span>
            {task.phase_info && (
              <span className="task-phase">
                <FaProjectDiagram /> Phase {task.phase_info.phase_number}: {task.phase_info.title}
              </span>
            )}
            <span className="attempt-count">
              <FaTasks /> {task.total_attempts}/{task.max_attempts === -1 ? '‚àû' : task.max_attempts} attempts
            </span>
          </div>
        </div>
        <div className="task-status-section">
          <span className={`status-badge ${getStatusBadgeClass(task.current_submission_status)}`}>
            {getStatusLabel(task.current_submission_status)}
          </span>
        </div>
      </div>

      {/* Task Description */}
      {task.description && (
        <div className="task-description">
          <p>{task.description}</p>
        </div>
      )}

      {/* Latest Submission Summary */}
      {mostRecentSubmission && (
        <div className="latest-submission-summary">
          <div className="summary-header">
            <h5><FaPaperPlane /> Latest Submission</h5>
            <span className="submission-info">{mostRecentSubmission.attempt_info}</span>
          </div>
          
          <div className="submission-preview">
            <div className="submission-meta">
              <span className="submitted-date">
                <FaClock /> {formatDateTime(mostRecentSubmission.submitted_at)}
              </span>
              <span className={`submission-status ${getStatusBadgeClass(mostRecentSubmission.status)}`}>
                {getStatusLabel(mostRecentSubmission.status)}
              </span>
            </div>
            
            {mostRecentSubmission.submission_text && (
              <div className="submission-text-preview">
                <p>{mostRecentSubmission.submission_text.length > 150 
                  ? mostRecentSubmission.submission_text.substring(0, 150) + '...' 
                  : mostRecentSubmission.submission_text}
                </p>
              </div>
            )}
            
            {mostRecentSubmission.file_urls && mostRecentSubmission.file_urls.length > 0 && (
              <div className="file-count">
                <FaFile /> {mostRecentSubmission.file_urls.length} file(s) attached
              </div>
            )}
          </div>

          {/* Show existing feedback for latest submission */}
          {mostRecentSubmission.feedback && mostRecentSubmission.feedback.length > 0 && (
            <div className="existing-feedback">
              <h6><FaComments /> Team Feedback</h6>
              <div className="feedback-list">
                {mostRecentSubmission.feedback.map((feedback, index) => (
                  <div key={index} className="feedback-item">
                    <div className="feedback-author">
                      <div className="author-avatar">
                        {feedback.author_profile_image ? (
                          <img src={feedback.author_profile_image} alt={feedback.author_name} />
                        ) : (
                          <div className="avatar-placeholder">
                            {feedback.author_name.charAt(0).toUpperCase()}
                          </div>
                        )}
                      </div>
                      <div className="author-details">
                        <span className="author-name">{feedback.author_name}</span>
                        <span className="feedback-time">{formatDateTime(feedback.created_at)}</span>
                      </div>
                    </div>
                    <div className="feedback-content">
                      {feedback.feedback_text}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Action Section for Submissions */}
      {submissionCheckingView.selectedAttempt && (
        <div className="action-section">
          <div className="feedback-input-section">
            <label><FaComment /> Add Your Feedback:</label>
            <textarea
              placeholder="Enter your feedback here..."
              value={feedbackText}
              onChange={(e) => setFeedbackText(e.target.value)}
              rows="3"
              className="feedback-textarea"
            />
          </div>
          
          <div className="action-buttons">
            {(() => {
              // Check if there's an approved attempt in this task (other than the current one)
              const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                att.status === 'approved' && att.id !== submissionCheckingView.selectedAttempt?.id
              );
              // Disable buttons if: current is approved OR there's another approved attempt
              // EXCEPTION: If current is a pending revision submission, keep buttons ENABLED
              const isCurrentApproved = submissionCheckingView.selectedAttempt?.status === 'approved';
              const isCurrentPendingRevision = submissionCheckingView.selectedAttempt?.status === 'pending' && submissionCheckingView.selectedAttempt?.isRevisionSubmission;
              const shouldDisableButtons = (isCurrentApproved || hasOtherApprovedAttempt) && !isCurrentPendingRevision;
              
              console.log('üîç Button logic debug:');
              console.log('  - selectedTask attempts:', submissionCheckingView.selectedTask?.attempts);
              console.log('  - selectedAttempt:', submissionCheckingView.selectedAttempt);
              console.log('  - isCurrentApproved:', isCurrentApproved);
              console.log('  - isCurrentPendingRevision:', isCurrentPendingRevision);
              console.log('  - hasOtherApprovedAttempt:', hasOtherApprovedAttempt);
              console.log('  - shouldDisableButtons:', shouldDisableButtons);
              
              return (
                <>
                  <button
                    className="btn btn-revision"
                    onClick={handleRequestRevisionClick}
                    disabled={submittingAction || loading || shouldDisableButtons}
                    title={shouldDisableButtons ? isCurrentApproved ? "This attempt is already approved" : "Cannot approve/revise when another attempt is already approved" : ""}
                    style={shouldDisableButtons ? { opacity: 0.5, cursor: 'not-allowed' } : {}}
                  >
                    {submittingAction ? (
                      <><FaSpinner className="spinning" /> Processing...</>
                    ) : (
                      <><FaEdit /> Request Revision</>
                    )}
                  </button>
                  <button
                    className="btn btn-approve"
                    onClick={handleApproveClick}
                    disabled={submittingAction || loading || shouldDisableButtons}
                    title={shouldDisableButtons ? isCurrentApproved ? "This attempt is already approved" : "Cannot approve/revise when another attempt is already approved" : ""}
                    style={shouldDisableButtons ? { opacity: 0.5, cursor: 'not-allowed' } : {}}
                  >
                    {submittingAction ? (
                      <><FaSpinner className="spinning" /> Processing...</>
                    ) : (
                      <><FaCheck /> Approve</>
                    )}
                  </button>
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* Expandable Sections */}
      <div className="expandable-sections">
        {/* Full Submission Details */}
        {mostRecentSubmission && (
          <div className="expandable-section">
            <div 
              className="section-toggle"
              onClick={() => setExpandedSection(expandedSection === 'details' ? null : 'details')}
            >
              <span><FaInfoCircle /> Full Submission Details</span>
              <FaChevronDown className={`expand-icon ${expandedSection === 'details' ? 'open' : ''}`} />
            </div>
            
            {expandedSection === 'details' && (
              <div className="section-content">
                <div className="full-submission-content">
                  {mostRecentSubmission.submission_text && (
                    <div className="full-text">
                      <h6>Submission Text:</h6>
                      <p>{mostRecentSubmission.submission_text}</p>
                    </div>
                  )}
                  
                  {mostRecentSubmission.file_urls && mostRecentSubmission.file_urls.length > 0 && (
                    <div className="submission-files">
                      <h6>Attached Files:</h6>
                      <div className="file-list">
                        {mostRecentSubmission.file_urls.map((url, index) => (
                          <a 
                            key={index} 
                            href={url} 
                            target="_blank" 
                            rel="noopener noreferrer" 
                            className="file-link"
                          >
                            <FaFile /> {url.split('/').pop() || `File ${index + 1}`}
                          </a>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {mostRecentSubmission.review_comments && (
                    <div className="review-comments">
                      <h6>Previous Review Comments:</h6>
                      <p>{mostRecentSubmission.review_comments}</p>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Submission History */}
        {task.attempts && task.attempts.length > 0 && (
          <div className="expandable-section">
            <div 
              className="section-toggle"
              onClick={() => setExpandedSection(expandedSection === 'history' ? null : 'history')}
            >
              <span><FaHistory /> Complete History ({task.attempts.length} attempts)</span>
              <FaChevronDown className={`expand-icon ${expandedSection === 'history' ? 'open' : ''}`} />
            </div>
            
            {expandedSection === 'history' && (
              <div className="section-content">
                <div className="submission-history">
                  {task.attempts.map(attempt => (
                    <div key={attempt.attempt_number} className="attempt-group">
                      <div className="attempt-header">
                        <h6>Attempt {attempt.attempt_number}</h6>
                        <span className="attempt-date">
                          {formatDateTime(attempt.original_submission.submitted_at)}
                        </span>
                      </div>
                      
                      {/* Original Submission */}
                      <div className="submission-item original">
                        <div className="submission-type-badge">Original</div>
                        <div className="submission-content">
                          {attempt.original_submission.submission_text && (
                            <p className="submission-text">{attempt.original_submission.submission_text}</p>
                          )}
                          {attempt.original_submission.file_urls && attempt.original_submission.file_urls.length > 0 && (
                            <div className="file-links">
                              {attempt.original_submission.file_urls.map((url, idx) => (
                                <a key={idx} href={url} target="_blank" rel="noopener noreferrer">
                                  <FaFile /> File {idx + 1}
                                </a>
                              ))}
                            </div>
                          )}
                          <span className={`status-badge ${getStatusBadgeClass(attempt.original_submission.status)}`}>
                            {getStatusLabel(attempt.original_submission.status)}
                          </span>
                          
                          {/* Show feedback for original submission */}
                          {attempt.original_submission.feedback && attempt.original_submission.feedback.length > 0 && (
                            <div className="submission-feedback">
                              <h7>Feedback:</h7>
                              {attempt.original_submission.feedback.map((fb, fbIndex) => (
                                <div key={fbIndex} className="feedback-bubble">
                                  <strong>{fb.author_name}:</strong> {fb.feedback_text}
                                  <small>({formatDateTime(fb.created_at)})</small>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Revisions */}
                      {attempt.revisions && attempt.revisions.map(revision => (
                        <div key={revision.revision_number} className="submission-item revision">
                          <div className="submission-type-badge revision">Revision {revision.revision_number}</div>
                          <div className="submission-content">
                            {revision.submission_text && (
                              <p className="submission-text">{revision.submission_text}</p>
                            )}
                            {revision.file_urls && revision.file_urls.length > 0 && (
                              <div className="file-links">
                                {revision.file_urls.map((url, idx) => (
                                  <a key={idx} href={url} target="_blank" rel="noopener noreferrer">
                                    <FaFile /> File {idx + 1}
                                  </a>
                                ))}
                              </div>
                            )}
                            <span className={`status-badge ${getStatusBadgeClass(revision.status)}`}>
                              {getStatusLabel(revision.status, true)}
                            </span>
                            <div className="revision-date">{formatDateTime(revision.submitted_at)}</div>
                            
                            {/* Show feedback for revision */}
                            {revision.feedback && revision.feedback.length > 0 && (
                              <div className="submission-feedback">
                                <h7>Feedback:</h7>
                                {revision.feedback.map((fb, fbIndex) => (
                                  <div key={fbIndex} className="feedback-bubble">
                                    <strong>{fb.author_name}:</strong> {fb.feedback_text}
                                    <small>({formatDateTime(fb.created_at)})</small>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// =================== SUBMISSION CHECKING RENDER ===================
const renderSubmissionChecking = () => {
  // Helper function to safely get file URLs as an array
  const getFileUrlsArray = (fileUrls) => {
    if (!fileUrls) return [];
    if (Array.isArray(fileUrls)) return fileUrls;
    if (typeof fileUrls === 'string') {
      try {
        const parsed = JSON.parse(fileUrls);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [fileUrls]; // If it's a single URL string
      }
    }
    return [];
  };

  // Download file for submission checking
  const downloadSubmissionFile = async (fileUrl, fileName) => {
    try {
      console.log('üì• Downloading submission file:', fileUrl);
      
      const token = localStorage.getItem('token');
      const response = await fetch(
        `${apiConfig.baseURL}/api/student/download-file?fileUrl=${encodeURIComponent(fileUrl)}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      );

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Download failed with response:', errorText);
        throw new Error('Failed to download file');
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName || 'downloaded_file';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      
      console.log('‚úÖ File downloaded successfully:', fileName);
    } catch (error) {
      console.error('Download error:', error);
      alert('Failed to download file. Please try again.');
    }
  };

  const handleProjectSelect = async (project) => {
    setSubmissionCheckingView(prev => ({
      ...prev,
      selectedProject: project,
      showProjectDropdown: false,
      loading: true
    }));

    try {
      // Load submission checking data for the selected project
      const token = localStorage.getItem('token');
      
      // Fetch project phases
      const phasesResponse = await fetch(
        `${apiConfig.baseURL}/api/projects/${project.id}/phases`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!phasesResponse.ok) throw new Error('Failed to load phases');
      
      const phasesData = await phasesResponse.json();
      const phases = phasesData.phases || [];
      
      console.log('üìã [Submission Checking] Loaded phases:', phases.map(p => ({ id: p.id, phase_number: p.phase_number, title: p.title })));
      
      // Detect current phase
      const today = new Date();
      const currentPhase = phases.find(phase => {
        const start = new Date(phase.start_date);
        const end = new Date(phase.end_date);
        return today >= start && today <= end;
      }) || phases[0]; // Default to first phase if none is current
      
      // Fetch submissions for current phase
      let submissions = [];
      if (currentPhase) {
        const submissionsResponse = await fetch(
          `${apiConfig.baseURL}/api/submission-checking/${project.id}/phase/${currentPhase.id}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (submissionsResponse.ok) {
          const submissionsData = await submissionsResponse.json();
          submissions = submissionsData.submissions || [];
        }
      }
      
      setSubmissionCheckingView(prev => ({
        ...prev,
        phases: phases,
        selectedPhase: currentPhase,
        detailsData: submissions,
        loading: false
      }));
    } catch (error) {
      console.error('Error loading submission checking data:', error);
      setSubmissionCheckingView(prev => ({
        ...prev,
        loading: false
      }));
    }
  };

  const handlePhaseSelect = async (phase) => {
    setSubmissionCheckingView(prev => ({
      ...prev,
      selectedPhase: phase,
      loading: true
    }));

    try {
      const token = localStorage.getItem('token');
      const submissionsResponse = await fetch(
        `${apiConfig.baseURL}/api/submission-checking/${submissionCheckingView.selectedProject.id}/phase/${phase.id}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (submissionsResponse.ok) {
        const submissionsData = await submissionsResponse.json();
        setSubmissionCheckingView(prev => ({
          ...prev,
          detailsData: submissionsData.submissions || [],
          loading: false
        }));
      }
    } catch (error) {
      console.error('Error loading phase submissions:', error);
      setSubmissionCheckingView(prev => ({
        ...prev,
        loading: false
      }));
    }
  };

  // Sort submissions
  const sortedSubmissions = [...(submissionCheckingView.detailsData || [])].sort((a, b) => {
    if (submissionCheckingSortBy === 'date') {
      return new Date(b.submittedAt || 0) - new Date(a.submittedAt || 0);
    } else if (submissionCheckingSortBy === 'name') {
      return (a.memberName || '').localeCompare(b.memberName || '');
    } else if (submissionCheckingSortBy === 'status') {
      const statusOrder = { pending: 1, revision: 2, approved: 3 };
      return (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
    }
    return 0;
  });

  return (
    <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: '24px', flex: 1, overflow: 'auto' }}>
      {/* Loading State */}
      {submissionCheckingView.loading ? (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaSpinner style={{ 
              fontSize: '36px', 
              color: '#872341',
              animation: 'spin 1s linear infinite' 
            }} />
            <span style={{ 
              color: '#FAF8F1',
              fontSize: '14px',
              fontWeight: '500'
            }}>
              Loading submission data...
            </span>
          </div>
        </div>
      ) : submissionCheckingView.selectedProject ? (
        <>
          {/* Main Layout Wrapper - Left Column + Details Card Side by Side */}
          <div style={{
            display: 'flex',
            flexDirection: 'row',
            gap: '24px',
            alignItems: 'flex-start',
            flex: 1,
            minWidth: 0
          }}>
            {/* Left Column Wrapper - Phase Info + Member Submissions */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '0px',
              width: '330px'
            }}>
            {/* Phase Info Card - Separate */}
            <div className="my-group-card-with-crosshair" style={{
              background: 'rgba(9, 18, 44, 0.15)',
              backdropFilter: 'blur(3.2px) saturate(120%)',
              WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
              border: '0.1px solid #5f5f5f',
              borderRadius: '0px',
              padding: '24px',
              width: '330px',
              marginTop: '50px'
            }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>

            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '16px'
            }}>
            {/* Left Side - Phase Selector */}
            <div>
              {/* Phase Circle Rectangle */}
              <div style={{
                backgroundColor: '#F9FAFB',
                border: '2px solid #E5E7EB',
                borderRadius: '12px',
                padding: '16px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '12px',
                marginBottom: '12px'
              }}>
                {/* Phase Circle */}
                <div style={{
                  width: '84px',
                  height: '84px',
                  borderRadius: '50%',
                  backgroundColor: '#34656D',
                  color: 'white',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '36px',
                  fontWeight: '700',
                  boxShadow: '0 4px 12px rgba(52, 101, 109, 0.3)',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease',
                  position: 'relative'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.transform = 'scale(1.05)';
                  e.currentTarget.style.boxShadow = '0 6px 16px rgba(52, 101, 109, 0.4)';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.transform = 'scale(1)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.3)';
                }}
                onClick={() => {
                  // Show phase selector modal or dropdown
                  const phaseSelect = document.getElementById('phase-select-input');
                  if (phaseSelect) phaseSelect.click();
                }}
                >
                  {submissionCheckingView.selectedPhase?.phase_number || '?'}
                  <div style={{
                    fontSize: '10px',
                    fontWeight: '500',
                    marginTop: '4px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px'
                  }}>
                    Phase
                  </div>
                </div>

                {/* Phase Selector Dropdown */}
                <select
                  id="phase-select-input"
                  value={submissionCheckingView.selectedPhase?.id || ''}
                  onChange={(e) => {
                    const selectedPhase = submissionCheckingView.phases?.find(p => p.id === e.target.value);
                    if (selectedPhase) handlePhaseSelect(selectedPhase);
                  }}
                  style={{
                    width: '100%',
                    padding: '8px 12px',
                    backgroundColor: 'white',
                    border: '1px solid #E5E7EB',
                    borderRadius: '6px',
                    fontSize: '13px',
                    fontWeight: '500',
                    color: '#504B38',
                    cursor: 'pointer'
                  }}
                >
                  <option value="">
                    {submissionCheckingView.phases && submissionCheckingView.phases.length > 0 
                      ? 'Select a phase...'
                      : 'No phases available'}
                  </option>
                  {submissionCheckingView.phases && submissionCheckingView.phases.length > 0 && submissionCheckingView.phases.map(phase => (
                    <option key={phase.id} value={phase.id}>
                      Phase {phase.phase_number}: {phase.title || 'Untitled'}
                    </option>
                  ))}
                </select>
              </div>

              {/* Date Pills - Single Row */}
              <div style={{
                display: 'flex',
                flexDirection: 'row',
                gap: '8px'
              }}>
                {/* Start Date Pill */}
                <div style={{
                  flex: 1,
                  backgroundColor: 'white',
                  border: '1px solid #D1FAE5',
                  borderRadius: '20px',
                  padding: '8px 12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    backgroundColor: '#D1FAE5',
                    color: '#059669',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '14px',
                    flexShrink: 0
                  }}>
                    <FaCalendar />
                  </div>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{
                      fontSize: '9px',
                      color: '#6B7280',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '2px'
                    }}>
                      Start
                    </div>
                    <div style={{
                      fontSize: '11px',
                      color: '#059669',
                      fontWeight: '600',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      whiteSpace: 'nowrap'
                    }}>
                      {submissionCheckingView.selectedPhase?.start_date 
                        ? new Date(submissionCheckingView.selectedPhase.start_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                          })
                        : 'Not set'
                      }
                    </div>
                  </div>
                </div>

                {/* End Date Pill */}
                <div style={{
                  flex: 1,
                  backgroundColor: 'white',
                  border: '1px solid #FEE2E2',
                  borderRadius: '20px',
                  padding: '8px 12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    backgroundColor: '#FEE2E2',
                    color: '#DC2626',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '14px',
                    flexShrink: 0
                  }}>
                    <FaCalendar />
                  </div>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{
                      fontSize: '9px',
                      color: '#6B7280',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '2px'
                    }}>
                      End
                    </div>
                    <div style={{
                      fontSize: '11px',
                      color: '#DC2626',
                      fontWeight: '600',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      whiteSpace: 'nowrap'
                    }}>
                      {submissionCheckingView.selectedPhase?.end_date 
                        ? new Date(submissionCheckingView.selectedPhase.end_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                          })
                        : 'Not set'
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          {/* Member Submissions Card */}
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            padding: '24px',
            minHeight: '90px',
            height:'350px',
            marginTop: '24px'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>

            {/* Card Title */}
            <h3 style={{
              margin: '0 0 20px 0',
              fontSize: '20px',
              fontWeight: '600',
              color: '#FFFFFF',
              display: 'flex',
              alignItems: 'center',
              gap: '10px'
            }}>
              <FaClipboardList style={{ color: '#fbfbfbff' }} />
              Member Submissions
            </h3>

            {/* Submissions List Section */}
            <div>
              {/* Sort By Dropdown */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '16px'
              }}>
                <h3 style={{
                  margin: 0,
                  fontSize: '18px',
                  fontWeight: '600',
                  color: '#FAF8F1'
                }}>
                  Submissions List
                </h3>
                <div style={{ position: 'relative' }}>
                  <button
                    onClick={() => setShowSubmissionCheckingSortDropdown(!showSubmissionCheckingSortDropdown)}
                    style={{
                      padding: '8px 16px',
                      background: 'rgba(14, 25, 60, 0.3)',
                      border: '1px solid rgba(225, 117, 100, 0.3)',
                      borderRadius: '6px',
                      fontSize: '13px',
                      fontWeight: '500',
                      color: '#FAF8F1',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => {
                      e.currentTarget.style.background = 'rgba(14, 25, 60, 0.5)';
                      e.currentTarget.style.borderColor = 'rgba(225, 117, 100, 0.5)';
                    }}
                    onMouseOut={(e) => {
                      e.currentTarget.style.background = 'rgba(14, 25, 60, 0.3)';
                      e.currentTarget.style.borderColor = 'rgba(225, 117, 100, 0.3)';
                    }}
                  >
                    <FaSort />
                    Sort by: {submissionCheckingSortBy === 'date' ? 'Date' : submissionCheckingSortBy === 'name' ? 'Name' : 'Status'}
                    <FaChevronDown style={{ fontSize: '10px' }} />
                  </button>
                  {showSubmissionCheckingSortDropdown && (
                    <div style={{
                      position: 'absolute',
                      top: '100%',
                      right: 0,
                      marginTop: '4px',
                      background: 'rgba(14, 25, 60, 0.95)',
                      backdropFilter: 'blur(10px)',
                      WebkitBackdropFilter: 'blur(10px)',
                      border: '1px solid rgba(225, 117, 100, 0.3)',
                      borderRadius: '6px',
                      boxShadow: '0 4px 6px rgba(0, 0, 0, 0.3)',
                      zIndex: 1001,
                      minWidth: '150px'
                    }}>
                      {['date', 'name', 'status'].map(option => (
                        <div
                          key={option}
                          onClick={() => {
                            setSubmissionCheckingSortBy(option);
                            setShowSubmissionCheckingSortDropdown(false);
                          }}
                          style={{
                            padding: '10px 16px',
                            cursor: 'pointer',
                            fontSize: '13px',
                            fontWeight: '500',
                            color: submissionCheckingSortBy === option ? '#FAF8F1' : '#EBE5C2',
                            backgroundColor: submissionCheckingSortBy === option ? 'rgba(225, 117, 100, 0.3)' : 'transparent',
                            transition: 'background-color 0.2s'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'rgba(225, 117, 100, 0.2)'}
                          onMouseOut={(e) => e.currentTarget.style.backgroundColor = submissionCheckingSortBy === option ? 'rgba(225, 117, 100, 0.3)' : 'transparent'}
                        >
                          {option === 'date' ? 'Date' : option === 'name' ? 'Name' : 'Status'}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Submissions List */}
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '8px',
                height: '350px',
                overflowY: 'auto',
                paddingRight: '8px'
              }}>
                {sortedSubmissions.length > 0 ? (
                  sortedSubmissions.map((submission, index) => (
                    <button
                      key={index}
                      onClick={() => {
                        // submission is now a grouped task with attempts array
                        const latestAttempt = submission.attempts && submission.attempts.length > 0 
                          ? submission.attempts[submission.attempts.length - 1] 
                          : null;
                        
                        setSubmissionCheckingView(prev => ({
                          ...prev,
                          selectedTask: submission,
                          selectedAttempt: latestAttempt,
                          selectedSubmission: latestAttempt // For backward compatibility
                        }));
                      }}
                      style={{
                        padding: '10px 14px',
                        backgroundColor: 'rgb(255 255 255)',
                        border: 'none',
                        borderRadius: '10px',
                        textAlign: 'left',
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '8px',
                        position: 'relative',
                        minHeight: '85px'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.transform = 'translateX(4px)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(225, 117, 100, 0.3)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.transform = 'translateX(0)';
                        e.currentTarget.style.boxShadow = 'none';
                      }}
                    >
                      {/* Status Badge - Top Right */}
                      <div style={{
                        position: 'absolute',
                        top: '12px',
                        right: '12px'
                      }}>
                        <span style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '4px',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '11px',
                          fontWeight: '600',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px',
                          backgroundColor: 
                            submission.latestStatus === 'pending' ? '#FEF3C7' :
                            submission.latestStatus === 'approved' ? '#D1FAE5' :
                            submission.latestStatus === 'revision_requested' ? '#FEE2E2' :
                            '#FEF3C7',
                          color:
                            submission.latestStatus === 'pending' ? '#D97706' :
                            submission.latestStatus === 'approved' ? '#059669' :
                            submission.latestStatus === 'revision_requested' ? '#DC2626' :
                            '#D97706'
                        }}>
                          {submission.latestStatus === 'pending' && <FaClock style={{ fontSize: '10px' }} />}
                          {submission.latestStatus === 'approved' && <FaCheck style={{ fontSize: '10px' }} />}
                          {submission.latestStatus === 'revision_requested' && <FaExclamationTriangle style={{ fontSize: '10px' }} />}
                          {submission.latestStatus === 'pending' && 'Pending'}
                          {submission.latestStatus === 'approved' && 'Approved'}
                          {submission.latestStatus === 'revision_requested' && 'Revision'}
                        </span>
                      </div>

                      {/* Member Info */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        marginBottom: '8px',
                        paddingRight: '100px' // Space for status badge
                      }}>
                        {submission.attempts && submission.attempts.length > 0 && submission.attempts[submission.attempts.length - 1].memberProfileImage ? (
                          <img 
                            src={submission.attempts[submission.attempts.length - 1].memberProfileImage} 
                            alt={submission.attempts[submission.attempts.length - 1].memberName}
                            style={{
                              width: '30px',
                              height: '30px',
                              borderRadius: '50%',
                              objectFit: 'cover',
                              border: '2px solid #E5E7EB',
                              flexShrink: 0
                            }}
                          />
                        ) : (
                          <div style={{
                            width: '30px',
                            height: '30px',
                            borderRadius: '50%',
                            backgroundColor: '#872341',
                            color: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '13px',
                            fontWeight: '600',
                          flexShrink: 0
                        }}>
                          {submission.attempts && submission.attempts.length > 0 ? submission.attempts[submission.attempts.length - 1].memberName?.charAt(0) || '?' : '?'}
                        </div>
                        )}
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#1F2937',
                            marginBottom: '2px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}>
                            {submission.attempts && submission.attempts.length > 0 ? submission.attempts[submission.attempts.length - 1].memberName : 'No submission'}
                          </div>
                          <div style={{
                            fontSize: '11px',
                            color: '#6B7280',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}>
                            {submission.taskTitle}
                          </div>
                        </div>
                      </div>

                      {/* Bottom Info */}
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        gap: '12px'
                      }}>
                        {/* Submitted Date */}
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px',
                          fontSize: '12px',
                          color: '#6B7280',
                          flex: 1,
                          minWidth: 0
                        }}>
                          <FaClock style={{ fontSize: '11px', flexShrink: 0 }} />
                          <span style={{
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}>
                            {(() => {
                              const latestAttempt = submission.attempts && submission.attempts.length > 0 
                                ? submission.attempts[submission.attempts.length - 1] 
                                : null;
                              const dateValue = latestAttempt?.submittedAt || latestAttempt?.submitted_at || latestAttempt?.created_at;
                              
                              return dateValue
                                ? new Date(dateValue).toLocaleString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                  })
                                : 'N/A';
                            })()}
                          </span>
                        </div>

                        {/* Attempts Badge - Only for pending/revision */}
                        {(submission.status === 'pending' || submission.status === 'revision') && (
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '4px',
                            padding: '4px 8px',
                            backgroundColor: '#F3F4F6',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: '600',
                            color: '#6B7280',
                            flexShrink: 0
                          }}>
                            <FaRedo style={{ fontSize: '10px' }} />
                            {submission.attempts || 0}/{submission.maxAttempts || '‚àû'}
                          </div>
                        )}
                      </div>
                    </button>
                  ))
                ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: '#EBE5C2'
                  }}>
                    <FaClipboardList style={{ fontSize: '48px', marginBottom: '12px', color: '#E17564' }} />
                    <p style={{ fontSize: '16px', fontWeight: '500', margin: 0, color: '#FAF8F1' }}>
                      No submissions for this phase
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
          </div>

          {/* Details Section - Separate Card */}
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid rgb(95, 95, 95)',
            borderRadius: '0px',
            padding: '24px',
            minHeight: '655px',
            height: '650px',
            flex: 1,
            minWidth: 0,
            display: 'flex',
            flexDirection: 'column',
            position: 'relative',
            marginTop: '50px'
          }}>
          <div className="crosshair-corner top-left" style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner top-right" style={{ pointerEvents: 'none', position: 'absolute', top: 0, right: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner bottom-left" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, left: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner bottom-right" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, right: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>

          {/* Scrollable Content Wrapper */}
          <div style={{
            flex: 1,
            overflowY: 'auto',
            overflowX: 'hidden',
            display: 'flex',
            flexDirection: 'column'
          }}>
          <h3 style={{
            margin: '0 0 20px 0',
            fontSize: '20px',
            fontWeight: '600',
            color: '#FAF8F1',
            display: 'flex',
            alignItems: 'center',
            gap: '10px'
          }}>
            <FaClipboardList style={{ color: '#E17564' }} />
            Details
          </h3>

          {submissionCheckingView.selectedSubmission ? (
              <div style={{
                display: 'grid',
                gridTemplateColumns: '2fr 1fr',
                gap: '24px'
              }}>
                {/* Left Column - Submission Details */}
                <div className="my-group-card-with-crosshair" style={{
                  background: '#FFFFFF',
                  border: '0.1px solid rgb(95, 95, 95)',
                  borderRadius: '0px',
                  padding: '24px',
                  position: 'relative'
                }}>
                  <div className="crosshair-corner top-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner top-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  {/* Header with Task Title */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'flex-start',
                    justifyContent: 'space-between',
                    marginBottom: '24px',
                    paddingBottom: '20px',
                    borderBottom: '2px solid rgb(95, 95, 95)',
                    gap: '16px'
                  }}>
                    <div style={{ flex: 1 }}>
                      <h3 style={{ margin: '0 0 12px 0', fontSize: '24px', fontWeight: '700', color: '#1F2937' }}>
                        {submissionCheckingView.selectedTask?.taskTitle || submissionCheckingView.selectedSubmission?.taskTitle}
                      </h3>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        fontSize: '14px',
                        color: '#6B7280'
                      }}>
                        <span style={{ fontWeight: '500' }}>Submitted by:</span>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          {submissionCheckingView.selectedSubmission.memberProfileImage ? (
                            <img 
                              src={submissionCheckingView.selectedSubmission.memberProfileImage} 
                              alt={submissionCheckingView.selectedSubmission.memberName}
                              style={{
                                width: '28px',
                                height: '28px',
                                borderRadius: '50%',
                                objectFit: 'cover',
                                border: '2px solid rgba(225, 117, 100, 0.5)'
                              }}
                            />
                          ) : (
                            <div style={{
                              width: '28px',
                              height: '28px',
                              borderRadius: '50%',
                              backgroundColor: '#E17564',
                              color: 'white',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: '600'
                            }}>
                              {submissionCheckingView.selectedSubmission.memberName?.charAt(0) || '?'}
                            </div>
                          )}
                          <span style={{ fontWeight: '600', color: '#1F2937' }}>
                            {submissionCheckingView.selectedSubmission.memberName}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* Status Badge */}
                    <span style={{
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '8px 16px',
                      borderRadius: '20px',
                      fontSize: '13px',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      whiteSpace: 'nowrap',
                      backgroundColor: (() => {
                        // Determine status: approved > revision_requested > pending
                        const hasApproved = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'approved');
                        const hasRevision = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'revision_requested');
                        
                        if (hasApproved) {
                          return '#D1FAE5';
                        } else if (hasRevision) {
                          return '#FEE2E2';
                        } else {
                          return '#FEF3C7';
                        }
                      })(),
                      color: (() => {
                        const hasApproved = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'approved');
                        const hasRevision = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'revision_requested');
                        
                        if (hasApproved) {
                          return '#059669';
                        } else if (hasRevision) {
                          return '#DC2626';
                        } else {
                          return '#D97706';
                        }
                      })()
                    }}>
                      {(() => {
                        const hasApproved = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'approved');
                        const hasRevision = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'revision_requested');
                        
                        if (hasApproved) {
                          return <FaCheck />;
                        } else if (hasRevision) {
                          return <FaExclamationTriangle />;
                        } else {
                          return <FaClock />;
                        }
                      })()}
                      {(() => {
                        const hasApproved = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'approved');
                        const hasRevision = submissionCheckingView.selectedTask?.attempts?.some(att => att.status === 'revision_requested');
                        
                        if (hasApproved) {
                          return 'Approved';
                        } else if (hasRevision) {
                          return 'Revision';
                        } else {
                          return 'Pending';
                        }
                      })()}
                    </span>
                  </div>

                  {/* Task Description */}
                  {submissionCheckingView.selectedTask?.taskDescription && (
                    <div style={{
                      backgroundColor: '#FFFFFF',
                      border: '1px solid #E5E7EB',
                      borderRadius: '8px',
                      padding: '16px',
                      marginBottom: '24px',
                      fontSize: '14px',
                      lineHeight: '1.6',
                      display: 'flex',
                      gap: '12px',
                      alignItems: 'flex-start'
                    }}>
                      <div style={{
                        flexShrink: 0,
                        fontSize: '18px',
                        color: '#6B7280',
                        marginTop: '2px'
                      }}>
                        <FaFileAlt />
                      </div>
                      <p style={{ margin: '0', color: '#374151', flex: 1 }}>
                        {submissionCheckingView.selectedTask.taskDescription}
                      </p>
                    </div>
                  )}

                  {/* Submission Info Grid */}
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '16px',
                  marginBottom: '24px'
                }}>
                  {/* Submitted On */}
                  <div style={{
                    backgroundColor: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)'
                  }}>
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Submitted On
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      {submissionCheckingView.selectedSubmission.submittedAt 
                        ? new Date(submissionCheckingView.selectedSubmission.submittedAt).toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })
                        : 'N/A'
                      }
                    </div>
                  </div>

                  {/* Phase */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)',
                    position: 'relative'
                  }}>
                   
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Phase
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      Phase {submissionCheckingView.selectedPhase?.phase_number}: {submissionCheckingView.selectedPhase?.title}
                    </div>
                  </div>

                  {/* Due On */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)',
                    position: 'relative'
                  }}>
                    
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Due On
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      {submissionCheckingView.selectedTask?.dueDate 
                        ? new Date(submissionCheckingView.selectedTask.dueDate).toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                          })
                        : 'Not set'
                      }
                    </div>
                  </div>

                  {/* Assigned On */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)',
                    position: 'relative'
                  }}>
                    
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Assigned On
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      {submissionCheckingView.selectedTask?.assignedDate 
                        ? new Date(submissionCheckingView.selectedTask.assignedDate).toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                          })
                        : 'Not set'
                      }
                    </div>
                  </div>

                  {/* Available Until */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)',
                    position: 'relative'
                  }}>
                   
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Available Until
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      {submissionCheckingView.selectedPhase?.end_date 
                        ? new Date(submissionCheckingView.selectedPhase.end_date).toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                          })
                        : 'Not set'
                      }
                    </div>
                  </div>

                  {/* File Types Allowed */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: '#09122C',
                    padding: '16px',
                    borderRadius: '0px',
                    border: '0.1px solid rgb(95, 95, 95)',
                    position: 'relative'
                  }}>
                    
                    <div style={{
                      fontSize: '11px',
                      color: '#E17564',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      File Types Allowed
                    </div>
                    <div style={{ fontSize: '14px', color: '#FAF8F1', fontWeight: '600' }}>
                      {(() => {
                        let allowedTypes = [];
                        const fileTypes = submissionCheckingView.selectedTask?.file_types_allowed;
                        
                        if (fileTypes) {
                          if (typeof fileTypes === 'string') {
                            // Try to parse as JSON first
                            try {
                              allowedTypes = JSON.parse(fileTypes);
                            } catch (e) {
                              // If not JSON, split by comma
                              allowedTypes = fileTypes.split(',').map(type => type.trim());
                            }
                          } else if (Array.isArray(fileTypes)) {
                            allowedTypes = fileTypes;
                          }
                        }
                        
                        return allowedTypes && allowedTypes.length > 0
                          ? allowedTypes.join(', ')
                          : 'All types';
                      })()}
                    </div>
                  </div>
                </div>

                {/* Approved Attempt Section */}
                {(() => {
                  const approvedAttempt = submissionCheckingView.selectedTask?.attempts?.find(att => att.status === 'approved');
                  const attemptIndex = submissionCheckingView.selectedTask?.attempts?.findIndex(att => att.status === 'approved');
                  const attemptNumber = submissionCheckingView.selectedTask?.attempts?.length - attemptIndex;
                  const isSelected = submissionCheckingView.selectedAttempt?.id === approvedAttempt?.id;
                  
                  return approvedAttempt ? (
                    <div style={{
                      marginBottom: '24px',
                      backgroundColor: '#D1FAE5',
                      padding: '16px',
                      borderRadius: '8px',
                    
                    }}>
                      <div style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#047857',
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <FaCheck style={{ color: '#059669' }} />
                        Approved Attempt
                      </div>
                      <div
                        onClick={() => {
                          setSubmissionCheckingView(prev => ({
                            ...prev,
                            selectedAttempt: approvedAttempt,
                            selectedSubmission: approvedAttempt
                          }));
                        }}
                        style={{
                          backgroundColor: isSelected ? '#DBEAFE' : 'white',
                          border: isSelected ? '2px solid #34656D' : '1px solid #6EE7B7',
                          borderRadius: '6px',
                          padding: '12px',
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}
                        onMouseOver={(e) => {
                          if (!isSelected) {
                            e.currentTarget.style.backgroundColor = '#F0FDF4';
                            e.currentTarget.style.borderColor = '#059669';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (!isSelected) {
                            e.currentTarget.style.backgroundColor = 'white';
                            e.currentTarget.style.borderColor = '#6EE7B7';
                          }
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px'
                        }}>
                          <span style={{
                            display: 'inline-flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            width: '32px',
                            height: '32px',
                            borderRadius: '50%',
                            backgroundColor: isSelected ? '#BFDBFE' : '#D1FAE5',
                            color: isSelected ? '#1E40AF' : '#047857',
                            fontWeight: '600',
                            fontSize: '14px'
                          }}>
                            {attemptNumber}
                          </span>
                          <div>
                            <div style={{
                              fontSize: '13px',
                              fontWeight: '600',
                              color: isSelected ? '#1E40AF' : '#047857'
                            }}>
                              Attempt {attemptNumber}
                            </div>
                            <div style={{
                              fontSize: '12px',
                              color: '#059669'
                            }}>
                              {new Date(approvedAttempt.submittedAt).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                            </div>
                          </div>
                        </div>
                        <span style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '4px',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '11px',
                          fontWeight: '600',
                          backgroundColor: '#D1FAE5',
                          color: '#059669'
                        }}>
                          <FaCheck style={{ fontSize: '10px' }} />
                          Approved
                        </span>
                      </div>
                    </div>
                  ) : null;
                })()}

                {/* Attempts Panel */}
                {submissionCheckingView.selectedTask?.attempts && submissionCheckingView.selectedTask.attempts.length > 0 && (
                  <div style={{
                    marginBottom: '24px',
                    background: '#872341',
                    padding: '16px',
                    borderRadius: '8px',
                   
                  }}>
                    <div style={{
                      fontSize: '14px',
                      fontWeight: '600',
                      color: '#FAF8F1',
                      marginBottom: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      <FaHistory style={{ color: '#E17564' }} />
                      Submission Attempts ({submissionCheckingView.selectedTask.attempts.length})
                    </div>
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px'
                    }}>
                      {submissionCheckingView.selectedTask.attempts.map((attempt, idx) => {
                        // Count only non-revision attempts for the attempt number
                        const nonRevisionAttempts = submissionCheckingView.selectedTask.attempts.filter(att => !att.isRevisionSubmission);
                        let attemptNumber;
                        
                        if (attempt.isRevisionSubmission) {
                          // For revisions, find which original attempt it belongs to
                          if (attempt.originalSubmissionId && nonRevisionAttempts.length > 0) {
                            const originalAttempt = nonRevisionAttempts.find(att => att.id === attempt.originalSubmissionId);
                            if (originalAttempt) {
                              attemptNumber = nonRevisionAttempts.length - nonRevisionAttempts.findIndex(att => att.id === originalAttempt.id);
                            } else {
                              attemptNumber = null; // No original found
                            }
                          } else {
                            attemptNumber = null; // No original attempts or no link
                          }
                        } else {
                          attemptNumber = nonRevisionAttempts.length - nonRevisionAttempts.findIndex(att => att.id === attempt.id);
                        }
                        
                        return (
                        <div
                          key={idx}
                          onClick={() => {
                            setSubmissionCheckingView(prev => ({
                              ...prev,
                              selectedAttempt: attempt,
                              selectedSubmission: attempt
                            }));
                          }}
                          style={{
                            backgroundColor: submissionCheckingView.selectedAttempt?.id === attempt.id ? '#DBEAFE' : 'white',
                            border: submissionCheckingView.selectedAttempt?.id === attempt.id ? '2px solid #34656D' : '1px solid #E5E7EB',
                            borderRadius: '6px',
                            padding: '12px',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                          }}
                          onMouseOver={(e) => {
                            if (submissionCheckingView.selectedAttempt?.id !== attempt.id) {
                              e.currentTarget.style.backgroundColor = '#F3F4F6';
                              e.currentTarget.style.borderColor = '#D1D5DB';
                            }
                          }}
                          onMouseOut={(e) => {
                            if (submissionCheckingView.selectedAttempt?.id !== attempt.id) {
                              e.currentTarget.style.backgroundColor = 'white';
                              e.currentTarget.style.borderColor = '#E5E7EB';
                            }
                          }}
                        >
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                          }}>
                            <span style={{
                              display: 'inline-flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              width: '32px',
                              height: '32px',
                              borderRadius: '50%',
                              backgroundColor: '#E5E7EB',
                              color: '#374151',
                              fontWeight: '600',
                              fontSize: '14px'
                            }}>
                              {typeof attemptNumber === 'number' ? attemptNumber : '‚Üí'}
                            </span>
                            <div>
                              <div style={{
                                fontSize: '13px',
                                fontWeight: '600',
                                color: '#374151'
                              }}>
                                {attempt.isRevisionSubmission ? (
                                  attemptNumber ? `Attempt ${attemptNumber}` : 'Revision'
                                ) : (
                                  `Attempt ${attemptNumber}`
                                )}
                                {attempt.isRevisionSubmission && attempt.revisionAttemptNumber && (() => {
                                  const revisionNumbers = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'];
                                  const revisionLabel = revisionNumbers[attempt.revisionAttemptNumber - 1] || `${attempt.revisionAttemptNumber}th`;
                                  return ` (${revisionLabel} Revision)`;
                                })()}
                              </div>
                              <div style={{
                                fontSize: '12px',
                                color: '#6B7280'
                              }}>
                                {new Date(attempt.submittedAt).toLocaleDateString('en-US', {
                                  month: 'short',
                                  day: 'numeric',
                                  hour: '2-digit',
                                  minute: '2-digit'
                                })}
                              </div>
                            </div>
                          </div>
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}>
                            {submissionCheckingView.selectedTask.approvedAttemptId === attempt.id && (
                              <span style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '4px',
                                padding: '4px 10px',
                                borderRadius: '12px',
                                fontSize: '11px',
                                fontWeight: '600',
                                backgroundColor: '#D1FAE5',
                                color: '#059669'
                              }}>
                                <FaCheck style={{ fontSize: '10px' }} />
                                Approved
                              </span>
                            )}
                            {attempt.status === 'revision_requested' && submissionCheckingView.selectedTask.approvedAttemptId !== attempt.id && (
                              <span style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '4px',
                                padding: '4px 10px',
                                borderRadius: '12px',
                                fontSize: '11px',
                                fontWeight: '600',
                                backgroundColor: '#FEE2E2',
                                color: '#DC2626'
                              }}>
                                <FaExclamationTriangle style={{ fontSize: '10px' }} />
                                Revision
                              </span>
                            )}
                          </div>
                        </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Submission Text */}
                {submissionCheckingView.selectedSubmission.submissionText && (
                  <div style={{
                    marginBottom: '24px',
                    backgroundColor: '#F9FAFB',
                    padding: '16px',
                    borderRadius: '8px',
                    border: '1px solid #E5E7EB'
                  }}>
                    <div style={{
                      fontSize: '11px',
                      color: '#6B7280',
                      fontWeight: '600',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Submission Text
                    </div>
                    <div style={{
                      fontSize: '14px',
                      color: '#374151',
                      lineHeight: '1.6',
                      whiteSpace: 'pre-wrap'
                    }}>
                      {submissionCheckingView.selectedSubmission.submissionText}
                    </div>
                  </div>
                )}

                {/* Uploaded Files */}
                {(() => {
                  const fileUrls = getFileUrlsArray(submissionCheckingView.selectedSubmission.fileUrls);
                  return fileUrls.length > 0 && (
                    <div style={{ marginBottom: '24px' }}>
                      <div style={{
                        fontSize: '11px',
                        color: '#6B7280',
                        fontWeight: '600',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        marginBottom: '12px'
                      }}>
                        Uploaded Files ({fileUrls.length})
                      </div>
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                        gap: '12px'
                      }}>
                        {fileUrls.map((file, idx) => {
                          const fileName = file.split('/').pop();
                          return (
                            <button
                              key={idx}
                              onClick={() => downloadSubmissionFile(file, fileName)}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '12px',
                                backgroundColor: 'white',
                                border: '1px solid #E5E7EB',
                                borderRadius: '8px',
                                textDecoration: 'none',
                                transition: 'all 0.2s ease',
                                cursor: 'pointer',
                                fontFamily: 'inherit',
                                fontSize: 'inherit'
                              }}
                              onMouseOver={(e) => {
                                e.currentTarget.style.backgroundColor = '#F9FAFB';
                                e.currentTarget.style.borderColor = '#34656D';
                                e.currentTarget.style.transform = 'translateY(-2px)';
                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                              }}
                              onMouseOut={(e) => {
                                e.currentTarget.style.backgroundColor = 'white';
                                e.currentTarget.style.borderColor = '#E5E7EB';
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = 'none';
                              }}
                            >
                              <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '8px',
                                backgroundColor: '#09122C',
                                color: 'white',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '18px',
                                flexShrink: 0
                              }}>
                                <FaFile />
                              </div>
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{
                                  fontSize: '13px',
                                  fontWeight: '600',
                                  color: '#374151',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  whiteSpace: 'nowrap'
                                }}>
                                  {fileName}
                                </div>
                                <div style={{
                                  fontSize: '11px',
                                  color: '#6B7280',
                                  marginTop: '2px'
                                }}>
                                  Click to download
                                </div>
                              </div>
                              <FaExternalLinkAlt style={{ fontSize: '14px', color: '#6B7280', flexShrink: 0 }} />
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  );
                })()}

                {/* Helper function to determine if buttons should be disabled */}
                {(() => {
                  // Calculate button disable state
                  const checkSubmissionDisabled = () => {
                    if (!submissionCheckingView.selectedAttempt) return true;
                    
                    // For REVISION submissions: Only check if THIS revision is approved or already revision_requested
                    if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                      return submissionCheckingView.selectedAttempt.status === 'approved' || 
                             submissionCheckingView.selectedAttempt.status === 'revision_requested';
                    }
                    
                    // For ORIGINAL submissions: Check conflicts with OTHER attempts
                    // But exclude other revision submissions from the conflict check
                    const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                      att.status === 'approved' && 
                      att.id !== submissionCheckingView.selectedAttempt?.id &&
                      !att.isRevisionSubmission  // Ignore revisions
                    );
                    
                    const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                      att.status === 'revision_requested' && 
                      att.id !== submissionCheckingView.selectedAttempt?.id &&
                      !att.isRevisionSubmission  // Ignore revisions
                    );
                    
                    return submissionCheckingView.selectedAttempt.status === 'approved' || 
                           submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                           hasOtherApprovedAttempt ||
                           hasOtherRevisionAttempt;
                  };
                  
                  // Store for later use
                  window.__submissionDisabledCheck = checkSubmissionDisabled;
                  return null;
                })()}

                {/* Action Buttons */}
                <div style={{
                  display: 'flex',
                  gap: '12px',
                  justifyContent: 'flex-end',
                  paddingTop: '20px',
                  borderTop: '2px solid #F3F4F6'
                }}>
                  <button
                    onClick={async () => {
                      try {
                        const response = await fetch('/api/submission-checking/request-revision', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                          },
                          body: JSON.stringify({
                            submissionId: submissionCheckingView.selectedAttempt.id,
                            taskId: submissionCheckingView.selectedTask.taskId,
                            projectId: submissionCheckingView.selectedProject.id,
                            isRevisionSubmission: submissionCheckingView.selectedAttempt?.isRevisionSubmission || false
                          })
                        });

                        if (response.ok) {
                          // Refresh submission data in Submission Checking view
                          setSubmissionCheckingView(prev => {
                            // Update the attempt in the attempts array
                            const updatedAttempts = prev.selectedTask.attempts.map(att => 
                              att.id === prev.selectedAttempt.id 
                                ? { ...att, status: 'revision_requested' }
                                : att
                            );
                            
                            return {
                              ...prev,
                              selectedAttempt: {
                                ...prev.selectedAttempt,
                                status: 'revision_requested'
                              },
                              selectedTask: {
                                ...prev.selectedTask,
                                latestStatus: 'revision_requested',
                                attempts: updatedAttempts
                              }
                            };
                          });
                          
                          // Also refresh the Activities view data
                          if (selectedActivitiesProject) {
                            await loadGroupTaskSubmissions(selectedActivitiesPhase?.id, selectedActivitiesProject);
                          }
                          
                          alert('Revision requested successfully!');
                        } else {
                          alert('Failed to request revision');
                        }
                      } catch (error) {
                        console.error('Revision request error:', error);
                        alert('Error requesting revision');
                      }
                    }}
                    disabled={(() => {
                      if (!submissionCheckingView.selectedAttempt) return true;
                      
                      // For REVISION submissions: Only check if THIS revision is approved or already revision_requested
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        return submissionCheckingView.selectedAttempt.status === 'approved' || 
                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      }
                      
                      // For ORIGINAL submissions: Check conflicts with OTHER attempts (excluding revisions)
                      const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                        att.status === 'approved' && 
                        att.id !== submissionCheckingView.selectedAttempt?.id &&
                        !att.isRevisionSubmission
                      );
                      const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                        att.status === 'revision_requested' && 
                        att.id !== submissionCheckingView.selectedAttempt?.id &&
                        !att.isRevisionSubmission
                      );
                      return submissionCheckingView.selectedAttempt.status === 'approved' || 
                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                             hasOtherApprovedAttempt ||
                             hasOtherRevisionAttempt;
                    })()}
                    style={{
                      padding: '12px 24px',
                      backgroundColor: (() => {
                        if (!submissionCheckingView.selectedAttempt) return '#E5E7EB';
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? '#E5E7EB' : '#DC2626';
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? '#E5E7EB' : '#DC2626';
                      })(),
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: (() => {
                        if (!submissionCheckingView.selectedAttempt) return 'not-allowed';
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? 'not-allowed' : 'pointer';
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? 'not-allowed' : 'pointer';
                      })(),
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      transition: 'all 0.2s ease',
                      opacity: (() => {
                        if (!submissionCheckingView.selectedAttempt) return 0.5;
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? 0.5 : 1;
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? 0.5 : 1;
                      })(),
                      title: (() => {
                        if (!submissionCheckingView.selectedAttempt) return '';
                        
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          if (submissionCheckingView.selectedAttempt.status === 'approved') {
                            return 'This revision is already approved';
                          } else if (submissionCheckingView.selectedAttempt.status === 'revision_requested') {
                            return 'Cannot request revision on a revision already marked for revision';
                          }
                          return '';
                        }
                        
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        if (submissionCheckingView.selectedAttempt.status === 'approved') {
                          return 'Cannot revise an already approved attempt';
                        } else if (submissionCheckingView.selectedAttempt.status === 'revision_requested') {
                          return 'Cannot revise an attempt already marked for revision';
                        } else if (hasOtherApprovedAttempt) {
                          return 'Cannot revise when another attempt is already approved';
                        } else if (hasOtherRevisionAttempt) {
                          return 'Cannot revise when another attempt is marked for revision';
                        }
                        return '';
                      })()
                    }}
                    onMouseOver={(e) => {
                      if (!submissionCheckingView.selectedAttempt) return;
                      
                      let shouldDisable = false;
                      
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      } else {
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                       hasOtherApprovedAttempt ||
                                       hasOtherRevisionAttempt;
                      }
                      
                      if (!shouldDisable) {
                        e.currentTarget.style.backgroundColor = '#B91C1C';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(220, 38, 38, 0.3)';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (!submissionCheckingView.selectedAttempt) return;
                      
                      let shouldDisable = false;
                      
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      } else {
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                       hasOtherApprovedAttempt ||
                                       hasOtherRevisionAttempt;
                      }
                      
                      if (!shouldDisable) {
                        e.currentTarget.style.backgroundColor = '#DC2626';
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                      }
                    }}
                  >
                    <FaExclamationTriangle />
                    Request Revision
                  </button>
                  
                  <button
                    onClick={async () => {
                      try {
                        const response = await fetch('/api/submission-checking/approve', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                          },
                          body: JSON.stringify({
                            submissionId: submissionCheckingView.selectedAttempt.id,
                            taskId: submissionCheckingView.selectedTask.taskId,
                            projectId: submissionCheckingView.selectedProject.id,
                            isRevisionSubmission: submissionCheckingView.selectedAttempt?.isRevisionSubmission || false
                          })
                        });

                        if (response.ok) {
                          const responseData = await response.json();
                          console.log('‚úÖ Approval response:', responseData);
                          
                          // Refresh submission data in Submission Checking view
                          setSubmissionCheckingView(prev => ({
                            ...prev,
                            selectedTask: {
                              ...prev.selectedTask,
                              approvedAttemptId: submissionCheckingView.selectedAttempt.id,
                              latestStatus: 'approved'
                            },
                            selectedAttempt: {
                              ...prev.selectedAttempt,
                              status: 'approved'
                            }
                          }));
                          
                          // Reload submissions to reflect backend changes (including task status)
                          if (submissionCheckingView.selectedProject && submissionCheckingView.selectedPhase) {
                            // Reload the submission list
                            const token = localStorage.getItem('token');
                            const refreshResponse = await fetch(`/api/submission-checking/submissions?projectId=${submissionCheckingView.selectedProject.id}&phaseId=${submissionCheckingView.selectedPhase.id}`, {
                              headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (refreshResponse.ok) {
                              const refreshData = await refreshResponse.json();
                              console.log('‚úÖ Refreshed submissions after approval');
                            }
                          }
                          
                          // Also refresh the Activities view data
                          if (selectedActivitiesProject) {
                            await loadGroupTaskSubmissions(selectedActivitiesPhase?.id, selectedActivitiesProject);
                          }
                          
                          // Refresh Project Dashboard if it's the active view
                          if (selectedTodoProject) {
                            await loadTodoData(selectedTodoProject.id);
                          }
                          
                          alert('Submission approved successfully! Task status updated to completed.');
                        } else {
                          alert('Failed to approve submission');
                        }
                      } catch (error) {
                        console.error('Approval error:', error);
                        alert('Error approving submission');
                      }
                    }}
                    disabled={(() => {
                      if (!submissionCheckingView.selectedAttempt) return true;
                      
                      // For REVISION submissions: Only check if THIS revision is approved or already revision_requested
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        return submissionCheckingView.selectedAttempt.status === 'approved' || 
                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      }
                      
                      // For ORIGINAL submissions: Check conflicts with OTHER attempts (excluding revisions)
                      const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                        att.status === 'approved' && 
                        att.id !== submissionCheckingView.selectedAttempt?.id &&
                        !att.isRevisionSubmission
                      );
                      const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                        att.status === 'revision_requested' && 
                        att.id !== submissionCheckingView.selectedAttempt?.id &&
                        !att.isRevisionSubmission
                      );
                      return submissionCheckingView.selectedAttempt.status === 'approved' || 
                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                             hasOtherApprovedAttempt ||
                             hasOtherRevisionAttempt;
                    })()}
                    style={{
                      padding: '12px 24px',
                      backgroundColor: (() => {
                        if (!submissionCheckingView.selectedAttempt) return '#E5E7EB';
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? '#E5E7EB' : '#059669';
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? '#E5E7EB' : '#059669';
                      })(),
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: (() => {
                        if (!submissionCheckingView.selectedAttempt) return 'not-allowed';
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? 'not-allowed' : 'pointer';
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? 'not-allowed' : 'pointer';
                      })(),
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      transition: 'all 0.2s ease',
                      opacity: (() => {
                        if (!submissionCheckingView.selectedAttempt) return 0.5;
                        
                        // For REVISION submissions
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                               submissionCheckingView.selectedAttempt.status === 'revision_requested';
                          return shouldDisable ? 0.5 : 1;
                        }
                        
                        // For ORIGINAL submissions
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                             submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                             hasOtherApprovedAttempt ||
                                             hasOtherRevisionAttempt;
                        return shouldDisable ? 0.5 : 1;
                      })(),
                      title: (() => {
                        if (!submissionCheckingView.selectedAttempt) return '';
                        
                        if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                          if (submissionCheckingView.selectedAttempt.status === 'approved') {
                            return 'This revision is already approved';
                          } else if (submissionCheckingView.selectedAttempt.status === 'revision_requested') {
                            return 'Cannot approve a revision already marked for revision';
                          }
                          return '';
                        }
                        
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        if (submissionCheckingView.selectedAttempt.status === 'approved') {
                          return 'This attempt is already approved';
                        } else if (submissionCheckingView.selectedAttempt.status === 'revision_requested') {
                          return 'Cannot approve an attempt marked for revision';
                        } else if (hasOtherApprovedAttempt) {
                          return 'Cannot approve when another attempt is already approved';
                        } else if (hasOtherRevisionAttempt) {
                          return 'Cannot approve when another attempt is marked for revision';
                        }
                        return '';
                      })()
                    }}
                    onMouseOver={(e) => {
                      if (!submissionCheckingView.selectedAttempt) return;
                      
                      let shouldDisable = false;
                      
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      } else {
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                       hasOtherApprovedAttempt ||
                                       hasOtherRevisionAttempt;
                      }
                      
                      if (!shouldDisable) {
                        e.currentTarget.style.backgroundColor = '#047857';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(5, 150, 105, 0.3)';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (!submissionCheckingView.selectedAttempt) return;
                      
                      let shouldDisable = false;
                      
                      if (submissionCheckingView.selectedAttempt?.isRevisionSubmission) {
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested';
                      } else {
                        const hasOtherApprovedAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'approved' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        const hasOtherRevisionAttempt = submissionCheckingView.selectedTask?.attempts?.some(att => 
                          att.status === 'revision_requested' && 
                          att.id !== submissionCheckingView.selectedAttempt?.id &&
                          !att.isRevisionSubmission
                        );
                        shouldDisable = submissionCheckingView.selectedAttempt.status === 'approved' || 
                                       submissionCheckingView.selectedAttempt.status === 'revision_requested' ||
                                       hasOtherApprovedAttempt ||
                                       hasOtherRevisionAttempt;
                      }
                      
                      if (!shouldDisable) {
                        e.currentTarget.style.backgroundColor = '#059669';
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                      }
                    }}
                  >
                    <FaCheck />
                    {submissionCheckingView.selectedAttempt.status === 'approved' ? 'Approved' : 'Approve'}
                  </button>
                </div>
              </div>

              {/* Right Column - Feedback Section */}
              <div style={{
                background: 'rgba(14, 25, 60, 0.25)',
                backdropFilter: 'blur(5px)',
                WebkitBackdropFilter: 'blur(5px)',
                border: '1px solid rgba(225, 117, 100, 0.3)',
                borderRadius: '12px',
                padding: '24px'
              }}>
                <h4 style={{
                  margin: '0 0 20px 0',
                  fontSize: '16px',
                  fontWeight: '600',
                  color: '#FAF8F1',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <FaComment style={{ color: '#E17564' }} />
                  Feedback History
                </h4>

                {submissionCheckingView.selectedSubmission.feedback && submissionCheckingView.selectedSubmission.feedback.length > 0 ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px',
                    maxHeight: '600px',
                    overflowY: 'auto'
                  }}>
                    {submissionCheckingView.selectedSubmission.feedback.map((fb, idx) => (
                      <div
                        key={idx}
                        style={{
                          backgroundColor: '#F9FAFB',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          padding: '16px'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px',
                          marginBottom: '12px',
                          paddingBottom: '12px',
                          borderBottom: '1px solid #E5E7EB'
                        }}>
                          {fb.feedback_by_image ? (
                            <img 
                              src={fb.feedback_by_image} 
                              alt={fb.feedback_by_name}
                              style={{
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                objectFit: 'cover',
                                border: '2px solid #E5E7EB',
                                flexShrink: 0
                              }}
                            />
                          ) : (
                            <div style={{
                              width: '32px',
                              height: '32px',
                              borderRadius: '50%',
                              backgroundColor: '#34656D',
                              color: 'white',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '14px',
                              fontWeight: '600',
                              flexShrink: 0
                            }}>
                              {fb.feedback_by_name?.charAt(0) || '?'}
                            </div>
                          )}
                          <div style={{ flex: 1 }}>
                            <div style={{
                              fontSize: '13px',
                              fontWeight: '600',
                              color: '#374151',
                              marginBottom: '2px'
                            }}>
                              {fb.feedback_by_name || 'Unknown'}
                            </div>
                            <div style={{
                              fontSize: '11px',
                              color: '#6B7280'
                            }}>
                              {fb.created_at 
                                ? new Date(fb.created_at).toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                  })
                                : 'N/A'
                              }
                            </div>
                          </div>
                        </div>
                        <div style={{
                          fontSize: '14px',
                          color: '#1F2937',
                          lineHeight: '1.6',
                          whiteSpace: 'pre-wrap'
                        }}>
                          {fb.feedback_text}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#EBE5C2'
                  }}>
                    <FaComment style={{ fontSize: '48px', marginBottom: '12px', color: '#E17564' }} />
                    <p style={{ fontSize: '14px', margin: 0 }}>
                      No feedback yet
                    </p>
                  </div>
                )}
              </div>
            </div>
            ) : (
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                flex: 1,
                textAlign: 'center',
                color: '#EBE5C2'
              }}>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '16px'
                }}>
                  <FaClipboardList style={{ fontSize: '64px', color: '#E17564' }} />
                  <p style={{ fontSize: '18px', fontWeight: '500', margin: 0, color: '#FAF8F1' }}>
                    Select a submission to view details
                  </p>
                  <p style={{ fontSize: '14px', color: '#EBE5C2', margin: 0 }}>
                    Click on any submission from the list above to see complete information
                  </p>
                </div>
              </div>
            )}
          </div>
          </div>
          </div>
        </>
      ) : (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaProjectDiagram size={36} style={{ color: '#E17564', marginBottom: '4px' }} />
            <h3 style={{ color: '#FAF8F1', fontSize: '16px', fontWeight: '600', margin: '0' }}>Select a Project</h3>
            <p style={{ color: '#FAF8F1', fontSize: '13px', margin: '0', textAlign: 'center', maxWidth: '450px' }}>
              Select a project to view submission checking details
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

// =================== TASK ASSIGNMENT RENDER ===================
const renderTaskAssignment = () => {
  // Helper function to get phase boundaries
  const getSelectedPhase = () => {
    if (!taskAssignmentView.taskForm.phase_id) return null;
    return taskAssignmentView.projectPhases.find(p => p.id === taskAssignmentView.taskForm.phase_id);
  };

  // Helper function to get min and max dates for phase
  const getPhaseDateBounds = () => {
    const phase = getSelectedPhase();
    if (!phase) return { minDate: null, maxDate: null, minTime: null, maxTime: null };
    
    // Phase starts at start_date 00:00 - due date can be from 00:01 
    // Phase ends at end_date 23:59 - due date/available until can be up to 23:58
    return {
      minDate: phase.start_date,
      maxDate: phase.end_date,
      minTime: '00:01', // 1 minute after phase starts
      maxTime: '23:58'  // 2 minutes before phase ends
    };
  };

  // Helper function to validate date against phase bounds
  const validateDateAgainstPhase = (dateStr, timeStr) => {
    const phase = getSelectedPhase();
    if (!phase) return { valid: true, message: '' };

    // Combine date and time to create a proper datetime
    const dateTimeStr = timeStr ? `${dateStr}T${timeStr}:00` : `${dateStr}T00:00:00`;
    const inputDate = new Date(dateTimeStr);
    const now = new Date();
    
    // Check if the selected date/time is in the past
    if (inputDate < now) {
      return { 
        valid: false, 
        message: `Due date cannot be in the past. Please select a future date and time.` 
      };
    }

    // Parse phase start and end dates
    const startDate = new Date(phase.start_date);
    const endDate = new Date(phase.end_date);
    
    // Validate the input is within the phase boundaries
    if (inputDate < startDate || inputDate > endDate) {
      // Format dates for display
      const startFormatted = dayjs(phase.start_date).format('MMM D, h:mm A');
      const endFormatted = dayjs(phase.end_date).format('MMM D, h:mm A');
      return { 
        valid: false, 
        message: `Must be between ${startFormatted} and ${endFormatted}` 
      };
    }

    return { valid: true, message: '' };
  };

  // Helper function to count assigned tasks for a member in a specific phase
  const getAssignedTaskCountForMemberPhase = (memberId, phaseId) => {
    const key = `${memberId}-${phaseId}`;
    return taskAssignmentView.assignedTasks[key] || 0;
  };

  // Helper function to get total tasks assigned to a member across all phases
  const getTotalTasksForMember = (memberId) => {
    return Object.keys(taskAssignmentView.assignedTasks).reduce((total, key) => {
      if (key.startsWith(`${memberId}-`)) {
        return total + taskAssignmentView.assignedTasks[key];
      }
      return total;
    }, 0);
  };

  // Helper function to check if a phase is still open for task assignments
  const isPhaseOpenForAssignments = (phase) => {
    if (!phase) return false;
    
    const now = dayjs();
    const phaseEnd = dayjs(phase.end_date);
    
    // Phase must not have ended yet
    if (now.isAfter(phaseEnd)) {
      return false;
    }
    
    return true;
  };

  // Filter phases to only show current and future phases (exclude passed phases)
  const getAvailablePhasesForAssignment = () => {
    return taskAssignmentView.projectPhases;
  };

  // Check if a phase is still available for assignment (not passed)
  const isPhaseAvailableForAssignment = (phase) => {
    if (!phase) return false;
    const now = dayjs();
    const phaseEnd = dayjs(phase.end_date);
    return now.isBefore(phaseEnd);
  };

  // ‚úÖ DYNAMIC: Detect the current active work phase (not evaluation or breathe)
  // This mimics the carousel logic to show tasks for the currently active phase
  const detectCurrentActiveWorkPhase = () => {
    if (!taskAssignmentView.projectPhases || taskAssignmentView.projectPhases.length === 0) {
      return null;
    }

    const now = new Date();
    const phases = taskAssignmentView.projectPhases.sort((a, b) => a.phase_number - b.phase_number);

    // Find which work phase is currently active
    for (let phase of phases) {
      const startDate = new Date(phase.start_date);
      const endDate = new Date(phase.end_date);

      // If current time is within this phase's work period, return it
      if (now >= startDate && now <= endDate) {
        return phase;
      }
    }

    // If we're between phases or in evaluation/breathe periods,
    // find the phase that's closest to ending (most recent active phase)
    let closestPhase = null;
    let smallestTimeDiff = Infinity;

    for (let phase of phases) {
      const endDate = new Date(phase.end_date);
      
      // Find phases that have ended
      if (now > endDate) {
        const timeDiff = now - endDate;
        if (timeDiff < smallestTimeDiff) {
          smallestTimeDiff = timeDiff;
          closestPhase = phase;
        }
      }
    }

    // If a phase has recently ended and we're in eval/breathe, show that phase
    if (closestPhase && smallestTimeDiff < 30 * 24 * 60 * 60 * 1000) { // Within 30 days
      return closestPhase;
    }

    // Otherwise return the first phase as default
    return phases[0] || null;
  };

  // Helper function to construct Supabase image URLs
  const getSupabaseImageUrl = (imagePath) => {
    if (!imagePath) return null;
    
    // Handle full URLs (shouldn't happen but just in case)
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
      return imagePath;
    }
    
    // Construct Supabase storage URL with correct project URL
    const baseUrl = 'https://qorkowgfjjuwxelumuut.supabase.co';
    const bucketName = 'studentaccounts';
    const fullUrl = `${baseUrl}/storage/v1/object/public/${bucketName}/${imagePath}`;
    
    return fullUrl;
  };

  // Fetch latest task status from database
  const fetchLatestTaskStatus = async (taskId) => {
    try {
      const token = localStorage.getItem('token');

      // Fetch latest status from backend API
      const response = await fetch(
        `${apiConfig.baseURL}/api/student-leader/tasks/${taskId}/latest-status`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!response.ok) {
        console.warn('Failed to fetch latest task status');
        return null;
      }

      const data = await response.json();
      return data.status || null;
    } catch (error) {
      console.error('Error fetching latest task status:', error);
      return null;
    }
  };

  const handleTaskAssignmentProjectSelect = async (project) => {
    setTaskAssignmentView(prev => ({
      ...prev,
      selectedProject: project,
      showProjectDropdown: false,
      loading: true
    }));

    try {
      const token = localStorage.getItem('token');
      
      // Fetch group members for this project
      const membersResponse = await fetch(
        `${apiConfig.baseURL}/api/task-assignment/projects/${project.id}/members`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!membersResponse.ok) throw new Error('Failed to load group members');
      
      const membersData = await membersResponse.json();
      
      // Fetch project phases
      const phasesResponse = await fetch(
        `${apiConfig.baseURL}/api/task-assignment/projects/${project.id}/phases`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!phasesResponse.ok) throw new Error('Failed to load phases');
      
      const phasesData = await phasesResponse.json();
      
      // Members data is already transformed by the backend
      setTaskAssignmentView(prev => ({
        ...prev,
        groupMembers: membersData.members || [],
        projectPhases: phasesData.phases || [],
        selectedProject: {
          ...project,
          min_tasks_per_member: phasesData.project?.min_tasks_per_member,
          max_tasks_per_member: phasesData.project?.max_tasks_per_member
        },
        loading: false
      }));

      // Load existing assigned tasks for this project
      await loadTaskAssignmentTasks(project.id);
    } catch (error) {
      console.error('Error loading task assignment data:', error);
      alert('Failed to load group members or phases: ' + error.message);
      setTaskAssignmentView(prev => ({
        ...prev,
        loading: false
      }));
    }
  };

  // Load assigned tasks for task assignment view
  const loadTaskAssignmentTasks = async (projectId) => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/api/student-leader/projects/${projectId}/assigned-tasks`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const data = await response.json();
        console.log('‚úÖ Assigned tasks loaded for task assignment view:', data);

        // Build assignedTasks object in format: { 'memberId-phaseId': count }
        const assignedTasksMap = {};
        
        if (data.tasks && data.tasks.length > 0) {
          data.tasks.forEach(task => {
            // Use assigned_to_id (the member) and task.phase_id
            const key = `${task.assigned_to_id}-${task.phase_id}`;
            assignedTasksMap[key] = (assignedTasksMap[key] || 0) + 1;
          });
        }

        console.log('üìä Assigned tasks map:', assignedTasksMap);
        
        // Update the state with the populated assignedTasks
        setTaskAssignmentView(prev => ({
          ...prev,
          assignedTasks: assignedTasksMap
        }));
      } else {
        console.error('‚ùå Failed to load assigned tasks');
        setTaskAssignmentView(prev => ({
          ...prev,
          assignedTasks: {}
        }));
      }
    } catch (error) {
      console.error('üí• Error loading assigned tasks for task assignment:', error);
      setTaskAssignmentView(prev => ({
        ...prev,
        assignedTasks: {}
      }));
    }
  };

  const handleMemberSelectForAssignment = (member) => {
    setTaskAssignmentView(prev => ({
      ...prev,
      selectedMember: member,
      taskForm: {
        title: '',
        description: '',
        phase_id: null,
        max_attempts: 1,
        due_datetime: null,
        available_until_datetime: null,
        file_types_allowed: []
      },
      dateValidationErrors: {}
    }));
  };

  const handleTaskFormChange = (field, value) => {
    setTaskAssignmentView(prev => {
      const updatedForm = {
        ...prev.taskForm,
        [field]: value
      };

      // If phase_id changed, clear dates to force re-selection with new constraints
      if (field === 'phase_id') {
        updatedForm.due_datetime = null;
        updatedForm.available_until_datetime = null;
        
        // Fetch assigned task counts for this phase
        if (value && prev.selectedProject) {
          const token = localStorage.getItem('token');
          const phaseId = value;
          const projectId = prev.selectedProject.id;
          
          // Fetch task assignments for this phase
          fetch(
            `${apiConfig.baseURL}/api/task-assignment/projects/${projectId}/phases/${phaseId}/assignments`,
            {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            }
          )
          .then(res => res.json())
          .then(data => {
            // Build assignment counts by member
            const assignedTasks = {};
            if (data.assignments && Array.isArray(data.assignments)) {
              data.assignments.forEach(assignment => {
                const key = `${assignment.assigned_to_student_id}-${phaseId}`;
                assignedTasks[key] = (assignedTasks[key] || 0) + 1;
              });
            }
            
            // Update state with new counts
            setTaskAssignmentView(prevState => ({
              ...prevState,
              assignedTasks: {
                ...prevState.assignedTasks,
                ...assignedTasks
              }
            }));
          })
          .catch(error => console.error('Error fetching assignment counts:', error));
        }
      }

      // Validate dates when they change
      let dateValidationErrors = { ...prev.dateValidationErrors };
      
      if (field === 'due_datetime' && value) {
        const dateStr = value.format('YYYY-MM-DD');
        const timeStr = value.format('HH:mm');
        const dateValidation = validateDateAgainstPhase(dateStr, timeStr);
        if (dateValidation.valid) {
          delete dateValidationErrors.due_date;
        } else {
          dateValidationErrors.due_date = dateValidation.message;
        }
      }

      if (field === 'available_until_datetime' && value) {
        const dateStr = value.format('YYYY-MM-DD');
        const timeStr = value.format('HH:mm');
        const dateValidation = validateDateAgainstPhase(dateStr, timeStr);
        if (dateValidation.valid) {
          delete dateValidationErrors.available_until;
        } else {
          dateValidationErrors.available_until = dateValidation.message;
        }
      }

      return {
        ...prev,
        taskForm: updatedForm,
        dateValidationErrors
      };
    });
  };

  const handleFileTypeToggle = (fileType) => {
    setTaskAssignmentView(prev => {
      const currentTypes = prev.taskForm.file_types_allowed || [];
      const newTypes = currentTypes.includes(fileType)
        ? currentTypes.filter(t => t !== fileType)
        : [...currentTypes, fileType];
      
      return {
        ...prev,
        taskForm: {
          ...prev.taskForm,
          file_types_allowed: newTypes
        }
      };
    });
  };

  const handleTaskSubmitAssignment = async (e) => {
    e.preventDefault();
    
    const { taskForm, selectedMember, selectedProject, dateValidationErrors } = taskAssignmentView;
    
    // Validation
    if (!taskForm.title.trim()) {
      alert('Please enter a task title');
      return;
    }
    
    if (!taskForm.description.trim()) {
      alert('Please enter a task description');
      return;
    }
    
    if (!taskForm.phase_id) {
      alert('Please select a project phase');
      return;
    }

    // Check if phase is still open for assignments
    const selectedPhase = getSelectedPhase();
    if (!isPhaseOpenForAssignments(selectedPhase)) {
      alert('This phase has ended and is no longer accepting new task assignments');
      return;
    }
    
    if (!taskForm.due_datetime) {
      alert('Please select a due date and time');
      return;
    }

    // Validate due date against phase bounds
    const dueDateStr = taskForm.due_datetime.format('YYYY-MM-DD');
    const dueTimeStr = taskForm.due_datetime.format('HH:mm');
    const dueDateValidation = validateDateAgainstPhase(dueDateStr, dueTimeStr);
    if (!dueDateValidation.valid) {
      alert('Invalid due date: ' + dueDateValidation.message);
      return;
    }

    // Validate available_until date if provided
    if (taskForm.available_until_datetime) {
      const availDateStr = taskForm.available_until_datetime.format('YYYY-MM-DD');
      const availTimeStr = taskForm.available_until_datetime.format('HH:mm');
      const availableUntilValidation = validateDateAgainstPhase(availDateStr, availTimeStr);
      if (!availableUntilValidation.valid) {
        alert('Invalid available until date: ' + availableUntilValidation.message);
        return;
      }
    }

    // Check if due_date is after available_until_date
    if (taskForm.available_until_datetime && taskForm.due_datetime > taskForm.available_until_datetime) {
      alert('Due date cannot be after the available until date');
      return;
    }

    try {
      setTaskAssignmentView(prev => ({ ...prev, loading: true }));
      
      const token = localStorage.getItem('token');
      
      // Format dates - split into date and time parts
      // Backend expects: due_date (YYYY-MM-DD), due_time (HH:mm)
      const due_date = taskForm.due_datetime.format('YYYY-MM-DD');
      const due_time = taskForm.due_datetime.format('HH:mm');
      
      const available_until_date = taskForm.available_until_datetime ? taskForm.available_until_datetime.format('YYYY-MM-DD') : null;
      const available_until_time = taskForm.available_until_datetime ? taskForm.available_until_datetime.format('HH:mm') : null;
      
      const response = await fetch(
        `${apiConfig.baseURL}/api/task-assignment/create`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            project_id: selectedProject.id,
            student_id: selectedMember.student_id,
            phase_id: taskForm.phase_id,
            title: taskForm.title,
            description: taskForm.description,
            due_date: due_date,
            due_time: due_time,
            available_until_date: available_until_date,
            available_until_time: available_until_time,
            max_attempts: taskForm.max_attempts,
            file_types_allowed: taskForm.file_types_allowed
          })
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to assign task');
      }

      const responseData = await response.json();
      console.log('‚úÖ Task assigned successfully:', responseData);
      
      alert('Task assigned successfully to ' + selectedMember.name + '!');
      
      // Reload assigned tasks to refresh the counts in Overview and Assign tabs
      await loadAssignedTasksWithCounts(selectedProject.id);
      
      // Also reload task assignment tasks for the Assign tab member pill counts
      await loadTaskAssignmentTasks(selectedProject.id);
      
      // Reset form
      setTaskAssignmentView(prev => ({
        ...prev,
        taskForm: {
          title: '',
          description: '',
          phase_id: null,
          max_attempts: 1,
          due_datetime: null,
          available_until_datetime: null,
          file_types_allowed: []
        },
        selectedMember: null,
        loading: false
      }));
    } catch (error) {
      console.error('Error assigning task:', error);
      alert(error.message || 'Failed to assign task. Please try again.');
      setTaskAssignmentView(prev => ({ ...prev, loading: false }));
    }
  };

  // =================== TIMELINE VISUALIZATION ===================
  // Helper function: Detect current active phase including eval and breathe periods
  const detectCurrentTimelineItem = (timelineItems) => {
    const now = new Date();
    
    console.log('üîç [DETECTION] Current time:', now.toISOString());
    console.log('üîç [DETECTION] Checking', timelineItems.length, 'timeline items...');
    
    return timelineItems.findIndex((item, index) => {
      // Skip project start/end markers - only check actual phases, evaluations, and breathe periods
      if (item.type === 'project_start' || item.type === 'project_end') {
        return false;
      }
      
      const startDate = new Date(item.startDate);
      const endDate = item.endDate ? new Date(item.endDate) : new Date('2099-12-31');
      
      const isActive = now >= startDate && now <= endDate;
      
      console.log(`  Item ${index}: ${item.label} (${item.type}) | Start: ${startDate.toISOString()} | End: ${endDate.toISOString()} | Active: ${isActive}`);
      
      return isActive;
    });
  };

  // Render project timeline with current phase in center
  const renderProjectTimeline = () => {
    if (!taskAssignmentView.selectedProject || !taskAssignmentView.projectPhases || taskAssignmentView.projectPhases.length === 0) {
      return null;
    }

    const phases = taskAssignmentView.projectPhases.sort((a, b) => a.phase_number - b.phase_number);
    const project = taskAssignmentView.selectedProject;
    
    // Build a complete timeline sequence: PROJECT_START ‚Üí [PHASE ‚Üí EVAL ‚Üí BREATHE] √ó n ‚Üí PROJECT_END
    const timelineItems = [];
    
    // Add project start
    timelineItems.push({
      type: 'project_start',
      label: 'Project Start',
      icon: FaCheck,
      startDate: project.start_date
    });
    
    // Add all phases with their evaluation and breathe periods
    phases.forEach((phase, index) => {
      // Add work phase
      timelineItems.push({
        type: 'phase',
        label: `Phase ${phase.phase_number}`,
        icon: phase.phase_number,
        title: phase.title,
        startDate: phase.start_date,
        endDate: phase.end_date,
        phaseData: phase
      });
      
      // DEBUG: Log phase data
      console.log(`Phase ${phase.phase_number}:`, {
        hasEvalDates: !!(phase.evaluation_available_from && phase.evaluation_due_date),
        evaluation_available_from: phase.evaluation_available_from,
        evaluation_due_date: phase.evaluation_due_date,
        hasBreatheDates: !!(phase.breathe_start_date && phase.breathe_end_date),
        breathe_start_date: phase.breathe_start_date,
        breathe_end_date: phase.breathe_end_date,
        isLastPhase: index === phases.length - 1
      });
      
      // Add evaluation phase (if exists)
      if (phase.evaluation_available_from && phase.evaluation_due_date) {
        timelineItems.push({
          type: 'evaluation',
          label: 'Evaluation Phase',
          icon: FaClipboardList,
          startDate: phase.evaluation_available_from,
          endDate: phase.evaluation_due_date,
          color: '#8B5CF6'
        });
      }
      
      // Add breathe phase (if exists - REMOVED the "not last phase" restriction)
      if (phase.breathe_start_date && phase.breathe_end_date) {
        timelineItems.push({
          type: 'breathe',
          label: 'Breathe',
          icon: FaClock,
          startDate: phase.breathe_start_date,
          endDate: phase.breathe_end_date,
          color: '#F59E0B',
          isDashed: true
        });
      }
    });

    // DEBUG: Log complete timeline
    console.log('Complete Timeline Items:', timelineItems.map(item => ({
      type: item.type,
      label: item.label,
      startDate: item.startDate,
      endDate: item.endDate
    })));
    
    // Add project end
    timelineItems.push({
      type: 'project_end',
      label: 'Project End',
      icon: FaCheckDouble,
      startDate: project.due_date
    });
    
    // Detect current timeline item (including phases, evaluations, and breathe periods)
    const currentItemIndex = detectCurrentTimelineItem(timelineItems);
    
    console.log('üéØ [CAROUSEL] Current item index:', currentItemIndex, '/ Total items:', timelineItems.length);
    
    // Carousel: show 7 items (shows each phase with its eval and breathe, or all if fewer than 7)
    const displayCount = Math.min(7, timelineItems.length);
    const halfCount = Math.floor(displayCount / 2);
    
    let startIdx, endIdx;
    
    if (currentItemIndex === -1) {
      // No current item - show from start
      startIdx = 0;
      endIdx = Math.min(timelineItems.length - 1, displayCount - 1);
    } else {
      // Current item exists - CENTER IT
      startIdx = Math.max(0, currentItemIndex - halfCount);
      endIdx = Math.min(timelineItems.length - 1, currentItemIndex + halfCount);
      
      // If we're at the start, shift end forward
      if (startIdx === 0) {
        endIdx = Math.min(timelineItems.length - 1, displayCount - 1);
      }
      // If we're at the end, shift start backward
      if (endIdx === timelineItems.length - 1) {
        startIdx = Math.max(0, timelineItems.length - displayCount);
      }
    }
    
    const displayItems = timelineItems.slice(startIdx, endIdx + 1);
    
    // Calculate display index of current item (for visual centering)
    const displayIndex = currentItemIndex >= startIdx ? currentItemIndex - startIdx : -1;
    
    return (
      <div className="my-group-card-with-crosshair" style={{
        background: 'rgba(9, 18, 44, 0.15)',
        backdropFilter: 'blur(3.2px) saturate(120%)',
        WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
        border: '0.1px solid rgb(95, 95, 95)',
        borderRadius: '0px',
        padding: '20px',
        marginBottom: '24px',
        marginTop: '70px',
        height: '180px',
        minHeight: '100px',
        position: 'relative'
      }}>
        <div className="crosshair-corner top-left" style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, zIndex: 10 }}>
          <div className="crosshair-h"></div>
          <div className="crosshair-v"></div>
        </div>
        <div className="crosshair-corner top-right" style={{ pointerEvents: 'none', position: 'absolute', top: 0, right: 0, zIndex: 10 }}>
          <div className="crosshair-h"></div>
          <div className="crosshair-v"></div>
        </div>
        <div className="crosshair-corner bottom-left" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, left: 0, zIndex: 10 }}>
          <div className="crosshair-h"></div>
          <div className="crosshair-v"></div>
        </div>
        <div className="crosshair-corner bottom-right" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, right: 0, zIndex: 10 }}>
          <div className="crosshair-h"></div>
          <div className="crosshair-v"></div>
        </div>
        <h3 style={{
          fontSize: '14px',
          fontWeight: '600',
          color: '#FFFFFF',
          marginBottom: '16px',
          display: 'flex',
          alignItems: 'center',
          gap: '8px'
        }}>
          <FaCalendarAlt />
          Project Timeline (Carousel)
        </h3>

        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
          
          paddingBottom: '8px',
          justifyContent: 'center',
          flexWrap: 'nowrap'
        }}>
          {/* Show "Earlier" if not at start */}
          {startIdx > 0 && (
            <>
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '8px',
                minWidth: '80px',
                flexShrink: 0
              }}>
                <div style={{
                  width: '40px',
                  height: '40px',
                  borderRadius: '50%',
                  backgroundColor: '#FFFFFF',
                  border: '2px solid #09122C',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '16px',
                  color: '#09122C'
                }}>
                  ...
                </div>
                <div style={{
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#09122C',
                  textAlign: 'center'
                }}>
                  Earlier
                </div>
              </div>
              <div style={{
                width: '16px',
                height: '2px',
                backgroundColor: '#D1D5DB',
                flexShrink: 0
              }}></div>
            </>
          )}

          {/* Display timeline items */}
          {displayItems.map((item, idx) => {
            const isCurrent = idx === displayIndex;
            
            return (
              <div key={`${item.type}-${idx}`} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                {/* Timeline Item Circle */}
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '6px',
                  minWidth: isCurrent ? '100px' : '80px',
                  flexShrink: 0
                }}>
                  <div style={{
                    width: isCurrent ? '70px' : '45px',
                    height: isCurrent ? '70px' : '45px',
                    borderRadius: '50%',
                    backgroundColor: '#FFFFFF',
                    border: isCurrent ? '3px solid #E17564' :
                            item.type === 'phase' ? '2px solid #09122C' :
                            item.type === 'evaluation' ? '2px solid #8B5CF6' :
                            item.type === 'breathe' ? '2px dashed #F59E0B' :
                            item.type === 'project_start' || item.type === 'project_end' ? '2px solid #09122C' : '2px solid #D1D5DB',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: isCurrent ? '14px' : item.type === 'phase' ? '12px' : item.type === 'evaluation' || item.type === 'breathe' ? '16px' : '20px',
                    fontWeight: '700',
                    color: isCurrent ? '#E17564' : 
                           item.type === 'phase' ? '#09122C' :
                           item.type === 'evaluation' ? '#8B5CF6' :
                           item.type === 'breathe' ? '#F59E0B' : '#09122C',
                    position: 'relative',
                    boxShadow: isCurrent ? '0 0 0 8px rgba(225, 117, 100, 0.15)' : 'none',
                    transition: 'all 0.3s ease',
                    padding: '8px',
                    textAlign: 'center'
                  }}>
                    {/* Show phase title for phase items, icon for others */}
                    {item.type === 'phase' ? (
                      <span style={{ fontSize: isCurrent ? '11px' : '9px', lineHeight: '1.2' }}>
                        {item.title}
                      </span>
                    ) : typeof item.icon === 'number' ? (
                      item.icon
                    ) : (
                      <item.icon />
                    )}
                  </div>
                  <div style={{
                    fontSize: isCurrent ? '12px' : '10px',
                    fontWeight: isCurrent ? '700' : '600',
                    color: '#FFFFFF',
                    textAlign: 'center',
                    maxWidth: '75px',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  }}>
                    {item.label}
                  </div>
                </div>

                {/* Connector to next item */}
                {idx < displayItems.length - 1 && (
                  <div style={{
                    width: '16px',
                    height: '2px',
                    backgroundColor: '#09122C',
                    flexShrink: 0
                  }}></div>
                )}
              </div>
            );
          })}

          {/* Show "Later" if not at end */}
          {endIdx < timelineItems.length - 1 && (
            <>
              <div style={{
                width: '16px',
                height: '2px',
                backgroundColor: '#09122C',
                flexShrink: 0
              }}></div>
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '8px',
                minWidth: '80px',
                flexShrink: 0
              }}>
                <div style={{
                  width: '40px',
                  height: '40px',
                  borderRadius: '50%',
                  backgroundColor: '#FFFFFF',
                  border: '2px solid #09122C',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '16px',
                  color: '#09122C'
                }}>
                  ...
                </div>
                <div style={{
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#09122C',
                  textAlign: 'center'
                }}>
                  Later
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    );
  };

  return (
    <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: '24px', flex: 1, overflow: 'auto' }}>
      {/* Project Timeline Visualization */}
      {taskAssignmentView.selectedProject && renderProjectTimeline()}

      {/* Main Content Card */}
      {taskAssignmentView.loading ? (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaSpinner style={{ 
              fontSize: '36px', 
              color: '#872341',
              animation: 'spin 1s linear infinite' 
            }} />
            <span style={{ 
              color: '#FAF8F1',
              fontSize: '14px',
              fontWeight: '500'
            }}>
              Loading task assignment data...
            </span>
          </div>
        </div>
      ) : taskAssignmentView.selectedProject ? (
        <div className="my-group-card-with-crosshair" style={{
          background: 'rgba(9, 18, 44, 0.15)',
          backdropFilter: 'blur(3.2px) saturate(120%)',
          WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
          border: '0.1px solid rgb(95, 95, 95)',
          borderRadius: '0px',
          overflow: 'hidden',
          height: '1000px',
          display: 'flex',
          flexDirection: 'column',
          position: 'relative'
        }}>
          <div className="crosshair-corner top-left" style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner top-right" style={{ pointerEvents: 'none', position: 'absolute', top: 0, right: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner bottom-left" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, left: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          <div className="crosshair-corner bottom-right" style={{ pointerEvents: 'none', position: 'absolute', bottom: 0, right: 0, zIndex: 10 }}>
            <div className="crosshair-h"></div>
            <div className="crosshair-v"></div>
          </div>
          {/* 4-Tab Navigation Bar */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(4, 1fr)',
            gap: '0',
            borderBottom: '0.1px solid rgb(95, 95, 95)',
            backgroundColor: 'rgba(9, 18, 44, 0.2)'
          }}>
            {/* Tab 1: Overview */}
            <button
              onClick={() => setTaskAssignmentView(prev => ({ ...prev, activeTab: 'overview', selectedMember: null }))}
              style={{
                padding: '16px',
                backgroundColor: taskAssignmentView.activeTab === 'overview' ? '#872341' : '#FFFFFF',
                color: taskAssignmentView.activeTab === 'overview' ? '#FFFFFF' : '#872341',
                border: 'none',
                borderRight: '0.1px solid rgb(95, 95, 95)',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px',
                minHeight: '80px'
              }}
              onMouseOver={(e) => {
                if (taskAssignmentView.activeTab !== 'overview') {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                }
              }}
              onMouseOut={(e) => {
                if (taskAssignmentView.activeTab !== 'overview') {
                  e.currentTarget.style.backgroundColor = '#FFFFFF';
                }
              }}
            >
              <FaEye style={{ fontSize: '20px' }} />
              <span>Overview</span>
            </button>

            {/* Tab 2: Assign */}
            <button
              onClick={() => setTaskAssignmentView(prev => ({ ...prev, activeTab: 'assign' }))}
              style={{
                padding: '16px',
                backgroundColor: taskAssignmentView.activeTab === 'assign' ? '#872341' : '#FFFFFF',
                color: taskAssignmentView.activeTab === 'assign' ? '#FFFFFF' : '#872341',
                border: 'none',
                borderRight: '0.1px solid rgb(95, 95, 95)',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px',
                minHeight: '80px'
              }}
              onMouseOver={(e) => {
                if (taskAssignmentView.activeTab !== 'assign') {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                }
              }}
              onMouseOut={(e) => {
                if (taskAssignmentView.activeTab !== 'assign') {
                  e.currentTarget.style.backgroundColor = '#FFFFFF';
                }
              }}
            >
              <FaHandPointRight style={{ fontSize: '20px' }} />
              <span>Assign</span>
            </button>

            {/* Tab 3: Manage */}
            <button
              onClick={() => setTaskAssignmentView(prev => ({ ...prev, activeTab: 'manage', selectedMember: null, selectedMemberFilter: 'all' }))}
              style={{
                padding: '16px',
                backgroundColor: taskAssignmentView.activeTab === 'manage' ? '#872341' : '#FFFFFF',
                color: taskAssignmentView.activeTab === 'manage' ? '#FFFFFF' : '#872341',
                border: 'none',
                borderRight: '0.1px solid rgb(95, 95, 95)',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px',
                minHeight: '80px'
              }}
              onMouseOver={(e) => {
                if (taskAssignmentView.activeTab !== 'manage') {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                }
              }}
              onMouseOut={(e) => {
                if (taskAssignmentView.activeTab !== 'manage') {
                  e.currentTarget.style.backgroundColor = '#FFFFFF';
                }
              }}
            >
              <FaClipboardList style={{ fontSize: '20px' }} />
              <span>Manage</span>
            </button>

            {/* Tab 4: Extension Requests */}
            <button
              onClick={() => {
                setTaskAssignmentView(prev => ({ ...prev, activeTab: 'extensions' }));
                if (groupData?.group_id) {
                  loadExtensionRequests(groupData.group_id);
                }
              }}
              style={{
                padding: '16px',
                backgroundColor: taskAssignmentView.activeTab === 'extensions' ? '#872341' : '#FFFFFF',
                color: taskAssignmentView.activeTab === 'extensions' ? '#FFFFFF' : '#872341',
                border: 'none',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px',
                minHeight: '80px'
              }}
              onMouseOver={(e) => {
                if (taskAssignmentView.activeTab !== 'extensions') {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                }
              }}
              onMouseOut={(e) => {
                if (taskAssignmentView.activeTab !== 'extensions') {
                  e.currentTarget.style.backgroundColor = '#FFFFFF';
                }
              }}
            >
              <FaClipboardCheck style={{ fontSize: '20px' }} />
              <span>Extension Requests</span>
            </button>
          </div>

          {/* Content Area - Changes based on active tab */}
          <div style={{ padding: '24px', flex: 1, overflowY: 'auto', overflowX: 'hidden' }}>
            {taskAssignmentView.activeTab === 'overview' && (
              <div>
                {/* Header with Title and Project Dates */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '24px',
                  marginBottom: '24px'
                }}>
                  {/* Project Start Pill */}
                  <div style={{
                    backgroundColor: '#DBEAFE',
                    border: '1px solid #0EA5E9',
                    color: '#0369A1',
                    padding: '12px 20px',
                    borderRadius: '20px',
                    fontSize: '12px',
                    fontWeight: '600',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '4px',
                    minWidth: '140px',
                    textAlign: 'center'
                  }}>
                    <span style={{ fontSize: '11px', opacity: 0.8 }}>PROJECT START</span>
                    <span style={{ fontSize: '14px', fontWeight: '700' }}>
                      {taskAssignmentView.selectedProject 
                        ? dayjs(taskAssignmentView.selectedProject.start_date).format('MMM DD')
                        : 'N/A'}
                    </span>
                  </div>

                  {/* Title with Subtext */}
                  <div style={{ flex: 1, textAlign: 'center' }}>
                    <h3 style={{
                      fontSize: '24px',
                      fontWeight: '700',
                      color: 'white',
                      margin: '0 0 8px 0'
                    }}>
                      Task Assignment Overview
                    </h3>
                    
                    {/* Current Phase Subtext */}
                    <div style={{
                      fontSize: '13px',
                      color: 'white',
                      fontWeight: '500'
                    }}>
                      {(() => {
                        // ‚úÖ DYNAMIC: Use the same phase detection as the carousel
                        const activeWorkPhase = detectCurrentActiveWorkPhase();
                        
                        if (!activeWorkPhase) {
                          return 'No active phase';
                        }

                        // Determine if we're in an evaluation or breathe period
                        const now = new Date();
                        const evalStart = activeWorkPhase.evaluation_available_from ? new Date(activeWorkPhase.evaluation_available_from) : null;
                        const evalEnd = activeWorkPhase.evaluation_due_date ? new Date(activeWorkPhase.evaluation_due_date) : null;
                        const breatheStart = activeWorkPhase.breathe_start_date ? new Date(activeWorkPhase.breathe_start_date) : null;
                        const breatheEnd = activeWorkPhase.breathe_end_date ? new Date(activeWorkPhase.breathe_end_date) : null;

                        if (evalStart && evalEnd && now >= evalStart && now <= evalEnd) {
                          return `Phase ${activeWorkPhase.phase_number} - Evaluation Period`;
                        }
                        if (breatheStart && breatheEnd && now >= breatheStart && now <= breatheEnd) {
                          return `Phase ${activeWorkPhase.phase_number} - Breathe Period`;
                        }
                        
                        return `Phase ${activeWorkPhase.phase_number}: ${activeWorkPhase.title}`;
                      })()}
                    </div>
                  </div>

                  {/* Project End Pill */}
                  <div style={{
                    backgroundColor: '#FEE2E2',
                    border: '1px solid #EF4444',
                    color: '#991B1B',
                    padding: '12px 20px',
                    borderRadius: '20px',
                    fontSize: '12px',
                    fontWeight: '600',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '4px',
                    minWidth: '140px',
                    textAlign: 'center'
                  }}>
                    <span style={{ fontSize: '11px', opacity: 0.8 }}>PROJECT END</span>
                    <span style={{ fontSize: '14px', fontWeight: '700' }}>
                      {taskAssignmentView.selectedProject 
                        ? dayjs(taskAssignmentView.selectedProject.due_date).format('MMM DD')
                        : 'N/A'}
                    </span>
                  </div>
                </div>

                {/* Min/Max Stats Pill - Combined */}
                <div style={{
                  display: 'flex',
                  gap: '16px',
                  justifyContent: 'center',
                  marginBottom: '32px'
                }}>
                  {/* Combined Min/Max Tasks Pill */}
                  <div style={{
                    backgroundColor: '#F3E8FF',
                    border: '1px solid #D8B4FE',
                    color: '#6B21A8',
                    padding: '12px 24px',
                    borderRadius: '20px',
                    fontSize: '13px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                  }}>
                    <span>Task Range:</span>
                    <span style={{ fontSize: '15px', fontWeight: '700' }}>
                      {taskAssignmentView.selectedProject?.min_tasks_per_member || 0} - {taskAssignmentView.selectedProject?.max_tasks_per_member || 0}
                    </span>
                  </div>
                </div>
                
                {/* Member Cards Grid */}
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                  gap: '24px'
                }}>
                  {taskAssignmentView.groupMembers.length > 0 ? (
                    taskAssignmentView.groupMembers.map(member => {
                      // Count tasks assigned to this member in the CURRENT ACTIVE PHASE only
                      // ‚úÖ DYNAMIC: Detect current active phase using the same logic as the carousel
                      const activeWorkPhase = detectCurrentActiveWorkPhase();
                      const tasksInCurrentPhase = activeWorkPhase 
                        ? getAssignedTaskCountForMemberPhase(member.student_id, activeWorkPhase.id)
                        : 0;
                      
                      return (
                        <div
                          key={member.student_id}
                          style={{
                            backgroundColor: 'white',
                            border: '1px solid #B9B28A',
                            borderRadius: '12px',
                            padding: '24px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            minHeight: '340px',
                            transition: 'all 0.3s ease',
                            boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)'
                          }}
                          onMouseOver={(e) => {
                            e.currentTarget.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.1)';
                            e.currentTarget.style.transform = 'translateY(-4px)';
                          }}
                          onMouseOut={(e) => {
                            e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.05)';
                            e.currentTarget.style.transform = 'translateY(0)';
                          }}
                        >
                          {/* Profile Picture */}
                          <div style={{
                            width: '80px',
                            height: '80px',
                            borderRadius: '50%',
                            backgroundColor: member.profile_image_url ? 'transparent' : '#34656D',
                            color: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '32px',
                            fontWeight: '600',
                            marginBottom: '16px',
                            overflow: 'hidden',
                            backgroundImage: member.profile_image_url ? `url(${getSupabaseImageUrl(member.profile_image_url)})` : 'none',
                            backgroundSize: 'cover',
                            backgroundPosition: 'center'
                          }}>
                            {!member.profile_image_url && (member.name?.charAt(0)?.toUpperCase() || '?')}
                          </div>

                          {/* Member Name */}
                          <div style={{
                            fontSize: '16px',
                            fontWeight: '700',
                            color: '#504B38',
                            textAlign: 'center',
                            marginBottom: '4px'
                          }}>
                            {member.name}
                          </div>

                          {/* Member Position */}
                          <div style={{
                            fontSize: '13px',
                            color: '#6B7280',
                            textTransform: 'capitalize',
                            marginBottom: '20px'
                          }}>
                            {member.role || 'Team Member'}
                          </div>

                          {/* Assigned Tasks / Evaluation Status Pill */}
                          {(() => {
                            // Determine if we're in an evaluation phase
                            const now = new Date();
                            const phases = taskAssignmentView.projectPhases?.sort((a, b) => a.phase_number - b.phase_number) || [];
                            
                            // Find which phase we're in (evaluation or regular)
                            let isEvaluationPhase = false;
                            let isLastEvalPhase = false;
                            let currentPhaseNumber = null;
                            
                            for (let phase of phases) {
                              // Check if in evaluation phase for this phase
                              if (phase.evaluation_available_from && phase.evaluation_due_date) {
                                const evalStart = new Date(phase.evaluation_available_from);
                                const evalEnd = new Date(phase.evaluation_due_date);
                                if (now >= evalStart && now <= evalEnd) {
                                  isEvaluationPhase = true;
                                  currentPhaseNumber = phase.phase_number;
                                  
                                  // Check if this is the last evaluation phase
                                  const laterPhases = phases.filter(p => p.phase_number > phase.phase_number);
                                  const hasLaterEval = laterPhases.some(p => p.evaluation_available_from && p.evaluation_due_date);
                                  isLastEvalPhase = !hasLaterEval;
                                  break;
                                }
                              }
                            }
                            
                            // If in evaluation phase, show evaluation status
                            if (isEvaluationPhase && currentPhaseNumber) {
                              return (
                                <div>
                                  {/* Phase Evaluation Status */}
                                  <div style={{
                                    backgroundColor: '#DBEAFE',
                                    border: '1px solid #0EA5E9',
                                    color: '#0369A1',
                                    padding: '12px 20px',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    marginBottom: '12px',
                                    justifyContent: 'center'
                                  }}>
                                    <span>Phase Eval:</span>
                                    <span style={{ fontSize: '16px', fontWeight: '700' }}>
                                      {member.phase_evaluations?.[currentPhaseNumber] ? '‚úì Submitted' : '‚úó Pending'}
                                    </span>
                                  </div>
                                  
                                  {/* Project Evaluation Status - Only if last eval phase */}
                                  {isLastEvalPhase && (
                                    <div style={{
                                      backgroundColor: '#FEF3C7',
                                      border: '1px solid #F59E0B',
                                      color: '#92400E',
                                      padding: '12px 20px',
                                      borderRadius: '20px',
                                      fontSize: '13px',
                                      fontWeight: '600',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '8px',
                                      marginBottom: '24px',
                                      justifyContent: 'center'
                                    }}>
                                      <span>Project Eval:</span>
                                      <span style={{ fontSize: '16px', fontWeight: '700' }}>
                                        {member.project_evaluation ? '‚úì Submitted' : '‚úó Pending'}
                                      </span>
                                    </div>
                                  )}
                                </div>
                              );
                            } else {
                              // Show assigned tasks during non-evaluation phases
                              return (
                                <div style={{
                                  backgroundColor: '#F3E8FF',
                                  border: '1px solid #D8B4FE',
                                  color: '#6B21A8',
                                  padding: '12px 20px',
                                  borderRadius: '20px',
                                  fontSize: '13px',
                                  fontWeight: '600',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '8px',
                                  marginBottom: '24px'
                                }}>
                                  <span>Assigned Tasks:</span>
                                  <span style={{ fontSize: '16px', fontWeight: '700' }}>{tasksInCurrentPhase}</span>
                                </div>
                              );
                            }
                          })()}


                          {/* Assign Button */}
                          <button
                            onClick={() => {
                              handleMemberSelectForAssignment(member);
                              setTaskAssignmentView(prev => ({ ...prev, activeTab: 'assign' }));
                            }}
                            style={{
                              width: '100%',
                              padding: '12px 24px',
                              backgroundColor: '#872341',
                              color: 'white',
                              border: 'none',
                              borderRadius: '8px',
                              fontSize: '14px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseOver={(e) => {
                              e.currentTarget.style.backgroundColor = '#6B1A33';
                              e.currentTarget.style.transform = 'scale(1.02)';
                            }}
                            onMouseOut={(e) => {
                              e.currentTarget.style.backgroundColor = '#872341';
                              e.currentTarget.style.transform = 'scale(1)';
                            }}
                          >
                            Assign Task
                          </button>
                        </div>
                      );
                    })
                  ) : (
                    <div style={{
                      gridColumn: '1 / -1',
                      textAlign: 'center',
                      padding: '60px 20px',
                      color: '#9CA3AF',
                      fontSize: '14px'
                    }}>
                      No group members found. Select a project to load members.
                    </div>
                  )}
                </div>
              </div>
            )}

            {taskAssignmentView.activeTab === 'assign' && (
              <div style={{
                display: 'grid',
                gridTemplateColumns: '300px 1fr',
                gap: '24px'
              }}>
              {/* Left Side - Member List */}
              <div style={{
                borderRight: '2px solid #E5E7EB',
                paddingRight: '24px'
              }}>
              <h3 style={{
                fontSize: '16px',
                fontWeight: '600',
                color: 'white',
                marginBottom: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                <FaUsers />
                Group Members
              </h3>
              
              {taskAssignmentView.groupMembers.length > 0 ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px'
                }}>
                  {taskAssignmentView.groupMembers.map(member => (
                    <div
                      key={member.student_id}
                      onClick={() => handleMemberSelectForAssignment(member)}
                      style={{
                        padding: '12px',
                        backgroundColor: taskAssignmentView.selectedMember?.student_id === member.student_id ? '#F8F3D9' : '#F9FAFB',
                        border: `2px solid ${taskAssignmentView.selectedMember?.student_id === member.student_id ? '#B9B28A' : '#E5E7EB'}`,
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onMouseOver={(e) => {
                        if (taskAssignmentView.selectedMember?.student_id !== member.student_id) {
                          e.currentTarget.style.backgroundColor = '#F8F3D9';
                          e.currentTarget.style.borderColor = '#B9B28A';
                        }
                      }}
                      onMouseOut={(e) => {
                        if (taskAssignmentView.selectedMember?.student_id !== member.student_id) {
                          e.currentTarget.style.backgroundColor = '#F9FAFB';
                          e.currentTarget.style.borderColor = '#E5E7EB';
                        }
                      }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                      }}>
                        {/* Member Avatar */}
                        <div style={{
                          width: '40px',
                          height: '40px',
                          borderRadius: '50%',
                          backgroundColor: member.profile_image_url ? 'transparent' : '#34656D',
                          color: 'white',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '16px',
                          fontWeight: '600',
                          flexShrink: 0,
                          overflow: 'hidden',
                          backgroundImage: member.profile_image_url ? `url(${getSupabaseImageUrl(member.profile_image_url)})` : 'none',
                          backgroundSize: 'cover',
                          backgroundPosition: 'center'
                        }}>
                          {!member.profile_image_url && (member.name?.charAt(0)?.toUpperCase() || '?')}
                        </div>
                        
                        {/* Member Info */}
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#504B38',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            {member.name}
                          </div>
                          <div style={{
                            fontSize: '12px',
                            color: '#6B7280',
                            textTransform: 'capitalize'
                          }}>
                            {member.role || 'Member'}
                          </div>
                        </div>

                        {/* Task Count Badge with Color Coding - Filtered by Selected Phase */}
                        {taskAssignmentView.selectedProject && taskAssignmentView.taskForm.phase_id && (
                          (() => {
                            const tasksInSelectedPhase = getAssignedTaskCountForMemberPhase(member.student_id, taskAssignmentView.taskForm.phase_id);
                            const min = taskAssignmentView.selectedProject.min_tasks_per_member || 0;
                            const max = taskAssignmentView.selectedProject.max_tasks_per_member || 0;
                            
                            let backgroundColor, textColor;
                            if (tasksInSelectedPhase < min) {
                              backgroundColor = '#FEE2E2';
                              textColor = '#DC2626';
                            } else if (tasksInSelectedPhase < max) {
                              backgroundColor = '#FEF3C7';
                              textColor = '#D97706';
                            } else {
                              backgroundColor = '#D1FAE5';
                              textColor = '#059669';
                            }
                            
                            return (
                              <div style={{
                                backgroundColor,
                                color: textColor,
                                padding: '4px 10px',
                                borderRadius: '12px',
                                fontSize: '12px',
                                fontWeight: '600',
                                whiteSpace: 'nowrap',
                                flexShrink: 0
                              }}>
                                {tasksInSelectedPhase}/{max}
                              </div>
                            );
                          })()
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div style={{
                  padding: '20px',
                  textAlign: 'center',
                  color: '#9CA3AF',
                  fontSize: '14px'
                }}>
                  No group members found
                </div>
              )}
            </div>

            {/* Right Side - Task Assignment Form */}
            <div style={{ paddingLeft: '24px' }}>
              {taskAssignmentView.selectedMember ? (
                <form onSubmit={handleTaskSubmitAssignment}>
                  {/* Centered Header Section */}
                  <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                    <h3 style={{
                      fontSize: '18px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '8px'
                    }}>
                      Create Task
                    </h3>
                    <p style={{
                      fontSize: '14px',
                      color: 'white',
                      marginBottom: '0'
                    }}>
                      Assigning to: <strong>{taskAssignmentView.selectedMember.name}</strong>
                    </p>
                  </div>

                  {/* Project Phase - Moved to Top */}
                  <div style={{ marginBottom: '24px' }}>
                    <label style={{
                      display: 'block',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '8px',
                      textAlign: 'center'
                    }}>
                      Project Phase <span style={{ color: '#EF4444' }}>*</span>
                    </label>
                    <select
                      value={taskAssignmentView.taskForm.phase_id || ''}
                      onChange={(e) => handleTaskFormChange('phase_id', e.target.value)}
                      required
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #E5E7EB',
                        borderRadius: '6px',
                        fontSize: '14px',
                        color: '#504B38',
                        backgroundColor: 'white',
                        cursor: 'pointer'
                      }}
                    >
                      <option value="">Select Phase</option>
                      {getAvailablePhasesForAssignment().map(phase => (
                        <option 
                          key={phase.id} 
                          value={phase.id}
                          disabled={!isPhaseAvailableForAssignment(phase)}
                        >
                          Phase {phase.phase_number}: {phase.title} ({dayjs(phase.start_date).format('MMM DD')} - {dayjs(phase.end_date).format('MMM DD')})
                          {!isPhaseAvailableForAssignment(phase) ? ' (Ended)' : ''}
                        </option>
                      ))}
                    </select>

                    {/* Show message if no phases available */}
                    {getAvailablePhasesForAssignment().filter(p => isPhaseAvailableForAssignment(p)).length === 0 && (
                      <div style={{
                        marginTop: '12px',
                        padding: '12px',
                        backgroundColor: '#FEE2E2',
                        border: '1px solid #FCA5A5',
                        borderRadius: '6px',
                        fontSize: '13px',
                        color: '#DC2626',
                        textAlign: 'center'
                      }}>
                        No phases available for assignment. All phases have ended.
                      </div>
                    )}

                    {/* Phase Details Section - Shows when phase is selected */}
                    {taskAssignmentView.taskForm.phase_id && getSelectedPhase() && (
                      <div style={{
                        marginTop: '12px',
                        padding: '12px',
                        backgroundColor: '#F3F4F6',
                        border: '1px solid #D1D5DB',
                        borderRadius: '6px',
                        fontSize: '13px',
                        color: '#374151',
                        lineHeight: '1.6'
                      }}>
                        <div style={{ marginBottom: '12px' }}>
                          <strong style={{ color: '#1F2937', fontSize: '14px' }}>
                            Phase {getSelectedPhase().phase_number}: {getSelectedPhase().title}
                          </strong>
                        </div>
                        
                        {getSelectedPhase().description && (
                          <div style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: '1px solid #D1D5DB' }}>
                            <p style={{ margin: '0', fontSize: '12px', color: '#6B7280' }}>
                              {getSelectedPhase().description}
                            </p>
                          </div>
                        )}
                        
                        {/* Duration Pills */}
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                          <div style={{
                            padding: '6px 12px',
                            backgroundColor: '#EBE5C2',
                            color: '#504B38',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '600',
                            textTransform: 'uppercase'
                          }}>
                            Start: {dayjs(getSelectedPhase().start_date).format('MMM DD, h:mm A')}
                          </div>
                          <div style={{
                            padding: '6px 12px',
                            backgroundColor: '#EBE5C2',
                            color: '#504B38',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '600',
                            textTransform: 'uppercase'
                          }}>
                            End: {dayjs(getSelectedPhase().end_date).format('MMM DD, h:mm A')}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Task Title */}
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{
                      display: 'block',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '8px'
                    }}>
                      Task Title <span style={{ color: '#EF4444' }}>*</span>
                    </label>
                    <input
                      type="text"
                      value={taskAssignmentView.taskForm.title}
                      onChange={(e) => handleTaskFormChange('title', e.target.value)}
                      placeholder="Enter task title"
                      required
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #E5E7EB',
                        borderRadius: '6px',
                        fontSize: '14px',
                        color: '#504B38'
                      }}
                    />
                  </div>

                  {/* Task Description */}
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{
                      display: 'block',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '8px'
                    }}>
                      Task Description <span style={{ color: '#EF4444' }}>*</span>
                    </label>
                    <textarea
                      value={taskAssignmentView.taskForm.description}
                      onChange={(e) => handleTaskFormChange('description', e.target.value)}
                      placeholder="Enter detailed task description"
                      required
                      rows={4}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #E5E7EB',
                        borderRadius: '6px',
                        fontSize: '14px',
                        color: '#504B38',
                        fontFamily: 'inherit',
                        resize: 'vertical'
                      }}
                    />
                  </div>

                  {/* Current Active Phase Indicator */}
                  {currentActivePhase && (
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        padding: '16px',
                        backgroundColor: '#FEF3E2',
                        border: '1px solid #E5B8A8',
                        borderRadius: '8px',
                        marginBottom: '16px'
                      }}>
                        <div className="active-phase-circle" style={{
                          width: '55px',
                          height: '55px',
                          minWidth: '55px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          borderRadius: '50%',
                          background: 'linear-gradient(135deg, #8b0000 0%, #b22222 100%)',
                          border: '4px solid white',
                          fontSize: '24px',
                          fontWeight: 'bold',
                          color: 'white',
                          boxShadow: '0 0 20px rgba(139, 0, 0, 0.4)',
                          animation: 'pulseRedWave 2s infinite'
                        }}>
                          {currentActivePhase.phase_number}
                        </div>
                        <div style={{
                          flex: 1
                        }}>
                          <h4 style={{
                            margin: '0 0 8px 0',
                            fontSize: '14px',
                            fontWeight: '600',
                            color: 'white'
                          }}>
                            Current Phase: {currentActivePhase.title}
                          </h4>
                          <div style={{
                            fontSize: '13px',
                            color: 'white'
                          }}>
                            {dayjs(currentActivePhase.start_date).format('MMM DD, h:mm A')} - {dayjs(currentActivePhase.end_date).format('MMM DD, h:mm A')}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Maximum Attempts */}
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{
                      display: 'block',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '8px'
                    }}>
                      Maximum Attempts <span style={{ color: '#EF4444' }}>*</span>
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="10"
                      value={taskAssignmentView.taskForm.max_attempts}
                      onChange={(e) => handleTaskFormChange('max_attempts', parseInt(e.target.value))}
                      required
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '1px solid #E5E7EB',
                        borderRadius: '6px',
                        fontSize: '14px',
                        color: '#504B38'
                      }}
                    />
                  </div>

                  {/* Due Date & Time and Available Until Date & Time - Same Row */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '16px',
                    marginBottom: '20px'
                  }}>
                    {/* Due Date and Time - Using MUI DateTimePicker */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: 'white',
                        marginBottom: '8px'
                      }}>
                        Due Date & Time <span style={{ color: '#EF4444' }}>*</span>
                      </label>
                      <LocalizationProvider dateAdapter={AdapterDayjs}>
                        <DateTimePicker
                          value={taskAssignmentView.taskForm.due_datetime}
                          onChange={(newValue) => handleTaskFormChange('due_datetime', newValue)}
                          disabled={!taskAssignmentView.taskForm.phase_id}
                          minDateTime={taskAssignmentView.taskForm.phase_id ? 
                            (dayjs().isAfter(dayjs(getSelectedPhase()?.start_date)) ? dayjs() : dayjs(getSelectedPhase()?.start_date)) : undefined}
                          maxDateTime={taskAssignmentView.taskForm.phase_id ? dayjs(getSelectedPhase()?.end_date) : undefined}
                          slotProps={{
                            textField: {
                              fullWidth: true,
                              size: 'small',
                              error: !!taskAssignmentView.dateValidationErrors?.due_date,
                              helperText: taskAssignmentView.dateValidationErrors?.due_date,
                              style: {
                                opacity: taskAssignmentView.taskForm.phase_id ? 1 : 0.5
                              },
                              sx: {
                                '& .MuiPickersOutlinedInput-root': {
                                  backgroundColor: 'white'
                                },
                                '& .MuiPickersInputBase-sectionContent': {
                                  color: taskAssignmentView.taskForm.due_datetime ? '#000000' : '#6B7280'
                                },
                                '& .MuiPickersInputBase-sectionSeparator': {
                                  color: taskAssignmentView.taskForm.due_datetime ? '#000000' : '#6B7280'
                                }
                              }
                            }
                          }}
                        />
                      </LocalizationProvider>
                      {taskAssignmentView.taskForm.phase_id && getSelectedPhase() && (
                        <div style={{
                          marginTop: '6px',
                          fontSize: '11px',
                          color: '#6B7280',
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '6px'
                        }}>
                          <FaCalendarAlt style={{ marginTop: '2px', flexShrink: 0 }} />
                          <span>Must be between {dayjs(getSelectedPhase().start_date).format('MMM D, h:mm A')} and {dayjs(getSelectedPhase().end_date).format('MMM D, h:mm A')}</span>
                        </div>
                      )}
                    </div>

                    {/* Available Until Date and Time - Using MUI DateTimePicker */}
                    <div>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '8px'
                      }}>
                        <label style={{
                          display: 'block',
                          fontSize: '14px',
                          fontWeight: '600',
                          color: 'white'
                        }}>
                          Available Until Date & Time
                        </label>
                        {taskAssignmentView.taskForm.available_until_datetime && (
                          <button
                            type="button"
                            onClick={() => handleTaskFormChange('available_until_datetime', null)}
                            style={{
                              fontSize: '12px',
                              fontWeight: '500',
                              color: '#EF4444',
                              backgroundColor: 'transparent',
                              border: '1px solid #EF4444',
                              borderRadius: '4px',
                              padding: '4px 10px',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseOver={(e) => {
                              e.currentTarget.style.backgroundColor = '#FEE2E2';
                            }}
                            onMouseOut={(e) => {
                              e.currentTarget.style.backgroundColor = 'transparent';
                            }}
                          >
                            Clear
                          </button>
                        )}
                      </div>
                      <LocalizationProvider dateAdapter={AdapterDayjs}>
                        <DateTimePicker
                          value={taskAssignmentView.taskForm.available_until_datetime}
                          onChange={(newValue) => handleTaskFormChange('available_until_datetime', newValue)}
                          disabled={!taskAssignmentView.taskForm.phase_id}
                          minDateTime={taskAssignmentView.taskForm.phase_id ? 
                            (dayjs().isAfter(dayjs(getSelectedPhase()?.start_date)) ? dayjs() : dayjs(getSelectedPhase()?.start_date)) : undefined}
                          maxDateTime={taskAssignmentView.taskForm.phase_id ? dayjs(getSelectedPhase()?.end_date) : undefined}
                          slotProps={{
                            textField: {
                              fullWidth: true,
                              size: 'small',
                              error: !!taskAssignmentView.dateValidationErrors?.available_until,
                              helperText: taskAssignmentView.dateValidationErrors?.available_until,
                              style: {
                                opacity: taskAssignmentView.taskForm.phase_id ? 1 : 0.5
                              },
                              sx: {
                                '& .MuiPickersOutlinedInput-root': {
                                  backgroundColor: 'white'
                                },
                                '& .MuiPickersInputBase-sectionContent': {
                                  color: taskAssignmentView.taskForm.available_until_datetime ? '#000000' : '#6B7280'
                                },
                                '& .MuiPickersInputBase-sectionSeparator': {
                                  color: taskAssignmentView.taskForm.available_until_datetime ? '#000000' : '#6B7280'
                                }
                              }
                            }
                          }}
                        />
                      </LocalizationProvider>
                      {taskAssignmentView.taskForm.phase_id && (
                        <div style={{
                          marginTop: '6px',
                          fontSize: '11px',
                          color: '#6B7280',
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '6px'
                        }}>
                          <FaClock style={{ marginTop: '2px', flexShrink: 0 }} />
                          <span>Optional - cannot exceed {dayjs(getSelectedPhase().end_date).format('MMM D, h:mm A')} or come before due date</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Allowed File Types */}
                  <div style={{ marginBottom: '24px' }}>
                    <label style={{
                      display: 'block',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white',
                      marginBottom: '12px'
                    }}>
                      Allowed File Types
                    </label>
                    
                    {/* Two-Panel File Type Selector */}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: '180px 1fr',
                      gap: '12px',
                      border: '1px solid #E5E7EB',
                      borderRadius: '6px',
                      overflow: 'hidden'
                    }}>
                      {/* Left Panel - Categories */}
                      <div style={{
                        backgroundColor: '#F9FAFB',
                        borderRight: '1px solid #E5E7EB',
                        maxHeight: '280px',
                        overflowY: 'auto'
                      }}>
                        {Object.keys(fileTypeCategories).map(category => {
                          const selectedCount = fileTypeCategories[category].filter(
                            type => taskAssignmentView.taskForm.file_types_allowed.includes(type)
                          ).length;
                          
                          return (
                            <div
                              key={category}
                              onClick={() => setSelectedFileTypeCategory(category)}
                              style={{
                                padding: '10px 12px',
                                cursor: 'pointer',
                                backgroundColor: selectedFileTypeCategory === category ? '#E8F1F2' : 'transparent',
                                borderBottom: '1px solid #E5E7EB',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                fontSize: '13px',
                                fontWeight: '500',
                                color: '#504B38',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseOver={(e) => {
                                if (selectedFileTypeCategory !== category) {
                                  e.currentTarget.style.backgroundColor = '#F3F4F6';
                                }
                              }}
                              onMouseOut={(e) => {
                                if (selectedFileTypeCategory !== category) {
                                  e.currentTarget.style.backgroundColor = 'transparent';
                                }
                              }}
                            >
                              <span>{category}</span>
                              {selectedCount > 0 && (
                                <span style={{
                                  backgroundColor: '#34656D',
                                  color: 'white',
                                  borderRadius: '12px',
                                  padding: '2px 6px',
                                  fontSize: '11px',
                                  fontWeight: '600'
                                }}>
                                  {selectedCount}
                                </span>
                              )}
                            </div>
                          );
                        })}
                      </div>

                      {/* Right Panel - File Types */}
                      <div style={{
                        padding: '12px',
                        maxHeight: '280px',
                        overflowY: 'auto',
                        backgroundColor: 'white'
                      }}>
                        {selectedFileTypeCategory ? (
                          <div>
                            <div style={{
                              marginBottom: '12px',
                              paddingBottom: '8px',
                              borderBottom: '1px solid #E5E7EB',
                              fontSize: '12px',
                              fontWeight: '600',
                              color: '#000000'
                            }}>
                              {selectedFileTypeCategory} File Types
                            </div>
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: 'repeat(2, 1fr)',
                              gap: '8px'
                            }}>
                              {fileTypeCategories[selectedFileTypeCategory].map(type => (
                                <label key={type} style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '8px',
                                  cursor: 'pointer',
                                  padding: '6px',
                                  borderRadius: '4px',
                                  backgroundColor: taskAssignmentView.taskForm.file_types_allowed.includes(type) ? '#E8F1F2' : 'transparent',
                                  transition: 'all 0.2s ease'
                                }}
                                onMouseOver={(e) => {
                                  e.currentTarget.style.backgroundColor = '#E8F1F2';
                                }}
                                onMouseOut={(e) => {
                                  if (!taskAssignmentView.taskForm.file_types_allowed.includes(type)) {
                                    e.currentTarget.style.backgroundColor = 'transparent';
                                  }
                                }}>
                                  <input
                                    type="checkbox"
                                    checked={taskAssignmentView.taskForm.file_types_allowed.includes(type)}
                                    onChange={() => handleFileTypeToggle(type)}
                                    style={{
                                      width: '16px',
                                      height: '16px',
                                      cursor: 'pointer',
                                      accentColor: '#872341'
                                    }}
                                  />
                                  <span style={{
                                    fontSize: '12px',
                                    color: '#000000',
                                    fontWeight: '500',
                                    textTransform: 'uppercase'
                                  }}>
                                    {type}
                                  </span>
                                </label>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            height: '100%',
                            color: '#000000',
                            fontSize: '13px',
                            fontStyle: 'italic'
                          }}>
                            Select a category to view file types
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Selected File Types Summary */}
                    {taskAssignmentView.taskForm.file_types_allowed.length > 0 && (
                      <div style={{
                        marginTop: '12px',
                        display: 'flex',
                        gap: '6px',
                        flexWrap: 'wrap',
                        alignItems: 'center'
                      }}>
                        <strong style={{ fontSize: '12px', color: 'white' }}>Selected:</strong>
                        {taskAssignmentView.taskForm.file_types_allowed.map(type => (
                          <span key={type} style={{
                            background: '#872341',
                            color: 'white',
                            padding: '4px 10px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '600',
                            textTransform: 'uppercase'
                          }}>
                            {type}
                          </span>
                        ))}
                        <button
                          type="button"
                          onClick={() => handleTaskFormChange('file_types_allowed', [])}
                          style={{
                            marginLeft: 'auto',
                            padding: '4px 10px',
                            backgroundColor: '#F3F4F6',
                            color: '#6B7280',
                            border: '1px solid #D1D5DB',
                            borderRadius: '4px',
                            fontSize: '12px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseOver={(e) => {
                            e.currentTarget.style.backgroundColor = '#E5E7EB';
                          }}
                          onMouseOut={(e) => {
                            e.currentTarget.style.backgroundColor = '#F3F4F6';
                          }}
                        >
                          Clear All
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Submit Button */}
                  <button
                    type="submit"
                    disabled={!taskAssignmentView.taskForm.phase_id || !isPhaseOpenForAssignments(getSelectedPhase())}
                    style={{
                      width: '100%',
                      padding: '12px 24px',
                      backgroundColor: (taskAssignmentView.taskForm.phase_id && isPhaseOpenForAssignments(getSelectedPhase())) ? '#872341' : '#D1D5DB',
                      color: (taskAssignmentView.taskForm.phase_id && isPhaseOpenForAssignments(getSelectedPhase())) ? 'white' : '#9CA3AF',
                      border: 'none',
                      borderRadius: '6px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: (taskAssignmentView.taskForm.phase_id && isPhaseOpenForAssignments(getSelectedPhase())) ? 'pointer' : 'not-allowed',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => {
                      if (taskAssignmentView.taskForm.phase_id && isPhaseOpenForAssignments(getSelectedPhase())) {
                        e.currentTarget.style.backgroundColor = '#6B1A33';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (taskAssignmentView.taskForm.phase_id && isPhaseOpenForAssignments(getSelectedPhase())) {
                        e.currentTarget.style.backgroundColor = '#872341';
                      }
                    }}
                    title={!taskAssignmentView.taskForm.phase_id ? 'Please select a phase' : !isPhaseOpenForAssignments(getSelectedPhase()) ? 'This phase has ended and cannot accept new assignments' : 'Assign task'}
                  >
                    {!taskAssignmentView.taskForm.phase_id ? 'Select a Phase First' : !isPhaseOpenForAssignments(getSelectedPhase()) ? 'Phase Ended - No New Assignments' : 'Assign Task'}
                  </button>
                </form>
              ) : (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  height: '100%',
                  minHeight: '300px',
                  color: '#9CA3AF',
                  fontSize: '16px',
                  fontStyle: 'italic'
                }}>
                  Select a member to assign a task
                </div>
              )}
            </div>
            </div>
            )}

            {taskAssignmentView.activeTab === 'manage' && (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '32px'
              }}>
                {/* Manage Tab Header - Centered */}
                <div style={{
                  textAlign: 'center',
                  width: '100%'
                }}>
                  <h3 style={{
                    fontSize: '28px',
                    fontWeight: '700',
                    color: 'white',
                    marginBottom: '8px',
                    textShadow: '0 2px 4px rgba(0,0,0,0.1)'
                  }}>
                    Manage Task Assignments
                  </h3>
                  <p style={{
                    fontSize: '14px',
                    color: '#E17564',
                    margin: 0
                  }}>
                    View and manage all assigned tasks across team members
                  </p>
                </div>



                {/* Phase Information & Tasks */}
                <div style={{ width: '100%', maxWidth: '1200px', margin: '0 auto' }}>
                  {(() => {
                    // Get the active phase from the project timeline carousel
                    const activeWorkPhase = detectCurrentActiveWorkPhase();
                    const phase = activeWorkPhase;

                    if (!phase) {
                      return (
                        <div style={{
                          textAlign: 'center',
                          padding: '80px 40px',
                          backgroundColor: 'rgba(255,255,255,0.05)',
                          borderRadius: '16px',
                          border: '2px dashed rgba(255,255,255,0.2)'
                        }}>
                          <FaTasks style={{ fontSize: '64px', marginBottom: '20px', color: '#E17564' }} />
                          <h3 style={{ fontSize: '22px', fontWeight: '700', marginBottom: '12px', color: 'white' }}>
                            No Active Phase
                          </h3>
                          <p style={{ fontSize: '15px', color: '#E17564', lineHeight: '1.6' }}>
                            Please select a project with an active phase to manage tasks.
                          </p>
                        </div>
                      );
                    }

                    // Group tasks by member
                    const tasksByMember = {};
                    taskAssignmentView.phaseTasks.forEach(task => {
                      const member = taskAssignmentView.groupMembers.find(m => m.student_id === task.assigned_to);
                      if (member) {
                        if (!tasksByMember[member.student_id]) {
                          tasksByMember[member.student_id] = {
                            member: member,
                            tasks: []
                          };
                        }
                        tasksByMember[member.student_id].tasks.push(task);
                      }
                    });

                    return (
                      <div style={{
                        backgroundColor: 'white',
                        borderRadius: '16px',
                        padding: '32px',
                        boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)'
                      }}>
                        {/* Phase Information */}
                        <div style={{
                          marginBottom: '32px',
                          paddingBottom: '24px',
                          borderBottom: '2px solid #F3F4F6'
                        }}>
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            marginBottom: '16px'
                          }}>
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '12px',
                              background: 'linear-gradient(135deg, #872341 0%, #BE3144 100%)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '20px',
                              fontWeight: '700',
                              color: 'white'
                            }}>
                              {phase.phase_number}
                            </div>
                            <div>
                              <h3 style={{
                                fontSize: '24px',
                                fontWeight: '700',
                                color: '#09122C',
                                margin: '0 0 4px 0'
                              }}>
                                {phase.title}
                              </h3>
                              <div style={{
                                fontSize: '13px',
                                color: '#6B7280',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px'
                              }}>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                  <FaCalendarAlt style={{ color: '#872341' }} />
                                  {dayjs(phase.start_date).format('MMM DD')} - {dayjs(phase.end_date).format('MMM DD, YYYY')}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Tasks by Member - Grid Layout */}
                        {Object.keys(tasksByMember).length === 0 ? (
                          <div style={{
                            textAlign: 'center',
                            padding: '60px 40px',
                            backgroundColor: '#F8F9FA',
                            borderRadius: '12px'
                          }}>
                            <FaTasks style={{ fontSize: '48px', marginBottom: '16px', color: '#D1D5DB' }} />
                            <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#6B7280' }}>
                              No tasks assigned yet
                            </h3>
                            <p style={{ fontSize: '14px', color: '#9CA3AF' }}>
                              Switch to the Assign tab to create tasks for this phase.
                            </p>
                          </div>
                        ) : (
                          <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))',
                            gap: '24px'
                          }}>
                            {Object.values(tasksByMember).map(({ member, tasks }) => (
                              <div
                                key={member.student_id}
                                style={{
                                  backgroundColor: 'white',
                                  borderRadius: '16px',
                                  padding: '24px',
                                  border: '2px solid #E9ECEF',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  minHeight: '350px',
                                  transition: 'all 0.3s ease',
                                  boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)'
                                }}
                                onMouseOver={(e) => {
                                  e.currentTarget.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.1)';
                                  e.currentTarget.style.transform = 'translateY(-4px)';
                                }}
                                onMouseOut={(e) => {
                                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
                                  e.currentTarget.style.transform = 'translateY(0)';
                                }}
                              >
                                {/* Member Profile Section */}
                                <div style={{
                                  display: 'flex',
                                  flexDirection: 'column',
                                  alignItems: 'center',
                                  paddingBottom: '20px',
                                  borderBottom: '2px solid #F3F4F6',
                                  marginBottom: '20px'
                                }}>
                                  {/* Avatar */}
                                  <div style={{
                                    width: '70px',
                                    height: '70px',
                                    borderRadius: '50%',
                                    backgroundColor: member.profile_image_url ? 'transparent' : '#872341',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '28px',
                                    fontWeight: '600',
                                    marginBottom: '12px',
                                    overflow: 'hidden',
                                    backgroundImage: member.profile_image_url ? `url(${getSupabaseImageUrl(member.profile_image_url)})` : 'none',
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    border: '3px solid #E9ECEF'
                                  }}>
                                    {!member.profile_image_url && (member.name?.charAt(0)?.toUpperCase() || '?')}
                                  </div>

                                  {/* Member Name */}
                                  <h4 style={{
                                    fontSize: '18px',
                                    fontWeight: '700',
                                    color: '#09122C',
                                    margin: '0 0 4px 0',
                                    textAlign: 'center'
                                  }}>
                                    {member.name}
                                  </h4>

                                  {/* Role Badge */}
                                  <div style={{
                                    backgroundColor: '#F3E8FF',
                                    border: '1px solid #D8B4FE',
                                    color: '#6B21A8',
                                    padding: '4px 12px',
                                    borderRadius: '12px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    textTransform: 'uppercase',
                                    marginBottom: '8px'
                                  }}>
                                    {member.role || 'Team Member'}
                                  </div>

                                  {/* Task Count */}
                                  <div style={{
                                    backgroundColor: '#DBEAFE',
                                    border: '1px solid #0EA5E9',
                                    color: '#0369A1',
                                    padding: '6px 16px',
                                    borderRadius: '16px',
                                    fontSize: '13px',
                                    fontWeight: '700'
                                  }}>
                                    {tasks.length} {tasks.length === 1 ? 'Task' : 'Tasks'}
                                  </div>
                                </div>

                                {/* Task List */}
                                <div style={{
                                  flex: 1,
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: '10px',
                                  overflowY: 'auto',
                                  maxHeight: '350px',
                                  paddingRight: '4px'
                                }}>
                                  {tasks.map((task, index) => (
                                    <div
                                      key={task.id}
                                      onClick={async () => {
                                        // Open modal immediately
                                        setTaskModal({
                                          isOpen: true,
                                          task: task,
                                          isEditing: true,
                                          latestStatus: null,
                                          statusLoading: true
                                        });

                                        // Fetch latest status in background
                                        const status = await fetchLatestTaskStatus(task.id);
                                        setTaskModal(prev => ({
                                          ...prev,
                                          latestStatus: status,
                                          statusLoading: false
                                        }));
                                      }}
                                      style={{
                                        backgroundColor: '#F8F9FA',
                                        border: '1px solid #E9ECEF',
                                        borderRadius: '10px',
                                        padding: '14px',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s ease',
                                        display: 'flex',
                                        alignItems: 'flex-start',
                                        gap: '12px'
                                      }}
                                      onMouseOver={(e) => {
                                        e.currentTarget.style.backgroundColor = '#FEF3E2';
                                        e.currentTarget.style.borderColor = '#872341';
                                        e.currentTarget.style.transform = 'translateX(4px)';
                                      }}
                                      onMouseOut={(e) => {
                                        e.currentTarget.style.backgroundColor = '#F8F9FA';
                                        e.currentTarget.style.borderColor = '#E9ECEF';
                                        e.currentTarget.style.transform = 'translateX(0)';
                                      }}
                                    >
                                      {/* Task Number Badge */}
                                      <div style={{
                                        minWidth: '28px',
                                        height: '28px',
                                        borderRadius: '50%',
                                        backgroundColor: '#872341',
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '12px',
                                        fontWeight: '700',
                                        flexShrink: 0
                                      }}>
                                        {index + 1}
                                      </div>

                                      {/* Task Details */}
                                      <div style={{ flex: 1, minWidth: 0 }}>
                                        <div style={{
                                          fontSize: '14px',
                                          fontWeight: '600',
                                          color: '#09122C',
                                          marginBottom: '6px',
                                          display: '-webkit-box',
                                          WebkitLineClamp: 2,
                                          WebkitBoxOrient: 'vertical',
                                          overflow: 'hidden',
                                          lineHeight: '1.4'
                                        }}>
                                          {task.title}
                                        </div>

                                        {/* Due Date */}
                                        {task.due_date && (
                                          <div style={{
                                            fontSize: '11px',
                                            color: '#6B7280',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px',
                                            marginBottom: '6px'
                                          }}>
                                            <FaClock />
                                            Due: {dayjs(task.due_date).format('MMM DD, h:mm A')}
                                          </div>
                                        )}

                                        {/* Description Preview */}
                                        {task.description && (
                                          <div style={{
                                            fontSize: '11px',
                                            color: '#9CA3AF',
                                            display: '-webkit-box',
                                            WebkitLineClamp: 2,
                                            WebkitBoxOrient: 'vertical',
                                            overflow: 'hidden',
                                            lineHeight: '1.3'
                                          }}>
                                            {task.description}
                                          </div>
                                        )}
                                      </div>

                                      {/* Edit Icon */}
                                      <div style={{
                                        color: '#872341',
                                        fontSize: '16px',
                                        flexShrink: 0,
                                        marginTop: '4px'
                                      }}>
                                        <FaEdit />
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}

            {/* Extension Requests Tab */}
            {taskAssignmentView.activeTab === 'extensions' && (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '24px'
              }}>
                {/* Header */}
                <div style={{
                  textAlign: 'center',
                  width: '100%'
                }}>
                  <h3 style={{
                    fontSize: '28px',
                    fontWeight: '700',
                    color: 'white',
                    marginBottom: '8px',
                    textShadow: '0 2px 4px rgba(0,0,0,0.1)'
                  }}>
                    Extension Requests
                  </h3>
                  <p style={{
                    fontSize: '14px',
                    color: '#E17564',
                    margin: 0
                  }}>
                    Review and manage deadline extension requests from team members
                  </p>
                </div>

                {/* Filter Controls */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  gap: '16px'
                }}>
                  {/* Status Filter */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                  }}>
                    <label style={{
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white'
                    }}>
                      Filter by Status:
                    </label>
                    <select
                      value={taskAssignmentView.extensionStatusFilter}
                      onChange={(e) => setTaskAssignmentView(prev => ({
                        ...prev,
                        extensionStatusFilter: e.target.value
                      }))}
                      style={{
                        padding: '8px 12px',
                        borderRadius: '8px',
                        border: '1px solid #872341',
                        backgroundColor: 'white',
                        color: '#872341',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer'
                      }}
                    >
                      <option value="all">All Requests</option>
                      <option value="pending">Pending</option>
                      <option value="approved">Approved</option>
                      <option value="rejected">Rejected</option>
                    </select>
                  </div>

                  {/* Refresh Button */}
                  <button
                    onClick={() => groupData?.group_id && loadExtensionRequests(groupData.group_id)}
                    style={{
                      padding: '8px 16px',
                      borderRadius: '8px',
                      border: 'none',
                      backgroundColor: '#872341',
                      color: 'white',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#6d1c34'}
                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#872341'}
                  >
                    <FaSyncAlt />
                    Refresh
                  </button>
                </div>

                {/* Extension Requests List */}
                {taskAssignmentView.loadingExtensionRequests ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: 'white'
                  }}>
                    <FaSpinner style={{ fontSize: '32px', animation: 'spin 1s linear infinite' }} />
                    <p style={{ marginTop: '16px', fontSize: '14px' }}>Loading extension requests...</p>
                  </div>
                ) : (() => {
                  // Filter requests based on status
                  const filteredRequests = taskAssignmentView.extensionRequests.filter(req => {
                    if (taskAssignmentView.extensionStatusFilter === 'all') return true;
                    return req.status === taskAssignmentView.extensionStatusFilter;
                  });

                  if (filteredRequests.length === 0) {
                    return (
                      <div style={{
                        textAlign: 'center',
                        padding: '80px 40px',
                        backgroundColor: 'rgba(255,255,255,0.05)',
                        borderRadius: '16px',
                        border: '2px dashed rgba(255,255,255,0.2)',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <FaClipboardCheck style={{ fontSize: '64px', marginBottom: '20px', color: '#E17564' }} />
                        <h3 style={{ fontSize: '22px', fontWeight: '700', marginBottom: '12px', color: 'white' }}>
                          No Extension Requests
                        </h3>
                        <p style={{ fontSize: '15px', color: '#E17564', lineHeight: '1.6' }}>
                          {taskAssignmentView.extensionStatusFilter === 'all'
                            ? 'There are no extension requests at this time.'
                            : `No ${taskAssignmentView.extensionStatusFilter} extension requests found.`}
                        </p>
                      </div>
                    );
                  }

                  return (
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '16px'
                    }}>
                      {filteredRequests.map(request => {
                        const statusColors = {
                          pending: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
                          approved: { bg: '#D1FAE5', border: '#10B981', text: '#065F46' },
                          rejected: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B' }
                        };
                        const colors = statusColors[request.status] || statusColors.pending;

                        // Get profile image URL using the same helper function as Assign tab
                        const profileImageUrl = getProfileImageUrl(request.student);

                        return (
                          <div
                            key={request.id}
                            style={{
                              backgroundColor: 'white',
                              borderRadius: '12px',
                              padding: '20px',
                              border: `2px solid ${colors.border}`,
                              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                            }}
                          >
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: '1fr auto',
                              gap: '20px',
                              alignItems: 'start'
                            }}>
                              {/* Left Side - Request Details */}
                              <div>
                                {/* Student Info with Profile Picture */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '12px',
                                  marginBottom: '16px'
                                }}>
                                  {/* Profile Picture */}
                                  <div style={{
                                    width: '48px',
                                    height: '48px',
                                    borderRadius: '50%',
                                    overflow: 'hidden',
                                    border: '2px solid #872341',
                                    flexShrink: 0,
                                    backgroundColor: '#F3F4F6'
                                  }}>
                                    {profileImageUrl ? (
                                      <img
                                        src={profileImageUrl}
                                        alt={`${request.student?.first_name} ${request.student?.last_name}`}
                                        style={{
                                          width: '100%',
                                          height: '100%',
                                          objectFit: 'cover'
                                        }}
                                        onError={(e) => {
                                          e.target.style.display = 'none';
                                          e.target.parentElement.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#872341;color:white;font-weight:600;font-size:18px;">' + 
                                            (request.student?.first_name?.[0] || '?') + '</div>';
                                        }}
                                      />
                                    ) : (
                                      <div style={{
                                        width: '100%',
                                        height: '100%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        background: '#872341',
                                        color: 'white',
                                        fontWeight: '600',
                                        fontSize: '18px'
                                      }}>
                                        {request.student?.first_name?.[0] || '?'}
                                      </div>
                                    )}
                                  </div>

                                  {/* Student Name and Status */}
                                  <div style={{ flex: 1 }}>
                                    <div style={{
                                      fontSize: '16px',
                                      fontWeight: '700',
                                      color: '#09122C',
                                      marginBottom: '4px'
                                    }}>
                                      {request.student?.first_name} {request.student?.last_name}
                                    </div>
                                    <div style={{
                                      fontSize: '12px',
                                      color: '#6B7280',
                                      fontWeight: '500'
                                    }}>
                                      {request.student?.student_number}
                                    </div>
                                  </div>

                                  {/* Status Badge */}
                                  <span style={{
                                    fontSize: '11px',
                                    fontWeight: '700',
                                    padding: '6px 12px',
                                    borderRadius: '12px',
                                    backgroundColor: colors.bg,
                                    color: colors.text,
                                    border: `1px solid ${colors.border}`,
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px',
                                    whiteSpace: 'nowrap'
                                  }}>
                                    {request.status}
                                  </span>
                                </div>

                                {/* Task Title */}
                                <div style={{
                                  fontSize: '14px',
                                  fontWeight: '600',
                                  color: '#6B7280',
                                  marginBottom: '12px',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '8px'
                                }}>
                                  <FaTasks style={{ color: '#872341' }} />
                                  Task: {request.tasks?.title || 'Unknown Task'}
                                </div>

                                {/* Reason */}
                                <div style={{
                                  fontSize: '13px',
                                  color: '#374151',
                                  marginBottom: '12px',
                                  padding: '12px',
                                  backgroundColor: '#F9FAFB',
                                  borderRadius: '8px',
                                  border: '2px solid #872341'
                                }}>
                                  <div style={{ fontWeight: '600', marginBottom: '6px', color: '#872341' }}>
                                    Reason:
                                  </div>
                                  {request.reason}
                                </div>

                                {/* Dates */}
                                <div style={{
                                  display: 'flex',
                                  gap: '16px',
                                  flexWrap: 'wrap',
                                  fontSize: '12px',
                                  color: '#6B7280'
                                }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                    <FaClock style={{ color: '#872341' }} />
                                    <strong>Original Due:</strong> {dayjs(request.original_due_date).format('MMM DD, YYYY h:mm A')}
                                  </div>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                    <FaCalendarAlt style={{ color: '#872341' }} />
                                    <strong>Requested:</strong> {dayjs(request.requested_at).format('MMM DD, YYYY h:mm A')}
                                  </div>
                                </div>

                                {/* Approval/Rejection Info */}
                                {request.status !== 'pending' && (
                                  <div style={{
                                    marginTop: '12px',
                                    padding: '10px',
                                    backgroundColor: request.status === 'approved' ? '#ECFDF5' : '#FEF2F2',
                                    borderRadius: '8px',
                                    fontSize: '12px',
                                    color: request.status === 'approved' ? '#065F46' : '#991B1B'
                                  }}>
                                    <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                      {request.status === 'approved' ? '‚úì Approved by Leader' : '‚úó Rejected by Leader'}
                                    </div>
                                    {request.status === 'approved' && request.new_due_date && (
                                      <div>New deadline: {dayjs(request.new_due_date).format('MMM DD, YYYY h:mm A')}</div>
                                    )}
                                    {request.leader_notes && (
                                      <div style={{ marginTop: '4px' }}>
                                        <strong>Note:</strong> {request.leader_notes}
                                      </div>
                                    )}
                                    {request.rejection_reason && (
                                      <div style={{ marginTop: '4px' }}>
                                        <strong>Reason:</strong> {request.rejection_reason}
                                      </div>
                                    )}
                                    {request.reviewed_at && (
                                      <div style={{ marginTop: '4px', fontSize: '11px', opacity: 0.8 }}>
                                        {dayjs(request.reviewed_at).format('MMM DD, YYYY h:mm A')}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>

                              {/* Right Side - Action Buttons (only for pending) */}
                              {request.status === 'pending' && (
                                <div style={{
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: '12px'
                                }}>
                                  <button
                                    onClick={() => handleExtensionRequestSelect(request)}
                                    style={{
                                      padding: '10px 20px',
                                      borderRadius: '8px',
                                      border: 'none',
                                      backgroundColor: '#10B981',
                                      color: 'white',
                                      fontSize: '14px',
                                      fontWeight: '600',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      gap: '8px',
                                      transition: 'all 0.2s ease',
                                      whiteSpace: 'nowrap'
                                    }}
                                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#059669'}
                                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#10B981'}
                                  >
                                    <FaCheck />
                                    Approve
                                  </button>
                                  <button
                                    onClick={() => handleExtensionRequestReject(request)}
                                    style={{
                                      padding: '10px 20px',
                                      borderRadius: '8px',
                                      border: 'none',
                                      backgroundColor: '#EF4444',
                                      color: 'white',
                                      fontSize: '14px',
                                      fontWeight: '600',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      gap: '8px',
                                      transition: 'all 0.2s ease',
                                      whiteSpace: 'nowrap'
                                    }}
                                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#DC2626'}
                                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#EF4444'}
                                  >
                                    <FaTimes />
                                    Reject
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        </div>
      ) : (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaProjectDiagram size={36} style={{ color: '#E17564', marginBottom: '4px' }} />
            <h3 style={{ color: '#FAF8F1', fontSize: '16px', fontWeight: '600', margin: '0' }}>Select a Project</h3>
            <p style={{ color: '#FAF8F1', fontSize: '13px', margin: '0', textAlign: 'center', maxWidth: '450px' }}>
              Select a project to assign tasks to group members
            </p>
          </div>
        </div>
      )}

      {/* Task Edit/Delete Modal */}
      {taskModal.isOpen && taskModal.task && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}
        onClick={() => setTaskModal({ isOpen: false, task: null, isEditing: false })}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '16px',
            padding: '32px',
            maxWidth: '600px',
            width: '90%',
            maxHeight: '90vh',
            overflow: 'auto',
            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.3)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              marginBottom: '24px',
              paddingBottom: '16px',
              borderBottom: '2px solid #F3F4F6'
            }}>
              {/* Title and Close Button Row */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                marginBottom: '12px'
              }}>
                <div style={{ flex: 1 }}>
                  <h3 style={{
                    fontSize: '20px',
                    fontWeight: '700',
                    color: '#09122C',
                    margin: '0 0 8px 0',
                    display: '-webkit-box',
                    WebkitLineClamp: 2,
                    WebkitBoxOrient: 'vertical',
                    overflow: 'hidden',
                    lineHeight: '1.3'
                  }}>
                    {taskModal.task.title}
                  </h3>
                  <div style={{
                    fontSize: '12px',
                    color: '#6B7280',
                    fontWeight: '500'
                  }}>
                    Editing Task
                  </div>
                </div>
                <button
                  onClick={() => setTaskModal({ isOpen: false, task: null, isEditing: false, latestStatus: null, statusLoading: false })}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '24px',
                    color: '#6B7280',
                    cursor: 'pointer',
                    padding: '4px',
                    marginLeft: '16px',
                    flexShrink: 0
                  }}
                >
                  <FaTimes />
                </button>
              </div>

              {/* Status Badge */}
              {taskModal.statusLoading ? (
                <div style={{
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '8px',
                  backgroundColor: '#F3F4F6',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#6B7280'
                }}>
                  <FaSpinner style={{ animation: 'spin 1s linear infinite' }} />
                  Loading status...
                </div>
              ) : taskModal.latestStatus ? (
                <div style={{
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '8px',
                  backgroundColor:
                    taskModal.latestStatus === 'approved' || taskModal.latestStatus === 'completed' ? '#D1FAE5' :
                    taskModal.latestStatus === 'pending' || taskModal.latestStatus === 'submitted' ? '#FEF3C7' :
                    taskModal.latestStatus === 'revision_requested' || taskModal.latestStatus === 'to_revise' ? '#FEE2E2' :
                    '#F3F4F6',
                  border: `1px solid ${
                    taskModal.latestStatus === 'approved' || taskModal.latestStatus === 'completed' ? '#059669' :
                    taskModal.latestStatus === 'pending' || taskModal.latestStatus === 'submitted' ? '#D97706' :
                    taskModal.latestStatus === 'revision_requested' || taskModal.latestStatus === 'to_revise' ? '#DC2626' :
                    '#D1D5DB'
                  }`,
                  color:
                    taskModal.latestStatus === 'approved' || taskModal.latestStatus === 'completed' ? '#065F46' :
                    taskModal.latestStatus === 'pending' || taskModal.latestStatus === 'submitted' ? '#92400E' :
                    taskModal.latestStatus === 'revision_requested' || taskModal.latestStatus === 'to_revise' ? '#991B1B' :
                    '#6B7280',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  fontSize: '13px',
                  fontWeight: '700',
                  textTransform: 'capitalize'
                }}>
                  {taskModal.latestStatus === 'approved' || taskModal.latestStatus === 'completed' ? <FaCheckCircle /> :
                   taskModal.latestStatus === 'pending' || taskModal.latestStatus === 'submitted' ? <FaClock /> :
                   taskModal.latestStatus === 'revision_requested' || taskModal.latestStatus === 'to_revise' ? <FaExclamationCircle /> :
                   <FaInfoCircle />}
                  {taskModal.latestStatus.replace('_', ' ')}
                </div>
              ) : (
                <div style={{
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '8px',
                  backgroundColor: '#F3F4F6',
                  border: '1px solid #D1D5DB',
                  color: '#6B7280',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  fontSize: '13px',
                  fontWeight: '600'
                }}>
                  <FaInfoCircle />
                  No submissions yet
                </div>
              )}
            </div>

            {/* Check if editing is allowed */}
            {(() => {
              // Can only edit if there are no submissions
              // Only consider it has submissions if there's an actual submission status (not just pending)
              const hasSubmissions = taskModal.latestStatus !== null && 
                                     taskModal.latestStatus !== 'pending' && 
                                     !taskModal.statusLoading;
              const isApproved = taskModal.latestStatus === 'approved' || taskModal.latestStatus === 'completed';
              const canEdit = !hasSubmissions; // Can only edit if no submissions at all

              return (
                <>
                  {/* Warning Message - Show if cannot edit */}
                  {hasSubmissions && !taskModal.statusLoading && (
                    <div style={{
                      backgroundColor: isApproved ? '#FEF3E2' : '#FEE2E2',
                      border: `2px solid ${isApproved ? '#F59E0B' : '#DC2626'}`,
                      borderRadius: '12px',
                      padding: '16px',
                      marginBottom: '20px',
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '12px'
                    }}>
                      <div style={{
                        color: isApproved ? '#D97706' : '#DC2626',
                        fontSize: '20px',
                        marginTop: '2px'
                      }}>
                        {isApproved ? <FaCheckCircle /> : <FaExclamationTriangle />}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '700',
                          color: isApproved ? '#92400E' : '#991B1B',
                          marginBottom: '4px'
                        }}>
                          {isApproved ? 'Task Approved - Editing Disabled' : 'Editing Restricted'}
                        </div>
                        <div style={{
                          fontSize: '13px',
                          color: isApproved ? '#92400E' : '#991B1B',
                          lineHeight: '1.5'
                        }}>
                          {isApproved
                            ? 'This task has been approved and can no longer be modified or deleted.'
                            : 'This task has active submissions and cannot be modified or deleted. Only tasks with no submissions can be edited.'}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Task Form */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                    {/* Title */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: canEdit ? '#09122C' : '#9CA3AF',
                        marginBottom: '8px'
                      }}>
                        Task Title
                      </label>
                      <input
                        type="text"
                        value={taskModal.task.title}
                        onChange={(e) => setTaskModal(prev => ({
                          ...prev,
                          task: { ...prev.task, title: e.target.value }
                        }))}
                        disabled={!canEdit}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #E9ECEF',
                          borderRadius: '8px',
                          fontSize: '14px',
                          outline: 'none',
                          transition: 'border-color 0.2s',
                          backgroundColor: canEdit ? 'white' : '#F3F4F6',
                          color: canEdit ? '#09122C' : '#9CA3AF',
                          cursor: canEdit ? 'text' : 'not-allowed'
                        }}
                        onFocus={(e) => canEdit && (e.target.style.borderColor = '#872341')}
                        onBlur={(e) => canEdit && (e.target.style.borderColor = '#E9ECEF')}
                      />
                    </div>

                    {/* Description */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: canEdit ? '#09122C' : '#9CA3AF',
                        marginBottom: '8px'
                      }}>
                        Description
                      </label>
                      <textarea
                        value={taskModal.task.description || ''}
                        onChange={(e) => setTaskModal(prev => ({
                          ...prev,
                          task: { ...prev.task, description: e.target.value }
                        }))}
                        disabled={!canEdit}
                        rows={4}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #E9ECEF',
                          borderRadius: '8px',
                          fontSize: '14px',
                          outline: 'none',
                          resize: 'vertical',
                          fontFamily: 'inherit',
                          backgroundColor: canEdit ? 'white' : '#F3F4F6',
                          color: canEdit ? '#09122C' : '#9CA3AF',
                          cursor: canEdit ? 'text' : 'not-allowed'
                        }}
                        onFocus={(e) => canEdit && (e.target.style.borderColor = '#872341')}
                        onBlur={(e) => canEdit && (e.target.style.borderColor = '#E9ECEF')}
                      />
                    </div>

                    {/* Max Attempts */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: canEdit ? '#09122C' : '#9CA3AF',
                        marginBottom: '8px'
                      }}>
                        Max Attempts
                      </label>
                      <input
                        type="number"
                        min="1"
                        value={taskModal.task.max_attempts}
                        onChange={(e) => setTaskModal(prev => ({
                          ...prev,
                          task: { ...prev.task, max_attempts: parseInt(e.target.value) || 1 }
                        }))}
                        disabled={!canEdit}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #E9ECEF',
                          borderRadius: '8px',
                          fontSize: '14px',
                          outline: 'none',
                          backgroundColor: canEdit ? 'white' : '#F3F4F6',
                          color: canEdit ? '#09122C' : '#9CA3AF',
                          cursor: canEdit ? 'text' : 'not-allowed'
                        }}
                        onFocus={(e) => canEdit && (e.target.style.borderColor = '#872341')}
                        onBlur={(e) => canEdit && (e.target.style.borderColor = '#E9ECEF')}
                      />
                    </div>

                    {/* Due Date */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: canEdit ? '#09122C' : '#9CA3AF',
                        marginBottom: '8px'
                      }}>
                        Due Date
                      </label>
                      <LocalizationProvider dateAdapter={AdapterDayjs}>
                        <DateTimePicker
                          value={taskModal.task.due_date ? dayjs(taskModal.task.due_date) : null}
                          onChange={(newValue) => {
                            if (canEdit) {
                              setTaskModal(prev => ({
                                ...prev,
                                task: { ...prev.task, due_date: newValue ? newValue.toISOString() : null }
                              }));
                            }
                          }}
                          disabled={!canEdit}
                          slotProps={{
                            textField: {
                              fullWidth: true,
                              sx: {
                                '& .MuiOutlinedInput-root': {
                                  backgroundColor: canEdit ? 'white' : '#F3F4F6',
                                  '& input': {
                                    color: taskModal.task.due_date ? (canEdit ? 'black' : '#9CA3AF') : 'grey',
                                    cursor: canEdit ? 'text' : 'not-allowed'
                                  }
                                }
                              }
                            }
                          }}
                        />
                      </LocalizationProvider>
                    </div>

                    {/* Available Until */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: canEdit ? '#09122C' : '#9CA3AF',
                        marginBottom: '8px'
                      }}>
                        Available Until
                      </label>
                      <LocalizationProvider dateAdapter={AdapterDayjs}>
                        <DateTimePicker
                          value={taskModal.task.available_until ? dayjs(taskModal.task.available_until) : null}
                          onChange={(newValue) => {
                            if (canEdit) {
                              setTaskModal(prev => ({
                                ...prev,
                                task: { ...prev.task, available_until: newValue ? newValue.toISOString() : null }
                              }));
                            }
                          }}
                          disabled={!canEdit}
                          slotProps={{
                            textField: {
                              fullWidth: true,
                              sx: {
                                '& .MuiOutlinedInput-root': {
                                  backgroundColor: canEdit ? 'white' : '#F3F4F6',
                                  '& input': {
                                    color: taskModal.task.available_until ? (canEdit ? 'black' : '#9CA3AF') : 'grey',
                                    cursor: canEdit ? 'text' : 'not-allowed'
                                  }
                                }
                              }
                            }
                          }}
                        />
                      </LocalizationProvider>
                    </div>

                    {/* Assigned To (Read-only) */}
                    <div>
                      <label style={{
                        display: 'block',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#09122C',
                        marginBottom: '8px'
                      }}>
                        Assigned To
                      </label>
                      <div style={{
                        padding: '12px',
                        backgroundColor: '#F8F9FA',
                        border: '2px solid #E9ECEF',
                        borderRadius: '8px',
                        fontSize: '14px',
                        color: '#6B7280'
                      }}>
                        {taskAssignmentView.groupMembers.find(m => m.student_id === taskModal.task.assigned_to)?.name || 'Unknown'}
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div style={{
                      display: 'flex',
                      gap: '12px',
                      marginTop: '16px',
                      paddingTop: '16px',
                      borderTop: '2px solid #F3F4F6'
                    }}>
                      <button
                        onClick={async () => {
                    if (!taskModal.task.title.trim()) {
                      alert('Please enter a task title');
                      return;
                    }

                    try {
                      const token = localStorage.getItem('token');
                      
                      // Update task via API
                      const updateResponse = await fetch(
                        `${apiConfig.baseURL}/api/student-leader/tasks/${taskModal.task.id}`,
                        {
                          method: 'PUT',
                          headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                            title: taskModal.task.title,
                            description: taskModal.task.description,
                            max_attempts: taskModal.task.max_attempts,
                            due_date: taskModal.task.due_date,
                            available_until: taskModal.task.available_until
                          })
                        }
                      );

                      if (!updateResponse.ok) throw new Error('Failed to update task');

                      // Refresh tasks
                      const activePhase = detectCurrentActiveWorkPhase();
                      if (activePhase) {
                        const tasksResponse = await fetch(
                          `${apiConfig.baseURL}/api/student-leader/projects/${taskAssignmentView.selectedProject.id}/phases/${activePhase.id}/tasks`,
                          {
                            headers: {
                              'Authorization': `Bearer ${token}`,
                              'Content-Type': 'application/json'
                            }
                          }
                        );

                        if (tasksResponse.ok) {
                          const tasksData = await tasksResponse.json();
                          setTaskAssignmentView(prev => ({
                            ...prev,
                            phaseTasks: Array.isArray(tasksData) ? tasksData : (tasksData.tasks || [])
                          }));
                        }
                      }

                      alert('Task updated successfully!');
                      setTaskModal({ isOpen: false, task: null, isEditing: false, latestStatus: null, statusLoading: false });
                    } catch (error) {
                      console.error('Error updating task:', error);
                      alert('Failed to update task. Please try again.');
                    }
                  }}
                        disabled={!canEdit}
                        style={{
                          flex: 1,
                          padding: '14px',
                          backgroundColor: canEdit ? '#872341' : '#D1D5DB',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '16px',
                          fontWeight: '600',
                          cursor: canEdit ? 'pointer' : 'not-allowed',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: '8px',
                          opacity: canEdit ? 1 : 0.6
                        }}
                        onMouseOver={(e) => {
                          if (canEdit) {
                            e.currentTarget.style.backgroundColor = '#BE3144';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (canEdit) {
                            e.currentTarget.style.backgroundColor = '#872341';
                          }
                        }}
                        title={!canEdit ? 'Cannot modify task with existing submissions' : 'Save changes to this task'}
                      >
                        <FaEdit /> Save Changes
                      </button>

                      <button
                        onClick={async () => {
                          if (!canEdit) return;

                          if (!window.confirm('Are you sure you want to delete this task? This will also delete all submissions and feedback.')) {
                      return;
                    }

                    try {
                      const token = localStorage.getItem('token');
                      
                      // Delete task via API (cascade will handle submissions and revisions on backend)
                      const deleteResponse = await fetch(
                        `${apiConfig.baseURL}/api/student-leader/tasks/${taskModal.task.id}`,
                        {
                          method: 'DELETE',
                          headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                          }
                        }
                      );

                      if (!deleteResponse.ok) throw new Error('Failed to delete task');

                      // Refresh tasks
                      const activePhase = detectCurrentActiveWorkPhase();
                      if (activePhase) {
                        const tasksResponse = await fetch(
                          `${apiConfig.baseURL}/api/student-leader/projects/${taskAssignmentView.selectedProject.id}/phases/${activePhase.id}/tasks`,
                          {
                            headers: {
                              'Authorization': `Bearer ${token}`,
                              'Content-Type': 'application/json'
                            }
                          }
                        );

                        if (tasksResponse.ok) {
                          const tasksData = await tasksResponse.json();
                          setTaskAssignmentView(prev => ({
                            ...prev,
                            phaseTasks: Array.isArray(tasksData) ? tasksData : (tasksData.tasks || [])
                          }));
                        }
                      }

                      alert('Task deleted successfully!');
                      setTaskModal({ isOpen: false, task: null, isEditing: false, latestStatus: null, statusLoading: false });
                    } catch (error) {
                      console.error('Error deleting task:', error);
                      alert('Failed to delete task. Please try again.');
                    }
                  }}
                        disabled={!canEdit}
                        style={{
                          padding: '14px 24px',
                          backgroundColor: canEdit ? '#BE3144' : '#D1D5DB',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '16px',
                          fontWeight: '600',
                          cursor: canEdit ? 'pointer' : 'not-allowed',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          opacity: canEdit ? 1 : 0.6
                        }}
                        onMouseOver={(e) => {
                          if (canEdit) {
                            e.currentTarget.style.backgroundColor = '#8B1F2C';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (canEdit) {
                            e.currentTarget.style.backgroundColor = '#BE3144';
                          }
                        }}
                        title={!canEdit ? 'Cannot delete task with existing submissions' : 'Delete this task'}
                      >
                        <FaTimes /> Delete
                      </button>
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      )}
    </div>
  );
};

// =================== DELIVERABLES SUBMISSION RENDER ===================
const renderDeliverablesSubmission = () => {
  // Handler for project selection
  const handleDeliverablesProjectSelect = async (project) => {
    setDeliverablesView(prev => ({
      ...prev,
      selectedProject: project,
      showProjectDropdown: false,
      loading: true
    }));

    try {
      const token = localStorage.getItem('token');
      
      // Fetch phases for the project using the correct endpoint
      const phasesResponse = await fetch(
        `${apiConfig.baseURL}/api/student-leader/projects/${project.id}/phases`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (!phasesResponse.ok) throw new Error('Failed to fetch phases');
      let phasesData = await phasesResponse.json();
      console.log('üìÖ Raw phases response:', phasesData);
      
      // Handle different response formats
      if (phasesData.phases) {
        phasesData = phasesData.phases;
      } else if (phasesData.data) {
        phasesData = phasesData.data;
      }
      
      console.log('üìÖ Extracted phases data:', phasesData);
      
      // Ensure phasesData is an array
      if (!Array.isArray(phasesData)) {
        phasesData = [];
      }

      // üî• NEW: Fetch phase deliverable submissions for each phase
      console.log('üìã Fetching submissions for', phasesData.length, 'phases');
      
      // Fetch the project dashboard to get the correct group_id for THIS project
      const dashboardResponse = await fetch(
        `${apiConfig.baseURL}/api/student/projects/${project.id}/dashboard`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      let group_id = groupData?.group_id || groupData?.id; // Fallback to global groupData (prefer group_id over id)
      
      if (dashboardResponse.ok) {
        const dashboardData = await dashboardResponse.json();
        // Use the group_id from this specific project's dashboard
        group_id = dashboardData.group?.group_id || dashboardData.group?.id || group_id;
        console.log('üìã Using group_id from project dashboard:', group_id, dashboardData.group);
      } else {
        console.log('üìã Using fallback group_id:', group_id);
      }
      
      const phasesWithSubmissions = await Promise.all(
        phasesData.map(async (phase) => {
          try {
            const submissionResponse = await fetch(
              `${apiConfig.baseURL}/api/student/phases/${phase.id}/deliverable-submissions?group_id=${group_id}`,
              {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              }
            );

            if (submissionResponse.ok) {
              const submissionData = await submissionResponse.json();
              console.log(`‚úÖ Phase ${phase.phase_number} submissions:`, submissionData);
              return {
                ...phase,
                submissionDetails: submissionData.submissions || submissionData || []
              };
            } else {
              console.log(`‚ÑπÔ∏è No submissions found for phase ${phase.phase_number}`);
              return {
                ...phase,
                submissionDetails: []
              };
            }
          } catch (error) {
            console.error(`‚ùå Error fetching submissions for phase ${phase.phase_number}:`, error);
            return {
              ...phase,
              submissionDetails: []
            };
          }
        })
      );

      // Fetch project deliverable submission
      let projectSubmissionData = null;
      try {
        const projectSubmissionResponse = await fetch(
          `${apiConfig.baseURL}/api/student/projects/${project.id}/deliverable-submissions?group_id=${group_id}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (projectSubmissionResponse.ok) {
          const projectData = await projectSubmissionResponse.json();
          console.log('üì¶ Project submission data:', projectData);
          projectSubmissionData = projectData.submissions || projectData || [];
        } else {
          console.log('‚ÑπÔ∏è No project submission found');
        }
      } catch (error) {
        console.error('‚ùå Error fetching project submission:', error);
      }

      setDeliverablesView(prev => ({
        ...prev,
        phases: phasesWithSubmissions,
        projectSubmission: projectSubmissionData,
        loading: false,
        selectedDeliverable: null,
        deliverableType: null
      }));
    } catch (error) {
      console.error('Error loading deliverables data:', error);
      setDeliverablesView(prev => ({ ...prev, loading: false }));
    }
  };

  // Handler for deliverable selection (phase or project)
  const handleDeliverableSelect = async (deliverable, type) => {
    setDeliverablesView(prev => ({
      ...prev,
      selectedDeliverable: deliverable,
      deliverableType: type,
      detailsLoading: false
    }));

    // Note: Submission details loading logic would go here if backend endpoints exist
    // For now, we'll just display the deliverable without fetching additional details
  };

  // Handler for phase submission
  const handlePhaseDeliverableSubmit = async (phaseId, files, submissionText) => {
    try {
      const token = localStorage.getItem('token');
      const formData = new FormData();
      
      formData.append('phase_id', phaseId);
      formData.append('group_id', groupData.id);
      formData.append('submission_text', submissionText || '');
      
      files.forEach((file, index) => {
        formData.append(`files`, file);
      });

      const response = await fetch(
        `${apiConfig.baseURL}/api/student-leader/phase-submissions/submit`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        }
      );

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to submit phase deliverable');
      }

      alert('Phase deliverable submitted successfully!');
      
      // Refresh the deliverable details
      if (deliverablesView.selectedDeliverable && deliverablesView.deliverableType === 'phase') {
        handleDeliverableSelect(deliverablesView.selectedDeliverable, 'phase');
      }
    } catch (error) {
      console.error('Error submitting phase deliverable:', error);
      alert(`Error: ${error.message}`);
    }
  };

  // Handler for project submission
  const handleProjectDeliverableSubmit = async (files, submissionText) => {
    try {
      const token = localStorage.getItem('token');
      const formData = new FormData();
      
      formData.append('project_id', deliverablesView.selectedProject.id);
      formData.append('group_id', groupData.id);
      formData.append('submission_text', submissionText || '');
      
      files.forEach((file, index) => {
        formData.append(`files`, file);
      });

      const response = await fetch(
        `${apiConfig.baseURL}/api/student-leader/project-submissions/submit`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        }
      );

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to submit project deliverable');
      }

      alert('Project deliverable submitted successfully!');
      
      // Refresh project submission data
      handleDeliverablesProjectSelect(deliverablesView.selectedProject);
    } catch (error) {
      console.error('Error submitting project deliverable:', error);
      alert(`Error: ${error.message}`);
    }
  };

  return (
    <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: '24px', flex: 1, overflow: 'auto' }}>
      {/* Main Content */}
      {deliverablesView.loading ? (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1,
          width: '100%'
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaSpinner style={{ 
              fontSize: '36px', 
              color: '#872341',
              animation: 'spin 1s linear infinite' 
            }} />
            <span style={{ 
              color: '#FAF8F1',
              fontSize: '14px',
              fontWeight: '500'
            }}>
              Loading deliverables data...
            </span>
          </div>
        </div>
      ) : deliverablesView.selectedProject ? (
        <div className="submission-checking-container" style={{ display: 'flex', flexDirection: 'column', flex: 1 }}>
          <div className="deliverables-submission-main-container" style={{background: 'rgba(9, 18, 44, 0.15)', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)', borderRadius: '0px', position: 'relative'}}>
            {/* Crosshair Corners */}
            <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
            
            {/* Two Column Layout - Left: List, Right: Details */}
          <div className="deliverables-submission-grid">
            {/* Left Side - Deliverables List */}
            <div className="deliverables-submission-left">
              <div style={{
                padding: '16px',
                borderBottom: '2px solid #E5E7EB',
                fontWeight: '700',
                fontSize: '14px',
                color: '#2c3e50',
                backgroundColor: 'white'
              }}>
                Deliverables
              </div>
              <div style={{
                flex: 1,
                overflowY: 'auto',
                minHeight: 0
              }}>
                {/* Phase Deliverables */}
                {deliverablesView.phases.map(phase => {
                  // Determine phase status for left column indicator
                  const getPhaseStatus = () => {
                    if (!phase.submissionDetails || phase.submissionDetails.length === 0) {
                      const now = new Date();
                      const phaseEndDate = new Date(phase.end_date);
                      
                      if (now > phaseEndDate) {
                        return { status: 'MISSED', color: '#DC2626', bgColor: '#FEE2E2' };
                      }
                      return { status: 'NOT SUBMITTED', color: '#F59E0B', bgColor: '#FEF3C7' };
                    }
                    return { status: 'SUBMITTED', color: '#059669', bgColor: '#D1FAE5' };
                  };
                  
                  const phaseStatus = getPhaseStatus();
                  
                  return (
                  <div
                    key={phase.id}
                    onClick={() => handleDeliverableSelect(phase, 'phase')}
                    style={{
                      padding: '16px',
                      borderBottom: '1px solid #E5E7EB',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease',
                      backgroundColor: deliverablesView.selectedDeliverable?.id === phase.id && deliverablesView.deliverableType === 'phase' ? '#F8F3D9' : 'white',
                      borderLeft: deliverablesView.selectedDeliverable?.id === phase.id && deliverablesView.deliverableType === 'phase' ? '4px solid #34656D' : '4px solid transparent'
                    }}
                    onMouseOver={(e) => {
                      if (deliverablesView.selectedDeliverable?.id !== phase.id || deliverablesView.deliverableType !== 'phase') {
                        e.currentTarget.style.backgroundColor = '#f0f8ff';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (deliverablesView.selectedDeliverable?.id !== phase.id || deliverablesView.deliverableType !== 'phase') {
                        e.currentTarget.style.backgroundColor = 'white';
                      }
                    }}
                  >
                    {/* Phase Header */}
                    <div style={{
                      fontSize: '15px',
                      fontWeight: '700',
                      color: '#2c3e50',
                      marginBottom: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px'
                    }}>
                      <span style={{
                        backgroundColor: '#34656D',
                        color: 'white',
                        padding: '4px 10px',
                        borderRadius: '4px',
                        fontSize: '12px',
                        fontWeight: '700',
                        minWidth: '50px',
                        textAlign: 'center'
                      }}>
                        Phase {phase.phase_number}
                      </span>
                      <span style={{
                        flex: 1,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap',
                        fontSize: '14px'
                      }}>
                        {phase.title}
                      </span>
                      {/* Status Indicator Badge */}
                      <span style={{
                        fontSize: '9px',
                        fontWeight: '700',
                        padding: '3px 8px',
                        borderRadius: '10px',
                        backgroundColor: phaseStatus.bgColor,
                        color: phaseStatus.color,
                        border: `1px solid ${phaseStatus.color}`,
                        whiteSpace: 'nowrap',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                      }}>
                        {phaseStatus.status}
                      </span>
                    </div>
                    
                    {/* Date Pills */}
                    <div style={{
                      display: 'flex',
                      gap: '8px',
                      flexWrap: 'wrap'
                    }}>
                      {/* Start Date Pill */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        color: '#6B7280',
                        padding: '6px 12px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: '600',
                        whiteSpace: 'nowrap',
                        border: '1px solid #E5E7EB'
                      }}>
                        <FaCalendar style={{ fontSize: '13px' }} />
                        <span>Start: {new Date(phase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                      </div>
                      
                      {/* End Date Pill */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        color: '#6B7280',
                        padding: '6px 12px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: '600',
                        whiteSpace: 'nowrap',
                        border: '1px solid #E5E7EB'
                      }}>
                        <FaClock style={{ fontSize: '13px' }} />
                        <span>Due: {new Date(phase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                      </div>
                    </div>
                  </div>
                  );
                })}
                
                {/* Project Deliverable */}
                <div
                  onClick={() => handleDeliverableSelect(deliverablesView.selectedProject, 'project')}
                  style={{
                    padding: '16px',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    backgroundColor: deliverablesView.deliverableType === 'project' ? '#F8F3D9' : 'white',
                    borderTop: '2px solid #E5E7EB',
                    borderLeft: deliverablesView.deliverableType === 'project' ? '4px solid #34656D' : '4px solid transparent',
                    marginTop: 'auto'
                  }}
                  onMouseOver={(e) => {
                    if (deliverablesView.deliverableType !== 'project') {
                      e.currentTarget.style.backgroundColor = '#f0f8ff';
                    }
                  }}
                  onMouseOut={(e) => {
                    if (deliverablesView.deliverableType !== 'project') {
                      e.currentTarget.style.backgroundColor = 'white';
                    }
                  }}
                >
                  <div style={{
                    fontSize: '15px',
                    fontWeight: '700',
                    color: '#2c3e50',
                    marginBottom: '10px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <FaFileAlt style={{
                      fontSize: '16px',
                      color: '#34656D'
                    }} />
                    <span>
                      Project Deliverable
                    </span>
                  </div>
                  
                  {/* Project Due Date Pill */}
                  {deliverablesView.selectedProject?.due_date && (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      color: '#6B7280',
                      padding: '6px 12px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      fontWeight: '600',
                      width: 'fit-content',
                      border: '1px solid #E5E7EB'
                    }}>
                      <FaClock style={{ fontSize: '13px' }} />
                      <span>Due: {new Date(deliverablesView.selectedProject.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Right Side - Deliverable Details */}
            <div className="deliverables-submission-right">
              {/* Scrollable inner area: this is what actually scrolls when content overflows */}
              <div style={{ flex: 1, minHeight: 0, overflow: 'auto', boxSizing: 'border-box' }}>
                {deliverablesView.detailsLoading ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    height: '100%',
                    padding: '24px'
                  }}>
                    <div style={{
                      width: '500px',
                      height: '150px',
                      backgroundColor: 'rgba(9, 18, 44, 0.15)',
                      backdropFilter: 'blur(3.2px) saturate(120%)',
                      WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                      border: '0.1px solid rgb(95, 95, 95)',
                      borderRadius: '12px',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '16px',
                      boxSizing: 'border-box',
                      padding: '24px'
                    }}>
                      <FaSpinner style={{ 
                        fontSize: '48px', 
                        color: '#872341',
                        animation: 'spin 1s linear infinite' 
                      }} />
                      <span style={{ 
                        color: '#FAF8F1',
                        fontSize: '14px',
                        fontWeight: '500'
                      }}>
                        Loading details...
                      </span>
                    </div>
                  </div>
                ) : deliverablesView.selectedDeliverable ? (
                  deliverablesView.deliverableType === 'phase' ? (
                    <DeliverablePhaseDetails 
                      phase={deliverablesView.selectedDeliverable}
                      project={deliverablesView.selectedProject}
                      groupData={groupData}
                      onSubmit={handlePhaseDeliverableSubmit}
                    />
                  ) : (
                    <DeliverableProjectDetails 
                      project={deliverablesView.selectedProject}
                      projectSubmission={deliverablesView.projectSubmission}
                      groupData={groupData}
                      onSubmit={handleProjectDeliverableSubmit}
                    />
                  )
                ) : (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    height: '100%',
                    padding: '24px'
                  }}>
                    <div style={{
                      width: '500px',
                      minHeight: '150px',
                      backgroundColor: 'rgba(9, 18, 44, 0.15)',
                      backdropFilter: 'blur(3.2px) saturate(120%)',
                      WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                      border: '0.1px solid rgb(95, 95, 95)',
                      borderRadius: '12px',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '16px',
                      boxSizing: 'border-box',
                      padding: '24px'
                    }}>
                      <FaClipboardList style={{ fontSize: '48px', color: '#E17564', opacity: 0.7 }} />
                      <p style={{ fontSize: '16px', fontWeight: '500', margin: 0, color: '#FAF8F1', textAlign: 'center' }}>
                        Select a deliverable to view details
                      </p>
                      <p style={{ fontSize: '12px', color: '#E17564', marginTop: '8px', textAlign: 'center' }}>
                        Click on any phase or project deliverable from the list
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
        </div>
      ) : (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1,
          width: '100%'
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaClipboardList size={36} style={{ color: '#E17564', marginBottom: '4px' }} />
            <h3 style={{ color: '#FAF8F1', fontSize: '16px', fontWeight: '600', margin: '0' }}>Select a Project</h3>
            <p style={{ color: '#FAF8F1', fontSize: '13px', margin: '0', textAlign: 'center', maxWidth: '450px' }}>
              Select a project to view deliverables
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

// Deliverable Phase Details Component
const DeliverablePhaseDetails = ({ phase, project, groupData, onSubmit }) => {
  const [files, setFiles] = useState([]);
  const [submissionText, setSubmissionText] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [memberTasks, setMemberTasks] = useState({});
  const [loadingTasks, setLoadingTasks] = useState(false);
  const [expandedCards, setExpandedCards] = useState({});
  const [minTasksPerMember, setMinTasksPerMember] = useState(1);
  const [maxTasksPerMember, setMaxTasksPerMember] = useState(10);
  const [memberPage, setMemberPage] = useState(0);
  const [memberEvaluations, setMemberEvaluations] = useState({});
  const [loadingEvaluations, setLoadingEvaluations] = useState(false);
  const [expandedEvalCards, setExpandedEvalCards] = useState({});
  const [evalMemberPage, setEvalMemberPage] = useState(0);
  const [memberInclusions, setMemberInclusions] = useState({});
  const [inclusionFeedback, setInclusionFeedback] = useState({});
  const [fileTypeError, setFileTypeError] = useState(null); // ‚úÖ File type error state
  const [showFileTypeErrorModal, setShowFileTypeErrorModal] = useState(false); // ‚úÖ File type error modal
  const [invalidFilesList, setInvalidFilesList] = useState([]); // ‚úÖ List of invalid files
  
  // Task Detail Modal State
  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);
  const [selectedTaskDetail, setSelectedTaskDetail] = useState(null);
  const [loadingTaskDetail, setLoadingTaskDetail] = useState(false);
  
  // Validation Modal State
  const [showValidationModal, setShowValidationModal] = useState(false);
  const [validationErrors, setValidationErrors] = useState([]);
  const [validationWarnings, setValidationWarnings] = useState([]);
  
  // Resubmission State
  const [isCreatingNewAttempt, setIsCreatingNewAttempt] = useState(false);

  // ‚úÖ Helper to generate accept attribute for file input
  const getFileAcceptAttribute = () => {
    let allowedTypes = [];
    if (phase.file_types_allowed) {
      try {
        allowedTypes = typeof phase.file_types_allowed === 'string' 
          ? JSON.parse(phase.file_types_allowed) 
          : phase.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }
    
    if (allowedTypes.length > 0) {
      return allowedTypes.map(type => {
        const ext = type.toLowerCase().replace('.', '');
        return `.${ext}`;
      }).join(',');
    }
    return ''; // No restrictions
  };

  // Toggle card expansion
  const toggleCardExpansion = (memberId) => {
    setExpandedCards(prev => ({
      ...prev,
      [memberId]: !prev[memberId]
    }));
  };

  // Toggle evaluation card expansion
  const toggleEvalCardExpansion = (memberId) => {
    setExpandedEvalCards(prev => ({
      ...prev,
      [memberId]: !prev[memberId]
    }));
  };

  // ‚úÖ NEW: Load submission data when component mounts
  useEffect(() => {
    if (phase.submissionDetails && phase.submissionDetails.length > 0) {
      const latestSubmission = phase.submissionDetails[phase.submissionDetails.length - 1];
      
      // Load member inclusions from submission
      if (latestSubmission.member_inclusions && Array.isArray(latestSubmission.member_inclusions)) {
        const inclusionsMap = {};
        const feedbackMap = {};
        
        latestSubmission.member_inclusions.forEach(inclusion => {
          inclusionsMap[inclusion.member_id] = inclusion.included !== false;
          if (inclusion.exclusion_reason) {
            feedbackMap[inclusion.member_id] = inclusion.exclusion_reason;
          }
        });
        
        setMemberInclusions(inclusionsMap);
        setInclusionFeedback(feedbackMap);
        console.log('üìã Loaded member inclusions from submission:', inclusionsMap);
        console.log('üìã Loaded exclusion feedback from submission:', feedbackMap);
      }

      // Load submission text
      if (latestSubmission.submission_text) {
        setSubmissionText(latestSubmission.submission_text);
      }
    }
  }, [phase.submissionDetails]);

  // Handle task click to show details and files
  const handleTaskClick = async (task) => {
    try {
      setLoadingTaskDetail(true);
      setShowTaskDetailModal(true);
      
      const token = localStorage.getItem('token');
      
      // Fetch task submission details - get approved submission or latest leader-acted submission
      const response = await fetch(
        `${apiConfig.baseURL}/api/tasks/${task.id}/submission-details`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const submissionData = await response.json();
        console.log('üìã Task submission details:', submissionData);
        
        setSelectedTaskDetail({
          ...task,
          submissionDetails: submissionData
        });
      } else {
        // If endpoint doesn't exist or fails, just show task info without submission details
        setSelectedTaskDetail({
          ...task,
          submissionDetails: null
        });
      }
    } catch (error) {
      console.error('Error fetching task details:', error);
      setSelectedTaskDetail({
        ...task,
        submissionDetails: null
      });
    } finally {
      setLoadingTaskDetail(false);
    }
  };

  // Handler for creating new attempt
  const handleCreateNewAttempt = () => {
    setIsCreatingNewAttempt(true);
    setFiles([]);
    setSubmissionText('');
    // Keep member inclusions from previous submission
    console.log('üìù Creating new attempt - form is now editable');
  };

  // Handler for canceling new attempt
  const handleCancelNewAttempt = () => {
    setIsCreatingNewAttempt(false);
    setFiles([]);
    setSubmissionText('');
    console.log('‚ùå Canceled new attempt - returning to read-only mode');
  };

  // Validate phase deliverable submission before allowing submit
  const validatePhaseDeliverable = () => {
    const errors = [];
    const warnings = [];

    // VALIDATION RULE 1: Check if at least one file is selected
    if (!files || files.length === 0) {
      errors.push({
        type: 'files',
        message: 'At least one file must be uploaded',
        icon: 'üìÅ'
      });
    }

    // VALIDATION RULE 2: Check if all members have minimum tasks assigned for THIS PHASE
    // NOTE: The backend already filters tasks by phase_id, so all tasks in memberTasks
    // are guaranteed to be for THIS phase. No need to filter by phase_number.
    if (groupData && groupData.members && memberTasks) {
      const membersWithInsufficientTasks = [];
      
      console.log('üîç VALIDATION DEBUG - Checking min tasks per member');
      console.log('üîç VALIDATION DEBUG - Phase:', phase.phase_number, phase.title);
      console.log('üîç VALIDATION DEBUG - Min required:', minTasksPerMember);
      
      groupData.members.forEach(member => {
        const memberId = member.student_id || member.id;
        const memberTaskList = memberTasks[memberId] || [];
        
        // Since backend query filters by phase_id, just count all tasks
        const taskCount = memberTaskList.length;
        
        console.log(`üìä Validation - Member: ${member.full_name}: ${taskCount}/${minTasksPerMember} tasks`);
        
        if (taskCount < minTasksPerMember) {
          membersWithInsufficientTasks.push({
            name: member.full_name || member.user_name || member.name || 'Unknown',
            assigned: taskCount,
            required: minTasksPerMember
          });
        }
      });

      if (membersWithInsufficientTasks.length > 0) {
        errors.push({
          type: 'min_tasks',
          message: `Some members have insufficient tasks assigned for Phase ${phase.phase_number}`,
          details: membersWithInsufficientTasks,
          icon: '‚ö†Ô∏è'
        });
      }
    }

    // WARNING 1: Check phase evaluation submission status
    if (groupData && groupData.members && memberEvaluations) {
      const membersWithoutEvaluation = [];
      
      groupData.members.forEach(member => {
        const memberId = member.student_id || member.id;
        const evaluation = memberEvaluations[memberId];
        
        if (!evaluation || !evaluation.submitted) {
          membersWithoutEvaluation.push({
            name: member.full_name || member.user_name || member.name || 'Unknown'
          });
        }
      });

      if (membersWithoutEvaluation.length > 0) {
        warnings.push({
          type: 'evaluations',
          message: `${membersWithoutEvaluation.length} member(s) have not submitted phase evaluations`,
          details: membersWithoutEvaluation,
          icon: 'üìù'
        });
      }
    }

    return { errors, warnings };
  };

  // Handle submit button click - show validation modal first
  const handleSubmitClick = () => {
    const { errors, warnings } = validatePhaseDeliverable();
    setValidationErrors(errors);
    setValidationWarnings(warnings);
    setShowValidationModal(true);
  };

  // Proceed with actual submission after validation
  const proceedWithSubmission = async () => {
    setShowValidationModal(false);
    
    try {
      setSubmitting(true);
      const token = localStorage.getItem('token');

      // Prepare FormData for multipart/form-data submission
      const formData = new FormData();
      formData.append('projectId', project.id);
      formData.append('phaseId', phase.id);
      formData.append('groupId', groupData.group_id || groupData.id); // Use group_id, fallback to id
      formData.append('submissionText', submissionText || '');
      
      // Add member inclusions
      const memberInclusionsArray = groupData.members.map(member => {
        const memberId = member.student_id || member.id;
        return {
          member_id: memberId,
          member_name: member.full_name || member.user_name || member.name || 'Unknown',
          role: groupData.members.indexOf(member) === 0 ? 'leader' : 'member',
          included: memberInclusions[memberId] !== false, // Default to true if not explicitly excluded
          exclusion_reason: memberInclusions[memberId] === false ? (inclusionFeedback[memberId] || '') : null
        };
      });
      formData.append('memberInclusions', JSON.stringify(memberInclusionsArray));
      
      // Add validation results (already computed)
      formData.append('validationResults', JSON.stringify({
        files_uploaded: files.length > 0,
        min_tasks_met: validationErrors.length === 0,
        members_below_minimum: validationErrors.filter(e => e.type === 'error' && e.message.includes('tasks')),
        evaluation_warnings: validationWarnings
      }));
      
      // ‚úÖ NEW: Add resubmission data
      if (isCreatingNewAttempt && latestSubmission) {
        formData.append('isResubmission', 'true');
        formData.append('originalSubmissionId', latestSubmission.id);
        formData.append('resubmissionNumber', (latestSubmission.resubmission_number || 0) + 1);
      } else {
        formData.append('isResubmission', 'false');
        formData.append('resubmissionNumber', '0');
      }
      
      // Add files
      files.forEach((file, index) => {
        formData.append('files', file);
      });

      console.log('üì¶ Submitting phase deliverable...');
      console.log('  Project:', project.id);
      console.log('  Phase:', phase.id);
      console.log('  Group ID:', groupData.group_id || groupData.id);
      console.log('  Group Data:', groupData);
      console.log('  Files:', files.length);
      console.log('  Member Inclusions:', memberInclusionsArray);

      const response = await fetch(`${apiConfig.baseURL}/api/student/phase-deliverable/submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || errorData.details || 'Failed to submit phase deliverable');
      }

      const result = await response.json();
      console.log('‚úÖ Phase deliverable submitted successfully:', result);

      // Clear form after successful submission
      setFiles([]);
      setSubmissionText('');
      setMemberInclusions({});
      setInclusionFeedback({});
      setIsCreatingNewAttempt(false); // ‚úÖ Reset resubmission state
      
      const attemptText = isCreatingNewAttempt ? `\n\nAttempt #${(latestSubmission?.resubmission_number || 0) + 1}` : '';
      alert(`Phase deliverable submitted successfully!${attemptText}\n\nSubmission ID: ${result.submission_id}\nSubmitted at: ${new Date(result.submitted_at).toLocaleString()}`);
      
      // Reload the page to fetch updated submission data
      window.location.reload();
    } catch (error) {
      console.error('‚ùå Error submitting phase deliverable:', error);
      alert(`Error submitting phase deliverable:\n${error.message}`);
    } finally {
      setSubmitting(false);
    }
  };

  // Fetch tasks for each member in this phase and project
  useEffect(() => {
    if (phase && project && groupData?.members) {
      fetchMemberTasks();
      fetchMemberEvaluations();
    }
  }, [phase.id, project.id, groupData?.members]);

  const fetchMemberTasks = async () => {
    try {
      setLoadingTasks(true);
      const token = localStorage.getItem('token');
      
      // Fetch tasks organized by member for this project and phase
      const response = await fetch(
        `${API_BASE_URL}/api/student/phase-member-tasks?projectId=${project.id}&phaseId=${phase.id}`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const data = await response.json();
        console.log('üìã Member tasks fetched:', data);
        
        // Set min and max tasks per member from response
        setMinTasksPerMember(data.minTasksPerMember || 1);
        setMaxTasksPerMember(data.maxTasksPerMember || 10);
        
        // Organize tasks by member ID
        const tasksByMember = {};
        groupData.members.forEach(member => {
          tasksByMember[member.student_id || member.id] = [];
        });

        // Populate tasks from the response (already filtered by phase_id in backend)
        (data.data || []).forEach(memberData => {
          tasksByMember[memberData.member_id] = memberData.tasks || [];
          console.log(`üë§ Member ${memberData.member_id}: ${memberData.tasks?.length || 0} tasks for phase ${data.phaseNumber}`);
        });

        console.log('üìä Tasks by member populated for phase', data.phaseNumber);
        setMemberTasks(tasksByMember);
      } else {
        console.error('‚ùå Failed to fetch member tasks:', response.status);
      }
    } catch (error) {
      console.error('Error fetching member tasks:', error);
    } finally {
      setLoadingTasks(false);
    }
  };

  const fetchMemberEvaluations = async () => {
    try {
      setLoadingEvaluations(true);
      const token = localStorage.getItem('token');
      
      // Fetch phase evaluation submission status for all group members
      const response = await fetch(
        `${apiConfig.baseURL}/api/student/phases/${phase.id}/group-evaluation-status`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const data = await response.json();
        console.log('üìã Phase evaluation status fetched:', data);
        
        // Organize submission status by member ID
        // Convert the API response into the format expected by the UI
        const evalsByMember = {};
        
        (data.members || []).forEach(memberData => {
          console.log(`üîç Processing member ${memberData.student_name} (${memberData.student_id}):`, {
            has_submitted: memberData.has_submitted,
            total_submissions: memberData.total_submissions,
            submitted_count: memberData.submitted_count,
            submissions: memberData.submissions
          });

          // Create evaluation entries based on submission status
          const evaluations = [];
          
          if (memberData.has_submitted) {
            memberData.submissions.forEach(sub => {
              console.log(`   üìù Checking submission ${sub.id}:`, {
                status: sub.status,
                is_custom: sub.is_custom,
                has_file: sub.has_file,
                has_data: sub.has_data,
                will_include: sub.status !== 'not_started'
              });

              if (sub.status !== 'not_started') {
                evaluations.push({
                  id: sub.id,
                  status: sub.status,
                  submission_date: sub.submission_date,
                  is_custom: sub.is_custom,
                  has_file: sub.has_file,
                  has_data: sub.has_data,
                  phase_number: sub.phase_number || 0,
                  phase_title: sub.phase_title || 'Unknown Phase',
                  evaluator_name: sub.evaluation_label || 'Phase Evaluation'
                });
              }
            });
          }
          
          console.log(`   ‚úÖ Final evaluations for ${memberData.student_name}: ${evaluations.length}`, evaluations);
          evalsByMember[memberData.student_id] = evaluations;
        });

        console.log('üìã Organized evaluations by member:', evalsByMember);
        setMemberEvaluations(evalsByMember);
      } else {
        console.error('Failed to fetch phase evaluation status:', response.status);
        // Initialize empty evaluations for all members
        const evalsByMember = {};
        groupData.members.forEach(member => {
          evalsByMember[member.student_id || member.id] = [];
        });
        setMemberEvaluations(evalsByMember);
      }
    } catch (error) {
      console.error('Error fetching phase evaluation status:', error);
      // Initialize empty evaluations for all members on error
      const evalsByMember = {};
      groupData.members.forEach(member => {
        evalsByMember[member.student_id || member.id] = [];
      });
      setMemberEvaluations(evalsByMember);
    } finally {
      setLoadingEvaluations(false);
    }
  };

  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files || []);
    if (selectedFiles.length === 0) return;

    // ‚úÖ FILE TYPE VALIDATION
    setFileTypeError(null); // Clear previous errors
    let allowedTypes = [];
    if (phase.file_types_allowed) {
      try {
        allowedTypes = typeof phase.file_types_allowed === 'string' 
          ? JSON.parse(phase.file_types_allowed) 
          : phase.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }

    // Validate file types if restrictions exist
    if (allowedTypes.length > 0) {
      const invalidFiles = [];
      selectedFiles.forEach(file => {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const isValid = allowedTypes.some(type => {
          const allowedExt = type.toLowerCase().replace('.', '');
          return fileExt === allowedExt;
        });
        if (!isValid) {
          invalidFiles.push(file.name);
        }
      });

      if (invalidFiles.length > 0) {
        const errorMsg = `Allowed file types: ${allowedTypes.join(', ')}`;
        setFileTypeError(errorMsg);
        setInvalidFilesList(invalidFiles);
        setShowFileTypeErrorModal(true);
        e.target.value = ''; // Clear the input
        return;
      }
    }

    // Append new files to existing files, avoiding exact duplicates by name+size+lastModified
    setFiles((prevFiles) => {
      const existing = Array.isArray(prevFiles) ? prevFiles : [];
      const merged = [...existing];
      selectedFiles.forEach((sf) => {
        const isDuplicate = existing.some(
          (f) => f.name === sf.name && f.size === sf.size && f.lastModified === sf.lastModified
        );
        if (!isDuplicate) merged.push(sf);
      });
      return merged;
    });

    // Clear the input so selecting the same file again will trigger change
    e.target.value = '';
  };

  const handleSubmit = async () => {
    if (files.length === 0) {
      alert('Please select at least one file to submit');
      return;
    }

    // ‚úÖ RE-VALIDATE FILE TYPES BEFORE SUBMISSION
    let allowedTypes = [];
    if (phase.file_types_allowed) {
      try {
        allowedTypes = typeof phase.file_types_allowed === 'string' 
          ? JSON.parse(phase.file_types_allowed) 
          : phase.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }

    if (allowedTypes.length > 0) {
      const invalidFiles = [];
      files.forEach(file => {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const isValid = allowedTypes.some(type => {
          const allowedExt = type.toLowerCase().replace('.', '');
          return fileExt === allowedExt;
        });
        if (!isValid) {
          invalidFiles.push(file.name);
        }
      });

      if (invalidFiles.length > 0) {
        const errorMsg = `Allowed file types: ${allowedTypes.join(', ')}`;
        setFileTypeError(errorMsg);
        setInvalidFilesList(invalidFiles);
        setShowFileTypeErrorModal(true);
        return;
      }
    }

    setSubmitting(true);
    await onSubmit(phase.id, files, submissionText);
    setSubmitting(false);
    setFiles([]);
    setSubmissionText('');
  };

  const submissionDetails = phase.submissionDetails;
  const hasSubmission = (submissionDetails && submissionDetails.length > 0) && !isCreatingNewAttempt;
  const latestSubmission = submissionDetails && submissionDetails.length > 0 ? submissionDetails[submissionDetails.length - 1] : null;
  
  // ‚úÖ FIX: Count distinct attempts based on highest resubmission_number
  const maxAttempts = phase.max_attempts || 1;
  let currentAttempts = 0;
  if (submissionDetails && submissionDetails.length > 0) {
    const maxResubmissionNumber = Math.max(...submissionDetails.map(s => s.resubmission_number || 0));
    currentAttempts = maxResubmissionNumber + 1;
  }
  const canCreateNewAttempt = currentAttempts < maxAttempts;

  // Determine submission status
  const getSubmissionStatus = () => {
    if (!hasSubmission) {
      // Check if phase deadline has passed
      const now = new Date();
      const phaseEndDate = new Date(phase.end_date);
      
      if (now > phaseEndDate) {
        return { status: 'MISSED', color: '#DC2626', bgColor: '#FEE2E2' };
      }
      
      return { status: 'NOT SUBMITTED', color: '#F59E0B', bgColor: '#FEF3C7' };
    }
    
    const statusLower = latestSubmission.status?.toLowerCase() || '';
    
    if (statusLower.includes('late')) {
      return { status: 'Late', color: '#EA580C', bgColor: '#FFEDD5' };
    }
    
    return { status: 'SUBMITTED', color: '#059669', bgColor: '#D1FAE5' };
  };

  const submissionStatus = getSubmissionStatus();

  return (
    <div className="deliverable-details-container">
      {/* Header with Phase Title and Status Pill */}
      <div className="deliverable-details-header">
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '16px' }}>
          <h2><strong>Phase {phase.phase_number}:</strong> {phase.title}</h2>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            padding: '8px 16px',
            backgroundColor: submissionStatus.bgColor,
            border: `1px solid ${submissionStatus.color}`,
            borderRadius: '20px',
            whiteSpace: 'nowrap',
            flexShrink: 0
          }}>
            <span style={{
              width: '8px',
              height: '8px',
              borderRadius: '50%',
              backgroundColor: submissionStatus.color
            }}></span>
            <span style={{
              fontSize: '14px',
              fontWeight: '600',
              color: submissionStatus.color
            }}>
              {submissionStatus.status}
            </span>
          </div>
        </div>
      </div>

      {/* Content Area - Left (Upload Box) and Right (Description + Pills) */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: '0.9fr 1.3fr',
        gap: '10px',
        padding: '0 24px',
        marginBottom: '24px'
      }}>
        {/* Left Side - Unified Upload Box */}
        <div>
          <div className="phase-upload-box" style={{
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            minHeight: (files.length > 0 || hasSubmission) ? '200px' : 'auto'
          }}>
            {!hasSubmission && (
              <input
                type="file"
                multiple
                accept={getFileAcceptAttribute()}
                onChange={handleFileChange}
                id="phase-file-input"
                style={{ display: 'none' }}
              />
            )}
            
            {/* ‚úÖ SUBMITTED FILES - Display only when submission exists */}
            {hasSubmission && latestSubmission.files && latestSubmission.files.length > 0 && (
              <>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  maxHeight: '250px',
                  overflowY: 'auto',
                  marginBottom: '12px'
                }}>
                  {latestSubmission.files.map((file, idx) => (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '12px 15px',
                      backgroundColor: '#F0FDF4',
                      border: '1px solid #86EFAC',
                      borderRadius: '8px',
                      height: '46px'
                    }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        flex: 1,
                        minWidth: 0
                      }}>
                        <FaCheckCircle style={{ color: '#059669', fontSize: '18px', flexShrink: 0 }} />
                        <span style={{
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap',
                          fontSize: '14px',
                          color: '#064E3B',
                          fontWeight: '500'
                        }}>
                          {file.name}
                        </span>
                      </div>
                      <a
                        href={file.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          padding: '6px 12px',
                          backgroundColor: '#059669',
                          color: 'white',
                          borderRadius: '6px',
                          fontSize: '12px',
                          textDecoration: 'none',
                          fontWeight: '500',
                          flexShrink: 0,
                          marginLeft: '12px'
                        }}
                      >
                        Download
                      </a>
                    </div>
                  ))}
                </div>
                
                {/* ‚úÖ NEW: Create New Attempt Button or Max Attempts Message */}
                {canCreateNewAttempt ? (
                  <button
                    onClick={handleCreateNewAttempt}
                    style={{
                      padding: '12px 20px',
                      backgroundColor: '#3B82F6',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '8px',
                      width: '100%'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#2563EB'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#3B82F6'}
                  >
                    <FaPlus style={{ fontSize: '12px' }} />
                    Create New Attempt (Resubmit)
                  </button>
                ) : (
                  <div style={{
                    padding: '12px 20px',
                    backgroundColor: '#FEF3C7',
                    border: '1px solid #F59E0B',
                    borderRadius: '8px',
                    fontSize: '13px',
                    fontWeight: '500',
                    color: '#92400E',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    width: '100%'
                  }}>
                    <FaExclamationTriangle style={{ fontSize: '14px', color: '#F59E0B' }} />
                    Maximum attempts reached ({currentAttempts}/{maxAttempts})
                  </div>
                )}
              </>
            )}
            
            {/* Upload Label - Hidden when files are selected OR when submission exists */}
            {!hasSubmission && files.length === 0 && (
              <label htmlFor="phase-file-input" style={{ cursor: 'pointer', flexShrink: 0, textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                <div style={{ 
                  fontSize: '36px',
                  marginBottom: '8px',
                  color: '#34656D'
                }}>
                  <FaCloudUploadAlt />
                </div>
                <div style={{ 
                  fontWeight: '600', 
                  color: '#333', 
                  marginBottom: '4px', 
                  fontSize: '16px' 
                }}>
                  Click to upload files
                </div>
                <div style={{ 
                  color: '#6B7280', 
                  fontSize: '13px',
                  marginBottom: '12px'
                }}>
                  You can drag files here or click to choose
                </div>
              </label>
            )}

            {/* File List - Shows 2 files normally, scrollable if more - ONLY when no submission */}
            {!hasSubmission && files.length > 0 && (
              <>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  maxHeight: '120px',
                  overflowY: 'auto',
                  marginBottom: '12px',
                  flex: 1,
                  minHeight: '60px'
                }}>
                  {files.map((file, idx) => (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '12px 15px',
                      backgroundColor: '#fafafa',
                      border: '1px solid #e6e6e6',
                      borderRadius: '20px',
                      transition: 'all 0.15s ease',
                      height: '46px'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f5f5f5';
                      e.currentTarget.style.borderColor = '#dcdcdc';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#fafafa';
                      e.currentTarget.style.borderColor = '#e6e6e6';
                    }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        flex: 1,
                        minWidth: 0
                      }}>
                        <span style={{ fontSize: '12px', flexShrink: 0, color: '#4b5563' }}>‚Ä¢</span>
                        <div style={{ minWidth: 0, flex: 1 }}>
                          <div style={{
                            fontSize: '12px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            {file.name}
                          </div>
                          <div style={{
                            fontSize: '10px',
                            color: '#999',
                            marginTop: '1px'
                          }}>
                            {(file.size / 1024).toFixed(2)} KB
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          setFiles((prev) => prev.filter((_, i) => i !== idx));
                        }}
                        aria-label={`Remove ${file.name}`}
                        style={{
                          padding: '2px 6px',
                          backgroundColor: 'transparent',
                          color: '#999',
                          border: 'none',
                          borderRadius: '4px',
                          fontSize: '18px',
                          cursor: 'pointer',
                          flexShrink: 0,
                          lineHeight: '1',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                </div>

                {/* File Summary */}
                <div style={{
                  paddingTop: '8px',
                  borderTop: '1px solid #E5E7EB',
                  marginBottom: '12px',
                  fontSize: '11px',
                  color: '#999',
                  fontWeight: '500'
                }}>
                  {files.length} file(s) ‚Ä¢ {(files.reduce((sum, f) => sum + f.size, 0) / 1024).toFixed(2)} KB
                </div>

                {/* Buttons - Only appear after files are selected */}
                <div style={{ 
                  display: 'flex', 
                  gap: '12px',
                  flexDirection: 'row',
                  marginTop: 'auto',
                  width: '100%'
                }}>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      const input = document.getElementById('phase-file-input');
                      if (input) input.click();
                    }}
                    style={{
                      padding: '12px 16px',
                      backgroundColor: '#f0f0f0',
                      border: '1px solid #d0d0d0',
                      borderRadius: '20px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: '500',
                      flex: 1,
                      minWidth: '0'
                    }}
                  >
                    Add more files
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      setFiles([]);
                    }}
                    style={{
                      padding: '12px 16px',
                      backgroundColor: '#fff',
                      border: '1px solid #e0e0e0',
                      borderRadius: '20px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: '500',
                      flex: 1,
                      minWidth: '0'
                    }}
                  >
                    Clear
                  </button>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Right Side - Description Only */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', fontSize: '14.08px' }}>
          {/* Description */}
          <div>
            <div style={{ fontWeight: '600', color: '#6B7280', marginBottom: '8px', fontSize: '14.08px' }}>
              Description
            </div>
            <div style={{
              backgroundColor: '#F0F9FF',
              border: '1px solid #BFDBFE',
              borderRadius: '12px',
              padding: '16px',
              boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
              minHeight: '120px',
              display: 'flex',
              alignItems: 'flex-start',
              fontSize: '14.08px'
            }}>
              <p className="deliverable-description" style={{ margin: 0 }}>
                {phase.description}
              </p>
            </div>
            {/* View Rubric and Evaluation Form Buttons */}
            <div style={{
              display: 'flex',
              gap: '12px',
              marginTop: '12px'
            }}>
              {/* View Rubric Button */}
              <button
                onClick={() => {
                  console.log('View rubric clicked for phase:', phase.id);
                  setCurrentRubricPhase(phase);
                  fetchPhaseRubric(phase.id, setPhaseRubricData, setRubricLoading);
                  setShowPhaseRubricModal(true);
                }}
                style={{
                  flex: 1,
                  padding: '10px 16px',
                  backgroundColor: '#34656D',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14.08px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#2c545b';
                  e.target.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.3)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#34656D';
                  e.target.style.boxShadow = 'none';
                }}
              >
                View Rubric
              </button>
              {/* View Evaluation Form Button */}
              <button
                onClick={() => {
                  console.log('View evaluation form clicked for phase:', phase.id);
                  setCurrentEvalFormPhase(phase);
                  fetchPhaseEvaluationForm(phase.id, setPhaseEvalFormData, setEvalFormLoading);
                  setShowPhaseEvalFormModal(true);
                }}
                style={{
                  flex: 1,
                  padding: '10px 16px',
                  backgroundColor: '#34656D',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14.08px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#2c545b';
                  e.target.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.3)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#34656D';
                  e.target.style.boxShadow = 'none';
                }}
              >
                View Evaluation Form
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Phase Details Pills Section */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
        gap: '16px',
        padding: '0 24px',
        marginBottom: '24px'
      }}>
        {/* Status Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '16px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.875rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Status
          </label>
          <div style={{
            color: phase.is_active ? '#059669' : '#DC2626',
            fontWeight: '600',
            padding: '8px 14px',
            backgroundColor: phase.is_active ? '#D1FAE5' : '#FEE2E2',
            borderRadius: '6px',
            fontSize: '1rem',
            textAlign: 'center'
          }}>
            {phase.is_active ? 'Active' : 'Inactive'}
          </div>
        </div>

        {/* Dates Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '16px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.875rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Duration
          </label>
          <div style={{
            backgroundColor: '#F9FAFB',
            padding: '8px 12px',
            borderRadius: '4px',
            color: '#495057',
            fontWeight: '500',
            fontSize: '1rem',
            textAlign: 'center'
          }}>
            {new Date(phase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date(phase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
          </div>
        </div>

        {/* Max Attempts Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '16px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.875rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Attempts Allowed
          </label>
          <div style={{
            backgroundColor: '#F9FAFB',
            padding: '8px 12px',
            borderRadius: '4px',
            color: '#495057',
            fontWeight: '600',
            fontSize: '1rem',
            textAlign: 'center'
          }}>
            {phase.max_attempts || 'Unlimited'}
          </div>
        </div>

        {/* File Types Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '16px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.875rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            File Types
          </label>
          <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap', justifyContent: 'center' }}>
            {(() => {
              try {
                let fileTypes = phase.file_types_allowed;
                if (typeof fileTypes === 'string') {
                  fileTypes = JSON.parse(fileTypes);
                }
                
                if (Array.isArray(fileTypes) && fileTypes.length > 0) {
                  return fileTypes.map((fileType, idx) => (
                    <span key={idx} style={{
                      backgroundColor: '#DBEAFE',
                      color: '#1E40AF',
                      padding: '4px 10px',
                      borderRadius: '4px',
                      fontSize: '0.875rem',
                      fontWeight: '600'
                    }}>
                      {fileType.toUpperCase()}
                    </span>
                  ));
                } else {
                  return <span style={{ color: '#9CA3AF', fontSize: '0.875rem', fontStyle: 'italic' }}>
                    Any file types
                  </span>;
                }
              } catch (e) {
                console.error('Error parsing file types:', e);
                return <span style={{ color: '#9CA3AF', fontSize: '0.875rem', fontStyle: 'italic' }}>
                  Any file types
                </span>;
              }
            })()}
          </div>
        </div>

        {/* Evaluation Type Container */}
        {phase.evaluation_form_type && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '16px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.875rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Evaluation Form
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '8px 12px',
              borderRadius: '4px',
              color: '#495057',
              fontWeight: '500',
              fontSize: '1rem',
              textAlign: 'center'
            }}>
              {phase.evaluation_form_type}
            </div>
          </div>
        )}

        {/* Min Tasks Per Member Container */}
        {project && project.min_tasks_per_member && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '16px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.875rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Min Tasks Per Member
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '8px 12px',
              borderRadius: '4px',
              color: '#495057',
              fontWeight: '600',
              fontSize: '1rem',
              textAlign: 'center'
            }}>
              {project.min_tasks_per_member}
            </div>
          </div>
        )}

        {/* Max Tasks Per Member Container */}
        {project && project.max_tasks_per_member && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '16px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.875rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Max Tasks Per Member
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '8px 12px',
              borderRadius: '4px',
              color: '#495057',
              fontWeight: '600',
              fontSize: '1rem',
              textAlign: 'center'
            }}>
              {project.max_tasks_per_member}
            </div>
          </div>
        )}
      </div>

      {/* Member Submissions Section */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#ffffff', marginBottom: '24px' }}>
          Member Submissions
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <>
            <div style={{
              display: 'flex',
              gap: '24px',
              alignItems: 'flex-start',
              justifyContent: 'space-between'
            }}>
              {/* Cards Container */}
              <div style={{
                display: 'flex',
                gap: '24px',
                flexWrap: 'wrap',
                flex: 1,
                maxWidth: 'calc(100% - 50px)'
              }}>
                {groupData.members
                  .slice(memberPage * 3, (memberPage * 3) + 3)
                  .map((member, index) => {
                    const isLeader = groupData.members.indexOf(member) === 0;
                    const memberName = member.full_name || member.user_name || member.name || 'Unknown';
                    const memberInitial = memberName.charAt(0).toUpperCase();
                    const memberId = member.student_id || member.id;
                    const isExpanded = expandedCards[memberId];
                    const memberTaskList = memberTasks[memberId] || [];
                    const visibleTasksCount = 1;
                    const hasMoreTasks = memberTaskList.length > visibleTasksCount;
              
              return (
                <div
                  key={memberId}
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '14px',
                    padding: '24px',
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '12px',
                    width: '280px',
                    minWidth: '280px',
                    maxWidth: '280px',
                    textAlign: 'center',
                    boxShadow: isLeader ? '0 4px 12px rgba(52, 101, 109, 0.15)' : '0 1px 3px rgba(0, 0, 0, 0.1)',
                    transition: 'box-shadow 0.3s ease',
                    maxHeight: isExpanded ? '600px' : 'auto',
                    overflow: 'hidden',
                    position: 'relative'
                  }}
                >
                  {/* Tasks Counter Pill - Top Right */}
                  {!loadingTasks && (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '8px 14px',
                      backgroundColor: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '#D1FAE5' // Green when at or above max
                          : memberTaskList.length >= minTasksPerMember 
                          ? '#FEF3C7' // Orange when between min and max
                          : '#FEE2E2', // Red when below minimum
                      border: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '1px solid #6EE7B7' // Green border
                          : memberTaskList.length >= minTasksPerMember 
                          ? '1px solid #FCD34D' // Orange border
                          : '1px solid #FECACA', // Red border
                      borderRadius: '20px',
                      fontSize: '12px',
                      fontWeight: '700',
                      color: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '#047857' // Green text
                          : memberTaskList.length >= minTasksPerMember 
                          ? '#B45309' // Orange text
                          : '#DC2626' // Red text
                    }}>
                      <FaTasks size={13} />
                      <span>{memberTaskList.length}/{maxTasksPerMember}</span>
                    </div>
                  )}
                  {/* Profile Picture */}
                  <div style={{
                    width: '100px',
                    height: '100px',
                    borderRadius: '8px',
                    backgroundColor: '#34656D',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '40px',
                    fontWeight: '600',
                    overflow: 'hidden',
                    position: 'relative'
                  }}>
                    {member.profile_image_url && member.profile_image_url.trim() ? (
                      <img
                        src={member.profile_image_url.startsWith('http') 
                          ? member.profile_image_url 
                          : `${API_BASE_URL}${member.profile_image_url}`}
                        alt={memberName}
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                        onError={(e) => {
                          e.target.style.display = 'none';
                        }}
                      />
                    ) : null}
                    {!member.profile_image_url || !member.profile_image_url.trim() ? (
                      <span>{memberInitial}</span>
                    ) : null}
                  </div>

                  {/* Position */}
                  <div style={{
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#6b7280',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>
                    {isLeader ? 'Leader' : 'Member'}
                  </div>

                  {/* Name */}
                  <div style={{
                    fontSize: '15px',
                    fontWeight: '700',
                    color: '#2c3e50',
                    maxWidth: '220px',
                    lineHeight: '1.2',
                    whiteSpace: 'nowrap',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis'
                  }}>
                    {memberName}
                  </div>

                  {/* Tasks List */}
                  <div style={{
                    width: '100%',
                    borderTop: '1px solid #e5e7eb',
                    paddingTop: '12px',
                    marginTop: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      fontWeight: '700',
                      color: '#2c3e50',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      marginBottom: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px'
                    }}>
                      <FaTasks size={12} />
                      Assigned Tasks ({memberTaskList.length})
                    </div>
                    {loadingTasks ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        Loading...
                      </div>
                    ) : (
                      <>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '8px',
                          maxHeight: isExpanded ? '300px' : '120px',
                          overflowY: isExpanded ? 'auto' : 'hidden',
                          paddingRight: isExpanded ? '6px' : '0'
                        }}>
                          {memberTaskList.length > 0 ? (
                            (isExpanded ? memberTaskList : memberTaskList.slice(0, visibleTasksCount)).map((task, taskIdx) => (
                              <div
                                key={taskIdx}
                                onClick={() => handleTaskClick(task)}
                                style={{
                                  backgroundColor: '#F0FAFB',
                                  border: '1px solid #BFDBFE',
                                  borderRadius: '8px',
                                  padding: '10px 12px',
                                  fontSize: '12px',
                                  color: '#2c3e50',
                                  textAlign: 'left',
                                  lineHeight: '1.4',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s ease',
                                  hover: { backgroundColor: '#E0F2FE' },
                                  position: 'relative',
                                  paddingRight: '90px'
                                }}
                                title={task.description || task.title}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#E0F2FE';
                                  e.currentTarget.style.transform = 'translateY(-2px)';
                                  e.currentTarget.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#F0FAFB';
                                  e.currentTarget.style.transform = 'translateY(0)';
                                  e.currentTarget.style.boxShadow = 'none';
                                }}
                              >
                                {/* Task Status - Top Right */}
                                {task.status && (
                                  <div style={{
                                    position: 'absolute',
                                    top: '6px',
                                    right: '8px',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    color: task.status === 'completed' ? '#059669' : task.status === 'pending' ? '#DC2626' : task.status === 'to_revise' ? '#EA580C' : '#6B7280',
                                    backgroundColor: task.status === 'completed' ? '#D1FAE5' : task.status === 'pending' ? '#FEE2E2' : task.status === 'to_revise' ? '#FFEDD5' : '#F3F4F6',
                                    padding: '3px 6px',
                                    borderRadius: '4px',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '3px',
                                    whiteSpace: 'nowrap'
                                  }}>
                                    {task.status === 'completed' ? (
                                      <><FaCheck size={9} />Completed</>
                                    ) : task.status === 'pending' ? (
                                      <><FaClock size={9} />Pending</>
                                    ) : task.status === 'to_revise' ? (
                                      <><FaExclamationTriangle size={9} />Revision</>
                                    ) : (
                                      <><FaFileAlt size={9} />{task.status.replace(/_/g, ' ')}</>
                                    )}
                                  </div>
                                )}

                                <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '13px', paddingRight: '0' }}>
                                  {task.title?.length > 25 ? task.title.substring(0, 25) + '...' : task.title}
                                </div>
                                {task.due_date && (
                                  <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '3px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <FaCalendarAlt size={10} />
                                    {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                  </div>
                                )}
                              </div>
                            ))
                          ) : (
                            <div style={{
                              fontSize: '12px',
                              color: '#9CA3AF',
                              fontStyle: 'italic',
                              padding: '12px 8px'
                            }}>
                              No tasks assigned
                            </div>
                          )}
                        </div>
                        
                        {/* View More Button */}
                        {hasMoreTasks && (
                          <button
                            onClick={() => toggleCardExpansion(memberId)}
                            style={{
                              width: '100%',
                              marginTop: '10px',
                              padding: '8px 12px',
                              backgroundColor: isExpanded ? '#E5E7EB' : '#34656D',
                              color: isExpanded ? '#2c3e50' : 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#D1D5DB' : '#2c545b';
                              e.target.style.transform = 'translateY(-1px)';
                            }}
                            onMouseLeave={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#E5E7EB' : '#34656D';
                              e.target.style.transform = 'translateY(0)';
                            }}
                          >
                            {isExpanded 
                              ? `‚ñ≤ Show Less (${memberTaskList.length})` 
                              : `‚ñº View More (+${memberTaskList.length - visibleTasksCount})`
                            }
                          </button>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
                  })
                }
              </div>

              {/* Pagination Arrow */}
              {groupData.members.length > 3 && (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px',
                  justifyContent: 'center'
                }}>
                  {/* Previous Button */}
                  <button
                    onClick={() => setMemberPage(prev => Math.max(0, prev - 1))}
                    disabled={memberPage === 0}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: memberPage === 0 ? '#F3F4F6' : 'white',
                      color: memberPage === 0 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: memberPage === 0 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (memberPage > 0) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = memberPage === 0 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &lt;
                  </button>

                  {/* Page Indicator */}
                  <div style={{
                    textAlign: 'center',
                    fontSize: '11px',
                    fontWeight: '600',
                    color: '#6B7280',
                    minWidth: '44px'
                  }}>
                    {memberPage + 1}/{Math.ceil(groupData.members.length / 3)}
                  </div>

                  {/* Next Button */}
                  <button
                    onClick={() => setMemberPage(prev => prev + 1)}
                    disabled={memberPage >= Math.ceil(groupData.members.length / 3) - 1}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white',
                      color: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (memberPage < Math.ceil(groupData.members.length / 3) - 1) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &gt;
                  </button>
                </div>
              )}
            </div>
          </>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '24px',
            backgroundColor: '#F9FAFB',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            textAlign: 'center'
          }}>
            {groupData ? 'No group members available' : 'Loading group data...'}
          </div>
        )}
      </div>

      {/* Evaluation Submissions Section */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#FFFFFF', marginBottom: '24px' }}>
          Evaluation Submissions
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <>
            <div style={{
              display: 'flex',
              gap: '24px',
              alignItems: 'flex-start',
              justifyContent: 'space-between'
            }}>
              {/* Cards Container */}
              <div style={{
                display: 'flex',
                gap: '24px',
                flexWrap: 'wrap',
                flex: 1,
                maxWidth: 'calc(100% - 50px)'
              }}>
                {groupData.members
                  .slice(evalMemberPage * 3, (evalMemberPage * 3) + 3)
                  .map((member, index) => {
                    const isLeader = groupData.members.indexOf(member) === 0;
                    const memberName = member.full_name || member.user_name || member.name || 'Unknown';
                    const memberInitial = memberName.charAt(0).toUpperCase();
                    const memberId = member.student_id || member.id;
                    const isExpanded = expandedEvalCards[memberId];
                    const memberEvalList = memberEvaluations[memberId] || [];
                    const visibleEvalsCount = 1;
                    const hasMoreEvals = memberEvalList.length > visibleEvalsCount;
              
              return (
                <div
                  key={`eval-${memberId}`}
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '14px',
                    padding: '24px',
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '12px',
                    width: '280px',
                    minWidth: '280px',
                    maxWidth: '280px',
                    textAlign: 'center',
                    boxShadow: isLeader ? '0 4px 12px rgba(52, 101, 109, 0.15)' : '0 1px 3px rgba(0, 0, 0, 0.1)',
                    transition: 'box-shadow 0.3s ease',
                    maxHeight: isExpanded ? '600px' : 'auto',
                    overflow: 'hidden',
                    position: 'relative'
                  }}
                >
                  {/* Evaluation Status Pill - Top Right */}
                  {loadingEvaluations ? (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px',
                      padding: '8px 12px',
                      backgroundColor: '#F3F4F6',
                      border: '1px solid #D1D5DB',
                      borderRadius: '20px',
                      animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }}>
                      <div style={{
                        width: '16px',
                        height: '16px',
                        backgroundColor: '#D1D5DB',
                        borderRadius: '50%'
                      }} />
                    </div>
                  ) : (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px',
                      padding: '8px 12px',
                      backgroundColor: memberEvalList.length > 0 ? '#D1FADF' : '#FEE2E2',
                      border: memberEvalList.length > 0 ? '1px solid #6EE7B7' : '1px solid #FECACA',
                      borderRadius: '20px',
                      fontSize: '12px',
                      fontWeight: '700',
                      color: memberEvalList.length > 0 ? '#047857' : '#DC2626'
                    }}>
                      {memberEvalList.length > 0 ? (
                        <FaCheck size={16} />
                      ) : (
                        <FaTimes size={16} />
                      )}
                    </div>
                  )}
                  
                  {/* Profile Picture */}
                  <div style={{
                    width: '100px',
                    height: '100px',
                    borderRadius: '8px',
                    backgroundColor: '#34656D',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '40px',
                    fontWeight: '600',
                    overflow: 'hidden',
                    position: 'relative'
                  }}>
                    {member.profile_image_url && member.profile_image_url.trim() ? (
                      <img
                        src={member.profile_image_url.startsWith('http') 
                          ? member.profile_image_url 
                          : `${API_BASE_URL}${member.profile_image_url}`}
                        alt={memberName}
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                        onError={(e) => {
                          e.target.style.display = 'none';
                        }}
                      />
                    ) : null}
                    {!member.profile_image_url || !member.profile_image_url.trim() ? (
                      <span>{memberInitial}</span>
                    ) : null}
                  </div>

                  {/* Position */}
                  <div style={{
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#6b7280',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>
                    {isLeader ? 'Leader' : 'Member'}
                  </div>

                  {/* Name */}
                  <div style={{
                    fontSize: '15px',
                    fontWeight: '700',
                    color: '#2c3e50',
                    maxWidth: '220px',
                    lineHeight: '1.2',
                    whiteSpace: 'nowrap',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis'
                  }}>
                    {memberName}
                  </div>

                  {/* Evaluations List */}
                  <div style={{
                    width: '100%',
                    borderTop: '1px solid #e5e7eb',
                    paddingTop: '12px',
                    marginTop: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      fontWeight: '700',
                      color: '#2c3e50',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      marginBottom: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px'
                    }}>
                      <FaTasks size={12} />
                      Received Evaluations ({memberEvalList.length})
                    </div>
                    {loadingEvaluations ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        Loading...
                      </div>
                    ) : memberEvalList.length === 0 ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        No evaluations received
                      </div>
                    ) : (
                      <>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '8px'
                        }}>
                          {memberEvalList.slice(0, isExpanded ? memberEvalList.length : visibleEvalsCount).map((evaluation, idx) => (
                            <div
                              key={`eval-${idx}`}
                              style={{
                                backgroundColor: '#F0FAFB',
                                border: '1px solid #BFDBFE',
                                borderRadius: '8px',
                                padding: '10px 12px',
                                fontSize: '11px',
                                color: '#4B5563',
                                lineHeight: '1.4',
                                position: 'relative',
                                paddingRight: '90px'
                              }}
                            >
                              <div style={{ 
                                fontWeight: '600', 
                                marginBottom: '4px', 
                                color: '#2c3e50',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                maxWidth: '100%'
                              }}>
                                {evaluation.evaluator_name || 'Anonymous'}
                              </div>
                              <div style={{ fontSize: '10px', color: '#6B7280', marginBottom: '4px' }}>
                                {evaluation.score && <span>Score: {evaluation.score}/10</span>}
                              </div>
                              {evaluation.feedback && (
                                <div style={{ fontSize: '10px', marginTop: '4px', fontStyle: 'italic' }}>
                                  {evaluation.feedback.substring(0, 50)}...
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                        {hasMoreEvals && (
                          <button
                            onClick={() => toggleEvalCardExpansion(memberId)}
                            style={{
                              width: '100%',
                              marginTop: '10px',
                              padding: '8px 12px',
                              backgroundColor: isExpanded ? '#E5E7EB' : '#34656D',
                              color: isExpanded ? '#2c3e50' : 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#D1D5DB' : '#2c545b';
                              e.target.style.transform = 'translateY(-1px)';
                            }}
                            onMouseLeave={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#E5E7EB' : '#34656D';
                              e.target.style.transform = 'translateY(0)';
                            }}
                          >
                            {isExpanded 
                              ? `‚ñ≤ Show Less (${memberEvalList.length})` 
                              : `‚ñº View More (+${memberEvalList.length - visibleEvalsCount})`
                            }
                          </button>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
                  })
                }
              </div>

              {/* Pagination Arrow */}
              {groupData.members.length > 3 && (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px',
                  justifyContent: 'center'
                }}>
                  {/* Previous Button */}
                  <button
                    onClick={() => setEvalMemberPage(prev => Math.max(0, prev - 1))}
                    disabled={evalMemberPage === 0}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: evalMemberPage === 0 ? '#F3F4F6' : 'white',
                      color: evalMemberPage === 0 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: evalMemberPage === 0 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (evalMemberPage > 0) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = evalMemberPage === 0 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &lt;
                  </button>

                  {/* Page Indicator */}
                  <div style={{
                    textAlign: 'center',
                    fontSize: '11px',
                    fontWeight: '600',
                    color: '#6B7280',
                    minWidth: '44px'
                  }}>
                    {evalMemberPage + 1}/{Math.ceil(groupData.members.length / 3)}
                  </div>

                  {/* Next Button */}
                  <button
                    onClick={() => setEvalMemberPage(prev => prev + 1)}
                    disabled={evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white',
                      color: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (evalMemberPage < Math.ceil(groupData.members.length / 3) - 1) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &gt;
                  </button>
                </div>
              )}
            </div>
          </>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '24px',
            backgroundColor: '#F9FAFB',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            textAlign: 'center'
          }}>
            {groupData ? 'No group members available' : 'Loading group data...'}
          </div>
        )}
      </div>

      {/* Inclusion Recommendation Section */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#ffffff', marginBottom: '24px' }}>
          Inclusion Recommendation
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '12px'
          }}>
            {groupData.members.map((member) => {
              const memberId = member.student_id || member.id;
              const memberName = member.full_name || member.user_name || member.name || 'Unknown';
              const memberInitial = memberName.charAt(0).toUpperCase();
              const isLeader = groupData.members.indexOf(member) === 0;
              const isIncluded = memberInclusions[memberId] !== false;
              const feedback = inclusionFeedback[memberId] || '';

              return (
                <div key={`inclusion-${memberId}`} style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {/* Member Pill */}
                  <div
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '16px 20px',
                      backgroundColor: 'white',
                      border: '1px solid #e5e7eb',
                      borderRadius: '12px',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                      transition: 'all 0.2s ease',
                      opacity: isIncluded ? 1 : 0.75
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    }}
                  >
                    {/* Left Side - Profile and Info */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                      {/* Profile Picture */}
                      <div
                        style={{
                          width: '48px',
                          height: '48px',
                          borderRadius: '8px',
                          backgroundColor: '#34656D',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontSize: '20px',
                          fontWeight: '600',
                          overflow: 'hidden',
                          flexShrink: 0
                        }}
                      >
                        {member.profile_image_url && member.profile_image_url.trim() ? (
                          <img
                            src={member.profile_image_url.startsWith('http')
                              ? member.profile_image_url
                              : `${API_BASE_URL}${member.profile_image_url}`}
                            alt={memberName}
                            style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                            onError={(e) => {
                              e.target.style.display = 'none';
                            }}
                          />
                        ) : null}
                        {!member.profile_image_url || !member.profile_image_url.trim() ? (
                          <span>{memberInitial}</span>
                        ) : null}
                      </div>

                      {/* Member Details */}
                      <div>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: '#2c3e50'
                        }}>
                          {memberName}
                        </div>
                        <div style={{
                          fontSize: '12px',
                          color: '#6b7280',
                          textTransform: 'uppercase',
                          letterSpacing: '0.05em'
                        }}>
                          {isLeader ? 'Leader' : 'Member'}
                        </div>
                      </div>
                    </div>

                    {/* Right Side - Toggle Buttons */}
                    <div style={{
                      display: 'flex',
                      backgroundColor: '#F3F4F6',
                      borderRadius: '8px',
                      padding: '2px',
                      flexShrink: 0,
                      gap: '2px'
                    }}>
                      {/* Include Button */}
                      <button
                        onClick={() => {
                          if (!hasSubmission) {
                            setMemberInclusions(prev => ({ ...prev, [memberId]: true }));
                            setInclusionFeedback(prev => ({ ...prev, [memberId]: '' }));
                          }
                        }}
                        disabled={hasSubmission}
                        style={{
                          flex: 1,
                          padding: '8px 18px',
                          backgroundColor: isIncluded ? '#10B981' : 'transparent',
                          color: isIncluded ? '#FFFFFF' : '#6B7280',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: hasSubmission ? 'not-allowed' : 'pointer',
                          opacity: hasSubmission ? 0.6 : 1,
                          transition: 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
                          letterSpacing: '0.3px',
                          transform: isIncluded ? 'scale(1)' : 'scale(0.98)',
                          boxShadow: isIncluded ? '0 2px 8px rgba(16, 185, 129, 0.25)' : 'none',
                          animation: isIncluded ? 'slideToggle 0.4s ease-out' : 'slideToggleReverse 0.4s ease-out'
                        }}
                        onMouseEnter={(e) => {
                          if (isIncluded) {
                            e.target.style.backgroundColor = '#059669';
                            e.target.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.35)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (isIncluded) {
                            e.target.style.backgroundColor = '#10B981';
                            e.target.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.25)';
                          }
                        }}
                      >
                        Include
                      </button>

                      {/* Exclude Button */}
                      <button
                        onClick={() => {
                          if (!hasSubmission) {
                            setMemberInclusions(prev => ({ ...prev, [memberId]: false }));
                          }
                        }}
                        disabled={hasSubmission}
                        style={{
                          flex: 1,
                          padding: '8px 18px',
                          backgroundColor: !isIncluded ? '#EF4444' : 'transparent',
                          color: !isIncluded ? '#FFFFFF' : '#6B7280',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: hasSubmission ? 'not-allowed' : 'pointer',
                          opacity: hasSubmission ? 0.6 : 1,
                          transition: 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
                          letterSpacing: '0.3px',
                          transform: !isIncluded ? 'scale(1)' : 'scale(0.98)',
                          boxShadow: !isIncluded ? '0 2px 8px rgba(239, 68, 68, 0.25)' : 'none',
                          animation: !isIncluded ? 'slideToggle 0.4s ease-out' : 'slideToggleReverse 0.4s ease-out'
                        }}
                        onMouseEnter={(e) => {
                          if (!isIncluded) {
                            e.target.style.backgroundColor = '#DC2626';
                            e.target.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.35)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!isIncluded) {
                            e.target.style.backgroundColor = '#EF4444';
                            e.target.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.25)';
                          }
                        }}
                      >
                        Exclude
                      </button>
                    </div>
                  </div>

                  {/* Feedback Field - Appears when Excluded */}
                  {!isIncluded && (
                    <div
                      style={{
                        marginLeft: '0px',
                        animation: 'slideDown 0.3s ease-out',
                        marginBottom: '12px',
                        backgroundColor: '#FFFFFF',
                        padding: '16px',
                        borderRadius: '10px',
                        border: '1.5px solid #EF4444'
                      }}
                    >
                      {/* Header with Label */}
                      <div style={{ marginBottom: '12px' }}>
                        <label style={{
                          fontSize: '13px',
                          fontWeight: '600',
                          color: '#1F2937',
                          letterSpacing: '0.3px'
                        }}>
                          Exclusion Reason
                          <span style={{ color: '#EF4444' }}> *</span>
                        </label>
                        <p style={{
                          fontSize: '12px',
                          color: '#6B7280',
                          margin: '4px 0 0 0',
                          fontWeight: '400'
                        }}>
                          Minimum 50 characters required
                        </p>
                      </div>

                      {/* Textarea */}
                      <textarea
                        placeholder="Provide specific feedback for exclusion decision..."
                        value={feedback}
                        onChange={(e) => {
                          if (!hasSubmission) {
                            setInclusionFeedback(prev => ({ ...prev, [memberId]: e.target.value }));
                          }
                        }}
                        disabled={hasSubmission}
                        readOnly={hasSubmission}
                        style={{
                          width: '100%',
                          padding: '12px 14px',
                          fontSize: '13px',
                          border: feedback.length >= 50 ? '1.5px solid #10B981' : feedback.length > 0 ? '1.5px solid #F59E0B' : '1.5px solid #E5E7EB',
                          borderRadius: '8px',
                          fontFamily: 'inherit',
                          resize: 'vertical',
                          minHeight: '90px',
                          backgroundColor: hasSubmission ? '#F3F4F6' : '#FAFAFA',
                          color: '#1F2937',
                          cursor: hasSubmission ? 'not-allowed' : 'text',
                          opacity: hasSubmission ? 0.7 : 1,
                          boxShadow: feedback.length >= 50 ? '0 0 0 3px rgba(16, 185, 129, 0.08)' : feedback.length > 0 ? '0 0 0 3px rgba(245, 158, 11, 0.08)' : 'none',
                          transition: 'all 0.3s ease',
                          outline: 'none'
                        }}
                      />

                      {/* Character Counter and Status */}
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginTop: '12px',
                        fontSize: '12px',
                        fontWeight: '500'
                      }}>
                        <div style={{
                          color: feedback.length >= 50 ? '#10B981' : feedback.length > 0 ? '#F59E0B' : '#9CA3AF'
                        }}>
                          {feedback.length} / 50 characters
                          {feedback.length < 50 && feedback.length > 0 && <span style={{ marginLeft: '6px', color: '#F59E0B' }}>{50 - feedback.length} more needed</span>}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}

            {/* Action Buttons - Cancel and Submit */}
            <div style={{
              display: 'flex',
              gap: '12px',
              justifyContent: 'flex-end',
              marginTop: '24px',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }}>
              {/* Cancel Button */}
              <button
                onClick={() => {
                  setMemberInclusions({});
                  setInclusionFeedback({});
                }}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#F3F4F6',
                  color: '#374151',
                  border: '1.5px solid #D1D5DB',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease',
                  letterSpacing: '0.3px'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#E5E7EB';
                  e.target.style.borderColor = '#9CA3AF';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F3F4F6';
                  e.target.style.borderColor = '#D1D5DB';
                }}
              >
                Cancel
              </button>

              {/* Submit Button */}
              <button
                onClick={handleSubmitClick}
                disabled={submitting || hasSubmission}
                style={{
                  padding: '10px 24px',
                  backgroundColor: (submitting || hasSubmission) ? '#9CA3AF' : '#10B981',
                  color: '#FFFFFF',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: (submitting || hasSubmission) ? 'not-allowed' : 'pointer',
                  transition: 'all 0.3s ease',
                  letterSpacing: '0.3px',
                  boxShadow: '0 2px 8px rgba(16, 185, 129, 0.25)',
                  opacity: (submitting || hasSubmission) ? 0.7 : 1
                }}
                onMouseEnter={(e) => {
                  if (!submitting && !hasSubmission) {
                  e.target.style.backgroundColor = '#059669';
                  e.target.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.35)';
                  }
                }}
                onMouseLeave={(e) => {
                  if (!submitting && !hasSubmission) {
                  e.target.style.backgroundColor = '#10B981';
                  e.target.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.25)';
                  }
                }}
              >
                {hasSubmission ? 'Already Submitted' : (submitting ? (isCreatingNewAttempt ? 'Submitting Attempt...' : 'Submitting...') : (isCreatingNewAttempt ? 'Submit New Attempt' : 'Submit'))}
              </button>
              
              {/* ‚úÖ NEW: Cancel New Attempt Button - Only show when creating new attempt */}
              {isCreatingNewAttempt && (
                <button
                  onClick={handleCancelNewAttempt}
                  style={{
                    padding: '10px 24px',
                    backgroundColor: '#EF4444',
                    color: '#FFFFFF',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease',
                    letterSpacing: '0.3px'
                  }}
                  onMouseEnter={(e) => e.target.style.backgroundColor = '#DC2626'}
                  onMouseLeave={(e) => e.target.style.backgroundColor = '#EF4444'}
                >
                  Cancel New Attempt
                </button>
              )}
            </div>
          </div>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '24px',
            backgroundColor: '#F9FAFB',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            textAlign: 'center'
          }}>
            {groupData ? 'No group members available' : 'Loading group data...'}
          </div>
        )}
      </div>

      {/* Validation Modal */}
      {showValidationModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10001
        }}
        onClick={() => setShowValidationModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '600px',
            width: '90%',
            maxHeight: '85vh',
            overflow: 'auto',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                <h2 style={{
                  margin: 0,
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  color: '#2c3e50'
                }}>
                  Submission Validation
                </h2>
                <p style={{
                  margin: '4px 0 0 0',
                  fontSize: '14px',
                  color: '#6b7280'
                }}>
                  Please review the following before submitting
                </p>
              </div>
              <button
                onClick={() => setShowValidationModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6b7280',
                  padding: '4px 8px'
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {/* Validation Errors (Red - Must Fix) */}
              {validationErrors.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginBottom: '12px'
                  }}>
                    <FaExclamationTriangle style={{ color: '#DC2626', fontSize: '20px' }} />
                    <h3 style={{
                      margin: 0,
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#DC2626'
                    }}>
                      Required Actions ({validationErrors.length})
                    </h3>
                  </div>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {validationErrors.map((error, index) => (
                      <div
                        key={index}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FEE2E2',
                          border: '1px solid #FCA5A5',
                          borderLeft: '4px solid #DC2626',
                          borderRadius: '8px'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '10px'
                        }}>
                          <span style={{ fontSize: '20px' }}>{error.icon}</span>
                          <div style={{ flex: 1 }}>
                            <p style={{
                              margin: 0,
                              fontWeight: '600',
                              color: '#991B1B',
                              fontSize: '14px'
                            }}>
                              {error.message}
                            </p>
                            {error.details && error.details.length > 0 && (
                              <div style={{ marginTop: '8px' }}>
                                {error.type === 'min_tasks' && (
                                  <ul style={{
                                    margin: 0,
                                    paddingLeft: '20px',
                                    fontSize: '13px',
                                    color: '#7F1D1D'
                                  }}>
                                    {error.details.map((detail, idx) => (
                                      <li key={idx}>
                                        <strong>{detail.name}:</strong> {detail.assigned}/{detail.required} tasks assigned
                                      </li>
                                    ))}
                                  </ul>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Validation Warnings (Yellow - Optional) */}
              {validationWarnings.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginBottom: '12px'
                  }}>
                    <FaInfoCircle style={{ color: '#F59E0B', fontSize: '20px' }} />
                    <h3 style={{
                      margin: 0,
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#F59E0B'
                    }}>
                      Warnings ({validationWarnings.length})
                    </h3>
                  </div>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {validationWarnings.map((warning, index) => (
                      <div
                        key={index}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FEF3C7',
                          border: '1px solid #FCD34D',
                          borderLeft: '4px solid #F59E0B',
                          borderRadius: '8px'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '10px'
                        }}>
                          <div style={{ fontSize: '20px', color: '#F59E0B', marginTop: '2px' }}>
                            {warning.icon === 'FaChartBar' && <FaChartBar />}
                            {warning.icon === 'FaClipboardList' && <FaClipboardList />}
                          </div>
                          <div style={{ flex: 1 }}>
                            <p style={{
                              margin: 0,
                              fontWeight: '600',
                              color: '#92400E',
                              fontSize: '14px'
                            }}>
                              {warning.message}
                            </p>
                            {warning.details && warning.details.length > 0 && (
                              <div style={{ marginTop: '8px' }}>
                                {warning.type === 'evaluations' && (
                                  <ul style={{
                                    margin: 0,
                                    paddingLeft: '20px',
                                    fontSize: '13px',
                                    color: '#78350F'
                                  }}>
                                    {warning.details.map((detail, idx) => (
                                      <li key={idx}>{detail.name}</li>
                                    ))}
                                  </ul>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Success State - All Validations Passed */}
              {validationErrors.length === 0 && validationWarnings.length === 0 && (
                <div style={{
                  padding: '32px',
                  textAlign: 'center',
                  backgroundColor: '#D1FAE5',
                  borderRadius: '8px',
                  border: '1px solid #6EE7B7'
                }}>
                  <FaCheckCircle style={{ fontSize: '48px', color: '#059669', marginBottom: '12px' }} />
                  <p style={{
                    margin: 0,
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#047857'
                  }}>
                    All requirements met! Ready to submit.
                  </p>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '20px 24px',
              borderTop: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'flex-end',
              gap: '12px',
              backgroundColor: '#F9FAFB'
            }}>
              <button
                onClick={() => setShowValidationModal(false)}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#F3F4F6',
                  color: '#374151',
                  border: '1px solid #D1D5DB',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#E5E7EB';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F3F4F6';
                }}
              >
                Back
              </button>
              <button
                onClick={proceedWithSubmission}
                disabled={validationErrors.length > 0}
                style={{
                  padding: '10px 24px',
                  backgroundColor: validationErrors.length > 0 ? '#9CA3AF' : '#10B981',
                  color: '#FFFFFF',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: validationErrors.length > 0 ? 'not-allowed' : 'pointer',
                  transition: 'all 0.2s ease',
                  opacity: validationErrors.length > 0 ? 0.6 : 1
                }}
                onMouseEnter={(e) => {
                  if (validationErrors.length === 0) {
                    e.target.style.backgroundColor = '#059669';
                  }
                }}
                onMouseLeave={(e) => {
                  if (validationErrors.length === 0) {
                    e.target.style.backgroundColor = '#10B981';
                  }
                }}
              >
                {validationErrors.length > 0 ? 'Fix Issues to Proceed' : 'Proceed with Submission'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Task Detail Modal */}
      {showTaskDetailModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}
        onClick={() => setShowTaskDetailModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '800px',
            width: '90%',
            maxHeight: '85vh',
            overflow: 'auto',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{
                margin: 0,
                fontSize: '1.5rem',
                fontWeight: '700',
                color: '#2c3e50'
              }}>
                Task Details
              </h2>
              <button
                onClick={() => setShowTaskDetailModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6b7280',
                  padding: '4px 8px'
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {loadingTaskDetail ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <div style={{
                    display: 'inline-block',
                    width: '40px',
                    height: '40px',
                    border: '4px solid #f3f4f6',
                    borderTop: '4px solid #34656D',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }}></div>
                  <p style={{ marginTop: '16px', color: '#6b7280' }}>Loading task details...</p>
                </div>
              ) : selectedTaskDetail ? (
                <>
                  {/* Task Information */}
                  <div style={{ marginBottom: '24px' }}>
                    <h3 style={{
                      fontSize: '1.1rem',
                      fontWeight: '600',
                      color: '#34656D',
                      marginBottom: '12px'
                    }}>
                      {selectedTaskDetail.title}
                    </h3>
                    
                    {/* Task Status Badge */}
                    {selectedTaskDetail.status && (
                      <div style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '6px',
                        padding: '6px 12px',
                        borderRadius: '6px',
                        fontSize: '13px',
                        fontWeight: '600',
                        marginBottom: '16px',
                        backgroundColor: selectedTaskDetail.status === 'completed' ? '#D1FAE5' : 
                                       selectedTaskDetail.status === 'to_revise' ? '#FFEDD5' : '#FEE2E2',
                        color: selectedTaskDetail.status === 'completed' ? '#059669' : 
                              selectedTaskDetail.status === 'to_revise' ? '#EA580C' : '#DC2626'
                      }}>
                        {selectedTaskDetail.status === 'completed' ? <><FaCheck size={12} /> Completed</> :
                         selectedTaskDetail.status === 'to_revise' ? <><FaExclamationTriangle size={12} /> Needs Revision</> :
                         <><FaClock size={12} /> Pending</>}
                      </div>
                    )}

                    {selectedTaskDetail.description && (
                      <p style={{
                        color: '#6b7280',
                        lineHeight: '1.6',
                        marginTop: '12px'
                      }}>
                        {selectedTaskDetail.description}
                      </p>
                    )}

                    {selectedTaskDetail.due_date && (
                      <div style={{
                        marginTop: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        color: '#6b7280',
                        fontSize: '14px'
                      }}>
                        <FaCalendarAlt />
                        <span>Due: {new Date(selectedTaskDetail.due_date).toLocaleDateString('en-US', {
                          month: 'long',
                          day: 'numeric',
                          year: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}</span>
                      </div>
                    )}
                  </div>

                  {/* Submission Details */}
                  {selectedTaskDetail.submissionDetails && selectedTaskDetail.submissionDetails.submission ? (
                    <div style={{
                      marginTop: '24px',
                      padding: '20px',
                      backgroundColor: '#F9FAFB',
                      borderRadius: '8px',
                      border: '1px solid #E5E7EB'
                    }}>
                      <h4 style={{
                        fontSize: '1rem',
                        fontWeight: '600',
                        color: '#2c3e50',
                        marginBottom: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <FaFileAlt />
                        Submission
                        {selectedTaskDetail.submissionDetails.submission.revision_attempt_number && (
                          <span style={{
                            fontSize: '12px',
                            fontWeight: '500',
                            color: '#6b7280',
                            marginLeft: '4px'
                          }}>
                            (Revision #{selectedTaskDetail.submissionDetails.submission.revision_attempt_number})
                          </span>
                        )}
                      </h4>

                      {/* Submission Type Badge */}
                      <div style={{
                        display: 'inline-block',
                        padding: '4px 10px',
                        borderRadius: '4px',
                        fontSize: '11px',
                        fontWeight: '600',
                        marginBottom: '12px',
                        backgroundColor: selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' || 
                                       selectedTaskDetail.submissionDetails.submissionType === 'approved_original' 
                          ? '#D1FAE5' : '#FEF3C7',
                        color: selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' || 
                              selectedTaskDetail.submissionDetails.submissionType === 'approved_original' 
                          ? '#059669' : '#B45309'
                      }}>
                        {selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' ? '‚úì Approved Revision' :
                         selectedTaskDetail.submissionDetails.submissionType === 'approved_original' ? '‚úì Approved Original' :
                         selectedTaskDetail.submissionDetails.submissionType === 'revision_requested' ? '‚ö† Revision Requested' :
                         selectedTaskDetail.submissionDetails.submissionType === 'leader_acted' ? 'üìù Leader Reviewed' :
                         selectedTaskDetail.submissionDetails.submissionType === 'latest_revision' ? 'üìÑ Latest Revision' :
                         'üìÑ Latest Submission'}
                      </div>

                      {selectedTaskDetail.submissionDetails.submission.submitted_at && (
                        <p style={{
                          fontSize: '13px',
                          color: '#6b7280',
                          marginBottom: '12px'
                        }}>
                          <strong>Submitted:</strong> {new Date(selectedTaskDetail.submissionDetails.submission.submitted_at).toLocaleString()}
                        </p>
                      )}

                      {selectedTaskDetail.submissionDetails.submission.submission_text && (
                        <div style={{ marginBottom: '16px' }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            marginBottom: '6px'
                          }}>
                            Submission Text:
                          </p>
                          <p style={{
                            fontSize: '14px',
                            color: '#374151',
                            lineHeight: '1.6',
                            padding: '12px',
                            backgroundColor: 'white',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.submission_text}
                          </p>
                        </div>
                      )}

                      {/* Leader Feedback */}
                      {selectedTaskDetail.submissionDetails.submission.review_comments && (
                        <div style={{
                          marginTop: '16px',
                          padding: '12px',
                          backgroundColor: '#FEF3C7',
                          borderRadius: '6px',
                          borderLeft: '4px solid #F59E0B'
                        }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#92400E',
                            marginBottom: '6px'
                          }}>
                            Leader Feedback:
                          </p>
                          <p style={{
                            fontSize: '14px',
                            color: '#78350F',
                            lineHeight: '1.6'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.review_comments}
                          </p>
                        </div>
                      )}

                      {/* Submitted Files */}
                      {selectedTaskDetail.submissionDetails.submission.files && 
                       selectedTaskDetail.submissionDetails.submission.files.length > 0 && (
                        <div style={{ marginTop: '16px' }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            marginBottom: '10px'
                          }}>
                            Submitted Files ({selectedTaskDetail.submissionDetails.submission.files.length}):
                          </p>
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '8px'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.files.map((filePath, index) => {
                              const fileName = filePath.split('/').pop();
                              const fileExt = fileName.split('.').pop().toLowerCase();
                              return (
                                <a
                                  key={index}
                                  href={`${apiConfig.baseURL}/api/download-file?path=${encodeURIComponent(filePath)}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    padding: '10px 12px',
                                    backgroundColor: 'white',
                                    border: '1px solid #E5E7EB',
                                    borderRadius: '6px',
                                    textDecoration: 'none',
                                    color: '#2c3e50',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.backgroundColor = '#F3F4F6';
                                    e.currentTarget.style.borderColor = '#34656D';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.backgroundColor = 'white';
                                    e.currentTarget.style.borderColor = '#E5E7EB';
                                  }}
                                >
                                  <FaFileAlt style={{ color: '#34656D', fontSize: '18px' }} />
                                  <span style={{
                                    flex: 1,
                                    fontSize: '14px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                  }}>
                                    {fileName}
                                  </span>
                                  <FaDownload style={{ color: '#6b7280', fontSize: '14px' }} />
                                </a>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div style={{
                      padding: '40px',
                      textAlign: 'center',
                      color: '#9CA3AF'
                    }}>
                      <FaFileAlt size={48} style={{ marginBottom: '12px', opacity: 0.5 }} />
                      <p>No submission found for this task</p>
                    </div>
                  )}
                </>
              ) : (
                <div style={{
                  padding: '40px',
                  textAlign: 'center',
                  color: '#9CA3AF'
                }}>
                  <p>Failed to load task details</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ‚úÖ File Type Error Modal */}
      {showFileTypeErrorModal && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 10000
          }}
          onClick={() => setShowFileTypeErrorModal(false)}
        >
          <div 
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '32px',
              maxWidth: '500px',
              width: '90%',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Icon and Title */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                backgroundColor: '#FEE2E2',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '24px'
              }}>
                ‚ùå
              </div>
              <h3 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#1F2937' }}>
                Invalid File Type{invalidFilesList.length > 1 ? 's' : ''} Detected
              </h3>
            </div>

            {/* Description */}
            <p style={{ color: '#6B7280', marginBottom: '20px', lineHeight: '1.6' }}>
              The following file{invalidFilesList.length > 1 ? 's have' : ' has'} invalid extension{invalidFilesList.length > 1 ? 's' : ''}:
            </p>

            {/* Invalid Files List */}
            <div style={{
              backgroundColor: '#FEF2F2',
              border: '1px solid #FECACA',
              borderRadius: '8px',
              padding: '16px',
              marginBottom: '20px'
            }}>
              {invalidFilesList.map((fileName, index) => (
                <div key={index} style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '8px',
                  marginBottom: index < invalidFilesList.length - 1 ? '8px' : '0'
                }}>
                  <span style={{ color: '#DC2626', fontSize: '16px' }}>‚Ä¢</span>
                  <span style={{ color: '#991B1B', fontWeight: '500', wordBreak: 'break-all' }}>
                    {fileName}
                  </span>
                </div>
              ))}
            </div>

            {/* Allowed Types */}
            {fileTypeError && (
              <div style={{
                backgroundColor: '#ECFDF5',
                border: '1px solid #A7F3D0',
                borderRadius: '8px',
                padding: '16px',
                marginBottom: '24px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                  <span style={{ color: '#059669', fontSize: '16px' }}>‚úì</span>
                  <span style={{ color: '#065F46', fontWeight: '600' }}>Allowed File Types:</span>
                </div>
                <span style={{ color: '#047857', fontSize: '14px' }}>
                  {fileTypeError.replace('Allowed file types: ', '')}
                </span>
              </div>
            )}

            {/* Action Button */}
            <button
              onClick={() => setShowFileTypeErrorModal(false)}
              style={{
                width: '100%',
                padding: '12px 24px',
                backgroundColor: '#EF4444',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onMouseEnter={(e) => e.target.style.backgroundColor = '#DC2626'}
              onMouseLeave={(e) => e.target.style.backgroundColor = '#EF4444'}
            >
              Got it
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// Deliverable Project Details Component
const DeliverableProjectDetails = ({ project, projectSubmission, groupData, onSubmit }) => {
  const [files, setFiles] = useState([]);
  const [submissionText, setSubmissionText] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [memberTasks, setMemberTasks] = useState({});
  const [loadingTasks, setLoadingTasks] = useState(false);
  const [expandedCards, setExpandedCards] = useState({});
  const [minTasksPerMember, setMinTasksPerMember] = useState(1);
  const [maxTasksPerMember, setMaxTasksPerMember] = useState(10);
  const [memberPage, setMemberPage] = useState(0);
  const [memberEvaluations, setMemberEvaluations] = useState({});
  const [loadingEvaluations, setLoadingEvaluations] = useState(false);
  const [expandedEvalCards, setExpandedEvalCards] = useState({});
  const [evalMemberPage, setEvalMemberPage] = useState(0);
  const [memberInclusions, setMemberInclusions] = useState({});
  const [inclusionFeedback, setInclusionFeedback] = useState({});
  const [expandedPhaseDropdowns, setExpandedPhaseDropdowns] = useState({});
  const [projectPhases, setProjectPhases] = useState([]);
  const [phaseSubmissions, setPhaseSubmissions] = useState({});
  const [loadingPhaseSubmissions, setLoadingPhaseSubmissions] = useState(false);
  const [expandedExclusionReasons, setExpandedExclusionReasons] = useState({});
  const [minTasksPerPhase, setMinTasksPerPhase] = useState(1);
  const [maxTasksPerPhase, setMaxTasksPerPhase] = useState(10);
  const [fileTypeError, setFileTypeError] = useState(null); // ‚úÖ File type error state
  const [showFileTypeErrorModal, setShowFileTypeErrorModal] = useState(false); // ‚úÖ File type error modal
  const [invalidFilesList, setInvalidFilesList] = useState([]); // ‚úÖ List of invalid files
  
  // Task Detail Modal State
  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);
  const [selectedTaskDetail, setSelectedTaskDetail] = useState(null);
  const [loadingTaskDetail, setLoadingTaskDetail] = useState(false);
  
  // Validation Modal State
  const [showValidationModal, setShowValidationModal] = useState(false);
  const [validationErrors, setValidationErrors] = useState([]);
  const [validationWarnings, setValidationWarnings] = useState([]);

  // ‚úÖ NEW: Check if project has been submitted
  const projectSubmissionDetails = projectSubmission ? [projectSubmission] : [];
  const hasSubmission = projectSubmissionDetails && projectSubmissionDetails.length > 0;
  const latestSubmission = hasSubmission ? projectSubmissionDetails[projectSubmissionDetails.length - 1] : null;

  // ‚úÖ Helper to generate accept attribute for file input
  const getFileAcceptAttribute = () => {
    let allowedTypes = [];
    if (project.file_types_allowed) {
      try {
        allowedTypes = typeof project.file_types_allowed === 'string' 
          ? JSON.parse(project.file_types_allowed) 
          : project.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }
    
    if (allowedTypes.length > 0) {
      return allowedTypes.map(type => {
        const ext = type.toLowerCase().replace('.', '');
        return `.${ext}`;
      }).join(',');
    }
    return ''; // No restrictions
  };

  // Toggle card expansion
  const toggleCardExpansion = (memberId) => {
    setExpandedCards(prev => ({
      ...prev,
      [memberId]: !prev[memberId]
    }));
  };

  // Toggle evaluation card expansion
  const toggleEvalCardExpansion = (memberId) => {
    setExpandedEvalCards(prev => ({
      ...prev,
      [memberId]: !prev[memberId]
    }));
  };

  // Toggle phase dropdown
  const togglePhaseDropdown = (memberId, phaseId) => {
    const key = `${memberId}-${phaseId}`;
    setExpandedPhaseDropdowns(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  // Handle task click to show details and files
  const handleTaskClick = async (task) => {
    try {
      setLoadingTaskDetail(true);
      setShowTaskDetailModal(true);
      
      const token = localStorage.getItem('token');
      
      // Fetch task submission details - get approved submission or latest leader-acted submission
      const response = await fetch(
        `${apiConfig.baseURL}/api/tasks/${task.id}/submission-details`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const submissionData = await response.json();
        console.log('üìã Task submission details:', submissionData);
        
        setSelectedTaskDetail({
          ...task,
          submissionDetails: submissionData
        });
      } else {
        // If endpoint doesn't exist or fails, just show task info without submission details
        setSelectedTaskDetail({
          ...task,
          submissionDetails: null
        });
      }
    } catch (error) {
      console.error('Error fetching task details:', error);
      setSelectedTaskDetail({
        ...task,
        submissionDetails: null
      });
    } finally {
      setLoadingTaskDetail(false);
    }
  };

  // ‚úÖ NEW: Load submission data when component mounts
  useEffect(() => {
    if (hasSubmission && latestSubmission) {
      // Load member inclusions from submission
      if (latestSubmission.member_inclusions && Array.isArray(latestSubmission.member_inclusions)) {
        const inclusionsMap = {};
        const feedbackMap = {};
        
        latestSubmission.member_inclusions.forEach(inclusion => {
          inclusionsMap[inclusion.member_id] = inclusion.included !== false;
          if (inclusion.exclusion_reason) {
            feedbackMap[inclusion.member_id] = inclusion.exclusion_reason;
          }
        });
        
        setMemberInclusions(inclusionsMap);
        setInclusionFeedback(feedbackMap);
        console.log('üìã [PROJECT] Loaded member inclusions from submission:', inclusionsMap);
        console.log('üìã [PROJECT] Loaded exclusion feedback from submission:', feedbackMap);
      }

      // Load submission text
      if (latestSubmission.submission_text) {
        setSubmissionText(latestSubmission.submission_text);
      }
    }
  }, [hasSubmission, latestSubmission]);

  // Fetch tasks for each member in this project
  useEffect(() => {
    if (project && groupData?.members) {
      fetchMemberTasks();
      fetchMemberEvaluations();
    }
  }, [project.id, groupData?.members]);

  // Fetch phase submissions when projectPhases changes
  useEffect(() => {
    if (projectPhases && projectPhases.length > 0) {
      fetchPhaseSubmissions();
    }
  }, [projectPhases]);

  const fetchMemberTasks = async () => {
    try {
      setLoadingTasks(true);
      const token = localStorage.getItem('token');
      
      // Fetch all tasks for all members in this project (not phase-specific)
      const response = await fetch(
        `${API_BASE_URL}/api/student/project-member-tasks?projectId=${project.id}`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const data = await response.json();
        console.log('üìã Member tasks fetched:', data.data);
        console.log('üìÖ Project phases:', data.phases);
        console.log('üìä Min/Max from response:', data.minTasksPerMember, data.maxTasksPerMember);
        
        // Store all project phases
        const phases = data.phases || [];
        setProjectPhases(phases);
        
        // For PROJECT deliverable: min/max should already be project-level from backend
        // (backend should return multiplied values, not per-phase values)
        const numPhases = phases.length || 1;
        const minPerPhase = data.minTasksPerMember || 1;
        const maxPerPhase = data.maxTasksPerMember || 10;
        
        // Store per-phase values (used for validation - each phase needs this many tasks)
        setMinTasksPerPhase(minPerPhase);
        setMaxTasksPerPhase(maxPerPhase);
        
        // Project totals = per-phase amount √ó number of phases (for display purposes)
        const projectMin = minPerPhase * numPhases;
        const projectMax = maxPerPhase * numPhases;
        
        console.log(`ÔøΩ Using project totals directly: min ${projectMin}, max ${projectMax}`);
        
        setMinTasksPerMember(projectMin);
        setMaxTasksPerMember(projectMax);
        
        // Organize tasks by member ID - store as object with member_name for reference
        const tasksByMember = {};
        (data.data || []).forEach(memberData => {
          tasksByMember[memberData.member_id] = memberData.tasks || [];
        });

        setMemberTasks(tasksByMember);
      }
    } catch (error) {
      console.error('Error fetching member tasks:', error);
    } finally {
      setLoadingTasks(false);
    }
  };

  const fetchMemberEvaluations = async () => {
    try {
      setLoadingEvaluations(true);
      const token = localStorage.getItem('token');
      
      // Fetch project evaluation submission status for all group members
      const response = await fetch(
        `${apiConfig.baseURL}/api/student/projects/${project.id}/group-evaluation-status`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.ok) {
        const data = await response.json();
        console.log('üìã Project evaluation status fetched:', data);
        
        // Organize submission status by member ID
        // Convert the API response into the format expected by the UI
        const evalsByMember = {};
        
        (data.members || []).forEach(memberData => {
          console.log(`üîç Processing member ${memberData.student_name} (${memberData.student_id}):`, {
            has_submitted: memberData.has_submitted,
            total_submissions: memberData.total_submissions,
            submitted_count: memberData.submitted_count,
            submissions: memberData.submissions
          });

          // Create evaluation entries based on submission status
          const evaluations = [];
          
          if (memberData.has_submitted) {
            memberData.submissions.forEach(sub => {
              console.log(`   üìù Checking submission ${sub.id}:`, {
                status: sub.status,
                is_custom: sub.is_custom,
                has_file: sub.has_file,
                has_data: sub.has_data,
                will_include: sub.status !== 'not_started'
              });

              if (sub.status !== 'not_started') {
                evaluations.push({
                  id: sub.id,
                  status: sub.status,
                  submission_date: sub.submission_date,
                  is_custom: sub.is_custom,
                  has_file: sub.has_file,
                  has_data: sub.has_data,
                  project_id: sub.project_id,
                  project_title: sub.project_title,
                  evaluator_name: sub.evaluation_label || 'Project Evaluation'
                });
              }
            });
          }
          
          console.log(`   ‚úÖ Final evaluations for ${memberData.student_name}: ${evaluations.length}`, evaluations);
          evalsByMember[memberData.student_id] = evaluations;
        });

        console.log('üìã Organized evaluations by member:', evalsByMember);
        setMemberEvaluations(evalsByMember);
      } else {
        console.error('Failed to fetch project evaluation status:', response.status);
        // Initialize empty evaluations for all members
        const evalsByMember = {};
        groupData.members.forEach(member => {
          evalsByMember[member.student_id || member.id] = [];
        });
        setMemberEvaluations(evalsByMember);
      }
    } catch (error) {
      console.error('Error fetching project evaluation status:', error);
      // Initialize empty evaluations for all members on error
      const evalsByMember = {};
      groupData.members.forEach(member => {
        evalsByMember[member.student_id || member.id] = [];
      });
      setMemberEvaluations(evalsByMember);
    } finally {
      setLoadingEvaluations(false);
    }
  };

  // Fetch phase deliverable submissions
  const fetchPhaseSubmissions = async () => {
    if (!projectPhases || projectPhases.length === 0) return;
    
    try {
      setLoadingPhaseSubmissions(true);
      const token = localStorage.getItem('token');
      const group_id = groupData?.group_id || groupData?.id;
      
      console.log('üì¶ Fetching phase submissions for', projectPhases.length, 'phases');
      
      const submissionsMap = {};
      
      for (const phase of projectPhases) {
        try {
          const response = await fetch(
            `${apiConfig.baseURL}/api/student/phases/${phase.id}/deliverable-submissions?group_id=${group_id}`,
            {
              headers: { 'Authorization': `Bearer ${token}` }
            }
          );
          
          if (response.ok) {
            const data = await response.json();
            const submissions = data.submissions || data || [];
            submissionsMap[phase.id] = submissions.length > 0 ? submissions[0] : null;
            console.log(`‚úÖ Phase ${phase.phase_number} submission:`, submissionsMap[phase.id]);
          } else {
            submissionsMap[phase.id] = null;
          }
        } catch (error) {
          console.error(`Error fetching submission for phase ${phase.phase_number}:`, error);
          submissionsMap[phase.id] = null;
        }
      }
      
      setPhaseSubmissions(submissionsMap);
    } catch (error) {
      console.error('Error fetching phase submissions:', error);
    } finally {
      setLoadingPhaseSubmissions(false);
    }
  };

  // Handle file download
  const handleFileDownload = async (fileUrl, fileName) => {
    try {
      const response = await fetch(fileUrl);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Error downloading file:', error);
      // Fallback: open in new tab if download fails
      window.open(fileUrl, '_blank');
    }
  };

  // Validate project deliverable submission before allowing submit
  const validateProjectDeliverable = () => {
    const errors = [];
    const warnings = [];

    // VALIDATION RULE 1: Check if at least one file is selected
    if (!files || files.length === 0) {
      errors.push({
        type: 'files',
        message: 'At least one file must be uploaded',
        icon: 'üìÅ'
      });
    }

    // WARNING 2: Check if all members have minimum tasks PER PHASE (informational only)
    // Changed from error to warning - leaders can still submit even if task distribution isn't perfect
    if (groupData && groupData.members && memberTasks && projectPhases && projectPhases.length > 0) {
      const membersWithInsufficientTasks = [];
      
      console.log('üîç PROJECT VALIDATION DEBUG - Checking min tasks per phase');
      console.log('üîç PROJECT VALIDATION DEBUG - Min per phase:', minTasksPerPhase);
      console.log('üîç PROJECT VALIDATION DEBUG - Number of phases:', projectPhases.length);
      
      groupData.members.forEach(member => {
        const memberId = member.student_id || member.id;
        const memberTaskList = memberTasks[memberId] || [];
        
        // Group tasks by phase for this member
        const tasksByPhase = {};
        projectPhases.forEach(phase => {
          tasksByPhase[phase.id] = memberTaskList.filter(task => task.phase_id === phase.id).length;
        });
        
        // Check each phase individually - show warning for minimum or below
        const insufficientPhases = [];
        projectPhases.forEach(phase => {
          const taskCount = tasksByPhase[phase.id] || 0;
          console.log(`üìä Validation - Member: ${member.full_name || member.name}, Phase ${phase.phase_number}: ${taskCount}/${minTasksPerPhase} tasks`);
          
          // Show warning if at or below minimum (not just below)
          if (taskCount <= minTasksPerPhase) {
            insufficientPhases.push({
              phaseNumber: phase.phase_number,
              phaseTitle: phase.title,
              assigned: taskCount,
              required: minTasksPerPhase,
              isAtMinimum: taskCount === minTasksPerPhase
            });
          }
        });
        
        if (insufficientPhases.length > 0) {
          membersWithInsufficientTasks.push({
            name: member.full_name || member.user_name || member.name || 'Unknown',
            phases: insufficientPhases,
            totalAssigned: memberTaskList.length,
            totalRequired: minTasksPerPhase * projectPhases.length
          });
        }
      });

      if (membersWithInsufficientTasks.length > 0) {
        warnings.push({
          type: 'min_tasks',
          message: `Task distribution status - Members at or below minimum requirement`,
          details: membersWithInsufficientTasks,
          icon: 'FaChartBar',
          subMessage: `Minimum required: ${minTasksPerPhase} task(s) per phase (${minTasksPerPhase * projectPhases.length} total across ${projectPhases.length} phases)`
        });
      }
    }

    // WARNING 1: Check project evaluation submission status
    if (groupData && groupData.members && memberEvaluations) {
      const membersWithoutEvaluation = [];
      
      groupData.members.forEach(member => {
        const memberId = member.student_id || member.id;
        const evaluation = memberEvaluations[memberId];
        
        if (!evaluation || !evaluation.submitted) {
          membersWithoutEvaluation.push({
            name: member.full_name || member.user_name || member.name || 'Unknown'
          });
        }
      });

      if (membersWithoutEvaluation.length > 0) {
        warnings.push({
          type: 'evaluations',
          message: `${membersWithoutEvaluation.length} member(s) have not submitted project evaluations`,
          details: membersWithoutEvaluation,
          icon: 'FaClipboardList'
        });
      }
    }

    return { errors, warnings };
  };

  // Handle submit button click - show validation modal first
  const handleSubmitClick = () => {
    const { errors, warnings } = validateProjectDeliverable();
    setValidationErrors(errors);
    setValidationWarnings(warnings);
    setShowValidationModal(true);
  };

  // Proceed with actual submission after validation
  const proceedWithSubmission = async () => {
    setShowValidationModal(false);
    
    try {
      setSubmitting(true);
      const token = localStorage.getItem('token');

      // Prepare FormData for multipart/form-data submission
      const formData = new FormData();
      formData.append('projectId', project.id);
      formData.append('groupId', groupData.group_id || groupData.id);
      formData.append('submissionText', submissionText || '');
      
      // Add member inclusions
      const memberInclusionsArray = groupData.members.map(member => {
        const memberId = member.student_id || member.id;
        return {
          member_id: memberId,
          member_name: member.full_name || member.user_name || member.name || 'Unknown',
          role: groupData.members.indexOf(member) === 0 ? 'leader' : 'member',
          included: memberInclusions[memberId] !== false,
          exclusion_reason: memberInclusions[memberId] === false ? (inclusionFeedback[memberId] || '') : null
        };
      });
      formData.append('memberInclusions', JSON.stringify(memberInclusionsArray));
      
      // Add validation results
      formData.append('validationResults', JSON.stringify({
        files_uploaded: files.length > 0,
        min_tasks_met: validationErrors.length === 0,
        members_below_minimum: validationErrors.filter(e => e.type === 'min_tasks'),
        evaluation_warnings: validationWarnings
      }));
      
      // Add files
      files.forEach((file, index) => {
        formData.append('files', file);
      });

      console.log('üì¶ Submitting project deliverable...');
      console.log('  Project:', project.id);
      console.log('  Group ID:', groupData.group_id || groupData.id);
      console.log('  Files:', files.length);
      console.log('  Member Inclusions:', memberInclusionsArray);

      const response = await fetch(`${apiConfig.baseURL}/api/student/project-deliverable/submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || errorData.details || 'Failed to submit project deliverable');
      }

      const result = await response.json();
      console.log('‚úÖ Project deliverable submitted successfully:', result);

      // Clear form after successful submission
      setFiles([]);
      setSubmissionText('');
      setMemberInclusions({});
      setInclusionFeedback({});
      
      alert(`Project deliverable submitted successfully!\n\nSubmission ID: ${result.submission_id}\nSubmitted at: ${new Date(result.submitted_at).toLocaleString()}`);
      
      // Reload the page to fetch updated submission data
      window.location.reload();
    } catch (error) {
      console.error('‚ùå Error submitting project deliverable:', error);
      alert(`Error submitting project deliverable:\n${error.message}`);
    } finally {
      setSubmitting(false);
    }
  };

  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files || []);
    if (selectedFiles.length === 0) return;

    // ‚úÖ FILE TYPE VALIDATION
    setFileTypeError(null); // Clear previous errors
    let allowedTypes = [];
    if (project.file_types_allowed) {
      try {
        allowedTypes = typeof project.file_types_allowed === 'string' 
          ? JSON.parse(project.file_types_allowed) 
          : project.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }

    // Validate file types if restrictions exist
    if (allowedTypes.length > 0) {
      const invalidFiles = [];
      selectedFiles.forEach(file => {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const isValid = allowedTypes.some(type => {
          const allowedExt = type.toLowerCase().replace('.', '');
          return fileExt === allowedExt;
        });
        if (!isValid) {
          invalidFiles.push(file.name);
        }
      });

      if (invalidFiles.length > 0) {
        const errorMsg = `Allowed file types: ${allowedTypes.join(', ')}`;
        setFileTypeError(errorMsg);
        setInvalidFilesList(invalidFiles);
        setShowFileTypeErrorModal(true);
        e.target.value = ''; // Clear the input
        return;
      }
    }

    // Append new files to existing files, avoiding exact duplicates by name+size+lastModified
    setFiles((prevFiles) => {
      const existing = Array.isArray(prevFiles) ? prevFiles : [];
      const merged = [...existing];
      selectedFiles.forEach((sf) => {
        const isDuplicate = existing.some(
          (f) => f.name === sf.name && f.size === sf.size && f.lastModified === sf.lastModified
        );
        if (!isDuplicate) merged.push(sf);
      });
      return merged;
    });

    // Clear the input so selecting the same file again will trigger change
    e.target.value = '';
  };

  const handleSubmit = async () => {
    if (files.length === 0) {
      alert('Please select at least one file to submit');
      return;
    }

    // ‚úÖ RE-VALIDATE FILE TYPES BEFORE SUBMISSION
    let allowedTypes = [];
    if (project.file_types_allowed) {
      try {
        allowedTypes = typeof project.file_types_allowed === 'string' 
          ? JSON.parse(project.file_types_allowed) 
          : project.file_types_allowed;
      } catch {
        allowedTypes = [];
      }
    }

    if (allowedTypes.length > 0) {
      const invalidFiles = [];
      files.forEach(file => {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const isValid = allowedTypes.some(type => {
          const allowedExt = type.toLowerCase().replace('.', '');
          return fileExt === allowedExt;
        });
        if (!isValid) {
          invalidFiles.push(file.name);
        }
      });

      if (invalidFiles.length > 0) {
        const errorMsg = `Allowed file types: ${allowedTypes.join(', ')}`;
        setFileTypeError(errorMsg);
        setInvalidFilesList(invalidFiles);
        setShowFileTypeErrorModal(true);
        return;
      }
    }

    setSubmitting(true);
    await onSubmit(files, submissionText);
    setSubmitting(false);
    setFiles([]);
    setSubmissionText('');
  };

  // Determine submission status (using variables already defined at top of component)
  const getSubmissionStatus = () => {
    if (!hasSubmission) {
      return { status: 'Not Submitted', color: '#DC2626', bgColor: '#FEE2E2' };
    }
    
    const statusLower = latestSubmission.status?.toLowerCase() || '';
    
    if (statusLower.includes('late')) {
      return { status: 'Late', color: '#EA580C', bgColor: '#FFEDD5' };
    }
    
    return { status: 'Submitted', color: '#059669', bgColor: '#D1FAE5' };
  };

  const submissionStatus = getSubmissionStatus();

  return (
    <div className="deliverable-details-container">
      {/* Header with Project Title and Status Pill */}
      <div className="deliverable-details-header">
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '16px' }}>
          <h2><strong>Project:</strong> {project.title}</h2>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            padding: '8px 16px',
            backgroundColor: submissionStatus.bgColor,
            border: `1px solid ${submissionStatus.color}`,
            borderRadius: '20px',
            whiteSpace: 'nowrap',
            flexShrink: 0
          }}>
            <span style={{
              width: '8px',
              height: '8px',
              borderRadius: '50%',
              backgroundColor: submissionStatus.color
            }}></span>
            <span style={{
              fontSize: '14px',
              fontWeight: '600',
              color: submissionStatus.color
            }}>
              {submissionStatus.status}
            </span>
          </div>
        </div>
      </div>

      {/* Content Area - Left (Upload Box with Files Inside) and Right (Description + Pills) */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: '0.9fr 1.3fr',
        gap: '10px',
        padding: '0 24px',
        marginBottom: '24px'
      }}>
        {/* Left Side - Unified Upload Box */}
        <div>
          <div className="phase-upload-box" style={{
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            minHeight: files.length > 0 ? '200px' : 'auto'
          }}>
            <input
              type="file"
              multiple
              accept={getFileAcceptAttribute()}
              onChange={handleFileChange}
              id="project-file-input"
              style={{ display: 'none' }}
            />
            
            {/* Upload Label - Hidden when files are selected */}
            {files.length === 0 && (
              <label htmlFor="project-file-input" style={{ cursor: 'pointer', flexShrink: 0, textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                <div style={{ 
                  fontSize: '36px',
                  marginBottom: '8px',
                  color: '#34656D'
                }}>
                  <FaCloudUploadAlt />
                </div>
                <div style={{ 
                  fontWeight: '600', 
                  color: '#333', 
                  marginBottom: '4px', 
                  fontSize: '16px' 
                }}>
                  Click to upload files
                </div>
                <div style={{ 
                  color: '#6B7280', 
                  fontSize: '13px',
                  marginBottom: '12px'
                }}>
                  You can drag files here or click to choose
                </div>
              </label>
            )}

            {/* File List - Shows 2 files normally, scrollable if more - ONLY when no submission */}
            {!hasSubmission && files.length > 0 && (
              <>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  maxHeight: '120px',
                  overflowY: 'auto',
                  marginBottom: '12px',
                  flex: 1,
                  minHeight: '60px'
                }}>
                  {files.map((file, idx) => (
                    <div key={idx} style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '12px 15px',
                      backgroundColor: '#fafafa',
                      border: '1px solid #e6e6e6',
                      borderRadius: '20px',
                      transition: 'all 0.15s ease',
                      height: '46px'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f5f5f5';
                      e.currentTarget.style.borderColor = '#dcdcdc';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#fafafa';
                      e.currentTarget.style.borderColor = '#e6e6e6';
                    }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        flex: 1,
                        minWidth: 0
                      }}>
                        <span style={{ fontSize: '12px', flexShrink: 0, color: '#4b5563' }}>‚Ä¢</span>
                        <div style={{ minWidth: 0, flex: 1 }}>
                          <div style={{
                            fontSize: '12px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            {file.name}
                          </div>
                          <div style={{
                            fontSize: '10px',
                            color: '#999',
                            marginTop: '1px'
                          }}>
                            {(file.size / 1024).toFixed(2)} KB
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          setFiles((prev) => prev.filter((_, i) => i !== idx));
                        }}
                        aria-label={`Remove ${file.name}`}
                        style={{
                          padding: '2px 6px',
                          backgroundColor: 'transparent',
                          color: '#999',
                          border: 'none',
                          borderRadius: '4px',
                          fontSize: '18px',
                          cursor: 'pointer',
                          flexShrink: 0,
                          lineHeight: '1',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                </div>

                {/* File Summary */}
                <div style={{
                  paddingTop: '8px',
                  borderTop: '1px solid #E5E7EB',
                  marginBottom: '12px',
                  fontSize: '11px',
                  color: '#999',
                  fontWeight: '500'
                }}>
                  {files.length} file(s) ‚Ä¢ {(files.reduce((sum, f) => sum + f.size, 0) / 1024).toFixed(2)} KB
                </div>

                {/* Buttons - Only appear after files are selected */}
                <div style={{ 
                  display: 'flex', 
                  gap: '12px',
                  flexDirection: 'row',
                  marginTop: 'auto',
                  width: '100%'
                }}>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      const input = document.getElementById('project-file-input');
                      if (input) input.click();
                    }}
                    style={{
                      padding: '12px 16px',
                      backgroundColor: '#f0f0f0',
                      border: '1px solid #d0d0d0',
                      borderRadius: '20px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: '500',
                      flex: 1,
                      minWidth: '0'
                    }}
                  >
                    Add more files
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      setFiles([]);
                    }}
                    style={{
                      padding: '12px 16px',
                      backgroundColor: '#fff',
                      border: '1px solid #e0e0e0',
                      borderRadius: '20px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: '500',
                      flex: 1,
                      minWidth: '0'
                    }}
                  >
                    Clear
                  </button>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Right Side - Description Only */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', fontSize: '14.08px' }}>
          {/* Description */}
          <div>
            <div style={{ fontWeight: '600', color: '#6B7280', marginBottom: '8px', fontSize: '14.08px' }}>
              Description
            </div>
            <div style={{
              backgroundColor: '#F0F9FF',
              border: '1px solid #BFDBFE',
              borderRadius: '12px',
              padding: '16px',
              boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
              minHeight: '120px',
              display: 'flex',
              alignItems: 'flex-start',
              fontSize: '14.08px'
            }}>
              <p className="deliverable-description" style={{ margin: 0 }}>
                {project.description || '[Project description placeholder]'}
              </p>
            </div>
            {/* View Rubric and Evaluation Form Buttons */}
            <div style={{
              display: 'flex',
              gap: '12px',
              marginTop: '12px'
            }}>
              {/* View Rubric Button */}
              <button
                onClick={() => {
                  console.log('View rubric clicked for project:', project.id);
                  fetchProjectRubric(project.id);
                  setShowProjectRubricModal(true);
                }}
                style={{
                  flex: 1,
                  padding: '10px 16px',
                  backgroundColor: '#34656D',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14.08px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#2c545b';
                  e.target.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.3)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#34656D';
                  e.target.style.boxShadow = 'none';
                }}
              >
                View Rubric
              </button>
              {/* View Evaluation Form Button */}
              <button
                onClick={() => {
                  console.log('View evaluation form clicked for project:', project.id);
                  fetchProjectEvaluation(project.id);
                  setShowProjectEvaluationModal(true);
                }}
                style={{
                  flex: 1,
                  padding: '10px 16px',
                  backgroundColor: '#34656D',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14.08px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#2c545b';
                  e.target.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.3)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#34656D';
                  e.target.style.boxShadow = 'none';
                }}
              >
                View Evaluation Form
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Project Details Pills Section */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
        gap: '16px',
        padding: '0 24px',
        marginBottom: '24px'
      }}>
        {/* Status Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '14px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.8rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Status
          </label>
          <div style={{
            color: project.is_active ? '#059669' : '#DC2626',
            fontWeight: '600',
            padding: '7px 12px',
            backgroundColor: project.is_active ? '#D1FAE5' : '#FEE2E2',
            borderRadius: '5px',
            fontSize: '0.91rem',
            textAlign: 'center'
          }}>
            {project.is_active ? 'Active' : 'Inactive'}
          </div>
        </div>

        {/* Due Date Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '14px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.8rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Due Date
          </label>
          <div style={{
            backgroundColor: '#F9FAFB',
            padding: '7px 10px',
            borderRadius: '5px',
            color: '#495057',
            fontWeight: '500',
            fontSize: '0.91rem',
            textAlign: 'center'
          }}>
            {project.due_date ? new Date(project.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '[Due date not set]'}
          </div>
        </div>

        {/* Max File Size Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '14px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.8rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            Max File Size
          </label>
          <div style={{
            backgroundColor: '#F9FAFB',
            padding: '7px 10px',
            borderRadius: '5px',
            color: '#495057',
            fontWeight: '600',
            fontSize: '0.91rem',
            textAlign: 'center'
          }}>
            {project.max_file_size_mb ? `${project.max_file_size_mb} MB` : '[No limit]'}
          </div>
        </div>

        {/* File Types Container */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          padding: '14px',
          background: 'white',
          border: '1px solid #e5e7eb',
          borderRadius: '8px'
        }}>
          <label style={{ 
            fontSize: '0.8rem', 
            fontWeight: '600', 
            color: '#6b7280',
            textTransform: 'uppercase',
            letterSpacing: '0.05em'
          }}>
            File Types
          </label>
          <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', justifyContent: 'center' }}>
            {(() => {
              try {
                let fileTypes = project.file_types_allowed;
                if (typeof fileTypes === 'string') {
                  fileTypes = JSON.parse(fileTypes);
                }
                
                if (Array.isArray(fileTypes) && fileTypes.length > 0) {
                  return fileTypes.map((fileType, idx) => (
                    <span key={idx} style={{
                      backgroundColor: '#DBEAFE',
                      color: '#1E40AF',
                      padding: '4px 9px',
                      borderRadius: '4px',
                      fontSize: '0.8rem',
                      fontWeight: '600'
                    }}>
                      {fileType.toUpperCase()}
                    </span>
                  ));
                } else {
                  return <span style={{ color: '#9CA3AF', fontSize: '0.8rem', fontStyle: 'italic' }}>
                    Any file types
                  </span>;
                }
              } catch (e) {
                console.error('Error parsing file types:', e);
                return <span style={{ color: '#9CA3AF', fontSize: '0.8rem', fontStyle: 'italic' }}>
                  Any file types
                </span>;
              }
            })()}
          </div>
        </div>

        {/* Min Tasks Per Member Container */}
        {project && project.min_tasks_per_member && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '14px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.8rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Min Tasks Per Member
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '7px 10px',
              borderRadius: '5px',
              color: '#495057',
              fontWeight: '600',
              fontSize: '0.91rem',
              textAlign: 'center'
            }}>
              {project.min_tasks_per_member}
            </div>
          </div>
        )}

        {/* Max Tasks Per Member Container */}
        {project && project.max_tasks_per_member && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '14px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.8rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Max Tasks Per Member
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '7px 10px',
              borderRadius: '5px',
              color: '#495057',
              fontWeight: '600',
              fontSize: '0.91rem',
              textAlign: 'center'
            }}>
              {project.max_tasks_per_member}
            </div>
          </div>
        )}

        {/* Breathe Phase Days Container */}
        {project && project.breathe_phase_days !== null && project.breathe_phase_days !== undefined && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '8px',
            padding: '14px',
            background: 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px'
          }}>
            <label style={{ 
              fontSize: '0.8rem', 
              fontWeight: '600', 
              color: '#6b7280',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              Breathe Phase Days
            </label>
            <div style={{
              backgroundColor: '#F9FAFB',
              padding: '7px 10px',
              borderRadius: '5px',
              color: '#495057',
              fontWeight: '600',
              fontSize: '0.91rem',
              textAlign: 'center'
            }}>
              {project.breathe_phase_days} day{project.breathe_phase_days !== 1 ? 's' : ''}
            </div>
          </div>
        )}
      </div>

      {/* Member Submissions Section */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#ffffff', marginBottom: '24px' }}>
          Member Submissions
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <>
            <div style={{
              display: 'flex',
              gap: '24px',
              alignItems: 'flex-start',
              justifyContent: 'space-between'
            }}>
              {/* Cards Container */}
              <div style={{
                display: 'flex',
                gap: '24px',
                flexWrap: 'wrap',
                flex: 1,
                maxWidth: 'calc(100% - 50px)'
              }}>
                {groupData.members
                  .slice(memberPage * 3, (memberPage * 3) + 3)
                  .map((member, index) => {
                    const isLeader = groupData.members.indexOf(member) === 0;
                    const memberName = member.full_name || member.user_name || member.name || 'Unknown';
                    const memberInitial = memberName.charAt(0).toUpperCase();
                    const memberId = member.student_id || member.id;
                    const isExpanded = expandedCards[memberId];
                    const memberTaskList = memberTasks[memberId] || [];
                    const visibleTasksCount = 1;
                    const hasMoreTasks = memberTaskList.length > visibleTasksCount;
              
              return (
                <div
                  key={memberId}
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '14px',
                    padding: '24px',
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '12px',
                    width: '280px',
                    minWidth: '280px',
                    maxWidth: '280px',
                    textAlign: 'center',
                    boxShadow: isLeader ? '0 4px 12px rgba(52, 101, 109, 0.15)' : '0 1px 3px rgba(0, 0, 0, 0.1)',
                    transition: 'box-shadow 0.3s ease',
                    maxHeight: isExpanded ? '600px' : 'auto',
                    overflow: 'hidden',
                    position: 'relative'
                  }}
                >
                  {/* Tasks Counter Pill - Top Right */}
                  {!loadingTasks && (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '8px 14px',
                      backgroundColor: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '#D1FAE5' // Green when at or above max
                          : memberTaskList.length >= minTasksPerMember 
                          ? '#FEF3C7' // Orange when between min and max
                          : '#FEE2E2', // Red when below minimum
                      border: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '1px solid #6EE7B7' // Green border
                          : memberTaskList.length >= minTasksPerMember 
                          ? '1px solid #FCD34D' // Orange border
                          : '1px solid #FECACA', // Red border
                      borderRadius: '20px',
                      fontSize: '12px',
                      fontWeight: '700',
                      color: 
                        memberTaskList.length >= maxTasksPerMember 
                          ? '#047857' // Green text
                          : memberTaskList.length >= minTasksPerMember 
                          ? '#B45309' // Orange text
                          : '#DC2626' // Red text
                    }}>
                      <FaTasks size={13} />
                      <span>{memberTaskList.length}/{maxTasksPerMember}</span>
                    </div>
                  )}
                  {/* Profile Picture */}
                  <div style={{
                    width: '100px',
                    height: '100px',
                    borderRadius: '8px',
                    backgroundColor: '#34656D',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '40px',
                    fontWeight: '600',
                    overflow: 'hidden',
                    position: 'relative'
                  }}>
                    {member.profile_image_url && member.profile_image_url.trim() ? (
                      <img
                        src={member.profile_image_url.startsWith('http') 
                          ? member.profile_image_url 
                          : `${API_BASE_URL}${member.profile_image_url}`}
                        alt={memberName}
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                        onError={(e) => {
                          e.target.style.display = 'none';
                        }}
                      />
                    ) : null}
                    {!member.profile_image_url || !member.profile_image_url.trim() ? (
                      <span>{memberInitial}</span>
                    ) : null}
                  </div>

                  {/* Position */}
                  <div style={{
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#6b7280',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>
                    {isLeader ? 'Leader' : 'Member'}
                  </div>

                  {/* Name */}
                  <div style={{
                    fontSize: '15px',
                    fontWeight: '700',
                    color: '#2c3e50',
                    maxWidth: '220px',
                    lineHeight: '1.2',
                    whiteSpace: 'nowrap',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis'
                  }}>
                    {memberName}
                  </div>

                  {/* Tasks List */}
                  <div style={{
                    width: '100%',
                    borderTop: '1px solid #e5e7eb',
                    paddingTop: '12px',
                    marginTop: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      fontWeight: '700',
                      color: '#2c3e50',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      marginBottom: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px'
                    }}>
                      <FaTasks size={12} />
                      Assigned Tasks ({memberTaskList.length})
                    </div>
                    {loadingTasks ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        Loading...
                      </div>
                    ) : (
                      <>
                        {projectPhases.length > 0 ? (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                            {projectPhases.map(phase => {
                              const phaseNum = phase.phase_number || 'unknown';
                              const phaseKey = `${memberId}-${phaseNum}`;
                              const isPhaseExpanded = expandedPhaseDropdowns[phaseKey] || false;
                              
                              // Get tasks for this phase
                              const phaseTasks = memberTaskList.filter(task => 
                                (task.phase_number || 'unknown') === phaseNum
                              );

                              return (
                                <div key={phaseNum} style={{ border: '1px solid #D1D5DB', borderRadius: '8px', overflow: 'hidden', backgroundColor: '#FFFFFF' }}>
                                  {/* Phase Dropdown Header */}
                                  <button
                                    onClick={() => togglePhaseDropdown(memberId, phaseNum)}
                                    style={{
                                      width: '100%', padding: '10px 12px',
                                      backgroundColor: isPhaseExpanded ? '#E0F2FE' : '#F9FAFB',
                                      color: '#2c3e50', border: 'none',
                                        borderBottom: isPhaseExpanded ? '1px solid #BFDBFE' : 'none',
                                        fontSize: '12px', fontWeight: '600', cursor: 'pointer',
                                        transition: 'all 0.2s ease', display: 'flex',
                                        alignItems: 'center', justifyContent: 'space-between', gap: '8px'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.backgroundColor = isPhaseExpanded ? '#0EA5E9' : '#E5E7EB';
                                        e.currentTarget.style.color = isPhaseExpanded ? 'white' : '#2c3e50';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.backgroundColor = isPhaseExpanded ? '#E0F2FE' : '#F9FAFB';
                                        e.currentTarget.style.color = '#2c3e50';
                                      }}
                                    >
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                        <span style={{ fontSize: '14px' }}>{isPhaseExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                        <span>Phase {phaseNum}</span>
                                        {phase.title && (
                                          <span style={{ fontSize: '11px', color: '#6B7280', fontWeight: '500' }}>
                                            ({phase.title})
                                          </span>
                                        )}
                                        <span style={{ backgroundColor: '#BFDBFE', color: '#1E40AF', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', fontWeight: '600', marginLeft: 'auto' }}>
                                          {phaseTasks.length}
                                        </span>
                                      </div>
                                    </button>

                                    {/* Phase Tasks */}
                                    {isPhaseExpanded && (
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', padding: '10px 12px', maxHeight: '300px', overflowY: 'auto' }}>
                                        {phaseTasks.length > 0 ? (
                                          phaseTasks.map((task, taskIdx) => (
                                            <div 
                                              key={taskIdx} 
                                              onClick={() => handleTaskClick(task)}
                                              style={{ backgroundColor: '#F0FAFB', border: '1px solid #BFDBFE', borderRadius: '6px', padding: '10px 12px', fontSize: '12px', color: '#2c3e50', textAlign: 'left', lineHeight: '1.4', cursor: 'pointer', transition: 'all 0.2s ease', position: 'relative', paddingRight: '85px' }} 
                                              title={task.description || task.title}
                                              onMouseEnter={(e) => {
                                                e.currentTarget.style.backgroundColor = '#E0F2FE';
                                                e.currentTarget.style.transform = 'translateY(-2px)';
                                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                                              }}
                                              onMouseLeave={(e) => {
                                                e.currentTarget.style.backgroundColor = '#F0FAFB';
                                                e.currentTarget.style.transform = 'translateY(0)';
                                                e.currentTarget.style.boxShadow = 'none';
                                              }}
                                            >
                                              {/* Task Status */}
                                              {task.status && (
                                                <div style={{
                                                  position: 'absolute', top: '6px', right: '8px', fontSize: '10px', fontWeight: '600',
                                                  color: task.status === 'completed' ? '#059669' : task.status === 'pending' ? '#DC2626' : task.status === 'to_revise' ? '#EA580C' : '#6B7280',
                                                  backgroundColor: task.status === 'completed' ? '#D1FAE5' : task.status === 'pending' ? '#FEE2E2' : task.status === 'to_revise' ? '#FFEDD5' : '#F3F4F6',
                                                  padding: '3px 6px', borderRadius: '4px', display: 'inline-flex', alignItems: 'center', gap: '3px', whiteSpace: 'nowrap'
                                                }}>
                                                  {task.status === 'completed' ? <><FaCheck size={9} />Completed</> : task.status === 'pending' ? <><FaClock size={9} />Pending</> : task.status === 'to_revise' ? <><FaExclamationTriangle size={9} />Revision</> : <><FaFileAlt size={9} />{task.status.replace(/_/g, ' ')}</>}
                                                </div>
                                              )}
                                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '13px', paddingRight: '0' }}>
                                                {task.title?.length > 25 ? task.title.substring(0, 25) + '...' : task.title}
                                              </div>
                                              {task.due_date && (
                                                <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '3px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                  <FaCalendarAlt size={10} />
                                                  {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                </div>
                                              )}
                                            </div>
                                          ))
                                        ) : (
                                          <div style={{ fontSize: '12px', color: '#9CA3AF', fontStyle: 'italic', padding: '12px 8px', textAlign: 'center' }}>
                                            No tasks assigned
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                );
                            })}
                          </div>
                        ) : (
                          <div style={{ fontSize: '12px', color: '#9CA3AF', fontStyle: 'italic', padding: '12px 8px', textAlign: 'center' }}>
                            No phases available
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
                  })
                }
              </div>

              {/* Pagination Arrow */}
              {groupData.members.length > 3 && (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px',
                  justifyContent: 'center'
                }}>
                  {/* Previous Button */}
                  <button
                    onClick={() => setMemberPage(prev => Math.max(0, prev - 1))}
                    disabled={memberPage === 0}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: memberPage === 0 ? '#F3F4F6' : 'white',
                      color: memberPage === 0 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: memberPage === 0 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (memberPage > 0) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = memberPage === 0 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &lt;
                  </button>

                  {/* Page Indicator */}
                  <div style={{
                    textAlign: 'center',
                    fontSize: '11px',
                    fontWeight: '600',
                    color: '#6B7280',
                    minWidth: '44px'
                  }}>
                    {memberPage + 1}/{Math.ceil(groupData.members.length / 3)}
                  </div>

                  {/* Next Button */}
                  <button
                    onClick={() => setMemberPage(prev => prev + 1)}
                    disabled={memberPage >= Math.ceil(groupData.members.length / 3) - 1}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white',
                      color: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (memberPage < Math.ceil(groupData.members.length / 3) - 1) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = memberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &gt;
                  </button>
                </div>
              )}
            </div>
          </>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '20px'
          }}>
            No members available
          </div>
        )}
      </div>

      {/* Group Submissions Section - Phase Deliverables */}
      <div style={{ padding: '24px', borderTop: '1px solid #E5E7EB' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#ffffff', marginBottom: '24px' }}>
          Group Submissions
        </h3>
        {loadingPhaseSubmissions ? (
          <div style={{ textAlign: 'center', padding: '40px', color: '#9CA3AF' }}>
            Loading phase submissions...
          </div>
        ) : projectPhases && projectPhases.length > 0 ? (
          <div style={{
            overflowX: 'auto',
            paddingBottom: '10px'
          }}>
            <div style={{
              display: 'flex',
              gap: '20px',
              minWidth: 'fit-content'
            }}>
              {projectPhases.map((phase) => {
                const submission = phaseSubmissions[phase.id];
                const hasSubmission = submission && submission.files && submission.files.length > 0;
                const memberInclusions = submission?.member_inclusions || [];
                
                // Helper function to format date safely
                const formatDate = (dateString) => {
                  if (!dateString) return 'Not set';
                  try {
                    // Handle both ISO string and plain date string
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'Not set';
                    return date.toLocaleDateString('en-US', {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      timeZone: 'UTC'
                    });
                  } catch (error) {
                    return 'Not set';
                  }
                };
                
                return (
                  <div
                    key={phase.id}
                    style={{
                      backgroundColor: 'white',
                      border: '1px solid #E5E7EB',
                      borderRadius: '12px',
                      padding: '20px',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                      transition: 'box-shadow 0.3s ease',
                      cursor: 'pointer',
                      minWidth: '640px',
                      maxWidth: '640px'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(52, 101, 109, 0.15)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    }}
                  >
                    {/* Main Card Layout - Two Columns */}
                    <div style={{ display: 'flex', gap: '16px' }}>
                      {/* Left Column - Submission Info */}
                      <div style={{ flex: 1 }}>
                        {/* Phase Header */}
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px',
                          marginBottom: '16px',
                          paddingBottom: '12px',
                          borderBottom: '1px solid #F3F4F6'
                        }}>
                          <div style={{
                            backgroundColor: '#34656D',
                            color: 'white',
                            width: '40px',
                            height: '40px',
                            borderRadius: '8px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '18px',
                            fontWeight: '700'
                          }}>
                            {phase.phase_number}
                          </div>
                          <div style={{ flex: 1 }}>
                            <h4 style={{
                              margin: 0,
                              fontSize: '16px',
                              fontWeight: '600',
                              color: '#2c3e50',
                              marginBottom: '4px'
                            }}>
                              {phase.title}
                            </h4>
                            <div style={{
                              fontSize: '12px',
                              color: '#6B7280'
                            }}>
                              Phase {phase.phase_number}
                            </div>
                          </div>
                        </div>

                        {/* Dates */}
                        <div style={{
                          display: 'flex',
                          gap: '16px',
                          marginBottom: '16px'
                        }}>
                          <div style={{ flex: 1 }}>
                            <div style={{
                              fontSize: '11px',
                              fontWeight: '600',
                              color: '#6B7280',
                              textTransform: 'uppercase',
                              letterSpacing: '0.05em',
                              marginBottom: '4px'
                            }}>
                              Start Date
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: '#2c3e50',
                              fontWeight: '500'
                            }}>
                              {formatDate(phase.start_date)}
                            </div>
                          </div>
                          <div style={{ flex: 1 }}>
                            <div style={{
                              fontSize: '11px',
                              fontWeight: '600',
                              color: '#6B7280',
                              textTransform: 'uppercase',
                              letterSpacing: '0.05em',
                              marginBottom: '4px'
                            }}>
                              Due Date
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: '#2c3e50',
                              fontWeight: '500'
                            }}>
                              {formatDate(phase.end_date)}
                            </div>
                          </div>
                        </div>

                        {/* Submission Status */}
                        <div style={{
                          marginTop: '16px',
                          paddingTop: '16px',
                          borderTop: '1px solid #F3F4F6'
                        }}>
                    {hasSubmission ? (
                      <div>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginBottom: '12px'
                        }}>
                          <FaCheckCircle size={16} color="#059669" />
                          <span style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#059669'
                          }}>
                            Submitted
                          </span>
                        </div>
                        <div style={{
                          backgroundColor: '#F0FAFB',
                          border: '1px solid #BFDBFE',
                          borderRadius: '8px',
                          padding: '12px'
                        }}>
                          <div style={{
                            fontSize: '11px',
                            fontWeight: '600',
                            color: '#6B7280',
                            textTransform: 'uppercase',
                            letterSpacing: '0.05em',
                            marginBottom: '8px'
                          }}>
                            Uploaded Files
                          </div>
                          {submission.files.map((file, idx) => (
                            <div
                              key={idx}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '8px',
                                backgroundColor: 'white',
                                borderRadius: '6px',
                                marginBottom: idx < submission.files.length - 1 ? '6px' : '0'
                              }}
                            >
                              <FaFileAlt size={14} color="#34656D" />
                              <span style={{
                                fontSize: '12px',
                                color: '#2c3e50',
                                flex: 1,
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                whiteSpace: 'nowrap'
                              }}>
                                {file.name}
                              </span>
                              <button
                                onClick={() => handleFileDownload(file.url, file.name)}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  padding: '6px 10px',
                                  backgroundColor: '#34656D',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '4px',
                                  fontSize: '11px',
                                  fontWeight: '600',
                                  transition: 'background-color 0.2s ease',
                                  cursor: 'pointer'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#2c545b';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#34656D';
                                }}
                              >
                                <FaDownload size={12} style={{ marginRight: '4px' }} />
                                Download
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        padding: '12px',
                        backgroundColor: '#FEE2E2',
                        border: '1px solid #FCA5A5',
                        borderRadius: '8px'
                      }}>
                        <FaTimes size={16} color="#DC2626" />
                        <span style={{
                          fontSize: '13px',
                          fontWeight: '600',
                          color: '#DC2626'
                        }}>
                          No Submission
                          </span>
                        </div>
                      )}
                        </div>
                      </div>

                      {/* Right Column - Member Inclusions */}
                      <div style={{
                        width: '240px',
                        borderLeft: '1px solid #F3F4F6',
                        paddingLeft: '16px'
                      }}>
                        <div style={{
                          fontSize: '11px',
                          fontWeight: '700',
                          color: '#6B7280',
                          textTransform: 'uppercase',
                          letterSpacing: '0.05em',
                          marginBottom: '12px'
                        }}>
                          Phase Inclusion
                        </div>
                        {memberInclusions.length > 0 ? (
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '10px',
                            maxHeight: '400px',
                            overflowY: 'auto',
                            paddingRight: '8px',
                            scrollbarWidth: 'thin',
                            scrollbarColor: '#CBD5E0 #F7FAFC'
                          }}>
                            {memberInclusions.map((member, idx) => {
                              const reasonKey = `${phase.id}-${idx}`;
                              const isExpanded = expandedExclusionReasons[reasonKey];
                              const reason = member.exclusion_reason || '';
                              const maxLength = 80;
                              const needsTruncation = reason.length > maxLength;
                              
                              return (
                                <div
                                  key={idx}
                                  style={{
                                    padding: '10px',
                                    backgroundColor: member.included ? '#F0FDF4' : '#FEF2F2',
                                    border: `1px solid ${member.included ? '#BBF7D0' : '#FECACA'}`,
                                    borderRadius: '6px'
                                  }}
                                >
                                  <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    marginBottom: '6px'
                                  }}>
                                    {member.included ? (
                                      <FaCheckCircle size={12} color="#16A34A" />
                                    ) : (
                                      <FaTimes size={12} color="#DC2626" />
                                    )}
                                    <span style={{
                                      fontSize: '11px',
                                      fontWeight: '700',
                                      color: member.included ? '#16A34A' : '#DC2626',
                                      textTransform: 'uppercase',
                                      letterSpacing: '0.05em'
                                    }}>
                                      {member.included ? 'Included' : 'Excluded'}
                                    </span>
                                  </div>
                                  <div style={{
                                    fontSize: '13px',
                                    color: '#2c3e50',
                                    fontWeight: '600',
                                    marginBottom: '4px',
                                    wordBreak: 'break-word',
                                    lineHeight: '1.3'
                                  }}>
                                    {member.member_name}
                                  </div>
                                  <div style={{
                                    fontSize: '11px',
                                    color: '#6B7280',
                                    textTransform: 'capitalize',
                                    fontWeight: '500',
                                    marginBottom: !member.included && member.exclusion_reason ? '8px' : '0'
                                  }}>
                                    {member.role}
                                  </div>
                                  {!member.included && member.exclusion_reason && (
                                    <div style={{
                                      marginTop: '8px',
                                      padding: '8px',
                                      backgroundColor: 'white',
                                      borderRadius: '4px',
                                      fontSize: '11px',
                                      color: '#6B7280',
                                      fontStyle: 'italic',
                                      wordBreak: 'break-word',
                                      lineHeight: '1.4'
                                    }}>
                                      "{isExpanded || !needsTruncation ? reason : `${reason.substring(0, maxLength)}...`}"
                                      {needsTruncation && (
                                        <button
                                          onClick={() => setExpandedExclusionReasons(prev => ({
                                            ...prev,
                                            [reasonKey]: !prev[reasonKey]
                                          }))}
                                          style={{
                                            display: 'block',
                                            marginTop: '6px',
                                            padding: '4px 8px',
                                            backgroundColor: '#F3F4F6',
                                            border: 'none',
                                            borderRadius: '3px',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            color: '#4B5563',
                                            cursor: 'pointer',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.05em',
                                            transition: 'background-color 0.2s'
                                          }}
                                          onMouseEnter={(e) => {
                                            e.currentTarget.style.backgroundColor = '#E5E7EB';
                                          }}
                                          onMouseLeave={(e) => {
                                            e.currentTarget.style.backgroundColor = '#F3F4F6';
                                          }}
                                        >
                                          {isExpanded ? '‚àí Show Less' : '+ View More'}
                                        </button>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        ) : (
                          <div style={{
                            fontSize: '11px',
                            color: '#9CA3AF',
                            fontStyle: 'italic',
                            textAlign: 'center',
                            padding: '20px 0'
                          }}>
                            No submission yet
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ) : (
          <div style={{
            textAlign: 'center',
            padding: '40px',
            color: '#9CA3AF',
            fontSize: '14px'
          }}>
            No phases available for this project
          </div>
        )}
      </div>

      {/* Evaluation Submissions Section - Project Evaluations */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: '#ffffff', marginBottom: '24px' }}>
          Project Evaluation Submissions
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <>
            <div style={{
              display: 'flex',
              gap: '24px',
              alignItems: 'flex-start',
              justifyContent: 'space-between'
            }}>
              {/* Cards Container */}
              <div style={{
                display: 'flex',
                gap: '24px',
                flexWrap: 'wrap',
                flex: 1,
                maxWidth: 'calc(100% - 50px)'
              }}>
                {groupData.members
                  .slice(evalMemberPage * 3, (evalMemberPage * 3) + 3)
                  .map((member, index) => {
                    const isLeader = groupData.members.indexOf(member) === 0;
                    const memberName = member.full_name || member.user_name || member.name || 'Unknown';
                    const memberInitial = memberName.charAt(0).toUpperCase();
                    const memberId = member.student_id || member.id;
                    const isExpanded = expandedEvalCards[memberId];
                    const memberEvalList = memberEvaluations[memberId] || [];
                    const visibleEvalsCount = 1;
                    const hasMoreEvals = memberEvalList.length > visibleEvalsCount;
              
              return (
                <div
                  key={`eval-${memberId}`}
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '14px',
                    padding: '24px',
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '12px',
                    width: '280px',
                    minWidth: '280px',
                    maxWidth: '280px',
                    textAlign: 'center',
                    boxShadow: isLeader ? '0 4px 12px rgba(52, 101, 109, 0.15)' : '0 1px 3px rgba(0, 0, 0, 0.1)',
                    transition: 'box-shadow 0.3s ease',
                    maxHeight: isExpanded ? '600px' : 'auto',
                    overflow: 'hidden',
                    position: 'relative'
                  }}
                >
                  {/* Evaluation Status Pill - Top Right */}
                  {loadingEvaluations ? (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px',
                      padding: '8px 12px',
                      backgroundColor: '#F3F4F6',
                      border: '1px solid #D1D5DB',
                      borderRadius: '20px',
                      animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }}>
                      <div style={{
                        width: '16px',
                        height: '16px',
                        backgroundColor: '#D1D5DB',
                        borderRadius: '50%'
                      }} />
                    </div>
                  ) : (
                    <div style={{
                      position: 'absolute',
                      top: '12px',
                      right: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px',
                      padding: '8px 12px',
                      backgroundColor: memberEvalList.length > 0 ? '#D1FADF' : '#FEE2E2',
                      border: memberEvalList.length > 0 ? '1px solid #6EE7B7' : '1px solid #FECACA',
                      borderRadius: '20px',
                      fontSize: '12px',
                      fontWeight: '700',
                      color: memberEvalList.length > 0 ? '#047857' : '#DC2626'
                    }}>
                      {memberEvalList.length > 0 ? (
                        <FaCheck size={16} />
                      ) : (
                        <FaTimes size={16} />
                      )}
                    </div>
                  )}
                  
                  {/* Profile Picture */}
                  <div style={{
                    width: '100px',
                    height: '100px',
                    borderRadius: '8px',
                    backgroundColor: '#34656D',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '40px',
                    fontWeight: '600',
                    overflow: 'hidden',
                    position: 'relative'
                  }}>
                    {member.profile_image_url && member.profile_image_url.trim() ? (
                      <img
                        src={member.profile_image_url.startsWith('http') 
                          ? member.profile_image_url 
                          : `${API_BASE_URL}${member.profile_image_url}`}
                        alt={memberName}
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                        onError={(e) => {
                          e.target.style.display = 'none';
                        }}
                      />
                    ) : null}
                    {!member.profile_image_url || !member.profile_image_url.trim() ? (
                      <span>{memberInitial}</span>
                    ) : null}
                  </div>

                  {/* Position */}
                  <div style={{
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#6b7280',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>
                    {isLeader ? 'Leader' : 'Member'}
                  </div>

                  {/* Name */}
                  <div style={{
                    fontSize: '15px',
                    fontWeight: '700',
                    color: '#2c3e50',
                    maxWidth: '220px',
                    lineHeight: '1.2',
                    whiteSpace: 'nowrap',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis'
                  }}>
                    {memberName}
                  </div>

                  {/* Evaluations List */}
                  <div style={{
                    width: '100%',
                    borderTop: '1px solid #e5e7eb',
                    paddingTop: '12px',
                    marginTop: '8px'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      fontWeight: '700',
                      color: '#2c3e50',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      marginBottom: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px'
                    }}>
                      <FaTasks size={12} />
                      Project Evaluation ({memberEvalList.length})
                    </div>
                    {loadingEvaluations ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        Loading...
                      </div>
                    ) : memberEvalList.length === 0 ? (
                      <div style={{
                        fontSize: '12px',
                        color: '#9CA3AF',
                        fontStyle: 'italic'
                      }}>
                        No project evaluations submitted
                      </div>
                    ) : (
                      <>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '8px'
                        }}>
                          {memberEvalList.slice(0, isExpanded ? memberEvalList.length : visibleEvalsCount).map((evaluation, idx) => (
                            <div
                              key={`eval-${idx}`}
                              style={{
                                backgroundColor: '#F0FAFB',
                                border: '1px solid #BFDBFE',
                                borderRadius: '8px',
                                padding: '10px 12px',
                                fontSize: '11px',
                                color: '#4B5563',
                                lineHeight: '1.4',
                                position: 'relative',
                                
                              }}
                            >
                              <div style={{ 
                                fontWeight: '600', 
                                marginBottom: '6px', 
                                color: '#2c3e50',
                                fontSize: '12px'
                              }}>
                                {evaluation.evaluator_name || 'Project Evaluation'}
                              </div>
                              <div style={{ 
                                fontSize: '10px', 
                                color: '#6B7280', 
                                marginBottom: '4px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                              }}>
                                <span style={{
                                  backgroundColor: evaluation.status === 'submitted' ? '#D1FAE5' : '#FEF3C7',
                                  color: evaluation.status === 'submitted' ? '#047857' : '#92400E',
                                  padding: '2px 6px',
                                  borderRadius: '4px',
                                  fontSize: '10px',
                                  fontWeight: '600'
                                }}>
                                  {evaluation.status === 'submitted' ? 'Submitted' : evaluation.status}
                                </span>
                                {evaluation.submission_date && (
                                  <span>
                                    {new Date(evaluation.submission_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                  </span>
                                )}
                              </div>
                              {evaluation.is_custom ? (
                                <div style={{ 
                                  fontSize: '10px', 
                                  marginTop: '4px', 
                                  color: '#6366F1',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '4px'
                                }}>
                                  <FaFileAlt size={10} />
                                  Custom Evaluation Form
                                </div>
                              ) : evaluation.has_data ? (
                                <div style={{ 
                                  fontSize: '10px', 
                                  marginTop: '4px', 
                                  color: '#059669',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '4px'
                                }}>
                                  <FaCheckCircle size={10} />
                                  Built-in Evaluation Form
                                </div>
                              ) : null}
                            </div>
                          ))}
                        </div>
                        {hasMoreEvals && (
                          <button
                            onClick={() => toggleEvalCardExpansion(memberId)}
                            style={{
                              width: '100%',
                              marginTop: '10px',
                              padding: '8px 12px',
                              backgroundColor: isExpanded ? '#E5E7EB' : '#34656D',
                              color: isExpanded ? '#2c3e50' : 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#D1D5DB' : '#2c545b';
                              e.target.style.transform = 'translateY(-1px)';
                            }}
                            onMouseLeave={(e) => {
                              e.target.style.backgroundColor = isExpanded ? '#E5E7EB' : '#34656D';
                              e.target.style.transform = 'translateY(0)';
                            }}
                          >
                            {isExpanded 
                              ? `‚ñ≤ Show Less (${memberEvalList.length})` 
                              : `‚ñº View More (+${memberEvalList.length - visibleEvalsCount})`
                            }
                          </button>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
                  })
                }
              </div>

              {/* Pagination Arrow */}
              {groupData.members.length > 3 && (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px',
                  justifyContent: 'center'
                }}>
                  {/* Previous Button */}
                  <button
                    onClick={() => setEvalMemberPage(prev => Math.max(0, prev - 1))}
                    disabled={evalMemberPage === 0}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: evalMemberPage === 0 ? '#F3F4F6' : 'white',
                      color: evalMemberPage === 0 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: evalMemberPage === 0 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (evalMemberPage > 0) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = evalMemberPage === 0 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &lt;
                  </button>

                  {/* Page Indicator */}
                  <div style={{
                    textAlign: 'center',
                    fontSize: '11px',
                    fontWeight: '600',
                    color: '#6B7280',
                    minWidth: '44px'
                  }}>
                    {evalMemberPage + 1}/{Math.ceil(groupData.members.length / 3)}
                  </div>

                  {/* Next Button */}
                  <button
                    onClick={() => setEvalMemberPage(prev => prev + 1)}
                    disabled={evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1}
                    style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      backgroundColor: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white',
                      color: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#D1D5DB' : '#2c3e50',
                      fontSize: '20px',
                      fontWeight: '700',
                      cursor: evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? 'not-allowed' : 'pointer',
                      transition: 'all 0.2s ease',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      if (evalMemberPage < Math.ceil(groupData.members.length / 3) - 1) {
                        e.target.style.backgroundColor = '#E5E7EB';
                        e.target.style.borderColor = '#9CA3AF';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = evalMemberPage >= Math.ceil(groupData.members.length / 3) - 1 ? '#F3F4F6' : 'white';
                      e.target.style.borderColor = '#D1D5DB';
                    }}
                  >
                    &gt;
                  </button>
                </div>
              )}
            </div>
          </>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '24px',
            backgroundColor: '#F9FAFB',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            textAlign: 'center'
          }}>
            {groupData ? 'No group members available' : 'Loading group data...'}
          </div>
        )}
      </div>

      {/* Inclusion Recommendation Section */}
      <div style={{ padding: '24px' }}>
        <h3 style={{ fontSize: '1.1rem', fontWeight: '600', color: 'white', marginBottom: '24px' }}>
          Inclusion Recommendation
        </h3>
        {groupData && groupData.members && groupData.members.length > 0 ? (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '12px'
          }}>
            {groupData.members.map((member) => {
              const memberId = member.student_id || member.id;
              const memberName = member.full_name || member.user_name || member.name || 'Unknown';
              const memberInitial = memberName.charAt(0).toUpperCase();
              const isLeader = groupData.members.indexOf(member) === 0;
              const isIncluded = memberInclusions[memberId] !== false;
              const feedback = inclusionFeedback[memberId] || '';

              return (
                <div key={`inclusion-${memberId}`} style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {/* Member Pill */}
                  <div
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '16px 20px',
                      backgroundColor: 'white',
                      border: '1px solid #e5e7eb',
                      borderRadius: '12px',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                      transition: 'all 0.2s ease',
                      opacity: isIncluded ? 1 : 0.75
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    }}
                  >
                    {/* Left Side - Profile and Info */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                      {/* Profile Picture */}
                      <div
                        style={{
                          width: '48px',
                          height: '48px',
                          borderRadius: '8px',
                          backgroundColor: '#34656D',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontSize: '20px',
                          fontWeight: '600',
                          overflow: 'hidden',
                          flexShrink: 0
                        }}
                      >
                        {member.profile_image_url && member.profile_image_url.trim() ? (
                          <img
                            src={member.profile_image_url.startsWith('http')
                              ? member.profile_image_url
                              : `${API_BASE_URL}${member.profile_image_url}`}
                            alt={memberName}
                            style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                            onError={(e) => {
                              e.target.style.display = 'none';
                            }}
                          />
                        ) : null}
                        {!member.profile_image_url || !member.profile_image_url.trim() ? (
                          <span>{memberInitial}</span>
                        ) : null}
                      </div>

                      {/* Member Details */}
                      <div>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: '#2c3e50'
                        }}>
                          {memberName}
                        </div>
                        <div style={{
                          fontSize: '12px',
                          color: '#6b7280',
                          textTransform: 'uppercase',
                          letterSpacing: '0.05em'
                        }}>
                          {isLeader ? 'Leader' : 'Member'}
                        </div>
                      </div>
                    </div>

                    {/* Right Side - Toggle Buttons */}
                    <div style={{
                      display: 'flex',
                      backgroundColor: '#F3F4F6',
                      borderRadius: '8px',
                      padding: '2px',
                      flexShrink: 0,
                      gap: '2px'
                    }}>
                      {/* Include Button */}
                      <button
                        onClick={() => {
                          if (!hasSubmission) {
                            setMemberInclusions(prev => ({ ...prev, [memberId]: true }));
                            setInclusionFeedback(prev => ({ ...prev, [memberId]: '' }));
                          }
                        }}
                        disabled={hasSubmission}
                        style={{
                          flex: 1,
                          padding: '8px 18px',
                          backgroundColor: isIncluded ? '#10B981' : 'transparent',
                          color: isIncluded ? '#FFFFFF' : '#6B7280',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: hasSubmission ? 'not-allowed' : 'pointer',
                          opacity: hasSubmission ? 0.6 : 1,
                          transition: 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
                          letterSpacing: '0.3px',
                          transform: isIncluded ? 'scale(1)' : 'scale(0.98)',
                          boxShadow: isIncluded ? '0 2px 8px rgba(16, 185, 129, 0.25)' : 'none',
                          animation: isIncluded ? 'slideToggle 0.4s ease-out' : 'slideToggleReverse 0.4s ease-out'
                        }}
                        onMouseEnter={(e) => {
                          if (isIncluded) {
                            e.target.style.backgroundColor = '#059669';
                            e.target.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.35)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (isIncluded) {
                            e.target.style.backgroundColor = '#10B981';
                            e.target.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.25)';
                          }
                        }}
                      >
                        Include
                      </button>

                      {/* Exclude Button */}
                      <button
                        onClick={() => {
                          if (!hasSubmission) {
                            setMemberInclusions(prev => ({ ...prev, [memberId]: false }));
                          }
                        }}
                        disabled={hasSubmission}
                        style={{
                          flex: 1,
                          padding: '8px 18px',
                          backgroundColor: !isIncluded ? '#EF4444' : 'transparent',
                          color: !isIncluded ? '#FFFFFF' : '#6B7280',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: hasSubmission ? 'not-allowed' : 'pointer',
                          opacity: hasSubmission ? 0.6 : 1,
                          transition: 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
                          letterSpacing: '0.3px',
                          transform: !isIncluded ? 'scale(1)' : 'scale(0.98)',
                          boxShadow: !isIncluded ? '0 2px 8px rgba(239, 68, 68, 0.25)' : 'none',
                          animation: !isIncluded ? 'slideToggle 0.4s ease-out' : 'slideToggleReverse 0.4s ease-out'
                        }}
                        onMouseEnter={(e) => {
                          if (!isIncluded) {
                            e.target.style.backgroundColor = '#DC2626';
                            e.target.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.35)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!isIncluded) {
                            e.target.style.backgroundColor = '#EF4444';
                            e.target.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.25)';
                          }
                        }}
                      >
                        Exclude
                      </button>
                    </div>
                  </div>

                  {/* Feedback Field - Appears when Excluded */}
                  {!isIncluded && (
                    <div
                      style={{
                        marginLeft: '0px',
                        animation: 'slideDown 0.3s ease-out',
                        marginBottom: '12px',
                        backgroundColor: '#FFFFFF',
                        padding: '16px',
                        borderRadius: '10px',
                        border: '1.5px solid #EF4444'
                      }}
                    >
                      {/* Header with Label */}
                      <div style={{ marginBottom: '12px' }}>
                        <label style={{
                          fontSize: '13px',
                          fontWeight: '600',
                          color: '#1F2937',
                          letterSpacing: '0.3px'
                        }}>
                          Exclusion Reason
                          <span style={{ color: '#EF4444' }}> *</span>
                        </label>
                        <p style={{
                          fontSize: '12px',
                          color: '#6B7280',
                          margin: '4px 0 0 0',
                          fontWeight: '400'
                        }}>
                          Minimum 50 characters required
                        </p>
                      </div>

                      {/* Textarea */}
                      <textarea
                        placeholder="Provide specific feedback for exclusion decision..."
                        value={feedback}
                        onChange={(e) => {
                          if (!hasSubmission) {
                            setInclusionFeedback(prev => ({ ...prev, [memberId]: e.target.value }));
                          }
                        }}
                        disabled={hasSubmission}
                        readOnly={hasSubmission}
                        style={{
                          width: '100%',
                          padding: '12px 14px',
                          fontSize: '13px',
                          border: feedback.length >= 50 ? '1.5px solid #10B981' : feedback.length > 0 ? '1.5px solid #F59E0B' : '1.5px solid #E5E7EB',
                          borderRadius: '8px',
                          fontFamily: 'inherit',
                          resize: 'vertical',
                          minHeight: '90px',
                          backgroundColor: hasSubmission ? '#F3F4F6' : '#FAFAFA',
                          color: '#1F2937',
                          cursor: hasSubmission ? 'not-allowed' : 'text',
                          opacity: hasSubmission ? 0.7 : 1,
                          boxShadow: feedback.length >= 50 ? '0 0 0 3px rgba(16, 185, 129, 0.08)' : feedback.length > 0 ? '0 0 0 3px rgba(245, 158, 11, 0.08)' : 'none',
                          transition: 'all 0.3s ease',
                          outline: 'none'
                        }}
                      />

                      {/* Character Counter and Status */}
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginTop: '12px',
                        fontSize: '12px',
                        fontWeight: '500'
                      }}>
                        <div style={{
                          color: feedback.length >= 50 ? '#10B981' : feedback.length > 0 ? '#F59E0B' : '#9CA3AF'
                        }}>
                          {feedback.length} / 50 characters
                          {feedback.length < 50 && feedback.length > 0 && <span style={{ marginLeft: '6px', color: '#F59E0B' }}>{50 - feedback.length} more needed</span>}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}

            {/* Action Buttons - Cancel and Submit */}
            <div style={{
              display: 'flex',
              gap: '12px',
              justifyContent: 'flex-end',
              marginTop: '24px',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }}>
              {/* Cancel Button */}
              <button
                onClick={() => {
                  setMemberInclusions({});
                  setInclusionFeedback({});
                }}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#F3F4F6',
                  color: '#374151',
                  border: '1.5px solid #D1D5DB',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  transition: 'all 0.3s ease',
                  letterSpacing: '0.3px'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#E5E7EB';
                  e.target.style.borderColor = '#9CA3AF';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = '#F3F4F6';
                  e.target.style.borderColor = '#D1D5DB';
                }}
              >
                Cancel
              </button>

              {/* Submit Button */}
              <button
                onClick={handleSubmitClick}
                disabled={submitting || hasSubmission}
                style={{
                  padding: '10px 24px',
                  backgroundColor: (submitting || hasSubmission) ? '#9CA3AF' : '#10B981',
                  color: '#FFFFFF',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: (submitting || hasSubmission) ? 'not-allowed' : 'pointer',
                  transition: 'all 0.3s ease',
                  letterSpacing: '0.3px',
                  boxShadow: '0 2px 8px rgba(16, 185, 129, 0.25)',
                  opacity: (submitting || hasSubmission) ? 0.7 : 1
                }}
                onMouseEnter={(e) => {
                  if (!submitting && !hasSubmission) {
                  e.target.style.backgroundColor = '#059669';
                  e.target.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.35)';
                  }
                }}
                onMouseLeave={(e) => {
                  if (!submitting && !hasSubmission) {
                  e.target.style.backgroundColor = '#10B981';
                  e.target.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.25)';
                  }
                }}
              >
                {hasSubmission ? 'Already Submitted' : (submitting ? 'Submitting...' : 'Submit')}
              </button>
            </div>
          </div>
        ) : (
          <div style={{
            color: '#9CA3AF',
            fontSize: '14px',
            padding: '24px',
            backgroundColor: '#F9FAFB',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            textAlign: 'center'
          }}>
            {groupData ? 'No group members available' : 'Loading group data...'}
          </div>
        )}
      </div>

      {/* Validation Modal */}
      {showValidationModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10001
        }}
        onClick={() => setShowValidationModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '600px',
            width: '90%',
            maxHeight: '85vh',
            overflow: 'auto',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                <h2 style={{
                  margin: 0,
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  color: '#2c3e50'
                }}>
                  Project Submission Validation
                </h2>
                <p style={{
                  margin: '4px 0 0 0',
                  fontSize: '14px',
                  color: '#6b7280'
                }}>
                  Please review the following before submitting
                </p>
              </div>
              <button
                onClick={() => setShowValidationModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6b7280',
                  padding: '4px 8px'
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {/* Validation Errors (Red - Must Fix) */}
              {validationErrors.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginBottom: '12px'
                  }}>
                    <FaExclamationTriangle style={{ color: '#DC2626', fontSize: '20px' }} />
                    <h3 style={{
                      margin: 0,
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#DC2626'
                    }}>
                      Required Actions ({validationErrors.length})
                    </h3>
                  </div>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {validationErrors.map((error, index) => (
                      <div
                        key={index}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FEE2E2',
                          border: '1px solid #FCA5A5',
                          borderLeft: '4px solid #DC2626',
                          borderRadius: '8px'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '12px'
                        }}>
                          <span style={{ fontSize: '20px' }}>{error.icon}</span>
                          <div style={{ flex: 1 }}>
                            <div style={{
                              fontWeight: '600',
                              color: '#991B1B',
                              marginBottom: '8px'
                            }}>
                              {error.message}
                            </div>
                            {error.subMessage && (
                              <div style={{
                                fontSize: '13px',
                                color: '#7F1D1D',
                                marginBottom: '8px',
                                fontStyle: 'italic'
                              }}>
                                {error.subMessage}
                              </div>
                            )}
                            {error.details && error.details.length > 0 && (
                              <div style={{
                                marginTop: '8px',
                                paddingLeft: '12px',
                                borderLeft: '2px solid #FCA5A5'
                              }}>
                                {error.details.map((detail, idx) => (
                                  <div
                                    key={idx}
                                    style={{
                                      marginBottom: '12px',
                                      paddingBottom: '8px',
                                      borderBottom: idx < error.details.length - 1 ? '1px solid #FCA5A5' : 'none'
                                    }}
                                  >
                                    <div style={{
                                      fontSize: '13px',
                                      color: '#991B1B',
                                      fontWeight: '600',
                                      marginBottom: '4px'
                                    }}>
                                      ‚Ä¢ {detail.name}
                                    </div>
                                    {detail.phases && detail.phases.length > 0 && (
                                      <div style={{
                                        marginLeft: '16px',
                                        marginTop: '4px'
                                      }}>
                                        {detail.phases.map((phase, phaseIdx) => (
                                          <div
                                            key={phaseIdx}
                                            style={{
                                              fontSize: '12px',
                                              color: '#7F1D1D',
                                              marginBottom: '2px'
                                            }}
                                          >
                                            ‚ó¶ Phase {phase.phaseNumber} ({phase.phaseTitle}): {phase.assigned}/{phase.required} tasks
                                          </div>
                                        ))}
                                        <div style={{
                                          fontSize: '12px',
                                          color: '#991B1B',
                                          marginTop: '4px',
                                          fontWeight: '500'
                                        }}>
                                          Total: {detail.totalAssigned}/{detail.totalRequired} tasks
                                        </div>
                                      </div>
                                    )}
                                    {!detail.phases && (
                                      <div style={{
                                        fontSize: '12px',
                                        color: '#7F1D1D',
                                        marginLeft: '16px'
                                      }}>
                                        {detail.assigned}/{detail.required} tasks assigned
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Validation Warnings (Yellow - Can Proceed) */}
              {validationWarnings.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginBottom: '12px'
                  }}>
                    <FaExclamationCircle style={{ color: '#F59E0B', fontSize: '20px' }} />
                    <h3 style={{
                      margin: 0,
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#F59E0B'
                    }}>
                      Warnings ({validationWarnings.length})
                    </h3>
                  </div>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {validationWarnings.map((warning, index) => (
                      <div
                        key={index}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FEF3C7',
                          border: '1px solid #FCD34D',
                          borderLeft: '4px solid #F59E0B',
                          borderRadius: '8px'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '12px'
                        }}>
                          <div style={{ fontSize: '20px', color: '#F59E0B', marginTop: '2px' }}>
                            {warning.icon === 'FaChartBar' && <FaChartBar />}
                            {warning.icon === 'FaClipboardList' && <FaClipboardList />}
                          </div>
                          <div style={{ flex: 1 }}>
                            <div style={{
                              fontWeight: '600',
                              color: '#92400E',
                              marginBottom: '8px'
                            }}>
                              {warning.message}
                            </div>
                            {warning.details && warning.details.length > 0 && (
                              <div style={{
                                marginTop: '8px',
                                paddingLeft: '12px',
                                borderLeft: '2px solid #FCD34D'
                              }}>
                                {warning.details.map((detail, idx) => (
                                  <div
                                    key={idx}
                                    style={{
                                      marginBottom: '12px',
                                      paddingBottom: '8px',
                                      borderBottom: idx < warning.details.length - 1 ? '1px solid #FCD34D' : 'none'
                                    }}
                                  >
                                    <div style={{
                                      fontSize: '13px',
                                      color: '#92400E',
                                      fontWeight: '600',
                                      marginBottom: '4px'
                                    }}>
                                      ‚Ä¢ {detail.name}
                                    </div>
                                    {detail.phases && detail.phases.length > 0 && (
                                      <div style={{
                                        marginLeft: '16px',
                                        marginTop: '4px'
                                      }}>
                                        {detail.phases.map((phase, phaseIdx) => (
                                          <div
                                            key={phaseIdx}
                                            style={{
                                              fontSize: '12px',
                                              color: '#78350F',
                                              marginBottom: '2px'
                                            }}
                                          >
                                            ‚ó¶ Phase {phase.phaseNumber} ({phase.phaseTitle}): {phase.assigned}/{phase.required} tasks
                                          </div>
                                        ))}
                                        <div style={{
                                          fontSize: '12px',
                                          color: '#92400E',
                                          marginTop: '4px',
                                          fontWeight: '500'
                                        }}>
                                          Total: {detail.totalAssigned}/{detail.totalRequired} tasks
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Success Message */}
              {validationErrors.length === 0 && validationWarnings.length === 0 && (
                <div style={{
                  padding: '16px',
                  backgroundColor: '#D1FAE5',
                  border: '1px solid #6EE7B7',
                  borderLeft: '4px solid #10B981',
                  borderRadius: '8px',
                  marginBottom: '24px'
                }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                  }}>
                    <FaCheckCircle style={{ color: '#059669', fontSize: '20px' }} />
                    <div style={{
                      fontWeight: '600',
                      color: '#065F46'
                    }}>
                      All validation checks passed! Ready to submit.
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '24px',
              borderTop: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'flex-end',
              gap: '12px'
            }}>
              <button
                onClick={() => setShowValidationModal(false)}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#F3F4F6',
                  color: '#374151',
                  border: '1px solid #D1D5DB',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#E5E7EB'}
                onMouseLeave={(e) => e.target.style.backgroundColor = '#F3F4F6'}
              >
                Cancel
              </button>
              
              {validationErrors.length === 0 && (
                <button
                  onClick={proceedWithSubmission}
                  disabled={submitting}
                  style={{
                    padding: '10px 24px',
                    backgroundColor: submitting ? '#9CA3AF' : '#10B981',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: submitting ? 'not-allowed' : 'pointer',
                    transition: 'all 0.2s ease',
                    opacity: submitting ? 0.7 : 1
                  }}
                  onMouseEnter={(e) => {
                    if (!submitting) e.target.style.backgroundColor = '#059669';
                  }}
                  onMouseLeave={(e) => {
                    if (!submitting) e.target.style.backgroundColor = '#10B981';
                  }}
                >
                  {submitting ? 'Submitting...' : (validationWarnings.length > 0 ? 'Submit Anyway' : 'Submit')}
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ‚úÖ File Type Error Modal */}
      {showFileTypeErrorModal && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 10000
          }}
          onClick={() => setShowFileTypeErrorModal(false)}
        >
          <div 
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '32px',
              maxWidth: '500px',
              width: '90%',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Icon and Title */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                backgroundColor: '#FEE2E2',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '24px'
              }}>
                ‚ùå
              </div>
              <h3 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#1F2937' }}>
                Invalid File Type{invalidFilesList.length > 1 ? 's' : ''} Detected
              </h3>
            </div>

            {/* Description */}
            <p style={{ color: '#6B7280', marginBottom: '20px', lineHeight: '1.6' }}>
              The following file{invalidFilesList.length > 1 ? 's have' : ' has'} invalid extension{invalidFilesList.length > 1 ? 's' : ''}:
            </p>

            {/* Invalid Files List */}
            <div style={{
              backgroundColor: '#FEF2F2',
              border: '1px solid #FECACA',
              borderRadius: '8px',
              padding: '16px',
              marginBottom: '20px'
            }}>
              {invalidFilesList.map((fileName, index) => (
                <div key={index} style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '8px',
                  marginBottom: index < invalidFilesList.length - 1 ? '8px' : '0'
                }}>
                  <span style={{ color: '#DC2626', fontSize: '16px' }}>‚Ä¢</span>
                  <span style={{ color: '#991B1B', fontWeight: '500', wordBreak: 'break-all' }}>
                    {fileName}
                  </span>
                </div>
              ))}
            </div>

            {/* Allowed Types */}
            {fileTypeError && (
              <div style={{
                backgroundColor: '#ECFDF5',
                border: '1px solid #A7F3D0',
                borderRadius: '8px',
                padding: '16px',
                marginBottom: '24px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                  <span style={{ color: '#059669', fontSize: '16px' }}>‚úì</span>
                  <span style={{ color: '#065F46', fontWeight: '600' }}>Allowed File Types:</span>
                </div>
                <span style={{ color: '#047857', fontSize: '14px' }}>
                  {fileTypeError.replace('Allowed file types: ', '')}
                </span>
              </div>
            )}

            {/* Action Button */}
            <button
              onClick={() => setShowFileTypeErrorModal(false)}
              style={{
                width: '100%',
                padding: '12px 24px',
                backgroundColor: '#EF4444',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onMouseEnter={(e) => e.target.style.backgroundColor = '#DC2626'}
              onMouseLeave={(e) => e.target.style.backgroundColor = '#EF4444'}
            >
              Got it
            </button>
          </div>
        </div>
      )}

      {/* Task Detail Modal */}
      {showTaskDetailModal && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 10000
          }}
          onClick={() => setShowTaskDetailModal(false)}
        >
          <div 
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '0',
              maxWidth: '600px',
              width: '90%',
              maxHeight: '80vh',
              overflow: 'hidden',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
              display: 'flex',
              flexDirection: 'column'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              flexShrink: 0
            }}>
              <h2 style={{
                margin: 0,
                fontSize: '1.5rem',
                fontWeight: '700',
                color: '#2c3e50'
              }}>
                Task Details
              </h2>
              <button
                onClick={() => setShowTaskDetailModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6b7280',
                  padding: '4px 8px'
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {loadingTaskDetail ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <div style={{
                    display: 'inline-block',
                    width: '40px',
                    height: '40px',
                    border: '4px solid #f3f4f6',
                    borderTop: '4px solid #34656D',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }}></div>
                  <p style={{ marginTop: '16px', color: '#6b7280' }}>Loading task details...</p>
                </div>
              ) : selectedTaskDetail ? (
                <>
                  {/* Task Information */}
                  <div style={{ marginBottom: '24px' }}>
                    <h3 style={{
                      fontSize: '1.1rem',
                      fontWeight: '600',
                      color: '#34656D',
                      marginBottom: '12px'
                    }}>
                      {selectedTaskDetail.title}
                    </h3>
                    
                    {/* Task Status Badge */}
                    {selectedTaskDetail.status && (
                      <div style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '6px',
                        padding: '6px 12px',
                        borderRadius: '6px',
                        fontSize: '13px',
                        fontWeight: '600',
                        marginBottom: '16px',
                        backgroundColor: selectedTaskDetail.status === 'completed' ? '#D1FAE5' : 
                                       selectedTaskDetail.status === 'to_revise' ? '#FFEDD5' : '#FEE2E2',
                        color: selectedTaskDetail.status === 'completed' ? '#059669' : 
                              selectedTaskDetail.status === 'to_revise' ? '#EA580C' : '#DC2626'
                      }}>
                        {selectedTaskDetail.status === 'completed' ? <><FaCheck size={12} /> Completed</> :
                         selectedTaskDetail.status === 'to_revise' ? <><FaExclamationTriangle size={12} /> Needs Revision</> :
                         <><FaClock size={12} /> Pending</>}
                      </div>
                    )}

                    {selectedTaskDetail.description && (
                      <p style={{
                        color: '#6b7280',
                        lineHeight: '1.6',
                        marginTop: '12px'
                      }}>
                        {selectedTaskDetail.description}
                      </p>
                    )}

                    {selectedTaskDetail.due_date && (
                      <div style={{
                        marginTop: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        color: '#6b7280',
                        fontSize: '14px'
                      }}>
                        <FaCalendarAlt />
                        <span>Due: {new Date(selectedTaskDetail.due_date).toLocaleDateString('en-US', {
                          month: 'long',
                          day: 'numeric',
                          year: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}</span>
                      </div>
                    )}
                  </div>

                  {/* Submission Details */}
                  {selectedTaskDetail.submissionDetails && selectedTaskDetail.submissionDetails.submission ? (
                    <div style={{
                      marginTop: '24px',
                      padding: '20px',
                      backgroundColor: '#F9FAFB',
                      borderRadius: '8px',
                      border: '1px solid #E5E7EB'
                    }}>
                      <h4 style={{
                        fontSize: '1rem',
                        fontWeight: '600',
                        color: '#2c3e50',
                        marginBottom: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <FaFileAlt />
                        Submission
                        {selectedTaskDetail.submissionDetails.submission.revision_attempt_number && (
                          <span style={{
                            fontSize: '12px',
                            fontWeight: '500',
                            color: '#6b7280',
                            marginLeft: '4px'
                          }}>
                            (Revision #{selectedTaskDetail.submissionDetails.submission.revision_attempt_number})
                          </span>
                        )}
                      </h4>

                      {/* Submission Type Badge */}
                      <div style={{
                        display: 'inline-block',
                        padding: '4px 10px',
                        borderRadius: '4px',
                        fontSize: '11px',
                        fontWeight: '600',
                        marginBottom: '12px',
                        backgroundColor: selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' || 
                                       selectedTaskDetail.submissionDetails.submissionType === 'approved_original' 
                          ? '#D1FAE5' : '#FEF3C7',
                        color: selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' || 
                              selectedTaskDetail.submissionDetails.submissionType === 'approved_original' 
                          ? '#059669' : '#B45309'
                      }}>
                        {selectedTaskDetail.submissionDetails.submissionType === 'approved_revision' ? '‚úì Approved Revision' :
                         selectedTaskDetail.submissionDetails.submissionType === 'approved_original' ? '‚úì Approved Original' :
                         selectedTaskDetail.submissionDetails.submissionType === 'revision_requested' ? '‚ö† Revision Requested' :
                         selectedTaskDetail.submissionDetails.submissionType === 'leader_acted' ? 'üìù Leader Reviewed' :
                         selectedTaskDetail.submissionDetails.submissionType === 'latest_revision' ? 'üìÑ Latest Revision' :
                         'üìÑ Latest Submission'}
                      </div>

                      {selectedTaskDetail.submissionDetails.submission.submitted_at && (
                        <p style={{
                          fontSize: '13px',
                          color: '#6b7280',
                          marginBottom: '12px'
                        }}>
                          <strong>Submitted:</strong> {new Date(selectedTaskDetail.submissionDetails.submission.submitted_at).toLocaleString()}
                        </p>
                      )}

                      {selectedTaskDetail.submissionDetails.submission.submission_text && (
                        <div style={{ marginBottom: '16px' }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            marginBottom: '6px'
                          }}>
                            Submission Text:
                          </p>
                          <p style={{
                            fontSize: '14px',
                            color: '#374151',
                            lineHeight: '1.6',
                            padding: '12px',
                            backgroundColor: 'white',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.submission_text}
                          </p>
                        </div>
                      )}

                      {/* Leader Feedback */}
                      {selectedTaskDetail.submissionDetails.submission.review_comments && (
                        <div style={{
                          marginTop: '16px',
                          padding: '12px',
                          backgroundColor: '#FEF3C7',
                          borderRadius: '6px',
                          borderLeft: '4px solid #F59E0B'
                        }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#92400E',
                            marginBottom: '6px'
                          }}>
                            Leader Feedback:
                          </p>
                          <p style={{
                            fontSize: '14px',
                            color: '#78350F',
                            lineHeight: '1.6'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.review_comments}
                          </p>
                        </div>
                      )}

                      {/* Submitted Files */}
                      {selectedTaskDetail.submissionDetails.submission.files && 
                       selectedTaskDetail.submissionDetails.submission.files.length > 0 && (
                        <div style={{ marginTop: '16px' }}>
                          <p style={{
                            fontSize: '13px',
                            fontWeight: '600',
                            color: '#2c3e50',
                            marginBottom: '10px'
                          }}>
                            Submitted Files ({selectedTaskDetail.submissionDetails.submission.files.length}):
                          </p>
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '8px'
                          }}>
                            {selectedTaskDetail.submissionDetails.submission.files.map((filePath, index) => {
                              const fileName = filePath.split('/').pop();
                              return (
                                <a
                                  key={index}
                                  href={`${apiConfig.baseURL}/api/download-file?path=${encodeURIComponent(filePath)}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    padding: '10px 12px',
                                    backgroundColor: 'white',
                                    border: '1px solid #E5E7EB',
                                    borderRadius: '6px',
                                    textDecoration: 'none',
                                    color: '#2c3e50',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.backgroundColor = '#F3F4F6';
                                    e.currentTarget.style.borderColor = '#34656D';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.backgroundColor = 'white';
                                    e.currentTarget.style.borderColor = '#E5E7EB';
                                  }}
                                >
                                  <FaFileAlt style={{ color: '#34656D', fontSize: '18px' }} />
                                  <span style={{
                                    flex: 1,
                                    fontSize: '14px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                  }}>
                                    {fileName}
                                  </span>
                                  <FaDownload style={{ color: '#6b7280', fontSize: '14px' }} />
                                </a>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div style={{
                      padding: '40px',
                      textAlign: 'center',
                      color: '#9CA3AF'
                    }}>
                      <FaFileAlt size={48} style={{ marginBottom: '12px', opacity: 0.5 }} />
                      <p>No submission found for this task</p>
                    </div>
                  )}
                </>
              ) : (
                <div style={{
                  padding: '40px',
                  textAlign: 'center',
                  color: '#9CA3AF'
                }}>
                  <p>Failed to load task details</p>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: '2px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'flex-end',
              flexShrink: 0
            }}>
              <button
                onClick={() => setShowTaskDetailModal(false)}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#34656D',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#2c545b'}
                onMouseLeave={(e) => e.target.style.backgroundColor = '#34656D'}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Phase Details Panel Component
const PhaseDetailsPanel = ({ phase, groupData, onSubmit, attemptHistory, currentAttempts, maxAttempts, canSubmit, taskDeadlineRestriction }) => {
  console.log(`üéØ [DEBUG] PhaseDetailsPanel rendered with:`, {
    phase: phase ? { id: phase.id, title: phase.title, phase_number: phase.phase_number } : null,
    groupData: groupData ? { 
      group_name: groupData.group_name, 
      members: groupData.members ? groupData.members.map(m => ({ 
        id: m.id, 
        student_id: m.student_id, 
        full_name: m.full_name, 
        first_name: m.first_name,
        role: m.role 
      })) : [] 
    } : null,
    attemptHistory,
    currentAttempts,
    maxAttempts,
    canSubmit,
    taskDeadlineRestriction
  });

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [files, setFiles] = useState([]);
  const [uploadProgress, setUploadProgress] = useState({});
  const fileInputRef = useRef(null);

  const handleFileSelect = (event) => {
    const selectedFiles = Array.from(event.target.files);
    
    // Validate file types if restrictions exist
    if (phase.file_types_allowed) {
      let allowedTypes = [];
      
      // Handle different formats of file_types_allowed
      if (typeof phase.file_types_allowed === 'string') {
        try {
          // Try parsing as JSON first
          allowedTypes = JSON.parse(phase.file_types_allowed).map(type => type.trim().toLowerCase().replace('.', ''));
        } catch (e) {
          // If not JSON, treat as comma-separated string
          allowedTypes = phase.file_types_allowed.split(',').map(type => type.trim().toLowerCase().replace('.', ''));
        }
      } else if (Array.isArray(phase.file_types_allowed)) {
        allowedTypes = phase.file_types_allowed.map(type => type.trim().toLowerCase().replace('.', ''));
      }
      
      const invalidFiles = selectedFiles.filter(file => {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        return !allowedTypes.includes(fileExtension);
      });
      
      if (invalidFiles.length > 0) {
        alert(`Invalid file types detected. Allowed types: ${allowedTypes.join(', ')}`);
        return;
      }
    }

    // Validate file sizes (5MB limit per file)
    const maxSizeBytes = 5 * 1024 * 1024;
    const oversizedFiles = selectedFiles.filter(file => file.size > maxSizeBytes);
    if (oversizedFiles.length > 0) {
      alert('Some files are larger than 5MB. Please compress or choose smaller files.');
      return;
    }

    setFiles(prevFiles => [...prevFiles, ...selectedFiles]);
  };

  const removeFile = (index) => {
    setFiles(prevFiles => prevFiles.filter((_, i) => i !== index));
  };

  const uploadFiles = async () => {
    try {
      // Initialize progress for all files
      const progressInit = {};
      files.forEach(file => {
        progressInit[file.name] = 0;
      });
      setUploadProgress(progressInit);
      
      const formData = new FormData();
      formData.append('phaseId', phase.id);
      
      // Add all files to the same form data
      files.forEach(file => {
        formData.append('files', file); // Note: using 'files' field name for multiple files
      });
      
      const response = await fetch(`${apiConfig.baseURL}/api/student-leader/upload-phase-file`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload files');
      }
      
      const data = await response.json();
      
      // Set all files to 100% progress
      const progressComplete = {};
      files.forEach(file => {
        progressComplete[file.name] = 100;
      });
      setUploadProgress(progressComplete);
      
      console.log('‚úÖ All files uploaded successfully:', data);
      return data.files ? data.files.map(f => f.url) : [];
      
    } catch (error) {
      console.error('Failed to upload files:', error);
      alert(`Failed to upload files: ${error.message}`);
      
      // Set error state for progress
      const progressError = {};
      files.forEach(file => {
        progressError[file.name] = -1;
      });
      setUploadProgress(progressError);
      
      return null;
    }
  };

  const handleSubmit = async () => {
    if (files.length === 0) {
      alert('Please upload at least one file for the phase deliverable.');
      return;
    }

    if (!canSubmit) {
      if (currentAttempts >= maxAttempts) {
        alert(`You have reached the maximum number of attempts (${maxAttempts}) for this phase.`);
        return;
      }
      if (taskDeadlineRestriction) {
        alert('You cannot submit for this phase until all member tasks are past their due dates.');
        return;
      }
    }

    setIsSubmitting(true);
    try {
      let fileUrls = [];
      
      // Upload files (required for phase submissions)
      const uploadedUrls = await uploadFiles();
      if (uploadedUrls === null) {
        setIsSubmitting(false);
        return;
      }
      fileUrls = uploadedUrls;
      
      await onSubmit(phase.id, {
        submission_text: `Phase ${phase.phase_number} Final Deliverable`, // Auto-generated text
        file_urls: fileUrls
      });
      
      // Clear form after successful submission
      setFiles([]);
      setUploadProgress({});
    } catch (error) {
      // Error handling is done in the parent function
    } finally {
      setIsSubmitting(false);
    }
  };

  const formatFileSize = (bytes) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const getStatusClass = () => {
    switch (phase.status) {
      case 'graded': return 'graded';
      case 'submitted': return 'submitted';
      case 'pending': 
      default: return 'pending';
    }
  };

  return (
    <div className="canvas-phase-container">
      {/* Canvas-style Header Card */}
      <div className="canvas-card canvas-header-card">
        <div className="canvas-card-content">
          <div className="phase-header-content">
            <div className="phase-title-row">
              <div className="phase-badge-pill">Phase {phase.phase_number}</div>
              <h1 className="phase-title">{phase.title}</h1>
            </div>
            
            <div className="phase-meta-row">
              <div className="meta-item">
                <span className="meta-label">Start Date</span>
                <span className="meta-value">{new Date(phase.start_date).toLocaleDateString()}</span>
              </div>
              <div className="meta-item">
                <span className="meta-label">End Date</span>
                <span className="meta-value">{new Date(phase.end_date).toLocaleDateString()}</span>
              </div>
              <div className="meta-item">
                <span className="meta-label">Status</span>
                <div className={`status-pill status-${phase.status || 'pending'}`}>
                  {phase.status === 'graded' && <><FaCheckDouble size={12} /> Graded</>}
                  {phase.status === 'submitted' && <><FaCheck size={12} /> Submitted</>}
                  {(!phase.status || phase.status === 'pending') && <><FaClock size={12} /> Pending</>}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Attempts Tracking Card */}
      <div className="canvas-card attempts-card">
        <div className="canvas-card-header">
          <h2>Submission Attempts</h2>
        </div>
        <div className="canvas-card-content">
          <div className="attempts-info-row">
            <div className="attempts-counter">
              <span className="counter-value">{currentAttempts}</span>
              <span className="counter-label">of {maxAttempts} attempts used</span>
            </div>
            <div className="attempts-status">
              {canSubmit ? (
                <div className="status-pill status-allowed">
                  <FaCheck size={12} /> Submissions Allowed
                </div>
              ) : (
                <div className="status-pill status-restricted">
                  <FaTimes size={12} /> 
                  {currentAttempts >= maxAttempts ? 'Max Attempts Reached' : 'Task Deadline Restriction'}
                </div>
              )}
            </div>
          </div>
          
          {attemptHistory && attemptHistory.length > 0 && (
            <div className="attempts-history">
              <h4>Previous Submissions</h4>
              <div className="history-list">
                {attemptHistory.map((attempt, index) => (
                  <div key={index} className="history-item">
                    <div className="attempt-info">
                      <span className="attempt-number">Attempt {attempt.attempt_number}</span>
                      <span className="attempt-date">{new Date(attempt.submission_date).toLocaleString()}</span>
                    </div>
                    <div className={`attempt-status status-pill status-${attempt.status}`}>
                      {attempt.status}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {taskDeadlineRestriction && (
            <div className="restriction-notice">
              <div className="notice-pill notice-warning">
                <FaExclamationTriangle size={12} />
                Cannot submit until all member tasks are past their due dates
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Phase Description Card */}
      <div className="canvas-card description-card">
        <div className="canvas-card-header">
          <h2>Phase Description</h2>
        </div>
        <div className="canvas-card-content">
          <p className="phase-description">{phase.description}</p>
        </div>
      </div>

      {/* File Requirements Card */}
      {phase.file_types_allowed && (
        <div className="canvas-card requirements-card">
          <div className="canvas-card-header">
            <h2>File Requirements</h2>
          </div>
          <div className="canvas-card-content">
            <div className="requirements-grid">
              <div className="requirement-pill">
                <FaFile size={14} />
                <span>Types: {phase.file_types_allowed}</span>
              </div>
              <div className="requirement-pill">
                <FaCloudUploadAlt size={14} />
                <span>Max: 5MB per file</span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Current Submission Display */}
      {phase.submission && (
        <div className="canvas-card current-submission-card">
          <div className="canvas-card-header">
            <h2>Current Submission</h2>
          </div>
          <div className="canvas-card-content">
            <div className="submission-info-grid">
              <div className="info-item">
                <span className="info-label">Submitted</span>
                <span className="info-value">{new Date(phase.submission.submission_date).toLocaleString()}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Status</span>
                <div className={`status-pill status-${phase.submission.status}`}>
                  {phase.submission.status}
                </div>
              </div>
              {phase.submission.is_late && (
                <div className="info-item">
                  <span className="info-label">Notice</span>
                  <div className="status-pill status-warning">
                    <FaExclamationTriangle size={12} /> Late Submission
                  </div>
                </div>
              )}
              {phase.submission.grade && (
                <div className="info-item">
                  <span className="info-label">Grade</span>
                  <span className="info-value grade-value">{phase.submission.grade}%</span>
                </div>
              )}
            </div>
            
            {(() => {
              // Parse file_urls safely
              let fileUrls = [];
              if (phase.submission.file_urls) {
                try {
                  if (Array.isArray(phase.submission.file_urls)) {
                    fileUrls = phase.submission.file_urls;
                  } else if (typeof phase.submission.file_urls === 'string') {
                    fileUrls = JSON.parse(phase.submission.file_urls);
                  }
                } catch (e) {
                  console.warn('Failed to parse file_urls:', phase.submission.file_urls);
                  fileUrls = [];
                }
              }
              
              return fileUrls.length > 0 && (
                <div className="submitted-files-section">
                  <h4>Submitted Files</h4>
                  <div className="files-grid">
                    {fileUrls.map((url, index) => {
                      const fileNumber = index + 1;
                      const fileName = `File #${fileNumber}`;
                      
                      return (
                        <button 
                          key={index} 
                          onClick={() => downloadFile(url, fileName)}
                          className="current-submission-file-button"
                          title={`Download File #${fileNumber}`}
                        >
                          <FaFile size={14} />
                          <span>{fileName}</span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              );
            })()}
          </div>
        </div>
      )}

      {/* Submission Form Card */}
      <div className="canvas-card submission-form-card">
        <div className="canvas-card-header">
          <h2>Phase Deliverable Submission</h2>
          <p className="card-subtitle">Upload your final phase deliverable files</p>
        </div>
        <div className="canvas-card-content">
          
          {/* File Upload Section */}
          <div className="upload-section">
            <div 
              className={`upload-dropzone ${!canSubmit ? 'disabled' : ''}`}
              onClick={() => canSubmit && fileInputRef.current?.click()}
            >
              <div className="upload-icon">
                <FaCloudUploadAlt size={32} />
              </div>
              <div className="upload-content">
                <h3>Upload Files</h3>
                <p>Click to select files or drag and drop</p>
                {phase.file_types_allowed && (
                  <small className="upload-hint">Accepted: {phase.file_types_allowed}</small>
                )}
              </div>
            </div>
            
            <input
              ref={fileInputRef}
              type="file"
              multiple
              onChange={handleFileSelect}
              style={{ display: 'none' }}
              accept={phase.file_types_allowed ? 
                (() => {
                  let allowedTypes = [];
                  if (typeof phase.file_types_allowed === 'string') {
                    try {
                      allowedTypes = JSON.parse(phase.file_types_allowed);
                    } catch (e) {
                      allowedTypes = phase.file_types_allowed.split(',');
                    }
                  } else if (Array.isArray(phase.file_types_allowed)) {
                    allowedTypes = phase.file_types_allowed;
                  }
                  return allowedTypes.map(type => `.${type.trim().toLowerCase().replace('.', '')}`).join(',');
                })() : '*'
              }
            />
          </div>

          {/* Selected Files List */}
          {files.length > 0 && (
            <div className="selected-files-section">
              <h4>Selected Files</h4>
              <div className="files-list">
                {files.map((file, index) => (
                  <div key={index} className="file-item-pill">
                    <div className="file-info">
                      <FaFile size={14} />
                      <div className="file-details">
                        <span className="file-name">{file.name}</span>
                        <small className="file-size">({formatFileSize(file.size)})</small>
                      </div>
                    </div>
                    
                    {uploadProgress[file.name] !== undefined && (
                      <div className="file-progress">
                        {uploadProgress[file.name] === -1 ? (
                          <div className="progress-status error">
                            <FaTimes size={12} />
                          </div>
                        ) : uploadProgress[file.name] === 100 ? (
                          <div className="progress-status success">
                            <FaCheck size={12} />
                          </div>
                        ) : (
                          <div className="progress-bar-container">
                            <div 
                              className="progress-bar-fill" 
                              style={{ width: `${uploadProgress[file.name]}%` }}
                            />
                          </div>
                        )}
                      </div>
                    )}
                    
                    <button
                      type="button"
                      onClick={() => removeFile(index)}
                      className="remove-file-btn"
                      disabled={isSubmitting}
                    >
                      <FaTimes size={12} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Submit Button */}
          <div className="submit-section">
            <button
              className={`canvas-submit-btn ${!canSubmit || files.length === 0 ? 'disabled' : ''}`}
              onClick={handleSubmit}
              disabled={isSubmitting || files.length === 0 || !canSubmit}
            >
              {isSubmitting ? (
                <>
                  <FaSpinner className="loading-spinner" />
                  <span>{files.length > 0 ? 'Uploading...' : phase.submission ? 'Updating...' : 'Submitting...'}</span>
                </>
              ) : (
                <>
                  <FaPaperPlane size={14} />
                  <span>{phase.submission ? 'Update Submission' : 'Submit Phase'}</span>
                </>
              )}
            </button>
            
            {!canSubmit && (
              <div className="submit-restriction-notice">
                {currentAttempts >= maxAttempts ? (
                  <span className="restriction-text">Maximum attempts reached ({maxAttempts})</span>
                ) : taskDeadlineRestriction ? (
                  <span className="restriction-text">Waiting for all member tasks to be due</span>
                ) : (
                  <span className="restriction-text">Submission not allowed</span>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Member Task Submissions Component
const MemberTaskSubmissions = ({ member, phaseId, phaseNumber }) => {
  const [memberTasks, setMemberTasks] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchMemberTasks();
  }, [member.id, phaseId]);

  const fetchMemberTasks = async () => {
    try {
      console.log(`üîç [DEBUG] Fetching member tasks for:`, {
        memberId: member.student_id || member.id,
        phaseId,
        memberData: member
      });
      
      setLoading(true);
      const studentId = member.student_id || member.id;
      const apiUrl = `${apiConfig.baseURL}/api/student-leader/member-tasks/${studentId}/${phaseId}`;
      
      console.log(`üì° [DEBUG] Making request to:`, apiUrl);
      
      const response = await fetch(apiUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      console.log(`üì§ [DEBUG] Response status:`, response.status);
      console.log(`üì§ [DEBUG] Response ok:`, response.ok);

      if (response.ok) {
        const tasks = await response.json();
        console.log(`‚úÖ [DEBUG] Received tasks:`, tasks);
        setMemberTasks(tasks);
      } else {
        const errorText = await response.text();
        console.error(`‚ùå [DEBUG] Failed to fetch member tasks. Status: ${response.status}, Error: ${errorText}`);
        setMemberTasks([]);
      }
    } catch (error) {
      console.error(`‚ùå [DEBUG] Error fetching member tasks:`, error);
      setMemberTasks([]);
    } finally {
      console.log(`üèÅ [DEBUG] Finished fetching member tasks, loading: false`);
      setLoading(false);
    }
  };

  const downloadFile = (fileUrl, fileName) => {
    const link = document.createElement('a');
    link.href = fileUrl;
    link.download = fileName || 'download';
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  if (loading) {
    console.log(`üîÑ [DEBUG] MemberTaskSubmissions loading for member:`, member.full_name || member.first_name);
    return (
      <div className="member-task-submissions-card">
        <div className="member-header">
          <div className="member-avatar-small">
            {member.profile_image_url ? (
              <img src={getProfileImageUrl(member)} alt={member.full_name} />
            ) : (
              <div className="avatar-placeholder-small">
                {member.full_name?.charAt(0) || member.first_name?.charAt(0) || '?'}
              </div>
            )}
          </div>
          <div className="member-info-small">
            <span className="member-name-small">{member.full_name || `${member.first_name} ${member.last_name}`}</span>
            <span className="member-role-small">{member.role}</span>
          </div>
        </div>
        <div className="loading-tasks">
          <FaSpinner className="loading-spinner" />
          <span>Loading tasks...</span>
        </div>
      </div>
    );
  }

  console.log(`üìã [DEBUG] Rendering MemberTaskSubmissions for:`, {
    member: member.full_name || member.first_name,
    phaseId,
    phaseNumber,
    tasksCount: memberTasks.length,
    tasks: memberTasks
  });

  return (
    <div className="member-task-submissions-card">
      <div className="member-header">
        <div className="member-avatar-small">
          {member.profile_image_url ? (
            <img src={getProfileImageUrl(member)} alt={member.full_name} />
          ) : (
            <div className="avatar-placeholder-small">
              {member.full_name?.charAt(0) || member.first_name?.charAt(0) || '?'}
            </div>
          )}
        </div>
        <div className="member-info-small">
          <span className="member-name-small">{member.full_name || `${member.first_name} ${member.last_name}`}</span>
          <span className="member-role-small">{member.role}</span>
        </div>
      </div>

      <div className="task-submissions-grid">
        {memberTasks.length === 0 ? (
          <div className="no-tasks-assigned">
            <FaInfoCircle />
            <span>No tasks assigned for Phase {phaseNumber}</span>
          </div>
        ) : (
          memberTasks.map((task, index) => {
            // Get submission status and file info
            const submissionStatus = task.submission?.status || 'no_submission';
            const hasFiles = task.submission?.file_urls && 
              (Array.isArray(task.submission.file_urls) ? task.submission.file_urls.length > 0 : 
               typeof task.submission.file_urls === 'string' && task.submission.file_urls !== '[]');
            
            const getStatusIcon = () => {
              switch (submissionStatus) {
                case 'approved':
                  return <FaCheckCircle className="status-icon approved" />;
                case 'revision_requested':
                  return <FaExclamationTriangle className="status-icon revision-requested" />;
                case 'pending':
                  return <FaClock className="status-icon pending" />;
                default:
                  return <FaTimes className="status-icon no-submission" />;
              }
            };

            const getStatusText = () => {
              switch (submissionStatus) {
                case 'approved':
                  return 'Approved';
                case 'revision_requested':
                  return 'Needs Revision';
                case 'pending':
                  return 'Under Review';
                default:
                  return 'No Submission';
              }
            };

            const getDownloadUrl = () => {
              if (!hasFiles) return null;
              
              let fileUrls = task.submission.file_urls;
              if (typeof fileUrls === 'string') {
                try {
                  fileUrls = JSON.parse(fileUrls);
                } catch (e) {
                  console.error('Error parsing file_urls:', e);
                  return null;
                }
              }
              
              return Array.isArray(fileUrls) && fileUrls.length > 0 ? fileUrls[0] : null;
            };

            return (
              <div key={task.id} className={`task-submission-box ${submissionStatus}`}>
                <div className="task-info">
                  <span className="task-title">{task.title}</span>
                  <div className="task-meta">
                    <span className={`task-status ${submissionStatus}`}>
                      {getStatusIcon()}
                      {getStatusText()}
                    </span>
                    {task.submission?.submission_date && (
                      <small className="submission-date">
                        {new Date(task.submission.submission_date).toLocaleDateString()}
                      </small>
                    )}
                  </div>
                </div>
                
                <div className="submission-actions">
                  {hasFiles ? (
                    <button
                      className={`download-btn ${submissionStatus}`}
                      onClick={() => {
                        const fileUrl = getDownloadUrl();
                        if (fileUrl) {
                          downloadFile(fileUrl, `${member.full_name || member.first_name}_${task.title}_Phase${phaseNumber}`);
                        }
                      }}
                    >
                      <FaDownload />
                      <span>Download</span>
                    </button>
                  ) : task.submission ? (
                    <div className="no-file-indicator">
                      <FaFileAlt />
                      <span>Text Only</span>
                    </div>
                  ) : (
                    <div className="no-submission-indicator">
                      <FaTimes />
                      <span>Not Submitted</span>
                    </div>
                  )}
                  
                  {task.submission?.is_late && (
                    <div className="late-indicator">
                      <FaClock />
                      <span>Late</span>
                    </div>
                  )}
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
};

// Phase Submission Card Component with File Upload
const PhaseSubmissionCard = ({ phase, onSubmit }) => {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isExpanded, setIsExpanded] = useState(false);
  const [submissionText, setSubmissionText] = useState(
    phase.submission?.submission_text || ''
  );
  const [files, setFiles] = useState([]);
  const [uploadProgress, setUploadProgress] = useState({});
  const fileInputRef = useRef(null);

  const getStatusIcon = () => {
    switch (phase.status) {
      case 'graded':
        return <FaCheckDouble className="status-icon graded" />;
      case 'submitted':
        return <FaCheck className="status-icon submitted" />;
      case 'pending':
      default:
        return <FaClock className="status-icon pending" />;
    }
  };

  const getStatusClass = () => {
    let baseClass = '';
    switch (phase.status) {
      case 'graded': baseClass = 'graded'; break;
      case 'submitted': baseClass = 'submitted'; break;
      case 'pending': 
      default: baseClass = 'pending'; break;
    }
    
    // Add project completion class
    if (phase.isProjectCompletion) {
      baseClass += ' project-completion';
    }
    
    // Add date restriction classes
    if (phase.dateRestriction) {
      if (phase.dateRestriction.isPastDue) {
        baseClass += ' past-due';
      } else if (phase.dateRestriction.isNotStarted) {
        baseClass += ' not-started';
      }
    }
    
    return baseClass;
  };

  const isSubmissionDisabled = () => {
    // Check date restrictions
    if (phase.dateRestriction && !phase.dateRestriction.isWithinRange) {
      return true;
    }
    
    // Check can submit flag
    if (!phase.canSubmit) {
      return true;
    }
    
    return false;
  };

  const getSubmissionDisabledReason = () => {
    if (phase.dateRestriction) {
      if (phase.dateRestriction.isNotStarted) {
        return `Phase starts on ${new Date(phase.dateRestriction.startDate).toLocaleDateString()}`;
      }
      if (phase.dateRestriction.isPastDue) {
        return `Phase ended on ${new Date(phase.dateRestriction.endDate).toLocaleDateString()}`;
      }
    }
    
    if (!phase.canSubmit && phase.currentAttempts >= phase.maxAttempts) {
      return `Maximum attempts reached (${phase.maxAttempts})`;
    }
    
    return '';
  };

  const handleFileSelect = (event) => {
    const selectedFiles = Array.from(event.target.files);
    
    // Validate file types if restrictions exist
    if (phase.file_types_allowed) {
      let allowedTypes = [];
      
      // Handle different formats of file_types_allowed
      if (typeof phase.file_types_allowed === 'string') {
        try {
          // Try parsing as JSON first
          allowedTypes = JSON.parse(phase.file_types_allowed).map(type => type.trim().toLowerCase().replace('.', ''));
        } catch (e) {
          // If not JSON, treat as comma-separated string
          allowedTypes = phase.file_types_allowed.split(',').map(type => type.trim().toLowerCase().replace('.', ''));
        }
      } else if (Array.isArray(phase.file_types_allowed)) {
        allowedTypes = phase.file_types_allowed.map(type => type.trim().toLowerCase().replace('.', ''));
      }
      
      const invalidFiles = selectedFiles.filter(file => {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        return !allowedTypes.includes(fileExtension);
      });
      
      if (invalidFiles.length > 0) {
        alert(`Invalid file types detected. Allowed types: ${allowedTypes.join(', ')}`);
        return;
      }
    }

    // Validate file sizes (5MB limit per file)
    const maxSizeBytes = 5 * 1024 * 1024;
    const oversizedFiles = selectedFiles.filter(file => file.size > maxSizeBytes);
    if (oversizedFiles.length > 0) {
      alert('Some files are larger than 5MB. Please compress or choose smaller files.');
      return;
    }

    setFiles(prevFiles => [...prevFiles, ...selectedFiles]);
  };

  const removeFile = (index) => {
    setFiles(prevFiles => prevFiles.filter((_, i) => i !== index));
  };

  const uploadFiles = async () => {
    try {
      // Initialize progress for all files
      const progressInit = {};
      files.forEach(file => {
        progressInit[file.name] = 0;
      });
      setUploadProgress(progressInit);
      
      const formData = new FormData();
      formData.append('phaseId', phase.id);
      
      // Add all files to the same form data
      files.forEach(file => {
        formData.append('files', file); // Note: using 'files' field name for multiple files
      });
      
      const response = await fetch(`${apiConfig.baseURL}/api/student-leader/upload-phase-file`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload files');
      }
      
      const data = await response.json();
      
      // Set all files to 100% progress
      const progressComplete = {};
      files.forEach(file => {
        progressComplete[file.name] = 100;
      });
      setUploadProgress(progressComplete);
      
      console.log('‚úÖ All files uploaded successfully:', data);
      return data.files ? data.files.map(f => f.url) : [];
      
    } catch (error) {
      console.error('Failed to upload files:', error);
      alert(`Failed to upload files: ${error.message}`);
      
      // Set error state for progress
      const progressError = {};
      files.forEach(file => {
        progressError[file.name] = -1;
      });
      setUploadProgress(progressError);
      
      return null;
    }
  };

  const handleSubmit = async () => {
    if (files.length === 0) {
      alert('Please upload at least one file for the deliverable.');
      return;
    }

    setIsSubmitting(true);
    try {
      let fileUrls = [];
      
      // Upload files (required for submissions)
      const uploadedUrls = await uploadFiles();
      if (uploadedUrls === null) {
        setIsSubmitting(false);
        return;
      }
      fileUrls = uploadedUrls;
      
      if (phase.isProjectCompletion) {
        // Handle project completion submission
        await onSubmit(phase.id, {
          submission_text: 'Final Project Completion Submission',
          file_urls: fileUrls,
          isProjectCompletion: true
        });
      } else {
        // Handle regular phase submission
        await onSubmit(phase.id, {
          submission_text: `Phase ${phase.phase_number} Final Deliverable`,
          file_urls: fileUrls
        });
      }
      
      // Clear form after successful submission
      setFiles([]);
      setUploadProgress({});
      setIsExpanded(false);
    } catch (error) {
      // Error handling is done in the parent function
    } finally {
      setIsSubmitting(false);
    }
  };

  const formatFileSize = (bytes) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  return (
    <div className={`phase-card ${getStatusClass()}`}>
      <div className="phase-header" onClick={() => setIsExpanded(!isExpanded)}>
        <div className="phase-info">
          <div className="phase-title">
            {phase.isProjectCompletion ? (
              <>
                <span className="phase-number project-completion-badge">üèÅ Final</span>
                <h3>{phase.title}</h3>
              </>
            ) : (
              <>
                <span className="phase-number">Phase {phase.phase_number}</span>
                <h3>{phase.title}</h3>
              </>
            )}
          </div>
          <div className="phase-meta">
            <span className="phase-date">
              <FaCalendarAlt size={12} />
              {phase.isProjectCompletion ? (
                `Deadline: ${new Date(phase.end_date).toLocaleDateString()}`
              ) : (
                `${new Date(phase.start_date).toLocaleDateString()} - ${new Date(phase.end_date).toLocaleDateString()}`
              )}
            </span>
            {phase.dateRestriction && phase.dateRestriction.message && (
              <div className={`date-restriction-info ${
                phase.dateRestriction.isPastDue ? 'past-due' : 
                phase.dateRestriction.isNotStarted ? 'not-started' : 
                'active'
              }`}>
                {phase.dateRestriction.message}
              </div>
            )}
          </div>
        </div>
        <div className="phase-status">
          {getStatusIcon()}
          <span className="status-text">{phase.status}</span>
          {isSubmissionDisabled() && (
            <FaLock className="disabled-icon" title={getSubmissionDisabledReason()} />
          )}
          <FaChevronDown className={`expand-arrow ${isExpanded ? 'rotated' : ''}`} />
        </div>
      </div>

      {isExpanded && (
        <div className="phase-content">
          {phase.description && (
            <div className="phase-description">
              <h4>Description:</h4>
              <p>{phase.description}</p>
            </div>
          )}

          {phase.file_types_allowed && (
            <div className="file-requirements">
              <h4>File Requirements:</h4>
              <p><strong>Allowed types:</strong> {phase.file_types_allowed}</p>
              <p><strong>Max size:</strong> 5MB per file</p>
            </div>
          )}

          {phase.submission && (
            <div className="existing-submission">
              <h4>Current Submission:</h4>
              <div className="submission-info">
                <p><strong>Submitted:</strong> {new Date(phase.submission.submission_date).toLocaleString()}</p>
                <p><strong>Status:</strong> {phase.submission.status}</p>
                {phase.submission.is_late && (
                  <p><strong>Late Submission</strong> ‚ö†Ô∏è</p>
                )}
                {phase.submission.grade && (
                  <p><strong>Grade:</strong> {phase.submission.grade}%</p>
                )}
                {(() => {
                  // Parse file_urls safely
                  let fileUrls = [];
                  if (phase.submission.file_urls) {
                    try {
                      if (Array.isArray(phase.submission.file_urls)) {
                        fileUrls = phase.submission.file_urls;
                      } else if (typeof phase.submission.file_urls === 'string') {
                        fileUrls = JSON.parse(phase.submission.file_urls);
                      }
                    } catch (e) {
                      console.warn('Failed to parse file_urls:', phase.submission.file_urls);
                      fileUrls = [];
                    }
                  }
                  
                  return fileUrls.length > 0 && (
                    <div className="submitted-files">
                      <strong>Submitted Files:</strong>
                      {fileUrls.map((url, index) => (
                        <a key={index} href={url} target="_blank" rel="noopener noreferrer" className="file-link">
                          <FaFile size={12} />
                          File {index + 1}
                        </a>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          <div className="submission-form">
            <div className="form-group">
              <label>Final Phase Deliverable (Required):</label>
              
              {/* File Upload Card */}
              <div className="file-upload-area">
                <div 
                  className="file-upload-card"
                  onClick={() => fileInputRef.current?.click()}
                >
                  <FaCloudUploadAlt size={32} />
                  <h4>Upload Files</h4>
                  <p>Click to select files or drag and drop</p>
                  {phase.file_types_allowed && (
                    <small>Accepted: {phase.file_types_allowed}</small>
                  )}
                </div>
                
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                  accept={phase.file_types_allowed ? 
                    (() => {
                      let allowedTypes = [];
                      if (typeof phase.file_types_allowed === 'string') {
                        try {
                          allowedTypes = JSON.parse(phase.file_types_allowed);
                        } catch (e) {
                          allowedTypes = phase.file_types_allowed.split(',');
                        }
                      } else if (Array.isArray(phase.file_types_allowed)) {
                        allowedTypes = phase.file_types_allowed;
                      }
                      return allowedTypes.map(type => `.${type.trim().toLowerCase().replace('.', '')}`).join(',');
                    })() : '*'
                  }
                />
              </div>

              {/* Selected Files List */}
              {files.length > 0 && (
                <div className="selected-files">
                  <h5>Selected Files:</h5>
                  {files.map((file, index) => (
                    <div key={index} className="file-item">
                      <div className="file-info">
                        <FaFile size={14} />
                        <span className="file-name">{file.name}</span>
                        <small className="file-size">({formatFileSize(file.size)})</small>
                      </div>
                      
                      {uploadProgress[file.name] !== undefined && (
                        <div className="file-progress">
                          {uploadProgress[file.name] === -1 ? (
                            <span className="upload-error">Error</span>
                          ) : uploadProgress[file.name] === 100 ? (
                            <span className="upload-success"><FaCheck size={12} /></span>
                          ) : (
                            <div className="progress-bar">
                              <div 
                                className="progress-fill" 
                                style={{ width: `${uploadProgress[file.name]}%` }}
                              />
                            </div>
                          )}
                        </div>
                      )}
                      
                      <button
                        type="button"
                        onClick={() => removeFile(index)}
                        className="remove-file-btn"
                        disabled={isSubmitting}
                      >
                        <FaTimes size={12} />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="form-actions">
              {isSubmissionDisabled() ? (
                <div className="disabled-submission-overlay">
                  <div className="disabled-message">
                    <FaLock size={24} />
                    <h4>Submission Not Available</h4>
                    <p>{getSubmissionDisabledReason()}</p>
                    {phase.isProjectCompletion && (
                      <small>Complete all previous phases before submitting the final project.</small>
                    )}
                  </div>
                </div>
              ) : (
                <button
                  className="btn-submit"
                  onClick={handleSubmit}
                  disabled={isSubmitting || files.length === 0}
                >
                  {isSubmitting ? (
                    <>
                      <FaSpinner className="loading-spinner" />
                      {files.length > 0 ? 'Uploading...' : phase.hasSubmission ? 'Updating...' : 'Submitting...'}
                    </>
                  ) : (
                    <>
                      <FaPaperPlane />
                      {phase.isProjectCompletion ? 
                        'Submit Final Project' : 
                        phase.hasSubmission ? 'Update Submission' : 'Submit Phase'
                      }
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// =================== TASK GROUP CARD COMPONENT ===================
const TaskGroupCard = ({ taskGroup, onApprove, onRequestRevision }) => {
  const [selectedAttempt, setSelectedAttempt] = useState(null);
  const [feedbackText, setFeedbackText] = useState('');
  const [submittingAction, setSubmittingAction] = useState(false);

  // Set the first attempt as selected by default
  useEffect(() => {
    if (taskGroup?.attempts && taskGroup.attempts.length > 0 && !selectedAttempt) {
      setSelectedAttempt(taskGroup.attempts[0]);
    }
  }, [taskGroup?.attempts, selectedAttempt]);

  const handleApproveClick = async () => {
    if (!selectedAttempt) return;
    
    setSubmittingAction(true);
    try {
      await onApprove(selectedAttempt.id, feedbackText, selectedAttempt.submission_type || 'original');
      setFeedbackText('');
    } catch (error) {
      console.error('Error approving submission:', error);
    } finally {
      setSubmittingAction(false);
    }
  };

  const handleRequestRevisionClick = async () => {
    if (!selectedAttempt || !feedbackText.trim()) {
      alert('Please provide feedback when requesting revision.');
      return;
    }
    
    setSubmittingAction(true);
    try {
      await onRequestRevision(selectedAttempt.id, feedbackText, selectedAttempt.submission_type || 'original');
      setFeedbackText('');
    } catch (error) {
      console.error('Error requesting revision:', error);
    } finally {
      setSubmittingAction(false);
    }
  };

  // Safety check
  if (!taskGroup || !taskGroup.attempts || !Array.isArray(taskGroup.attempts)) {
    return (
      <div className="task-group-card">
        <div className="task-group-header">
          <div className="task-title-section">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="task-group-card">
      <div className="task-group-header">
        <div className="task-title-section">
          <h3>{taskGroup.task_title || 'Unknown Task'}</h3>
          <div className="task-meta">
            <span className="attempt-count">{taskGroup.attempts.length} Attempt{taskGroup.attempts.length !== 1 ? 's' : ''}</span>
            {taskGroup.is_leader && <span className="leader-badge">Leader</span>}
          </div>
        </div>
        <div className="task-info">
          <div className="info-item">
            <span className="info-label">Member:</span>
            <span className="info-value">{taskGroup.member_name}</span>
          </div>
          <div className="info-item">
            <span className="info-label">Phase:</span>
            <span className="info-value">Phase {taskGroup.phase_number}</span>
          </div>
        </div>
      </div>

      <div className="task-group-content">
        {/* Attempt Selection */}
        <div className="attempt-selection">
          <h4>Select Attempt to Review:</h4>
          <div className="attempt-tabs">
            {Array.isArray(taskGroup.attempts) && taskGroup.attempts.map((attempt, index) => (
              <button
                key={attempt.id || index}
                className={`attempt-tab ${selectedAttempt?.id === attempt.id ? 'active' : ''}`}
                onClick={() => setSelectedAttempt(attempt)}
              >
                <div className="attempt-tab-header">
                  <span className="attempt-type">
                    {attempt.submission_type === 'revision' ? 
                      `Revision ${attempt.revision_number}` : 
                      `Attempt ${attempt.attempt_number}`
                    }
                  </span>
                  <span className={`attempt-status ${attempt.status}`}>
                    {attempt.status === 'pending' ? 'Under Review' :
                     attempt.status === 'approved' ? 'Approved' :
                     attempt.status === 'revision_requested' ? 'Needs Revision' :
                     attempt.status}
                  </span>
                </div>
                <div className="attempt-date">
                  {attempt.submitted_at ? new Date(attempt.submitted_at).toLocaleDateString() : 'Unknown Date'}
                </div>
              </button>
            ))}
          </div>
        </div>

        {/* Selected Attempt Details */}
        {selectedAttempt && (
          <div className="selected-attempt-details">
            <div className="attempt-header">
              <h4>
                {selectedAttempt.submission_type === 'revision' ? 
                  `Revision ${selectedAttempt.revision_number}` : 
                  `Attempt ${selectedAttempt.attempt_number}`
                }
              </h4>
              <div className={`status-badge ${selectedAttempt.status}`}>
                {selectedAttempt.status === 'pending' ? 'Under Review' :
                 selectedAttempt.status === 'approved' ? 'Approved' :
                 selectedAttempt.status === 'revision_requested' ? 'Needs Revision' :
                 selectedAttempt.status}
              </div>
            </div>

            {selectedAttempt.submission_text && (
              <div className="submission-text">
                <h5>Description</h5>
                <p>{selectedAttempt.submission_text}</p>
              </div>
            )}

            {selectedAttempt.files && Array.isArray(selectedAttempt.files) && selectedAttempt.files.length > 0 && (
              <div className="submission-files">
                <h5>Files ({selectedAttempt.files.length})</h5>
                <div className="files-grid">
                  {selectedAttempt.files.map((file, fileIndex) => (
                    <div key={fileIndex} className="file-item">
                      <FaFileAlt className="file-icon" />
                      <span className="file-name">{file.filename || file}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {selectedAttempt.status === 'pending' && (
              <div className="submission-actions">
                <div className="feedback-section">
                  <label>Feedback:</label>
                  <textarea
                    placeholder="Add your feedback here..."
                    rows="3"
                    className="feedback-textarea"
                    value={feedbackText}
                    onChange={(e) => setFeedbackText(e.target.value)}
                  />
                </div>
                
                <div className="action-buttons">
                  <button 
                    className="btn btn-approve"
                    onClick={handleApproveClick}
                    disabled={submittingAction}
                  >
                    {submittingAction ? (
                      <><FaSpinner className="spinning" /> Processing...</>
                    ) : (
                      <><FaCheck /> Approve This Attempt</>
                    )}
                  </button>
                  <button 
                    className="btn btn-revision"
                    onClick={handleRequestRevisionClick}
                    disabled={submittingAction}
                  >
                    {submittingAction ? (
                      <><FaSpinner className="spinning" /> Processing...</>
                    ) : (
                      <><FaEdit /> Request Revision</>
                    )}
                  </button>
                </div>
              </div>
            )}

            {selectedAttempt.status === 'revision_requested' && selectedAttempt.review_comments && (
              <div className="revision-feedback">
                <h5>Revision Request</h5>
                <p>{selectedAttempt.review_comments}</p>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// =================== SUBMISSION REVIEW RENDER ===================


  // ‚úÖ Simplified My Group - Header controls moved to top
  // Member card component
  // Member rectangle component - VERTICAL rectangles
  const MemberCard = ({ member, isCurrentUser, isLeader }) => {
      return (
      <div 
        style={{
          width: '150px',
          height: '265px',
          backgroundColor: isCurrentUser ? 'rgba(95, 24, 45, 0.48)' : 'rgb(13 28 72 / 46%)',
          borderRadius: '15px',
          padding: '15px',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          cursor: 'pointer',
          transition: '0.3s',
          boxShadow: 'rgba(0, 0, 0, 0.1) 0px 2px 8px',
          border: '0.2px solid rgb(255, 255, 255)',
          transform: 'translateY(0px)'
        }}
             onMouseOver={(e) => {
               e.currentTarget.style.transform = 'translateY(-4px)';
               e.currentTarget.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
             }}
             onMouseOut={(e) => {
               e.currentTarget.style.transform = 'translateY(0px)';
               e.currentTarget.style.boxShadow = 'rgba(0, 0, 0, 0.1) 0px 2px 8px';
             }}
                  onClick={() => {
          console.log('Member clicked:', member.name || member.full_name);
          // TODO: Add member click functionality
        }}
      >
        {/* Profile Image - Large and centered */}
        <div style={{
          width: '75px',
          height: '75px',
          backgroundColor: '#F3F4F6',
          borderRadius: '50%',
          marginBottom: '20px',
          overflow: 'hidden',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          position: 'relative',
          border: isLeader ? '3px solid white' : 'none',
          flexShrink: 0
        }}>
          {member.profile_image_url ? (
            <img
              src={member.profile_image_url}
              alt={member.name || 'Member'}
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover',
                borderRadius: '50%',
                display: 'block'
              }}
              onError={(e) => {
                e.target.style.display = 'none';
                e.target.nextSibling.style.display = 'flex';
              }}
            />
          ) : null}
          <div style={{
            width: '100%',
            height: '100%',
            display: member.profile_image_url ? 'none' : 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            backgroundColor: '#F3F4F6',
            color: '#6B7280',
            fontSize: '24px',
            fontWeight: '600',
            borderRadius: '50%'
          }}>
            {member.name ? member.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?'}
                        </div>
          {isCurrentUser && (
            <div style={{
              position: 'absolute',
              top: '-5px',
              right: '-5px',
              width: '20px',
              height: '20px',
              backgroundColor: '#34656c',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'white',
              fontSize: '12px',
              fontWeight: 'bold',
              border: '3px solid white'
            }}>‚úì</div>
          )}
              </div>

        {/* Name and Position - Clean typography */}
        <div style={{ textAlign: 'center', flex: 1, display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
          <h3 style={{
            margin: '0 0 12px 0',
            fontSize: '16px',
            fontWeight: '600',
            color: 'white',
            lineHeight: '1.3'
          }}>
            {member.name || member.full_name || 'Unknown'}
          </h3>
          <p style={{
            margin: '0 0 20px 0',
            fontSize: '13px',
            color: 'white',
            fontWeight: '500',
            lineHeight: '1.4'
          }}>
            {isLeader ? 'Leader' : 'Member'}
          </p>
          
               {/* View button with eye icon */}
               <div style={{
                 display: 'flex',
                 alignItems: 'center',
                 justifyContent: 'center',
                 gap: '6px',
                 color: 'white',
                 fontSize: '12px',
                 fontWeight: '500',
                 cursor: 'pointer',
                 marginTop: 'auto',
                 paddingTop: '10px'
               }}
               onClick={(e) => {
                 e.stopPropagation();
                 console.log('View member clicked:', member.name || member.full_name);
                 // TODO: Add view member functionality
               }}>
                 <FaEye style={{ fontSize: '14px' }} />
                 <span>View</span>
                       </div>
                       </div>
                     </div>
    );
  };

  const renderMyGroup = () => {
    if (!groupData || !groupData.group_id) {
      return (
        <div className="my-group" style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          width: '100%',
          backgroundColor: 'transparent'
        }}>
          <div style={{
            textAlign: 'center',
            color: '#ffffff',
            padding: '20px'
          }}>
            <h2 style={{ 
              fontSize: '1.5rem', 
              fontWeight: '600', 
              marginBottom: '0.5rem',
              color: '#ffffff',
              WebkitTextFillColor: '#ffffff'
            }}>My Group</h2>
            <p style={{ 
              fontSize: '1rem', 
              color: '#ffffff',
              WebkitTextFillColor: '#ffffff',
              opacity: 0.9
            }}>You are not assigned to a group yet.</p>
          </div>
        </div>
      );
    }

    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    const currentUserId = currentUser.id || currentUser.student_id;

    const membersToUse = sortedGroupMembers.length > 0 ? sortedGroupMembers : groupMembers;
    const membersPerPage = 3; // Changed from 5 to 3
    const totalPages = Math.ceil(membersToUse.length / membersPerPage);
    const startIndex = currentMemberPage * membersPerPage;
    const endIndex = startIndex + membersPerPage;
    const currentMembers = membersToUse.slice(startIndex, endIndex);

        return (
          <div className="my-group" style={{ minHeight: '100vh', padding: '50px'}}>
            {/* Content based on active tab */}
            {activeGroupTab === 'overview' && (
              <>
                {/* Cards Row */}
                <div style={{
                  display: 'flex',
                  gap: '20px',
                  marginBottom: '20px'
                }}>
            {/* Members Card */}
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            padding: '20px',
            flex: 1.2,
            minHeight: '300px'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <h2 style={{
              color: 'white',
              fontSize: '24px',
              fontWeight: '600',
              margin: '-7px 0 13px',
              textAlign: 'left'
            }}>
              Members
            </h2>
            
            {/* Member Cards Carousel */}
            <div style={{ position: 'relative', width: '100%', zIndex: 10 }}>
              <div style={{
                display: 'flex',
                gap: '10px',
                justifyContent: 'flex-start',
                alignItems: 'start',
                width: '100%',
                minHeight: '170px',
                overflow: 'hidden'
              }}>
                {loadingMembers ? (
                  <div style={{ textAlign: 'center', color: '#504B38', width: '100%' }}>
                    Loading members...
                  </div>
                ) : membersToUse.length > 0 ? (
                  currentMembers.map((member, index) => {
                    const isCurrentUser = (member.id || member.student_id) === currentUserId;
                    const isLeader = member.role === 'leader' || member.is_leader;

                    return (
                      <MemberCard
                        key={member.id || member.student_id || index}
                        member={member}
                        isCurrentUser={isCurrentUser}
                        isLeader={isLeader}
                      />
                    );
                  })
                ) : (
                  <div style={{ textAlign: 'center', color: '#504B38', width: '100%' }}>
                    No group members found
                  </div>
                )}
              </div>
              
              {/* Glass Navigation Buttons - Show when more than 3 members */}
              {membersToUse.length > 3 && totalPages > 1 && (
                <>
                  {/* Left Navigation Button */}
                  {currentMemberPage > 0 && (
                    <button 
                      onClick={() => setCurrentMemberPage(Math.max(0, currentMemberPage - 1))}
                      style={{
                        position: 'absolute',
                        left: '-15px',
                        top: '50%',
                        transform: 'translateY(-50%)',
                        width: '40px',
                        height: '80px',
                        background: 'rgba(255, 255, 255, 0.1)',
                        backdropFilter: 'blur(10px)',
                        WebkitBackdropFilter: 'blur(10px)',
                        border: '1px solid rgba(255, 255, 255, 0.2)',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '20px',
                        fontWeight: 'bold',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.3s ease',
                        zIndex: 10,
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                        e.currentTarget.style.transform = 'translateY(-50%) translateX(-2px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                        e.currentTarget.style.transform = 'translateY(-50%)';
                      }}
                    >
                      &lt;
                    </button>
                  )}

                  {/* Right Navigation Button */}
                  {currentMemberPage < totalPages - 1 && (
                    <button 
                      onClick={() => setCurrentMemberPage(Math.min(totalPages - 1, currentMemberPage + 1))}
                      style={{
                        position: 'absolute',
                        right: '-15px',
                        top: '50%',
                        transform: 'translateY(-50%)',
                        width: '40px',
                        height: '80px',
                        background: 'rgba(255, 255, 255, 0.1)',
                        backdropFilter: 'blur(10px)',
                        WebkitBackdropFilter: 'blur(10px)',
                        border: '1px solid rgba(255, 255, 255, 0.2)',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '20px',
                        fontWeight: 'bold',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.3s ease',
                        zIndex: 10,
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.2)';
                        e.currentTarget.style.transform = 'translateY(-50%) translateX(2px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)';
                        e.currentTarget.style.transform = 'translateY(-50%)';
                      }}
                    >
                      &gt;
                    </button>
                  )}
                </>
              )}
            </div>
                </div>

          {/* Group Info Card */}
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            padding: '20px',
            flex: 0.6,
            minHeight: '300px'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <h2 style={{
              color: 'white',
              fontSize: '20px',
              fontWeight: '600',
              margin: '-7px 0px 13px',
              textAlign: 'left'
            }}>
              Group Info
            </h2>
            
            <div style={{
              backgroundColor: 'white',
              border: 'none',
              borderRadius: '8px',
              padding: '0',
              minHeight: '257px'
            }}>
              {/* Crosshair Layout - 4 Corners */}
              <div style={{
                position: 'relative',
                height: '257px',
                marginBottom: '0',
                marginTop: '0'
              }}>
                {/* Crosshair Lines - Removed */}

                {/* Top Left - Group Number */}
                <div style={{
                  position: 'absolute',
                  top: '0',
                  left: '0',
                  right: '50%',
                  bottom: '50%',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '12px'
                }}>
                  <FaUsers style={{ fontSize: '20px', color: '#872341', marginBottom: '6px' }} />
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827', marginBottom: '2px' }}>
                    {groupData?.group_name || 'N/A'}
                  </div>
                  <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '500', textAlign: 'center' }}>
                    Group
                  </div>
                </div>
                
                {/* Top Right - Current User's Position/Role */}
                <div style={{
                  position: 'absolute',
                  top: '0',
                  left: '50%',
                  right: '0',
                  bottom: '50%',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '12px'
                }}>
                  <FaUserTie style={{ fontSize: '20px', color: '#872341', marginBottom: '6px' }} />
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827', marginBottom: '2px', textTransform: 'capitalize' }}>
                    {groupData?.role || userRole || 'Member'}
                  </div>
                  <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '500', textAlign: 'center' }}>
                    Your Role
                  </div>
                </div>

                {/* Bottom Left - Members Count */}
                <div style={{
                  position: 'absolute',
                  top: '50%',
                  left: '0',
                  right: '50%',
                  bottom: '0',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '12px'
                }}>
                  <FaUser style={{ fontSize: '20px', color: '#872341', marginBottom: '6px' }} />
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827', marginBottom: '2px' }}>
                    {groupData?.members?.length || 0} / {groupData?.max_members || groupData?.members?.length || 0}
                  </div>
                  <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '500', textAlign: 'center' }}>
                    Members
                  </div>
                </div>
                
                {/* Bottom Right - Created/Assigned Date */}
                <div style={{
                  position: 'absolute',
                  top: '50%',
                  left: '50%',
                  right: '0',
                  bottom: '0',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '12px'
                }}>
                  <FaCalendarAlt style={{ fontSize: '20px', color: '#872341', marginBottom: '6px' }} />
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827', marginBottom: '2px', textAlign: 'center' }}>
                    {groupData?.assigned_at ? new Date(groupData.assigned_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}
                  </div>
                  <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '500', textAlign: 'center' }}>
                    Assigned On
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Group Stats Card */}
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            padding: '20px',
            flex: 1.2,
            minHeight: '300px'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <h2 style={{
              color: 'white',
              fontSize: '24px',
              fontWeight: '600',
              margin: '-7px 0px 13px',
              textAlign: 'left'
            }}>
              Group Stats
            </h2>
            
            <div style={{
              backgroundColor: 'white',
              border: 'none',
              borderRadius: '8px',
              padding: '0',
              minHeight: '257px',
              display: 'flex',
              overflow: 'hidden'
            }}>
              {/* Left Section - 3 Clickable Buttons - 35% narrower */}
              <div style={{
                flex: 0.65,
                display: 'flex',
                flexDirection: 'column',
                borderRight: 'none'
              }}>
                <button
                  onClick={() => setSelectedGroupStat('grade')}
                  style={{
                    flex: 1,
                    backgroundColor: selectedGroupStat === 'grade' ? '#6d1d34' : '#872341',
                    color: 'white',
                    border: 'none',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '4px',
                    margin: 0,
                    padding: '8px'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#6d1d34'}
                  onMouseOut={(e) => e.currentTarget.style.backgroundColor = selectedGroupStat === 'grade' ? '#6d1d34' : '#872341'}
                >
                  <FaChartLine style={{ fontSize: '16px' }} />
                  <span style={{ textAlign: 'center', lineHeight: '1.2' }}>
                    Group Grade<br/>Average
                  </span>
                </button>
                
                <button
                  onClick={() => setSelectedGroupStat('completion')}
                  style={{
                    flex: 1,
                    backgroundColor: selectedGroupStat === 'completion' ? '#6d1d34' : '#872341',
                    color: 'white',
                    border: 'none',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '4px',
                    margin: 0,
                    padding: '8px'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#6d1d34'}
                  onMouseOut={(e) => e.currentTarget.style.backgroundColor = selectedGroupStat === 'completion' ? '#6d1d34' : '#872341'}
                >
                  <FaTasks style={{ fontSize: '16px' }} />
                  <span style={{ textAlign: 'center', lineHeight: '1.2' }}>
                    Task Completion<br/>Rate
                  </span>
                </button>
                
                <button
                  onClick={() => setSelectedGroupStat('activity')}
                  style={{
                    flex: 1,
                    backgroundColor: selectedGroupStat === 'activity' ? '#6d1d34' : '#872341',
                    color: 'white',
                    border: 'none',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '4px',
                    margin: 0,
                    padding: '8px'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#6d1d34'}
                  onMouseOut={(e) => e.currentTarget.style.backgroundColor = selectedGroupStat === 'activity' ? '#6d1d34' : '#872341'}
                >
                  <FaUserCheck style={{ fontSize: '16px' }} />
                  <span style={{ textAlign: 'center', lineHeight: '1.2' }}>
                    Submission<br/>Activity
                  </span>
                </button>
              </div>

              {/* Right Section - Display stats based on selected button */}
              <div style={{
                flex: 1.35,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '20px',
                backgroundColor: '#f9fafb'
              }}>
                {groupStatsLoading ? (
                  <div style={{ textAlign: 'center', color: '#6B7280' }}>
                    <div className="spinner-border spinner-border-sm" role="status" style={{ marginBottom: '10px' }}>
                      <span className="sr-only">Loading...</span>
                    </div>
                    <div>Loading stats...</div>
                  </div>
                ) : selectedGroupStat === 'grade' ? (
                  <div style={{ width: '100%', display: 'flex', gap: '15px' }}>
                    {/* Phase Grade Average */}
                    <div style={{
                      flex: 1,
                      backgroundColor: 'white',
                      border: '2px solid #872341',
                      borderRadius: '12px',
                      padding: '20px',
                      textAlign: 'center',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center'
                    }}>
                      <div style={{
                        fontSize: '13px',
                        color: '#6B7280',
                        fontWeight: '600',
                        marginBottom: '12px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                      }}>
                        Phase Grade Average
                      </div>
                      <div style={{
                        fontSize: '42px',
                        fontWeight: '700',
                        color: '#872341',
                        marginBottom: '5px'
                      }}>
                        {groupStats.phaseGradeAverage !== null
                          ? groupStats.phaseGradeAverage.toFixed(1)
                          : 'N/A'}
                      </div>
                      {groupStats.phaseGradeAverage !== null && (
                        <div style={{
                          fontSize: '11px',
                          color: '#9CA3AF',
                          fontStyle: 'italic'
                        }}>
                          out of 100
                        </div>
                      )}
                    </div>

                    {/* Project Grade Average */}
                    <div style={{
                      flex: 1,
                      backgroundColor: 'white',
                      border: '2px solid #872341',
                      borderRadius: '12px',
                      padding: '20px',
                      textAlign: 'center',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center'
                    }}>
                      <div style={{
                        fontSize: '13px',
                        color: '#6B7280',
                        fontWeight: '600',
                        marginBottom: '12px',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                      }}>
                        Project Grade Average
                      </div>
                      <div style={{
                        fontSize: '42px',
                        fontWeight: '700',
                        color: '#872341',
                        marginBottom: '5px'
                      }}>
                        {groupStats.projectGradeAverage !== null
                          ? groupStats.projectGradeAverage.toFixed(1)
                          : 'N/A'}
                      </div>
                      {groupStats.projectGradeAverage !== null && (
                        <div style={{
                          fontSize: '11px',
                          color: '#9CA3AF',
                          fontStyle: 'italic'
                        }}>
                          out of 100
                        </div>
                      )}
                    </div>
                  </div>
                ) : selectedGroupStat === 'completion' ? (
                  <div style={{
                    width: '100%',
                    backgroundColor: 'white',
                    border: '2px solid #872341',
                    borderRadius: '12px',
                    padding: '25px',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '13px',
                      color: '#6B7280',
                      fontWeight: '600',
                      marginBottom: '15px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px'
                    }}>
                      Task Completion Rate
                    </div>
                    <div style={{
                      fontSize: '48px',
                      fontWeight: '700',
                      color: '#872341',
                      marginBottom: '8px'
                    }}>
                      {groupStats.taskCompletionRate !== null
                        ? `${groupStats.taskCompletionRate.toFixed(0)}%`
                        : 'N/A'}
                    </div>
                    <div style={{
                      fontSize: '14px',
                      color: '#6B7280',
                      marginTop: '10px'
                    }}>
                      {groupStats.completedTasks} of {groupStats.totalTasks} tasks completed
                    </div>
                  </div>
                ) : selectedGroupStat === 'activity' ? (
                  <div style={{
                    width: '100%',
                    backgroundColor: 'white',
                    border: '2px solid #872341',
                    borderRadius: '12px',
                    padding: '20px'
                  }}>
                    <div style={{
                      fontSize: '13px',
                      color: '#6B7280',
                      fontWeight: '600',
                      marginBottom: '15px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      textAlign: 'center'
                    }}>
                      Submission Activity
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '10px',
                        backgroundColor: '#f9fafb',
                        borderRadius: '6px'
                      }}>
                        <span style={{ fontSize: '14px', color: '#374151', fontWeight: '500' }}>Total Submissions:</span>
                        <span style={{ fontSize: '18px', fontWeight: '700', color: '#872341' }}>
                          {groupStats.submissionActivity.totalSubmissions}
                        </span>
                      </div>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '10px',
                        backgroundColor: '#f0fdf4',
                        borderRadius: '6px'
                      }}>
                        <span style={{ fontSize: '14px', color: '#374151', fontWeight: '500' }}>On-Time Submissions:</span>
                        <span style={{ fontSize: '18px', fontWeight: '700', color: '#10b981' }}>
                          {groupStats.submissionActivity.onTimeSubmissions}
                        </span>
                      </div>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '10px',
                        backgroundColor: '#fef3c7',
                        borderRadius: '6px'
                      }}>
                        <span style={{ fontSize: '14px', color: '#374151', fontWeight: '500' }}>Late Submissions:</span>
                        <span style={{ fontSize: '18px', fontWeight: '700', color: '#f59e0b' }}>
                          {groupStats.submissionActivity.lateSubmissions}
                        </span>
                      </div>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '10px',
                        backgroundColor: '#fee2e2',
                        borderRadius: '6px'
                      }}>
                        <span style={{ fontSize: '14px', color: '#374151', fontWeight: '500' }}>Pending:</span>
                        <span style={{ fontSize: '18px', fontWeight: '700', color: '#ef4444' }}>
                          {groupStats.submissionActivity.pendingSubmissions}
                        </span>
                      </div>
                    </div>
                  </div>
                ) : null}
              </div>
            </div>
          </div>
                </div>

                {/* Recent Feedbacks and Recent Submissions Row */}
                <div style={{
                  display: 'flex',
                  gap: '20px',
                  marginTop: '20px'
                }}>
                  {/* Recent Feedbacks Card */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid #5f5f5f',        
               
                    borderRadius: '0px',
                    padding: '20px',
                    flex: 1,
                    minHeight: '400px',
                    maxHeight: '400px',
                    display: 'flex',
                    flexDirection: 'column'
                  }}>
                    <div className="crosshair-corner top-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner top-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <h2 style={{
                      color: 'white',
                      fontSize: '20px',
                      fontWeight: '600',
                      margin: '-7px 0px 13px',
                      textAlign: 'left'
                    }}>
                      Recent Feedbacks
                    </h2>
                    
                    <div style={{
                      padding: '12px',
                      flex: 1,
                      overflowY: 'auto'
                    }}>
                      {recentActivityLoading ? (
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          height: '100%',
                          gap: '8px'
                        }}>
                          <div style={{
                            width: '20px',
                            height: '20px',
                            border: '3px solid #DDD',
                            borderTop: '3px solid #34656D',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                          }} />
                          <p style={{
                            color: '#6B7280',
                            fontSize: '14px',
                            margin: 0
                          }}>
                            Loading...
                          </p>
                        </div>
                      ) : recentFeedbacks && recentFeedbacks.length > 0 ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {recentFeedbacks.map((feedback, index) => (
                            <button
                              key={index}
                              onClick={async () => {
                                // Switch to Activities tab first
                                setActiveGroupTab('activities');
                                
                                // Navigate to this feedback in Feedback View
                                console.log('Navigating to feedback:', feedback);
                                
                                // 1. Switch to Feedback View
                                setActivitiesView('feedbackView');
                                
                                // 2. Find and select the project
                                const project = activeProjects.find(p => p.id === feedback.project_id);
                                if (project) {
                                  setSelectedActivitiesProject(project);
                                  
                                  // 3. Load project data and select phase
                                  const projectData = await loadActivitiesProjectData(project.id);
                                  if (projectData && projectData.phases) {
                                    setActivitiesPhases(projectData.phases);
                                    
                                    const phase = projectData.phases.find(ph => ph.id === feedback.phase_id);
                                    if (phase) {
                                      setSelectedActivitiesPhase(phase);
                                      
                                      // 4. Load submissions for this phase
                                      await loadGroupTaskSubmissions(phase.id, project);
                                      
                                      // 5. Find and select the task submission (wait a bit for state to update)
                                      setTimeout(() => {
                                        setGroupTaskSubmissions(prev => {
                                          const taskSub = prev.find(ts => ts.task_id === feedback.task_id);
                                          if (taskSub) {
                                            handleTaskSubmissionClick(taskSub);
                                            
                                            // 6. Scroll to the three-column section
                                            setTimeout(() => {
                                              const feedbackSection = document.querySelector('[data-feedback-columns]');
                                              if (feedbackSection) {
                                                feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                              }
                                            }, 100);
                                          }
                                          return prev;
                                        });
                                      }, 500);
                                    }
                                  }
                                }
                              }}
                              style={{
                                padding: '10px 14px',
                                backgroundColor: 'rgb(255 255 255)',
                                border: 'none',
                                borderRadius: '10px',
                                textAlign: 'left',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '4px'
                              }}
                              onMouseOver={(e) => {
                                e.currentTarget.style.transform = 'translateX(4px)';
                                e.currentTarget.style.boxShadow = '0 2px 8px rgba(252, 211, 77, 0.3)';
                              }}
                              onMouseOut={(e) => {
                                e.currentTarget.style.transform = 'translateX(0)';
                                e.currentTarget.style.boxShadow = 'none';
                              }}
                            >
                              {/* Feedback text - main content */}
                              <div style={{ 
                                fontSize: '13px', 
                                color: '#1F2937',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'flex-start',
                                gap: '8px'
                              }}>
                                <FaCommentAlt style={{ fontSize: '14px', color: '#872341', marginTop: '2px', flexShrink: 0 }} />
                                <span style={{
                                  display: '-webkit-box',
                                  WebkitLineClamp: 2,
                                  WebkitBoxOrient: 'vertical',
                                  overflow: 'hidden'
                                }}>
                                  "{feedback.feedback_text}"
                                </span>
                              </div>
                              
                              {/* Meta info in one line */}
                              <div style={{ 
                                fontSize: '11px', 
                                color: '#6B7280',
                                display: 'flex',
                                flexWrap: 'wrap',
                                gap: '8px',
                                alignItems: 'center',
                                marginLeft: '22px'
                              }}>
                                <span style={{ fontWeight: '600', color: '#872341', display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                  <FaUser style={{ fontSize: '9px' }} />
                                  {feedback.feedback_by_name}
                                </span>
                                <span>‚Üí</span>
                                <span style={{ fontWeight: '500', color: '#6B7280', display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                  <FaFileAlt style={{ fontSize: '9px' }} />
                                  {feedback.submitted_by_name}'s submission
                                </span>
                                <span>‚Ä¢</span>
                                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                  <FaClock style={{ fontSize: '9px' }} />
                                  {new Date(feedback.created_at).toLocaleDateString()}
                                </span>
                              </div>
                              
                              {/* Project/Phase badges */}
                              <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap', marginTop: '4px', marginLeft: '22px' }}>
                                <span style={{
                                  fontSize: '10px',
                                  padding: '3px 8px',
                                  backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                  color: '#872341',
                                  borderRadius: '6px',
                                  fontWeight: '600',
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  gap: '4px'
                                }}>
                                  <FaProjectDiagram style={{ fontSize: '9px' }} />
                                  {feedback.project_title}
                                </span>
                                <span style={{
                                  fontSize: '10px',
                                  padding: '3px 8px',
                                  backgroundColor: 'rgba(135, 35, 65, 0.08)',
                                  color: '#A8304A',
                                  borderRadius: '6px',
                                  fontWeight: '600',
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  gap: '4px'
                                }}>
                                  <FaTasks style={{ fontSize: '9px' }} />
                                  {feedback.phase_title}
                                </span>
                              </div>
                            </button>
                          ))}
                        </div>
                      ) : (
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          height: '100%'
                        }}>
                          <p style={{
                            color: '#9CA3AF',
                            fontSize: '14px',
                            fontStyle: 'italic',
                            textAlign: 'center'
                          }}>
                            No recent feedbacks to display
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Recent Submissions Card */}
                  <div className="my-group-card-with-crosshair" style={{
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid #5f5f5f',
                    borderRadius: '0px',
                    padding: '20px',
                    flex: 1,
                    minHeight: '400px',
                    maxHeight: '400px',
                    display: 'flex',
                    flexDirection: 'column'
                  }}>
                    <div className="crosshair-corner top-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner top-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <h2 style={{
                      color: 'white',
                      fontSize: '20px',
                      fontWeight: '600',
                      margin: '-7px 0px 13px',
                      textAlign: 'left'
                    }}>
                      Recent Submissions
                    </h2>
                    
                    <div style={{
                      padding: '12px',
                      flex: 1,
                      overflowY: 'auto'
                    }}>
                      {recentActivityLoading ? (
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          height: '100%',
                          gap: '8px'
                        }}>
                          <div style={{
                            width: '20px',
                            height: '20px',
                            border: '3px solid #DDD',
                            borderTop: '3px solid #34656D',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                          }} />
                          <p style={{
                            color: '#6B7280',
                            fontSize: '14px',
                            margin: 0
                          }}>
                            Loading...
                          </p>
                        </div>
                      ) : recentSubmissions && recentSubmissions.length > 0 ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {recentSubmissions.map((submission, index) => {
                            return (
                              <button
                                key={index}
                                onClick={async () => {
                                  // Switch to Activities tab first
                                  setActiveGroupTab('activities');
                                  
                                  // Navigate to this submission in Feedback View
                                  console.log('Navigating to submission:', submission);
                                  
                                  // 1. Switch to Feedback View
                                  setActivitiesView('feedbackView');
                                  
                                  // 2. Find and select the project
                                  const project = activeProjects.find(p => p.id === submission.project_id);
                                  if (project) {
                                    setSelectedActivitiesProject(project);
                                    
                                    // 3. Load project data and select phase
                                    const projectData = await loadActivitiesProjectData(project.id);
                                    if (projectData && projectData.phases) {
                                      setActivitiesPhases(projectData.phases);
                                      
                                      const phase = projectData.phases.find(ph => ph.id === submission.phase_id);
                                      if (phase) {
                                        setSelectedActivitiesPhase(phase);
                                        
                                        // 4. Load submissions for this phase
                                        await loadGroupTaskSubmissions(phase.id, project);
                                        
                                        // 5. Find and select the task submission (wait a bit for state to update)
                                        setTimeout(() => {
                                          setGroupTaskSubmissions(prev => {
                                            const taskSub = prev.find(ts => ts.task_id === submission.task_id);
                                            if (taskSub) {
                                              handleTaskSubmissionClick(taskSub);
                                              
                                              // 6. Scroll to the three-column section
                                              setTimeout(() => {
                                                const feedbackSection = document.querySelector('[data-feedback-columns]');
                                                if (feedbackSection) {
                                                  feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                }
                                              }, 100);
                                            }
                                            return prev;
                                          });
                                        }, 500);
                                      }
                                    }
                                  }
                                }}
                                style={{
                                  padding: '10px 14px',
                                  backgroundColor: 'rgb(255 255 255)',
                                  border: 'none',
                                  borderRadius: '10px',
                                  textAlign: 'left',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: '4px'
                                }}
                                onMouseOver={(e) => {
                                  e.currentTarget.style.transform = 'translateX(4px)';
                                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(252, 211, 77, 0.3)';
                                }}
                                onMouseOut={(e) => {
                                  e.currentTarget.style.transform = 'translateX(0)';
                                  e.currentTarget.style.boxShadow = 'none';
                                }}
                              >
                                {/* Task title - main content */}
                                <div style={{ 
                                  fontSize: '13px', 
                                  color: '#1F2937',
                                  fontWeight: '600',
                                  display: 'flex',
                                  alignItems: 'flex-start',
                                  gap: '8px'
                                }}>
                                  <FaFileAlt style={{ fontSize: '14px', color: '#872341', marginTop: '2px', flexShrink: 0 }} />
                                  <span style={{
                                    display: '-webkit-box',
                                    WebkitLineClamp: 2,
                                    WebkitBoxOrient: 'vertical',
                                    overflow: 'hidden'
                                  }}>
                                    {submission.task_title}
                                  </span>
                                </div>
                                
                                {/* Meta info in one line */}
                                <div style={{ 
                                  fontSize: '11px', 
                                  color: '#6B7280',
                                  display: 'flex',
                                  flexWrap: 'wrap',
                                  gap: '8px',
                                  alignItems: 'center',
                                  marginLeft: '22px'
                                }}>
                                  <span style={{ fontWeight: '600', color: '#872341', display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                    <FaUser style={{ fontSize: '9px' }} />
                                    {submission.submitted_by_name}
                                  </span>
                                  <span>‚Ä¢</span>
                                  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', fontWeight: '500' }}>
                                    <FaRedo style={{ fontSize: '9px' }} />
                                    Attempt #{submission.attempt_number}
                                  </span>
                                  <span>‚Ä¢</span>
                                  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                                    <FaClock style={{ fontSize: '9px' }} />
                                    {new Date(submission.submission_date).toLocaleDateString()}
                                  </span>
                                </div>
                                
                                {/* Project/Phase/Status badges */}
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap', marginTop: '4px', marginLeft: '22px' }}>
                                  <span style={{
                                    fontSize: '10px',
                                    padding: '3px 8px',
                                    backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                    color: '#872341',
                                    borderRadius: '6px',
                                    fontWeight: '600',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}>
                                    <FaProjectDiagram style={{ fontSize: '9px' }} />
                                    {submission.project_title}
                                  </span>
                                  <span style={{
                                    fontSize: '10px',
                                    padding: '3px 8px',
                                    backgroundColor: 'rgba(135, 35, 65, 0.08)',
                                    color: '#A8304A',
                                    borderRadius: '6px',
                                    fontWeight: '600',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}>
                                    <FaTasks style={{ fontSize: '9px' }} />
                                    {submission.phase_title}
                                  </span>
                                  <span style={{
                                    fontSize: '10px',
                                    padding: '3px 8px',
                                    backgroundColor: 'rgba(135, 35, 65, 0.15)',
                                    color: '#872341',
                                    borderRadius: '6px',
                                    fontWeight: '600',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}>
                                    {submission.status === 'approved' || submission.status === 'completed' ? (
                                      <>
                                        <FaCheckCircle style={{ fontSize: '9px' }} />
                                        Approved
                                      </>
                                    ) : submission.status === 'pending' ? (
                                      <>
                                        <FaClock style={{ fontSize: '9px' }} />
                                        Pending
                                      </>
                                    ) : submission.status === 'revision_requested' || submission.status === 'to_revise' ? (
                                      <>
                                        <FaRedo style={{ fontSize: '9px' }} />
                                        Revise
                                      </>
                                    ) : submission.status}
                                  </span>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      ) : (
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          height: '100%'
                        }}>
                          <p style={{
                            color: '#9CA3AF',
                            fontSize: '14px',
                            fontStyle: 'italic',
                            textAlign: 'center'
                          }}>
                            No recent submissions to display
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Gantt Chart Timeline Card */}  
               <div className="my-group-card-with-crosshair" style={{
                  background: 'rgba(9, 18, 44, 0.15)',
                  backdropFilter: 'blur(3.2px) saturate(120%)',
                  WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                  border: '0.1px solid #5f5f5f',
                  borderRadius: '12px',
                  padding: '20px',
                  marginTop: '20px',
                  minHeight: '750px', // Increased by 50% from 500px
                  maxHeight: '1200px' // Increased by 50% from 800px
                }}>
                  <div className="crosshair-corner top-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner top-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  {/* Header with Dropdowns */}
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px'
                  }}>
                    <h2 style={{
                      color: 'white',
                      fontSize: '20px',
                      fontWeight: '600',
                      margin: '0'
                    }}>
                      Project Timeline
                    </h2>
                    
                    <div style={{ display: 'flex', gap: '12px' }}>
                      {/* Project Dropdown */}
                      <div className="gantt-project-dropdown" style={{ position: 'relative' }}>
                        <button
                          onClick={() => setShowGanttProjectDropdown(!showGanttProjectDropdown)}
                          style={{
                            padding: '10px 16px',
                            backgroundColor: 'white',
                            border: '1px solid #B9B28A',
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: '500',
                            color: '#504B38',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            minWidth: '200px'
                          }}
                        >
                          <FaProjectDiagram />
                          {selectedGanttProject ? selectedGanttProject.title : 'Select Project'}
                          <FaChevronDown style={{ marginLeft: 'auto' }} />
                        </button>
                        
                        {showGanttProjectDropdown && (
                          <div style={{
                            position: 'absolute',
                            top: '100%',
                            left: '0',
                            minWidth: '200px',
                            backgroundColor: 'white',
                            border: '1px solid #B9B28A',
                            borderRadius: '6px',
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                            zIndex: 1000,
                            marginTop: '4px'
                          }}>
                            {activeProjects.map(project => (
                              <div
                                key={project.id}
                                onClick={async () => {
                                  setSelectedGanttProject(project);
                                  setSelectedGanttPhase(null);
                                  setShowGanttProjectDropdown(false);
                                  // Reset all phases to visible when project changes
                                  const allPhaseIds = new Set(project.project_phases?.map(p => p.id) || []);
                                  setVisiblePhases(allPhaseIds);
                                  await loadGanttProjectData(project.id);
                                }}
                                style={{
                                  padding: '10px 12px',
                                  cursor: 'pointer',
                                  fontSize: '14px',
                                  color: '#504B38',
                                  borderBottom: '1px solid #F3F4F6'
                                }}
                                onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#F3F4F6'}
                                onMouseOut={(e) => e.currentTarget.style.backgroundColor = 'white'}
                              >
                                {project.title}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Gantt Chart */}
                  {selectedGanttProject ? (
                    <div 
                      ref={ganttContainerRef}
                      style={{
                      backgroundColor: 'white',
                      border: '1px solid #B9B28A',
                      borderRadius: '8px',
                      padding: '0',
                      minHeight: '600px',
                      maxHeight: (() => {
                        // Adaptive height based on number of members
                        const memberCount = (groupMembers.length > 0 ? groupMembers : groupData?.members || []).length;
                        const baseHeight = 300;
                        const rowHeight = 70;
                        return `${baseHeight + (memberCount * rowHeight)}px`;
                      })(),
                      overflow: 'hidden', // Changed from auto to hidden to prevent clipping
                      position: 'relative',
                      display: 'flex',
                      flexDirection: 'column'
                    }}>
                      {ganttLoading ? (
                        <div style={{
                          padding: '60px',
                          textAlign: 'center',
                          color: '#6B7280'
                        }}>
                          Loading timeline...
                        </div>
                      ) : (() => {
                        const timelineDays = getGanttTimelineDays();
                        const { start, end } = getGanttDateRange();
                        const hasValidDates = timelineDays.length > 0 && start && end;
                        
                        // Use the container width from component state (measured by useEffect)
                        const DAY_WIDTH = getAdaptiveDayWidth(ganttContainerWidth);
                        const totalWidth = timelineDays.length * DAY_WIDTH;
                        const timelinePixelWidth = Math.max(nameColumnWidth + totalWidth, 0);
                        
                        if (!hasValidDates) {
                          return (
                            <div style={{
                              padding: '60px',
                              textAlign: 'center',
                              color: '#9CA3AF'
                            }}>
                              {selectedGanttPhase ? 
                                `No valid dates found for Phase ${selectedGanttPhase.phase_number}` :
                                'No valid dates found for this project'}
                            </div>
                          );
                        }
                        
                        // Get phase boundaries for indicators (when All Phases selected)
                        const rawPhaseIndicators = !selectedGanttPhase && selectedGanttProject.project_phases ? 
                          selectedGanttProject.project_phases.map(phase => {
                            const phaseStart = new Date(phase.start_date);
                            const phaseEnd = new Date(phase.end_date);
                            phaseStart.setHours(0, 0, 0, 0);
                            phaseEnd.setHours(0, 0, 0, 0);
                            
                            const timelineStart = new Date(start);
                            timelineStart.setHours(0, 0, 0, 0);
                            
                            const startDay = Math.max(0, Math.floor((phaseStart - timelineStart) / (1000 * 60 * 60 * 24)));
                            const duration = Math.ceil((phaseEnd - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
                            
                            return {
                              ...phase,
                              startDay,
                              duration,
                              leftPos: (startDay * DAY_WIDTH) + 4, // Add 4px margin
                              width: (duration * DAY_WIDTH) - 8 // Subtract 8px for margins
                            };
                          }) : [];
                        
                        // Calculate multi-row layout to prevent overlap
                        const phaseIndicatorsWithRows = calculatePhaseRows(rawPhaseIndicators, DAY_WIDTH);
                        
                        // Filter to only show visible phases
                        const phaseIndicators = phaseIndicatorsWithRows.filter(p => visiblePhases.has(p.id));
                        
                        // Calculate total rows needed for phase indicators
                        const maxPhaseRow = phaseIndicators.length > 0 ? Math.max(...phaseIndicators.map(p => p.row)) : -1;
                        const phaseRowCount = maxPhaseRow + 1;
                        const phaseIndicatorHeight = phaseRowCount > 0 ? (phaseRowCount * 36 + 24) : 24; // 36px per row + 24px padding
                        
                        return (
                        <>
                          {/* Phase Toggle Buttons (when All Phases selected) - OUTSIDE SCROLL */}
                          {!selectedGanttPhase && rawPhaseIndicators.length > 1 && (
                            <div style={{
                              padding: '12px 16px',
                              backgroundColor: '#F9FAFB',
                              borderBottom: '1px solid #E5E7EB',
                              display: 'flex',
                              flexWrap: 'wrap',
                              gap: '8px',
                              alignItems: 'center',
                              flexShrink: 0
                            }}>
                              <span style={{
                                fontSize: '12px',
                                fontWeight: '600',
                                color: '#6B7280',
                                marginRight: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                              }}>
                                <FaLayerGroup size={12} />
                                Toggle Phases:
                              </span>
                              {rawPhaseIndicators.map((phase, idx) => {
                                const isVisible = visiblePhases.has(phase.id);
                                const phaseColor = `hsl(${(idx * 60) % 360}, 70%, 55%)`;
                                return (
                                  <button
                                    key={phase.id}
                                    onClick={() => {
                                      const newVisible = new Set(visiblePhases);
                                      if (isVisible) {
                                        newVisible.delete(phase.id);
                                      } else {
                                        newVisible.add(phase.id);
                                      }
                                      setVisiblePhases(newVisible);
                                    }}
                                    style={{
                                      padding: '6px 12px',
                                      backgroundColor: isVisible ? phaseColor : '#E5E7EB',
                                      color: isVisible ? 'white' : '#6B7280',
                                      border: `2px solid ${isVisible ? phaseColor : '#D1D5DB'}`,
                                      borderRadius: '6px',
                                      fontSize: '11px',
                                      fontWeight: '700',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '6px',
                                      opacity: isVisible ? 1 : 0.6
                                    }}
                                    onMouseOver={(e) => {
                                      e.currentTarget.style.transform = 'translateY(-2px)';
                                      e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.transform = 'translateY(0)';
                                      e.currentTarget.style.boxShadow = 'none';
                                    }}
                                    title={isVisible ? 'Click to hide' : 'Click to show'}
                                  >
                                    {isVisible ? <FaEye size={10} /> : <FaEyeSlash size={10} />}
                                    P{phase.phase_number}
                                  </button>
                                );
                              })}
                              <button
                                onClick={() => {
                                  // Toggle all
                                  if (visiblePhases.size === rawPhaseIndicators.length) {
                                    setVisiblePhases(new Set());
                                  } else {
                                    setVisiblePhases(new Set(rawPhaseIndicators.map(p => p.id)));
                                  }
                                }}
                                style={{
                                  padding: '6px 12px',
                                  backgroundColor: '#6B7280',
                                  color: 'white',
                                  border: '2px solid #4B5563',
                                  borderRadius: '6px',
                                  fontSize: '11px',
                                  fontWeight: '700',
                                  cursor: 'pointer',
                                  marginLeft: '8px'
                                }}
                                title={visiblePhases.size === rawPhaseIndicators.length ? 'Hide All' : 'Show All'}
                              >
                                {visiblePhases.size === rawPhaseIndicators.length ? (
                                  <><FaEyeSlash size={11} style={{ marginRight: '6px' }} /> Hide All</>
                                ) : (
                                  <><FaEye size={11} style={{ marginRight: '6px' }} /> Show All</>
                                )}
                              </button>
                            </div>
                          )}
                        
                        {/* Scrollable Gantt Content */}
                        <div 
                          style={{ 
                            minWidth: '100%',
                            position: 'relative',
                            overflowX: 'auto',
                            overflowY: 'auto',
                            flex: 1,
                            maxHeight: '100%',
                            paddingBottom: '4px' // Prevent bottom border clipping - increased from 2px
                          }}
                        >
                          <div style={{ minHeight: '100%' }}>
                          {/* Fixed Header with Sticky Date Column */}
                          <table style={{
                            width: `${timelinePixelWidth}px`,
                            borderCollapse: 'collapse',
                            tableLayout: 'fixed',
                            backgroundColor: 'white'
                          }}>
                            <colgroup>
                              <col style={{ width: `${nameColumnWidth}px` }} />
                              {timelineDays.map((_, index) => (
                                <col key={`col-${index}`} style={{ width: `${DAY_WIDTH}px` }} />
                              ))}
                            </colgroup>
                            <thead>
                              {/* Row 1: Timeline Info Pills (Top) */}
                              <tr style={{ backgroundColor: 'white', borderBottom: '2px solid #E5E7EB' }}>
                                <th style={{
                                  padding: '16px',
                                  fontWeight: '600',
                                  fontSize: '12px',
                                  color: '#6B7280',
                                  textAlign: 'left',
                                  backgroundColor: 'white',
                                  zIndex: 10,
                                  borderRight: 'none'
                                }}>
                                  <div style={{ fontSize: '11px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '700' }}>Timeline Info</div>
                                </th>
                                {/* Project Start - On first date column */}
                                <td style={{
                                  padding: '12px 4px',
                                  textAlign: 'center',
                                  backgroundColor: 'white',
                                  borderRight: 'none',
                                  verticalAlign: 'middle',
                                  width: `${DAY_WIDTH}px`
                                }}>
                                  <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '4px',
                                    backgroundColor: '#10B981',
                                    color: 'white',
                                    padding: '8px 12px',
                                    borderRadius: '16px',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    boxShadow: '0 2px 6px rgba(16, 185, 129, 0.25)',
                                    minHeight: '50px',
                                    justifyContent: 'center'
                                  }}>
                                    <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>START</div>
                                    <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                      {start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </div>
                                  </div>
                                </td>
                                {/* Middle columns - Duration in center */}
                                {timelineDays.slice(1, -1).map((day, idx) => {
                                  const isMiddle = idx === Math.floor((timelineDays.length - 2) / 2);
                                  return (
                                    <td key={`middle-${idx}`} style={{
                                      padding: '12px 4px',
                                      textAlign: 'center',
                                      backgroundColor: 'white',
                                      borderRight: 'none',
                                      verticalAlign: 'middle',
                                      width: `${DAY_WIDTH}px`
                                    }}>
                                      {isMiddle && (
                                        <div style={{
                                          display: 'flex',
                                          flexDirection: 'column',
                                          alignItems: 'center',
                                          gap: '4px',
                                          backgroundColor: '#6B7280',
                                          color: 'white',
                                          padding: '8px 12px',
                                          borderRadius: '16px',
                                          fontSize: '10px',
                                          fontWeight: '600',
                                          boxShadow: '0 2px 6px rgba(107, 114, 128, 0.25)',
                                          minHeight: '50px',
                                          justifyContent: 'center'
                                        }}>
                                          <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>Duration</div>
                                          <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                            {timelineDays.length}d
                                          </div>
                                        </div>
                                      )}
                                    </td>
                                  );
                                })}
                                {/* Project End - On last date column */}
                                <td style={{
                                  padding: '12px 4px',
                                  textAlign: 'center',
                                  backgroundColor: 'white',
                                  borderRight: 'none',
                                  verticalAlign: 'middle',
                                  width: `${DAY_WIDTH}px`
                                }}>
                                  <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '4px',
                                    backgroundColor: '#EF4444',
                                    color: 'white',
                                    padding: '8px 12px',
                                    borderRadius: '16px',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    boxShadow: '0 2px 6px rgba(239, 68, 68, 0.25)',
                                    minHeight: '50px',
                                    justifyContent: 'center'
                                  }}>
                                    <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>END</div>
                                    <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                      {end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </div>
                                  </div>
                                </td>
                              </tr>
                              
                              {/* Row 2: Member Names Header and Date Headers */}
                              <tr style={{ backgroundColor: '#F9FAFB', borderBottom: '1px solid #E5E7EB' }}>
                                <th style={{
                                  padding: '12px 16px',
                                  fontWeight: '600',
                                  fontSize: '13px',
                                  color: '#6B7280',
                                  borderRight: '2px solid #E5E7EB',
                                  textAlign: 'left',
                                  position: 'relative',
                                  backgroundColor: 'white',
                                  zIndex: 10
                                }}>
                                  <div>Group Members</div>
                                  <div style={{ 
                                    fontSize: '10px', 
                                    fontWeight: '500', 
                                    color: '#9CA3AF',
                                    marginTop: '4px'
                                  }}>
                                    {selectedGanttPhase ? 
                                      `Phase ${selectedGanttPhase.phase_number}` : 
                                      'All Phases (Overview)'}
                                  </div>
                                  
                                  {/* Resize Handle */}
                                  <div
                                    onMouseDown={(e) => {
                                      setIsResizing(true);
                                      const startX = e.clientX;
                                      const startWidth = nameColumnWidth;
                                      
                                      const handleMouseMove = (moveEvent) => {
                                        const delta = moveEvent.clientX - startX;
                                        const newWidth = Math.max(150, Math.min(400, startWidth + delta));
                                        setNameColumnWidth(newWidth);
                                      };
                                      
                                      const handleMouseUp = () => {
                                        setIsResizing(false);
                                        document.removeEventListener('mousemove', handleMouseMove);
                                        document.removeEventListener('mouseup', handleMouseUp);
                                      };
                                      
                                      document.addEventListener('mousemove', handleMouseMove);
                                      document.addEventListener('mouseup', handleMouseUp);
                                    }}
                                    style={{
                                      position: 'absolute',
                                      right: '-2px',
                                      top: 0,
                                      bottom: 0,
                                      width: '8px',
                                      cursor: 'col-resize',
                                      backgroundColor: isResizing ? '#3B82F6' : 'transparent',
                                      transition: 'background-color 0.2s',
                                      zIndex: 20
                                    }}
                                    onMouseEnter={(e) => {
                                      if (!isResizing) e.currentTarget.style.backgroundColor = '#E5E7EB';
                                    }}
                                    onMouseLeave={(e) => {
                                      if (!isResizing) e.currentTarget.style.backgroundColor = 'transparent';
                                    }}
                                  />
                                </th>
                                {/* Date Headers */}
                                {timelineDays.map((day, index) => {
                                  const isToday = new Date().toDateString() === day.toDateString();
                                  const isStartDate = day.toDateString() === start.toDateString();
                                  const isEndDate = day.toDateString() === end.toDateString();
                                  
                                  // Clean white background - no gray for weekends
                                  let backgroundColor = 'white';
                                  let textColor = '#6B7280';
                                  
                                  if (isToday) {
                                    backgroundColor = '#872341';
                                    textColor = 'white';
                                  } else if (isStartDate) {
                                    textColor = '#059669';
                                  } else if (isEndDate) {
                                    textColor = '#DC2626';
                                  }
                                  
                                  const dayFontSize = DAY_WIDTH >= 150 ? '16px' : (DAY_WIDTH >= 100 ? '14px' : (DAY_WIDTH >= 70 ? '12px' : '11px'));
                                  const monthFontSize = DAY_WIDTH >= 150 ? '13px' : (DAY_WIDTH >= 100 ? '11px' : (DAY_WIDTH >= 70 ? '10px' : '9px'));
                                  const labelFontSize = DAY_WIDTH >= 150 ? '10px' : (DAY_WIDTH >= 100 ? '9px' : (DAY_WIDTH >= 70 ? '8px' : '7px'));
                                  
                                  return (
                                    <th key={`header-${index}`} style={{
                                      padding: DAY_WIDTH >= 70 ? '10px 4px' : '8px 2px',
                                      textAlign: 'center',
                                      fontSize: dayFontSize,
                                      fontWeight: (isToday || isStartDate || isEndDate) ? '700' : '600',
                                      color: textColor,
                                      borderRight: 'none',
                                      borderBottom: '1px solid #E5E7EB',
                                      backgroundColor: backgroundColor,
                                      width: `${DAY_WIDTH}px`
                                    }}>
                                      <div style={{ 
                                        fontWeight: (isToday || isStartDate || isEndDate) ? '700' : '600',
                                        fontSize: (isToday || isStartDate || isEndDate) ? (DAY_WIDTH >= 150 ? '18px' : (DAY_WIDTH >= 100 ? '16px' : '14px')) : dayFontSize,
                                        color: textColor
                                      }}>
                                        {day.getDate()}
                                      </div>
                                      <div style={{ fontSize: monthFontSize, marginTop: '3px', fontWeight: '500', color: textColor }}>
                                        {day.toLocaleDateString('en-US', { month: 'short' })}
                                      </div>
                                      {isToday && DAY_WIDTH >= 60 && (
                                        <div style={{
                                          fontSize: labelFontSize,
                                          color: 'white',
                                          fontWeight: '700',
                                          marginTop: '3px'
                                        }}>
                                          TODAY
                                        </div>
                                      )}
                                      {isStartDate && !isToday && DAY_WIDTH >= 60 && (
                                        <div style={{
                                          fontSize: labelFontSize,
                                          color: '#059669',
                                          fontWeight: '700',
                                          marginTop: '3px'
                                        }}>
                                          START
                                        </div>
                                      )}
                                      {isEndDate && !isToday && DAY_WIDTH >= 60 && (
                                        <div style={{
                                          fontSize: labelFontSize,
                                          color: '#DC2626',
                                          fontWeight: '700',
                                          marginTop: '3px'
                                        }}>
                                          END
                                        </div>
                                      )}
                                    </th>
                                  );
                                })}
                              </tr>
                            </thead>
                            <tbody>
                          {(() => {
                            // Organize tasks by phase - filter by visiblePhases
                            let phases = selectedGanttProject.project_phases || [];
                            // Filter phases to only show visible ones when not in "All Phases" mode (when some are toggled off)
                            if (visiblePhases.size > 0 && visiblePhases.size < phases.length) {
                              phases = phases.filter(p => visiblePhases.has(p.id));
                            }
                            const tasksByPhase = {};
                            
                            // Initialize phases
                            phases.forEach(phase => {
                              tasksByPhase[phase.id] = [];
                            });
                            
                            // Group tasks by phase
                            ganttTasks.forEach(task => {
                              const phaseId = task.project_phases?.id || task.phase_id || task.project_phase_id;
                              if (phaseId && tasksByPhase[phaseId]) {
                                tasksByPhase[phaseId].push(task);
                              }
                            });
                            
                            // Create member color mapping (different shades of blue)
                            const allMembers = groupMembers.length > 0 ? groupMembers : groupData?.members || [];
                            
                            // Filter members to only show those with tasks in visible phases
                            let visibleMembers = allMembers;
                            if (visiblePhases.size > 0 && visiblePhases.size < phases.length) {
                              const membersWithVisibleTasks = new Set();
                              phases.forEach(phase => {
                                const phaseTasks = tasksByPhase[phase.id] || [];
                                phaseTasks.forEach(task => {
                                  if (task.assigned_to_id || task.assigned_to || task.student_id) {
                                    membersWithVisibleTasks.add(task.assigned_to_id || task.assigned_to || task.student_id);
                                  }
                                });
                              });
                              visibleMembers = allMembers.filter(member => {
                                const memberId = member.id || member.student_id || member.member_id;
                                return membersWithVisibleTasks.has(memberId) || membersWithVisibleTasks.size === 0;
                              });
                            }
                            
                            const memberColorMap = {};
                            visibleMembers.forEach((member, idx) => {
                              const memberId = member.id || member.student_id || member.member_id;
                              // Different shades of blue: from lighter to darker
                              const lightness = 65 - (idx * 8); // 65%, 57%, 49%, 41%, etc.
                              memberColorMap[memberId] = `hsl(210, 85%, ${Math.max(35, lightness)}%)`;
                            });
                            
                            // Render phases and their tasks
                            const rows = [];
                            
                            // Helper: Create cells for a row
                            const createRowCells = (contentElements) => {
                              const cells = [];
                              contentElements.forEach(({ dayIndex, content }) => {
                                // Create empty cells before this content
                                while (cells.length < dayIndex) {
                                  cells.push(
                                    <td key={`empty-${cells.length}`} style={{
                                      width: `${DAY_WIDTH}px`,
                                      padding: '8px 4px',
                                      verticalAlign: 'middle',
                                      backgroundColor: 'white',
                                      borderRight: '2px solid #D1D5DB',
                                      borderBottom: '1px solid #E5E7EB'
                                    }}></td>
                                  );
                                }
                                // Add content cell
                                cells.push(
                                  <td key={`content-${dayIndex}`} style={{
                                    width: `${DAY_WIDTH}px`,
                                    padding: '8px 4px',
                                    verticalAlign: 'middle',
                                    backgroundColor: 'white',
                                    borderRight: '2px solid #D1D5DB',
                                    borderBottom: '1px solid #E5E7EB',
                                    position: 'relative'
                                  }}>
                                    {content}
                                  </td>
                                );
                              });
                              // Fill remaining cells
                              while (cells.length < timelineDays.length) {
                                cells.push(
                                  <td key={`empty-${cells.length}`} style={{
                                    width: `${DAY_WIDTH}px`,
                                    padding: '8px 4px',
                                    verticalAlign: 'middle',
                                    backgroundColor: 'white',
                                    borderRight: '2px solid #D1D5DB',
                                    borderBottom: '1px solid #E5E7EB'
                                  }}></td>
                                );
                              }
                              return cells;
                            };
                            
                            phases.sort((a, b) => a.phase_number - b.phase_number).forEach((phase, phaseIndex) => {
                              const phaseTasks = tasksByPhase[phase.id] || [];
                              const rowHeight = 50;
                              
                              // Calculate phase position
                              const phaseStart = new Date(phase.start_date);
                              const phaseEnd = new Date(phase.end_date);
                              phaseStart.setHours(0, 0, 0, 0);
                              phaseEnd.setHours(0, 0, 0, 0);
                              
                              const timelineStart = new Date(start);
                              timelineStart.setHours(0, 0, 0, 0);
                              
                              const startOffset = Math.floor((phaseStart - timelineStart) / (1000 * 60 * 60 * 24));
                              // Calculate days from start date to end date (inclusive)
                              // If start=Nov5 and end=Nov10: that's 6 days (5,6,7,8,9,10)
                              const durationDays = Math.floor((phaseEnd - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
                              
                              const phaseColor = `hsl(${(phaseIndex * 60) % 360}, 70%, 55%)`;
                              
                              // Phase Header Row - One cell per day in timeline
                              const phaseCells = [];
                              for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                // Check if this day falls within the phase range
                                if (dayIdx >= startOffset && dayIdx < startOffset + durationDays) {
                                  // This day is part of the phase - color it
                                  phaseCells.push(
                                    <td 
                                      key={`phase-cell-${dayIdx}`} 
                                      onClick={() => {
                                        setGanttSelectedPhase(phase);
                                        setShowGanttPhaseModal(true);
                                      }}
                                      style={{
                                      width: `${DAY_WIDTH}px`,
                                      padding: '0px',
                                      margin: '0px',
                                      verticalAlign: 'middle',
                                      backgroundColor: phaseColor,
                                      borderRight: 'none',
                                      borderBottom: '1px solid rgba(255,255,255,0.2)',
                                      color: 'white',
                                      fontWeight: '600',
                                      fontSize: '11px',
                                      textAlign: 'center',
                                      height: '50px',
                                      display: 'table-cell',
                                      overflow: 'hidden',
                                      whiteSpace: 'nowrap',
                                      cursor: 'pointer',
                                      transition: 'opacity 0.2s',
                                      opacity: 1
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                    >
                                      {dayIdx === startOffset && `Phase ${phase.phase_number}`}
                                    </td>
                                  );
                                } else {
                                  // This day is NOT part of the phase - leave empty
                                  phaseCells.push(
                                    <td key={`phase-empty-${dayIdx}`} style={{
                                      width: `${DAY_WIDTH}px`,
                                      padding: '0px',
                                      margin: '0px',
                                      verticalAlign: 'middle',
                                      backgroundColor: 'white',
                                      borderRight: 'none',
                                      borderBottom: '1px solid #E5E7EB',
                                      display: 'table-cell'
                                    }}></td>
                                  );
                                }
                              }
                              
                              rows.push(
                                <tr key={`phase-${phase.id}`} style={{
                                  backgroundColor: '#F9FAFB',
                                  boxShadow: '0 2px 0 0 #E5E7EB'
                                }}>
                                  <td style={{
                                    width: `${nameColumnWidth}px`,
                                    padding: '12px 16px',
                                    verticalAlign: 'middle',
                                    borderRight: '2px solid #E5E7EB',
                                    borderLeft: '2px solid #E5E7EB',
                                    borderTop: '1px solid #E5E7EB',
                                    borderBottom: '1px solid #E5E7EB',
                                    backgroundColor: '#F9FAFB',
                                    height: `${rowHeight}px`,
                                    maxWidth: `${nameColumnWidth}px`,
                                    overflow: 'hidden'
                                  }}>
                                    <div style={{
                                      fontSize: '14px',
                                      fontWeight: '700',
                                      color: '#111827',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '8px',
                                      minWidth: 0
                                    }}>
                                      <FaLayerGroup size={14} style={{ color: phaseColor, flexShrink: 0 }} />
                                      <span style={{
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        Phase {phase.phase_number}: {phase.title}
                                      </span>
                                    </div>
                                  </td>
                                  {phaseCells}
                                </tr>
                              );
                              
                              // Task Rows
                              phaseTasks.forEach((task, taskIndex) => {
                                // Find assigned member
                                const assignedTo = task.assigned_to_id || task.assigned_to || task.assignedTo || task.assigned_member_id || task.assignedMemberId || task.student_id || task.studentId || task.member_id || task.memberId;
                                const assignedMember = (groupMembers.length > 0 ? groupMembers : groupData?.members || []).find(m => {
                                  const memberId = m.id || m.student_id || m.member_id;
                                  const memberStudentId = m.student_id || m.id;
                                  return assignedTo === memberId || assignedTo === memberStudentId;
                                });
                                
                                const position = getTaskPosition(task, DAY_WIDTH);
                                const taskStartDay = Math.floor((position.startDate - start) / (1000 * 60 * 60 * 24));
                                const taskEndDay = Math.floor((position.endDate - start) / (1000 * 60 * 60 * 24));
                                
                                // Create task cells aligned with dates
                                const taskCells = [];
                                for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                  if (dayIdx >= taskStartDay && dayIdx <= taskEndDay) {
                                    const isFirstDay = dayIdx === taskStartDay;
                                    const isLastDay = dayIdx === taskEndDay;
                                    
                                    taskCells.push(
                                      <td 
                                        key={`task-cell-${dayIdx}`} 
                                        onClick={() => {
                                          setGanttSelectedTask(task);
                                          setGanttSelectedPhaseForTask(phase);
                                          setGanttSelectedMemberForTask(assignedMember);
                                          setShowGanttTaskModal(true);
                                        }}
                                        style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: 'white',
                                        borderRight: 'none',
                                        borderBottom: '1px solid #E5E7EB',
                                        position: 'relative',
                                        height: `${rowHeight}px`,
                                        display: 'table-cell',
                                        overflow: 'hidden',
                                        cursor: 'pointer',
                                        transition: 'background-color 0.2s'
                                      }}
                                      onMouseEnter={(e) => { e.currentTarget.style.backgroundColor = '#F3F4F6'; }}
                                      onMouseLeave={(e) => { e.currentTarget.style.backgroundColor = 'white'; }}
                                      >
                                        {isFirstDay && (
                                          <div style={{
                                            position: 'relative',
                                            height: '34px',
                                            width: 'auto',
                                            maxWidth: '90%',
                                            backgroundColor: phaseColor,
                                            borderRadius: '17px',
                                            padding: '0 12px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px',
                                            fontSize: '11px',
                                            color: 'white',
                                            fontWeight: '600',
                                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            minWidth: '30px',
                                            flexShrink: 0
                                          }}>
                                            {assignedMember ? (
                                              <>
                                                <div style={{
                                                  width: '20px',
                                                  height: '20px',
                                                  borderRadius: '50%',
                                                  overflow: 'hidden',
                                                  backgroundColor: 'white',
                                                  border: '2px solid white',
                                                  flexShrink: 0
                                                }}>
                                                  {assignedMember.profile_image_url ? (
                                                    <img
                                                      src={assignedMember.profile_image_url}
                                                      alt={assignedMember.name || assignedMember.full_name}
                                                      style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        objectFit: 'cover'
                                                      }}
                                                      onError={(e) => {
                                                        e.target.style.display = 'none';
                                                      }}
                                                    />
                                                  ) : (
                                                    <div style={{
                                                      width: '100%',
                                                      height: '100%',
                                                      display: 'flex',
                                                      alignItems: 'center',
                                                      justifyContent: 'center',
                                                      fontSize: '9px',
                                                      fontWeight: '600',
                                                      color: '#3B82F6',
                                                      backgroundColor: '#DBEAFE'
                                                    }}>
                                                      {(assignedMember.name || assignedMember.full_name || 'M').charAt(0).toUpperCase()}
                                                    </div>
                                                  )}
                                                </div>
                                                <span style={{ overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                                  {assignedMember.name || assignedMember.full_name}
                                                </span>
                                              </>
                                            ) : (
                                              'Unassigned'
                                            )}
                                          </div>
                                        )}
                                      </td>
                                    );
                                  } else {
                                    taskCells.push(
                                      <td key={`task-empty-${dayIdx}`} style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: 'white',
                                        borderRight: 'none',
                                        borderBottom: '1px solid #E5E7EB',
                                        display: 'table-cell'
                                      }}></td>
                                    );
                                  }
                                }
                                
                                rows.push(
                                  <tr key={`task-${task.id}`} style={{
                                    backgroundColor: 'white',
                                    boxShadow: '0 1px 0 0 #E5E7EB'
                                  }}>
                                    <td style={{
                                      width: `${nameColumnWidth}px`,
                                      padding: '8px 16px 8px 32px',
                                      verticalAlign: 'middle',
                                      borderRight: '2px solid #E5E7EB',
                                      borderLeft: '2px solid #E5E7EB',
                                      borderTop: '1px solid #E5E7EB',
                                      borderBottom: '1px solid #E5E7EB',
                                      backgroundColor: 'white',
                                      height: `${rowHeight}px`,
                                      maxWidth: `${nameColumnWidth}px`,
                                      overflow: 'hidden'
                                    }}>
                                      <div style={{
                                        fontSize: '13px',
                                        fontWeight: '500',
                                        color: '#374151',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        minWidth: 0
                                      }}>
                                        <FaTasks size={11} style={{ color: phaseColor, flexShrink: 0 }} />
                                        <span style={{
                                          overflow: 'hidden',
                                          textOverflow: 'ellipsis',
                                          whiteSpace: 'nowrap',
                                          flex: 1
                                        }}>
                                          {task.title}
                                        </span>
                                      </div>
                                    </td>
                                    {taskCells}
                                  </tr>
                                );
                              });
                              
                              // Add Evaluation Phase after this phase if it exists
                              const isLastPhase = phaseIndex === phases.length - 1;
                              if (phase.evaluation_available_from && phase.evaluation_due_date) {
                                const rowHeight = 50;
                                
                                const evalStart = new Date(phase.evaluation_available_from);
                                const evalEnd = new Date(phase.evaluation_due_date);
                                evalStart.setHours(0, 0, 0, 0);
                                evalEnd.setHours(0, 0, 0, 0);
                                
                                const evalStartOffset = Math.floor((evalStart - timelineStart) / (1000 * 60 * 60 * 24));
                                // Calculate days from start date to end date (inclusive)
                                const evalDurationDays = Math.floor((evalEnd - evalStart) / (1000 * 60 * 60 * 24)) + 1;
                                
                                // Check for project evaluation on last phase
                                const hasProjectEval = isLastPhase && selectedGanttProject.project_evaluation_forms && selectedGanttProject.project_evaluation_forms.length > 0;
                                const evalLabel = hasProjectEval ? 'Project Evaluation' : 'Phase Evaluation';
                                const evalColor = hasProjectEval ? '#10B981' : '#8B5CF6';
                                
                                // Create eval cells - one per day in timeline
                                const evalCells = [];
                                for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                  // Check if this day falls within the evaluation range
                                  if (dayIdx >= evalStartOffset && dayIdx < evalStartOffset + evalDurationDays) {
                                    // This day is part of the evaluation - color it
                                    evalCells.push(
                                      <td 
                                        key={`eval-cell-${dayIdx}`} 
                                        onClick={() => {
                                          setGanttSelectedEval(phase);
                                          setGanttEvalType(hasProjectEval ? 'project' : 'phase');
                                          setShowGanttEvalModal(true);
                                        }}
                                        style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: evalColor,
                                        borderRight: 'none',
                                        borderBottom: '1px solid rgba(255,255,255,0.2)',
                                        color: 'white',
                                        fontWeight: '600',
                                        fontSize: '11px',
                                        textAlign: 'center',
                                        height: `${rowHeight}px`,
                                        display: 'table-cell',
                                        overflow: 'hidden',
                                        whiteSpace: 'nowrap',
                                        cursor: 'pointer',
                                        transition: 'opacity 0.2s',
                                        opacity: 1
                                      }}
                                      onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                      onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                      >
                                        {dayIdx === evalStartOffset && evalLabel.substring(0, 4)}
                                      </td>
                                    );
                                  } else {
                                    // This day is NOT part of the evaluation - empty
                                    evalCells.push(
                                      <td key={`eval-empty-${dayIdx}`} style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: 'white',
                                        borderRight: 'none',
                                        borderBottom: '1px solid #E5E7EB',
                                        display: 'table-cell'
                                      }}></td>
                                    );
                                  }
                                }
                                
                                rows.push(
                                  <tr key={`eval-phase-${phase.id}`} style={{
                                    backgroundColor: '#F9FAFB',
                                    boxShadow: '0 2px 0 0 #E5E7EB'
                                  }}>
                                    <td style={{
                                      width: `${nameColumnWidth}px`,
                                      padding: '12px 16px',
                                      verticalAlign: 'middle',
                                      borderRight: '2px solid #E5E7EB',
                                      borderLeft: '2px solid #E5E7EB',
                                      borderTop: '1px solid #E5E7EB',
                                      borderBottom: '1px solid #E5E7EB',
                                      backgroundColor: '#F9FAFB',
                                      height: `${rowHeight}px`
                                    }}>
                                      <div style={{
                                        fontSize: '14px',
                                        fontWeight: '700',
                                        color: '#111827',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                      }}>
                                        <FaClipboardCheck size={14} style={{ color: evalColor }} />
                                        {evalLabel}
                                      </div>
                                    </td>
                                    {evalCells}
                                  </tr>
                                );
                              }
                              
                              // Add Breathe Phase after evaluation if it exists
                              if (phase.breathe_start_date && phase.breathe_end_date) {
                                const rowHeight = 50;
                                
                                const breatheStart = new Date(phase.breathe_start_date);
                                const breatheEnd = new Date(phase.breathe_end_date);
                                breatheStart.setHours(0, 0, 0, 0);
                                breatheEnd.setHours(0, 0, 0, 0);
                                
                                const breatheStartOffset = Math.floor((breatheStart - timelineStart) / (1000 * 60 * 60 * 24));
                                // Calculate days from start date to end date (inclusive)
                                const breatheDurationDays = Math.floor((breatheEnd - breatheStart) / (1000 * 60 * 60 * 24)) + 1;
                                
                                // Create breathe cells - one cell for each day in timeline
                                const breatheCells = [];
                                for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                  // Check if this day is within the breathe period
                                  if (dayIdx >= breatheStartOffset && dayIdx < breatheStartOffset + breatheDurationDays) {
                                    breatheCells.push(
                                      <td 
                                        key={`breathe-cell-${dayIdx}`} 
                                        onClick={() => {
                                          setSelectedBreathePhase(phase);
                                          setShowBreatheModal(true);
                                        }}
                                        style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: '#F59E0B',
                                        borderRight: 'none',
                                        borderBottom: '1px solid rgba(255,255,255,0.2)',
                                        color: 'white',
                                        fontWeight: '600',
                                        fontSize: '11px',
                                        textAlign: 'center',
                                        height: `${rowHeight}px`,
                                        display: 'table-cell',
                                        overflow: 'hidden',
                                        whiteSpace: 'nowrap',
                                        cursor: 'pointer',
                                        transition: 'opacity 0.2s',
                                        opacity: 1
                                      }}
                                      onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                      onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                      >
                                        {dayIdx === breatheStartOffset && 'BREATHE'}
                                      </td>
                                    );
                                  } else {
                                    // Empty cell for non-breathe days
                                    breatheCells.push(
                                      <td key={`breathe-empty-${dayIdx}`} style={{
                                        width: `${DAY_WIDTH}px`,
                                        padding: '0px',
                                        margin: '0px',
                                        verticalAlign: 'middle',
                                        backgroundColor: 'white',
                                        borderRight: 'none',
                                        borderBottom: '1px solid #E5E7EB',
                                        display: 'table-cell'
                                      }}></td>
                                    );
                                  }
                                }
                                
                                rows.push(
                                  <tr key={`breathe-phase-${phase.id}`} style={{
                                    backgroundColor: '#F9FAFB',
                                    boxShadow: '0 2px 0 0 #E5E7EB'
                                  }}>
                                    <td style={{
                                      width: `${nameColumnWidth}px`,
                                      padding: '12px 16px',
                                      verticalAlign: 'middle',
                                      borderRight: '2px solid #E5E7EB',
                                      borderLeft: '2px solid #E5E7EB',
                                      borderTop: '1px solid #E5E7EB',
                                      borderBottom: '1px solid #E5E7EB',
                                      backgroundColor: '#F9FAFB',
                                      height: `${rowHeight}px`
                                    }}>
                                      <div style={{
                                        fontSize: '14px',
                                        fontWeight: '700',
                                        color: '#111827',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                      }}>
                                        <FaClock size={14} style={{ color: '#F59E0B' }} />
                                        Breathe Phase
                                      </div>
                                    </td>
                                    {breatheCells}
                                  </tr>
                                );
                              }
                            });
                            
                            return rows;
                          })()}
                            </tbody>
                          </table>
                          {/* Border overlay - render after table to ensure visibility */}
                          <div style={{
                            position: 'relative',
                            width: '100%',
                            height: '2px',
                            backgroundColor: '#E5E7EB',
                            marginTop: '-2px'
                          }}></div>

                          {/* Legend & Info */}
                          <div style={{
                            padding: '16px',
                            backgroundColor: '#F9FAFB',
                            borderTop: '1px solid #E5E7EB',
                            marginBottom: '4px', // Ensure bottom borders aren't clipped
                            minWidth: `${timelinePixelWidth}px`
                          }}>
                            <div style={{
                              display: 'flex',
                              gap: '24px',
                              justifyContent: 'center',
                              flexWrap: 'wrap',
                              marginBottom: '8px'
                            }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                <div style={{ width: '18px', height: '18px', backgroundColor: '#10B981', borderRadius: '4px' }}></div>
                                <span style={{ fontWeight: '500' }}>Completed</span>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                <div style={{ width: '18px', height: '18px', backgroundColor: '#F59E0B', borderRadius: '4px' }}></div>
                                <span style={{ fontWeight: '500' }}>In Progress</span>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                <div style={{ width: '18px', height: '18px', backgroundColor: '#EF4444', borderRadius: '4px' }}></div>
                                <span style={{ fontWeight: '500' }}>Overdue</span>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                <div style={{ width: '18px', height: '18px', backgroundColor: '#6B7280', borderRadius: '4px' }}></div>
                                <span style={{ fontWeight: '500' }}>Pending</span>
                              </div>
                            </div>
                            <div style={{
                              textAlign: 'center',
                              fontSize: '11px',
                              color: '#6B7280',
                              lineHeight: '1.6',
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              gap: '4px'
                            }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <FaInfoCircle size={11} />
                                Timeline: {selectedGanttPhase ? 
                                `Phase ${selectedGanttPhase.phase_number}` :
                                `Project Overview (${phaseIndicators.length} phase${phaseIndicators.length !== 1 ? 's' : ''})`} 
                              ({start.toLocaleDateString()} - {end.toLocaleDateString()})
                              ‚Ä¢ {timelineDays.length} day{timelineDays.length !== 1 ? 's' : ''}
                                {timelineDays.length > 30 && (
                                  <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    ‚Ä¢ Scroll horizontally <FaArrowRight size={9} />
                                  </span>
                                )}
                              </div>
                              {selectedGanttProject?.breathe_phase_days > 0 && (
                                <div style={{ marginTop: '4px', color: '#3B82F6', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                  <FaClock size={11} />
                                  Breathe Phase: {selectedGanttProject.breathe_phase_days} day{selectedGanttProject.breathe_phase_days !== 1 ? 's' : ''} between phases (not shown on timeline)
                                </div>
                              )}
                            </div>
                          </div>
                          </div>
                        </div>
                        </>
                        );
                      })()}
                    </div>
                  ) : (
                    <div style={{
                      backgroundColor: 'white',
                      border: '1px solid #B9B28A',
                      borderRadius: '8px',
                      padding: '60px',
                      textAlign: 'center',
                      color: '#9CA3AF'
                    }}>
                      Please select a project to view the timeline
                    </div>
                  )}
                </div>









              </>
            )} 
            {/* Activities Tab */}
            {activeGroupTab === 'activities' && (
              <div style={{ width: '100%' }}>
                {/* Controls Row - Status card left, Controls center, Due date right */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '20px',
                  gap: '20px'
                }}>
                  {/* Left side - Status Pill */}
                  <div style={{
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid rgb(95, 95, 95)',
                    borderRadius: '20px',
                    padding: '10px 16px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    minWidth: '150px',
                    height: '48px',
                    boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)'
                  }}>
                    {(() => {
                      if (!selectedActivitiesProject) {
                        return (
                          <>
                            <FaInfoCircle style={{ color: '#BE3144', fontSize: '14px' }} />
                            <div style={{
                              display: 'flex',
                              flexDirection: 'column',
                              gap: '2px'
                            }}>
                              <div style={{
                                fontSize: '10px',
                                color: 'white',
                                fontWeight: '500'
                              }}>
                                Status:
                              </div>
                              <div style={{
                                fontSize: '13px',
                                color: 'white',
                                fontWeight: '600'
                              }}>
                                No project
                              </div>
                            </div>
                          </>
                        );
                      }
                      
                      const today = new Date();
                      const phaseEnd = selectedActivitiesPhase?.end_date ? new Date(selectedActivitiesPhase.end_date) : null;
                      const projectEnd = (selectedActivitiesProject.due_date || selectedActivitiesProject.end_date) 
                        ? new Date(selectedActivitiesProject.due_date || selectedActivitiesProject.end_date) 
                        : null;
                      
                      // Determine which status to show based on selection
                      const isPhaseSelected = !!selectedActivitiesPhase;
                      const endDate = isPhaseSelected ? phaseEnd : projectEnd;
                      const isCompleted = endDate && today > endDate;
                      
                      return (
                        <>
                          {isCompleted ? <FaCheckCircle style={{ color: '#BE3144', fontSize: '14px' }} /> : <FaClock style={{ color: '#BE3144', fontSize: '14px' }} />}
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '2px'
                          }}>
                            <div style={{
                              fontSize: '10px',
                              color: 'white',
                              fontWeight: '500'
                            }}>
                              Status ({isPhaseSelected ? 'Phase' : 'Project'}):
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: 'white',
                              fontWeight: '600'
                            }}>
                              {isCompleted ? 'Completed' : 'Ongoing'}
                            </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Center - Combined Dropdown (looks like one but functions as two) */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    flex: 1,
                    justifyContent: 'center',
                    position: 'relative',
                    zIndex: 100
                  }}>
                    <div style={{
                      display: 'flex',
                      backgroundColor: 'rgb(255, 255, 255)',
                      border: '2px solid rgb(255, 255, 255)',
                      borderRadius: '8px',
                      overflow: 'visible',
                      minWidth: '600px'
                    }}>
                      {/* Project Dropdown */}
                      <div className="activities-project-dropdown" style={{ position: 'relative', zIndex: 102, flex: 1 }}>
                        <button
                          onClick={() => {
                            setShowActivitiesProjectDropdown(!showActivitiesProjectDropdown);
                            setShowActivitiesPhaseDropdown(false); // Close phase dropdown when opening project
                          }}
                          style={{
                            width: '100%',
                            padding: '8px 24px',
                            backgroundColor: 'rgb(255, 255, 255)',
                            color: 'rgb(135, 35, 65)',
                            border: 'none',
                            borderRight: '1px solid rgba(135, 35, 65, 0.2)',
                            borderRadius: '0',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            justifyContent: 'space-between',
                            transition: '0.2s',
                            minHeight: '42px'
                          }}
                          onMouseOver={(e) => {
                            e.currentTarget.style.backgroundColor = '#f8f9fa';
                            e.currentTarget.style.transform = 'translateY(-1px)';
                          }}
                          onMouseOut={(e) => {
                            e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                            e.currentTarget.style.transform = 'translateY(0)';
                          }}
                        >
                          <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                          <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                            {selectedActivitiesProject ? selectedActivitiesProject.title : 'Select Project'}
                          </span>
                          <FaChevronDown style={{ transition: 'transform 0.3s', transform: showActivitiesProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)', fontSize: '12px', flexShrink: 0 }} />
                        </button>
                        {showActivitiesProjectDropdown && (
                          <div style={{
                            position: 'absolute',
                            top: 'calc(100% + 8px)',
                            left: 0,
                            right: 0,
                            backgroundColor: 'white',
                            borderRadius: '12px',
                            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
                            zIndex: 9999,
                            maxHeight: '400px',
                            overflowY: 'auto',
                            border: '1px solid #e5e7eb'
                          }}>
                            {activeProjects && activeProjects.length > 0 ? (
                              activeProjects.map(project => (
                                <div
                                  key={project.id}
                                  onClick={() => handleActivitiesProjectChange(project)}
                                  style={{
                                    padding: '16px 20px',
                                    cursor: 'pointer',
                                    borderBottom: '1px solid #f0f0f0',
                                    transition: 'all 0.2s ease',
                                    backgroundColor: selectedActivitiesProject?.id === project.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                                    e.currentTarget.style.paddingLeft = '24px';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = selectedActivitiesProject?.id === project.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                                    e.currentTarget.style.paddingLeft = '20px';
                                  }}
                                >
                                  <FaProjectDiagram style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                  <div style={{ flex: 1 }}>
                                    <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px', marginBottom: '2px' }}>
                                      {project.title}
                                    </div>
                                    {project.start_date && project.end_date && (
                                      <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                        {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                      </div>
                                    )}
                                  </div>
                                  {selectedActivitiesProject?.id === project.id && (
                                    <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                  )}
                                </div>
                              ))
                            ) : (
                              <div style={{ padding: '16px 20px', color: '#9CA3AF', fontSize: '14px', textAlign: 'center' }}>
                                No projects available
                              </div>
                            )}
                          </div>
                        )}
                      </div>

                      {/* Phase Dropdown */}
                      <div className="activities-phase-dropdown" style={{ position: 'relative', zIndex: 101, flex: 1 }}>
                        <button
                          onClick={() => {
                            setShowActivitiesPhaseDropdown(!showActivitiesPhaseDropdown);
                            setShowActivitiesProjectDropdown(false); // Close project dropdown when opening phase
                          }}
                          disabled={!selectedActivitiesProject}
                          style={{
                            width: '100%',
                            padding: '8px 24px',
                            backgroundColor: selectedActivitiesProject ? 'rgb(255, 255, 255)' : 'rgb(245, 245, 245)',
                            color: selectedActivitiesProject ? 'rgb(135, 35, 65)' : 'rgb(156, 163, 175)',
                            border: 'none',
                            borderRadius: '0',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: selectedActivitiesProject ? 'pointer' : 'not-allowed',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            justifyContent: 'space-between',
                            transition: '0.2s',
                            minHeight: '42px'
                          }}
                          onMouseOver={(e) => {
                            if (selectedActivitiesProject) {
                              e.currentTarget.style.backgroundColor = '#f8f9fa';
                              e.currentTarget.style.transform = 'translateY(-1px)';
                            }
                          }}
                          onMouseOut={(e) => {
                            if (selectedActivitiesProject) {
                              e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                              e.currentTarget.style.transform = 'translateY(0)';
                            }
                          }}
                        >
                          <FaTasks style={{ fontSize: '14px', flexShrink: 0 }} />
                          <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                            {selectedActivitiesPhase ? `Phase ${selectedActivitiesPhase.phase_number}: ${selectedActivitiesPhase.title}` : 'No Phase (Project View)'}
                          </span>
                          <FaChevronDown style={{ transition: 'transform 0.3s', transform: showActivitiesPhaseDropdown ? 'rotate(180deg)' : 'rotate(0deg)', fontSize: '12px', flexShrink: 0 }} />
                        </button>
                        {showActivitiesPhaseDropdown && selectedActivitiesProject && (
                          <div style={{
                            position: 'absolute',
                            top: 'calc(100% + 8px)',
                            left: 0,
                            right: 0,
                            backgroundColor: 'white',
                            borderRadius: '12px',
                            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
                            zIndex: 9999,
                            maxHeight: '400px',
                            overflowY: 'auto',
                            border: '1px solid #e5e7eb'
                          }}>
                            {/* None option to clear phase selection */}
                            <div
                              onClick={() => handleActivitiesPhaseChange(null)}
                              style={{
                                padding: '16px 20px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s ease',
                                backgroundColor: !selectedActivitiesPhase ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                              }}
                              onMouseOver={(e) => {
                                e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                                e.currentTarget.style.paddingLeft = '24px';
                              }}
                              onMouseOut={(e) => {
                                e.currentTarget.style.backgroundColor = !selectedActivitiesPhase ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                                e.currentTarget.style.paddingLeft = '20px';
                              }}
                            >
                              <FaClipboardList style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px' }}>
                                  No Phase (Project View)
                                </div>
                              </div>
                              {!selectedActivitiesPhase && (
                                <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                              )}
                            </div>
                            
                            {activitiesPhases && activitiesPhases.length > 0 ? (
                              activitiesPhases.map(phase => (
                                <div
                                  key={phase.id}
                                  onClick={() => handleActivitiesPhaseChange(phase)}
                                  style={{
                                    padding: '16px 20px',
                                    cursor: 'pointer',
                                    borderBottom: '1px solid #f0f0f0',
                                    transition: 'all 0.2s ease',
                                    backgroundColor: selectedActivitiesPhase?.id === phase.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                                    e.currentTarget.style.paddingLeft = '24px';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = selectedActivitiesPhase?.id === phase.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                                    e.currentTarget.style.paddingLeft = '20px';
                                  }}
                                >
                                  <FaTasks style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                  <div style={{ flex: 1 }}>
                                    <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px', marginBottom: '2px' }}>
                                      Phase {phase.phase_number}: {phase.title}
                                    </div>
                                    {phase.start_date && phase.end_date && (
                                      <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                        {new Date(phase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(phase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                      </div>
                                    )}
                                  </div>
                                  {selectedActivitiesPhase?.id === phase.id && (
                                    <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                  )}
                                </div>
                              ))
                            ) : (
                              <div style={{ padding: '16px 20px', color: '#9CA3AF', fontSize: '14px', textAlign: 'center' }}>
                                No phases available
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Right side - Due Date Pill */}
                  <div style={{
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid rgb(95, 95, 95)',
                    borderRadius: '20px',
                    padding: '10px 16px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    minWidth: '150px',
                    height: '48px',
                    boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)'
                  }}>
                    {(() => {
                      if (!selectedActivitiesProject) {
                        return (
                          <>
                            <FaCalendar style={{ color: '#BE3144', fontSize: '14px' }} />
                            <div style={{
                              display: 'flex',
                              flexDirection: 'column',
                              gap: '2px'
                            }}>
                              <div style={{
                                fontSize: '10px',
                                color: 'white',
                                fontWeight: '500'
                              }}>
                                Due on:
                              </div>
                              <div style={{
                                fontSize: '13px',
                                color: 'white',
                                fontWeight: '600'
                              }}>
                                No project
                              </div>
                            </div>
                          </>
                        );
                      }
                      
                      // If phase is selected, show phase due date, otherwise show project due date
                      const isPhaseSelected = !!selectedActivitiesPhase;
                      const dueDate = selectedActivitiesPhase?.end_date || selectedActivitiesProject.due_date || selectedActivitiesProject.end_date;
                      const dueDateObj = dueDate ? new Date(dueDate) : null;
                      const today = new Date();
                      
                      // Check if overdue
                      const isOverdue = dueDateObj && dueDateObj < today;
                      
                      return (
                        <>
                          <FaCalendar style={{ 
                            color: '#BE3144',
                            fontSize: '14px'
                          }} />
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '2px'
                          }}>
                            <div style={{
                              fontSize: '10px',
                              color: 'white',
                              fontWeight: '500'
                            }}>
                              Due on ({isPhaseSelected ? 'Phase' : 'Project'}):
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: 'white',
                              fontWeight: '600'
                            }}>
                              {dueDateObj 
                                ? dueDateObj.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric'
                                  })
                                : 'Not set'
                              }
                            </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                </div>

                {/* Progress Bar Section */}
                {selectedActivitiesProject && (
                  <div className="my-group-card-with-crosshair" style={{
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid #5f5f5f',
                    borderRadius: '0px',
                    padding: '20px',
                    marginBottom: '20px',
                    position: 'relative'
                  }}>
                    <div className="crosshair-corner top-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner top-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-left">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    <div className="crosshair-corner bottom-right">
                      <div className="crosshair-h"></div>
                      <div className="crosshair-v"></div>
                    </div>
                    {(() => {
                      // Get phases for the selected project
                      const phases = selectedActivitiesProject.project_phases || [];
                      const totalPhases = phases.length;
                      
                      // Calculate progress based on actual submissions
                      const { phaseSubmissions, projectSubmission, loading } = projectProgressData;
                      
                      // Count how many phases have been submitted
                      const submittedPhaseIds = new Set(phaseSubmissions.map(sub => sub.phase_id));
                      const submittedPhasesCount = phases.filter(phase => submittedPhaseIds.has(phase.id)).length;
                      
                      // Progress calculation:
                      // - Phase submissions: 80% total (divided equally among phases)
                      // - Project submission: 20%
                      const phaseWeight = 80;
                      const projectWeight = 20;
                      
                      const phaseProgress = totalPhases > 0 
                        ? (submittedPhasesCount / totalPhases) * phaseWeight 
                        : 0;
                      
                      const projectProgress = projectSubmission ? projectWeight : 0;
                      
                      const progressPercentage = phaseProgress + projectProgress;
                      
                      return (
                        <>
                          {/* Progress Bar */}
                          <div style={{ marginBottom: '16px' }}>
                            {loading ? (
                              <div style={{ textAlign: 'center', padding: '20px', color: 'white' }}>
                                Loading progress...
                              </div>
                            ) : (
                              <>
                                <div style={{
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  marginBottom: '8px'
                                }}>
                                  <h3 style={{
                                    margin: 0,
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: 'white'
                                  }}>
                                    Project Progress
                                  </h3>
                                  <span style={{
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    color: 'white'
                                  }}>
                                    {submittedPhasesCount} of {totalPhases} phases {projectSubmission ? '+ project' : ''} submitted
                                  </span>
                                </div>
                            
                            <div style={{
                              width: '100%',
                              height: '32px',
                              backgroundColor: '#E5E7EB',
                              borderRadius: '16px',
                              overflow: 'hidden',
                              position: 'relative'
                            }}>
                              <div style={{
                                width: `${progressPercentage}%`,
                                height: '100%',
                                background: (() => {
                                                                                                                                                                            // Dynamic gradient based on progress
                                  if (progressPercentage >= 80) {
                                    // Green gradient (80-100%)
                                    return 'linear-gradient(90deg, #10B981 0%, #059669 100%)';
                                  } else if (progressPercentage >= 50) {
                                    // Orange gradient (50-79%)
                                    return 'linear-gradient(90deg, #F59E0B 0%, #EA580C 100%)';
                                  } else {
                                    // Red gradient (0-49%)
                                    return 'linear-gradient(90deg, #EF4444 0%, #DC2626 100%)';
                                  }
                                })(),
                                transition: 'width 0.5s ease, background 0.5s ease',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'flex-end',
                                paddingRight: progressPercentage > 10 ? '12px' : '0',
                                boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.1)'
                              }}>
                                {progressPercentage > 10 && (
                                  <span style={{
                                    fontSize: '14px',
                                    color: 'white',
                                    fontWeight: '700',
                                    textShadow: '0 1px 2px rgba(0, 0, 0, 0.3)'
                                  }}>
                                    {Math.round(progressPercentage)}%
                                  </span>
                                )}
                              </div>
                              {progressPercentage <= 10 && progressPercentage > 0 && (
                                <span style={{
                                  position: 'absolute',
                                  left: '12px',
                                  top: '50%',
                                  transform: 'translateY(-50%)',
                                  fontSize: '14px',
                                  color: '#6B7280',
                                  fontWeight: '700'
                                }}>
                                  {Math.round(progressPercentage)}%
                                </span>
                              )}
                            </div>
                              </>
                            )}
                          </div>
                        </>
                      );
                    })()}
                  </div>
                )}

                {/* Wide Card Below */}
                <div className="my-group-card-with-crosshair" style={{
                  background: 'rgba(9, 18, 44, 0.15)',
                  backdropFilter: 'blur(3.2px) saturate(120%)',
                  WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                  border: '0.1px solid #5f5f5f',
                  borderRadius: '0px',
                  overflow: 'hidden',
                  minHeight: '500px',
                  position: 'relative'
                }}>
                  <div className="crosshair-corner top-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner top-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  {/* Header: Three-Column Button Section */}
                  {selectedActivitiesProject && (
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(3, 1fr)',
                      gap: '0',
                      borderBottom: 'none',
                      backgroundColor: 'white'
                    }}>
                      {/* Column 1: Feedback View Button */}
                      <button
                        onClick={() => setActivitiesView('feedbackView')}
                        style={{
                          padding: '16px',
                          backgroundColor: activitiesView === 'feedbackView' ? '#872341' : 'white',
                          color: activitiesView === 'feedbackView' ? 'white' : '#872341',
                          border: 'none',
                          borderRight: 'none',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: '8px',
                          minHeight: '80px'
                        }}
                        onMouseOver={(e) => {
                          if (activitiesView !== 'feedbackView') {
                            e.currentTarget.style.backgroundColor = '#872341';
                            e.currentTarget.style.color = 'white';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (activitiesView !== 'feedbackView') {
                            e.currentTarget.style.backgroundColor = 'white';
                            e.currentTarget.style.color = '#872341';
                          }
                        }}
                      >
                        <FaComments style={{ fontSize: '20px' }} />
                        <span>Feedback View</span>
                      </button>

                      {/* Column 2: Tasks Button */}
                      <button
                        onClick={() => setActivitiesView('tasks')}
                        style={{
                          padding: '16px',
                          backgroundColor: activitiesView === 'tasks' ? '#872341' : 'white',
                          color: activitiesView === 'tasks' ? 'white' : '#872341',
                          border: 'none',
                          borderRight: 'none',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: '8px',
                          minHeight: '80px'
                        }}
                        onMouseOver={(e) => {
                          if (activitiesView !== 'tasks') {
                            e.currentTarget.style.backgroundColor = '#872341';
                            e.currentTarget.style.color = 'white';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (activitiesView !== 'tasks') {
                            e.currentTarget.style.backgroundColor = 'white';
                            e.currentTarget.style.color = '#872341';
                          }
                        }}
                      >
                        <FaTasks style={{ fontSize: '20px' }} />
                        <span>Tasks</span>
                      </button>

                      {/* Column 3: Deliverables */}
                      <button
                        onClick={async () => {
                          setActivitiesView('deliverables');
                          await loadActivitiesPhaseSubmissions(selectedActivitiesProject);
                        }}
                        style={{
                          padding: '16px',
                          backgroundColor: activitiesView === 'deliverables' ? '#872341' : 'white',
                          color: activitiesView === 'deliverables' ? 'white' : '#872341',
                          border: 'none',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: '8px',
                          minHeight: '80px'
                        }}
                        onMouseOver={(e) => {
                          if (activitiesView !== 'deliverables') {
                          e.currentTarget.style.backgroundColor = '#872341';
                          e.currentTarget.style.color = 'white';
                          }
                        }}
                        onMouseOut={(e) => {
                          if (activitiesView !== 'deliverables') {
                          e.currentTarget.style.backgroundColor = 'white';
                          e.currentTarget.style.color = '#872341';
                          }
                        }}
                      >
                        <FaClipboardCheck style={{ fontSize: '20px' }} />
                        <span style={{ textAlign: 'center', fontSize: '14px' }}>Deliverables</span>
                      </button>
                    </div>
                  )}

                  {/* Content Area */}
                  <div style={{ padding: '20px' }}>
                  {/* Three-Section Layout for Feedback View */}
                  {activitiesView === 'feedbackView' && selectedActivitiesProject ? (
                    <div 
                      data-feedback-columns="true"
                      style={{
                        display: 'grid',
                        gridTemplateColumns: '280px 1fr 320px',
                        gap: '20px',
                        minHeight: '500px',
                        width: '100%'
                      }}
                    >
                      {/* LEFT SECTION: Submissions List (Fixed 280px) */}
                      <div style={{
                        backgroundColor: 'white',
                        border: '1px solid #B9B28A',
                        borderRadius: '8px',
                        padding: '16px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '12px',
                        overflow: 'hidden'
                      }}>
                        {/* Search and Sort Controls */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', flexShrink: 0 }}>
                          <input
                            type="text"
                            placeholder="Search submissions..."
                            value={submissionSearchTerm}
                            onChange={(e) => setSubmissionSearchTerm(e.target.value)}
                            style={{
                              padding: '8px 12px',
                              border: '1px solid #B9B28A',
                              borderRadius: '6px',
                              fontSize: '14px',
                              outline: 'none'
                            }}
                          />
                          <select
                            value={submissionSortBy}
                            onChange={(e) => setSubmissionSortBy(e.target.value)}
                            style={{
                              padding: '8px 12px',
                              border: '1px solid #B9B28A',
                              borderRadius: '6px',
                              fontSize: '14px',
                              cursor: 'pointer',
                              backgroundColor: 'white'
                            }}
                          >
                            <option value="date">Sort by Date</option>
                            <option value="member">Sort by Member</option>
                            <option value="status">Sort by Status</option>
                            {!selectedActivitiesPhase && <option value="phase">Sort by Phase</option>}
                          </select>
                        </div>

                        {/* Submissions List */}
                        <div style={{
                          flex: 1,
                          overflowY: 'auto',
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '8px',
                          minHeight: 0
                        }}>
                          {loadingActivities ? (
                            <div style={{ textAlign: 'center', padding: '20px', color: '#9CA3AF' }}>
                              Loading submissions...
                            </div>
                          ) : groupTaskSubmissions.length > 0 ? (
                            groupTaskSubmissions
                              .filter(taskGroup => {
                                // Show ALL submissions (pending, revision_requested, completed, no_submission)
                                
                                // Search filter
                                if (!submissionSearchTerm) return true;
                                const searchLower = submissionSearchTerm.toLowerCase();
                                return (
                                  taskGroup.task_title?.toLowerCase().includes(searchLower) ||
                                  taskGroup.student_name?.toLowerCase().includes(searchLower)
                                );
                              })
                              .sort((a, b) => {
                                if (submissionSortBy === 'date') {
                                  return new Date(b.latest_submission?.submission_date || 0) - new Date(a.latest_submission?.submission_date || 0);
                                } else if (submissionSortBy === 'member') {
                                  return (a.student_name || '').localeCompare(b.student_name || '');
                                } else if (submissionSortBy === 'phase') {
                                  return (a.phase_number || 0) - (b.phase_number || 0);
                                } else {
                                  return (a.latest_submission?.status || '').localeCompare(b.latest_submission?.status || '');
                                }
                              })
                              .map((taskGroup, index) => {
                                // Determine status badge color
                                // Priority: If ANY attempt is approved, show COMPLETED/APPROVED
                                // Otherwise, use latest attempt status
                                const hasApprovedAttempt = taskGroup.submissions?.some(s => s.status === 'approved');
                                const latestStatus = hasApprovedAttempt ? 'approved' : taskGroup.latest_submission?.status;
                                const hasNoSubmission = !taskGroup.latest_submission || latestStatus === 'no_submission';
                                const isCompleted = latestStatus === 'completed' || latestStatus === 'approved';
                                const isPending = latestStatus === 'pending';
                                const needsRevision = latestStatus === 'revision_requested' || latestStatus === 'to_revise';
                                
                                return (
                                <div
                                  key={`submission-${taskGroup.task_id}-${taskGroup.student_id}`}
                                  onClick={() => handleTaskSubmissionClick(taskGroup)}
                                  style={{
                                    padding: '12px',
                                    backgroundColor: selectedTaskSubmission?.task_id === taskGroup.task_id && selectedTaskSubmission?.student_id === taskGroup.student_id ? 'rgba(135, 35, 65, 0.1)' : 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: selectedTaskSubmission?.task_id === taskGroup.task_id && selectedTaskSubmission?.student_id === taskGroup.student_id ? '0 2px 8px rgba(135, 35, 65, 0.2)' : '0 2px 4px rgba(0, 0, 0, 0.1)'
                                  }}
                                  onMouseOver={(e) => {
                                    if (selectedTaskSubmission?.task_id !== taskGroup.task_id || selectedTaskSubmission?.student_id !== taskGroup.student_id) {
                                      e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.05)';
                                      e.currentTarget.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
                                    }
                                  }}
                                  onMouseOut={(e) => {
                                    if (selectedTaskSubmission?.task_id !== taskGroup.task_id || selectedTaskSubmission?.student_id !== taskGroup.student_id) {
                                      e.currentTarget.style.backgroundColor = 'white';
                                      e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                                    }
                                  }}
                                >
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                    {/* Profile Image */}
                                    {taskGroup.profile_image_url ? (
                                      <img
                                        src={taskGroup.profile_image_url.startsWith('http')
                                          ? taskGroup.profile_image_url
                                          : `http://localhost:5000${taskGroup.profile_image_url}`}
                                        alt={taskGroup.student_name}
                                        onError={(e) => {
                                          e.target.style.display = 'none';
                                          e.target.nextSibling.style.display = 'flex';
                                        }}
                                        style={{
                                          width: '36px',
                                          height: '36px',
                                          borderRadius: '6px',
                                          objectFit: 'cover',
                                          display: 'block'
                                        }}
                                      />
                                    ) : null}
                                      <div style={{
                                        width: '36px',
                                        height: '36px',
                                      borderRadius: '6px',
                                        backgroundColor: '#872341',
                                        color: 'white',
                                      display: taskGroup.profile_image_url ? 'none' : 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                      }}>
                                      {taskGroup.student_first_name?.charAt(0).toUpperCase() || taskGroup.student_name?.charAt(0).toUpperCase() || 'U'}
                                      </div>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: '13px', fontWeight: '600', color: '#504B38' }}>
                                        {taskGroup.student_name || 'Unknown'}
                                      </div>
                                      <div style={{ fontSize: '11px', color: '#9CA3AF', marginBottom: '2px' }}>
                                        {taskGroup.task_title || 'Untitled Task'}
                                      </div>
                                      {/* Show phase info when No Phase View is active */}
                                      {!selectedActivitiesPhase && taskGroup.phase_number && (
                                        <div style={{ 
                                          fontSize: '10px', 
                                          color: '#872341',
                                          fontWeight: '600',
                                          display: 'inline-block',
                                          padding: '2px 6px',
                                          borderRadius: '4px',
                                          backgroundColor: 'rgba(135, 35, 65, 0.08)',
                                          marginTop: '2px'
                                        }}>
                                          Phase {taskGroup.phase_number}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                      <span style={{ fontSize: '10px', color: '#6B7280' }}>
                                        Due: {taskGroup.due_date ? new Date(taskGroup.due_date).toLocaleDateString() : 'N/A'}
                                      </span>
                                      <span style={{ fontSize: '10px', color: '#6B7280' }}>
                                        {taskGroup.submissions.length} attempt{taskGroup.submissions.length !== 1 ? 's' : ''}
                                      </span>
                                    </div>
                                    <span style={{
                                      fontSize: '10px',
                                      fontWeight: '600',
                                      padding: '2px 8px',
                                      borderRadius: '12px',
                                      backgroundColor: 
                                        isCompleted ? 'rgba(16, 185, 129, 0.1)' :
                                        needsRevision ? 'rgba(135, 35, 65, 0.1)' :
                                        isPending ? 'rgba(135, 35, 65, 0.15)' :
                                        hasNoSubmission ? 'rgba(156, 163, 175, 0.1)' : 'rgba(156, 163, 175, 0.1)',
                                      color:
                                        isCompleted ? '#10B981' :
                                        needsRevision ? '#872341' :
                                        isPending ? '#872341' :
                                        hasNoSubmission ? '#6B7280' : '#6B7280'
                                    }}>
                                      {hasNoSubmission ? 'NO SUBMISSION' :
                                       isCompleted ? 'COMPLETED' :
                                       isPending ? 'PENDING' :
                                       needsRevision ? 'NEEDS REVISION' :
                                       taskGroup.latest_submission?.status?.replace('_', ' ').toUpperCase()}
                                    </span>
                                  </div>
                                </div>
                                );
                              })
                          ) : (
                            <div style={{ textAlign: 'center', padding: '20px', color: '#9CA3AF', fontSize: '14px' }}>
                              No submissions found
                            </div>
                          )}
                        </div>
                      </div>

                      {/* MIDDLE SECTION: Task Details (Flexible) */}
                      <div style={{
                        backgroundColor: 'white',
                        border: '1px solid #B9B28A',
                        borderRadius: '8px',
                        padding: '16px',
                        overflowY: 'auto',
                        maxHeight: '500px',
                        display: 'flex',
                        alignItems: selectedTaskSubmission && selectedAttempt ? 'flex-start' : 'center',
                        justifyContent: selectedTaskSubmission && selectedAttempt ? 'flex-start' : 'center'
                      }}>
                        {selectedTaskSubmission && selectedAttempt ? (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', width: '100%' }}>
                            {/* Task Title and Attempt Dropdown */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px' }}>
                              <div style={{ flex: 1 }}>
                                <h3 style={{
                                  margin: '0 0 4px 0',
                                  fontSize: '18px',
                                  fontWeight: '700',
                                  color: '#09122C'
                                }}>
                                  {selectedTaskSubmission.task_title || 'Task Details'}
                                </h3>
                                <div style={{ fontSize: '12px', color: '#BE3144' }}>
                                  Submitted by {selectedTaskSubmission.student_name}
                                </div>
                              </div>
                              
                              {/* Attempt Dropdown */}
                              <select
                                value={selectedAttempt.attempt_number}
                                onChange={(e) => {
                                  const attempt = selectedTaskSubmission.submissions.find(
                                    s => s.attempt_number === parseInt(e.target.value)
                                  );
                                  handleAttemptChange(attempt);
                                }}
                                style={{
                                  padding: '6px 10px',
                                  border: '1px solid #872341',
                                  borderRadius: '6px',
                                  fontSize: '13px',
                                  fontWeight: '500',
                                  color: '#872341',
                                  cursor: 'pointer',
                                  backgroundColor: 'white',
                                  minWidth: '120px'
                                }}
                              >
                                {selectedTaskSubmission.submissions.map((sub, idx) => (
                                  <option key={`${sub.id}-${sub.attempt_number}-${idx}`} value={sub.attempt_number}>
                                    Attempt {sub.attempt_number}
                                  </option>
                                ))}
                              </select>
                            </div>

                            {/* Task Description */}
                            {selectedTaskSubmission.task_description && (
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'rgba(135, 35, 65, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(135, 35, 65, 0.15)'
                              }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '8px' }}>
                                  Description
                                </div>
                                <div style={{
                                  fontSize: '13px',
                                  color: '#BE3144',
                                  lineHeight: '1.5'
                                }}>
                                  {selectedTaskSubmission.task_description}
                                </div>
                              </div>
                            )}

                            {/* Task Info Grid */}
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: '1fr 1fr',
                              gap: '10px'
                            }}>
                              <div style={{
                                padding: '10px 12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '11px', color: '#09122C', marginBottom: '4px', fontWeight: '600' }}>
                                  Due Date
                                </div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: '#BE3144' }}>
                                  {selectedTaskSubmission.due_date ? 
                                    new Date(selectedTaskSubmission.due_date).toLocaleDateString() : 
                                    'N/A'}
                                </div>
                              </div>
                              <div style={{
                                padding: '10px 12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '11px', color: '#09122C', marginBottom: '4px', fontWeight: '600' }}>
                                  Attempts
                                </div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: '#BE3144' }}>
                                  {selectedAttempt.attempt_number} of {selectedTaskSubmission.max_attempts || 'Unlimited'}
                                </div>
                              </div>
                              <div style={{
                                padding: '10px 12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '11px', color: '#09122C', marginBottom: '4px', fontWeight: '600' }}>
                                  Submitted On
                                </div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: '#BE3144' }}>
                                  {new Date(selectedAttempt.submission_date).toLocaleDateString()}
                                </div>
                              </div>
                              <div style={{
                                padding: '10px 12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '11px', color: '#09122C', marginBottom: '4px', fontWeight: '600' }}>
                                  File Types Allowed
                                </div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: '#BE3144', wordBreak: 'break-word' }}>
                                  {formatFileTypes(selectedTaskSubmission.file_types_allowed)}
                                </div>
                              </div>
                            </div>

                            {/* Submission Text */}
                            {selectedAttempt.submission_text && (
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'rgba(135, 35, 65, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(135, 35, 65, 0.15)'
                              }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '8px' }}>
                                  Submission Text
                                </div>
                                <div style={{
                                  fontSize: '13px',
                                  color: '#BE3144',
                                  lineHeight: '1.5'
                                }}>
                                  {selectedAttempt.submission_text}
                                </div>
                              </div>
                            )}

                            {/* Submitted Files */}
                            {selectedAttempt.file_urls && Array.isArray(selectedAttempt.file_urls) && selectedAttempt.file_urls.length > 0 ? (
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '10px' }}>
                                  Submitted Files ({selectedAttempt.file_urls.length})
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {selectedAttempt.file_urls.map((fileUrl, index) => {
                                    // Extract filename from URL or path
                                    const fileName = fileUrl.split('/').pop() || `file-${index + 1}`;
                                    
                                    return (
                                      <button
                                        key={`file-${index}-${fileName}`}
                                        onClick={async (e) => {
                                          e.preventDefault();
                                          try {
                                            const token = localStorage.getItem('token');
                                            const response = await fetch(fileUrl, {
                                              method: 'GET',
                                              headers: {
                                                'Authorization': `Bearer ${token}`,
                                                'Content-Type': 'application/json'
                                              }
                                            });
                                            
                                            if (!response.ok) {
                                              throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                                            }
                                            
                                            const blob = await response.blob();
                                            const url = window.URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = fileName;
                                            document.body.appendChild(a);
                                            a.click();
                                            window.URL.revokeObjectURL(url);
                                            document.body.removeChild(a);
                                          } catch (error) {
                                            console.error('Download failed:', error);
                                            alert('Download failed: ' + error.message);
                                          }
                                        }}
                                        style={{
                                          padding: '10px 12px',
                                          backgroundColor: 'white',
                                          border: '1px solid rgba(135, 35, 65, 0.2)',
                                          borderRadius: '8px',
                                          fontSize: '13px',
                                          textDecoration: 'none',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '8px',
                                          transition: 'all 0.2s',
                                          cursor: 'pointer',
                                          width: '100%',
                                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.05)';
                                          e.currentTarget.style.borderColor = '#872341';
                                          e.currentTarget.style.boxShadow = '0 2px 6px rgba(135, 35, 65, 0.15)';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.backgroundColor = 'white';
                                          e.currentTarget.style.borderColor = 'rgba(135, 35, 65, 0.2)';
                                          e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
                                        }}
                                      >
                                        <FaFileAlt style={{ fontSize: '16px', flexShrink: 0, color: '#872341' }} />
                                        <span style={{ 
                                          flex: 1, 
                                          overflow: 'hidden', 
                                          textOverflow: 'ellipsis', 
                                          whiteSpace: 'nowrap',
                                          fontWeight: '500',
                                          textAlign: 'left',
                                          color: '#09122C'
                                        }}>
                                          {fileName}
                                        </span>
                                        <FaDownload style={{ fontSize: '12px', flexShrink: 0, color: '#872341' }} />
                                      </button>
                                    );
                                  })}
                                </div>
                              </div>
                            ) : (
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '10px' }}>
                                  Submitted Files
                                </div>
                                <div style={{
                                  padding: '12px',
                                  backgroundColor: '#F9FAFB',
                                  border: '1px solid #E5E7EB',
                                  borderRadius: '6px',
                                  textAlign: 'center',
                                  color: '#BE3144',
                                  fontSize: '12px'
                                }}>
                                  No files submitted
                                </div>
                              </div>
                            )}

                            {/* Review Comments (if any) */}
                            {selectedAttempt.review_comments && (
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'rgba(190, 49, 68, 0.06)',
                                borderRadius: '8px',
                                border: '1px solid rgba(190, 49, 68, 0.2)'
                              }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '8px' }}>
                                  Review Comments
                                </div>
                                <div style={{
                                  fontSize: '13px',
                                  color: '#BE3144',
                                  lineHeight: '1.5'
                                }}>
                                  {selectedAttempt.review_comments}
                                </div>
                              </div>
                            )}
                          </div>
                        ) : (
                          <div style={{ 
                            textAlign: 'center',
                            padding: '40px 20px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            gap: '12px'
                          }}>
                            <div style={{
                              width: '60px',
                              height: '60px',
                              borderRadius: '50%',
                              backgroundColor: 'rgba(9, 18, 44, 0.08)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              marginBottom: '8px'
                            }}>
                              <svg style={{ width: '30px', height: '30px', color: '#BE3144' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            </div>
                            <div style={{
                              fontSize: '16px',
                              fontWeight: '600',
                              color: '#09122C'
                            }}>
                              No Submission Selected
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: '#BE3144',
                              maxWidth: '250px',
                              lineHeight: '1.5'
                            }}>
                              Select a submission from the list to view task details and submission information
                            </div>
                          </div>
                        )}
                      </div>

                      {/* RIGHT SECTION: Feedback/Comments (Fixed 320px) */}
                      <div style={{
                        backgroundColor: 'white',
                        border: '1px solid #B9B28A',
                        borderRadius: '8px',
                        display: 'flex',
                        flexDirection: 'column',
                        maxHeight: '500px',
                        position: 'relative',
                        alignItems: selectedTaskSubmission && selectedAttempt ? 'stretch' : 'center',
                        justifyContent: selectedTaskSubmission && selectedAttempt ? 'flex-start' : 'center',
                        padding: selectedTaskSubmission && selectedAttempt ? '0' : '40px 20px'
                      }}>
                        {selectedTaskSubmission && selectedAttempt ? (
                          <>
                        {/* Header */}
                        <div style={{
                          padding: '16px 16px 12px 16px',
                          borderBottom: '1px solid #E5E7EB',
                          flexShrink: 0,
                          backgroundColor: 'white',
                          borderTopLeftRadius: '8px',
                          borderTopRightRadius: '8px'
                        }}>
                          <h4 style={{
                            margin: 0,
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#09122C'
                          }}>
                            Feedback & Comments
                          </h4>
                        </div>
                        
                        {/* Scrollable Feedback List */}
                        <div style={{
                          flex: 1,
                          overflowY: 'auto',
                          overflowX: 'hidden',
                          padding: '12px 16px',
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '12px',
                          minHeight: 0,
                          backgroundColor: 'white'
                        }}>
                          {submissionFeedbacks.length > 0 ? (
                            submissionFeedbacks.map((feedback, index) => (
                              <div
                                key={index}
                                style={{
                                  padding: '12px',
                                  backgroundColor: feedback.is_from_leader ? 'rgba(135, 35, 65, 0.1)' : 'rgba(9, 18, 44, 0.08)',
                                  border: `1px solid ${feedback.is_from_leader ? '#872341' : '#09122C'}`,
                                  borderRadius: '8px',
                                  flexShrink: 0
                                }}
                              >
                                {/* Feedback Header */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                  {feedback.profile_image_url ? (
                                    <img
                                      src={feedback.profile_image_url.startsWith('http')
                                        ? feedback.profile_image_url
                                        : `http://localhost:5000${feedback.profile_image_url}`}
                                      alt={feedback.reviewer_name}
                                      onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.nextSibling.style.display = 'flex';
                                      }}
                                      style={{
                                        width: '28px',
                                        height: '28px',
                                        borderRadius: '6px',
                                        objectFit: 'cover',
                                        display: 'block'
                                      }}
                                    />
                                  ) : null}
                                    <div style={{
                                      width: '28px',
                                      height: '28px',
                                    borderRadius: '6px',
                                    backgroundColor: feedback.is_from_leader ? '#872341' : '#09122C',
                                      color: 'white',
                                    display: feedback.profile_image_url ? 'none' : 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: '12px',
                                      fontWeight: '600',
                                      flexShrink: 0
                                    }}>
                                      {feedback.reviewer_name?.charAt(0).toUpperCase() || 'R'}
                                    </div>
                                  <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#872341' }}>
                                      {feedback.reviewer_name || 'Reviewer'}
                                      {feedback.is_from_leader ? (
                                        <span style={{
                                          marginLeft: '6px',
                                          fontSize: '10px',
                                          padding: '2px 6px',
                                          backgroundColor: '#872341',
                                          color: 'white',
                                          borderRadius: '10px',
                                          fontWeight: '600'
                                        }}>
                                          Leader
                                        </span>
                                      ) : (
                                        <span style={{
                                          marginLeft: '6px',
                                          fontSize: '10px',
                                          padding: '2px 6px',
                                          backgroundColor: '#09122C',
                                          color: 'white',
                                          borderRadius: '10px',
                                          fontWeight: '600'
                                        }}>
                                          Member
                                        </span>
                                      )}
                                    </div>
                                    <div style={{ fontSize: '10px', color: '#BE3144' }}>
                                      {new Date(feedback.created_at).toLocaleString()}
                                    </div>
                                  </div>
                                </div>

                                {/* Feedback Content */}
                                <div style={{
                                  fontSize: '13px',
                                  color: '#09122C',
                                  lineHeight: '1.5',
                                  wordWrap: 'break-word',
                                  overflowWrap: 'break-word'
                                }}>
                                  {feedback.comment_text}
                                </div>
                              </div>
                            ))
                          ) : (
                            <div style={{
                              textAlign: 'center',
                              padding: '20px',
                              color: '#BE3144',
                              fontSize: '13px'
                            }}>
                              No feedback yet
                            </div>
                          )}
                        </div>

                        {/* Feedback Form - Fixed at Bottom */}
                        {selectedTaskSubmission && selectedAttempt && (
                          <div style={{
                            padding: '12px 16px',
                            borderTop: '1px solid #E5E7EB',
                            backgroundColor: '#F9FAFB',
                            flexShrink: 0,
                            borderBottomLeftRadius: '8px',
                            borderBottomRightRadius: '8px'
                          }}>
                            {/* Feedback Text */}
                            <textarea
                              value={groupFeedbackText}
                              onChange={(e) => setGroupFeedbackText(e.target.value)}
                              placeholder="Write your feedback..."
                              style={{
                                width: '100%',
                                minHeight: '70px',
                                padding: '10px',
                                border: '1px solid #872341',
                                borderRadius: '8px',
                                fontSize: '13px',
                                resize: 'vertical',
                                fontFamily: 'inherit',
                                marginBottom: '10px',
                                boxSizing: 'border-box',
                                color: '#09122C',
                                outline: 'none'
                              }}
                              onFocus={(e) => {
                                e.currentTarget.style.borderColor = '#872341';
                                e.currentTarget.style.boxShadow = '0 0 0 2px rgba(135, 35, 65, 0.1)';
                              }}
                              onBlur={(e) => {
                                e.currentTarget.style.borderColor = '#872341';
                                e.currentTarget.style.boxShadow = 'none';
                              }}
                            />

                            {/* Submit Button */}
                            <button
                              onClick={handleSubmitGroupFeedback}
                              disabled={submittingGroupFeedback || !groupFeedbackText.trim()}
                              style={{
                                width: '100%',
                                padding: '10px',
                                backgroundColor: submittingGroupFeedback || !groupFeedbackText.trim() ? '#9CA3AF' : '#872341',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: submittingGroupFeedback || !groupFeedbackText.trim() ? 'not-allowed' : 'pointer',
                                transition: 'all 0.2s',
                                boxShadow: submittingGroupFeedback || !groupFeedbackText.trim() ? 'none' : '0 2px 4px rgba(135, 35, 65, 0.3)'
                              }}
                              onMouseOver={(e) => {
                                if (!submittingGroupFeedback && groupFeedbackText.trim()) {
                                  e.currentTarget.style.backgroundColor = '#6b1d35';
                                  e.currentTarget.style.boxShadow = '0 4px 8px rgba(135, 35, 65, 0.4)';
                                }
                              }}
                              onMouseOut={(e) => {
                                if (!submittingGroupFeedback && groupFeedbackText.trim()) {
                                  e.currentTarget.style.backgroundColor = '#872341';
                                  e.currentTarget.style.boxShadow = '0 2px 4px rgba(135, 35, 65, 0.3)';
                                }
                              }}
                            >
                              {submittingGroupFeedback ? 'Submitting...' : 'Submit Feedback'}
                            </button>
                          </div>
                        )}
                          </>
                        ) : (
                          <div style={{ 
                            textAlign: 'center',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            gap: '12px'
                          }}>
                            <div style={{
                              width: '60px',
                              height: '60px',
                              borderRadius: '50%',
                              backgroundColor: 'rgba(135, 35, 65, 0.08)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              marginBottom: '8px'
                            }}>
                              <svg style={{ width: '30px', height: '30px', color: '#872341' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                              </svg>
                            </div>
                            <div style={{
                              fontSize: '16px',
                              fontWeight: '600',
                              color: '#09122C'
                            }}>
                              No Feedback Available
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: '#BE3144',
                              maxWidth: '250px',
                              lineHeight: '1.5'
                            }}>
                              Select a submission to view and add feedback comments
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  ) : activitiesView === 'tasks' && selectedActivitiesProject ? (
                    /* TASKS VIEW: Member Cards with Task Assignments */
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                      gap: '16px',
                      padding: '8px'
                    }}>
                      {/* Member Cards */}
                      {groupMembers && groupMembers.length > 0 ? (
                        groupMembers.map((member) => {
                          // Get tasks assigned to this member from allGroupTasks
                          const memberTaskData = allGroupTasks.find(t => t.student_id === member.student_id);
                          const memberTasks = memberTaskData?.tasks || [];
                          
                          // Calculate total min/max based on whether viewing all phases or single phase
                          let minTasks, maxTasks;
                          
                          // Get task limits from the selected project (not from taskLimits state which is for Task Assignment tab)
                          const projectMinTasks = selectedActivitiesProject?.min_tasks_per_member || 1;
                          const projectMaxTasks = selectedActivitiesProject?.max_tasks_per_member || 10;
                          
                          if (!selectedActivitiesPhase && selectedActivitiesProject?.project_phases) {
                            // No phase selected - calculate total across all phases
                            const phaseCount = selectedActivitiesProject.project_phases.length;
                            minTasks = projectMinTasks * phaseCount;
                            maxTasks = projectMaxTasks * phaseCount;
                          } else {
                            // Single phase selected - use regular limits
                            minTasks = projectMinTasks;
                            maxTasks = projectMaxTasks;
                          }
                          
                          // Calculate color based on task count vs min/max
                          const taskCount = memberTasks.length;
                          
                          let countColor = '#09122C';
                          let countBgColor = 'rgba(9, 18, 44, 0.04)';
                          let countBorderColor = 'rgba(9, 18, 44, 0.1)';
                          
                          if (taskCount < minTasks) {
                            // Below minimum - Red
                            countColor = '#DC2626';
                            countBgColor = 'rgba(220, 38, 38, 0.08)';
                            countBorderColor = 'rgba(220, 38, 38, 0.3)';
                          } else if (taskCount >= minTasks && taskCount < maxTasks) {
                            // At or above minimum but below maximum - Orange
                            countColor = '#EA580C';
                            countBgColor = 'rgba(234, 88, 12, 0.08)';
                            countBorderColor = 'rgba(234, 88, 12, 0.3)';
                          } else if (taskCount >= maxTasks) {
                            // At or above maximum - Green
                            countColor = '#059669';
                            countBgColor = 'rgba(5, 150, 105, 0.08)';
                            countBorderColor = 'rgba(5, 150, 105, 0.3)';
                          }

                          return (
                            <div
                              key={member.student_id}
                              style={{
                                backgroundColor: 'white',
                                border: '1px solid #B9B28A',
                                borderRadius: '12px',
                                padding: '16px',
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '12px'
                              }}
                            >
                              {/* Member Header */}
                              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                {member.profile_image_url ? (
                                  <img
                                    src={member.profile_image_url}
                                    alt={member.name}
                                    style={{
                                      width: '48px',
                                      height: '48px',
                                      borderRadius: '6px',
                                      objectFit: 'cover'
                                    }}
                                  />
                                ) : (
                                  <div style={{
                                    width: '48px',
                                    height: '48px',
                                    borderRadius: '6px',
                                    backgroundColor: '#872341',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    fontWeight: '600'
                                  }}>
                                    {member.name.charAt(0).toUpperCase()}
                                  </div>
                                )}
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontWeight: '600', fontSize: '15px', color: '#09122C' }}>
                                    {member.name}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#872341' }}>
                                    {member.position || 'Member'}
                                  </div>
                                </div>
                              </div>

                              {/* Task Count */}
                              <div style={{
                                textAlign: 'center',
                                padding: '12px',
                                backgroundColor: countBgColor,
                                borderRadius: '8px',
                                border: `1px solid ${countBorderColor}`
                              }}>
                                <div style={{ fontSize: '32px', fontWeight: '700', color: countColor, lineHeight: '1' }}>
                                  {taskCount} / {maxTasks}
                                </div>
                                <div style={{ fontSize: '12px', color: '#09122C', marginTop: '6px', fontWeight: '500' }}>
                                  {taskCount < minTasks ? `Need ${minTasks - taskCount} more` :
                                   taskCount === minTasks && minTasks > 0 ? 'At minimum' :
                                   taskCount >= maxTasks ? 'At maximum' :
                                   taskCount > 0 ? 'Tasks Assigned' : 'No tasks yet'}
                                </div>
                              </div>

                              {/* Task List */}
                              <div style={{ 
                                display: 'flex', 
                                flexDirection: 'column', 
                                gap: '8px',
                                maxHeight: memberTasks.length > 2 ? '220px' : 'none',
                                overflowY: memberTasks.length > 2 ? 'auto' : 'visible',
                                paddingRight: memberTasks.length > 2 ? '4px' : '0'
                              }}>
                                {memberTasks.length > 0 ? (
                                  memberTasks.map((task) => {
                                    // Determine task status colors and clickability
                                    const isPending = task.status === 'pending';
                                    const isToRevise = task.status === 'to_revise';
                                    const isInProgress = task.status === 'in_progress';
                                    const isCompleted = task.status === 'completed';
                                    
                                    // All tasks are clickable now
                                    const isClickable = true;

                                    return (
                                      <button
                                        key={`task-${task.id}`}
                                        onClick={async () => {
                                          console.log('Navigating to task:', task);
                                          
                                          // Navigate to Feedback View
                                          setActivitiesView('feedbackView');
                                          
                                          // Load submissions for current phase (or all phases if null)
                                          await loadGroupTaskSubmissions(selectedActivitiesPhase?.id || null, selectedActivitiesProject);
                                          
                                          // Wait for submissions to load, then select this task
                                          setTimeout(() => {
                                            const taskSubmission = groupTaskSubmissions.find(
                                              ts => ts.task_id === task.id && ts.student_id === member.student_id
                                            );
                                            if (taskSubmission) {
                                              handleTaskSubmissionClick(taskSubmission);
                                            }
                                            
                                            // Scroll to feedback section
                                            setTimeout(() => {
                                              const feedbackSection = document.querySelector('[data-feedback-columns]');
                                              if (feedbackSection) {
                                                feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                              }
                                            }, 100);
                                          }, 500);
                                        }}
                                        style={{
                                          padding: '10px 12px',
                                          backgroundColor: isPending ? '#F3F4F6' : 
                                                          isCompleted ? '#D1FAE5' : 
                                                          isToRevise ? '#FEF3C7' : 
                                                          isInProgress ? '#DBEAFE' : '#F3F4F6',
                                          border: `1px solid ${isPending ? '#E5E7EB' : 
                                                               isCompleted ? '#86EFAC' : 
                                                               isToRevise ? '#FDE047' : 
                                                               isInProgress ? '#93C5FD' : '#E5E7EB'}`,
                                          borderRadius: '8px',
                                          textAlign: 'left',
                                          cursor: 'pointer',
                                          transition: 'all 0.2s',
                                          opacity: 1,
                                          width: '100%'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.transform = 'translateY(-2px)';
                                          e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.transform = 'translateY(0)';
                                          e.currentTarget.style.boxShadow = 'none';
                                        }}
                                      >
                                        <div style={{
                                          fontSize: '13px',
                                          fontWeight: '600',
                                          color: '#504B38',
                                          marginBottom: '4px',
                                          overflow: 'hidden',
                                          textOverflow: 'ellipsis',
                                          whiteSpace: 'nowrap'
                                        }}>
                                          {task.title}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#9CA3AF' }}>
                                          {isPending ? 'Not Started' :
                                           isCompleted ? 'Completed' :
                                           isToRevise ? 'Needs Revision' :
                                           isInProgress ? 'In Progress' :
                                           'Unknown Status'}
                                        </div>
                                      </button>
                                    );
                                  })
                                ) : (
                                  <div style={{
                                    padding: '16px',
                                    textAlign: 'center',
                                    color: '#9CA3AF',
                                    fontSize: '12px',
                                    fontStyle: 'italic'
                                  }}>
                                    No tasks assigned
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })
                      ) : (
                        <div style={{
                          gridColumn: '1 / -1',
                          textAlign: 'center',
                          padding: '40px',
                          color: '#9CA3AF'
                        }}>
                          No group members found
                        </div>
                      )}
                    </div>
                  ) : activitiesView === 'deliverables' && selectedActivitiesProject ? (
                    /* DELIVERABLES VIEW */
                    <div style={{
                      display: 'flex',
                      gap: '20px',
                      height: 'calc(100vh - 400px)',
                      minHeight: '600px'
                    }}>
                      {/* Left Column: All Deliverables (Phases + Project) */}
                      <div style={{
                        flex: '0 0 350px',
                        backgroundColor: 'white',
                        border: '1px solid #B9B28A',
                        borderRadius: '12px',
                        padding: '20px',
                        overflowY: 'auto'
                      }}>
                        <h3 style={{ 
                          color: '#09122C', 
                          fontSize: '18px', 
                          fontWeight: '700', 
                          marginBottom: '16px' 
                        }}>
                          Deliverables
                        </h3>
                        
                        {loadingPhaseSubmissionsView ? (
                          <div style={{ textAlign: 'center', padding: '40px', color: '#BE3144' }}>
                            Loading...
                    </div>
                  ) : (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {/* Phase Deliverables */}
                            {activitiesPhases.map((phase) => {
                              const now = new Date();
                              const phaseEndDate = phase.end_date ? new Date(phase.end_date) : null;
                              const phaseStartDate = phase.start_date ? new Date(phase.start_date) : null;
                              
                              // Find submission for this phase
                              const phaseSubmission = activitiesPhaseSubmissions.find(sub => sub.phase_id === phase.id);
                              
                              let statusText = 'No Submission';
                              let statusColor = '#DC2626'; // red
                              let statusBgColor = 'rgba(220, 38, 38, 0.1)';
                              
                              if (phaseSubmission) {
                                statusText = 'Submitted';
                                statusColor = '#059669'; // green
                                statusBgColor = 'rgba(5, 150, 105, 0.1)';
                              } else if (phaseStartDate && now < phaseStartDate) {
                                statusText = 'Upcoming';
                                statusColor = '#0284C7'; // blue
                                statusBgColor = 'rgba(2, 132, 199, 0.1)';
                              } else if (phaseEndDate && now <= phaseEndDate) {
                                statusText = 'Pending';
                                statusColor = '#EA580C'; // orange
                                statusBgColor = 'rgba(234, 88, 12, 0.1)';
                              }
                              
                              const isSelected = (phaseSubmission && selectedPhaseSubmission?.id === phaseSubmission.id) || 
                                               (selectedPhaseSubmission?.phase_id === phase.id && !selectedPhaseSubmission?.id);
                              
                              return (
                                <button
                                  key={phase.id}
                                  onClick={() => {
                                    setSelectedPhaseSubmission(phaseSubmission || { phase_id: phase.id, phase_snapshot: phase });
                                  }}
                                  style={{
                                    padding: '16px',
                                    backgroundColor: isSelected ? 'rgba(135, 35, 65, 0.08)' : 'white',
                                    border: `2px solid ${isSelected ? '#872341' : 'rgba(185, 178, 138, 0.5)'}`,
                                    borderRadius: '12px',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    position: 'relative'
                                  }}
                                  onMouseOver={(e) => {
                                    if (!isSelected) {
                                      e.currentTarget.style.backgroundColor = 'rgba(185, 178, 138, 0.1)';
                                    }
                                  }}
                                  onMouseOut={(e) => {
                                    if (!isSelected) {
                                      e.currentTarget.style.backgroundColor = 'white';
                                    }
                                  }}
                                >
                                  {/* Status pill - top right */}
                    <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    right: '12px',
                                    padding: '4px 10px',
                                    borderRadius: '12px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    backgroundColor: statusBgColor,
                                    color: statusColor
                                  }}>
                                    {statusText}
                                  </div>
                                  
                                  <div style={{ 
                                    fontSize: '16px', 
                                    fontWeight: '600', 
                                    color: '#09122C',
                                    marginBottom: '6px',
                                    paddingRight: '100px'
                                  }}>
                                    Phase {phase.phase_number}: {phase.title}
                                  </div>
                                  
                                  {/* Phase Description Preview */}
                                  {phase.description && (
                                    <div style={{
                                      fontSize: '11px',
                                      color: '#666',
                                      marginBottom: '8px',
                                      overflow: 'hidden',
                                      textOverflow: 'ellipsis',
                                      display: '-webkit-box',
                                      WebkitLineClamp: 2,
                                      WebkitBoxOrient: 'vertical',
                                      lineHeight: '1.4'
                                    }}>
                                      {phase.description}
                                    </div>
                                  )}
                                  
                                  {/* Start and Due Dates */}
                                  <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                    {phaseStartDate && (
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: '11px',
                                        color: '#872341'
                                      }}>
                                        <FaCalendarAlt style={{ fontSize: '10px' }} />
                                        <span style={{ fontWeight: '500' }}>
                                          {phaseStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {phaseStartDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </span>
                                      </div>
                                    )}
                                    {phaseEndDate && (
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: '11px',
                                        color: '#BE3144'
                                      }}>
                                        <FaClock style={{ fontSize: '10px' }} />
                                        <span style={{ fontWeight: '500' }}>
                                          Due {phaseEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {phaseEndDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                </button>
                              );
                            })}
                            
                            {/* Project Submission (at the end) */}
                            {(() => {
                              const projectObj = typeof selectedActivitiesProject === 'object' ? selectedActivitiesProject : null;
                              if (!projectObj) return null;
                              
                              const now = new Date();
                              const projectEndDate = projectObj.end_date ? new Date(projectObj.end_date) : null;
                              const projectStartDate = projectObj.start_date ? new Date(projectObj.start_date) : null;
                              
                              // Get project submission from projectProgressData, not from phase submissions
                              const projectSubmission = projectProgressData?.projectSubmission;
                              
                              let statusText = 'No Submission';
                              let statusColor = '#DC2626'; // red
                              let statusBgColor = 'rgba(220, 38, 38, 0.1)';
                              
                              if (projectSubmission) {
                                statusText = 'Submitted';
                                statusColor = '#059669'; // green
                                statusBgColor = 'rgba(5, 150, 105, 0.1)';
                              } else if (projectStartDate && now < projectStartDate) {
                                statusText = 'Upcoming';
                                statusColor = '#0284C7'; // blue
                                statusBgColor = 'rgba(2, 132, 199, 0.1)';
                              } else if (projectEndDate && now <= projectEndDate) {
                                statusText = 'Pending';
                                statusColor = '#EA580C'; // orange
                                statusBgColor = 'rgba(234, 88, 12, 0.1)';
                              }
                              
                              const isSelected = selectedPhaseSubmission === 'project' || (projectSubmission && selectedPhaseSubmission?.id === projectSubmission.id);
                              
                              return (
                                <button
                                  key="project-submission"
                                  onClick={() => {
                                    setSelectedPhaseSubmission(projectSubmission || { project_id: projectObj.id, phase_snapshot: null });
                                  }}
                                  style={{
                                    padding: '16px',
                                    backgroundColor: isSelected ? 'rgba(135, 35, 65, 0.08)' : 'white',
                                    border: `2px solid ${isSelected ? '#872341' : 'rgba(185, 178, 138, 0.5)'}`,
                                    borderRadius: '12px',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    position: 'relative'
                                  }}
                                  onMouseOver={(e) => {
                                    if (!isSelected) {
                                      e.currentTarget.style.backgroundColor = 'rgba(185, 178, 138, 0.1)';
                                    }
                                  }}
                                  onMouseOut={(e) => {
                                    if (!isSelected) {
                                      e.currentTarget.style.backgroundColor = 'white';
                                    }
                                  }}
                                >
                                  {/* Status pill - top right */}
                                  <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    right: '12px',
                                    padding: '4px 10px',
                                    borderRadius: '12px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    backgroundColor: statusBgColor,
                                    color: statusColor
                                  }}>
                                    {statusText}
                                  </div>
                                  
                                  <div style={{ 
                                    fontSize: '16px', 
                                    fontWeight: '600', 
                                    color: '#09122C',
                                    marginBottom: '8px',
                                    paddingRight: '100px'
                                  }}>
                                    Project Submission
                                  </div>
                                  
                                  {/* Start and Due Dates */}
                                  <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                    {projectStartDate && (
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: '11px',
                                        color: '#872341'
                                      }}>
                                        <FaCalendarAlt style={{ fontSize: '10px' }} />
                                        <span style={{ fontWeight: '500' }}>
                                          {projectStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {projectStartDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </span>
                                      </div>
                                    )}
                                    {projectEndDate && (
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: '11px',
                                        color: '#BE3144'
                                      }}>
                                        <FaClock style={{ fontSize: '10px' }} />
                                        <span style={{ fontWeight: '500' }}>
                                          Due {projectEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {projectEndDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                </button>
                              );
                            })()}
                          </div>
                        )}
                      </div>

                      {/* Right Column: Submission Details */}
                      <div style={{
                        flex: 1,
                        backgroundColor: 'white',
                        border: '1px solid #B9B28A',
                        borderRadius: '12px',
                        padding: '20px',
                        overflowY: 'auto',
                        display: selectedPhaseSubmission ? 'block' : 'flex',
                        alignItems: selectedPhaseSubmission ? 'initial' : 'center',
                        justifyContent: selectedPhaseSubmission ? 'initial' : 'center'
                      }}>
                        {selectedPhaseSubmission ? (
                          // Check if it's a project submission without actual submission
                          !selectedPhaseSubmission.phase_id && !selectedPhaseSubmission.submitted_at ? (
                            // Centered empty state for project without submission
                            <div style={{
                              textAlign: 'center',
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              justifyContent: 'center',
                              gap: '20px',
                              padding: '40px 20px'
                            }}>
                              <div style={{
                                width: '80px',
                                height: '80px',
                                borderRadius: '50%',
                                backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                marginBottom: '8px'
                              }}>
                                <svg style={{ width: '40px', height: '40px', color: '#872341' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                              </div>
                              <div>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: '#09122C', marginBottom: '8px' }}>
                                  Project Submission
                                </div>
                                <div style={{ fontSize: '15px', color: '#BE3144', maxWidth: '300px', lineHeight: '1.5' }}>
                                  No submission yet. You can view the project rubric and evaluation form below.
                                </div>
                              </div>
                              
                              {/* Action Buttons */}
                              <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', justifyContent: 'center', marginTop: '8px' }}>
                                <button
                                  onClick={() => {
                                    console.log('View rubric clicked for project:', selectedPhaseSubmission.project_id);
                                    fetchProjectRubric(selectedPhaseSubmission.project_id);
                                    setShowProjectRubricModal(true);
                                  }}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: 'white',
                                    border: '2px solid #872341',
                                    borderRadius: '8px',
                                    color: '#872341',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#872341';
                                    e.currentTarget.style.color = 'white';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = 'white';
                                    e.currentTarget.style.color = '#872341';
                                  }}
                                >
                                  <FaFileAlt style={{ fontSize: '14px' }} />
                                  View Rubric
                                </button>
                                
                                <button
                                  onClick={() => {
                                    console.log('View evaluation form clicked for project:', selectedPhaseSubmission.project_id);
                                    fetchProjectEvaluation(selectedPhaseSubmission.project_id);
                                    setShowProjectEvaluationModal(true);
                                  }}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: 'white',
                                    border: '2px solid #09122C',
                                    borderRadius: '8px',
                                    color: '#09122C',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#09122C';
                                    e.currentTarget.style.color = 'white';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = 'white';
                                    e.currentTarget.style.color = '#09122C';
                                  }}
                                >
                                  <FaClipboardList style={{ fontSize: '14px' }} />
                                  View Evaluation Form
                                </button>
                              </div>

                              {/* Project Information for Empty State */}
                              {selectedActivitiesProject && (
                                <div style={{
                                  width: '100%',
                                  maxWidth: '500px',
                                  padding: '16px',
                                  backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                  borderRadius: '8px',
                                  border: '1px solid rgba(9, 18, 44, 0.1)',
                                  textAlign: 'left'
                                }}>
                                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                    Project Information
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '8px' }}>
                                    {/* File Types Allowed */}
                                    {(() => {
                                      const fileTypes = selectedActivitiesProject?.file_types_allowed;
                                      if (fileTypes) {
                                        let parsedTypes = [];
                                        try {
                                          parsedTypes = typeof fileTypes === 'string' ? JSON.parse(fileTypes) : fileTypes;
                                        } catch (e) {
                                          parsedTypes = [];
                                        }
                                        if (parsedTypes.length > 0) {
                                          return (
                                            <div style={{
                                              gridColumn: '1 / -1',
                                              padding: '10px',
                                              backgroundColor: 'white',
                                              borderRadius: '6px',
                                              border: '1px solid rgba(135, 35, 65, 0.2)'
                                            }}>
                                              <div style={{ fontSize: '11px', fontWeight: '600', color: '#09122C', marginBottom: '4px' }}>
                                                File Types Allowed
                                              </div>
                                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                                                {parsedTypes.map((type, idx) => (
                                                  <span key={idx} style={{
                                                    padding: '2px 6px',
                                                    backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                                    borderRadius: '4px',
                                                    fontSize: '10px',
                                                    fontWeight: '600',
                                                    color: '#872341'
                                                  }}>
                                                    .{type}
                                                  </span>
                                                ))}
                                              </div>
                                            </div>
                                          );
                                        }
                                      }
                                      return null;
                                    })()}

                                    {/* Start Date */}
                                    {selectedActivitiesProject?.start_date && (
                                      <div style={{
                                        padding: '10px',
                                        backgroundColor: 'white',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(135, 35, 65, 0.2)'
                                      }}>
                                        <div style={{ fontSize: '10px', fontWeight: '600', color: '#09122C', marginBottom: '4px' }}>
                                          Start Date
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#BE3144' }}>
                                          {new Date(selectedActivitiesProject.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#BE3144' }}>
                                          {new Date(selectedActivitiesProject.start_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                      </div>
                                    )}

                                    {/* Due Date */}
                                    {selectedActivitiesProject?.due_date && (
                                      <div style={{
                                        padding: '10px',
                                        backgroundColor: 'white',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(135, 35, 65, 0.2)'
                                      }}>
                                        <div style={{ fontSize: '10px', fontWeight: '600', color: '#09122C', marginBottom: '4px' }}>
                                          Due Date
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#BE3144' }}>
                                          {new Date(selectedActivitiesProject.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#BE3144' }}>
                                          {new Date(selectedActivitiesProject.due_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                      </div>
                                    )}

                                    {/* Min Tasks Per Member */}
                                    {selectedActivitiesProject?.min_tasks_per_member !== undefined && (
                                      <div style={{
                                        padding: '10px',
                                        backgroundColor: 'white',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(135, 35, 65, 0.2)'
                                      }}>
                                        <div style={{ fontSize: '10px', fontWeight: '600', color: '#09122C', marginBottom: '4px' }}>
                                          Min Tasks
                                        </div>
                                        <div style={{ fontSize: '18px', color: '#BE3144', fontWeight: '700' }}>
                                          {selectedActivitiesProject.min_tasks_per_member}
                                        </div>
                                      </div>
                                    )}

                                    {/* Max Tasks Per Member */}
                                    {selectedActivitiesProject?.max_tasks_per_member !== undefined && (
                                      <div style={{
                                        padding: '10px',
                                        backgroundColor: 'white',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(135, 35, 65, 0.2)'
                                      }}>
                                        <div style={{ fontSize: '10px', fontWeight: '600', color: '#09122C', marginBottom: '4px' }}>
                                          Max Tasks
                                        </div>
                                        <div style={{ fontSize: '18px', color: '#BE3144', fontWeight: '700' }}>
                                          {selectedActivitiesProject.max_tasks_per_member}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            {/* Header with Grade */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '16px' }}>
                              <div style={{ flex: 1 }}>
                                <h3 style={{ 
                                  color: '#FFFFFF', 
                                  fontSize: '22px', 
                                  fontWeight: '700', 
                                  marginBottom: '12px' 
                                }}>
                                  {selectedPhaseSubmission.phase_snapshot ? 
                                    `Phase ${selectedPhaseSubmission.phase_snapshot.phase_number}: ${selectedPhaseSubmission.phase_snapshot.title}` :
                                    'Project Submission'}
                                </h3>
                                
                                {/* Date Pills */}
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
                                  {/* Start Date Pill */}
                                  {(() => {
                                    const startDate = selectedPhaseSubmission.phase_snapshot 
                                      ? selectedPhaseSubmission.phase_snapshot.start_date 
                                      : selectedActivitiesProject?.start_date;
                                    
                                    if (startDate) {
                                      const startDateObj = new Date(startDate);
                                      return (
                                        <div style={{
                                          padding: '6px 12px',
                                          backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                          border: '1px solid #872341',
                                          borderRadius: '20px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px'
                                        }}>
                                          <FaCalendarAlt style={{ fontSize: '11px', color: '#872341' }} />
                                          <span style={{ fontSize: '11px', fontWeight: '600', color: '#872341' }}>
                                            Start: {startDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {startDateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                          </span>
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}

                                  {/* Due Date Pill */}
                                  {(() => {
                                    const dueDate = selectedPhaseSubmission.phase_snapshot 
                                      ? selectedPhaseSubmission.phase_snapshot.end_date 
                                      : selectedActivitiesProject?.due_date;
                                    
                                    if (dueDate) {
                                      const dueDateObj = new Date(dueDate);
                                      return (
                                        <div style={{
                                          padding: '6px 12px',
                                          backgroundColor: 'rgba(190, 49, 68, 0.1)',
                                          border: '1px solid #BE3144',
                                          borderRadius: '20px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px'
                                        }}>
                                          <FaClock style={{ fontSize: '11px', color: '#BE3144' }} />
                                          <span style={{ fontSize: '11px', fontWeight: '600', color: '#BE3144' }}>
                                            Due: {dueDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {dueDateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                          </span>
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}

                                  {/* Submitted Date Pill */}
                                  {selectedPhaseSubmission.submitted_at && (
                                    <div style={{
                                      padding: '6px 12px',
                                      backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                      border: '1px solid #059669',
                                      borderRadius: '20px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '6px'
                                    }}>
                                      <FaCheckCircle style={{ fontSize: '11px', color: '#059669' }} />
                                      <span style={{ fontSize: '11px', fontWeight: '600', color: '#059669' }}>
                                        Submitted: {new Date(selectedPhaseSubmission.submitted_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at {new Date(selectedPhaseSubmission.submitted_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                      </span>
                                    </div>
                                  )}
                                </div>
                                
                                {/* Action Buttons */}
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginTop: '12px' }}>
                                  {/* For Phase Submissions */}
                                  {selectedPhaseSubmission.phase_snapshot && selectedPhaseSubmission.phase_id && (
                                    <>
                                      <button
                                        onClick={() => {
                                          console.log('View rubric clicked for phase:', selectedPhaseSubmission.phase_id);
                                          const phaseInfo = selectedPhaseSubmission.phase_snapshot || { phase_number: 'Unknown' };
                                          setCurrentRubricPhase(phaseInfo);
                                          fetchPhaseRubric(selectedPhaseSubmission.phase_id, setPhaseRubricData, setRubricLoading);
                                          setShowPhaseRubricModal(true);
                                        }}
                                        style={{
                                          padding: '8px 16px',
                                          backgroundColor: 'white',
                                          border: '1px solid #872341',
                                          borderRadius: '6px',
                                          color: '#872341',
                                          fontSize: '13px',
                                          fontWeight: '600',
                                          cursor: 'pointer',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px',
                                          transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.backgroundColor = '#872341';
                                          e.currentTarget.style.color = 'white';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.backgroundColor = 'white';
                                          e.currentTarget.style.color = '#872341';
                                        }}
                                      >
                                        <FaFileAlt style={{ fontSize: '12px' }} />
                                        View Rubric
                                      </button>
                                      
                                      <button
                                        onClick={() => {
                                          console.log('View evaluation form clicked for phase:', selectedPhaseSubmission.phase_id);
                                          const phaseInfo = selectedPhaseSubmission.phase_snapshot || { phase_number: 'Unknown' };
                                          setCurrentEvalFormPhase(phaseInfo);
                                          fetchPhaseEvaluationForm(selectedPhaseSubmission.phase_id, setPhaseEvalFormData, setEvalFormLoading);
                                          setShowPhaseEvalFormModal(true);
                                        }}
                                        style={{
                                          padding: '8px 16px',
                                          backgroundColor: 'white',
                                          border: '1px solid #09122C',
                                          borderRadius: '6px',
                                          color: '#09122C',
                                          fontSize: '13px',
                                          fontWeight: '600',
                                          cursor: 'pointer',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px',
                                          transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.backgroundColor = '#09122C';
                                          e.currentTarget.style.color = 'white';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.backgroundColor = 'white';
                                          e.currentTarget.style.color = '#09122C';
                                        }}
                                      >
                                        <FaClipboardList style={{ fontSize: '12px' }} />
                                        View Evaluation Form
                                      </button>
                                    </>
                                  )}
                                  
                                  {/* For Project Submissions */}
                                  {!selectedPhaseSubmission.phase_id && selectedPhaseSubmission.project_id && (
                                    <>
                                      <button
                                        onClick={() => {
                                          console.log('View rubric clicked for project:', selectedPhaseSubmission.project_id);
                                          fetchProjectRubric(selectedPhaseSubmission.project_id);
                                          setShowProjectRubricModal(true);
                                        }}
                                        style={{
                                          padding: '8px 16px',
                                          backgroundColor: 'white',
                                          border: '1px solid #872341',
                                          borderRadius: '6px',
                                          color: '#872341',
                                          fontSize: '13px',
                                          fontWeight: '600',
                                          cursor: 'pointer',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px',
                                          transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.backgroundColor = '#872341';
                                          e.currentTarget.style.color = 'white';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.backgroundColor = 'white';
                                          e.currentTarget.style.color = '#872341';
                                        }}
                                      >
                                        <FaFileAlt style={{ fontSize: '12px' }} />
                                        View Rubric
                                      </button>
                                      
                                      <button
                                        onClick={() => {
                                          console.log('View evaluation form clicked for project:', selectedPhaseSubmission.project_id);
                                          fetchProjectEvaluation(selectedPhaseSubmission.project_id);
                                          setShowProjectEvaluationModal(true);
                                        }}
                                        style={{
                                          padding: '8px 16px',
                                          backgroundColor: 'white',
                                          border: '1px solid #09122C',
                                          borderRadius: '6px',
                                          color: '#09122C',
                                          fontSize: '13px',
                                          fontWeight: '600',
                                          cursor: 'pointer',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px',
                                          transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.backgroundColor = '#09122C';
                                          e.currentTarget.style.color = 'white';
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.backgroundColor = 'white';
                                          e.currentTarget.style.color = '#09122C';
                                        }}
                                      >
                                        <FaClipboardList style={{ fontSize: '12px' }} />
                                        View Evaluation Form
                                      </button>
                                    </>
                                  )}
                                </div>
                              </div>
                              
                              {/* Grade Box */}
                              {selectedPhaseSubmission.grade && (
                                <div style={{
                                  minWidth: '120px',
                                  padding: '16px',
                                  backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                  border: '2px solid rgba(5, 150, 105, 0.3)',
                                  borderRadius: '12px',
                                  textAlign: 'center'
                                }}>
                                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#059669', marginBottom: '4px' }}>
                                    Phase Grade
                                  </div>
                                  <div style={{ fontSize: '32px', fontWeight: '700', color: '#059669', lineHeight: '1' }}>
                                    {selectedPhaseSubmission.grade}
                                  </div>
                                  <div style={{ fontSize: '14px', color: '#059669', marginTop: '4px' }}>
                                    / {selectedPhaseSubmission.max_grade}
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Phase/Project Information */}
                            {(selectedPhaseSubmission.phase_snapshot || (!selectedPhaseSubmission.phase_id && selectedActivitiesProject)) && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  {selectedPhaseSubmission.phase_snapshot ? 'Phase' : 'Project'} Information
                                </div>
                                
                                {/* Phase/Project Description */}
                                {(selectedPhaseSubmission.phase_snapshot?.description || selectedActivitiesProject?.description) && (
                                  <div style={{ marginBottom: '16px' }}>
                                    <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C', marginBottom: '6px' }}>
                                      Description
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#BE3144', lineHeight: '1.6' }}>
                                      {selectedPhaseSubmission.phase_snapshot?.description || selectedActivitiesProject?.description}
                                    </div>
                                  </div>
                                )}
                                
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px' }}>
                                  {/* File Types Allowed */}
                                  {(() => {
                                    const fileTypes = selectedPhaseSubmission.phase_snapshot 
                                      ? selectedPhaseSubmission.phase_snapshot.file_types_allowed 
                                      : selectedActivitiesProject?.file_types_allowed;
                                    
                                    if (fileTypes) {
                                      let parsedTypes = [];
                                      try {
                                        parsedTypes = typeof fileTypes === 'string' ? JSON.parse(fileTypes) : fileTypes;
                                      } catch (e) {
                                        parsedTypes = [];
                                      }
                                      
                                      if (parsedTypes.length > 0) {
                                        return (
                                          <div style={{
                                            padding: '12px',
                                            backgroundColor: 'white',
                                            borderRadius: '6px',
                                            border: '1px solid rgba(135, 35, 65, 0.2)'
                                          }}>
                                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#09122C', marginBottom: '6px' }}>
                                              File Types Allowed
                                            </div>
                                            <div style={{ fontSize: '13px', color: '#BE3144', display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                                              {parsedTypes.map((type, idx) => (
                                                <span key={idx} style={{
                                                  padding: '2px 8px',
                                                  backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                                  borderRadius: '4px',
                                                  fontSize: '11px',
                                                  fontWeight: '600',
                                                  color: '#872341'
                                                }}>
                                                  .{type}
                                                </span>
                                              ))}
                                            </div>
                                          </div>
                                        );
                                      }
                                    }
                                    return null;
                                  })()}

                                  {/* Max Attempts (for phases) */}
                                  {selectedPhaseSubmission.phase_snapshot?.max_attempts && (
                                    <div style={{
                                      padding: '12px',
                                      backgroundColor: 'white',
                                      borderRadius: '6px',
                                      border: '1px solid rgba(135, 35, 65, 0.2)'
                                    }}>
                                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#09122C', marginBottom: '6px' }}>
                                        Max Attempts
                                      </div>
                                      <div style={{ fontSize: '20px', color: '#BE3144', fontWeight: '700' }}>
                                        {selectedPhaseSubmission.phase_snapshot.max_attempts}
                                      </div>
                                    </div>
                                  )}

                                  {/* Min Tasks Per Member */}
                                  {(() => {
                                    const minTasks = selectedPhaseSubmission.phase_snapshot 
                                      ? (selectedActivitiesProject?.min_tasks_per_member || 1)
                                      : selectedActivitiesProject?.min_tasks_per_member;
                                    
                                    if (minTasks !== undefined && minTasks !== null) {
                                      return (
                                        <div style={{
                                          padding: '12px',
                                          backgroundColor: 'white',
                                          borderRadius: '6px',
                                          border: '1px solid rgba(135, 35, 65, 0.2)'
                                        }}>
                                          <div style={{ fontSize: '12px', fontWeight: '600', color: '#09122C', marginBottom: '6px' }}>
                                            Min Tasks Per Member
                                          </div>
                                          <div style={{ fontSize: '20px', color: '#BE3144', fontWeight: '700' }}>
                                            {minTasks}
                                          </div>
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}

                                  {/* Max Tasks Per Member */}
                                  {(() => {
                                    const maxTasks = selectedPhaseSubmission.phase_snapshot 
                                      ? (selectedActivitiesProject?.max_tasks_per_member || 5)
                                      : selectedActivitiesProject?.max_tasks_per_member;
                                    
                                    if (maxTasks !== undefined && maxTasks !== null) {
                                      return (
                                        <div style={{
                                          padding: '12px',
                                          backgroundColor: 'white',
                                          borderRadius: '6px',
                                          border: '1px solid rgba(135, 35, 65, 0.2)'
                                        }}>
                                          <div style={{ fontSize: '12px', fontWeight: '600', color: '#09122C', marginBottom: '6px' }}>
                                            Max Tasks Per Member
                                          </div>
                                          <div style={{ fontSize: '20px', color: '#BE3144', fontWeight: '700' }}>
                                            {maxTasks}
                                          </div>
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}
                                </div>
                              </div>
                            )}

                            {/* Submission Files */}
                            {selectedPhaseSubmission.files && selectedPhaseSubmission.files.length > 0 && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  Submitted Files ({selectedPhaseSubmission.files.length})
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {selectedPhaseSubmission.files.map((file, index) => {
                                    const handleDownload = async (e) => {
                                      e.stopPropagation();
                                      try {
                                        const response = await fetch(file.url);
                                        const blob = await response.blob();
                                        const url = window.URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = file.name;
                                        document.body.appendChild(a);
                                        a.click();
                                        window.URL.revokeObjectURL(url);
                                        document.body.removeChild(a);
                                      } catch (error) {
                                        console.error('Download failed:', error);
                                        alert('Failed to download file');
                                      }
                                    };

                                    return (
                                      <div
                                        key={index}
                                        style={{
                                          padding: '12px',
                                          backgroundColor: 'white',
                                          border: '1px solid rgba(135, 35, 65, 0.2)',
                                          borderRadius: '8px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '12px'
                                        }}
                                      >
                                        <FaFileAlt style={{ color: '#872341', fontSize: '20px' }} />
                                        <div style={{ flex: 1 }}>
                                          <div style={{ fontSize: '14px', fontWeight: '600', color: '#09122C' }}>
                                            {file.name}
                                          </div>
                                          <div style={{ fontSize: '12px', color: '#BE3144' }}>
                                            {(file.size / 1024).toFixed(2)} KB
                                          </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                          <button
                                            onClick={() => window.open(file.url, '_blank')}
                                            style={{
                                              padding: '8px 12px',
                                              backgroundColor: 'white',
                                              border: '1px solid #09122C',
                                              borderRadius: '6px',
                                              color: '#09122C',
                                              fontSize: '12px',
                                              fontWeight: '600',
                                              cursor: 'pointer',
                                              display: 'flex',
                                              alignItems: 'center',
                                              gap: '6px',
                                              transition: 'all 0.2s'
                                            }}
                                            onMouseOver={(e) => {
                                              e.currentTarget.style.backgroundColor = '#09122C';
                                              e.currentTarget.style.color = 'white';
                                            }}
                                            onMouseOut={(e) => {
                                              e.currentTarget.style.backgroundColor = 'white';
                                              e.currentTarget.style.color = '#09122C';
                                            }}
                                          >
                                            <FaEye style={{ fontSize: '12px' }} />
                                            View
                                          </button>
                                          <button
                                            onClick={handleDownload}
                                            style={{
                                              padding: '8px 12px',
                                              backgroundColor: '#872341',
                                              border: '1px solid #872341',
                                              borderRadius: '6px',
                                              color: 'white',
                                              fontSize: '12px',
                                              fontWeight: '600',
                                              cursor: 'pointer',
                                              display: 'flex',
                                              alignItems: 'center',
                                              gap: '6px',
                                              transition: 'all 0.2s'
                                            }}
                                            onMouseOver={(e) => {
                                              e.currentTarget.style.backgroundColor = '#6B1D33';
                                            }}
                                            onMouseOut={(e) => {
                                              e.currentTarget.style.backgroundColor = '#872341';
                                            }}
                                          >
                                            <FaDownload style={{ fontSize: '12px' }} />
                                            Download
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            )}

                            {/* Member Submissions */}
                            {selectedPhaseSubmission.member_tasks && selectedPhaseSubmission.member_tasks.length > 0 && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(135, 35, 65, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(135, 35, 65, 0.15)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  Member Submissions ({selectedPhaseSubmission.member_tasks.length} members)
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {selectedPhaseSubmission.member_tasks.map((memberData, index) => {
                                    const memberId = memberData.member_id || index;
                                    const isExpanded = expandedMemberSubmissions[memberId];
                                    
                                    return (
                                    <div 
                                      key={index}
                                      style={{
                                        padding: '12px',
                                        backgroundColor: 'white',
                                        borderRadius: '8px',
                                        border: '1px solid rgba(135, 35, 65, 0.2)'
                                      }}
                                    >
                                      {/* Member Header - Clickable to toggle */}
                                      <div 
                                        onClick={() => {
                                          setExpandedMemberSubmissions(prev => ({
                                            ...prev,
                                            [memberId]: !prev[memberId]
                                          }));
                                        }}
                                        style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between', 
                                          alignItems: 'center', 
                                          cursor: 'pointer',
                                          userSelect: 'none'
                                        }}
                                      >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                                          <div style={{
                                            width: '20px',
                                            height: '20px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            transition: 'transform 0.2s'
                                          }}>
                                            <FaChevronRight 
                                              style={{ 
                                                fontSize: '12px', 
                                                color: '#872341',
                                                transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                                transition: 'transform 0.2s'
                                              }} 
                                            />
                                          </div>
                                          <div>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: '#09122C' }}>
                                              {memberData.member_name}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#872341', marginTop: '2px' }}>
                                              {memberData.task_count} task(s) ‚Ä¢ {memberData.min_required} min / {memberData.max_allowed} max
                                            </div>
                                          </div>
                                        </div>
                                        <div style={{
                                          padding: '4px 8px',
                                          borderRadius: '12px',
                                          fontSize: '12px',
                                          fontWeight: '600',
                                          backgroundColor: memberData.role === 'leader' ? 'rgba(135, 35, 65, 0.1)' : 'rgba(9, 18, 44, 0.08)',
                                          color: memberData.role === 'leader' ? '#872341' : '#09122C'
                                        }}>
                                          {memberData.role}
                                        </div>
                                      </div>
                                      
                                      {/* Expandable Task Details */}
                                      {isExpanded && memberData.tasks && memberData.tasks.length > 0 && (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(135, 35, 65, 0.2)' }}>
                                          {memberData.tasks.map((task, taskIndex) => {
                                            // Get all submitted files from submission_files array
                                            const allSubmittedFiles = [];
                                            let revisionCount = 0;
                                            
                                            if (task.submission_files && task.submission_files.length > 0) {
                                              task.submission_files.forEach(submission => {
                                                if (submission.is_revision) {
                                                  revisionCount++;
                                                }
                                                if (submission.files && submission.files.length > 0) {
                                                  submission.files.forEach(filePath => {
                                                    allSubmittedFiles.push({
                                                      path: filePath,
                                                      status: submission.status,
                                                      attempt: submission.attempt_number,
                                                      submitted_at: submission.submitted_at,
                                                      is_revision: submission.is_revision
                                                    });
                                                  });
                                                }
                                              });
                                            }
                                            
                                            return (
                                              <div 
                                                key={taskIndex}
                                                style={{
                                                  padding: '8px',
                                                  backgroundColor: 'rgba(9, 18, 44, 0.02)',
                                                  borderRadius: '6px',
                                                  fontSize: '11px'
                                                }}
                                              >
                                                <div style={{ fontWeight: '600', color: '#09122C', marginBottom: '4px', fontSize: '13px' }}>
                                                  {task.title}
                                                </div>
                                                <div style={{ color: '#BE3144', marginBottom: allSubmittedFiles.length > 0 ? '6px' : '0', fontSize: '12px' }}>
                                                  Status: {task.status} ‚Ä¢ Attempts: {task.current_attempts}/{task.max_attempts}
                                                  {revisionCount > 0 && (
                                                    <span style={{ color: '#0284C7', fontWeight: '600' }}> ‚Ä¢ {revisionCount} revision{revisionCount > 1 ? 's' : ''}</span>
                                                  )}
                                                </div>
                                                
                                                {/* Display submitted files */}
                                                {allSubmittedFiles.length > 0 && (
                                                  <div style={{ marginTop: '6px', paddingTop: '6px', borderTop: '1px solid rgba(9, 18, 44, 0.1)' }}>
                                                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#872341', marginBottom: '4px' }}>
                                                      Submitted Files ({allSubmittedFiles.length}):
                                                    </div>
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                      {allSubmittedFiles.map((fileInfo, fileIdx) => {
                                                        // Extract filename from path
                                                        const fileName = fileInfo.path.split('/').pop();
                                                        // Use backend API endpoint for task submission files
                                                        const fileUrl = `/api/files/task-submissions/${fileInfo.path}`;
                                                        
                                                        const handleDownload = async (e) => {
                                                          e.stopPropagation();
                                                          try {
                                                            const token = localStorage.getItem('token');
                                                            const response = await fetch(fileUrl, {
                                                              method: 'GET',
                                                              headers: {
                                                                'Authorization': `Bearer ${token}`,
                                                                'Content-Type': 'application/json'
                                                              }
                                                            });
                                                            
                                                            if (!response.ok) {
                                                              throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                                                            }
                                                            
                                                            const blob = await response.blob();
                                                            const url = window.URL.createObjectURL(blob);
                                                            const a = document.createElement('a');
                                                            a.href = url;
                                                            a.download = fileName;
                                                            document.body.appendChild(a);
                                                            a.click();
                                                            window.URL.revokeObjectURL(url);
                                                            document.body.removeChild(a);
                                                          } catch (error) {
                                                            console.error('Download failed:', error);
                                                            alert('Failed to download file: ' + fileName);
                                                          }
                                                        };

                                                        return (
                                                          <div
                                                            key={fileIdx}
                                                            style={{
                                                              padding: '6px',
                                                              backgroundColor: 'white',
                                                              border: '1px solid rgba(135, 35, 65, 0.2)',
                                                              borderRadius: '4px',
                                                              display: 'flex',
                                                              alignItems: 'center',
                                                              gap: '6px',
                                                              fontSize: '11px'
                                                            }}
                                                          >
                                                            <FaFileAlt style={{ color: '#872341', fontSize: '11px', flexShrink: 0 }} />
                                                            <span style={{ 
                                                              flex: 1, 
                                                              color: '#09122C', 
                                                              overflow: 'hidden', 
                                                              textOverflow: 'ellipsis', 
                                                              whiteSpace: 'nowrap',
                                                              fontSize: '11px'
                                                            }}>
                                                              {fileName}
                                                            </span>
                                                            <span style={{ 
                                                              fontSize: '10px', 
                                                              color: '#BE3144',
                                                              flexShrink: 0,
                                                              marginRight: '4px'
                                                            }}>
                                                              {fileInfo.is_revision ? 'Rev' : `#${fileInfo.attempt}`}
                                                            </span>
                                                            <div style={{ display: 'flex', gap: '4px' }}>
                                                              <button
                                                                onClick={() => window.open(fileUrl, '_blank')}
                                                                style={{
                                                                  padding: '3px 6px',
                                                                  backgroundColor: 'white',
                                                                  border: '1px solid #09122C',
                                                                  borderRadius: '3px',
                                                                  color: '#09122C',
                                                                  fontSize: '10px',
                                                                  fontWeight: '600',
                                                                  cursor: 'pointer',
                                                                  display: 'flex',
                                                                  alignItems: 'center',
                                                                  gap: '3px',
                                                                  transition: 'all 0.2s'
                                                                }}
                                                                onMouseOver={(e) => {
                                                                  e.currentTarget.style.backgroundColor = '#09122C';
                                                                  e.currentTarget.style.color = 'white';
                                                                }}
                                                                onMouseOut={(e) => {
                                                                  e.currentTarget.style.backgroundColor = 'white';
                                                                  e.currentTarget.style.color = '#09122C';
                                                                }}
                                                              >
                                                                <FaEye style={{ fontSize: '9px' }} />
                                                              </button>
                                                              <button
                                                                onClick={handleDownload}
                                                                style={{
                                                                  padding: '3px 6px',
                                                                  backgroundColor: '#872341',
                                                                  border: '1px solid #872341',
                                                                  borderRadius: '3px',
                                                                  color: 'white',
                                                                  fontSize: '10px',
                                                                  fontWeight: '600',
                                                                  cursor: 'pointer',
                                                                  display: 'flex',
                                                                  alignItems: 'center',
                                                                  gap: '3px',
                                                                  transition: 'all 0.2s'
                                                                }}
                                                                onMouseOver={(e) => {
                                                                  e.currentTarget.style.backgroundColor = '#6B1D33';
                                                                }}
                                                                onMouseOut={(e) => {
                                                                  e.currentTarget.style.backgroundColor = '#872341';
                                                                }}
                                                              >
                                                                <FaDownload style={{ fontSize: '9px' }} />
                                                              </button>
                                                            </div>
                                                          </div>
                                                        );
                                                      })}
                                                    </div>
                                                  </div>
                                                )}
                                              </div>
                                            );
                                          })}
                                        </div>
                                      )}
                                    </div>
                                    );
                                  })}
                                </div>
                              </div>
                            )}

                            {/* Member Inclusions */}
                            {selectedPhaseSubmission.member_inclusions && selectedPhaseSubmission.member_inclusions.length > 0 && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(9, 18, 44, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(9, 18, 44, 0.1)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  Member Inclusions
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {selectedPhaseSubmission.member_inclusions.map((member, index) => (
                                    <div 
                                      key={index}
                                      style={{
                                        padding: '10px',
                                        backgroundColor: member.included ? 'rgba(5, 150, 105, 0.05)' : 'rgba(220, 38, 38, 0.05)',
                                        borderRadius: '6px',
                                        border: `1px solid ${member.included ? 'rgba(5, 150, 105, 0.2)' : 'rgba(220, 38, 38, 0.2)'}`,
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                      }}
                                    >
                                      <div>
                                        <div style={{ fontSize: '13px', fontWeight: '600', color: '#09122C' }}>
                                          {member.member_name}
                                        </div>
                                        {!member.included && member.exclusion_reason && (
                                          <div style={{ fontSize: '12px', color: '#BE3144', marginTop: '4px' }}>
                                            Reason: {member.exclusion_reason}
                                          </div>
                                        )}
                                      </div>
                                      <div style={{
                                        padding: '4px 8px',
                                        borderRadius: '12px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        backgroundColor: member.included ? 'rgba(5, 150, 105, 0.1)' : 'rgba(220, 38, 38, 0.1)',
                                        color: member.included ? '#059669' : '#DC2626'
                                      }}>
                                        {member.included ? 'Included' : 'Excluded'}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Validation Results */}
                            {selectedPhaseSubmission.validation_results && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(190, 49, 68, 0.06)',
                                borderRadius: '8px',
                                border: '1px solid rgba(190, 49, 68, 0.2)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  Validation Results
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  <div style={{ fontSize: '13px', color: '#09122C' }}>
                                    ‚úì Files Uploaded: {selectedPhaseSubmission.validation_results.files_uploaded ? 'Yes' : 'No'}
                                  </div>
                                  <div style={{ fontSize: '13px', color: '#09122C' }}>
                                    ‚úì Min Tasks Met: {selectedPhaseSubmission.validation_results.min_tasks_met ? 'Yes' : 'No'}
                                  </div>
                                  {selectedPhaseSubmission.validation_results.evaluation_warnings && selectedPhaseSubmission.validation_results.evaluation_warnings.length > 0 && (
                                    <div style={{ marginTop: '8px' }}>
                                      <div style={{ fontSize: '13px', fontWeight: '600', color: '#872341', marginBottom: '6px' }}>
                                        Warnings:
                                      </div>
                                      {selectedPhaseSubmission.validation_results.evaluation_warnings.map((warning, idx) => (
                                        <div key={idx} style={{ fontSize: '12px', color: '#BE3144', marginLeft: '16px' }}>
                                          {warning.icon} {warning.message}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Instructor Feedback */}
                            {selectedPhaseSubmission.instructor_feedback && (
                              <div style={{
                                padding: '16px',
                                backgroundColor: 'rgba(135, 35, 65, 0.04)',
                                borderRadius: '8px',
                                border: '1px solid rgba(135, 35, 65, 0.15)'
                              }}>
                                <div style={{ fontSize: '15px', fontWeight: '600', color: '#09122C', marginBottom: '12px' }}>
                                  Instructor Feedback
                                </div>
                                <div style={{ fontSize: '14px', color: '#BE3144', lineHeight: '1.6' }}>
                                  {selectedPhaseSubmission.instructor_feedback}
                                </div>
                                {selectedPhaseSubmission.graded_at && (
                                  <div style={{ fontSize: '12px', color: '#872341', marginTop: '8px' }}>
                                    Graded on {new Date(selectedPhaseSubmission.graded_at).toLocaleDateString()} at {new Date(selectedPhaseSubmission.graded_at).toLocaleTimeString()}
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                          )
                        ) : (
                          <div style={{
                            textAlign: 'center',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            gap: '12px'
                          }}>
                            <div style={{
                              width: '64px',
                              height: '64px',
                              borderRadius: '50%',
                              backgroundColor: 'rgba(9, 18, 44, 0.1)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              marginBottom: '8px'
                            }}>
                              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#09122C" strokeWidth="2">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            </div>
                            <div style={{ fontSize: '16px', fontWeight: '600', color: '#09122C' }}>
                              No Submission Selected
                            </div>
                            <div style={{ fontSize: '13px', color: '#BE3144', maxWidth: '250px', lineHeight: '1.5' }}>
                              Select a phase submission from the list to view details
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div style={{
                      backgroundColor: 'white',
                      border: '1px solid #B9B28A',
                      borderRadius: '8px',
                      padding: '20px',
                      minHeight: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <p style={{
                        color: '#9CA3AF',
                        fontSize: '16px',
                        fontStyle: 'italic',
                        textAlign: 'center'
                      }}>
                        Select a project and phase to view activities
                      </p>
                    </div>
                  )}
                  </div>
                </div>
              </div>
            )}

            {/* Reports Tab */}
            {activeGroupTab === 'reports' && (
              <>
              {/* Combined Project/Phase Dropdown - Centered Outside Card */}
              <div style={{
                display: 'flex',
                justifyContent: 'center',
                marginBottom: '20px',
                position: 'relative',
                zIndex: 100
              }}>
                {/* Combined Dropdown Container */}
                <div style={{
                  display: 'flex',
                  backgroundColor: 'rgb(255, 255, 255)',
                  border: '2px solid rgb(255, 255, 255)',
                  borderRadius: '8px',
                  overflow: 'visible',
                  minWidth: '600px'
                }}>
                  {/* Project Dropdown */}
                  <div className="reports-project-dropdown" style={{ position: 'relative', zIndex: 102, flex: 1 }}>
                    <button
                      onClick={() => {
                        setShowReportsProjectDropdown(!showReportsProjectDropdown);
                        setShowReportsGanttPhaseDropdown(false);
                      }}
                      style={{
                        width: '100%',
                        padding: '8px 24px',
                        backgroundColor: 'rgb(255, 255, 255)',
                        color: 'rgb(135, 35, 65)',
                        border: 'none',
                        borderRight: '1px solid rgba(135, 35, 65, 0.2)',
                        borderRadius: '0',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between',
                        transition: '0.2s',
                        minHeight: '42px'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = '#f8f9fa';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {selectedReportsProject ? selectedReportsProject.title : 'Select Project'}
                      </span>
                      <FaChevronDown style={{ transition: 'transform 0.3s', transform: showReportsProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)', fontSize: '12px', flexShrink: 0 }} />
                    </button>
                    
                  {showReportsProjectDropdown && (
                    <div style={{
                      position: 'absolute',
                      top: 'calc(100% + 8px)',
                      left: 0,
                      right: 0,
                      backgroundColor: 'white',
                      borderRadius: '12px',
                      boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
                      zIndex: 9999,
                      maxHeight: '400px',
                      overflowY: 'auto',
                      border: '1px solid #e5e7eb'
                    }}>
                          {activeProjects && activeProjects.length > 0 ? (
                            activeProjects.map(project => (
                              <div
                                key={project.id}
                                onClick={() => {
                                  setSelectedReportsProject(project);
                                  setShowReportsProjectDropdown(false);
                                }}
                                style={{
                                  padding: '16px 20px',
                                  cursor: 'pointer',
                                  borderBottom: '1px solid #f0f0f0',
                                  transition: 'all 0.2s ease',
                                  backgroundColor: selectedReportsProject?.id === project.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '12px'
                                }}
                                onMouseOver={(e) => {
                                  e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                                  e.currentTarget.style.paddingLeft = '24px';
                                }}
                                onMouseOut={(e) => {
                                  e.currentTarget.style.backgroundColor = selectedReportsProject?.id === project.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                                  e.currentTarget.style.paddingLeft = '20px';
                                }}
                              >
                                <FaProjectDiagram style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px', marginBottom: '2px' }}>
                                    {project.title}
                                  </div>
                                  {project.start_date && project.end_date && (
                                    <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                      {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                    </div>
                                  )}
                                </div>
                                {selectedReportsProject?.id === project.id && (
                                  <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                                )}
                              </div>
                            ))
                          ) : (
                        <div style={{ padding: '16px 20px', color: '#9CA3AF', fontSize: '14px', textAlign: 'center' }}>
                          No projects available
                        </div>
                      )}
                    </div>
                  )}
                  </div>

                  {/* Phase Dropdown */}
                  <div className="reports-phase-dropdown" style={{ position: 'relative', zIndex: 101, flex: 1 }}>
                    <button
                      onClick={() => {
                        setShowReportsGanttPhaseDropdown(!showReportsGanttPhaseDropdown);
                        setShowReportsProjectDropdown(false);
                      }}
                      disabled={!selectedReportsProject}
                      style={{
                        width: '100%',
                        padding: '8px 24px',
                        backgroundColor: selectedReportsProject ? 'rgb(255, 255, 255)' : 'rgb(245, 245, 245)',
                        color: selectedReportsProject ? 'rgb(135, 35, 65)' : 'rgb(156, 163, 175)',
                        border: 'none',
                        borderRadius: '0',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: selectedReportsProject ? 'pointer' : 'not-allowed',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between',
                        transition: '0.2s',
                        minHeight: '42px'
                      }}
                      onMouseOver={(e) => {
                        if (selectedReportsProject) {
                          e.currentTarget.style.backgroundColor = '#f8f9fa';
                          e.currentTarget.style.transform = 'translateY(-1px)';
                        }
                      }}
                      onMouseOut={(e) => {
                        if (selectedReportsProject) {
                          e.currentTarget.style.backgroundColor = 'rgb(255, 255, 255)';
                          e.currentTarget.style.transform = 'translateY(0)';
                        }
                      }}
                    >
                      <FaTasks style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {selectedGanttPhase ? `Phase ${selectedGanttPhase.phase_number}: ${selectedGanttPhase.title}` : 'All Phases'}
                      </span>
                      <FaChevronDown style={{ transition: 'transform 0.3s', transform: showReportsGanttPhaseDropdown ? 'rotate(180deg)' : 'rotate(0deg)', fontSize: '12px', flexShrink: 0 }} />
                    </button>
                  {showReportsGanttPhaseDropdown && selectedReportsProject && selectedReportsProject.project_phases && (
                    <div style={{
                      position: 'absolute',
                      top: 'calc(100% + 8px)',
                      left: 0,
                      right: 0,
                      backgroundColor: 'white',
                      borderRadius: '12px',
                      boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
                      zIndex: 9999,
                      maxHeight: '400px',
                      overflowY: 'auto',
                      border: '1px solid #e5e7eb'
                    }}>
                          {/* All Phases Option */}
                          <div
                            onClick={() => {
                              setSelectedGanttPhase(null);
                              setShowReportsGanttPhaseDropdown(false);
                            }}
                            style={{
                              padding: '16px 20px',
                              cursor: 'pointer',
                              borderBottom: '1px solid #f0f0f0',
                              transition: 'all 0.2s ease',
                              backgroundColor: !selectedGanttPhase ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '12px'
                            }}
                            onMouseOver={(e) => {
                              e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                              e.currentTarget.style.paddingLeft = '24px';
                            }}
                            onMouseOut={(e) => {
                              e.currentTarget.style.backgroundColor = !selectedGanttPhase ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                              e.currentTarget.style.paddingLeft = '20px';
                            }}
                          >
                            <FaClipboardList style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px' }}>
                                All Phases (Overview)
                              </div>
                            </div>
                            {!selectedGanttPhase && (
                              <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                            )}
                          </div>
                          {selectedReportsProject.project_phases.map((phase) => (
                            <div
                              key={phase.id}
                              onClick={() => {
                                setSelectedGanttPhase(phase);
                                setShowReportsGanttPhaseDropdown(false);
                              }}
                              style={{
                                padding: '16px 20px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f0f0f0',
                                transition: 'all 0.2s ease',
                                backgroundColor: selectedGanttPhase?.id === phase.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                              }}
                              onMouseOver={(e) => {
                                e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.08)';
                                e.currentTarget.style.paddingLeft = '24px';
                              }}
                              onMouseOut={(e) => {
                                e.currentTarget.style.backgroundColor = selectedGanttPhase?.id === phase.id ? 'rgba(135, 35, 65, 0.08)' : 'transparent';
                                e.currentTarget.style.paddingLeft = '20px';
                              }}
                            >
                              <FaTasks style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: '600', color: '#09122C', fontSize: '14px', marginBottom: '2px' }}>
                                  Phase {phase.phase_number}: {phase.title}
                                </div>
                                <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                  {new Date(phase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(phase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                </div>
                              </div>
                              {selectedGanttPhase?.id === phase.id && (
                                <FaCheckCircle style={{ fontSize: '16px', color: '#872341', flexShrink: 0 }} />
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                  </div>
                </div>
              </div>
                
                {/* Main Reports Card */}
                <div className="my-group-card-with-crosshair" style={{
                  background: 'rgba(9, 18, 44, 0.15)',
                  backdropFilter: 'blur(3.2px) saturate(120%)',
                  WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                  border: '0.1px solid rgb(95, 95, 95)',
                  borderRadius: '0px',
                  padding: '28px',
                  minHeight: '400px',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.08)'
                }}>
                  {/* Crosshair Corners */}
                  <div className="crosshair-corner top-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner top-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-left">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  <div className="crosshair-corner bottom-right">
                    <div className="crosshair-h"></div>
                    <div className="crosshair-v"></div>
                  </div>
                  
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '24px',
                    zIndex: 10,
                    position: 'relative'
                  }}>
                    <h2 style={{
                      color: 'white',
                      fontSize: '26px',
                      fontWeight: '700',
                      margin: 0
                    }}>
                      {selectedReportsProject 
                        ? `${selectedReportsProject.title}${selectedGanttPhase ? `: ${selectedGanttPhase.title} Report` : ' Report'}` 
                        : 'Group Reports'}
                    </h2>
                    
                    {/* Export to PDF Button */}
                    {selectedReportsProject && (
                      <button
                        onClick={async (e) => {
                          let btn, originalText;
                          try {
                            // Show loading state
                            btn = e.currentTarget;
                            originalText = btn.innerText;
                            btn.disabled = true;
                            btn.innerText = 'Generating PDF...';
                            
                            // Capture Gantt chart screenshots
                            const ganttImages = [];
                            if (reportsGanttRef.current) {
                              try {
                                const ganttHeight = reportsGanttRef.current.scrollHeight;
                                const ganttWidth = reportsGanttRef.current.scrollWidth;
                                const maxHeightPerPage = 1200;
                                const numSections = Math.ceil(ganttHeight / maxHeightPerPage);
                                
                                for (let i = 0; i < numSections; i++) {
                                  const clonedElement = reportsGanttRef.current.cloneNode(true);
                                  const tempDiv = document.createElement('div');
                                  tempDiv.style.position = 'fixed';
                                  tempDiv.style.left = '-9999px';
                                  tempDiv.style.top = '-9999px';
                                  tempDiv.appendChild(clonedElement);
                                  document.body.appendChild(tempDiv);
                                  
                                  const canvas = await html2canvas(clonedElement, {
                                    backgroundColor: '#ffffff',
                                    scale: 1.2,
                                    logging: false,
                                    useCORS: true,
                                    allowTaint: true,
                                    width: ganttWidth,
                                    height: maxHeightPerPage
                                  });
                                  
                                  ganttImages.push(canvas.toDataURL('image/png'));
                                  document.body.removeChild(tempDiv);
                                }
                              } catch (err) {
                                console.warn('Could not capture Gantt chart:', err);
                              }
                            }
                            
                            // Capture pie chart for each filter
                            const pieChartImages = [];
                            const filterOptions = [null, 'completed', 'submitted', 'missed', 'late', 'revision'];
                            const originalFilter = selectedSubmissionStatusFilter;
                            
                            for (const filter of filterOptions) {
                              try {
                                // Set the filter
                                setSelectedSubmissionStatusFilter(filter);
                                
                                // Wait for re-render
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                if (reportsPieChartRef.current) {
                                  const canvas = await html2canvas(reportsPieChartRef.current, {
                                    backgroundColor: '#ffffff',
                                    scale: 1.5,
                                    logging: false,
                                    useCORS: true,
                                    allowTaint: true
                                  });
                                  pieChartImages.push({
                                    filter: filter || 'all',
                                    filterLabel: filter === null ? 'All' : filter.charAt(0).toUpperCase() + filter.slice(1),
                                    data: canvas.toDataURL('image/png')
                                  });
                                }
                              } catch (err) {
                                console.warn(`Could not capture pie chart for filter ${filter}:`, err);
                              }
                            }
                            
                            // Restore original filter
                            setSelectedSubmissionStatusFilter(originalFilter);
                            
                            // Capture task assignment table
                            let taskTableImage = null;
                            if (reportsTaskTableRef.current) {
                              try {
                                const canvas = await html2canvas(reportsTaskTableRef.current, {
                                  backgroundColor: '#ffffff',
                                  scale: 1.2,
                                  logging: false,
                                  useCORS: true,
                                  allowTaint: true
                                });
                                taskTableImage = canvas.toDataURL('image/png');
                              } catch (err) {
                                console.warn('Could not capture task table:', err);
                              }
                            }
                            
                            // Calculate actual progress based on phase submissions
                            let progressPercent = 0;
                            let completedPhasesCount = 0;
                            let totalPhasesCount = 0;
                            if (selectedReportsProject && projectProgressData?.phaseSubmissions) {
                              const phases = selectedReportsProject.project_phases || [];
                              totalPhasesCount = phases.length;
                              completedPhasesCount = phases.filter(phase => {
                                return projectProgressData.phaseSubmissions.some(sub => sub.phase_id === phase.id);
                              }).length;
                              progressPercent = totalPhasesCount > 0 ? (completedPhasesCount / totalPhasesCount) * 100 : 0;
                            }
                            
                            
                            // Create a new window to render the report for PDF
                            const reportWindow = window.open('', '', 'width=1200,height=800');
                            
                            // Build the report HTML
                            const reportTitle = selectedGanttPhase 
                              ? `${selectedReportsProject.title}: ${selectedGanttPhase.title} Report` 
                              : `${selectedReportsProject.title} Report`;
                            
                            const reportDate = new Date().toLocaleDateString('en-US', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric'
                            });
                            
                            // Gather report data
                            const reportHTML = `
                              <!DOCTYPE html>
                              <html>
                              <head>
                                <title>${reportTitle}</title>
                                <style>
                                  * { margin: 0; padding: 0; box-sizing: border-box; }
                                  body {
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    padding: 40px;
                                    background: white;
                                    color: #333;
                                  }
                                  .header {
                                    text-align: center;
                                    border-bottom: 3px solid #872341;
                                    padding-bottom: 20px;
                                    margin-bottom: 30px;
                                  }
                                  .header h1 {
                                    color: #872341;
                                    font-size: 32px;
                                    margin-bottom: 10px;
                                  }
                                  .header p {
                                    color: #666;
                                    font-size: 14px;
                                  }
                                  .section {
                                    margin-bottom: 30px;
                                    page-break-inside: avoid;
                                  }
                                  .section h2 {
                                    color: #09122C;
                                    font-size: 24px;
                                    margin-bottom: 15px;
                                    border-left: 4px solid #872341;
                                    padding-left: 15px;
                                  }
                                  .info-grid {
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 20px;
                                    margin-bottom: 20px;
                                  }
                                  .info-item {
                                    padding: 15px;
                                    background: #f5f5f5;
                                    border-left: 4px solid #872341;
                                    border-radius: 4px;
                                  }
                                  .info-item label {
                                    display: block;
                                    font-weight: 700;
                                    color: #872341;
                                    font-size: 12px;
                                    text-transform: uppercase;
                                    margin-bottom: 8px;
                                  }
                                  .info-item value {
                                    display: block;
                                    font-size: 16px;
                                    color: #333;
                                    font-weight: 600;
                                  }
                                  .progress-bar {
                                    width: 100%;
                                    height: 30px;
                                    background: #e5e7eb;
                                    border-radius: 15px;
                                    overflow: hidden;
                                    margin: 15px 0;
                                  }
                                  .progress-fill {
                                    height: 100%;
                                    background: linear-gradient(90deg, #10B981 0%, #059669 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-weight: 700;
                                    font-size: 14px;
                                  }
                                  table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 15px 0;
                                  }
                                  th {
                                    background: #872341;
                                    color: white;
                                    padding: 12px;
                                    text-align: left;
                                    font-weight: 600;
                                  }
                                  td {
                                    padding: 12px;
                                    border-bottom: 1px solid #e5e7eb;
                                  }
                                  tr:nth-child(even) {
                                    background: #f9fafb;
                                  }
                                  .status-badge {
                                    display: inline-block;
                                    padding: 6px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    font-weight: 600;
                                  }
                                  .status-completed {
                                    background: #d1fae5;
                                    color: #059669;
                                  }
                                  .status-pending {
                                    background: #fef3c7;
                                    color: #d97706;
                                  }
                                  .status-missed {
                                    background: #fee2e2;
                                    color: #dc2626;
                                  }
                                  .footer {
                                    margin-top: 40px;
                                    text-align: center;
                                    border-top: 1px solid #e5e7eb;
                                    padding-top: 20px;
                                    color: #666;
                                    font-size: 12px;
                                  }
                                  @media print {
                                    body { padding: 0; }
                                    .section { page-break-inside: avoid; }
                                  }
                                </style>
                              </head>
                              <body>
                                <div class="header">
                                  <h1>${reportTitle}</h1>
                                  <p>Generated on ${reportDate}</p>
                                </div>
                                
                                <div class="section">
                                  <h2>Project Information</h2>
                                  <div class="info-grid">
                                    <div class="info-item">
                                      <label>Project Title</label>
                                      <value>${selectedReportsProject.title}</value>
                                    </div>
                                    <div class="info-item">
                                      <label>Start Date</label>
                                      <value>${new Date(selectedReportsProject.start_date).toLocaleDateString()}</value>
                                    </div>
                                    <div class="info-item">
                                      <label>Due Date</label>
                                      <value>${new Date(selectedReportsProject.due_date).toLocaleDateString()}</value>
                                    </div>
                                    <div class="info-item">
                                      <label>Status</label>
                                      <value>${new Date(selectedReportsProject.due_date) > new Date() ? 'Ongoing' : 'Completed'}</value>
                                    </div>
                                  </div>
                                  ${selectedReportsProject.description ? `
                                    <div class="info-item" style="grid-column: span 2;">
                                      <label>Description</label>
                                      <value>${selectedReportsProject.description}</value>
                                    </div>
                                  ` : ''}
                                </div>

                                <div class="section">
                                  <h2>Overall Progress</h2>
                                  <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%;">${Math.round(progressPercent)}%</div>
                                  </div>
                                  <p style="font-size: 14px; color: #666;">Phase Completion: ${completedPhasesCount} of ${totalPhasesCount} phases completed</p>
                                </div>

                                <div class="section">
                                  <h2>Project Timeline (Gantt Chart)</h2>
                                  ${ganttImages.length > 0 ? ganttImages.map((imgData, idx) => `
                                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                                      ${ganttImages.length > 1 ? `<p style="font-size: 12px; color: #666; margin-bottom: 10px;">Chart Part ${idx + 1} of ${ganttImages.length}</p>` : ''}
                                      <img src="${imgData}" style="width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; display: block;">
                                    </div>
                                  `).join('') : '<p style="color: #999;">Gantt chart not available</p>'}
                                </div>
                                
                                <div class="section">
                                  <h2>Submissions Analysis by Filter</h2>
                                  ${pieChartImages.length > 0 ? pieChartImages.map((item, idx) => `
                                    <div style="margin-bottom: 30px; page-break-inside: avoid;">
                                      <h3 style="color: #09122C; font-size: 16px; margin-bottom: 15px; border-left: 3px solid #872341; padding-left: 10px;">
                                        Filter: ${item.filterLabel}
                                      </h3>
                                      <img src="${item.data}" style="width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; display: block;">
                                    </div>
                                  `).join('') : '<p style="color: #999;">Pie charts not available</p>'}
                                </div>
                                <div class="section">
                                  <h2>Task Assignment Table</h2>
                                  ${taskTableImage ? `<img src="${taskTableImage}" style="width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; display: block;">` : '<p style="color: #999;">Task table not available</p>'}
                                </div>

                                <div class="footer">
                                  <p>S-MAN System - Project Report</p>
                                  <p>This report was automatically generated from the S-MAN System</p>
                                </div>
                              </body>
                              </html>
                            `;
                            
                            // Write to the new window
                            reportWindow.document.write(reportHTML);
                            reportWindow.document.close();
                            
                            // Wait for content to load, then print to PDF
                            setTimeout(() => {
                              reportWindow.print();
                              btn.disabled = false;
                              btn.innerText = originalText;
                            }, 250);
                            
                          } catch (error) {
                            console.error('Error generating PDF:', error);
                            alert('Error generating PDF. Please try again.');
                            if (btn) {
                              btn.disabled = false;
                              btn.innerText = originalText || 'Export to PDF';
                            }
                          }
                        }}
                        style={{
                          padding: '10px 20px',
                          background: 'rgba(255, 255, 255, 0.15)',
                          backdropFilter: 'blur(10px) saturate(120%)',
                          WebkitBackdropFilter: 'blur(10px) saturate(120%)',
                          border: '1px solid rgba(255, 255, 255, 0.3)',
                          borderRadius: '8px',
                          color: 'white',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          transition: 'all 0.3s',
                          boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)'
                        }}
                        onMouseOver={(e) => {
                          e.currentTarget.style.background = 'rgba(255, 255, 255, 0.25)';
                          e.currentTarget.style.transform = 'translateY(-2px)';
                          e.currentTarget.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.15)';
                        }}
                        onMouseOut={(e) => {
                          e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)';
                          e.currentTarget.style.transform = 'translateY(0)';
                          e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                        }}
                      >
                        <FaFilePdf size={16} />
                        Export to PDF
                      </button>
                    )}
                  </div>
                
                {/* Project Information Cards */}
                {selectedReportsProject ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '20px'
                  }}>
                    {/* Card 1: Project Progress */}
                    <div className="my-group-card-with-crosshair" style={{
                      background: 'rgba(255, 255, 255, 0.95)',
                      backdropFilter: 'blur(10px) saturate(120%)',
                      WebkitBackdropFilter: 'blur(10px) saturate(120%)',
                      border: '0.1px solid rgb(95, 95, 95)',
                      borderRadius: '0px',
                      padding: '28px',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '20px',
                      boxShadow: '0 8px 24px rgba(0, 0, 0, 0.08)',
                      transition: 'all 0.3s'
                    }}
                    onMouseOver={(e) => {
                      e.currentTarget.style.boxShadow = '0 12px 32px rgba(135, 35, 65, 0.15)';
                      e.currentTarget.style.transform = 'translateY(-2px)';
                    }}
                    onMouseOut={(e) => {
                      e.currentTarget.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.08)';
                      e.currentTarget.style.transform = 'translateY(0)';
                    }}>
                      {/* Crosshair Corners */}
                      <div className="crosshair-corner top-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner top-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      
                      {/* Header with Title and Action Buttons */}
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '24px',
                        flexWrap: 'wrap',
                        gap: '16px',
                        zIndex: 10,
                        position: 'relative'
                      }}>
                        <h3 style={{
                          color: '#09122C',
                          fontSize: '24px',
                          fontWeight: '700',
                          margin: 0
                        }}>
                          Project Progress
                        </h3>
                        
                        {/* Action Buttons - Moved to Top Right for Better Accessibility */}
                        <div style={{
                          display: 'flex',
                          gap: '12px',
                          flexWrap: 'wrap'
                        }}>
                          {/* Rubric Button - Shows Project Rubric if no phase selected, Phase Rubric if phase selected */}
                          {(() => {
                            const isPhaseView = !!selectedGanttPhase;
                            const itemToCheck = isPhaseView ? selectedGanttPhase : selectedReportsProject;
                            
                            // For phase: check is_custom_rubric or has_builtin_rubric
                            // For project: check project_rubric_type
                            const rubricType = isPhaseView 
                              ? (itemToCheck?.is_custom_rubric ? 'custom' : (itemToCheck?.has_builtin_rubric ? 'builtin' : null))
                              : itemToCheck?.project_rubric_type;
                            const rubricFileUrl = itemToCheck?.rubric_file_url;
                            
                            if (rubricType === 'custom' && rubricFileUrl) {
                              return (
                                <button
                                  onClick={() => window.open(rubricFileUrl, '_blank')}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: '#872341',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '700',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '10px',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 4px 12px rgba(135, 35, 65, 0.3)',
                                    whiteSpace: 'nowrap'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#BE3144';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(135, 35, 65, 0.4)';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = '#872341';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(135, 35, 65, 0.3)';
                                  }}
                                >
                                  <FaClipboardList size={16} />
                                  View {isPhaseView ? 'Phase' : 'Project'} Rubric
                                </button>
                              );
                            } else if (rubricType === 'builtin') {
                              return (
                                <button
                                  onClick={() => {
                                    if (isPhaseView) {
                                      fetchPhaseRubric(itemToCheck.id, setPhaseRubricData, setRubricLoading);
                                      setShowPhaseRubricModal(true);
                                    } else {
                                      fetchProjectRubric(selectedReportsProject.id);
                                      setShowProjectRubricModal(true);
                                    }
                                  }}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: '#872341',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '700',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '10px',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 4px 12px rgba(135, 35, 65, 0.3)',
                                    whiteSpace: 'nowrap'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#BE3144';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(135, 35, 65, 0.4)';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = '#872341';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(135, 35, 65, 0.3)';
                                  }}
                                >
                                  <FaClipboardList size={16} />
                                  View {isPhaseView ? 'Phase' : 'Project'} Rubric
                                </button>
                              );
                            }
                            return null;
                          })()}

                          {/* Evaluation Button - Shows Project Evaluation if no phase selected, Phase Evaluation if phase selected */}
                          {(() => {
                            const isPhaseView = !!selectedGanttPhase;
                            const itemToCheck = isPhaseView ? selectedGanttPhase : selectedReportsProject;
                            
                            // For phase: check is_custom_evaluation or has_builtin_evaluation
                            // For project: check project_evaluation_type
                            const evaluationType = isPhaseView
                              ? (itemToCheck?.is_custom_evaluation ? 'custom' : (itemToCheck?.has_builtin_evaluation ? 'builtin' : null))
                              : itemToCheck?.project_evaluation_type;
                            const evaluationFileUrl = itemToCheck?.evaluation_form_file_url;
                            
                            if (evaluationType === 'custom' && evaluationFileUrl) {
                              return (
                                <button
                                  onClick={() => window.open(evaluationFileUrl, '_blank')}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: '#09122C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '700',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '10px',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 4px 12px rgba(9, 18, 44, 0.3)',
                                    whiteSpace: 'nowrap'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#1a2a4e';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(9, 18, 44, 0.4)';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = '#09122C';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(9, 18, 44, 0.3)';
                                  }}
                                >
                                  <FaClipboardCheck size={16} />
                                  View {isPhaseView ? 'Phase' : 'Project'} Evaluation
                                </button>
                              );
                            } else if (evaluationType === 'builtin') {
                              return (
                                <button
                                  onClick={() => {
                                    if (isPhaseView) {
                                      fetchPhaseEvaluationForm(itemToCheck.id, setPhaseEvalFormData, setEvalFormLoading);
                                      setShowPhaseEvalFormModal(true);
                                    } else {
                                      fetchProjectEvaluation(selectedReportsProject.id);
                                      setShowProjectEvaluationModal(true);
                                    }
                                  }}
                                  style={{
                                    padding: '12px 20px',
                                    backgroundColor: '#09122C',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '700',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '10px',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 4px 12px rgba(9, 18, 44, 0.3)',
                                    whiteSpace: 'nowrap'
                                  }}
                                  onMouseOver={(e) => {
                                    e.currentTarget.style.backgroundColor = '#1a2a4e';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(9, 18, 44, 0.4)';
                                  }}
                                  onMouseOut={(e) => {
                                    e.currentTarget.style.backgroundColor = '#09122C';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(9, 18, 44, 0.3)';
                                  }}
                                >
                                  <FaClipboardCheck size={16} />
                                  View {isPhaseView ? 'Phase' : 'Project'} Evaluation
                                </button>
                              );
                            }
                            return null;
                          })()}
                        </div>
                      </div>
                      
                      {/* Progress Bar Section */}
                      {(() => {
                        let phases = selectedReportsProject.project_phases || [];
                        
                        // Filter phases if a specific phase is selected
                        if (selectedGanttPhase) {
                          phases = phases.filter(p => p.id === selectedGanttPhase.id);
                        }
                        
                        const totalPhases = phases.length;
                        
                        // Calculate completed phases based on ACTUAL SUBMISSIONS, not end dates
                        const completedPhases = phases.filter(phase => {
                          // Check if there's a submission for this phase
                          const phaseSubmission = projectProgressData?.phaseSubmissions?.find(sub => sub.phase_id === phase.id);
                          return !!phaseSubmission; // Phase is completed if there's a submission
                        }).length;
                        
                        const progress = totalPhases > 0 ? (completedPhases / totalPhases) * 100 : 0;
                        
                        return (
                          <div style={{ 
                            zIndex: 10, 
                            position: 'relative',
                            marginBottom: '28px',
                            padding: '20px',
                            backgroundColor: 'rgba(185, 178, 138, 0.05)',
                            borderRadius: '12px',
                            border: '1px solid rgba(185, 178, 138, 0.2)'
                          }}>
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center',
                              marginBottom: '16px'
                            }}>
                              <span style={{ fontSize: '18px', color: '#872341', fontWeight: '700' }}>
                                {selectedGanttPhase ? `Phase ${selectedGanttPhase.phase_number} Progress` : 'Overall Progress'}
                              </span>
                              <span style={{ fontSize: '17px', color: '#09122C', fontWeight: '700' }}>
                                {selectedGanttPhase ? `${completedPhases} of 1 phase completed` : `${completedPhases} of ${totalPhases} phases completed`}
                              </span>
                            </div>
                            <div style={{
                              width: '100%',
                              height: '32px',
                              backgroundColor: 'rgba(185, 178, 138, 0.2)',
                              borderRadius: '16px',
                              overflow: 'hidden',
                              position: 'relative'
                            }}>
                              <div style={{
                                width: `${progress}%`,
                                height: '100%',
                                background: (() => {
                                  // Dynamic gradient based on progress
                                  if (progress >= 80) {
                                    // Green gradient (80-100%)
                                    return 'linear-gradient(90deg, #10B981 0%, #059669 100%)';
                                  } else if (progress >= 50) {
                                    // Orange gradient (50-79%)
                                    return 'linear-gradient(90deg, #F59E0B 0%, #EA580C 100%)';
                                  } else {
                                    // Red gradient (0-49%)
                                    return 'linear-gradient(90deg, #EF4444 0%, #DC2626 100%)';
                                  }
                                })(),
                                transition: 'width 0.3s ease, background 0.3s ease',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'flex-end',
                                paddingRight: '14px',
                                boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.1)'
                              }}>
                                <span style={{
                                  fontSize: '15px',
                                  color: 'white',
                                  fontWeight: '700',
                                  textShadow: '0 1px 2px rgba(0, 0, 0, 0.3)'
                                }}>
                                  {Math.round(progress)}%
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                      
                      {/* Reorganized Project/Phase Information - Single Column Layout for Better Readability */}
                      {(() => {
                        const phases = selectedReportsProject.project_phases || [];
                        const today = new Date();
                        const currentPhase = phases.find(p => {
                          if (!p.start_date || !p.end_date) return false;
                          const start = new Date(p.start_date);
                          const end = new Date(p.end_date);
                          return today >= start && today <= end;
                        });
                        
                        // Determine if showing phase or project details
                        const isPhaseView = !!selectedGanttPhase;
                        const displayItem = isPhaseView ? selectedGanttPhase : selectedReportsProject;
                        const displayTitle = isPhaseView ? `Phase ${selectedGanttPhase.phase_number}: ${selectedGanttPhase.title}` : selectedReportsProject.title;
                        const displayStartDate = isPhaseView ? selectedGanttPhase.start_date : selectedReportsProject.start_date;
                        const displayEndDate = isPhaseView ? selectedGanttPhase.end_date : selectedReportsProject.due_date;
                        
                        const endDate = displayEndDate ? new Date(displayEndDate) : null;
                        const isCompleted = endDate && today > endDate;
                        const displayStatus = isCompleted ? 'Completed' : 'Ongoing';
                        
                        return (
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '20px',
                            zIndex: 10,
                            position: 'relative'
                          }}>
                            {/* Title Section */}
                            <div style={{
                              padding: '18px',
                              backgroundColor: 'rgba(9, 18, 44, 0.06)',
                              borderRadius: '10px',
                              border: '2px solid rgba(9, 18, 44, 0.15)'
                            }}>
                              <div style={{
                                fontSize: '13px',
                                color: '#872341',
                                marginBottom: '8px',
                                fontWeight: '700',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                <FaFileAlt size={14} /> {isPhaseView ? 'Phase' : 'Project'} Title
                              </div>
                              <div style={{
                                fontSize: '20px',
                                color: '#09122C',
                                fontWeight: '700',
                                lineHeight: '1.4'
                              }}>
                                {displayTitle}
                              </div>
                            </div>

                            {/* Description - Only show for project view if available */}
                            {!isPhaseView && selectedReportsProject.description && (
                              <div style={{
                                padding: '18px',
                                backgroundColor: 'rgba(135, 35, 65, 0.06)',
                                borderRadius: '10px',
                                border: '2px solid rgba(135, 35, 65, 0.2)'
                              }}>
                                <div style={{
                                  fontSize: '13px',
                                  color: '#872341',
                                  marginBottom: '10px',
                                  fontWeight: '700',
                                  textTransform: 'uppercase',
                                  letterSpacing: '0.5px',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '8px'
                                }}>
                                  <FaEdit size={14} /> Description
                                </div>
                                <div style={{
                                  fontSize: '16px',
                                  color: '#09122C',
                                  lineHeight: '1.7',
                                  fontWeight: '500'
                                }}>
                                  {selectedReportsProject.description}
                                </div>
                              </div>
                            )}
                            
                            {/* Timeline Information Grid */}
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                              gap: '16px'
                            }}>
                              {/* Start Date */}
                              {displayStartDate && (
                                <div style={{
                                  padding: '16px',
                                  backgroundColor: 'rgba(135, 35, 65, 0.1)',
                                  borderRadius: '10px',
                                  border: '2px solid rgba(135, 35, 65, 0.25)'
                                }}>
                                  <div style={{
                                    fontSize: '12px',
                                    color: '#872341',
                                    marginBottom: '8px',
                                    fontWeight: '700',
                                    textTransform: 'uppercase',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                  }}>
                                    <FaPlay size={12} /> Start Date
                                  </div>
                                  <div style={{
                                    fontSize: '16px',
                                    color: '#09122C',
                                    fontWeight: '700'
                                  }}>
                                    {new Date(displayStartDate).toLocaleDateString('en-US', {
                                      month: 'short',
                                      day: 'numeric',
                                      year: 'numeric'
                                    })}
                                  </div>
                                </div>
                              )}

                              {/* End Date */}
                              {displayEndDate && (
                                <div style={{
                                  padding: '16px',
                                  backgroundColor: 'rgba(190, 49, 68, 0.1)',
                                  borderRadius: '10px',
                                  border: '2px solid rgba(190, 49, 68, 0.25)'
                                }}>
                                  <div style={{
                                    fontSize: '12px',
                                    color: '#BE3144',
                                    marginBottom: '8px',
                                    fontWeight: '700',
                                    textTransform: 'uppercase',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                  }}>
                                    <FaStop size={12} /> {isPhaseView ? 'End Date' : 'Due Date'}
                                  </div>
                                  <div style={{
                                    fontSize: '16px',
                                    color: '#09122C',
                                    fontWeight: '700'
                                  }}>
                                    {new Date(displayEndDate).toLocaleDateString('en-US', {
                                      month: 'short',
                                      day: 'numeric',
                                      year: 'numeric'
                                    })}
                                  </div>
                                </div>
                              )}

                              {/* Current Status */}
                              <div style={{
                                padding: '16px',
                                backgroundColor: isCompleted ? 'rgba(5, 150, 105, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                                borderRadius: '10px',
                                border: `2px solid ${isCompleted ? '#059669' : '#3B82F6'}`,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                gridColumn: displayStartDate && displayEndDate ? 'span 1' : 'span 1'
                              }}>
                                <div style={{ fontSize: '28px' }}>
                                  {isCompleted ? <FaCheckCircle /> : <FaClock />}
                                </div>
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontSize: '12px', color: isCompleted ? '#059669' : '#3B82F6', fontWeight: '700', textTransform: 'uppercase', marginBottom: '6px' }}>
                                    {isPhaseView ? 'Phase Status' : 'Project Status'}
                                  </div>
                                  <div style={{ fontSize: '18px', color: '#09122C', fontWeight: '700' }}>
                                    {displayStatus}
                                  </div>
                                  {currentPhase && (
                                    <div style={{ fontSize: '13px', color: '#BE3144', fontWeight: '600', marginTop: '4px' }}>
                                      Phase: {currentPhase.phase_name || currentPhase.title || 'Unnamed Phase'}
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>

                            {/* Project Requirements Section */}
                            {(selectedReportsProject.file_types_allowed || selectedReportsProject.max_file_size_mb || 
                              selectedReportsProject.min_tasks_per_member || selectedReportsProject.max_tasks_per_member ||
                              (selectedReportsProject.breathe_phase_days !== null && selectedReportsProject.breathe_phase_days !== undefined)) && (
                              <div style={{
                                padding: '18px',
                                backgroundColor: 'rgba(9, 18, 44, 0.06)',
                                borderRadius: '10px',
                                border: '2px solid rgba(9, 18, 44, 0.15)'
                              }}>
                                <div style={{ 
                                  fontSize: '13px', 
                                  color: '#872341', 
                                  fontWeight: '700', 
                                  textTransform: 'uppercase', 
                                  marginBottom: '16px', 
                                  display: 'flex', 
                                  alignItems: 'center', 
                                  gap: '8px' 
                                }}>
                                  <FaCog size={14} /> Project Requirements
                                </div>
                                
                                <div style={{
                                  display: 'grid',
                                  gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                                  gap: '16px'
                                }}>
                                  {/* File Types */}
                                  {selectedReportsProject.file_types_allowed && (
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#872341', marginBottom: '6px', fontWeight: '700' }}>
                                        File Types
                                      </div>
                                      <div style={{ fontSize: '14px', color: '#09122C', fontWeight: '600', display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                        {Array.isArray(selectedReportsProject.file_types_allowed) 
                                          ? selectedReportsProject.file_types_allowed.map((type, index) => (
                                              <span key={index} style={{
                                                padding: '4px 10px',
                                                backgroundColor: 'rgba(135, 35, 65, 0.15)',
                                                borderRadius: '6px',
                                                fontSize: '13px',
                                                fontWeight: '700'
                                              }}>
                                                .{type}
                                              </span>
                                            ))
                                          : selectedReportsProject.file_types_allowed}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Max File Size */}
                                  {selectedReportsProject.max_file_size_mb && (
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#872341', marginBottom: '6px', fontWeight: '700' }}>
                                        Max File Size
                                      </div>
                                      <div style={{ fontSize: '16px', color: '#09122C', fontWeight: '700' }}>
                                        {selectedReportsProject.max_file_size_mb} MB
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Tasks Per Member */}
                                  {(selectedReportsProject.min_tasks_per_member || selectedReportsProject.max_tasks_per_member) && (
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#872341', marginBottom: '6px', fontWeight: '700' }}>
                                        Tasks Per Member
                                      </div>
                                      <div style={{ fontSize: '16px', color: '#09122C', fontWeight: '700' }}>
                                        {selectedReportsProject.min_tasks_per_member || 0} - {selectedReportsProject.max_tasks_per_member || 'N/A'}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Breathe Phase */}
                                  {selectedReportsProject.breathe_phase_days !== null && selectedReportsProject.breathe_phase_days !== undefined && (
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#872341', marginBottom: '6px', fontWeight: '700' }}>
                                        Breathe Phase
                                      </div>
                                      <div style={{ fontSize: '16px', color: '#09122C', fontWeight: '700' }}>
                                        {selectedReportsProject.breathe_phase_days} {selectedReportsProject.breathe_phase_days === 1 ? 'day' : 'days'}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>

                    {/* Project Timeline Section - Same Advanced Gantt from Overview Tab */}
                    {selectedReportsProject ? (
                      <div className="my-group-card-with-crosshair" style={{
                        background: 'rgba(9, 18, 44, 0.15)',
                        backdropFilter: 'blur(3.2px) saturate(120%)',
                        WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                        border: '0.1px solid #5f5f5f',
                        borderRadius: '12px',
                        padding: '20px',
                        marginTop: '20px',
                        minHeight: '750px',
                        maxHeight: '1200px'
                      }}>
                        <div className="crosshair-corner top-left">
                          <div className="crosshair-h"></div>
                          <div className="crosshair-v"></div>
                        </div>
                        <div className="crosshair-corner top-right">
                          <div className="crosshair-h"></div>
                          <div className="crosshair-v"></div>
                        </div>
                        <div className="crosshair-corner bottom-left">
                          <div className="crosshair-h"></div>
                          <div className="crosshair-v"></div>
                        </div>
                        <div className="crosshair-corner bottom-right">
                          <div className="crosshair-h"></div>
                          <div className="crosshair-v"></div>
                        </div>
                        {/* Header */}
                        <h2 style={{
                          color: 'white',
                          fontSize: '20px',
                          fontWeight: '600',
                          margin: '0 0 20px 0'
                        }}>
                          Project Timeline
                        </h2>
                        
                        {/* Gantt Chart */}
                        {selectedGanttProject ? (
                          <div 
                            ref={reportsGanttRef}
                            style={{
                            backgroundColor: 'white',
                            border: '1px solid #B9B28A',
                            borderRadius: '8px',
                            padding: '0',
                            minHeight: '600px',
                            maxHeight: (() => {
                              // Adaptive height based on number of members
                              const memberCount = (groupMembers.length > 0 ? groupMembers : groupData?.members || []).length;
                              const baseHeight = 300;
                              const rowHeight = 70;
                              return `${baseHeight + (memberCount * rowHeight)}px`;
                            })(),
                            overflow: 'hidden',
                            position: 'relative',
                            display: 'flex',
                            flexDirection: 'column'
                          }}>
                            {ganttLoading ? (
                              <div style={{
                                padding: '60px',
                                textAlign: 'center',
                                color: '#6B7280'
                              }}>
                                Loading timeline...
                              </div>
                            ) : (() => {
                              const timelineDays = getGanttTimelineDays();
                              const { start, end } = getGanttDateRange();
                              const hasValidDates = timelineDays.length > 0 && start && end;
                              
                              const DAY_WIDTH = getAdaptiveDayWidth(ganttContainerWidth);
                              const totalWidth = timelineDays.length * DAY_WIDTH;
                              const timelinePixelWidth = Math.max(nameColumnWidth + totalWidth, 0);
                              
                              if (!hasValidDates) {
                                return (
                                  <div style={{
                                    padding: '60px',
                                    textAlign: 'center',
                                    color: '#9CA3AF'
                                  }}>
                                    {selectedGanttPhase ? 
                                      `No valid dates found for Phase ${selectedGanttPhase.phase_number}` :
                                      'No valid dates found for this project'}
                                  </div>
                                );
                              }
                              
                              // Get phase boundaries for indicators (when All Phases selected)
                              const rawPhaseIndicators = !selectedGanttPhase && selectedGanttProject.project_phases ? 
                                selectedGanttProject.project_phases.map(phase => {
                                  const phaseStart = new Date(phase.start_date);
                                  const phaseEnd = new Date(phase.end_date);
                                  phaseStart.setHours(0, 0, 0, 0);
                                  phaseEnd.setHours(0, 0, 0, 0);
                                  
                                  const timelineStart = new Date(start);
                                  timelineStart.setHours(0, 0, 0, 0);
                                  
                                  const startDay = Math.max(0, Math.floor((phaseStart - timelineStart) / (1000 * 60 * 60 * 24)));
                                  const duration = Math.ceil((phaseEnd - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
                                  
                                  return {
                                    ...phase,
                                    startDay,
                                    duration,
                                    leftPos: (startDay * DAY_WIDTH) + 4,
                                    width: (duration * DAY_WIDTH) - 8
                                  };
                                }) : [];
                              
                              // Calculate multi-row layout to prevent overlap
                              const phaseIndicatorsWithRows = calculatePhaseRows(rawPhaseIndicators, DAY_WIDTH);
                              
                              // Filter to only show visible phases
                              const phaseIndicators = phaseIndicatorsWithRows.filter(p => visiblePhases.has(p.id));
                              
                              return (
                              <>
                                {/* Phase Toggle Buttons (when All Phases selected) - OUTSIDE SCROLL */}
                                {!selectedGanttPhase && rawPhaseIndicators.length > 1 && (
                                  <div style={{
                                    padding: '12px 16px',
                                    backgroundColor: '#F9FAFB',
                                    borderBottom: '1px solid #E5E7EB',
                                    display: 'flex',
                                    flexWrap: 'wrap',
                                    gap: '8px',
                                    alignItems: 'center',
                                    flexShrink: 0
                                  }}>
                                    <span style={{
                                      fontSize: '12px',
                                      fontWeight: '600',
                                      color: '#6B7280',
                                      marginRight: '8px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '6px'
                                    }}>
                                      <FaLayerGroup size={12} />
                                      Toggle Phases:
                                    </span>
                                    {rawPhaseIndicators.map((phase, idx) => {
                                      const isVisible = visiblePhases.has(phase.id);
                                      const phaseColor = `hsl(${(idx * 60) % 360}, 70%, 55%)`;
                                      return (
                                        <button
                                          key={phase.id}
                                          onClick={() => {
                                            const newVisible = new Set(visiblePhases);
                                            if (isVisible) {
                                              newVisible.delete(phase.id);
                                            } else {
                                              newVisible.add(phase.id);
                                            }
                                            setVisiblePhases(newVisible);
                                          }}
                                          style={{
                                            padding: '6px 12px',
                                            backgroundColor: isVisible ? phaseColor : '#E5E7EB',
                                            color: isVisible ? 'white' : '#6B7280',
                                            border: `2px solid ${isVisible ? phaseColor : '#D1D5DB'}`,
                                            borderRadius: '6px',
                                            fontSize: '11px',
                                            fontWeight: '700',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s ease',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px',
                                            opacity: isVisible ? 1 : 0.6
                                          }}
                                          onMouseOver={(e) => {
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                            e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
                                          }}
                                          onMouseOut={(e) => {
                                            e.currentTarget.style.transform = 'translateY(0)';
                                            e.currentTarget.style.boxShadow = 'none';
                                          }}
                                          title={isVisible ? 'Click to hide' : 'Click to show'}
                                        >
                                          {isVisible ? <FaEye size={10} /> : <FaEyeSlash size={10} />}
                                          P{phase.phase_number}
                                        </button>
                                      );
                                    })}
                                    <button
                                      onClick={() => {
                                        // Toggle all
                                        if (visiblePhases.size === rawPhaseIndicators.length) {
                                          setVisiblePhases(new Set());
                                        } else {
                                          setVisiblePhases(new Set(rawPhaseIndicators.map(p => p.id)));
                                        }
                                      }}
                                      style={{
                                        padding: '6px 12px',
                                        backgroundColor: '#6B7280',
                                        color: 'white',
                                        border: '2px solid #4B5563',
                                        borderRadius: '6px',
                                        fontSize: '11px',
                                        fontWeight: '700',
                                        cursor: 'pointer',
                                        marginLeft: '8px'
                                      }}
                                      title={visiblePhases.size === rawPhaseIndicators.length ? 'Hide All' : 'Show All'}
                                    >
                                      {visiblePhases.size === rawPhaseIndicators.length ? (
                                        <><FaEyeSlash size={11} style={{ marginRight: '6px' }} /> Hide All</>
                                      ) : (
                                        <><FaEye size={11} style={{ marginRight: '6px' }} /> Show All</>
                                      )}
                                    </button>
                                  </div>
                                )}
                              
                                {/* Scrollable Gantt Content */}
                                <div 
                                  style={{ 
                                    minWidth: '100%',
                                    position: 'relative',
                                    overflowX: 'auto',
                                    overflowY: 'auto',
                                    flex: 1,
                                    maxHeight: '100%',
                                    paddingBottom: '4px'
                                  }}
                                >
                                  <div style={{ minHeight: '100%' }}>
                                  {/* Fixed Header with Sticky Date Column */}
                                  <table style={{
                                    width: `${timelinePixelWidth}px`,
                                    borderCollapse: 'collapse',
                                    tableLayout: 'fixed',
                                    backgroundColor: 'white'
                                  }}>
                                    <colgroup>
                                      <col style={{ width: `${nameColumnWidth}px` }} />
                                      {timelineDays.map((_, index) => (
                                        <col key={`col-${index}`} style={{ width: `${DAY_WIDTH}px` }} />
                                      ))}
                                    </colgroup>
                                    <thead>
                                      {/* Row 1: Timeline Info Pills (Top) */}
                                      <tr style={{ backgroundColor: 'white', borderBottom: '2px solid #E5E7EB' }}>
                                        <th style={{
                                          padding: '16px',
                                          fontWeight: '600',
                                          fontSize: '12px',
                                          color: '#6B7280',
                                          textAlign: 'left',
                                          backgroundColor: 'white',
                                          zIndex: 10,
                                          borderRight: 'none'
                                        }}>
                                          <div style={{ fontSize: '11px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '700' }}>Timeline Info</div>
                                        </th>
                                        {/* Project Start - On first date column */}
                                        <td style={{
                                          padding: '12px 4px',
                                          textAlign: 'center',
                                          backgroundColor: 'white',
                                          borderRight: 'none',
                                          verticalAlign: 'middle',
                                          width: `${DAY_WIDTH}px`
                                        }}>
                                          <div style={{
                                            display: 'flex',
                                            flexDirection: 'column',
                                            alignItems: 'center',
                                            gap: '4px',
                                            backgroundColor: '#10B981',
                                            color: 'white',
                                            padding: '8px 12px',
                                            borderRadius: '16px',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            boxShadow: '0 2px 6px rgba(16, 185, 129, 0.25)',
                                            minHeight: '50px',
                                            justifyContent: 'center'
                                          }}>
                                            <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>START</div>
                                            <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                              {start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                            </div>
                                          </div>
                                        </td>
                                        {/* Middle columns - Duration in center */}
                                        {timelineDays.slice(1, -1).map((day, idx) => {
                                          const isMiddle = idx === Math.floor((timelineDays.length - 2) / 2);
                                          return (
                                            <td key={`middle-${idx}`} style={{
                                              padding: '12px 4px',
                                              textAlign: 'center',
                                              backgroundColor: 'white',
                                              borderRight: 'none',
                                              verticalAlign: 'middle',
                                              width: `${DAY_WIDTH}px`
                                            }}>
                                              {isMiddle && (
                                                <div style={{
                                                  display: 'flex',
                                                  flexDirection: 'column',
                                                  alignItems: 'center',
                                                  gap: '4px',
                                                  backgroundColor: '#6B7280',
                                                  color: 'white',
                                                  padding: '8px 12px',
                                                  borderRadius: '16px',
                                                  fontSize: '10px',
                                                  fontWeight: '600',
                                                  boxShadow: '0 2px 6px rgba(107, 114, 128, 0.25)',
                                                  minHeight: '50px',
                                                  justifyContent: 'center'
                                                }}>
                                                  <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>Duration</div>
                                                  <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                                    {timelineDays.length}d
                                                  </div>
                                                </div>
                                              )}
                                            </td>
                                          );
                                        })}
                                        {/* Project End - On last date column */}
                                        <td style={{
                                          padding: '12px 4px',
                                          textAlign: 'center',
                                          backgroundColor: 'white',
                                          borderRight: 'none',
                                          verticalAlign: 'middle',
                                          width: `${DAY_WIDTH}px`
                                        }}>
                                          <div style={{
                                            display: 'flex',
                                            flexDirection: 'column',
                                            alignItems: 'center',
                                            gap: '4px',
                                            backgroundColor: '#EF4444',
                                            color: 'white',
                                            padding: '8px 12px',
                                            borderRadius: '16px',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            boxShadow: '0 2px 6px rgba(239, 68, 68, 0.25)',
                                            minHeight: '50px',
                                            justifyContent: 'center'
                                          }}>
                                            <div style={{ fontSize: '8px', opacity: 0.9, textTransform: 'uppercase' }}>END</div>
                                            <div style={{ fontSize: '11px', fontWeight: '700' }}>
                                              {end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                            </div>
                                          </div>
                                        </td>
                                      </tr>
                                      
                                      {/* Row 2: Member Names Header and Date Headers */}
                                      <tr style={{ backgroundColor: '#F9FAFB', borderBottom: '1px solid #E5E7EB' }}>
                                        <th style={{
                                          padding: '12px 16px',
                                          fontWeight: '600',
                                          fontSize: '13px',
                                          color: '#6B7280',
                                          borderRight: '2px solid #E5E7EB',
                                          textAlign: 'left',
                                          position: 'relative',
                                          backgroundColor: 'white',
                                          zIndex: 10
                                        }}>
                                          <div>Group Members</div>
                                          <div style={{ 
                                            fontSize: '10px', 
                                            fontWeight: '500', 
                                            color: '#9CA3AF',
                                            marginTop: '4px'
                                          }}>
                                            {selectedGanttPhase ? 
                                              `Phase ${selectedGanttPhase.phase_number}` : 
                                              'All Phases (Overview)'}
                                          </div>
                                        </th>
                                        {/* Date Headers */}
                                        {timelineDays.map((day, index) => {
                                          const isToday = new Date().toDateString() === day.toDateString();
                                          const isStartDate = day.toDateString() === start.toDateString();
                                          const isEndDate = day.toDateString() === end.toDateString();
                                          
                                          let backgroundColor = 'white';
                                          let textColor = '#6B7280';
                                          
                                          if (isToday) {
                                            backgroundColor = '#872341';
                                            textColor = 'white';
                                          } else if (isStartDate) {
                                            textColor = '#059669';
                                          } else if (isEndDate) {
                                            textColor = '#DC2626';
                                          }
                                          
                                          const dayFontSize = DAY_WIDTH >= 150 ? '16px' : (DAY_WIDTH >= 100 ? '14px' : (DAY_WIDTH >= 70 ? '12px' : '11px'));
                                          const monthFontSize = DAY_WIDTH >= 150 ? '13px' : (DAY_WIDTH >= 100 ? '11px' : (DAY_WIDTH >= 70 ? '10px' : '9px'));
                                          const labelFontSize = DAY_WIDTH >= 150 ? '10px' : (DAY_WIDTH >= 100 ? '9px' : (DAY_WIDTH >= 70 ? '8px' : '7px'));
                                          
                                          return (
                                            <th key={`header-${index}`} style={{
                                              padding: DAY_WIDTH >= 70 ? '10px 4px' : '8px 2px',
                                              textAlign: 'center',
                                              fontSize: dayFontSize,
                                              fontWeight: (isToday || isStartDate || isEndDate) ? '700' : '600',
                                              color: textColor,
                                              borderRight: 'none',
                                              borderBottom: '1px solid #E5E7EB',
                                              backgroundColor: backgroundColor,
                                              width: `${DAY_WIDTH}px`
                                            }}>
                                              <div style={{ 
                                                fontWeight: (isToday || isStartDate || isEndDate) ? '700' : '600',
                                                fontSize: (isToday || isStartDate || isEndDate) ? (DAY_WIDTH >= 150 ? '18px' : (DAY_WIDTH >= 100 ? '16px' : '14px')) : dayFontSize,
                                                color: textColor
                                              }}>
                                                {day.getDate()}
                                              </div>
                                              <div style={{ fontSize: monthFontSize, marginTop: '3px', fontWeight: '500', color: textColor }}>
                                                {day.toLocaleDateString('en-US', { month: 'short' })}
                                              </div>
                                              {isToday && DAY_WIDTH >= 60 && (
                                                <div style={{
                                                  fontSize: labelFontSize,
                                                  color: 'white',
                                                  fontWeight: '700',
                                                  marginTop: '3px'
                                                }}>
                                                  TODAY
                                                </div>
                                              )}
                                              {isStartDate && !isToday && DAY_WIDTH >= 60 && (
                                                <div style={{
                                                  fontSize: labelFontSize,
                                                  color: '#059669',
                                                  fontWeight: '700',
                                                  marginTop: '3px'
                                                }}>
                                                  START
                                                </div>
                                              )}
                                              {isEndDate && !isToday && DAY_WIDTH >= 60 && (
                                                <div style={{
                                                  fontSize: labelFontSize,
                                                  color: '#DC2626',
                                                  fontWeight: '700',
                                                  marginTop: '3px'
                                                }}>
                                                  END
                                                </div>
                                              )}
                                            </th>
                                          );
                                        })}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {(() => {
                                        // For Reports tab, use allGroupTasks; for Overview use ganttTasks
                                        const tasksToUse = activeTab === 'my-group' ? 
                                          (allGroupTasks.flatMap(memberData => memberData.tasks || []) || []) : 
                                          (ganttTasks || []);
                                        
                                        // Organize tasks by phase - filter by visiblePhases or selected phase
                                        let phases = selectedGanttProject.project_phases || [];
                                        
                                        // In Reports tab: if a phase is selected, show ONLY that phase
                                        // Otherwise show all visible phases
                                        if (activeTab === 'my-group' && selectedGanttPhase) {
                                          // Single phase mode - only show selected phase
                                          phases = phases.filter(p => p.id === selectedGanttPhase.id);
                                        } else if (visiblePhases.size > 0 && visiblePhases.size < phases.length) {
                                          // Multiple phases mode - filter by visiblePhases
                                          phases = phases.filter(p => visiblePhases.has(p.id));
                                        }
                                        
                                        const tasksByPhase = {};
                                        
                                        // Initialize phases
                                        phases.forEach(phase => {
                                          tasksByPhase[phase.id] = [];
                                        });
                                        
                                        // Group tasks by phase
                                        tasksToUse.forEach(task => {
                                          const phaseId = task.project_phases?.id || task.phase_id || task.project_phase_id;

                                          if (phaseId && tasksByPhase[phaseId]) {
                                            tasksByPhase[phaseId].push(task);
                                          }
                                        });
                                        
                                        // Create member color mapping
                                        const allMembers = groupMembers.length > 0 ? groupMembers : groupData?.members || [];
                                        const memberColorMap = {};
                                        allMembers.forEach((member, idx) => {
                                          const memberId = member.id || member.student_id || member.member_id;
                                          const lightness = 65 - (idx * 8);
                                          memberColorMap[memberId] = `hsl(210, 85%, ${Math.max(35, lightness)}%)`;
                                        });
                                        
                                        // Render phases and their tasks
                                        const rows = [];
                                        
                                        phases.sort((a, b) => a.phase_number - b.phase_number).forEach((phase, phaseIndex) => {
                                          const phaseTasks = tasksByPhase[phase.id] || [];
                                          const rowHeight = 50;
                                          const phaseColor = `hsl(${(phaseIndex * 60) % 360}, 70%, 55%)`;
                                          
                                          // Calculate phase position
                                          const phaseStart = new Date(phase.start_date);
                                          const phaseEnd = new Date(phase.end_date);
                                          phaseStart.setHours(0, 0, 0, 0);
                                          phaseEnd.setHours(0, 0, 0, 0);
                                          
                                          const timelineStart = new Date(start);
                                          timelineStart.setHours(0, 0, 0, 0);
                                          
                                          const startOffset = Math.floor((phaseStart - timelineStart) / (1000 * 60 * 60 * 24));
                                          const durationDays = Math.floor((phaseEnd - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
                                          
                                          // Phase Header Row
                                          const phaseCells = [];
                                          for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                            if (dayIdx >= startOffset && dayIdx < startOffset + durationDays) {
                                              phaseCells.push(
                                                <td 
                                                  key={`phase-cell-${dayIdx}`}
                                                  onClick={() => {
                                                    setGanttSelectedPhase(phase);
                                                    setShowGanttPhaseModal(true);
                                                  }}
                                                  style={{
                                                    width: `${DAY_WIDTH}px`,
                                                    padding: '0px',
                                                    margin: '0px',
                                                    verticalAlign: 'middle',
                                                    backgroundColor: phaseColor,
                                                    borderRight: 'none',
                                                    borderBottom: '1px solid rgba(255,255,255,0.2)',
                                                    color: 'white',
                                                    fontWeight: '600',
                                                    fontSize: '11px',
                                                    textAlign: 'center',
                                                    height: '50px',
                                                    display: 'table-cell',
                                                    overflow: 'hidden',
                                                    whiteSpace: 'nowrap',
                                                    cursor: 'pointer',
                                                    transition: 'opacity 0.2s',
                                                    opacity: 1
                                                  }}
                                                  onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                                  onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                                >
                                                  {dayIdx === startOffset && `Phase ${phase.phase_number}`}
                                                </td>
                                              );
                                            } else {
                                              phaseCells.push(
                                                <td key={`phase-empty-${dayIdx}`} style={{
                                                  width: `${DAY_WIDTH}px`,
                                                  padding: '0px',
                                                  margin: '0px',
                                                  verticalAlign: 'middle',
                                                  backgroundColor: 'white',
                                                  borderRight: 'none',
                                                  borderBottom: '1px solid #E5E7EB',
                                                  display: 'table-cell'
                                                }}></td>
                                              );
                                            }
                                          }
                                          
                                          rows.push(
                                            <tr key={`phase-${phase.id}`} style={{
                                              backgroundColor: '#F9FAFB',
                                              boxShadow: '0 2px 0 0 #E5E7EB'
                                            }}>
                                              <td style={{
                                                width: `${nameColumnWidth}px`,
                                                padding: '12px 16px',
                                                verticalAlign: 'middle',
                                                borderRight: '2px solid #E5E7EB',
                                                borderLeft: '2px solid #E5E7EB',
                                                borderTop: '1px solid #E5E7EB',
                                                borderBottom: '1px solid #E5E7EB',
                                                backgroundColor: '#F9FAFB',
                                                height: `${rowHeight}px`,
                                                maxWidth: `${nameColumnWidth}px`,
                                                overflow: 'hidden'
                                              }}>
                                                <div style={{
                                                  fontSize: '14px',
                                                  fontWeight: '700',
                                                  color: '#111827',
                                                  display: 'flex',
                                                  alignItems: 'center',
                                                  gap: '8px',
                                                  minWidth: 0
                                                }}>
                                                  <FaLayerGroup size={14} style={{ color: phaseColor, flexShrink: 0 }} />
                                                  <span style={{
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis',
                                                    whiteSpace: 'nowrap'
                                                  }}>
                                                    Phase {phase.phase_number}: {phase.title}
                                                  </span>
                                                </div>
                                              </td>
                                              {phaseCells}
                                            </tr>
                                          );
                                          
                                          // Task Rows
                                          phaseTasks.forEach((task, taskIndex) => {
                                            const assignedTo = task.assigned_to_id || task.assigned_to || task.assignedTo || task.assigned_member_id || task.assignedMemberId || task.student_id || task.studentId || task.member_id || task.memberId;
                                            const assignedMember = allMembers.find(m => {
                                              const memberId = m.id || m.student_id || m.member_id;
                                              const memberStudentId = m.student_id || m.id;
                                              return assignedTo === memberId || assignedTo === memberStudentId;
                                            });
                                            
                                            const position = getTaskPosition(task, DAY_WIDTH);
                                            const taskStartDay = Math.floor((position.startDate - start) / (1000 * 60 * 60 * 24));
                                            const taskEndDay = Math.floor((position.endDate - start) / (1000 * 60 * 60 * 24));
                                            
                                            // Create task cells aligned with dates
                                            const taskCells = [];
                                            for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                              if (dayIdx >= taskStartDay && dayIdx <= taskEndDay) {
                                                const isFirstDay = dayIdx === taskStartDay;
                                                
                                                taskCells.push(
                                                  <td 
                                                    key={`task-cell-${dayIdx}`}
                                                    onClick={() => {
                                                      setGanttSelectedTask(task);
                                                      setGanttSelectedPhaseForTask(phase);
                                                      setGanttSelectedMemberForTask(assignedMember);
                                                      setShowGanttTaskModal(true);
                                                    }}
                                                    style={{
                                                      width: `${DAY_WIDTH}px`,
                                                      padding: '0px',
                                                      margin: '0px',
                                                      verticalAlign: 'middle',
                                                      backgroundColor: 'white',
                                                      borderRight: 'none',
                                                      borderBottom: '1px solid #E5E7EB',
                                                      position: 'relative',
                                                      height: `${rowHeight}px`,
                                                      display: 'table-cell',
                                                      overflow: 'hidden',
                                                      cursor: 'pointer',
                                                      transition: 'background-color 0.2s'
                                                    }}
                                                    onMouseEnter={(e) => { e.currentTarget.style.backgroundColor = '#F3F4F6'; }}
                                                    onMouseLeave={(e) => { e.currentTarget.style.backgroundColor = 'white'; }}
                                                  >
                                                    {isFirstDay && (
                                                      <div style={{
                                                        position: 'relative',
                                                        height: '34px',
                                                        width: 'auto',
                                                        maxWidth: '90%',
                                                        backgroundColor: phaseColor,
                                                        borderRadius: '17px',
                                                        padding: '0 12px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        gap: '8px',
                                                        fontSize: '11px',
                                                        color: 'white',
                                                        fontWeight: '600',
                                                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                                                        whiteSpace: 'nowrap',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        minWidth: '30px',
                                                        flexShrink: 0
                                                      }}>
                                                        {assignedMember ? (
                                                          <>
                                                            <div style={{
                                                              width: '20px',
                                                              height: '20px',
                                                              borderRadius: '50%',
                                                              overflow: 'hidden',
                                                              backgroundColor: 'white',
                                                              border: '2px solid white',
                                                              flexShrink: 0
                                                            }}>
                                                              {assignedMember.profile_image_url ? (
                                                                <img
                                                                  src={assignedMember.profile_image_url}
                                                                  alt={assignedMember.name || assignedMember.full_name}
                                                                  style={{
                                                                    width: '100%',
                                                                    height: '100%',
                                                                    objectFit: 'cover'
                                                                  }}
                                                                  onError={(e) => {
                                                                    e.target.style.display = 'none';
                                                                  }}
                                                                />
                                                              ) : (
                                                                <div style={{
                                                                  width: '100%',
                                                                  height: '100%',
                                                                  display: 'flex',
                                                                  alignItems: 'center',
                                                                  justifyContent: 'center',
                                                                  fontSize: '9px',
                                                                  fontWeight: '600',
                                                                  color: '#3B82F6',
                                                                  backgroundColor: '#DBEAFE'
                                                                }}>
                                                                  {(assignedMember.name || assignedMember.full_name || 'M').charAt(0).toUpperCase()}
                                                                </div>
                                                              )}
                                                            </div>
                                                            <span style={{ overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                                              {assignedMember.name || assignedMember.full_name}
                                                            </span>
                                                          </>
                                                        ) : (
                                                          'Unassigned'
                                                        )}
                                                      </div>
                                                    )}
                                                  </td>
                                                );
                                              } else {
                                                taskCells.push(
                                                  <td key={`task-empty-${dayIdx}`} style={{
                                                    width: `${DAY_WIDTH}px`,
                                                    padding: '0px',
                                                    margin: '0px',
                                                    verticalAlign: 'middle',
                                                    backgroundColor: 'white',
                                                    borderRight: 'none',
                                                    borderBottom: '1px solid #E5E7EB',
                                                    display: 'table-cell'
                                                  }}></td>
                                                );
                                              }
                                            }
                                            
                                            rows.push(
                                              <tr key={`task-${task.id}`} style={{
                                                backgroundColor: 'white',
                                                boxShadow: '0 1px 0 0 #E5E7EB'
                                              }}>
                                                <td style={{
                                                  width: `${nameColumnWidth}px`,
                                                  padding: '8px 16px 8px 32px',
                                                  verticalAlign: 'middle',
                                                  borderRight: '2px solid #E5E7EB',
                                                  borderLeft: '2px solid #E5E7EB',
                                                  borderTop: '1px solid #E5E7EB',
                                                  borderBottom: '1px solid #E5E7EB',
                                                  backgroundColor: 'white',
                                                  height: `${rowHeight}px`,
                                                  maxWidth: `${nameColumnWidth}px`,
                                                  overflow: 'hidden'
                                                }}>
                                                  <div style={{
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    color: '#374151',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    minWidth: 0
                                                  }}>
                                                    <FaTasks size={11} style={{ color: phaseColor, flexShrink: 0 }} />
                                                    <span style={{
                                                      overflow: 'hidden',
                                                      textOverflow: 'ellipsis',
                                                      whiteSpace: 'nowrap',
                                                      flex: 1
                                                    }}>
                                                      {task.title}
                                                    </span>
                                                  </div>
                                                </td>
                                                {taskCells}
                                              </tr>
                                            );
                                          });
                                          
                                          // Add Evaluation Phase after this phase if it exists
                                          const isLastPhase = phaseIndex === phases.length - 1;
                                          if (phase.evaluation_available_from && phase.evaluation_due_date) {
                                            const rowHeight = 50;
                                            
                                            const evalStart = new Date(phase.evaluation_available_from);
                                            const evalEnd = new Date(phase.evaluation_due_date);
                                            evalStart.setHours(0, 0, 0, 0);
                                            evalEnd.setHours(0, 0, 0, 0);
                                            
                                            const evalStartOffset = Math.floor((evalStart - timelineStart) / (1000 * 60 * 60 * 24));
                                            const evalDurationDays = Math.floor((evalEnd - evalStart) / (1000 * 60 * 60 * 24)) + 1;
                                            
                                            // Check for project evaluation on last phase
                                            const hasProjectEval = isLastPhase && selectedGanttProject.project_evaluation_forms && selectedGanttProject.project_evaluation_forms.length > 0;
                                            const evalLabel = hasProjectEval ? 'Project Evaluation' : 'Phase Evaluation';
                                            const evalColor = hasProjectEval ? '#10B981' : '#8B5CF6';
                                            
                                            // Create eval cells
                                            const evalCells = [];
                                            for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                              if (dayIdx >= evalStartOffset && dayIdx < evalStartOffset + evalDurationDays) {
                                                evalCells.push(
                                                  <td 
                                                    key={`eval-cell-${dayIdx}`} 
                                                    onClick={() => {
                                                      setGanttSelectedEval(phase);
                                                      setGanttEvalType(hasProjectEval ? 'project' : 'phase');
                                                      setShowGanttEvalModal(true);
                                                    }}
                                                    style={{
                                                      width: `${DAY_WIDTH}px`,
                                                      padding: '0px',
                                                      margin: '0px',
                                                      verticalAlign: 'middle',
                                                      backgroundColor: evalColor,
                                                      borderRight: 'none',
                                                      borderBottom: '1px solid rgba(255,255,255,0.2)',
                                                      color: 'white',
                                                      fontWeight: '600',
                                                      fontSize: '11px',
                                                      textAlign: 'center',
                                                      height: `${rowHeight}px`,
                                                      display: 'table-cell',
                                                      overflow: 'hidden',
                                                      whiteSpace: 'nowrap',
                                                      cursor: 'pointer',
                                                      transition: 'opacity 0.2s',
                                                      opacity: 1
                                                    }}
                                                    onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                                    onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                                  >
                                                    {dayIdx === evalStartOffset && evalLabel.substring(0, 4)}
                                                  </td>
                                                );
                                              } else {
                                                evalCells.push(
                                                  <td key={`eval-empty-${dayIdx}`} style={{
                                                    width: `${DAY_WIDTH}px`,
                                                    padding: '0px',
                                                    margin: '0px',
                                                    verticalAlign: 'middle',
                                                    backgroundColor: 'white',
                                                    borderRight: 'none',
                                                    borderBottom: '1px solid #E5E7EB',
                                                    display: 'table-cell'
                                                  }}></td>
                                                );
                                              }
                                            }
                                            
                                            rows.push(
                                              <tr key={`eval-phase-${phase.id}`} style={{
                                                backgroundColor: '#F9FAFB',
                                                boxShadow: '0 2px 0 0 #E5E7EB'
                                              }}>
                                                <td style={{
                                                  width: `${nameColumnWidth}px`,
                                                  padding: '12px 16px',
                                                  verticalAlign: 'middle',
                                                  borderRight: '2px solid #E5E7EB',
                                                  borderLeft: '2px solid #E5E7EB',
                                                  borderTop: '1px solid #E5E7EB',
                                                  borderBottom: '1px solid #E5E7EB',
                                                  backgroundColor: '#F9FAFB',
                                                  height: `${rowHeight}px`
                                                }}>
                                                  <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '700',
                                                    color: '#111827',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px'
                                                  }}>
                                                    <FaClipboardCheck size={14} style={{ color: evalColor }} />
                                                    {evalLabel}
                                                  </div>
                                                </td>
                                                {evalCells}
                                              </tr>
                                            );
                                          }
                                          
                                          // Add Breathe Phase after evaluation if it exists
                                          if (phase.breathe_start_date && phase.breathe_end_date) {
                                            const rowHeight = 50;
                                            
                                            const breatheStart = new Date(phase.breathe_start_date);
                                            const breatheEnd = new Date(phase.breathe_end_date);
                                            breatheStart.setHours(0, 0, 0, 0);
                                            breatheEnd.setHours(0, 0, 0, 0);
                                            
                                            const breatheStartOffset = Math.floor((breatheStart - timelineStart) / (1000 * 60 * 60 * 24));
                                            const breatheDurationDays = Math.floor((breatheEnd - breatheStart) / (1000 * 60 * 60 * 24)) + 1;
                                            
                                            // Create breathe cells
                                            const breatheCells = [];
                                            for (let dayIdx = 0; dayIdx < timelineDays.length; dayIdx++) {
                                              if (dayIdx >= breatheStartOffset && dayIdx < breatheStartOffset + breatheDurationDays) {
                                                breatheCells.push(
                                                  <td 
                                                    key={`breathe-cell-${dayIdx}`} 
                                                    onClick={() => {
                                                      setSelectedBreathePhase(phase);
                                                      setShowBreatheModal(true);
                                                    }}
                                                    style={{
                                                      width: `${DAY_WIDTH}px`,
                                                      padding: '0px',
                                                      margin: '0px',
                                                      verticalAlign: 'middle',
                                                      backgroundColor: '#F59E0B',
                                                      borderRight: 'none',
                                                      borderBottom: '1px solid rgba(255,255,255,0.2)',
                                                      color: 'white',
                                                      fontWeight: '600',
                                                      fontSize: '11px',
                                                      textAlign: 'center',
                                                      height: `${rowHeight}px`,
                                                      display: 'table-cell',
                                                      overflow: 'hidden',
                                                      whiteSpace: 'nowrap',
                                                      cursor: 'pointer',
                                                      transition: 'opacity 0.2s',
                                                      opacity: 1
                                                    }}
                                                    onMouseEnter={(e) => { e.currentTarget.style.opacity = '0.8'; }}
                                                    onMouseLeave={(e) => { e.currentTarget.style.opacity = '1'; }}
                                                  >
                                                    {dayIdx === breatheStartOffset && 'BREATHE'}
                                                  </td>
                                                );
                                              } else {
                                                breatheCells.push(
                                                  <td key={`breathe-empty-${dayIdx}`} style={{
                                                    width: `${DAY_WIDTH}px`,
                                                    padding: '0px',
                                                    margin: '0px',
                                                    verticalAlign: 'middle',
                                                    backgroundColor: 'white',
                                                    borderRight: 'none',
                                                    borderBottom: '1px solid #E5E7EB',
                                                    display: 'table-cell'
                                                  }}></td>
                                                );
                                              }
                                            }
                                            
                                            rows.push(
                                              <tr key={`breathe-phase-${phase.id}`} style={{
                                                backgroundColor: '#F9FAFB',
                                                boxShadow: '0 2px 0 0 #E5E7EB'
                                              }}>
                                                <td style={{
                                                  width: `${nameColumnWidth}px`,
                                                  padding: '12px 16px',
                                                  verticalAlign: 'middle',
                                                  borderRight: '2px solid #E5E7EB',
                                                  borderLeft: '2px solid #E5E7EB',
                                                  borderTop: '1px solid #E5E7EB',
                                                  borderBottom: '1px solid #E5E7EB',
                                                  backgroundColor: '#F9FAFB',
                                                  height: `${rowHeight}px`
                                                }}>
                                                  <div style={{
                                                    fontSize: '14px',
                                                    fontWeight: '700',
                                                    color: '#111827',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px'
                                                  }}>
                                                    <FaWind size={14} style={{ color: '#F59E0B' }} />
                                                    Breathe Phase
                                                  </div>
                                                </td>
                                                {breatheCells}
                                              </tr>
                                            );
                                          }
                                        });
                                        
                                        return rows;
                                      })()}
                                    </tbody>
                                  </table>
                                  </div>
                                </div>
                                
                                {/* Legend & Info */}
                                <div style={{
                                  padding: '16px',
                                  backgroundColor: '#F9FAFB',
                                  borderTop: '1px solid #E5E7EB',
                                  marginBottom: '4px',
                                  minWidth: `${timelinePixelWidth}px`
                                }}>
                                  <div style={{
                                    display: 'flex',
                                    gap: '24px',
                                    justifyContent: 'center',
                                    flexWrap: 'wrap',
                                    marginBottom: '8px'
                                  }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                      <div style={{ width: '18px', height: '18px', backgroundColor: '#10B981', borderRadius: '4px' }}></div>
                                      <span style={{ fontWeight: '500' }}>Completed</span>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                      <div style={{ width: '18px', height: '18px', backgroundColor: '#F59E0B', borderRadius: '4px' }}></div>
                                      <span style={{ fontWeight: '500' }}>In Progress</span>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                      <div style={{ width: '18px', height: '18px', backgroundColor: '#EF4444', borderRadius: '4px' }}></div>
                                      <span style={{ fontWeight: '500' }}>Overdue</span>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
                                      <div style={{ width: '18px', height: '18px', backgroundColor: '#6B7280', borderRadius: '4px' }}></div>
                                      <span style={{ fontWeight: '500' }}>Pending</span>
                                    </div>
                                  </div>
                                  <div style={{
                                    textAlign: 'center',
                                    fontSize: '11px',
                                    color: '#6B7280',
                                    lineHeight: '1.6',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <FaInfoCircle size={11} />
                                      Timeline: {selectedGanttPhase ? 
                                      `Phase ${selectedGanttPhase.phase_number}` :
                                      `Project Overview (${phaseIndicators.length} phase${phaseIndicators.length !== 1 ? 's' : ''})`} 
                                    ({start.toLocaleDateString()} - {end.toLocaleDateString()})
                                    ‚Ä¢ {timelineDays.length} day{timelineDays.length !== 1 ? 's' : ''}
                                      {timelineDays.length > 30 && (
                                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                          ‚Ä¢ Scroll horizontally <FaArrowRight size={9} />
                                        </span>
                                      )}
                                    </div>
                                    {selectedGanttProject?.breathe_phase_days > 0 && (
                                      <div style={{ marginTop: '4px', color: '#3B82F6', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                        <FaClock size={11} />
                                        Breathe Phase: {selectedGanttProject.breathe_phase_days} day{selectedGanttProject.breathe_phase_days !== 1 ? 's' : ''} between phases (not shown on timeline)
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </>
                              );
                            })()}
                          </div>
                        ) : (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #B9B28A',
                            borderRadius: '8px',
                            padding: '60px',
                            textAlign: 'center',
                            color: '#9CA3AF'
                          }}>
                            Please select a project to view the timeline
                          </div>
                        )}
                      </div>
                    ) : null}

                    {/* Deliverable Summary Section */}
                    <div className="my-group-card-with-crosshair" style={{
                      backgroundColor: 'white',
                      border: '0.1px solid rgb(95, 95, 95)',
                      borderRadius: '0px',
                      padding: '24px',
                      marginBottom: '24px'
                    }}>
                      {/* Crosshair Corners */}
                      <div className="crosshair-corner top-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner top-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      
                      <h3 style={{
                        color: '#504B38',
                        fontSize: '18px',
                        fontWeight: '600',
                        margin: '0 0 20px 0',
                        zIndex: 10,
                        position: 'relative'
                      }}>
                        Deliverable Summary
                      </h3>
                      
                      {/* Two-Column Layout */}
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 300px',
                        gap: '24px'
                      }}>
                        {/* Left Side - Graph and Members */}
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '16px'
                        }}>
                          {/* Graph */}
                          <div 
                            ref={reportsPieChartRef}
                            style={{
                            backgroundColor: 'white',
                            border: '1px solid #E5E7EB',
                            borderRadius: '8px',
                            padding: '20px',
                            minHeight: '320px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center'
                          }}>
                            <div style={{
                              fontSize: '14px',
                              fontWeight: '600',
                              color: '#504B38',
                              marginBottom: '4px',
                              width: '100%',
                              textAlign: 'center'
                            }}>
                              Submissions per Member
                            </div>
                            <div style={{
                              fontSize: '12px',
                              color: '#6B7280',
                              marginBottom: '16px',
                              width: '100%',
                              textAlign: 'center'
                            }}>
                              {selectedSubmissionStatusFilter ? (
                                <>
                                  Showing{' '}
                                  <span style={{ fontWeight: '600', color: '#504B38' }}>
                                    {selectedSubmissionStatusFilter === 'completed' && 'Completed'}
                                    {selectedSubmissionStatusFilter === 'submitted' && 'Pending'}
                                    {selectedSubmissionStatusFilter === 'missed' && 'Unsubmitted'}
                                    {selectedSubmissionStatusFilter === 'late' && 'Late'}
                                    {selectedSubmissionStatusFilter === 'revision' && 'Revision'}
                                  </span>
                                  {' '}submissions by team member
                                </>
                              ) : (
                                'Tracking submission amounts by team member'
                              )}
                            </div>
                            
                            {/* Pie Chart */}
                            {(() => {
                              // Calculate submission counts per member from allGroupTasks
                              const members = groupMembers.length > 0 ? groupMembers : groupData?.members || [];
                              
                              // Get all tasks from allGroupTasks
                              const allTasks = Array.isArray(allGroupTasks) 
                                ? allGroupTasks.flatMap(memberData => memberData.tasks || [])
                                : [];
                              
                              // Filter tasks based on selected phase (use selectedGanttPhase from the project/phase dropdown)
                              const filteredTasks = selectedGanttPhase && selectedReportsProject
                                ? allTasks.filter(task => {
                                    const taskPhaseId = task.phase_id || task.project_phase_id;
                                    return taskPhaseId === selectedGanttPhase.id;
                                  })
                                : allTasks;
                              
                              // Count submissions per member
                              const submissionCounts = {};
                              
                              // Initialize all members with 0 count
                              members.forEach(member => {
                                const memberId = member.student_id || member.id;
                                submissionCounts[memberId] = {
                                  name: member.name || member.full_name || `Member ${memberId}`,
                                  count: 0
                                };
                              });
                              
                              // Count submissions from tasks - Use LATEST submission only (avoid duplicates)
                              filteredTasks.forEach(task => {
                                // Get the member ID from the task - task belongs to a member
                                const memberId = task.student_id || task.assigned_to || task.member_id;
                                
                                if (memberId && submissionCounts[memberId]) {
                                  // Get submission data from nested objects
                                  const taskSubmissions = task.task_submissions || [];
                                  
                                  // Find ALL submissions (task_submissions + revision_submissions) with timestamps
                                  let allSubmissions = [];
                                  
                                  // Add all task submissions
                                  taskSubmissions.forEach(taskSub => {
                                    allSubmissions.push({
                                      type: 'task_submission',
                                      data: taskSub,
                                      timestamp: new Date(taskSub.created_at || taskSub.submitted_at || 0)
                                    });
                                    
                                    // Add all revision submissions linked to this task submission
                                    if (taskSub.revision_submissions && Array.isArray(taskSub.revision_submissions)) {
                                      taskSub.revision_submissions.forEach(revSub => {
                                        allSubmissions.push({
                                          type: 'revision_submission',
                                          data: revSub,
                                          timestamp: new Date(revSub.created_at || revSub.submitted_at || 0)
                                        });
                                      });
                                    }
                                  });
                                  
                                  // Apply status filter based on submission status
                                  let shouldCount = false;
                                  
                                  if (selectedSubmissionStatusFilter === 'missed') {
                                    // Missed = NO submissions AND past due date
                                    if (allSubmissions.length === 0) {
                                      if (!task.due_date) {
                                        shouldCount = true; // No due date and no submission = missed
                                      } else {
                                        const dueDate = new Date(task.due_date);
                                        const now = new Date();
                                        shouldCount = dueDate < now; // Past due date with no submission
                                      }
                                    }
                                  } else if (allSubmissions.length === 0) {
                                    // No submissions for other filters - skip
                                    shouldCount = false;
                                  } else {
                                    // Sort by timestamp (newest first) to get the LATEST submission
                                    allSubmissions.sort((a, b) => b.timestamp - a.timestamp);
                                    const latestSubmission = allSubmissions[0];
                                    
                                    console.log(`üîç [DEBUG] Task ${task.id}: Latest submission type=${latestSubmission.type}, status=${latestSubmission.data.status}, timestamp=${latestSubmission.timestamp.toISOString()}`);
                                    
                                    if (selectedSubmissionStatusFilter === null) {
                                      // No filter - count all submissions
                                      shouldCount = true;
                                    } else if (selectedSubmissionStatusFilter === 'completed') {
                                      // Count only if latest submission is approved
                                      shouldCount = latestSubmission.data.status === 'approved';
                                    } else if (selectedSubmissionStatusFilter === 'submitted') {
                                      // Count if latest submission is pending (waiting for review)
                                      shouldCount = latestSubmission.data.status === 'pending' || latestSubmission.data.status === 'pending_approval';
                                    } else if (selectedSubmissionStatusFilter === 'late') {
                                      // Late = submitted after due date BUT within available_until_date
                                      if (task.due_date && latestSubmission.data.submitted_at) {
                                        const dueDate = new Date(task.due_date);
                                        const submittedDate = new Date(latestSubmission.data.submitted_at);
                                        const availableUntilDate = task.available_until_date ? new Date(task.available_until_date) : null;
                                        
                                        const isLate = submittedDate > dueDate;
                                        if (isLate) {
                                          // If available_until_date exists, must be within that window
                                          if (availableUntilDate) {
                                            shouldCount = submittedDate <= availableUntilDate;
                                          } else {
                                            // No available_until_date, just check if late
                                            shouldCount = true;
                                          }
                                        }
                                      }
                                    } else if (selectedSubmissionStatusFilter === 'revision') {
                                      // Count if latest submission needs revision
                                      shouldCount = latestSubmission.data.status === 'revision_requested' || 
                                                   latestSubmission.data.status === 'to_revise' ||
                                                   latestSubmission.data.status === 'needs_revision';
                                    }
                                  }
                                  
                                  if (shouldCount) {
                                    submissionCounts[memberId].count++;
                                  }
                                }
                              });
                              
                              // Also check deliverablesView.phases for phase deliverable submissions
                              // BUT ONLY if we haven't already counted them in the task loop
                              // AND only if status filter is not applied (to avoid double counting)
                              if (selectedSubmissionStatusFilter === null && deliverablesView.phases && Array.isArray(deliverablesView.phases)) {
                                const phaseSubmissions = deliverablesView.phases.flatMap(phase => phase.submissionDetails || []);
                                
                                phaseSubmissions.forEach(submission => {
                                  const memberId = submission.submitted_by_student_id || 
                                                  submission.submitted_by || 
                                                  submission.student_id ||
                                                  submission.created_by;
                                  
                                  if (memberId && submissionCounts[memberId]) {
                                    submissionCounts[memberId].count++;
                                  } else if (memberId) {
                                    // Member exists but not in our initial list, add them
                                    submissionCounts[memberId] = {
                                      name: `Member ${memberId}`,
                                      count: 1
                                    };
                                  }
                                });
                              }
                              
                              // Also check projectProgressData for additional submissions
                              // BUT ONLY if status filter is not applied (to avoid double counting)
                              if (selectedSubmissionStatusFilter === null && projectProgressData?.phaseSubmissions && Array.isArray(projectProgressData.phaseSubmissions)) {
                                projectProgressData.phaseSubmissions.forEach(submission => {
                                  const memberId = submission.submitted_by_student_id || 
                                                  submission.submitted_by || 
                                                  submission.student_id ||
                                                  submission.created_by;
                                  
                                  if (memberId && submissionCounts[memberId]) {
                                    submissionCounts[memberId].count++;
                                  } else if (memberId && !submissionCounts[memberId]) {
                                    // Member exists but not in our initial list, add them
                                    submissionCounts[memberId] = {
                                      name: `Member ${memberId}`,
                                      count: 1
                                    };
                                  }
                                });
                              }
                              
                              // Prepare pie chart data - only show members with submissions
                              const pieData = Object.values(submissionCounts)
                                .filter(m => m.count > 0)
                                .map((member, index) => ({
                                  id: index,
                                  value: member.count,
                                  label: `${member.name} (${member.count})`,
                                  name: member.name
                                }));
                              
                              // If no submissions, show placeholder
                              if (pieData.length === 0) {
                                return (
                                  <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    height: '200px',
                                    color: '#9CA3AF',
                                    fontSize: '14px'
                                  }}>
                                    <FaClipboardList size={48} style={{ marginBottom: '12px', opacity: 0.5 }} />
                                    <div>No submissions tracked yet</div>
                                    {allTasks.length > 0 && (
                                      <div style={{ fontSize: '12px', marginTop: '8px', color: '#6B7280' }}>
                                        {allTasks.length} tasks found, but no submissions recorded
                                      </div>
                                    )}
                                  </div>
                                );
                              }
                              
                              // Color palette for pie chart - changes based on selected filter
                              let COLORS = [];
                              if (selectedSubmissionStatusFilter === 'completed') {
                                // Green shades for completed
                                COLORS = ['#10B981', '#059669', '#047857', '#065F46', '#064E3B'];
                              } else if (selectedSubmissionStatusFilter === 'submitted') {
                                // Blue shades for pending
                                COLORS = ['#3B82F6', '#2563EB', '#1D4ED8', '#1E40AF', '#1E3A8A'];
                              } else if (selectedSubmissionStatusFilter === 'missed') {
                                // Red shades for unsubmitted/missed
                                COLORS = ['#EF4444', '#DC2626', '#B91C1C', '#991B1B', '#7F1D1D'];
                              } else if (selectedSubmissionStatusFilter === 'late') {
                                // Orange/Yellow shades for late
                                COLORS = ['#F59E0B', '#D97706', '#B45309', '#92400E', '#78350F'];
                              } else if (selectedSubmissionStatusFilter === 'revision') {
                                // Purple shades for revision
                                COLORS = ['#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95'];
                              } else {
                                // Default mixed palette for no filter
                                COLORS = ['#872341', '#BE3144', '#E17564', '#09122C', '#6B7280', '#10B981', '#F59E0B', '#3B82F6'];
                              }
                              
                              return (
                                <ResponsiveContainer width="100%" height={280}>
                                  <PieChart>
                                    <Pie
                                      data={pieData}
                                      cx="50%"
                                      cy="50%"
                                      innerRadius={60}
                                      outerRadius={100}
                                      paddingAngle={2}
                                      dataKey="value"
                                      label={({ name, percent, value }) => `${name.split(' ')[0]}: ${value}`}
                                    >
                                      {pieData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                      ))}
                                    </Pie>
                                    <Tooltip 
                                      formatter={(value, name, props) => [
                                        `${props.payload.name}: ${value} submission${value !== 1 ? 's' : ''}`,
                                        'Count'
                                      ]}
                                    />
                                    <Legend 
                                      formatter={(value, entry) => entry.payload.name}
                                      wrapperStyle={{ fontSize: '12px', paddingTop: '10px' }}
                                    />
                                  </PieChart>
                                </ResponsiveContainer>
                              );
                            })()}
                          </div>
                          
                          {/* Team Members - Below Graph */}
                          <div style={{
                            backgroundColor: '#F9FAFB',
                            border: '1px solid #E5E7EB',
                            borderRadius: '8px',
                            padding: '16px'
                          }}>
                            <div style={{
                              fontSize: '14px',
                              fontWeight: '600',
                              color: '#504B38',
                              marginBottom: '12px'
                            }}>
                              Team Members ({(groupMembers.length > 0 ? groupMembers : groupData?.members || []).length})
                            </div>
                            <div style={{
                              display: 'flex',
                              flexWrap: 'wrap',
                              gap: '8px'
                            }}>
                              {(groupMembers.length > 0 ? groupMembers : groupData?.members || []).map((member, idx) => (
                                <div
                                  key={member.id || idx}
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    padding: '6px 10px',
                                    backgroundColor: 'white',
                                    border: '1px solid #E5E7EB',
                                    borderRadius: '6px',
                                    fontSize: '12px'
                                  }}
                                >
                                  <div style={{
                                    width: '24px',
                                    height: '24px',
                                    borderRadius: '50%',
                                    overflow: 'hidden',
                                    backgroundColor: '#E5E7EB',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    color: '#6B7280'
                                  }}>
                                    {member.profile_image_url ? (
                                      <img
                                        src={member.profile_image_url}
                                        alt={member.name || member.full_name}
                                        style={{
                                          width: '100%',
                                          height: '100%',
                                          objectFit: 'cover'
                                        }}
                                        onError={(e) => {
                                          e.target.style.display = 'none';
                                          e.target.parentElement.textContent = (member.name || member.full_name || 'M').charAt(0).toUpperCase();
                                        }}
                                      />
                                    ) : (
                                      (member.name || member.full_name || 'M').charAt(0).toUpperCase()
                                    )}
                                  </div>
                                  <span style={{ fontWeight: '500', color: '#504B38' }}>
                                    {member.name || member.full_name}
                                  </span>
                                  {member.role === 'leader' && (
                                    <span style={{
                                      fontSize: '10px',
                                      padding: '2px 6px',
                                      backgroundColor: '#DBEAFE',
                                      color: '#1E40AF',
                                      borderRadius: '4px',
                                      fontWeight: '600'
                                    }}>
                                      Leader
                                    </span>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                        
                        {/* Right Side - Task Status Counts (Clickable for Filter) */}
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '12px'
                        }}>
                          {/* Task Status Cards - Clickable for Filtering */}
                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '8px',
                            paddingTop: '8px'
                          }}>
                            {(() => {
                              // Calculate task counts based on selected phase (use selectedGanttPhase from project/phase dropdown)
                              const tasks = allGroupTasks.flatMap(memberData => memberData.tasks || []);
                              const filteredTasks = selectedGanttPhase 
                                ? tasks.filter(task => task.phase_id === selectedGanttPhase.id || task.project_phase_id === selectedGanttPhase.id)
                                : tasks;

                              // Helper function to get latest submission across task_submissions and revision_submissions
                              const getLatestSubmissionStatus = (task) => {
                                const taskSubmissions = task.task_submissions || [];
                                
                                if (taskSubmissions.length === 0) {
                                  return null; // No submissions
                                }
                                
                                // Find ALL submissions with timestamps
                                let allSubmissions = [];
                                taskSubmissions.forEach(taskSub => {
                                  allSubmissions.push({
                                    type: 'task_submission',
                                    status: taskSub.status,
                                    submitted_at: taskSub.submitted_at,
                                    created_at: taskSub.created_at,
                                    timestamp: new Date(taskSub.created_at || taskSub.submitted_at || 0)
                                  });
                                  
                                  if (taskSub.revision_submissions && Array.isArray(taskSub.revision_submissions)) {
                                    taskSub.revision_submissions.forEach(revSub => {
                                      allSubmissions.push({
                                        type: 'revision_submission',
                                        status: revSub.status,
                                        submitted_at: revSub.submitted_at,
                                        created_at: revSub.created_at,
                                        timestamp: new Date(revSub.created_at || revSub.submitted_at || 0)
                                      });
                                    });
                                  }
                                });
                                
                                if (allSubmissions.length === 0) return null;
                                
                                // Sort by timestamp (newest first)
                                allSubmissions.sort((a, b) => b.timestamp - a.timestamp);
                                return allSubmissions[0]; // Return latest submission
                              };

                              const completed = filteredTasks.filter(t => {
                                const latest = getLatestSubmissionStatus(t);
                                return latest && latest.status === 'approved';
                              }).length;
                              
                              const submitted = filteredTasks.filter(t => {
                                const latest = getLatestSubmissionStatus(t);
                                return latest && (latest.status === 'pending' || latest.status === 'pending_approval');
                              }).length;
                              
                              const missed = filteredTasks.filter(t => {
                                // Missed = Task has NO submission AND is past due date
                                const latest = getLatestSubmissionStatus(t);
                                if (latest) return false; // Has a submission, so not missed
                                
                                if (!t.due_date) return true; // No due date set, counts as missed if no submission
                                const dueDate = new Date(t.due_date);
                                const now = new Date();
                                return dueDate < now; // Past due date with no submission
                              }).length;
                              
                              const late = filteredTasks.filter(t => {
                                // Late = Task has submission AND submitted_date > due_date AND submitted_date <= available_until_date
                                if (!t.due_date) return false; // Need a due date to be "late"
                                
                                const latest = getLatestSubmissionStatus(t);
                                if (!latest || !latest.submitted_at) return false; // Need a submission date
                                
                                const submittedDate = new Date(latest.submitted_at);
                                const dueDate = new Date(t.due_date);
                                const availableUntilDate = t.available_until_date ? new Date(t.available_until_date) : null;
                                const now = new Date();
                                
                                // Check if submitted after due date
                                const isLate = submittedDate > dueDate;
                                if (!isLate) return false;
                                
                                // If available_until_date exists, check if submitted within that window
                                if (availableUntilDate) {
                                  return submittedDate <= availableUntilDate;
                                }
                                
                                // If no available_until_date, just check if it was submitted late
                                return true;
                              }).length;
                              
                              const revision = filteredTasks.filter(t => {
                                const latest = getLatestSubmissionStatus(t);
                                return latest && (latest.status === 'revision_requested' || latest.status === 'to_revise' || latest.status === 'needs_revision');
                              }).length;

                              return (
                                <>
                                  {/* Completed - Clickable */}
                                  <div 
                                    onClick={() => setSelectedSubmissionStatusFilter(selectedSubmissionStatusFilter === 'completed' ? null : 'completed')}
                                    style={{
                                      padding: '12px',
                                      backgroundColor: selectedSubmissionStatusFilter === 'completed' ? '#DCF4E7' : '#F0FDF4',
                                      border: selectedSubmissionStatusFilter === 'completed' ? '2px solid #10B981' : '1px solid #86EFAC',
                                      borderRadius: '6px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'space-between',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseOver={(e) => {
                                      if (selectedSubmissionStatusFilter !== 'completed') {
                                        e.currentTarget.style.backgroundColor = '#E6FAF0';
                                        e.currentTarget.style.borderColor = '#6EE7B7';
                                      }
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.backgroundColor = selectedSubmissionStatusFilter === 'completed' ? '#DCF4E7' : '#F0FDF4';
                                      e.currentTarget.style.borderColor = selectedSubmissionStatusFilter === 'completed' ? '2px solid #10B981' : '1px solid #86EFAC';
                                    }}
                                  >
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#166534' }}>Completed Submissions</span>
                                    <span style={{
                                      padding: '4px 10px',
                                      backgroundColor: '#10B981',
                                      color: 'white',
                                      borderRadius: '12px',
                                      fontSize: '13px',
                                      fontWeight: '700'
                                    }}>
                                      {completed}
                                    </span>
                                  </div>

                                  {/* Submitted - Clickable */}
                                  <div 
                                    onClick={() => setSelectedSubmissionStatusFilter(selectedSubmissionStatusFilter === 'submitted' ? null : 'submitted')}
                                    style={{
                                      padding: '12px',
                                      backgroundColor: selectedSubmissionStatusFilter === 'submitted' ? '#DBEAFE' : '#EFF6FF',
                                      border: selectedSubmissionStatusFilter === 'submitted' ? '2px solid #3B82F6' : '1px solid #93C5FD',
                                      borderRadius: '6px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'space-between',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseOver={(e) => {
                                      if (selectedSubmissionStatusFilter !== 'submitted') {
                                        e.currentTarget.style.backgroundColor = '#E0E7FF';
                                        e.currentTarget.style.borderColor = '#60A5FA';
                                      }
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.backgroundColor = selectedSubmissionStatusFilter === 'submitted' ? '#DBEAFE' : '#EFF6FF';
                                      e.currentTarget.style.borderColor = selectedSubmissionStatusFilter === 'submitted' ? '2px solid #3B82F6' : '1px solid #93C5FD';
                                    }}
                                  >
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#1E40AF' }}>Pending Submissions</span>
                                    <span style={{
                                      padding: '4px 10px',
                                      backgroundColor: '#3B82F6',
                                      color: 'white',
                                      borderRadius: '12px',
                                      fontSize: '13px',
                                      fontWeight: '700'
                                    }}>
                                      {submitted}
                                    </span>
                                  </div>

                                  {/* Missed - Clickable */}
                                  <div 
                                    onClick={() => setSelectedSubmissionStatusFilter(selectedSubmissionStatusFilter === 'missed' ? null : 'missed')}
                                    style={{
                                      padding: '12px',
                                      backgroundColor: selectedSubmissionStatusFilter === 'missed' ? '#FECACA' : '#FEF2F2',
                                      border: selectedSubmissionStatusFilter === 'missed' ? '2px solid #EF4444' : '1px solid #FCA5A5',
                                      borderRadius: '6px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'space-between',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseOver={(e) => {
                                      if (selectedSubmissionStatusFilter !== 'missed') {
                                        e.currentTarget.style.backgroundColor = '#FED7D7';
                                        e.currentTarget.style.borderColor = '#F87171';
                                      }
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.backgroundColor = selectedSubmissionStatusFilter === 'missed' ? '#FECACA' : '#FEF2F2';
                                      e.currentTarget.style.borderColor = selectedSubmissionStatusFilter === 'missed' ? '2px solid #EF4444' : '1px solid #FCA5A5';
                                    }}
                                  >
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#991B1B' }}>Unsubmitted (Missed)</span>
                                    <span style={{
                                      padding: '4px 10px',
                                      backgroundColor: '#EF4444',
                                      color: 'white',
                                      borderRadius: '12px',
                                      fontSize: '13px',
                                      fontWeight: '700'
                                    }}>
                                      {missed}
                                    </span>
                                  </div>

                                  {/* Late - Clickable */}
                                  <div 
                                    onClick={() => setSelectedSubmissionStatusFilter(selectedSubmissionStatusFilter === 'late' ? null : 'late')}
                                    style={{
                                      padding: '12px',
                                      backgroundColor: selectedSubmissionStatusFilter === 'late' ? '#FEE2E4' : '#FFFBEB',
                                      border: selectedSubmissionStatusFilter === 'late' ? '2px solid #F59E0B' : '1px solid #FCD34D',
                                      borderRadius: '6px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'space-between',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseOver={(e) => {
                                      if (selectedSubmissionStatusFilter !== 'late') {
                                        e.currentTarget.style.backgroundColor = '#FFEAA7';
                                        e.currentTarget.style.borderColor = '#FFD700';
                                      }
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.backgroundColor = selectedSubmissionStatusFilter === 'late' ? '#FEE2E4' : '#FFFBEB';
                                      e.currentTarget.style.borderColor = selectedSubmissionStatusFilter === 'late' ? '2px solid #F59E0B' : '1px solid #FCD34D';
                                    }}
                                  >
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#92400E' }}>Late Submissions</span>
                                    <span style={{
                                      padding: '4px 10px',
                                      backgroundColor: '#F59E0B',
                                      color: 'white',
                                      borderRadius: '12px',
                                      fontSize: '13px',
                                      fontWeight: '700'
                                    }}>
                                      {late}
                                    </span>
                                  </div>

                                  {/* Revision - Clickable */}
                                  <div 
                                    onClick={() => setSelectedSubmissionStatusFilter(selectedSubmissionStatusFilter === 'revision' ? null : 'revision')}
                                    style={{
                                      padding: '12px',
                                      backgroundColor: selectedSubmissionStatusFilter === 'revision' ? '#EDE9FE' : '#F5F3FF',
                                      border: selectedSubmissionStatusFilter === 'revision' ? '2px solid #8B5CF6' : '1px solid #C4B5FD',
                                      borderRadius: '6px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'space-between',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseOver={(e) => {
                                      if (selectedSubmissionStatusFilter !== 'revision') {
                                        e.currentTarget.style.backgroundColor = '#F3E8FF';
                                        e.currentTarget.style.borderColor = '#D8B4FE';
                                      }
                                    }}
                                    onMouseOut={(e) => {
                                      e.currentTarget.style.backgroundColor = selectedSubmissionStatusFilter === 'revision' ? '#EDE9FE' : '#F5F3FF';
                                      e.currentTarget.style.borderColor = selectedSubmissionStatusFilter === 'revision' ? '2px solid #8B5CF6' : '1px solid #C4B5FD';
                                    }}
                                  >
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#5B21B6' }}>Revision Submissions</span>
                                    <span style={{
                                      padding: '4px 10px',
                                      backgroundColor: '#8B5CF6',
                                      color: 'white',
                                      borderRadius: '12px',
                                      fontSize: '13px',
                                      fontWeight: '700'
                                    }}>
                                      {revision}
                                    </span>
                                  </div>
                                </>
                              );
                            })()}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Task Assignment Table Section */}
                    <div 
                      ref={reportsTaskTableRef}
                      className="my-group-card-with-crosshair" style={{
                      backgroundColor: 'white',
                      border: '0.1px solid rgb(95, 95, 95)',
                      borderRadius: '0px',
                      padding: '24px',
                      marginTop: '24px'
                    }}>
                      {/* Crosshair Corners */}
                      <div className="crosshair-corner top-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner top-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-left">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      <div className="crosshair-corner bottom-right">
                        <div className="crosshair-h"></div>
                        <div className="crosshair-v"></div>
                      </div>
                      
                      <h3 style={{
                        color: '#504B38',
                        fontSize: '18px',
                        fontWeight: '600',
                        margin: '0 0 20px 0',
                        zIndex: 10,
                        position: 'relative'
                      }}>
                        Task Assignment Table
                      </h3>
                      
                      {/* Table Container */}
                      <div style={{
                        backgroundColor: 'white',
                        border: '1px solid #E5E7EB',
                        borderRadius: '8px',
                        overflow: 'hidden'
                      }}>
                        {/* Table Header */}
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: '250px repeat(4, 1fr)',
                          backgroundColor: '#F9FAFB',
                          borderBottom: '2px solid #E5E7EB',
                          padding: '12px 16px',
                          fontWeight: '600',
                          fontSize: '13px',
                          color: '#374151'
                        }}>
                          <div>Member</div>
                          <div style={{ textAlign: 'center' }}>Assigned</div>
                          <div style={{ textAlign: 'center' }}>Pending</div>
                          <div style={{ textAlign: 'center' }}>Missed</div>
                          <div style={{ textAlign: 'center' }}>Completed</div>
                        </div>
                        
                        {/* Table Rows */}
                        {(() => {
                          const members = groupMembers.length > 0 ? groupMembers : groupData?.members || [];
                          const tasks = allGroupTasks || [];
                          
                          return members.map((member, idx) => {
                            // Find all tasks for this member
                            const memberTaskData = tasks.find(t => t.student_id === member.student_id || t.student_id === member.id);
                            const memberTasks = memberTaskData?.tasks || [];
                            
                            // Calculate statistics
                            const totalAssigned = memberTasks.length;
                            
                            // Helper function to determine actual task status from submissions
                            const getActualTaskStatus = (task) => {
                              // Collect ALL submissions across all tables with their timestamps
                              const allSubmissions = [];
                              
                              // 1. Add task_submissions
                              if (task.task_submissions && task.task_submissions.length > 0) {
                                task.task_submissions.forEach(sub => {
                                  allSubmissions.push({
                                    status: sub.status,
                                    submitted_at: sub.submitted_at || sub.created_at,
                                    attempt_number: sub.attempt_number || 0,
                                    type: 'task_submission',
                                    revision_submissions: sub.revision_submissions || []
                                  });
                                });
                              }
                              
                              // If no submissions at all, return pending/task status
                              if (allSubmissions.length === 0) {
                                return task.status || 'pending';
                              }
                              
                              // Sort by attempt_number DESC, then by submitted_at DESC to get the LATEST attempt
                              allSubmissions.sort((a, b) => {
                                // First sort by attempt number (descending)
                                if (a.attempt_number !== b.attempt_number) {
                                  return b.attempt_number - a.attempt_number;
                                }
                                // If same attempt, sort by date (most recent first)
                                const dateA = new Date(a.submitted_at);
                                const dateB = new Date(b.submitted_at);
                                return dateB - dateA;
                              });
                              
                              const latestSubmission = allSubmissions[0];
                              
                              // 2. Check for revision_submissions in the latest attempt
                              if (latestSubmission.revision_submissions && latestSubmission.revision_submissions.length > 0) {
                                // Sort revisions by created_at to get the latest one
                                const sortedRevisions = [...latestSubmission.revision_submissions].sort((a, b) => {
                                  return new Date(b.created_at) - new Date(a.created_at);
                                });
                                const latestRevision = sortedRevisions[0];
                                
                                // If the latest revision is approved, consider the task approved
                                if (latestRevision.status === 'approved') {
                                  return 'approved';
                                }
                                // If the latest revision is rejected, check the main submission status
                                if (latestRevision.status === 'rejected') {
                                  return latestSubmission.status || 'pending';
                                }
                              }
                              
                              // Return the status of the latest attempt
                              return latestSubmission.status || task.status || 'pending';
                            };
                            
                            // Completed: tasks with actual status 'completed' or 'approved'
                            const completed = memberTasks.filter(t => {
                              const actualStatus = getActualTaskStatus(t);
                              return actualStatus === 'completed' || actualStatus === 'approved';
                            }).length;
                            
                            // Missed: overdue tasks that are NOT completed (past due date and no successful submission)
                            const missed = memberTasks.filter(t => {
                              const actualStatus = getActualTaskStatus(t);
                              if (actualStatus === 'completed' || actualStatus === 'approved') return false;
                              if (!t.due_date) return false;
                              const dueDate = new Date(t.due_date);
                              const now = new Date();
                              return dueDate < now;
                            }).length;
                            
                            // Pending: tasks that are not completed and not missed (still within due date or no due date set)
                            const pending = totalAssigned - completed - missed;
                            
                            return (
                              <div
                                key={member.id || idx}
                                style={{
                                  display: 'grid',
                                  gridTemplateColumns: '250px repeat(4, 1fr)',
                                  borderBottom: idx < members.length - 1 ? '1px solid #E5E7EB' : 'none',
                                  padding: '16px',
                                  alignItems: 'center',
                                  transition: 'background-color 0.2s',
                                  cursor: 'default'
                                }}
                                onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                                onMouseOut={(e) => e.currentTarget.style.backgroundColor = 'white'}
                              >
                                {/* Member Info */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '12px'
                                }}>
                                  {/* Profile Picture */}
                                  <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    overflow: 'hidden',
                                    backgroundColor: '#E5E7EB',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    flexShrink: 0
                                  }}>
                                    {member.profile_image_url ? (
                                      <img
                                        src={member.profile_image_url}
                                        alt={member.name || member.full_name}
                                        style={{
                                          width: '100%',
                                          height: '100%',
                                          objectFit: 'cover'
                                        }}
                                        onError={(e) => {
                                          e.target.style.display = 'none';
                                          e.target.parentElement.innerHTML = `<div style="font-size: 16px; font-weight: 600; color: #6B7280;">${(member.name || member.full_name || 'M').charAt(0).toUpperCase()}</div>`;
                                        }}
                                      />
                                    ) : (
                                      <div style={{
                                        fontSize: '16px',
                                        fontWeight: '600',
                                        color: '#6B7280'
                                      }}>
                                        {(member.name || member.full_name || 'M').charAt(0).toUpperCase()}
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Name and Role */}
                                  <div>
                                    <div style={{
                                      fontSize: '14px',
                                      fontWeight: '600',
                                      color: '#374151',
                                      marginBottom: '2px'
                                    }}>
                                      {member.name || member.full_name}
                                    </div>
                                    {member.role === 'leader' && (
                                      <div style={{
                                        fontSize: '11px',
                                        color: '#1E40AF',
                                        backgroundColor: '#DBEAFE',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        display: 'inline-block',
                                        fontWeight: '600'
                                      }}>
                                        Leader
                                      </div>
                                    )}
                                  </div>
                                </div>
                                
                                {/* Assigned */}
                                <div style={{
                                  textAlign: 'center',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  color: '#374151'
                                }}>
                                  {totalAssigned}
                                </div>
                                
                                {/* Pending */}
                                <div style={{
                                  textAlign: 'center',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  color: '#F59E0B'
                                }}>
                                  {pending}
                                </div>
                                
                                {/* Missed */}
                                <div style={{
                                  textAlign: 'center',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  color: '#EF4444'
                                }}>
                                  {missed}
                                </div>
                                
                                {/* Completed */}
                                <div style={{
                                  textAlign: 'center',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  color: '#10B981'
                                }}>
                                  {completed}
                                </div>
                              </div>
                            );
                          });
                        })()}
                        
                        {/* Empty State */}
                        {(() => {
                          const members = groupMembers.length > 0 ? groupMembers : groupData?.members || [];
                          if (members.length === 0) {
                            return (
                              <div style={{
                                padding: '40px 20px',
                                textAlign: 'center',
                                color: '#9CA3AF',
                                fontSize: '14px'
                              }}>
                                No team members found
                              </div>
                            );
                          }
                          return null;
                        })()}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '40px 20px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '300px'
                  }}>
                    <p style={{
                      color: '#9CA3AF',
                      fontSize: '14px',
                      fontStyle: 'italic',
                      textAlign: 'center'
                    }}>
                      Select a project to view its report
                    </p>
                  </div>
                )}
                </div>
              </>
            )}

            {/* Old Submissions Tab - Deprecated */}
            {activeGroupTab === 'submissions' && (
              <div style={{
                backgroundColor: '#F8F3D9',
                border: '1px solid #B9B28A',
                borderRadius: '12px',
                padding: '20px',
                minHeight: '400px'
              }}>
                <h2 style={{
                  color: '#504B38',
                  fontSize: '24px',
                  fontWeight: '600',
                  margin: '0 0 20px 0',
                  textAlign: 'left'
                }}>
                  Submissions & Feedback
                </h2>
                
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                  gap: '20px'
                }}>
                  {/* Recent Submissions */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Recent Submissions
                    </h3>
                    <p style={{ color: '#6B7280', fontSize: '14px', margin: '0' }}>
                      No recent submissions found
                    </p>
                  </div>

                  {/* Recent Feedback */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Recent Feedback
                    </h3>
                    <p style={{ color: '#6B7280', fontSize: '14px', margin: '0' }}>
                      No recent feedback received
                    </p>
                  </div>

                  {/* Action Buttons */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Quick Actions
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      <button style={{
                        padding: '10px 16px',
                        backgroundColor: '#34656c',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer'
                      }}>
                        Leave Feedback
                      </button>
                      <button style={{
                        padding: '10px 16px',
                        backgroundColor: '#F3F4F6',
                        color: '#374151',
                        border: '1px solid #D1D5DB',
                        borderRadius: '6px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer'
                      }}>
                        Check Assigned Tasks
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Group Analytics Tab */}
            {activeGroupTab === 'analytics' && (
              <div style={{
                backgroundColor: '#F8F3D9',
                border: '1px solid #B9B28A',
                borderRadius: '12px',
                padding: '20px',
                minHeight: '400px'
              }}>
                <h2 style={{
                  color: '#504B38',
                  fontSize: '24px',
                  fontWeight: '600',
                  margin: '0 0 20px 0',
                  textAlign: 'left'
                }}>
                  Group Analytics
                </h2>
                
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                  gap: '20px'
                }}>
                  {/* Performance Metrics */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Performance Metrics
                    </h3>
                    <div style={{ fontSize: '14px', color: '#6B7280' }}>
                      <p style={{ margin: '5px 0' }}>‚Ä¢ Task Completion Rate: 0%</p>
                      <p style={{ margin: '5px 0' }}>‚Ä¢ Average Grade: N/A</p>
                      <p style={{ margin: '5px 0' }}>‚Ä¢ On-time Submissions: 0</p>
                    </div>
                  </div>

                  {/* Activity Timeline */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Activity Timeline
                    </h3>
                    <p style={{ color: '#6B7280', fontSize: '14px', margin: '0' }}>
                      No recent activity to display
                    </p>
                  </div>

                  {/* Member Contributions */}
                  <div style={{
                    backgroundColor: 'white',
                    border: '1px solid #B9B28A',
                    borderRadius: '8px',
                    padding: '20px'
                  }}>
                    <h3 style={{ color: '#504B38', fontSize: '18px', margin: '0 0 15px 0' }}>
                      Member Contributions
                    </h3>
                    <p style={{ color: '#6B7280', fontSize: '14px', margin: '0' }}>
                      Contribution data will be displayed here
                    </p>
                  </div>
                </div>
              </div>
            )}
                  </div>
    );
  };


  // Render functions for other tabs (only the missing ones)
  const renderAnnouncements = () => {
    const selectedAnnouncement = expandedAnnouncement 
      ? filteredAnnouncements.find(a => a.id === expandedAnnouncement) 
      : filteredAnnouncements[0];

    return (
      <div className="announcements-content-redesigned" style={{display: 'flex', gap: '2rem', height: '100%', padding: '2rem'}}>
        {/* Left Card - Announcements List */}
        <div className="announcements-left-card my-group-card-with-crosshair" style={{
          flex: '0 0 35%',
          display: 'flex',
          flexDirection: 'column',
          backgroundColor: 'rgba(9, 18, 44, 0.15)',
          backdropFilter: 'blur(3.2px) saturate(120%)',
          borderRadius: '0px',
          boxShadow: '0 8px 32px rgba(52, 101, 109, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5)',
          overflow: 'hidden',
          border: '0.1px solid rgb(95, 95, 95)',
          position: 'relative'
        }}>
          {/* Crosshair Corners */}
          <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>

          {/* Filter Buttons Header - Styled like Notifications */}
          <div style={{
            display: 'flex',
            backgroundColor: 'rgb(255, 255, 255)',
            gap: '12px',
            padding: '16px',
            borderBottom: '2px solid rgb(135, 35, 65)',
            flexWrap: 'wrap',
            alignItems: 'center'
          }}>
            {[
              { key: 'all', label: 'All', icon: FaEnvelope },
              { key: 'general', label: 'General', icon: FaBullhorn },
              { key: 'project', label: 'Project', icon: FaProjectDiagram },
              { key: 'urgent', label: 'Urgent', icon: FaExclamationTriangle },
              { key: 'info', label: 'Information', icon: FaInfoCircle }
            ].map(filter => {
              const count = filter.key === 'all' 
                ? announcements.length 
                : announcements.filter(a => a.type === filter.key).length;
              const IconComponent = filter.icon;
              
              return (
                <button
                  key={filter.key}
                  title={`Show ${filter.label.toLowerCase()} announcements`}
                  onClick={() => {
                    setAnnouncementFilter(filter.key);
                    setExpandedAnnouncement(null);
                  }}
                  style={{
                    padding: '10px 18px',
                    backgroundColor: announcementFilter === filter.key ? '#872341' : '#f5f5f5',
                    color: '#872341',
                    border: '2px solid #872341',
                    borderRadius: '8px',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: '0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    boxShadow: announcementFilter === filter.key ? 'rgba(135, 35, 65, 0.3) 0px 2px 8px' : 'none',
                    opacity: 1,
                    transform: 'translateY(0px)'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.opacity = '0.9';
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.opacity = '1';
                    e.currentTarget.style.transform = 'translateY(0px)';
                  }}
                >
                  <IconComponent 
                    size={13} 
                    color={announcementFilter === filter.key ? '#ffffff' : '#872341'}
                  />
                  <span style={{color: announcementFilter === filter.key ? '#ffffff' : '#872341'}}>
                    {filter.label}
                  </span>
                </button>
              );
            })}
          </div>

          {/* Search Box */}
          <div style={{padding: '1rem 1.5rem', borderBottom: '1px solid rgb(95, 95, 95)'}}>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', backgroundColor: 'rgba(135, 35, 65, 0.05)', padding: '0.75rem 1rem', borderRadius: '0px', backdropFilter: 'blur(3.2px) saturate(120%)', WebkitBackdropFilter: 'blur(3.2px) saturate(120%)', border: '0.1px solid rgb(95, 95, 95)'}}>
              <FaSearch style={{color: '#b0b0b0', fontSize: '0.875rem'}} />
              <input
                type="text"
                placeholder="Search announcements..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                style={{
                  flex: 1,
                  border: 'none',
                  backgroundColor: 'transparent',
                  outline: 'none',
                  fontSize: '0.875rem',
                  color: '#d0d0d0'
                }}
              />
            </div>
          </div>

          {/* Announcements List */}
          <div style={{
            flex: 1,
            overflowY: 'auto',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {filteredAnnouncements.length > 0 ? (
              filteredAnnouncements.map(announcement => {
                const isNew = isAnnouncementNew(announcement.created_at);
                const isSelected = selectedAnnouncement?.id === announcement.id;
                
                return (
                  <div 
                    key={announcement.id} 
                    onClick={() => setExpandedAnnouncement(announcement.id)}
                    style={{
                      padding: '1rem 1.5rem',
                      borderBottom: '1px solid rgb(95, 95, 95)',
                      cursor: 'pointer',
                      backgroundColor: isSelected ? 'rgba(190, 49, 68, 0.15)' : 'transparent',
                      borderLeft: isSelected ? '4px solid #BE3144' : '4px solid transparent',
                      transition: 'all 0.3s ease'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isSelected ? 'rgba(190, 49, 68, 0.15)' : 'rgba(190, 49, 68, 0.08)'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = isSelected ? 'rgba(190, 49, 68, 0.15)' : 'transparent'}
                  >
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem'}}>
                      <h4 style={{fontSize: '0.9rem', fontWeight: '600', color: '#ffffff', margin: 0}}>{announcement.title}</h4>
                      {isNew && <span style={{
                        fontSize: '0.65rem',
                        fontWeight: '700',
                        backgroundColor: 'rgba(225, 117, 100, 0.25)',
                        color: '#E17564',
                        padding: '0.25rem 0.5rem',
                        borderRadius: '0px',
                        border: '0.1px solid rgb(95, 95, 95)'
                      }}>NEW</span>}
                    </div>
                    <div style={{display: 'flex', gap: '0.75rem', marginBottom: '0.5rem', alignItems: 'center'}}>
                      <span style={{
                        fontSize: '0.75rem',
                        fontWeight: '600',
                        backgroundColor: announcement.type === 'urgent' ? 'rgba(225, 117, 100, 0.15)' : 
                                        announcement.type === 'important' ? 'rgba(190, 49, 68, 0.15)' :
                                        announcement.type === 'project' ? 'rgba(135, 35, 65, 0.15)' : 'rgba(225, 117, 100, 0.08)',
                        color: announcement.type === 'urgent' ? '#E17564' : 
                               announcement.type === 'important' ? '#BE3144' :
                               announcement.type === 'project' ? '#872341' : '#E17564',
                        padding: '0.25rem 0.75rem',
                        borderRadius: '0px',
                        textTransform: 'capitalize',
                        backdropFilter: 'blur(3.2px) saturate(120%)',
                        border: '0.1px solid rgb(95, 95, 95)'
                      }}>
                        {announcement.type}
                      </span>
                      <span style={{fontSize: '0.75rem', color: '#b0b0b0', opacity: 0.8}}>{formatDateTime(announcement.created_at)}</span>
                    </div>
                    <p style={{
                      fontSize: '0.8rem',
                      color: '#d0d0d0',
                      margin: 0,
                      lineHeight: '1.4',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      display: '-webkit-box',
                      WebkitLineClamp: 2,
                      WebkitBoxOrient: 'vertical',
                      opacity: 0.85
                    }}>
                      {announcement.content.replace(/<[^>]*>/g, '')}
                    </p>
                  </div>
                );
              })
            ) : (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '3rem 1.5rem',
                color: '#999999',
                textAlign: 'center',
                backgroundColor: '#ffffff'
              }}>
                <FaBullhorn size={40} style={{marginBottom: '1rem', opacity: 0.3, color: '#999999'}} />
                <p style={{margin: 0, fontSize: '0.9rem', fontWeight: '500', color: '#333333'}}>No announcements found</p>
                {(searchQuery || announcementFilter !== 'all') && (
                  <button 
                    onClick={() => {
                      setSearchQuery('');
                      setAnnouncementFilter('all');
                    }}
                    style={{
                      padding: '10px 20px',
                      background: '#872341',
                      border: '2px solid #872341',
                      borderRadius: '8px',
                      color: '#ffffff',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      transition: 'all 0.3s ease',
                      marginTop: '1rem'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.transform = 'translateY(-2px)';
                      e.currentTarget.style.opacity = '0.9';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.transform = 'translateY(0)';
                      e.currentTarget.style.opacity = '1';
                    }}
                  >
                    Clear Filters
                  </button>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Right Card - Announcement Details */}
        <div className="my-group-card-with-crosshair" style={{
          flex: '1',
          display: 'flex',
          flexDirection: 'column',
          backgroundColor: 'rgba(9, 18, 44, 0.15)',
          backdropFilter: 'blur(3.2px) saturate(120%)',
          borderRadius: '0px',
          boxShadow: '0 8px 32px rgba(52, 101, 109, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5)',
          overflow: 'hidden',
          border: '0.1px solid rgb(95, 95, 95)',
          position: 'relative'
        }}
        >
          {/* Crosshair Corners */}
          <div className="crosshair-corner top-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner top-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner bottom-left"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>
          <div className="crosshair-corner bottom-right"><div className="crosshair-h"></div><div className="crosshair-v"></div></div>

          {selectedAnnouncement ? (
            <>
              {/* Header Section */}
              <div style={{
                padding: '2rem 2rem 1.5rem 2rem',
                borderBottom: '2px solid #872341',
                background: '#ffffff',
                backdropFilter: 'blur(3.2px) saturate(120%)',
                WebkitBackdropFilter: 'blur(3.2px) saturate(120%)'
              }}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem'}}>
                  <h2 style={{fontSize: '1.5rem', fontWeight: '700', color: '#333333', margin: 0}}>
                    {selectedAnnouncement.title}
                  </h2>
                  <span style={{
                    fontSize: '0.75rem',
                    fontWeight: '700',
                    backgroundColor: selectedAnnouncement.type === 'urgent' ? 'rgba(225, 117, 100, 0.2)' : 
                                    selectedAnnouncement.type === 'important' ? 'rgba(190, 49, 68, 0.2)' :
                                    selectedAnnouncement.type === 'project' ? 'rgba(135, 35, 65, 0.2)' : 'rgba(225, 117, 100, 0.15)',
                    color: selectedAnnouncement.type === 'urgent' ? '#E17564' : 
                           selectedAnnouncement.type === 'important' ? '#BE3144' :
                           selectedAnnouncement.type === 'project' ? '#872341' : '#E17564',
                    padding: '0.5rem 1rem',
                    borderRadius: '4px',
                    textTransform: 'capitalize',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                    border: 'none'
                  }}>
                    {selectedAnnouncement.type}
                  </span>
                </div>
                
                <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', color: '#666666'}}>
                    <FaUser size={16} />
                    <span style={{fontSize: '0.9rem'}}><strong>Posted by:</strong> {selectedAnnouncement.author || 'Professor'}</span>
                  </div>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', color: '#666666'}}>
                    <FaCalendarAlt size={16} />
                    <span style={{fontSize: '0.9rem'}}><strong>Date:</strong> {formatDateTime(selectedAnnouncement.created_at)}</span>
                  </div>
                </div>
              </div>

              {/* Content Section */}
              <div style={{
                flex: 1,
                overflowY: 'auto',
                padding: '2rem'
              }}>
                <div style={{
                  fontSize: '1rem',
                  lineHeight: '1.6',
                  color: '#d0d0d0'
                }} dangerouslySetInnerHTML={{ 
                  __html: selectedAnnouncement.content 
                }} />
              </div>

              {/* Actions Section */}
              <div style={{
                padding: '1.5rem 2rem',
                borderTop: '1px solid rgb(95, 95, 95)',
                background: 'rgba(135, 35, 65, 0.08)',
                backdropFilter: 'blur(3.2px) saturate(120%)',
                WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
                display: 'flex',
                gap: '1rem'
              }}>
                <button 
                  onClick={() => markAnnouncementAsRead(selectedAnnouncement.id)}
                  style={{
                    padding: '10px 20px',
                    background: 'rgba(255, 255, 255, 0.15)',
                    backdropFilter: 'blur(10px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(10px) saturate(120%)',
                    border: '1px solid rgba(255, 255, 255, 0.3)',
                    borderRadius: '8px',
                    color: '#ffffff',
                    fontSize: '14px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.5rem',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.25)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)';
                  }}
                >
                  <FaCheck /> Mark as Read
                </button>
                
                <button 
                  onClick={() => bookmarkAnnouncement(selectedAnnouncement.id)}
                  style={{
                    padding: '10px 20px',
                    background: 'rgba(255, 255, 255, 0.15)',
                    backdropFilter: 'blur(10px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(10px) saturate(120%)',
                    border: '1px solid rgba(255, 255, 255, 0.3)',
                    borderRadius: '8px',
                    color: '#ffffff',
                    fontSize: '14px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.5rem',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.25)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)';
                  }}
                >
                  <FaBookmark /> Save
                </button>
                
                <button 
                  onClick={() => shareAnnouncement(selectedAnnouncement)}
                  style={{
                    padding: '10px 20px',
                    background: 'rgba(255, 255, 255, 0.15)',
                    backdropFilter: 'blur(10px) saturate(120%)',
                    WebkitBackdropFilter: 'blur(10px) saturate(120%)',
                    border: '1px solid rgba(255, 255, 255, 0.3)',
                    borderRadius: '8px',
                    color: '#ffffff',
                    fontSize: '14px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.5rem',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.25)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)';
                  }}
                >
                  <FaShare /> Share
                </button>
              </div>
            </>
          ) : (
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              flex: 1,
              color: '#ffffff',
              textAlign: 'center',
              padding: '3rem',
              opacity: 0.8
            }}>
              {announcements.length === 0 ? (
                <>
                  <FaBullhorn size={80} style={{marginBottom: '1rem', opacity: 0.3, color: '#b0b0b0'}} />
                  <h3 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem', color: '#ffffff'}}>No Announcements Yet</h3>
                  <p style={{fontSize: '0.95rem', margin: 0, color: '#b0b0b0'}}>Your professors haven't posted any announcements yet.</p>
                </>
              ) : (
                <>
                  <FaArrowLeft size={80} style={{marginBottom: '1rem', opacity: 0.3, color: '#b0b0b0'}} />
                  <h3 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem', color: '#ffffff'}}>Select an Announcement</h3>
                  <p style={{fontSize: '0.95rem', margin: 0, color: '#b0b0b0'}}>Click on an announcement from the list to view its full details.</p>
                </>
              )}
            </div>
          )}
        </div>
      </div>
    );
  };

  // Helper functions for announcements
  function isAnnouncementNew(createdAt) {
    const now = new Date();
    const announcementDate = new Date(createdAt);
    const daysDiff = (now - announcementDate) / (1000 * 60 * 60 * 24);
    return daysDiff <= 3; // Consider "new" if posted within 3 days
  }

  function markAnnouncementAsRead(announcementId) {
    // You can implement this to track read status
    console.log('Marking announcement as read:', announcementId);
    // Could update local state or make API call
  }

  function bookmarkAnnouncement(announcementId) {
    // Implementation for bookmarking
    console.log('Bookmarking announcement:', announcementId);
  }

  function shareAnnouncement(announcement) {
    // Implementation for sharing
    if (navigator.share) {
      navigator.share({
        title: announcement.title,
        text: announcement.content.substring(0, 100) + '...',
        url: window.location.href
      });
    } else {
      // Fallback - copy to clipboard
      navigator.clipboard.writeText(
        `${announcement.title}\n\n${announcement.content}\n\nFrom: ${announcement.course_name}`
      );
      alert('Announcement copied to clipboard!');
    }
  }

// Notification helper functions (moved to component level)
const getUnreadCount = () => {
  return notifications.filter(n => !n.read).length;
};

const getNotificationFilterCount = (filterKey) => {
  if (filterKey === 'all') return notifications.length;
  return notifications.filter(n => n.type === filterKey).length;
};

const getNotificationIcon = (type) => {
  const icons = {
    task_assigned: <FaTasks className="notification-type-icon" />,
    feedback_received: <FaComments className="notification-type-icon" />,
    submission_approved: <FaCheckCircle className="notification-type-icon" />,
    submission_revision: <FaExclamationCircle className="notification-type-icon" />,
    grade_released: <FaGraduationCap className="notification-type-icon" />,
    deliverable_submitted: <FaFileAlt className="notification-type-icon" />,
    extension_approved: <FaCheckCircle className="notification-type-icon" />,
    extension_rejected: <FaTimesCircle className="notification-type-icon" />,
    // Legacy support
    task: <FaTasks className="notification-type-icon" />,
    feedback: <FaComments className="notification-type-icon" />,
    grade: <FaGraduationCap className="notification-type-icon" />,
    overdue: <FaClock className="notification-type-icon" />,
    system: <FaCog className="notification-type-icon" />,
    announcement: <FaBullhorn className="notification-type-icon" />
  };
  return icons[type] || <FaBell className="notification-type-icon" />;
};

const getNotificationTypeInfo = (type) => {
  const typeInfo = {
    task_assigned: { label: 'Task', color: '#1565C0', bg: '#E3F2FD', icon: FaTasks },
    feedback_received: { label: 'Feedback', color: '#6A1B9A', bg: '#F3E5F5', icon: FaComments },
    submission_approved: { label: 'Approved', color: '#2E7D32', bg: '#E8F5E9', icon: FaCheckCircle },
    submission_revision: { label: 'Revision', color: '#E65100', bg: '#FFF3E0', icon: FaExclamationCircle },
    grade_released: { label: 'Grade', color: '#2E7D32', bg: '#E8F5E9', icon: FaGraduationCap },
    deliverable_submitted: { label: 'Deliverable', color: '#1565C0', bg: '#E3F2FD', icon: FaFileAlt },
    extension_approved: { label: 'Extension', color: '#2E7D32', bg: '#E8F5E9', icon: FaCheckCircle },
    extension_rejected: { label: 'Extension', color: '#C62828', bg: '#FFEBEE', icon: FaTimesCircle },
    // Legacy support
    task: { label: 'Task', color: '#1565C0', bg: '#E3F2FD', icon: FaTasks },
    feedback: { label: 'Feedback', color: '#6A1B9A', bg: '#F3E5F5', icon: FaComments },
    grade: { label: 'Grade', color: '#2E7D32', bg: '#E8F5E9', icon: FaGraduationCap },
    system: { label: 'System', color: '#E65100', bg: '#FFF3E0', icon: FaCog }
  };
  return typeInfo[type] || { label: 'Other', color: '#424242', bg: '#F5F5F5', icon: FaBell };
};

const getRelativeTime = (dateString) => {
  const now = new Date();
  const notificationDate = new Date(dateString);
  const diffMs = now - notificationDate;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return formatDate(dateString);
};

const handleNotificationClick = async (notification) => {
  // Mark as read when clicked
  if (!notification.is_read) {
    await toggleNotificationRead(notification.id);
  }
  
  // Handle navigation based on notification type
  switch (notification.notification_type) {
    case 'task_assigned':
      setActiveTab('project-dashboard');
      break;
    case 'grade_released':
      setActiveTab('my-grades');
      break;
    case 'feedback_received':
    case 'submission_approved':
    case 'submission_revision':
      // Navigate to specific submission or task
      setActiveTab('project-dashboard');
      break;
    case 'extension_approved':
    case 'extension_rejected':
      setActiveTab('project-dashboard');
      break;
  }
};

const toggleNotificationRead = async (notificationId) => {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/notifications/${notificationId}/read`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      // Update local state
      setNotifications(prev => prev.map(n => 
        n.id === notificationId ? { ...n, is_read: true, read_at: new Date().toISOString() } : n
      ));
      // Update unread count
      setUnreadNotifications(prev => Math.max(0, prev - 1));
    }
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
};

const deleteNotification = async (notificationId, skipConfirm = false) => {
  if (skipConfirm || window.confirm('Are you sure you want to delete this notification?')) {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/notifications/${notificationId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        // Update local state
        const deletedNotif = notifications.find(n => n.id === notificationId);
        setNotifications(prev => prev.filter(n => n.id !== notificationId));
        
        // Update unread count if deleted notification was unread
        if (deletedNotif && !deletedNotif.is_read) {
          setUnreadNotifications(prev => Math.max(0, prev - 1));
        }
      }
    } catch (error) {
      console.error('Error deleting notification:', error);
    }
  }
};

const renderTaskNotificationDetails = (notification) => {
  return (
    <div className="task-notification-details">
      <div className="detail-row">
        <strong>Task:</strong> {notification.details?.taskTitle}
      </div>
      <div className="detail-row">
        <strong>Due Date:</strong> {formatDateTime(notification.details?.dueDate)}
      </div>
      <div className="detail-row">
        <strong>Project:</strong> {notification.details?.projectTitle}
      </div>
    </div>
  );
};

const renderFeedbackNotificationDetails = (notification) => {
  return (
    <div className="feedback-notification-details">
      <div className="detail-row">
        <strong>From:</strong> {notification.details?.reviewer}
      </div>
      <div className="detail-row">
        <strong>Task:</strong> {notification.details?.taskTitle}
      </div>
      <div className="detail-row">
        <strong>Feedback:</strong>
        <p className="feedback-preview">{notification.details?.feedback}</p>
      </div>
    </div>
  );
};

const renderGradeNotificationDetails = (notification) => {
  return (
    <div className="grade-notification-details">
      <div className="detail-row">
        <strong>Assignment:</strong> {notification.details?.assignmentName}
      </div>
      <div className="detail-row">
        <strong>Grade:</strong> 
        <span className="grade-display">{notification.details?.grade}%</span>
      </div>
      <div className="detail-row">
        <strong>Graded by:</strong> {notification.details?.gradedBy}
      </div>
    </div>
  );
};

const renderSystemNotificationDetails = (notification) => {
  return (
    <div className="system-notification-details">
      <div className="detail-row">
        <strong>System Message:</strong>
        <p>{notification.details?.systemMessage}</p>
      </div>
    </div>
  );
};

const navigateToTask = (taskId) => {
  setActiveTab('project-dashboard');
  // You can add logic to highlight or scroll to specific task
};

const viewFeedback = (submissionId) => {
  // Navigate to submission with feedback
  setActiveTab('project-dashboard');
};

const renderNotifications = () => {
  return (
    <div className="notifications">
      {/* Filter Buttons Header */}
      <div className="notification-filter-header" style={{
        display: 'flex',
        gap: '12px',
        padding: '16px',
        marginTop: '80px',
        backgroundColor: '#ffffff',
        borderBottom: '2px solid #872341',
        flexWrap: 'wrap',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        {/* Left Section: All/Unread Toggle */}
        <div style={{
          display: 'flex',
          gap: '12px',
          alignItems: 'center',
          flexWrap: 'wrap',
          marginRight: '16px'
        }}>
          {/* All Notifications Button */}
          <button
            onClick={() => setShowUnreadOnly(false)}
            title="Show all notifications"
            style={{
              padding: '10px 18px',
              backgroundColor: !showUnreadOnly ? '#872341' : '#f5f5f5',
              color: !showUnreadOnly ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: !showUnreadOnly ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaInbox size={13} />
            <span>All</span>
          </button>

          {/* Unread Only Button */}
          <button
            onClick={() => setShowUnreadOnly(true)}
            title="Show unread only"
            style={{
              padding: '10px 18px',
              backgroundColor: showUnreadOnly ? '#872341' : '#f5f5f5',
              color: showUnreadOnly ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: showUnreadOnly ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaEnvelope size={13} />
            <span>Unread</span>
          </button>
        </div>

        {/* Divider */}
        <div style={{
          width: '1px',
          height: '24px',
          backgroundColor: '#ddd',
          margin: '0 8px'
        }}></div>

        {/* Center Section: Type Filters - CENTERED */}
        <div style={{
          display: 'flex',
          gap: '12px',
          alignItems: 'center',
          justifyContent: 'center',
          flexWrap: 'nowrap'
        }}>
          {/* Tasks Filter */}
          <button
            onClick={() => setNotificationFilter('task')}
            title="Show task notifications"
            style={{
              padding: '10px 18px',
              backgroundColor: notificationFilter === 'task' ? '#872341' : '#f5f5f5',
              color: notificationFilter === 'task' ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: notificationFilter === 'task' ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none',
              whiteSpace: 'nowrap'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaTasks size={13} />
            <span>Tasks</span>
          </button>

          {/* Feedback Filter */}
          <button
            onClick={() => setNotificationFilter('feedback')}
            title="Show feedback notifications"
            style={{
              padding: '10px 18px',
              backgroundColor: notificationFilter === 'feedback' ? '#872341' : '#f5f5f5',
              color: notificationFilter === 'feedback' ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: notificationFilter === 'feedback' ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none',
              whiteSpace: 'nowrap'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaComments size={13} />
            <span>Feedback</span>
          </button>

          {/* Grades Filter */}
          <button
            onClick={() => setNotificationFilter('grade')}
            title="Show grade notifications"
            style={{
              padding: '10px 18px',
              backgroundColor: notificationFilter === 'grade' ? '#872341' : '#f5f5f5',
              color: notificationFilter === 'grade' ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: notificationFilter === 'grade' ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none',
              whiteSpace: 'nowrap'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaGraduationCap size={13} />
            <span>Grades</span>
          </button>

          {/* System Filter */}
          <button
            onClick={() => setNotificationFilter('system')}
            title="Show system notifications"
            style={{
              padding: '10px 18px',
              backgroundColor: notificationFilter === 'system' ? '#872341' : '#f5f5f5',
              color: notificationFilter === 'system' ? '#ffffff' : '#872341',
              border: `2px solid #872341`,
              borderRadius: '8px',
              fontSize: '13px',
              fontWeight: '600',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: notificationFilter === 'system' ? '0 2px 8px rgba(135, 35, 65, 0.3)' : 'none',
              whiteSpace: 'nowrap'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.opacity = '0.9';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.opacity = '1';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <FaCog size={13} />
            <span>System</span>
          </button>
        </div>

        {/* Divider */}
        <div style={{
          width: '1px',
          height: '24px',
          backgroundColor: '#ddd',
          margin: '0 8px'
        }}></div>

        {/* Right Section: Clear All Button */}
        <button
          onClick={() => setShowClearAllModal(true)}
          title="Delete all notifications"
          style={{
            padding: '10px 18px',
            backgroundColor: '#FFEBEE',
            color: '#C62828',
            border: '2px solid #C62828',
            borderRadius: '8px',
            fontSize: '13px',
            fontWeight: '600',
            cursor: 'pointer',
            transition: 'all 0.2s ease',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            boxShadow: '0 2px 4px rgba(198, 40, 40, 0.2)',
            whiteSpace: 'nowrap',
            marginLeft: '16px'
          }}
          onMouseOver={(e) => {
            e.currentTarget.style.opacity = '0.9';
            e.currentTarget.style.transform = 'translateY(-2px)';
            e.currentTarget.style.boxShadow = '0 4px 8px rgba(198, 40, 40, 0.3)';
          }}
          onMouseOut={(e) => {
            e.currentTarget.style.opacity = '1';
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = '0 2px 4px rgba(198, 40, 40, 0.2)';
          }}
        >
          <FaTrash size={13} />
          <span>Clear All</span>
        </button>
      </div>

      {/* Notifications List */}
      <div className="notifications-content" style={{marginTop: '0px'}}>

        {filteredNotifications.length > 0 ? (
          <div className="notifications-list">
            {filteredNotifications.map(notification => {
              const typeInfo = getNotificationTypeInfo(notification.notification_type || notification.type);
              const IconComponent = typeInfo.icon;
              
              return (
              <div 
                key={notification.id} 
                className={`notification-card ${notification.is_read ? 'read' : 'unread'} ${notification.notification_type || notification.type}`}
                onClick={() => handleNotificationClick(notification)}
              >
                <div className="notification-indicator">
                  {!notification.is_read && <div className="unread-dot"></div>}
                </div>

                <div className="notification-icon">
                  {getNotificationIcon(notification.notification_type || notification.type)}
                </div>

                <div className="notification-main">
                  <div className="notification-header">
                    <h4>{notification.title}</h4>
                    <div className="notification-meta">
                      {/* Type Badge */}
                      <span style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '6px',
                        padding: '4px 12px',
                        borderRadius: '12px',
                        fontSize: '11px',
                        fontWeight: '700',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        backgroundColor: typeInfo.bg,
                        color: typeInfo.color
                      }}>
                        <IconComponent size={10} />
                        <span>{typeInfo.label}</span>
                      </span>
                      <span className="notification-time">
                        {getRelativeTime(notification.created_at || notification.date)}
                      </span>
                    </div>
                  </div>

                  <div className="notification-content">
                    <p className="notification-message">{notification.message}</p>
                    
                    {notification.metadata && expandedNotification === notification.id && (
                      <div className="notification-details">
                        {/* Display metadata information if needed */}
                        {notification.metadata.task_title && (
                          <div className="detail-row">
                            <strong>Task:</strong> {notification.metadata.task_title}
                          </div>
                        )}
                        {notification.metadata.project_title && (
                          <div className="detail-row">
                            <strong>Project:</strong> {notification.metadata.project_title}
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  <div className="notification-actions" style={{marginTop: '12px'}}>
                    {!notification.is_read && (
                      <button 
                        className="action-btn secondary"
                        onClick={(e) => {
                          e.stopPropagation();
                          toggleNotificationRead(notification.id);
                        }}
                        style={{fontSize: '12px', padding: '6px 12px'}}
                      >
                        <FaCheckCircle />
                        <span>Mark as Read</span>
                      </button>
                    )}
                    <button 
                      className="action-btn danger"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteNotification(notification.id);
                      }}
                      style={{fontSize: '12px', padding: '6px 12px'}}
                    >
                      <FaTrash />
                      <span>Delete</span>
                    </button>
                  </div>
                </div>
              </div>
            );
            })}
          </div>
        ) : (
          <div className="no-notifications">
            {notifications.length === 0 ? (
              <>
                <FaBell size={48} style={{ color: '#cbd5e0', marginBottom: '1rem' }} />
                <h3>No Notifications</h3>
                <p>You're all caught up! No notifications to show.</p>
                <small style={{ color: '#a0aec0', fontStyle: 'italic' }}>
                  You'll receive notifications here for task updates, feedback, grades, and other important information.
                </small>
              </>
            ) : (
              <>
                <FaFilter size={48} style={{ color: '#cbd5e0', marginBottom: '1rem' }} />
                <h3>No Matching Notifications</h3>
                <p>No notifications match your current filters.</p>
                <button 
                  className="clear-filters-btn"
                  onClick={() => {
                    setNotificationFilter('all');
                    setShowUnreadOnly(false);
                  }}
                >
                  Clear Filters
                </button>
              </>
            )}
          </div>
        )}
      </div>

      {/* Clear All Confirmation Modal */}
      {showClearAllModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 2000
        }}>
          <div style={{
            backgroundColor: '#ffffff',
            borderRadius: '12px',
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
            maxWidth: '450px',
            width: '90%',
            overflow: 'hidden'
          }}>
            {/* Modal Header - Plain */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #f0f0f0'
            }}>
              <h2 style={{
                margin: 0,
                color: '#212121',
                fontSize: '18px',
                fontWeight: '600'
              }}>
                Clear All Notifications
              </h2>
            </div>

            {/* Modal Body */}
            <div style={{
              padding: '24px',
              textAlign: 'center'
            }}>
              <p style={{
                color: '#424242',
                fontSize: '14px',
                lineHeight: '1.6',
                marginBottom: '16px',
                margin: '0 0 16px 0'
              }}>
                Are you sure you want to delete all notifications? This action cannot be undone.
              </p>
              <p style={{
                color: '#757575',
                fontSize: '13px',
                fontWeight: '500',
                marginBottom: 0,
                margin: 0
              }}>
                {notifications.length} notification{notifications.length !== 1 ? 's' : ''} will be permanently deleted.
              </p>
            </div>

            {/* Modal Footer */}
            <div style={{
              display: 'flex',
              gap: '12px',
              padding: '16px 24px',
              borderTop: '1px solid #f0f0f0',
              justifyContent: 'flex-end'
            }}>
              {/* Cancel Button */}
              <button
                onClick={() => setShowClearAllModal(false)}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#f5f5f5',
                  color: '#424242',
                  border: '2px solid #bdbdbd',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#eeeeee';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = '#f5f5f5';
                }}
              >
                Cancel
              </button>

              {/* Confirm Button */}
              <button
                onClick={async () => {
                  try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/notifications/clear-all', {
                      method: 'DELETE',
                      headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                      setNotifications([]);
                      setUnreadNotifications(0);
                    }
                  } catch (error) {
                    console.error('Error clearing all notifications:', error);
                  }
                  setShowClearAllModal(false);
                }}
                style={{
                  padding: '10px 24px',
                  backgroundColor: '#872341',
                  color: '#ffffff',
                  border: '2px solid #872341',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#6B1A32';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(135, 35, 65, 0.3)';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = '#872341';
                  e.currentTarget.style.boxShadow = 'none';
                }}
              >
                Yes, Delete All
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
const renderEvaluations = () => {
  // Backend now returns filtered data directly based on query params
  const filteredEvaluations = evaluationsData || [];

  return (
    <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: '24px', flex: 1, overflow: 'auto', padding: '24px' }}>
      {evaluationsLoading ? (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '400px',
          flex: 1,
          width: '100%'
        }}>
          <div className="my-group-card-with-crosshair" style={{
            background: 'rgba(9, 18, 44, 0.15)',
            backdropFilter: 'blur(3.2px) saturate(120%)',
            WebkitBackdropFilter: 'blur(3.2px) saturate(120%)',
            border: '0.1px solid #5f5f5f',
            borderRadius: '0px',
            width: '500px',
            height: '150px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '12px',
            position: 'relative'
          }}>
            <div className="crosshair-corner top-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner top-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-left">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <div className="crosshair-corner bottom-right">
              <div className="crosshair-h"></div>
              <div className="crosshair-v"></div>
            </div>
            <FaSpinner style={{ 
              fontSize: '36px', 
              color: '#872341',
              animation: 'spin 1s linear infinite' 
            }} />
            <span style={{ 
              color: '#FAF8F1',
              fontSize: '14px',
              fontWeight: '500'
            }}>
              Loading evaluations...
            </span>
          </div>
        </div>
      ) : (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '24px', flex: 1, marginTop: '70px' }}>
          {/* Control Pill Section */}
          <div style={{
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '16px',
            marginBottom: '12px'
          }}>
            {/* Left Pill - Received Evaluations */}
            <button
              onClick={() => setEvaluationViewFilter('received')}
              style={{
                padding: '12px 28px',
                borderRadius: '20px',
                border: evaluationViewFilter === 'received' ? '2px solid #872341' : '2px solid #cbd5e0',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                backgroundColor: evaluationViewFilter === 'received' ? '#872341' : 'rgba(9, 18, 44, 0.6)',
                color: evaluationViewFilter === 'received' ? '#FFFFFF' : '#cbd5e0',
                transition: 'all 0.3s ease',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                position: 'relative',
                backdropFilter: 'blur(3.2px) saturate(120%)',
                WebkitBackdropFilter: 'blur(3.2px) saturate(120%)'
              }}
            >
              <FaComments /> Received
            </button>

            {/* Right Pill - Given Evaluations */}
            <button
              onClick={() => setEvaluationViewFilter('given')}
              style={{
                padding: '12px 28px',
                borderRadius: '20px',
                border: evaluationViewFilter === 'given' ? '2px solid #872341' : '2px solid #cbd5e0',
                fontSize: '14px',
                fontWeight: '600',
                cursor: 'pointer',
                backgroundColor: evaluationViewFilter === 'given' ? '#872341' : 'rgba(9, 18, 44, 0.6)',
                color: evaluationViewFilter === 'given' ? '#FFFFFF' : '#cbd5e0',
                transition: 'all 0.3s ease',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                position: 'relative',
                backdropFilter: 'blur(3.2px) saturate(120%)',
                WebkitBackdropFilter: 'blur(3.2px) saturate(120%)'
              }}
            >
              <FaClipboardList /> Given
            </button>
          </div>

          {/* Evaluations Cards Section */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
            gap: '16px',
            flex: 1
          }}>
            {filteredEvaluations.length > 0 ? (
              filteredEvaluations.map((evaluation, index) => {
                // Calculate average score for received evaluations
                let displayScore = 0;
                let isCustomFile = false;
                if (evaluationViewFilter === 'received') {
                  // For received, use the score from this evaluation
                  // If it's a custom file evaluation, show "CUSTOM FILE"
                  if (evaluation.scores?.total === 'CUSTOM FILE') {
                    displayScore = 'CUSTOM FILE';
                    isCustomFile = true;
                  } else {
                    displayScore = evaluation.scores?.total || 0;
                  }
                } else {
                  // For given, show average of all members
                  if (evaluation.evaluatedMembers && evaluation.evaluatedMembers.length > 0) {
                    const sum = evaluation.evaluatedMembers.reduce((acc, member) => acc + (member.total || 0), 0);
                    displayScore = (sum / evaluation.evaluatedMembers.length).toFixed(1);
                  }
                }

                return (
                <div
                  key={`eval-${index}`}
                  onClick={() => {
                    setSelectedEvaluationDetail({ ...evaluation, evaluationViewFilter });
                    setShowEvaluationDetailModal(true);
                  }}
                  style={{
                    display: 'flex',
                    height: '230px',
                    borderRadius: '0px',
                    overflow: 'hidden',
                    background: 'rgba(9, 18, 44, 0.15)',
                    backdropFilter: 'blur(3.2px) saturate(120%)',
                    border: '0.1px solid #5f5f5f',
                    transition: 'all 0.3s ease',
                    cursor: 'pointer'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = 'rgba(9, 18, 44, 0.25)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(135, 35, 65, 0.2)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = 'rgba(9, 18, 44, 0.15)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  {/* Left Section - Grade (Only for Received) */}
                  {evaluationViewFilter === 'received' && (
                  <div
                    style={{
                      flex: '0 0 150px',
                      padding: '24px',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      borderRight: '1px solid rgba(95, 95, 95, 0.3)',
                      backgroundColor: 'rgba(135, 35, 65, 0.1)'
                    }}
                  >
                    <div style={{ fontSize: isCustomFile ? '16px' : '28px', fontWeight: '700', color: '#872341', marginBottom: '8px', textAlign: 'center' }}>
                      {displayScore || 'N/A'}
                    </div>
                    <div style={{ fontSize: '12px', color: '#cbd5e0', textAlign: 'center' }}>
                      {isCustomFile ? 'Evaluation' : 'Score'}
                    </div>
                  </div>
                  )}

                  {/* Right Section - Information */}
                  <div
                    style={{
                      flex: 1,
                      padding: evaluationViewFilter === 'received' ? '24px' : '24px',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'space-between',
                      overflow: 'auto',
                      maxHeight: '200px'
                    }}
                  >
                    <div>
                      <h4 style={{ margin: '0 0 12px 0', color: '#FAF8F1', fontSize: '16px', fontWeight: '600' }}>
                        {evaluation.type === 'phase' 
                          ? `Phase ${evaluation.phaseNumber}: ${evaluation.phaseName}`
                          : `Project: ${evaluation.projectTitle}`
                        }
                      </h4>
                      <p style={{ margin: '0 0 8px 0', color: '#cbd5e0', fontSize: '13px' }}>
                        <strong>Project:</strong> {evaluation.projectTitle}
                      </p>
                      <p style={{ margin: '0 0 8px 0', color: '#cbd5e0', fontSize: '13px' }}>
                        <strong>Group:</strong> {evaluation.groupName}
                      </p>
                      <p style={{ margin: '0', color: '#cbd5e0', fontSize: '12px' }}>
                        <strong>Submitted:</strong> {new Date(evaluation.submissionDate || evaluation.createdAt).toLocaleDateString()} {new Date(evaluation.submissionDate || evaluation.createdAt).toLocaleTimeString()}
                      </p>
                    </div>

                    <details style={{ cursor: 'pointer', marginTop: '12px' }}>
                      <summary style={{ color: '#872341', fontWeight: '600', fontSize: '12px', cursor: 'pointer' }}>
                        View Details
                      </summary>
                      <div style={{ marginTop: '12px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {evaluation.scores?.criteria && Object.entries(evaluation.scores.criteria).map(([criterion, score], idx) => (
                          <div key={idx} style={{ fontSize: '11px', color: '#cbd5e0' }}>
                            <strong style={{ color: '#FAF8F1' }}>{criterion}</strong>
                            <p style={{ margin: '4px 0 0 0', color: '#cbd5e0' }}>
                              {typeof score === 'number' ? `${score}/5` : String(score)}
                            </p>
                          </div>
                        ))}
                        {evaluation.scores?.feedback && (
                          <div style={{ fontSize: '11px', color: '#cbd5e0', marginTop: '8px' }}>
                            <strong style={{ color: '#FAF8F1' }}>Feedback</strong>
                            <p style={{ margin: '4px 0 0 0', color: '#cbd5e0' }}>
                              {evaluation.scores.feedback}
                            </p>
                          </div>
                        )}
                        {evaluation.scores?.strengths && (
                          <div style={{ fontSize: '11px', color: '#cbd5e0' }}>
                            <strong style={{ color: '#FAF8F1' }}>Strengths</strong>
                            <p style={{ margin: '4px 0 0 0', color: '#cbd5e0' }}>
                              {evaluation.scores.strengths}
                            </p>
                          </div>
                        )}
                        {evaluation.scores?.improvements && (
                          <div style={{ fontSize: '11px', color: '#cbd5e0' }}>
                            <strong style={{ color: '#FAF8F1' }}>Areas for Improvement</strong>
                            <p style={{ margin: '4px 0 0 0', color: '#cbd5e0' }}>
                              {evaluation.scores.improvements}
                            </p>
                          </div>
                        )}
                        {evaluationViewFilter === 'given' && evaluation.isCustomEvaluation && (
                          <div style={{ marginTop: '8px' }}>
                            <strong style={{ color: '#FAF8F1', fontSize: '11px' }}>
                              üìÑ Custom Evaluation (File Submission)
                            </strong>
                          </div>
                        )}
                        {evaluationViewFilter === 'given' && evaluation.evaluatedMembers && evaluation.evaluatedMembers.length > 0 && (
                          <div style={{ marginTop: '8px' }}>
                            <strong style={{ color: '#FAF8F1', fontSize: '11px' }}>
                              Evaluated Members: {evaluation.evaluatedMembers.length}
                            </strong>
                          </div>
                        )}
                      </div>
                    </details>
                  </div>
                </div>
                );
              })
            ) : (
              <div style={{
                gridColumn: '1 / -1',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '60px 24px',
                textAlign: 'center'
              }}>
                <FaClipboardList size={48} style={{ color: '#cbd5e0', marginBottom: '1rem' }} />
                <h3 style={{ color: '#FAF8F1', marginBottom: '8px' }}>
                  No {evaluationViewFilter === 'received' ? 'Received' : 'Given'} Evaluations
                </h3>
                <p style={{ color: '#cbd5e0', fontSize: '14px' }}>
                  {evaluationViewFilter === 'received' 
                    ? "You haven't received any evaluations for this project yet."
                    : "You haven't submitted any evaluations for this project yet."
                  }
                </p>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// Phase Modal Component
const PhaseModal = ({ isOpen, onClose, phase }) => {
  const [isPhaseModalLoading, setIsPhaseModalLoading] = useState(false);
  
  useEffect(() => {
    if (isOpen && phase) {
      setIsPhaseModalLoading(true);
      // Simulate loading time for phase data
      setTimeout(() => {
        setIsPhaseModalLoading(false);
      }, 300);
    }
  }, [isOpen, phase]);
  
  if (!isOpen || !phase) return null;
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="phase-modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative' }}>
        {/* Loading Overlay */}
        {isPhaseModalLoading && (
          <ModalLoadingOverlay isVisible={true} />
        )}
        <div className="phase-modal-header">
          <div className="phase-modal-title">
            <h2>Phase {phase.phase_number}: {phase.title}</h2>
            <div className="phase-modal-subtitle">
              <span className={`phase-status-badge ${getPhaseStatus(phase)}`}>
                {getPhaseStatus(phase) === 'active' ? 'Active' : 
                 getPhaseStatus(phase) === 'completed' ? 'Completed' : 
                 getPhaseStatus(phase) === 'upcoming' ? 'Upcoming' : 'Pending'}
              </span>
            </div>
          </div>
          <button 
            className="modal-close"
            onClick={onClose}
          >
            <FaTimes />
          </button>
        </div>
        
        <div className="phase-modal-body">
          {/* Phase Information Section */}
          <div className="phase-info-section">
            <h3>Phase Information</h3>
            <div className="phase-info-grid">
              <div className="info-item">
                <label>Start Date:</label>
                <span>{phase.start_date ? new Date(phase.start_date).toLocaleDateString() : 'Not set'}</span>
              </div>
              <div className="info-item">
                <label>End Date:</label>
                <span>{phase.end_date ? new Date(phase.end_date).toLocaleDateString() : 'Not set'}</span>
              </div>
              <div className="info-item">
                <label>Duration:</label>
                <span>
                  {phase.start_date && phase.end_date ? 
                    Math.ceil((new Date(phase.end_date) - new Date(phase.start_date)) / (1000 * 60 * 60 * 24)) + ' days' : 
                    'Not specified'}
                </span>
              </div>
              <div className="info-item">
                <label>Status:</label>
                <span className={`phase-status ${getPhaseStatus(phase)}`}>
                  {getPhaseStatus(phase) === 'active' ? 'Active' : 
                   getPhaseStatus(phase) === 'completed' ? 'Completed' : 
                   getPhaseStatus(phase) === 'upcoming' ? 'Upcoming' : 'Pending'}
                </span>
              </div>
            </div>
          </div>

          {/* Phase Timeline with Breathe & Evaluation Phases */}
          <div className="phase-timeline-section" style={{
            padding: '20px',
            backgroundColor: '#F9FAFB',
            borderRadius: '12px',
            marginBottom: '20px',
            border: '1px solid #E5E7EB'
          }}>
            <h3 style={{ marginTop: 0, marginBottom: '16px' }}>Phase Timeline</h3>
            
            {/* Main Timeline Visualization */}
            <div style={{
              display: 'flex',
              gap: '8px',
              alignItems: 'flex-end',
              marginBottom: '20px',
              flexWrap: 'wrap'
            }}>
              {/* Phase Work Period */}
              <div style={{
                flex: 1,
                minWidth: '120px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center'
              }}>
                <div style={{
                  backgroundColor: '#34656D',
                  width: '100%',
                  height: '60px',
                  borderRadius: '8px 8px 0 0',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'white',
                  fontWeight: '600',
                  fontSize: '12px',
                  textAlign: 'center',
                  padding: '8px'
                }}>
                  Phase Work
                </div>
                <div style={{
                  fontSize: '11px',
                  color: '#6B7280',
                  marginTop: '8px',
                  textAlign: 'center'
                }}>
                  {phase.start_date ? new Date(phase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'} - {phase.end_date ? new Date(phase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}
                </div>
              </div>

              {/* Evaluation Phase - Show BEFORE Breathe if evaluation dates are set */}
              {phase.evaluation_available_from && phase.evaluation_due_date && (
                <>
                  <div style={{
                    fontSize: '18px',
                    color: '#D1D5DB'
                  }}>‚Üí</div>
                  <div style={{
                    flex: 1,
                    minWidth: '120px',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center'
                  }}>
                    <div style={{
                      backgroundColor: '#8B5CF6',
                      width: '100%',
                      height: '60px',
                      borderRadius: '8px 8px 0 0',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      fontWeight: '600',
                      fontSize: '12px',
                      textAlign: 'center',
                      padding: '8px'
                    }}>
                      Evaluation
                    </div>
                    <div style={{
                      fontSize: '11px',
                      color: '#6B7280',
                      marginTop: '8px',
                      textAlign: 'center'
                    }}>
                      {new Date(phase.evaluation_available_from).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date(phase.evaluation_due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                  </div>
                </>
              )}

              {/* Breathe Phase - Only show if breathe_phase_days > 0, after evaluation */}
              {phase.breathe_phase_days && phase.breathe_phase_days > 0 && phase.end_date && (
                <>
                  <div style={{
                    fontSize: '18px',
                    color: '#D1D5DB'
                  }}>‚Üí</div>
                  <div style={{
                    flex: 0.5,
                    minWidth: '80px',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center'
                  }}>
                    <div style={{
                      backgroundColor: '#F59E0B',
                      width: '100%',
                      height: '60px',
                      borderRadius: '8px 8px 0 0',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      fontWeight: '600',
                      fontSize: '12px',
                      textAlign: 'center',
                      padding: '8px'
                    }}>
                      Breathe
                    </div>
                    <div style={{
                      fontSize: '11px',
                      color: '#6B7280',
                      marginTop: '8px',
                      textAlign: 'center'
                    }}>
                      {phase.breathe_phase_days} day{phase.breathe_phase_days !== 1 ? 's' : ''}
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Legend */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
              gap: '12px',
              paddingTop: '12px',
              borderTop: '1px solid #E5E7EB'
            }}>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center', fontSize: '13px' }}>
                <div style={{
                  width: '20px',
                  height: '20px',
                  backgroundColor: '#34656D',
                  borderRadius: '4px'
                }}></div>
                <span>Phase Work Period</span>
              </div>
              {phase.breathe_phase_days && phase.breathe_phase_days > 0 && (
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center', fontSize: '13px' }}>
                  <div style={{
                    width: '20px',
                    height: '20px',
                    backgroundColor: '#F59E0B',
                    borderRadius: '4px'
                  }}></div>
                  <span>Breathe Phase (No work)</span>
                </div>
              )}
              {phase.evaluation_available_from && (
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center', fontSize: '13px' }}>
                  <div style={{
                    width: '20px',
                    height: '20px',
                    backgroundColor: '#8B5CF6',
                    borderRadius: '4px'
                  }}></div>
                  <span>Evaluation Window</span>
                </div>
              )}
            </div>
          </div>

          {/* Phase Description */}
          <div className="phase-description-section">
            <h3>Description</h3>
            <p>{phase.description || 'No description available for this phase.'}</p>
          </div>

          {/* Phase Progress */}
          <div className="phase-progress-section">
            <h3>Progress</h3>
            <div className="progress-container">
              <div className="progress-bar-container">
                <div className="progress-bar">
                  <div 
                    className="progress-fill" 
                    style={{ 
                      width: `${getPhaseStatus(phase) === 'completed' ? 100 : 
                              getPhaseStatus(phase) === 'active' ? 50 : 0}%` 
                    }}
                  ></div>
                </div>
                <span className="progress-text">
                  {getPhaseStatus(phase) === 'completed' ? '100% Complete' : 
                   getPhaseStatus(phase) === 'active' ? 'In Progress' : 'Not Started'}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <div className="phase-modal-footer">
          <button 
            className="modal-btn secondary"
            onClick={onClose}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Breathe Phase Modal Component
const BreathePhaseModal = ({ isOpen, onClose, phase }) => {
  if (!isOpen || !phase) return null;

  const breatheStart = phase.breathe_start_date ? new Date(phase.breathe_start_date) : null;
  const breatheEnd = phase.breathe_end_date ? new Date(phase.breathe_end_date) : null;
  const breatheDays = phase.breathe_phase_days || 0;

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="phase-modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative', maxWidth: '600px' }}>
        <div className="phase-modal-header">
          <div className="phase-modal-title">
            <h2>Breathe Phase</h2>
            <p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280', fontWeight: '400' }}>
              Rest period after Phase {phase.phase_number}
            </p>
          </div>
          <button 
            className="modal-close"
            onClick={onClose}
          >
            ‚úï
          </button>
        </div>
        
        <div className="phase-modal-body">
          {/* Overview */}
          <div className="phase-info-section" style={{ backgroundColor: '#fef3c7', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>What is Breathe Phase?</h3>
            <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.6', color: '#92400e' }}>
              This is a designated rest period between phases where no new work deliverables are required. Use this time to recover, reflect on feedback, and prepare for the next phase.
            </p>
          </div>

          {/* Timeline Section */}
          <div className="phase-info-section" style={{ backgroundColor: '#f3f4f6', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>Duration & Dates</h3>
            <div className="phase-info-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
              <div className="info-item">
                <label>Duration</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {breatheDays} day{breatheDays !== 1 ? 's' : ''}
                </span>
              </div>
              <div className="info-item">
                <label>Start Date</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {breatheStart ? breatheStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Not set'}
                </span>
              </div>
              <div className="info-item">
                <label>End Date</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {breatheEnd ? breatheEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Not set'}
                </span>
              </div>
            </div>
          </div>

          {/* During Breathe Phase */}
          <div className="phase-info-section">
            <h3>What to Do</h3>
            <div style={{ backgroundColor: '#f3f4f6', padding: '12px', borderRadius: '6px', fontSize: '13px', color: '#4b5563', lineHeight: '1.8' }}>
              <ul style={{ margin: 0, paddingLeft: '20px' }}>
                <li>Review feedback received from Phase {phase.phase_number}</li>
                <li>Reflect on your progress and learnings</li>
                <li>Plan and prepare for the next phase</li>
                <li>Rest and recharge</li>
                <li>Submit evaluations if they are still open</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div className="phase-modal-footer">
          <button 
            className="modal-btn secondary"
            onClick={onClose}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Gantt Phase Modal Component
const GanttPhaseModal = ({ isOpen, onClose, phase }) => {
  if (!isOpen || !phase) return null;

  const startDate = phase.start_date ? new Date(phase.start_date) : null;
  const endDate = phase.end_date ? new Date(phase.end_date) : null;
  const durationDays = startDate && endDate ? 
    Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) : 0;

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="phase-modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative', maxWidth: '650px' }}>
        <div className="phase-modal-header">
          <div className="phase-modal-title">
            <h2>Phase {phase.phase_number}</h2>
            <p style={{ margin: '8px 0 0 0', fontSize: '16px', color: '#4b5563', fontWeight: '500' }}>
              {phase.title}
            </p>
          </div>
          <button className="modal-close" onClick={onClose}>
            ‚úï
          </button>
        </div>
        
        <div className="phase-modal-body">
          {/* Timeline Section */}
          <div className="phase-info-section" style={{ backgroundColor: '#f3f4f6', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>Timeline</h3>
            <div className="phase-info-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
              <div className="info-item">
                <label>Start Date</label>
                <span style={{ fontSize: '15px', color: '#059669' }}>
                  {startDate ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
              <div className="info-item">
                <label>End Date</label>
                <span style={{ fontSize: '15px', color: '#dc2626' }}>
                  {endDate ? endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
              <div className="info-item">
                <label>Duration</label>
                <span style={{ fontSize: '15px', color: '#3b82f6' }}>
                  {durationDays} day{durationDays !== 1 ? 's' : ''}
                </span>
              </div>
            </div>
          </div>

          {/* Description Section */}
          {phase.description && (
            <div className="phase-info-section">
              <h3>Description</h3>
              <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.6', color: '#4b5563' }}>
                {phase.description}
              </p>
            </div>
          )}

          {/* Deliverables Section */}
          {phase.deliverables && phase.deliverables.length > 0 && (
            <div className="phase-info-section">
              <h3>Deliverables</h3>
              <ul style={{ margin: '0', paddingLeft: '20px', fontSize: '14px', color: '#4b5563', lineHeight: '1.8' }}>
                {phase.deliverables.map((deliverable, idx) => (
                  <li key={idx}>{deliverable}</li>
                ))}
              </ul>
            </div>
          )}
        </div>
        
        <div className="phase-modal-footer">
          <button 
            className="modal-btn secondary"
            onClick={onClose}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Gantt Task Modal Component
const GanttTaskModal = ({ isOpen, onClose, task, phase, member, currentUser, onNavigate }) => {
  if (!isOpen || !task) return null;

  const isOwnTask = member && currentUser && (member.id === currentUser.id || member.student_id === currentUser.student_id);
  const taskStartDate = task.start_date ? new Date(task.start_date) : null;
  const taskEndDate = task.end_date ? new Date(task.end_date) : null;
  
  // Check if there's a submission for this task
  const hasSubmission = task.submission_count && task.submission_count > 0;
  const submissionStatus = task.status || 'no_submission';

  const handleGoTo = () => {
    if (isOwnTask) {
      // Own task: Always navigate to project dashboard
      onNavigate({ view: 'project-dashboard', taskId: task.id, phaseId: phase?.id });
    } else if (hasSubmission) {
      // Other member's task: Only navigate if they have submission
      onNavigate({ view: 'group-activities', taskId: task.id, feedbackMode: true });
    }
    onClose();
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="phase-modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative', maxWidth: '650px' }}>
        <div className="phase-modal-header">
          <div className="phase-modal-title">
            <h2>{task.title}</h2>
            <p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280', fontWeight: '400' }}>
              {hasSubmission ? 'Task Detail' : 'No Submission'}
            </p>
          </div>
          <button className="modal-close" onClick={onClose}>
            ‚úï
          </button>
        </div>
        
        <div className="phase-modal-body">
          {/* No Submission Message */}
          {!hasSubmission && (
            <div className="phase-info-section" style={{ backgroundColor: '#fee2e2', padding: '16px', borderRadius: '8px', marginBottom: '24px', border: '1px solid #fecaca' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <div style={{ fontSize: '24px', color: '#dc2626' }}>‚ö†Ô∏è</div>
                <div>
                  <h3 style={{ margin: '0 0 4px 0', color: '#991b1b' }}>No Submission Yet</h3>
                  <p style={{ margin: 0, fontSize: '14px', color: '#7f1d1d' }}>
                    {member ? `${member.name || member.full_name}` : 'This member'} has not submitted this task yet.
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Assignment Section */}
          <div className="phase-info-section" style={{ backgroundColor: '#f3f4f6', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>Assignment</h3>
            <div className="phase-info-grid" style={{ gridTemplateColumns: 'repeat(2, 1fr)' }}>
              <div className="info-item">
                <label>Assigned To</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {member ? (member.name || member.full_name) : 'Unassigned'}
                </span>
              </div>
              <div className="info-item">
                <label>Phase</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {phase ? `Phase ${phase.phase_number}` : 'Not specified'}
                </span>
              </div>
            </div>
          </div>

          {/* Timeline Section */}
          <div className="phase-info-section" style={{ backgroundColor: '#fef3c7', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>Timeline</h3>
            <div className="phase-info-grid" style={{ gridTemplateColumns: 'repeat(2, 1fr)' }}>
              <div className="info-item">
                <label>Start Date</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1f2937' }}>
                  {taskStartDate ? taskStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
              <div className="info-item">
                <label>Due Date</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#dc2626' }}>
                  {taskEndDate ? taskEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
            </div>
          </div>

          {/* Description Section */}
          {task.description && (
            <div className="phase-info-section">
              <h3>Description</h3>
              <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.6', color: '#4b5563' }}>
                {task.description}
              </p>
            </div>
          )}

          {/* View Type Info */}
          {(isOwnTask || hasSubmission) && (
            <div className="phase-info-section" style={{ backgroundColor: '#eff6ff', padding: '12px', borderRadius: '8px', fontSize: '13px', color: '#1e40af', borderLeft: '4px solid #3b82f6' }}>
              <strong>Go To:</strong> {isOwnTask 
                ? 'Opens Project Dashboard with your task' 
                : 'Opens Group Activities with feedback for this task'}
            </div>
          )}
        </div>
        
        <div className="phase-modal-footer">
          <button className="modal-btn secondary" onClick={onClose}>
            Cancel
          </button>
          {(isOwnTask || hasSubmission) && (
            <button 
              className="modal-btn primary" 
              onClick={handleGoTo}
            >
              Go To
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// Gantt Evaluation Modal Component
const GanttEvaluationModal = ({ isOpen, onClose, phase, evalType }) => {
  if (!isOpen || !phase) return null;

  const isProjectEval = evalType === 'project';
  const evalStart = isProjectEval ? phase.project_evaluation_available_from : phase.evaluation_available_from;
  const evalEnd = isProjectEval ? phase.project_evaluation_due_date : phase.evaluation_due_date;
  const evalStartDate = evalStart ? new Date(evalStart) : null;
  const evalEndDate = evalEnd ? new Date(evalEnd) : null;

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="phase-modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative', maxWidth: '650px' }}>
        <div className="phase-modal-header">
          <div className="phase-modal-title">
            <h2>{isProjectEval ? 'Project Evaluation' : `Phase ${phase.phase_number} Evaluation`}</h2>
            <p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280', fontWeight: '400' }}>
              {isProjectEval ? 'Project-wide evaluation window' : 'Phase evaluation window'}
            </p>
          </div>
          <button className="modal-close" onClick={onClose}>
            ‚úï
          </button>
        </div>
        
        <div className="phase-modal-body">
          {/* Evaluation Timeline */}
          <div className="phase-info-section" style={{ backgroundColor: '#dbeafe', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
            <h3 style={{ marginTop: 0 }}>Evaluation Period</h3>
            <div className="phase-info-grid" style={{ gridTemplateColumns: 'repeat(2, 1fr)' }}>
              <div className="info-item">
                <label>Available From</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#1e40af' }}>
                  {evalStartDate ? evalStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
              <div className="info-item">
                <label>Due Date</label>
                <span style={{ fontSize: '15px', fontWeight: '500', color: '#dc2626' }}>
                  {evalEndDate ? evalEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}
                </span>
              </div>
            </div>
          </div>

          {/* What to Submit */}
          <div className="phase-info-section">
            <h3>What to Submit</h3>
            <p style={{ margin: '0 0 16px 0', fontSize: '14px', lineHeight: '1.6', color: '#4b5563' }}>
              {isProjectEval 
                ? 'Complete your project evaluation form with all rubric responses and submit before the due date.'
                : `Complete your Phase ${phase.phase_number} evaluation form with all rubric responses and submit before the due date.`
              }
            </p>
            <div style={{ backgroundColor: '#f3f4f6', padding: '12px', borderRadius: '6px', fontSize: '13px', color: '#4b5563', lineHeight: '1.6' }}>
              <strong>Requirements:</strong>
              <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px' }}>
                <li>Review all evaluation criteria</li>
                <li>Complete all required fields</li>
                <li>Provide feedback or ratings as needed</li>
                <li>Submit before the due date</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div className="phase-modal-footer">
          <button className="modal-btn secondary" onClick={onClose}>
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Member Modal Component
const MemberModal = () => {
  const [isMemberModalLoading, setIsMemberModalLoading] = useState(false);
  
  useEffect(() => {
    if (showMemberModal && selectedMember) {
      setIsMemberModalLoading(true);
      // Simulate loading time for member data
      setTimeout(() => {
        setIsMemberModalLoading(false);
      }, 500);
    }
  }, [showMemberModal, selectedMember]);
  
  if (!showMemberModal || !selectedMember) return null;
  
  return (
    <div className="modal-overlay" onClick={() => setShowMemberModal(false)}>
      <div className="modal-content" onClick={e => e.stopPropagation()} style={{ position: 'relative' }}>
        {/* Loading Overlay */}
        {isMemberModalLoading && (
          <ModalLoadingOverlay isVisible={true} />
        )}
          <div className="modal-left">
            <div className="member-avatar-modal">
              {selectedMember.studentaccounts?.profile_image_url ? (
                <img 
                  src={getProfileImageUrl(selectedMember.studentaccounts)} 
                  alt={selectedMember.studentaccounts.first_name}
                />
              ) : (
                <FaUser />
              )}
            </div>
            <h3>{selectedMember.studentaccounts?.first_name} {selectedMember.studentaccounts?.last_name}</h3>
            <span className={`role ${selectedMember.role}`}>{selectedMember.position}</span>
          </div>
          <div className="modal-right">
            <h4>Recent Activity</h4>
            <div className="activity-section">
              <h5>Assigned Tasks</h5>
              <p>Task activity will be displayed here</p>
            </div>
            <div className="activity-section">
              <h5>Recent Feedbacks</h5>
              <p>Recent feedback activity will be displayed here</p>
            </div>
          </div>
          <button 
            className="modal-close"
            onClick={() => setShowMemberModal(false)}
          >
            <FaTimes />
          </button>
        </div>
    </div>
  );
};

  // Main render (continues from where your code left off)
  if (loading) {
    return (
      <div className="loading-screen">
        <div className="spinner"></div>
        <p>Loading dashboard...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="dashboard-error">
        <p>{error}</p>
        <button onClick={loadDashboardData}>Retry</button>
      </div>
    );
  }

  // My Group phase navigation functions
  const navigateToGroupPreviousPhase = () => {
    if (!selectedGroupProject || !groupAvailablePhases.length) return;
    
    const sortedPhases = [...groupAvailablePhases].sort((a, b) => a.phase_number - b.phase_number);
    const currentIndex = selectedGroupPhase ? 
      sortedPhases.findIndex(phase => phase.id === selectedGroupPhase.id) : -1;
    
    if (currentIndex > 0) {
      const newPhase = sortedPhases[currentIndex - 1];
      setSelectedGroupPhase(newPhase);
      setGroupPhaseFilterMode('specific');
    }
  };

  const navigateToGroupNextPhase = () => {
    if (!selectedGroupProject || !groupAvailablePhases.length) return;
    
    const sortedPhases = [...groupAvailablePhases].sort((a, b) => a.phase_number - b.phase_number);
    const currentIndex = selectedGroupPhase ? 
      sortedPhases.findIndex(phase => phase.id === selectedGroupPhase.id) : -1;
    
    if (currentIndex < sortedPhases.length - 1) {
      const newPhase = sortedPhases[currentIndex + 1];
      setSelectedGroupPhase(newPhase);
      setGroupPhaseFilterMode('specific');
    }
  };

  return (
    <div className="course-student-dashboard">
      {/* Squares Background */}
      <div className="squares-background">
        <Squares 
          direction="up"
          speed={0.25}
          squareSize={100}
          borderColor="#E17564" 
          hoverFillColor="#303030"
          className="w-full h-full"
        />
      </div>

      <SidebarProvider
        style={{
          "--sidebar-width": "16rem",
          "--sidebar-width-collapsed": "0rem",
          "--header-height": "4rem",
        }}
      >
        <AppSidebar 
          variant="inset" 
          onTabChange={handleNavItemClick} 
          userRole={userRole} 
          activeTab={activeTab} 
          userProfile={userProfile}
          courseInfo={courseData ? {
            course_name: courseData.course_name,
            course_code: courseData.course_code,
            section: courseData.section,
            semester: courseData.semester,
            school_year: courseData.school_year
          } : null}
        />
        <SidebarInset style={{ backgroundColor: activeTab === 'my-group' ? 'white' : 'inherit' }}>
          {/* Pink Header Section with conditional content */}
          {activeTab === 'project-dashboard' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered content */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Project Dashboard</h1>
                </div>
                
                {/* Center area - Notch with Dropdown and Phase Circle */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',  
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '400px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '20px'
                }}>
                  {/* Project Selector Dropdown */}
                  <div className="project-dropdown-wrapper" style={{ 
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center'
                  }}>
                    <button 
                      onClick={() => setShowProjectDropdown(!showProjectDropdown)}
                      style={{
                        padding: '8px 24px',
                        minWidth: '336px',
                        marginTop: '-30px',
                        backgroundColor: '#ffffff',
                        color: '#872341',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.95)';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {selectedProject ? selectedProject.title : 'Select a project'}
                      </span>
                      <FaChevronDown style={{
                        transition: 'transform 0.3s ease',
                        transform: showProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                        fontSize: '12px',
                        flexShrink: 0
                      }} />
                    </button>
                    
                    {showProjectDropdown && (
                      <div style={{
                        position: 'absolute',
                        top: 'calc(100% + 8px)',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        minWidth: '384px',
                        backgroundColor: 'white',
                        border: '2px solid #872341',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(135, 35, 65, 0.2)',
                        zIndex: 9999,
                        maxHeight: '300px',
                        overflowY: 'auto',
                        pointerEvents: 'auto'
                      }}>
                        {projects.filter(p => isProjectOngoing(p)).length > 0 ? (
                          projects.filter(p => isProjectOngoing(p)).map(project => (
                            <div
                              key={project.id}
                              onClick={() => handleProjectChange(project)}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f3f4f6',
                                transition: 'background-color 0.2s',
                                backgroundColor: selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'
                              }}
                              onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.1)'}
                              onMouseOut={(e) => e.currentTarget.style.backgroundColor = selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'}
                            >
                              <div style={{ 
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                justifyContent: 'space-between'
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                                  <FaProjectDiagram style={{ color: '#872341', fontSize: '16px', flexShrink: 0 }} />
                                  <div style={{ flex: 1 }}>
                                    <div style={{ 
                                      fontWeight: '600', 
                                      color: '#872341', 
                                      fontSize: '14px',
                                      marginBottom: '2px'
                                    }}>
                                      {project.title}
                                    </div>
                                    {project.start_date && project.due_date && (
                                      <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                        {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <span style={{
                                  padding: '2px 8px',
                                  borderRadius: '12px',
                                  fontSize: '11px',
                                  fontWeight: '600',
                                  backgroundColor: project.status === 'active' ? '#D1FAE5' : '#FEE2E2',
                                  color: project.status === 'active' ? '#059669' : '#DC2626',
                                  flexShrink: 0
                                }}>
                                  {project.status}
                                </span>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div style={{ padding: '12px 16px', color: '#9CA3AF', fontSize: '14px' }}>
                            No projects available
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Phase Circle - Below dropdown */}
                  <div className="phase-circle-container">
                    <div className="phase-navigation-row">
                      {/* Previous Phase Button */}
                      <button 
                        className="phase-nav-button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          console.log('üîç Previous phase button clicked');
                          console.log('üîç Previous phase button - selectedPhase:', selectedPhase?.phase_number);
                          console.log('üîç Previous phase button - event target:', e.target);
                          navigateToPreviousPhase();
                        }}
                        disabled={(() => {
                          const hasProject = !!selectedProject;
                          const hasPhases = !!selectedProject?.project_phases;
                          const isFirstPhase = viewedPhase ? 
                            selectedProject?.project_phases?.sort((a, b) => a.phase_number - b.phase_number)[0]?.id === viewedPhase.id :
                            currentPhase ? 
                            selectedProject?.project_phases?.sort((a, b) => a.phase_number - b.phase_number)[0]?.id === currentPhase.id :
                            true;
                          // Allow navigation even on first phase - user can navigate past phases
                          const disabled = !hasProject || !hasPhases;
                          console.log('üîç Previous button disabled check:', { hasProject, hasPhases, isFirstPhase, disabled, viewedPhase: viewedPhase?.id, currentPhase: currentPhase?.id });
                          return disabled;
                        })()}
                        title="Previous Phase"
                      >
                        <FaChevronLeft />
                      </button>

                      {/* Phase Circle */}
                      {selectedProject && (viewedPhase || currentPhase) ? (
                        <div className="phase-circle-with-label">
                          <div 
                            className={`phase-circle ${viewedPhase ? 'viewed' : 'active'} ${
                              viewedPhase && (
                                viewedPhase.id !== currentPhase?.id || 
                                viewedPhase.currentPhaseType !== currentPhase?.currentPhaseType
                              ) ? 'different-from-current' : ''
                            }`}
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              console.log('üîç Phase circle clicked - showProjectPhases:', showProjectPhases);
                              console.log('üîç Phase circle clicked - selectedProject:', selectedProject?.title);
                              console.log('üîç Phase circle clicked - viewedPhase:', viewedPhase?.phase_number);
                              console.log('üîç Phase circle clicked - currentPhase:', currentPhase?.phase_number);
                              console.log('üîç Phase circle clicked - selectedPhase:', selectedPhase?.phase_number);
                              console.log('üîç Phase circle clicked - event target:', e.target);
                              console.log('üîç Phase circle clicked - event type:', e.type);
                              console.log('üîç Phase circle clicked - event bubbles:', e.bubbles);
                              console.log('üîç Phase circle clicked - event cancelable:', e.cancelable);
                              setShowProjectPhases(!showProjectPhases);
                            }}
                            onMouseDown={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                            }}
                            title={(() => {
                              const phase = viewedPhase || currentPhase;
                              const seqNumber = getSequentialPhaseNumber(phase, selectedProject?.project_phases);
                              let phaseTypeLabel = '';
                              if (phase?.currentPhaseType === 'evaluation') {
                                phaseTypeLabel = ' - Evaluation Phase';
                              } else if (phase?.currentPhaseType === 'breathe') {
                                phaseTypeLabel = ' - Breathe Period';
                              } else {
                                phaseTypeLabel = ' - Work Phase';
                              }
                              const isDifferent = viewedPhase && (
                                viewedPhase.id !== currentPhase?.id || 
                                viewedPhase.currentPhaseType !== currentPhase?.currentPhaseType
                              );
                              return `Phase ${seqNumber}${phaseTypeLabel}: ${phase.title}${isDifferent ? ' (Viewing)' : ''}`;
                            })()}
                            style={{
                              backgroundColor: (() => {
                                const phase = viewedPhase || currentPhase;
                                if (!phase?.currentPhaseType) return '#F3F4F6';
                                if (phase.currentPhaseType === 'evaluation') return '#F3E8FF'; // light purple
                                if (phase.currentPhaseType === 'breathe') return '#ECFDF5'; // light green
                                return '#FEF2F2'; // light red for work phase
                              })(),
                              borderColor: (() => {
                                const phase = viewedPhase || currentPhase;
                                if (!phase?.currentPhaseType) return '#D1D5DB';
                                if (phase.currentPhaseType === 'evaluation') return '#8B5CF6'; // purple
                                if (phase.currentPhaseType === 'breathe') return '#10B981'; // green
                                return '#DC2626'; // red for regular/work phases
                              })(),
                              color: (() => {
                                // Map the phase type to an explicit accent color for the number/icon
                                // Work phases -> red, Evaluation -> purple, Breathe -> green
                                const phase = viewedPhase || currentPhase;
                                if (!phase?.currentPhaseType) return '#6B7280';
                                if (phase.currentPhaseType === 'evaluation') return '#8B5CF6'; // purple
                                if (phase.currentPhaseType === 'breathe') return '#10B981'; // green
                                return '#DC2626'; // red for regular/work phases
                              })()
                            }}
                          >
                            {(() => {
                              const phase = viewedPhase || currentPhase;
                              const seqNumber = getSequentialPhaseNumber(phase, selectedProject?.project_phases);
                              // Show icons for evaluation and breathe, numbers for work phases
                              if (phase.currentPhaseType === 'evaluation') return <FaClipboard style={{ fontSize: '1.08em' }} />;
                              if (phase.currentPhaseType === 'breathe') return <FaPause style={{ fontSize: '1.08em' }} />;
                              return seqNumber; // work phase shows sequential number
                            })()}
                          </div>
                          
                          {/* Return Button - Only show when viewing different phase */}
                          {viewedPhase && (
                            viewedPhase.id !== currentPhase?.id || 
                            viewedPhase.currentPhaseType !== currentPhase?.currentPhaseType
                          ) && (
                            <div className="phase-label-section">
                              <button 
                                className="return-to-active-btn"
                                onClick={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  if (currentPhase) {
                                    setViewedPhase(currentPhase);
                                  }
                                }}
                                title="Return to the currently active phase"
                                style={{ marginTop: '12px' }}
                              >
                                <FaArrowRight style={{ marginRight: '4px' }} />
                                Return to Active
                              </button>
                            </div>
                          )}
                        </div>
                      ) : selectedProject ? (
                        <div 
                          className="phase-circle empty"
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              console.log('üîç Phase circle (empty) clicked - showProjectPhases:', showProjectPhases);
                              setShowProjectPhases(!showProjectPhases);
                            }}
                            onMouseDown={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                            }}
                          title="No active phase - Click to view phases"
                        >
                          ?
                        </div>
                      ) : (
                        <div 
                          className="phase-circle empty project-icon"
                          title="Select a project first"
                        >
                          <FaProjectDiagram />
                        </div>
                      )}

                      {/* Next Phase Button */}
                      <button 
                        className="phase-nav-button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          console.log('üîç Next phase button clicked');
                          console.log('üîç Next phase button - selectedPhase:', selectedPhase?.phase_number);
                          console.log('üîç Next phase button - event target:', e.target);
                          navigateToNextPhase();
                        }}
                        disabled={(() => {
                          const hasProject = !!selectedProject;
                          const hasPhases = !!selectedProject?.project_phases;
                          const isLastPhase = viewedPhase ? 
                            selectedProject?.project_phases?.sort((a, b) => a.phase_number - b.phase_number).slice(-1)[0]?.id === viewedPhase.id :
                            currentPhase ? 
                            selectedProject?.project_phases?.sort((a, b) => a.phase_number - b.phase_number).slice(-1)[0]?.id === currentPhase.id :
                            true;
                          // Allow navigation even on last phase - user can navigate through all phases
                          const disabled = !hasProject || !hasPhases;
                          console.log('üîç Next button disabled check:', { hasProject, hasPhases, isLastPhase, disabled, viewedPhase: viewedPhase?.id, currentPhase: currentPhase?.id });
                          return disabled;
                        })()}
                        title="Next Phase"
                      >
                        <FaChevronRight />
                      </button>
                    </div>
                    
                    <div className={`phase-text ${selectedProject && (viewedPhase || currentPhase) ? 'active' : 'inactive'}`}>
                      {selectedProject && (viewedPhase || currentPhase) ? 
                        (() => {
                          const phase = viewedPhase || currentPhase;
                          if (phase?.currentPhaseType === 'evaluation') {
                            return `EVALUATION PHASE: ${phase.title}${viewedPhase && viewedPhase.id !== currentPhase?.id ? ' (Viewing)' : ''}`;
                          } else if (phase?.currentPhaseType === 'breathe') {
                            return `BREATHE PHASE: ${phase.title}${viewedPhase && viewedPhase.id !== currentPhase?.id ? ' (Viewing)' : ''}`;
                          }
                          return `Phase ${phase.phase_number}: ${phase.title}${viewedPhase && viewedPhase.id !== currentPhase?.id ? ' (Viewing)' : ''}`;
                        })() : 
                       selectedProject ? 'No Active Phase' : 'Select a Project'}
                    </div>
                    
                    {/* Reset to Current Phase Button (only show when viewing different phase AND currentPhase exists) */}
                    {selectedProject && currentPhase && viewedPhase && viewedPhase.id !== currentPhase.id && (
                      <button 
                        className="reset-to-current-phase-btn"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          console.log('üîç Reset to current phase button clicked');
                          console.log('üîç Reset button - selectedPhase:', selectedPhase?.phase_number);
                          console.log('üîç Reset button - event target:', e.target);
                          resetToCurrentPhase();
                        }}
                        title="Reset to Current Phase"
                      >
                        <FaUndo /> Current Phase
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'my-group' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered content */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>My Group</h1>
                </div>
                
                {/* Center area - Tab Navigation Buttons */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '450px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  <button
                    onClick={() => setActiveGroupTab('overview')}
                    style={{
                      padding: '8px 30px',
                      minWidth: '120px',
                      marginTop: '-20px',
                      backgroundColor: activeGroupTab === 'overview' ? '#ffffff' : 'transparent',
                      color: activeGroupTab === 'overview' ? '#872341' : '#ffffff',
                      border: activeGroupTab === 'overview' ? '2px solid #ffffff' : '2px solid rgba(255,255,255,0.5)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => {
                      if (activeGroupTab !== 'overview') {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        e.currentTarget.style.borderColor = '#ffffff';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (activeGroupTab !== 'overview') {
                        e.currentTarget.style.backgroundColor = 'transparent';
                        e.currentTarget.style.borderColor = 'rgba(255,255,255,0.5)';
                      }
                    }}
                  >
                    Overview
                  </button>
                  
                  <button
                    onClick={() => setActiveGroupTab('activities')}
                    style={{
                      padding: '8px 30px',
                      minWidth: '120px',
                      marginTop: '-20px',
                      backgroundColor: activeGroupTab === 'activities' ? '#ffffff' : 'transparent',
                      color: activeGroupTab === 'activities' ? '#872341' : '#ffffff',
                      border: activeGroupTab === 'activities' ? '2px solid #ffffff' : '2px solid rgba(255,255,255,0.5)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => {
                      if (activeGroupTab !== 'activities') {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        e.currentTarget.style.borderColor = '#ffffff';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (activeGroupTab !== 'activities') {
                        e.currentTarget.style.backgroundColor = 'transparent';
                        e.currentTarget.style.borderColor = 'rgba(255,255,255,0.5)';
                      }
                    }}
                  >
                    Activities
                  </button>
                  
                  <button
                    onClick={() => setActiveGroupTab('reports')}
                    style={{
                      padding: '8px 30px',
                      minWidth: '120px',
                      marginTop: '-20px',
                      backgroundColor: activeGroupTab === 'reports' ? '#ffffff' : 'transparent',
                      color: activeGroupTab === 'reports' ? '#872341' : '#ffffff',
                      border: activeGroupTab === 'reports' ? '2px solid #ffffff' : '2px solid rgba(255,255,255,0.5)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseOver={(e) => {
                      if (activeGroupTab !== 'reports') {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        e.currentTarget.style.borderColor = '#ffffff';
                      }
                    }}
                    onMouseOut={(e) => {
                      if (activeGroupTab !== 'reports') {
                        e.currentTarget.style.backgroundColor = 'transparent';
                        e.currentTarget.style.borderColor = 'rgba(255,255,255,0.5)';
                      }
                    }}
                  >
                    Reports
                  </button>
                </div>
              </div>
            </header>
          ) : activeTab === 'submission-checking' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Submission Checking</h1>
                </div>
                
                {/* Center area - Notch with Project Dropdown */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '400px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Project Dropdown Button */}
                  <div className="project-dropdown-wrapper" style={{ 
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center'
                  }}>
                    <button
                      onClick={() => setSubmissionCheckingView(prev => ({
                        ...prev,
                        showProjectDropdown: !prev.showProjectDropdown
                      }))}
                      style={{
                        padding: '8px 24px',
                        minWidth: '336px',
                        marginTop: '-30px',
                        backgroundColor: '#ffffff',
                        color: '#872341',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.95)';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {submissionCheckingView.selectedProject 
                          ? submissionCheckingView.selectedProject.title 
                          : 'Select a Project'}
                      </span>
                      <FaChevronDown style={{
                        transition: 'transform 0.3s ease',
                        transform: submissionCheckingView.showProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                        fontSize: '12px',
                        flexShrink: 0
                      }} />
                    </button>
                    
                    {submissionCheckingView.showProjectDropdown && (
                      <div style={{
                        position: 'absolute',
                        top: 'calc(100% + 8px)',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        minWidth: '384px',
                        backgroundColor: 'white',
                        border: '2px solid #872341',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(135, 35, 65, 0.2)',
                        zIndex: 1001,
                        maxHeight: '300px',
                        overflowY: 'auto'
                      }}>
                        {projects.filter(p => p.is_active).length > 0 ? (
                          projects.filter(p => p.is_active).map(project => (
                            <div
                              key={project.id}
                              onClick={() => {
                                setSubmissionCheckingView(prev => ({
                                  ...prev,
                                  selectedProject: project,
                                  showProjectDropdown: false,
                                  loading: true
                                }));
                                // Call the existing handleProjectSelect function
                                const handleProjectSelect = async (project) => {
                                  try {
                                    const token = localStorage.getItem('token');
                                    
                                    const phasesResponse = await fetch(
                                      `${apiConfig.baseURL}/api/projects/${project.id}/phases`,
                                      {
                                        headers: {
                                          'Authorization': `Bearer ${token}`,
                                          'Content-Type': 'application/json'
                                        }
                                      }
                                    );

                                    if (!phasesResponse.ok) throw new Error('Failed to load phases');
                                    
                                    const phasesData = await phasesResponse.json();
                                    const phases = phasesData.phases || [];
                                    
                                    const today = new Date();
                                    const currentPhase = phases.find(phase => {
                                      const start = new Date(phase.start_date);
                                      const end = new Date(phase.end_date);
                                      return today >= start && today <= end;
                                    }) || phases[0];
                                    
                                    let submissions = [];
                                    if (currentPhase) {
                                      const submissionsResponse = await fetch(
                                        `${apiConfig.baseURL}/api/submission-checking/${project.id}/phase/${currentPhase.id}`,
                                        {
                                          headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                          }
                                        }
                                      );

                                      if (submissionsResponse.ok) {
                                        const submissionsData = await submissionsResponse.json();
                                        submissions = submissionsData.submissions || [];
                                      }
                                    }
                                    
                                    setSubmissionCheckingView(prev => ({
                                      ...prev,
                                      phases: phases,
                                      selectedPhase: currentPhase,
                                      detailsData: submissions,
                                      loading: false
                                    }));
                                  } catch (error) {
                                    console.error('Error loading submission checking data:', error);
                                    setSubmissionCheckingView(prev => ({
                                      ...prev,
                                      loading: false
                                    }));
                                  }
                                };
                                handleProjectSelect(project);
                              }}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f3f4f6',
                                transition: 'background-color 0.2s',
                                backgroundColor: submissionCheckingView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'
                              }}
                              onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.1)'}
                              onMouseOut={(e) => e.currentTarget.style.backgroundColor = submissionCheckingView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'}
                            >
                              <div style={{ 
                                fontWeight: '500', 
                                color: '#872341', 
                                fontSize: '14px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                <FaProjectDiagram />
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                  <div>{project.title}</div>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    color: '#6B7280', 
                                    fontWeight: '400' 
                                  }}>
                                    {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div style={{ padding: '12px 16px', color: '#9CA3AF', fontSize: '14px' }}>
                            No active projects available
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'task-assignment' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Task Assignment</h1>
                </div>
                
                {/* Center area - Notch with Project Dropdown */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '400px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Project Dropdown Button */}
                  <div className="project-dropdown-wrapper" style={{ 
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center'
                  }}>
                    <button
                      onClick={() => setTaskAssignmentView(prev => ({
                        ...prev,
                        showProjectDropdown: !prev.showProjectDropdown
                      }))}
                      style={{
                        padding: '8px 24px',
                        minWidth: '336px',
                        marginTop: '-30px',
                        backgroundColor: '#ffffff',
                        color: '#872341',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.95)';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {taskAssignmentView.selectedProject 
                          ? taskAssignmentView.selectedProject.title 
                          : 'Select a Project'}
                      </span>
                      <FaChevronDown style={{
                        transition: 'transform 0.3s ease',
                        transform: taskAssignmentView.showProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                        fontSize: '12px',
                        flexShrink: 0
                      }} />
                    </button>
                    
                    {taskAssignmentView.showProjectDropdown && (
                      <div style={{
                        position: 'absolute',
                        top: 'calc(100% + 8px)',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        minWidth: '384px',
                        backgroundColor: 'white',
                        border: '2px solid #872341',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(135, 35, 65, 0.2)',
                        zIndex: 1001,
                        maxHeight: '300px',
                        overflowY: 'auto'
                      }}>
                        {projects.filter(p => p.is_active).length > 0 ? (
                          projects.filter(p => p.is_active).map(project => (
                            <div
                              key={project.id}
                              onClick={async () => {
                                setTaskAssignmentView(prev => ({
                                  ...prev,
                                  selectedProject: project,
                                  showProjectDropdown: false,
                                  loading: true
                                }));

                                try {
                                  const token = localStorage.getItem('token');
                                  
                                  // Fetch group members for this project
                                  const membersResponse = await fetch(
                                    `${apiConfig.baseURL}/api/task-assignment/projects/${project.id}/members`,
                                    {
                                      headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                      }
                                    }
                                  );

                                  if (!membersResponse.ok) throw new Error('Failed to load group members');
                                  
                                  const membersData = await membersResponse.json();
                                  
                                  // Fetch project phases
                                  const phasesResponse = await fetch(
                                    `${apiConfig.baseURL}/api/task-assignment/projects/${project.id}/phases`,
                                    {
                                      headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                      }
                                    }
                                  );

                                  if (!phasesResponse.ok) throw new Error('Failed to load phases');
                                  
                                  const phasesData = await phasesResponse.json();
                                  
                                  // Load existing assigned tasks
                                  const tasksResponse = await fetch(
                                    `${apiConfig.baseURL}/api/student-leader/projects/${project.id}/assigned-tasks`,
                                    {
                                      headers: {
                                        'Authorization': `Bearer ${token}`
                                      }
                                    }
                                  );

                                  let assignedTasksMap = {};
                                  if (tasksResponse.ok) {
                                    const data = await tasksResponse.json();
                                    if (data.tasks && data.tasks.length > 0) {
                                      data.tasks.forEach(task => {
                                        const key = `${task.assigned_to_id}-${task.phase_id}`;
                                        assignedTasksMap[key] = (assignedTasksMap[key] || 0) + 1;
                                      });
                                    }
                                  }
                                  
                                  // Members data is already transformed by the backend
                                  setTaskAssignmentView(prev => ({
                                    ...prev,
                                    groupMembers: membersData.members || [],
                                    projectPhases: phasesData.phases || [],
                                    selectedProject: {
                                      ...project,
                                      min_tasks_per_member: phasesData.project?.min_tasks_per_member,
                                      max_tasks_per_member: phasesData.project?.max_tasks_per_member
                                    },
                                    assignedTasks: assignedTasksMap,
                                    loading: false
                                  }));
                                } catch (error) {
                                  console.error('Error loading task assignment data:', error);
                                  alert('Failed to load group members or phases: ' + error.message);
                                  setTaskAssignmentView(prev => ({
                                    ...prev,
                                    loading: false
                                  }));
                                }
                              }}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f3f4f6',
                                transition: 'background-color 0.2s',
                                backgroundColor: taskAssignmentView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'
                              }}
                              onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.1)'}
                              onMouseOut={(e) => e.currentTarget.style.backgroundColor = taskAssignmentView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'}
                            >
                              <div style={{ 
                                fontWeight: '500', 
                                color: '#872341', 
                                fontSize: '14px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                <FaProjectDiagram />
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                  <div>{project.title}</div>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    color: '#6B7280', 
                                    fontWeight: '400' 
                                  }}>
                                    {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div style={{ padding: '12px 16px', color: '#9CA3AF', fontSize: '14px' }}>
                            No active projects available
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'deliverables-submission' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Deliverables Submission</h1>
                </div>
                
                {/* Center area - Notch with Project Dropdown */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '400px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Project Dropdown Button */}
                  <div className="project-dropdown-wrapper" style={{ 
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center'
                  }}>
                    <button
                      onClick={() => setDeliverablesView(prev => ({ 
                        ...prev, 
                        showProjectDropdown: !prev.showProjectDropdown 
                      }))}
                      style={{
                        padding: '8px 24px',
                        minWidth: '336px',
                        marginTop: '-30px',
                        backgroundColor: '#ffffff',
                        color: '#872341',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        justifyContent: 'space-between'
                      }}
                      onMouseOver={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.95)';
                        e.currentTarget.style.transform = 'translateY(-1px)';
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px', flexShrink: 0 }} />
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textAlign: 'center' }}>
                        {deliverablesView.selectedProject 
                          ? deliverablesView.selectedProject.title 
                          : 'Select a Project'}
                      </span>
                      <FaChevronDown style={{
                        transition: 'transform 0.3s ease',
                        transform: deliverablesView.showProjectDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                        fontSize: '12px',
                        flexShrink: 0
                      }} />
                    </button>
                    
                    {deliverablesView.showProjectDropdown && (
                      <div style={{
                        position: 'absolute',
                        top: 'calc(100% + 8px)',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        minWidth: '384px',
                        backgroundColor: 'white',
                        border: '2px solid #872341',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(135, 35, 65, 0.2)',
                        zIndex: 1001,
                        maxHeight: '300px',
                        overflowY: 'auto'
                      }}>
                        {projects.filter(p => p.is_active).length > 0 ? (
                          projects.filter(p => p.is_active).map(project => (
                            <div
                              key={project.id}
                              onClick={async () => {
                                setDeliverablesView(prev => ({
                                  ...prev,
                                  selectedProject: project,
                                  showProjectDropdown: false,
                                  loading: true
                                }));

                                try {
                                  const token = localStorage.getItem('token');
                                  
                                  // Fetch phases for the project
                                  const phasesResponse = await fetch(
                                    `${apiConfig.baseURL}/api/student-leader/projects/${project.id}/phases`,
                                    {
                                      headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                      }
                                    }
                                  );

                                  if (!phasesResponse.ok) throw new Error('Failed to fetch phases');
                                  let phasesData = await phasesResponse.json();
                                  
                                  // Handle different response formats
                                  if (phasesData.phases) {
                                    phasesData = phasesData.phases;
                                  } else if (phasesData.data) {
                                    phasesData = phasesData.data;
                                  }
                                  
                                  // Ensure phasesData is an array
                                  if (!Array.isArray(phasesData)) {
                                    phasesData = [];
                                  }

                                  // Fetch the project dashboard to get the correct group_id
                                  const dashboardResponse = await fetch(
                                    `${apiConfig.baseURL}/api/student/projects/${project.id}/dashboard`,
                                    {
                                      headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                      }
                                    }
                                  );
                                  
                                  let group_id = groupData?.group_id || groupData?.id;
                                  
                                  if (dashboardResponse.ok) {
                                    const dashboardData = await dashboardResponse.json();
                                    group_id = dashboardData.group?.group_id || dashboardData.group?.id || group_id;
                                  }
                                  
                                  const phasesWithSubmissions = await Promise.all(
                                    phasesData.map(async (phase) => {
                                      try {
                                        const submissionResponse = await fetch(
                                          `${apiConfig.baseURL}/api/student/phases/${phase.id}/deliverable-submissions?group_id=${group_id}`,
                                          {
                                            headers: {
                                              'Authorization': `Bearer ${token}`,
                                              'Content-Type': 'application/json'
                                            }
                                          }
                                        );

                                        if (submissionResponse.ok) {
                                          const submissionData = await submissionResponse.json();
                                          return {
                                            ...phase,
                                            submissionDetails: submissionData.submissions || submissionData || []
                                          };
                                        } else {
                                          return {
                                            ...phase,
                                            submissionDetails: []
                                          };
                                        }
                                      } catch (error) {
                                        console.error(`Error fetching submissions for phase ${phase.phase_number}:`, error);
                                        return {
                                          ...phase,
                                          submissionDetails: []
                                        };
                                      }
                                    })
                                  );

                                  setDeliverablesView(prev => ({
                                    ...prev,
                                    phases: phasesWithSubmissions,
                                    projectSubmission: null,
                                    loading: false,
                                    selectedDeliverable: null,
                                    deliverableType: null
                                  }));
                                } catch (error) {
                                  console.error('Error loading deliverables data:', error);
                                  setDeliverablesView(prev => ({ ...prev, loading: false }));
                                }
                              }}
                              style={{
                                padding: '12px 16px',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f3f4f6',
                                transition: 'background-color 0.2s',
                                backgroundColor: deliverablesView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'
                              }}
                              onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'rgba(135, 35, 65, 0.1)'}
                              onMouseOut={(e) => e.currentTarget.style.backgroundColor = deliverablesView.selectedProject?.id === project.id ? 'rgba(135, 35, 65, 0.1)' : 'transparent'}
                            >
                              <div style={{ 
                                fontWeight: '500', 
                                color: '#872341', 
                                fontSize: '14px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                <FaProjectDiagram />
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                  <div>{project.title}</div>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    color: '#6B7280', 
                                    fontWeight: '400' 
                                  }}>
                                    {new Date(project.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - {new Date(project.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div style={{ padding: '12px 16px', color: '#9CA3AF', fontSize: '14px' }}>
                            No active projects available
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'my-grades' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>My Grades</h1>
                </div>
                
                {/* Center area - Notch with Project/Phase Toggle Buttons */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '280px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Toggle Buttons Container */}
                  <div style={{
                    display: 'flex',
                    gap: '8px',
                    marginTop: '-30px'
                  }}>
                    {/* Project Button */}
                    <button
                      onClick={() => {
                        setGradesViewFilter('project');
                        setGradesViewMode('wide');
                      }}
                      style={{
                        padding: '8px 24px',
                        backgroundColor: gradesViewFilter === 'project' ? '#ffffff' : 'transparent',
                        color: gradesViewFilter === 'project' ? '#872341' : '#ffffff',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}
                      onMouseOver={(e) => {
                        if (gradesViewFilter !== 'project') {
                          e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        }
                      }}
                      onMouseOut={(e) => {
                        if (gradesViewFilter !== 'project') {
                          e.currentTarget.style.backgroundColor = 'transparent';
                        }
                      }}
                    >
                      <FaProjectDiagram style={{ fontSize: '14px' }} />
                      Project
                    </button>

                    {/* Phase Button */}
                    <button
                      onClick={() => {
                        setGradesViewFilter('phase');
                        setGradesViewMode('wide');
                      }}
                      style={{
                        padding: '8px 24px',
                        backgroundColor: gradesViewFilter === 'phase' ? '#ffffff' : 'transparent',
                        color: gradesViewFilter === 'phase' ? '#872341' : '#ffffff',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}
                      onMouseOver={(e) => {
                        if (gradesViewFilter !== 'phase') {
                          e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        }
                      }}
                      onMouseOut={(e) => {
                        if (gradesViewFilter !== 'phase') {
                          e.currentTarget.style.backgroundColor = 'transparent';
                        }
                      }}
                    >
                      <FaTasks style={{ fontSize: '14px' }} />
                      Phase
                    </button>
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'evaluations' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Evaluations</h1>
                </div>
                
                {/* Center area - Notch with Type Toggle Pill */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: 'auto',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Center Pill - Toggle Button with Animation */}
                  <div style={{
                    padding: '4px',
                    borderRadius: '20px',
                    border: '2px solid #FFFFFF',
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0px',
                    width: '300px',
                    position: 'relative',
                    marginTop: '-30px'
                  }}>
                    {/* Project Option */}
                    <button
                      onClick={() => setEvaluationTypeToggle('project')}
                      style={{
                        flex: 1,
                        padding: '10px 20px',
                        borderRadius: '18px',
                        border: 'none',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        backgroundColor: evaluationTypeToggle === 'project' ? '#FFFFFF' : 'transparent',
                        color: evaluationTypeToggle === 'project' ? '#872341' : '#FFFFFF',
                        transition: 'all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px'
                      }}
                    >
                      <FaProjectDiagram size={16} /> Project
                    </button>

                    {/* Phase Option */}
                    <button
                      onClick={() => setEvaluationTypeToggle('phase')}
                      style={{
                        flex: 1,
                        padding: '10px 20px',
                        borderRadius: '18px',
                        border: 'none',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        backgroundColor: evaluationTypeToggle === 'phase' ? '#FFFFFF' : 'transparent',
                        color: evaluationTypeToggle === 'phase' ? '#872341' : '#FFFFFF',
                        transition: 'all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px'
                      }}
                    >
                      <FaClipboardList size={16} /> Phase
                    </button>
                  </div>
                </div>
              </div>
            </header>
          ) : activeTab === 'notifications' ? (
            <header className="flex h-10 shrink-0 items-center gap-2 px-6" style={{backgroundColor: '#872341', border: 'none'}}>
              {/* Header with sidebar toggle on left and centered notch */}
              <div className="project-dashboard-header" style={{display: 'flex', alignItems: 'center', width: '100%', height: '100%', padding: 0, margin: 0}}>
                {/* Left side - Sidebar toggle */}
                <div className="project-dashboard-sidebar-section" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <SidebarTrigger className="-ml-1" style={{color: '#ffffff'}} />
                  <Separator
                    orientation="vertical"
                    className="mx-2 data-[orientation=vertical]:h-4"
                    style={{backgroundColor: '#BE3144'}}
                  />
                  <h1 className="text-base font-semibold site-header-title" style={{color: '#ffffff', fontWeight: '600', WebkitTextFillColor: '#ffffff', textShadow: 'none'}}>Notifications</h1>
                </div>
                
                {/* Center area - Notch with Search Field */}
                <div className="project-dashboard-center-section" style={{ 
                  position: 'absolute',
                  top: '40px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '400px',
                  height: '42px',
                  backgroundColor: '#872341',
                  borderRadius: '0 0 28px 28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10,
                  padding: '0 12px',
                  gap: '12px'
                }}>
                  {/* Search Field */}
                  <div className="notification-search-wrapper" style={{ 
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    width: '100%'
                  }}>
                    <input
                      type="text"
                      placeholder="Search notifications..."
                      value={notificationSearchQuery}
                      onChange={(e) => setNotificationSearchQuery(e.target.value)}
                      style={{
                        padding: '8px 16px',
                        minWidth: '336px',
                        marginTop: '-30px',
                        backgroundColor: '#ffffff',
                        color: '#872341',
                        border: '2px solid #ffffff',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'text',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        outline: 'none',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                      }}
                      onFocus={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                      }}
                      onBlur={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                        e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                      }}
                    />
                  </div>
                </div>
              </div>
            </header>
          ) : (
            <SiteHeader title={getPageTitle()} />
          )}
          <div className="flex-1 p-4" style={{ backgroundColor: activeTab === 'my-group' ? 'white' : 'inherit' }}>
            {renderContent()}
          </div>
        </SidebarInset>

      <MemberModal />
      
      {/* ===== GANTT CHART MODALS ===== */}
      
      {/* Gantt Phase Modal */}
      {showGanttPhaseModal && ganttSelectedPhase && (
        <GanttPhaseModal 
          isOpen={showGanttPhaseModal}
          onClose={() => setShowGanttPhaseModal(false)}
          phase={ganttSelectedPhase}
        />
      )}

      {/* Gantt Task Modal */}
      {showGanttTaskModal && ganttSelectedTask && (
        <GanttTaskModal 
          isOpen={showGanttTaskModal}
          onClose={() => setShowGanttTaskModal(false)}
          task={ganttSelectedTask}
          phase={ganttSelectedPhaseForTask}
          member={ganttSelectedMemberForTask}
          currentUser={JSON.parse(localStorage.getItem('user') || '{}')}
          onNavigate={(config) => {
            // Handle navigation
            if (config.view === 'project-dashboard') {
              // Navigate to Project Dashboard with this task
              setSelectedProject(selectedGanttProject);
              setCurrentPhase(ganttSelectedPhaseForTask);
              setViewedPhase(ganttSelectedPhaseForTask);
              setSelectedTask(ganttSelectedTask);
              setSelectedPhase(ganttSelectedPhaseForTask);
              setShowTaskModal(true);
              setActiveTab('project-dashboard');
            } else if (config.view === 'group-activities') {
              // Navigate to My Group Activities with feedback view for this task
              setActiveTab('my-group');
              setActiveGroupTab('activities');
              setActivitiesView('feedbackView');
              
              // Set the project and load data
              if (selectedGanttProject) {
                setSelectedActivitiesProject(selectedGanttProject);
                setSelectedActivitiesPhase(ganttSelectedPhaseForTask);
                
                // Load the task submissions for this phase
                loadGroupTaskSubmissions(ganttSelectedPhaseForTask?.id, selectedGanttProject).then(() => {
                  // Find and highlight the current task in the submission list
                  setTimeout(() => {
                    const taskSubmission = groupTaskSubmissions.find(ts => ts.task_id === ganttSelectedTask.id);
                    if (taskSubmission) {
                      handleTaskSubmissionClick(taskSubmission);
                    }
                  }, 300);
                });
              }
            }
          }}
        />
      )}

      {/* Gantt Evaluation Modal */}
      {showGanttEvalModal && ganttSelectedEval && (
        <GanttEvaluationModal 
          isOpen={showGanttEvalModal}
          onClose={() => setShowGanttEvalModal(false)}
          phase={ganttSelectedEval}
          evalType={ganttEvalType}
        />
      )}
      
      {/* ===== END GANTT CHART MODALS ===== */}

      {/* Phase Modal Component */}
      {showPhaseModal && selectedPhaseForModal && (
        <PhaseModal 
          isOpen={showPhaseModal}
          onClose={() => setShowPhaseModal(false)}
          phase={selectedPhaseForModal}
        />
      )}

      {/* Breathe Phase Modal Component */}
      {showBreatheModal && selectedBreathePhase && (
        <BreathePhaseModal 
          isOpen={showBreatheModal}
          onClose={() => setShowBreatheModal(false)}
          phase={selectedBreathePhase}
        />
      )}

      {/* Task Detail Modal */}
      <TaskDetailModal
        key={selectedTask?.id || 'task-modal'}
        isOpen={showTaskModal}
        onClose={() => {
          setShowTaskModal(false);
          setSelectedTask(null);
          setSelectedPhase(null);
          setTaskModalSource(null);
        }}
        task={selectedTask}
        project={selectedProject}
        phase={selectedPhase}
        source={taskModalSource}
        onTaskSubmitted={async () => {
          // Refresh all data to move task from To-Do to Pending
          if (selectedProject) {
            await refreshData('task-submission');
          }
        }}
        onRequestExtension={() => {
          // Open extension request modal
          setShowExtensionRequestModal(true);
        }}
      />

      {/* Extension Request Modal */}
      {showExtensionRequestModal && selectedTask && (
        <div 
          className="extension-request-modal-overlay"
          onClick={() => {
            setShowExtensionRequestModal(false);
            setExtensionRequestReason('');
          }}
        >
          <div 
            className="extension-request-modal-container"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="extension-request-modal-header">
              <h2>Request Deadline Extension</h2>
              <button 
                className="extension-request-modal-close"
                onClick={() => {
                  setShowExtensionRequestModal(false);
                  setExtensionRequestReason('');
                }}
              >
                √ó
              </button>
            </div>
            <div className="extension-request-modal-body">
              <div className="extension-request-task-info">
                <h3>{selectedTask.title}</h3>
                <p><strong>Original Due Date:</strong> {new Date(selectedTask.due_date).toLocaleString()}</p>
                {selectedTask.available_until && (
                  <p><strong>Available Until:</strong> {new Date(selectedTask.available_until).toLocaleString()}</p>
                )}
              </div>
              <div className="extension-request-form">
                <label htmlFor="extension-reason">
                  <strong>Reason for Extension Request:</strong>
                  <span className="required-field">*</span>
                </label>
                <textarea
                  id="extension-reason"
                  className="extension-request-textarea"
                  placeholder="Please explain why you need an extension for this task..."
                  value={extensionRequestReason}
                  onChange={(e) => setExtensionRequestReason(e.target.value)}
                  rows={6}
                  maxLength={500}
                  disabled={submittingExtensionRequest}
                />
                <div className="extension-request-char-count">
                  {extensionRequestReason.length}/500 characters
                </div>
              </div>
            </div>
            <div className="extension-request-modal-footer">
              <button
                className="extension-request-cancel-btn"
                onClick={() => {
                  setShowExtensionRequestModal(false);
                  setExtensionRequestReason('');
                }}
                disabled={submittingExtensionRequest}
              >
                Cancel
              </button>
              <button
                className="extension-request-submit-btn"
                onClick={handleExtensionRequest}
                disabled={submittingExtensionRequest || !extensionRequestReason.trim()}
              >
                {submittingExtensionRequest ? 'Submitting...' : 'Submit Request'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Extension Request Approval Modal */}
      {(() => {
        console.log('üü¢ [MODAL CHECK] showExtensionApprovalModal:', showExtensionApprovalModal);
        console.log('üü¢ [MODAL CHECK] selectedExtensionRequest:', taskAssignmentView.selectedExtensionRequest);
        console.log('üü¢ [MODAL CHECK] Will render modal:', showExtensionApprovalModal && taskAssignmentView.selectedExtensionRequest);
        return null;
      })()}
      {showExtensionApprovalModal && taskAssignmentView.selectedExtensionRequest && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            backdropFilter: 'blur(4px)'
          }}
          onClick={() => setTaskAssignmentView(prev => ({
            ...prev,
            showExtensionApprovalModal: false,
            selectedExtensionRequest: null,
            approvalNewDueDate: '',
            approvalNewAvailableUntil: '',
            approvalLeaderNotes: ''
          }))}
        >
          <div 
            style={{
              backgroundColor: 'white',
              borderRadius: '16px',
              padding: '32px',
              maxWidth: '600px',
              width: '90%',
              maxHeight: '90vh',
              overflow: 'auto',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.4)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              marginBottom: '24px',
              paddingBottom: '16px',
              borderBottom: '2px solid #E5E7EB'
            }}>
              <h2 style={{
                fontSize: '24px',
                fontWeight: '700',
                color: '#09122C',
                margin: 0,
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                <FaCheck style={{ color: '#10B981' }} />
                Approve Extension Request
              </h2>
              <button
                onClick={() => setTaskAssignmentView(prev => ({
                  ...prev,
                  showExtensionApprovalModal: false,
                  selectedExtensionRequest: null,
                  approvalNewDueDate: '',
                  approvalNewAvailableUntil: '',
                  approvalLeaderNotes: ''
                }))}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '28px',
                  color: '#6B7280',
                  cursor: 'pointer',
                  padding: '0',
                  lineHeight: 1
                }}
              >
                √ó
              </button>
            </div>

            {/* Body */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '20px'
            }}>
              {/* Request Info */}
              <div style={{
                padding: '16px',
                backgroundColor: '#F9FAFB',
                borderRadius: '12px',
                border: '1px solid #E5E7EB'
              }}>
                <div style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6' }}>
                  <div style={{ marginBottom: '8px' }}>
                    <strong style={{ color: '#872341' }}>Student:</strong> {taskAssignmentView.selectedExtensionRequest.student_name}
                  </div>
                  <div style={{ marginBottom: '8px' }}>
                    <strong style={{ color: '#872341' }}>Task:</strong> {taskAssignmentView.selectedExtensionRequest.task_title}
                  </div>
                  <div style={{ marginBottom: '8px' }}>
                    <strong style={{ color: '#872341' }}>Original Due:</strong> {dayjs(taskAssignmentView.selectedExtensionRequest.original_due_date).format('MMM DD, YYYY h:mm A')}
                  </div>
                  <div>
                    <strong style={{ color: '#872341' }}>Reason:</strong> {taskAssignmentView.selectedExtensionRequest.reason}
                  </div>
                </div>
              </div>

              {/* Phase Boundaries Warning */}
              {(() => {
                const phase = taskAssignmentView.selectedProject?.project_phases?.find(
                  p => p.id === taskAssignmentView.selectedExtensionRequest.phase_id
                );
                if (phase) {
                  return (
                    <div style={{
                      padding: '12px',
                      backgroundColor: '#FEF3C7',
                      borderRadius: '8px',
                      border: '1px solid #F59E0B',
                      fontSize: '13px',
                      color: '#92400E'
                    }}>
                      <strong>‚ö† Phase Boundaries:</strong> New deadline must be between {dayjs(phase.start_date).format('MMM DD, YYYY')} and {dayjs(phase.end_date).format('MMM DD, YYYY')}
                    </div>
                  );
                }
                return null;
              })()}

              {/* New Due Date */}
              <div>
                <label style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151',
                  marginBottom: '8px'
                }}>
                  New Due Date <span style={{ color: '#EF4444' }}>*</span>
                </label>
                <input
                  type="datetime-local"
                  value={taskAssignmentView.approvalNewDueDate}
                  onChange={(e) => setTaskAssignmentView(prev => ({
                    ...prev,
                    approvalNewDueDate: e.target.value
                  }))}
                  min={(() => {
                    const phase = taskAssignmentView.selectedProject?.project_phases?.find(
                      p => p.id === taskAssignmentView.selectedExtensionRequest.phase_id
                    );
                    return phase ? dayjs(phase.start_date).format('YYYY-MM-DDTHH:mm') : undefined;
                  })()}
                  max={(() => {
                    const phase = taskAssignmentView.selectedProject?.project_phases?.find(
                      p => p.id === taskAssignmentView.selectedExtensionRequest.phase_id
                    );
                    return phase ? dayjs(phase.end_date).format('YYYY-MM-DDTHH:mm') : undefined;
                  })()}
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '14px',
                    color: '#374151'
                  }}
                />
              </div>

              {/* New Available Until */}
              <div>
                <label style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151',
                  marginBottom: '8px'
                }}>
                  New Available Until <span style={{ color: '#9CA3AF', fontSize: '12px', fontWeight: '400' }}>(Optional)</span>
                </label>
                <input
                  type="datetime-local"
                  value={taskAssignmentView.approvalNewAvailableUntil}
                  onChange={(e) => setTaskAssignmentView(prev => ({
                    ...prev,
                    approvalNewAvailableUntil: e.target.value
                  }))}
                  min={(() => {
                    const phase = taskAssignmentView.selectedProject?.project_phases?.find(
                      p => p.id === taskAssignmentView.selectedExtensionRequest.phase_id
                    );
                    return phase ? dayjs(phase.start_date).format('YYYY-MM-DDTHH:mm') : undefined;
                  })()}
                  max={(() => {
                    const phase = taskAssignmentView.selectedProject?.project_phases?.find(
                      p => p.id === taskAssignmentView.selectedExtensionRequest.phase_id
                    );
                    return phase ? dayjs(phase.end_date).format('YYYY-MM-DDTHH:mm') : undefined;
                  })()}
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '14px',
                    color: '#374151'
                  }}
                />
              </div>

              {/* Leader Notes */}
              <div>
                <label style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151',
                  marginBottom: '8px'
                }}>
                  Leader Notes (Optional)
                </label>
                <textarea
                  value={taskAssignmentView.approvalLeaderNotes}
                  onChange={(e) => setTaskAssignmentView(prev => ({
                    ...prev,
                    approvalLeaderNotes: e.target.value
                  }))}
                  placeholder="Add any notes or comments for the student..."
                  rows={3}
                  maxLength={500}
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '14px',
                    color: '#374151',
                    resize: 'vertical',
                    fontFamily: 'inherit'
                  }}
                />
                <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px', textAlign: 'right' }}>
                  {(taskAssignmentView.approvalLeaderNotes || '').length}/500 characters
                </div>
              </div>
            </div>

            {/* Footer */}
            <div style={{
              display: 'flex',
              justifyContent: 'flex-end',
              gap: '12px',
              marginTop: '24px',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }}>
              <button
                onClick={() => setTaskAssignmentView(prev => ({
                  ...prev,
                  showExtensionApprovalModal: false,
                  selectedExtensionRequest: null,
                  approvalNewDueDate: '',
                  approvalNewAvailableUntil: '',
                  approvalLeaderNotes: ''
                }))}
                disabled={taskAssignmentView.submittingExtension}
                style={{
                  padding: '10px 24px',
                  borderRadius: '8px',
                  border: '1px solid #D1D5DB',
                  backgroundColor: 'white',
                  color: '#374151',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleApproveExtension}
                disabled={
                  taskAssignmentView.submittingExtension ||
                  !taskAssignmentView.approvalNewDueDate
                }
                style={{
                  padding: '10px 24px',
                  borderRadius: '8px',
                  border: 'none',
                  backgroundColor: taskAssignmentView.submittingExtension || !taskAssignmentView.approvalNewDueDate ? '#9CA3AF' : '#10B981',
                  color: 'white',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: taskAssignmentView.submittingExtension || !taskAssignmentView.approvalNewDueDate ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                {taskAssignmentView.submittingExtension ? (
                  <>
                    <FaSpinner style={{ animation: 'spin 1s linear infinite' }} />
                    Approving...
                  </>
                ) : (
                  <>
                    <FaCheck />
                    Approve Extension
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Extension Request Rejection Modal */}
      {showExtensionRejectionModal && taskAssignmentView.selectedExtensionRequest && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            backdropFilter: 'blur(4px)'
          }}
          onClick={() => setTaskAssignmentView(prev => ({
            ...prev,
            showExtensionRejectionModal: false,
            selectedExtensionRequest: null,
            rejectionReason: ''
          }))}
        >
          <div 
            style={{
              backgroundColor: 'white',
              borderRadius: '16px',
              padding: '32px',
              maxWidth: '550px',
              width: '90%',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.4)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              marginBottom: '24px',
              paddingBottom: '16px',
              borderBottom: '2px solid #E5E7EB'
            }}>
              <h2 style={{
                fontSize: '24px',
                fontWeight: '700',
                color: '#09122C',
                margin: 0,
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                <FaTimes style={{ color: '#EF4444' }} />
                Reject Extension Request
              </h2>
              <button
                onClick={() => setTaskAssignmentView(prev => ({
                  ...prev,
                  showExtensionRejectionModal: false,
                  selectedExtensionRequest: null,
                  rejectionReason: ''
                }))}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '28px',
                  color: '#6B7280',
                  cursor: 'pointer',
                  padding: '0',
                  lineHeight: 1
                }}
              >
                √ó
              </button>
            </div>

            {/* Body */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '20px'
            }}>
              {/* Request Info */}
              <div style={{
                padding: '16px',
                backgroundColor: '#FEF2F2',
                borderRadius: '12px',
                border: '1px solid #FCA5A5'
              }}>
                <div style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6' }}>
                  <div style={{ marginBottom: '8px' }}>
                    <strong style={{ color: '#872341' }}>Student:</strong> {taskAssignmentView.selectedExtensionRequest.student_name}
                  </div>
                  <div style={{ marginBottom: '8px' }}>
                    <strong style={{ color: '#872341' }}>Task:</strong> {taskAssignmentView.selectedExtensionRequest.task_title}
                  </div>
                  <div>
                    <strong style={{ color: '#872341' }}>Reason:</strong> {taskAssignmentView.selectedExtensionRequest.reason}
                  </div>
                </div>
              </div>

              {/* Rejection Reason */}
              <div>
                <label style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151',
                  marginBottom: '8px'
                }}>
                  Rejection Reason (Optional)
                </label>
                <textarea
                  value={taskAssignmentView.rejectionReason}
                  onChange={(e) => setTaskAssignmentView(prev => ({
                    ...prev,
                    rejectionReason: e.target.value
                  }))}
                  placeholder="Explain why the extension request is being rejected..."
                  rows={4}
                  maxLength={500}
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '14px',
                    color: '#374151',
                    resize: 'vertical',
                    fontFamily: 'inherit'
                  }}
                />
                <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px', textAlign: 'right' }}>
                  {(taskAssignmentView.rejectionReason || '').length}/500 characters
                </div>
              </div>

              {/* Warning */}
              <div style={{
                padding: '12px',
                backgroundColor: '#FEF3C7',
                borderRadius: '8px',
                border: '1px solid #F59E0B',
                fontSize: '13px',
                color: '#92400E'
              }}>
                <strong>‚ö† Warning:</strong> Rejecting this request will notify the student that their extension was not approved.
              </div>
            </div>

            {/* Footer */}
            <div style={{
              display: 'flex',
              justifyContent: 'flex-end',
              gap: '12px',
              marginTop: '24px',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }}>
              <button
                onClick={() => setTaskAssignmentView(prev => ({
                  ...prev,
                  showExtensionRejectionModal: false,
                  selectedExtensionRequest: null,
                  rejectionReason: ''
                }))}
                disabled={taskAssignmentView.submittingExtension}
                style={{
                  padding: '10px 24px',
                  borderRadius: '8px',
                  border: '1px solid #D1D5DB',
                  backgroundColor: 'white',
                  color: '#374151',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleRejectExtension}
                disabled={taskAssignmentView.submittingExtension}
                style={{
                  padding: '10px 24px',
                  borderRadius: '8px',
                  border: 'none',
                  backgroundColor: taskAssignmentView.submittingExtension ? '#9CA3AF' : '#EF4444',
                  color: 'white',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: taskAssignmentView.submittingExtension ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                {taskAssignmentView.submittingExtension ? (
                  <>
                    <FaSpinner style={{ animation: 'spin 1s linear infinite' }} />
                    Rejecting...
                  </>
                ) : (
                  <>
                    <FaTimes />
                    Reject Request
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Project Timeline Modal - Root level rendering for proper z-index */}
      {showProjectPhases && selectedProject && selectedProject.project_phases && (
        <div className="phase-timeline-modal-overlay" onClick={() => setShowProjectPhases(false)} style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.4)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000,
          backdropFilter: 'blur(4px)',
          WebkitBackdropFilter: 'blur(4px)'
        }}>
          <div className="timeline-modal-content-styled" onClick={(e) => e.stopPropagation()} style={{
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            backdropFilter: 'blur(10px) saturate(120%)',
            WebkitBackdropFilter: 'blur(10px) saturate(120%)',
            border: '1px solid rgba(255, 255, 255, 0.3)',
            borderRadius: '12px',
            padding: '2rem',
            maxWidth: '95vw',
            maxHeight: '85vh',
            overflow: 'auto',
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1)',
            position: 'relative',
            zIndex: 10001
          }}>
            {/* Timeline Header */}
            <div className="timeline-header" style={{
              textAlign: 'center',
              marginBottom: '2rem'
            }}>
              <h2 style={{
                fontSize: '1.8rem',
                fontWeight: '600',
                color: '#000',
                margin: 0,
                fontFamily: 'sans-serif'
              }}>Project Timeline</h2>
            </div>

            {/* Timeline Container - Horizontal with Scroll */}
            <div className="timeline-container" style={{
              display: 'flex',
              flexDirection: 'row',
              gap: '1.3rem',
              padding: '2.6rem 1.3rem',
              overflowx: 'auto',
              overflowY: 'hidden',
              alignItems: 'center',
              minHeight: '260px'
            }}>
              {/* PROJECT START */}
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '0.975rem',
                minWidth: '156px',
                flexShrink: 0
              }}>
                <div style={{
                  width: '65px',
                  height: '65px',
                  borderRadius: '50%',
                  backgroundColor: '#f5f5f5',
                  border: '2.6px solid #872341',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '1.69rem'
                }}>
                  <FaCalendarAlt size={26} style={{ color: '#872341' }} />
                </div>
                <div style={{
                  textAlign: 'center'
                }}>
                  <div style={{
                    fontSize: '1.04rem',
                    fontWeight: '600',
                    color: '#000',
                    marginBottom: '0.325rem'
                  }}>
                    Project Start
                  </div>
                  <div style={{
                    fontSize: '0.91rem',
                    color: '#666'
                  }}>
                    {selectedProject.start_date ? dayjs(selectedProject.start_date).format('MMM DD, hh:mm A') : 'TBA'}
                  </div>
                </div>
              </div>

              {/* Horizontal Line */}
              <div style={{
                width: '52px',
                height: '2.6px',
                backgroundColor: '#ddd',
                flexShrink: 0
              }}></div>

              {/* PHASES WITH EVALUATION & BREATHE GAPS */}
              {selectedProject.project_phases
                .sort((a, b) => a.phase_number - b.phase_number)
                .map((phase, index) => {
                  const isActive = currentPhase && currentPhase.id === phase.id && currentPhase.currentPhaseType === 'work';
                  const isLastPhase = index === selectedProject.project_phases.length - 1;
                  const hasEvalDates = phase.evaluation_available_from && phase.evaluation_due_date;
                  
                  return (
                    <div key={phase.id} style={{ display: 'flex', alignItems: 'center', gap: '1.3rem', flexShrink: 0 }}>
                      {/* PHASE */}
                      <div style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        gap: '0.975rem',
                        minWidth: '156px',
                        cursor: 'pointer',
                        opacity: isActive ? 1 : 0.9,
                        transition: 'opacity 0.2s'
                      }} onClick={() => handlePhaseClick(phase)}>
                        <div style={{
                          width: '65px',
                          height: '65px',
                          borderRadius: '50%',
                          backgroundColor: '#872341',
                          border: '2.6px solid #872341',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '1.3rem',
                          fontWeight: '700',
                          color: '#ffffff'
                        }}>
                          {phase.phase_number}
                        </div>
                        <div style={{
                          textAlign: 'center'
                        }}>
                          <div style={{
                            fontSize: '0.975rem',
                            fontWeight: '600',
                            color: '#000',
                            marginBottom: '0.325rem'
                          }}>
                            Phase {phase.phase_number}
                          </div>
                          <div style={{
                            fontSize: '0.845rem',
                            color: '#666',
                            maxWidth: '143px',
                            wordBreak: 'break-word'
                          }}>
                            {dayjs(phase.start_date).format('MMM DD, hh:mm A')} - {dayjs(phase.end_date).format('MMM DD, hh:mm A')}
                          </div>
                          {isActive && (
                            <div style={{
                              fontSize: '0.845rem',
                              color: '#fff',
                              backgroundColor: '#872341',
                              padding: '0.26rem 0.52rem',
                              borderRadius: '2.6px',
                              fontWeight: '600',
                              marginTop: '0.325rem'
                            }}>
                              Active
                            </div>
                          )}
                        </div>
                      </div>

                      {/* EVALUATION PHASE */}
                      {hasEvalDates && (() => {
                        const isEvalActive = currentPhase && currentPhase.id === phase.id && currentPhase.currentPhaseType === 'evaluation';
                        
                        return (
                          <>
                            <div style={{
                              width: '52px',
                              height: '2.6px',
                              backgroundColor: '#ddd',
                              flexShrink: 0
                            }}></div>
                            
                            <div style={{
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              gap: '0.975rem',
                              minWidth: '156px',
                              flexShrink: 0
                            }}>
                              <div style={{
                                width: '65px',
                                height: '65px',
                                borderRadius: '50%',
                                backgroundColor: '#8B5CF6',
                                border: `2.6px solid #8B5CF6`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.43rem',
                                transition: 'all 0.2s',
                                color: '#ffffff'
                              }}>
                                <FaClipboardList size={23.4} style={{ color: '#ffffff' }} />
                              </div>
                              <div style={{
                                textAlign: 'center'
                              }}>
                                <div style={{
                                  fontSize: '0.975rem',
                                  fontWeight: '600',
                                  color: '#000',
                                  marginBottom: '0.325rem'
                                }}>
                                  {isLastPhase && selectedProject.project_evaluation_forms && selectedProject.project_evaluation_forms.length > 0 ? 
                                    'Evaluation / Project Eval' : 
                                    'Evaluation Phase'}
                                </div>
                                <div style={{
                                  fontSize: '0.845rem',
                                  color: '#666',
                                  maxWidth: '143px',
                                  wordBreak: 'break-word'
                                }}>
                                  {dayjs(phase.evaluation_available_from).format('MMM DD, hh:mm A')}
                                </div>
                                <div style={{
                                  fontSize: '0.75rem',
                                  color: '#999',
                                  marginTop: '0.2rem'
                                }}>
                                  to {dayjs(phase.evaluation_due_date).format('MMM DD, hh:mm A')}
                                </div>
                                {isEvalActive && (
                                  <div style={{
                                    fontSize: '0.845rem',
                                    color: '#fff',
                                    backgroundColor: '#8B5CF6',
                                    padding: '0.26rem 0.52rem',
                                    borderRadius: '2.6px',
                                    fontWeight: '600',
                                    marginTop: '0.325rem'
                                  }}>
                                    Active
                                  </div>
                                )}
                              </div>
                            </div>
                          </>
                        );
                      })()}

                      {/* BREATHE PHASE */}
                      {(selectedProject.breathe_phase_days > 0 || phase.breathe_start_date) && (() => {
                        const isBreatheActive = currentPhase && currentPhase.id === phase.id && currentPhase.currentPhaseType === 'breathe';
                        
                        return (
                          <>
                            <div style={{
                              width: '52px',
                              height: '2.6px',
                              backgroundColor: '#ddd',
                              flexShrink: 0
                            }}></div>
                            <div style={{
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              gap: '0.975rem',
                              minWidth: '156px',
                              flexShrink: 0
                            }}>
                              <div style={{
                                width: '65px',
                                height: '65px',
                                borderRadius: '50%',
                                backgroundColor: '#10B981',
                                border: `2.6px solid #10B981`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.43rem',
                                transition: 'all 0.2s',
                                color: '#ffffff'
                              }}>
                                <FaPause size={23.4} style={{ color: '#ffffff' }} />
                              </div>
                              <div style={{
                                textAlign: 'center'
                              }}>
                                <div style={{
                                  fontSize: '0.975rem',
                                  fontWeight: '600',
                                  color: '#000',
                                  marginBottom: '0.325rem'
                                }}>
                                  Breathe
                                </div>
                                <div style={{
                                  fontSize: '0.845rem',
                                  color: '#666',
                                  maxWidth: '143px',
                                  wordBreak: 'break-word'
                                }}>
                                  {phase.breathe_start_date && phase.breathe_end_date ? (
                                    <>
                                      {dayjs(phase.breathe_start_date).format('MMM DD, hh:mm A')}
                                      <div style={{ fontSize: '0.75rem', color: '#999', marginTop: '0.2rem' }}>
                                        to {dayjs(phase.breathe_end_date).format('MMM DD, hh:mm A')}
                                      </div>
                                    </>
                                  ) : (
                                    `${selectedProject.breathe_phase_days || phase.breathe_duration_days || 0}d`
                                  )}
                                </div>
                                {isBreatheActive && (
                                  <div style={{
                                    fontSize: '0.845rem',
                                    color: '#fff',
                                    backgroundColor: '#10B981',
                                    padding: '0.26rem 0.52rem',
                                    borderRadius: '2.6px',
                                    fontWeight: '600',
                                    marginTop: '0.325rem'
                                  }}>
                                    Active
                                  </div>
                                )}
                              </div>
                            </div>
                            {!isLastPhase && (
                              <div style={{
                                width: '52px',
                                height: '2.6px',
                                backgroundColor: '#ddd',
                                flexShrink: 0
                              }}></div>
                            )}
                          </>
                        );
                      })()}

                      {isLastPhase && (selectedProject.breathe_phase_days > 0 || hasEvalDates) && (
                        <div style={{
                          width: '52px',
                          height: '2.6px',
                          backgroundColor: '#ddd',
                          flexShrink: 0
                        }}></div>
                      )}
                    </div>
                  );
                })}

              {/* PROJECT END */}
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '0.975rem',
                minWidth: '156px',
                flexShrink: 0
              }}>
                <div style={{
                  width: '65px',
                  height: '65px',
                  borderRadius: '50%',
                  backgroundColor: '#f5f5f5',
                  border: '2.6px solid #872341',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '1.43rem'
                }}>
                  <FaCheckCircle size={23.4} style={{ color: '#872341' }} />
                </div>
                <div style={{
                  textAlign: 'center'
                }}>
                  <div style={{
                    fontSize: '0.975rem',
                    fontWeight: '600',
                    color: '#000',
                    marginBottom: '0.325rem'
                  }}>
                    Project End
                  </div>
                  <div style={{
                    fontSize: '0.845rem',
                    color: '#666'
                  }}>
                    {selectedProject.due_date ? dayjs(selectedProject.due_date).format('MMM DD, hh:mm A') : 'TBA'}
                  </div>
                </div>
              </div>
            </div>

            {/* Close Button */}
            <button 
              onClick={() => setShowProjectPhases(false)}
              style={{
                position: 'absolute',
                top: '1rem',
                right: '1rem',
                backgroundColor: 'transparent',
                border: 'none',
                fontSize: '1.5rem',
                cursor: 'pointer',
                color: '#666',
                padding: '0.5rem'
              }}
            >
              <FaTimes />
            </button>
          </div>
        </div>
      )}

      {/* Revision Modal */}
      <RevisionModal
        key={`${selectedRevisionTask?.id || 'revision-modal'}-${selectedRevisionSubmissionId || 'no-submission'}`}
        isOpen={showRevisionModal}
        onClose={() => {
          setShowRevisionModal(false);
          setSelectedRevisionTask(null);
          setSelectedRevisionSubmissionId(null);
          setSelectedPhase(null);
        }}
        task={selectedRevisionTask}
        originalSubmissionId={selectedRevisionSubmissionId}
        project={selectedProject}
        phase={selectedPhase}
        onTaskSubmitted={async () => {
          // Refresh all data to update revision status
          if (selectedProject) {
            // Add a small delay to ensure database consistency
            setTimeout(async () => {
              await refreshData('revision-submission');
            }, 500);
          }
        }}
      />

      {/* Completed Task Modal */}
      <CompletedTaskModal
        key={selectedCompletedTask?.id || 'completed-modal'}
        isOpen={showCompletedModal}
        onClose={() => {
          setShowCompletedModal(false);
          setSelectedCompletedTask(null);
          setSelectedPhase(null);
        }}
        task={selectedCompletedTask}
        project={selectedProject}
        phase={selectedPhase}
        source="completed"
      />

      {/* Evaluation Modal */}
      <EvaluationModal
        isOpen={showEvaluationModal}
        onClose={() => {
          setShowEvaluationModal(false);
          setSelectedEvaluation(null);
          setSelectedPhase(null);
          // ‚úÖ FIX: Refetch ALL evaluation submissions after modal closes (both phase and project)
          if (selectedProject?.group_id) {
            console.log('üîÑ [PHASE EVAL MODAL CLOSE] Refetching ALL submissions');
            fetchMyEvaluationSubmissions(selectedProject.group_id, null, null); // Fetch all submissions
          }
        }}
        evaluation={selectedEvaluation}
        project={selectedProject}
        phase={selectedPhase}
        groupData={groupData}
        currentUser={userProfile}
        onEvaluationSubmitted={async (evaluationId) => {
          console.log('‚úÖ [PARENT] Evaluation submitted:', evaluationId);
          // Refresh evaluation submissions after successful submission with a delay
          const phaseToUse = viewedPhase || currentPhase;
          // First try selectedEvaluation.group_id, then groupData.id, then groupData.group_id
          const groupIdToEvaluate = selectedEvaluation?.group_id || groupData?.id || groupData?.group_id;
          console.log('üîÑ [PARENT] Callback triggered - phaseToUse:', phaseToUse?.id, 'groupIdToEvaluate:', groupIdToEvaluate);
          
          if (groupIdToEvaluate && phaseToUse?.id) {
            // First, update the local state immediately to show the submission
            setMyEvaluationSubmissions(prevSubmissions => {
              const existingIndex = prevSubmissions.findIndex(
                sub => sub.phase_id === phaseToUse.id && sub.type === 'phase_evaluation'
              );
              
              if (existingIndex >= 0) {
                // Update existing submission
                const updated = [...prevSubmissions];
                updated[existingIndex] = {
                  ...updated[existingIndex],
                  status: 'submitted',
                  submission_date: new Date().toISOString()
                };
                return updated;
              } else {
                // Add new submission
                return [
                  ...prevSubmissions,
                  {
                    id: evaluationId,
                    phase_id: phaseToUse.id,
                    type: 'phase_evaluation',
                    status: 'submitted',
                    submission_date: new Date().toISOString(),
                    // Add other required fields if needed
                  }
                ];
              }
            });

            // Then fetch the latest data from the server after a delay
            setTimeout(async () => {
              console.log('üîÑ [PARENT] Fetching ALL updated submissions after 2s delay for phase:', phaseToUse.id, 'group:', groupIdToEvaluate);
              await fetchMyEvaluationSubmissions(groupIdToEvaluate, null, null); // ‚úÖ FIX: Fetch ALL submissions (both phase and project)
              
              // Force a re-render of the phase evaluation card
              setSelectedEvaluation(prev => prev ? { ...prev } : null);
            }, 2000);
          } else {
            console.warn('‚ö†Ô∏è [PARENT] Missing required data - groupIdToEvaluate:', groupIdToEvaluate, 'phase_id:', phaseToUse?.id);
            console.log('üîç [DEBUG] selectedEvaluation:', selectedEvaluation);
            console.log('üîç [DEBUG] groupData:', groupData);
          }
        }}
      />

      {/* Project Evaluation Modal */}
      <ProjectEvaluationModal
        isOpen={showProjectEvalModal}
        onClose={() => {
          setShowProjectEvalModal(false);
          setSelectedProjectEvaluation(null);
          // ‚úÖ FIX: Refetch ALL evaluation submissions after modal closes (both phase and project)
          if (selectedProject?.group_id) {
            console.log('üîÑ [PROJECT EVAL MODAL CLOSE] Refetching ALL submissions');
            fetchMyEvaluationSubmissions(selectedProject.group_id, null, null); // Fetch all submissions
          }
        }}
        evaluation={selectedProjectEvaluation}
        project={selectedProject}
        groupData={groupData}
        currentUser={userProfile}
      />

      {/* Evaluation Detail Modal (for Evaluations tab) */}
      <EvaluationDetailModal
        isOpen={showEvaluationDetailModal}
        onClose={() => {
          setShowEvaluationDetailModal(false);
          setSelectedEvaluationDetail(null);
        }}
        evaluation={selectedEvaluationDetail}
      />

      {/* Phase Rubric Modal */}
      {showPhaseRubricModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 10000,
          padding: '20px'
        }}>
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '800px',
            width: '100%',
            maxHeight: '90vh',
            overflowY: 'auto',
            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.2)'
          }}>
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'sticky',
              top: 0,
              backgroundColor: 'white',
              zIndex: 1
            }}>
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                {currentRubricPhase 
                  ? `Phase ${currentRubricPhase.phase_number}: ${currentRubricPhase.title || 'Rubric'}` 
                  : 'Phase Rubric'}
              </h2>
              <button
                onClick={() => {
                  setShowPhaseRubricModal(false);
                  setPhaseRubricData(null);
                  setCurrentRubricPhase(null);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6B7280',
                  padding: '0',
                  width: '32px',
                  height: '32px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '6px',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#F3F4F6';
                  e.target.style.color = '#111827';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = 'transparent';
                  e.target.style.color = '#6B7280';
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Content */}
            <div style={{ padding: '24px' }}>
              {rubricLoading ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <FaSpinner className="fa-spin" style={{ fontSize: '32px', color: '#34656D' }} />
                  <p style={{ marginTop: '16px', color: '#6B7280' }}>Loading rubric...</p>
                </div>
              ) : phaseRubricData?.error ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <FaExclamationCircle style={{ fontSize: '48px', color: '#DC2626', marginBottom: '16px' }} />
                  <p style={{ color: '#6B7280', fontSize: '16px' }}>
                    {phaseRubricData.error === 'not_found' 
                      ? 'No rubric found for this phase.' 
                      : 'Failed to load rubric.'}
                  </p>
                </div>
              ) : phaseRubricData?.is_custom ? (
                // Custom Rubric - Display PDF/File
                <div>
                  <div style={{
                    padding: '16px',
                    backgroundColor: '#F0F9FF',
                    border: '1px solid #BFDBFE',
                    borderRadius: '8px',
                    marginBottom: '16px'
                  }}>
                    <p style={{ margin: 0, color: '#1E40AF', fontSize: '14px', fontWeight: '500' }}>
                      <FaFileAlt style={{ marginRight: '8px' }} />
                      Custom Rubric File
                    </p>
                  </div>
                  {phaseRubricData.file_url ? (
                    <div style={{ marginTop: '16px' }}>
                      <iframe
                        src={phaseRubricData.file_url}
                        style={{
                          width: '100%',
                          height: '600px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px'
                        }}
                        title="Phase Rubric"
                      />
                      <a
                        href={phaseRubricData.file_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginTop: '16px',
                          padding: '12px 20px',
                          backgroundColor: '#34656D',
                          color: 'white',
                          textDecoration: 'none',
                          borderRadius: '8px',
                          fontWeight: '600',
                          fontSize: '14px'
                        }}
                      >
                        <FaDownload /> Download Rubric
                      </a>
                    </div>
                  ) : (
                    <p style={{ color: '#6B7280' }}>No file available</p>
                  )}
                </div>
              ) : phaseRubricData?.criteria ? (
                // Built-in Rubric - Display Criteria
                <div>
                  <div style={{
                    padding: '16px',
                    backgroundColor: '#F0FDF4',
                    border: '1px solid #BBF7D0',
                    borderRadius: '8px',
                    marginBottom: '16px'
                  }}>
                    <p style={{ margin: 0, color: '#15803D', fontSize: '14px', fontWeight: '500' }}>
                      Total Points: {phaseRubricData.total_points || 100}
                    </p>
                  </div>
                  {phaseRubricData.instructions && (
                    <div style={{
                      padding: '16px',
                      backgroundColor: '#F9FAFB',
                      borderRadius: '8px',
                      marginBottom: '20px',
                      fontSize: '14px',
                      color: '#374151'
                    }}>
                      {phaseRubricData.instructions}
                    </div>
                  )}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {phaseRubricData.criteria.map((criterion, index) => (
                      <div
                        key={criterion.id || index}
                        style={{
                          padding: '16px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          backgroundColor: '#FAFAFA'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          marginBottom: '8px'
                        }}>
                          <h4 style={{
                            margin: 0,
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#111827'
                          }}>
                            {criterion.name}
                          </h4>
                          <span style={{
                            padding: '4px 12px',
                            backgroundColor: '#34656D',
                            color: 'white',
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: '600'
                          }}>
                            {criterion.max_points} pts
                          </span>
                        </div>
                        {criterion.description && (
                          <p style={{
                            margin: 0,
                            fontSize: '14px',
                            color: '#6B7280',
                            lineHeight: '1.6'
                          }}>
                            {criterion.description}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <p style={{ color: '#6B7280' }}>No rubric data available</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Phase Evaluation Form Modal */}
      {showPhaseEvalFormModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 10000,
          padding: '20px'
        }}>
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '800px',
            width: '100%',
            maxHeight: '90vh',
            overflowY: 'auto',
            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.2)'
          }}>
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              position: 'sticky',
              top: 0,
              backgroundColor: 'white',
              zIndex: 1
            }}>
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                {currentEvalFormPhase 
                  ? `Phase ${currentEvalFormPhase.phase_number}: Evaluation Form` 
                  : 'Phase Evaluation Form'}
              </h2>
              <button
                onClick={() => {
                  setShowPhaseEvalFormModal(false);
                  setPhaseEvalFormData(null);
                  setCurrentEvalFormPhase(null);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#6B7280',
                  padding: '0',
                  width: '32px',
                  height: '32px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '6px',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = '#F3F4F6';
                  e.target.style.color = '#111827';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = 'transparent';
                  e.target.style.color = '#6B7280';
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Content */}
            <div style={{ padding: '24px' }}>
              {evalFormLoading ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <FaSpinner className="fa-spin" style={{ fontSize: '32px', color: '#34656D' }} />
                  <p style={{ marginTop: '16px', color: '#6B7280' }}>Loading evaluation form...</p>
                </div>
              ) : phaseEvalFormData?.error ? (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <FaExclamationCircle style={{ fontSize: '48px', color: '#DC2626', marginBottom: '16px' }} />
                  <p style={{ color: '#6B7280', fontSize: '16px' }}>
                    {phaseEvalFormData.error === 'not_found' 
                      ? 'No evaluation form found for this phase.' 
                      : 'Failed to load evaluation form.'}
                  </p>
                </div>
              ) : phaseEvalFormData?.is_custom ? (
                // Custom Evaluation Form - Display PDF/File
                <div>
                  <div style={{
                    padding: '16px',
                    backgroundColor: '#F0F9FF',
                    border: '1px solid #BFDBFE',
                    borderRadius: '8px',
                    marginBottom: '16px'
                  }}>
                    <p style={{ margin: 0, color: '#1E40AF', fontSize: '14px', fontWeight: '500' }}>
                      <FaFileAlt style={{ marginRight: '8px' }} />
                      Custom Evaluation Form
                    </p>
                  </div>
                  {phaseEvalFormData.custom_file_url ? (
                    <div style={{ marginTop: '16px' }}>
                      <iframe
                        src={phaseEvalFormData.custom_file_url}
                        style={{
                          width: '100%',
                          height: '600px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px'
                        }}
                        title="Phase Evaluation Form"
                      />
                      <a
                        href={phaseEvalFormData.custom_file_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginTop: '16px',
                          padding: '12px 20px',
                          backgroundColor: '#34656D',
                          color: 'white',
                          textDecoration: 'none',
                          borderRadius: '8px',
                          fontWeight: '600',
                          fontSize: '14px'
                        }}
                      >
                        <FaDownload /> Download Form
                      </a>
                    </div>
                  ) : (
                    <p style={{ color: '#6B7280' }}>No file available</p>
                  )}
                </div>
              ) : phaseEvalFormData?.criteria ? (
                // Built-in Evaluation Form - Display Criteria
                <div>
                  <div style={{
                    padding: '16px',
                    backgroundColor: '#F0FDF4',
                    border: '1px solid #BBF7D0',
                    borderRadius: '8px',
                    marginBottom: '16px'
                  }}>
                    <p style={{ margin: 0, color: '#15803D', fontSize: '14px', fontWeight: '500' }}>
                      Total Points: {phaseEvalFormData.total_points || 100}
                    </p>
                  </div>
                  {phaseEvalFormData.instructions && (
                    <div style={{
                      padding: '16px',
                      backgroundColor: '#F9FAFB',
                      borderRadius: '8px',
                      marginBottom: '20px',
                      fontSize: '14px',
                      color: '#374151'
                    }}>
                      {phaseEvalFormData.instructions}
                    </div>
                  )}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {phaseEvalFormData.criteria.map((criterion, index) => (
                      <div
                        key={criterion.id || index}
                        style={{
                          padding: '16px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          backgroundColor: '#FAFAFA'
                        }}
                      >
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          marginBottom: '8px'
                        }}>
                          <h4 style={{
                            margin: 0,
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#111827'
                          }}>
                            {criterion.name}
                          </h4>
                          <span style={{
                            padding: '4px 12px',
                            backgroundColor: '#34656D',
                            color: 'white',
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: '600'
                          }}>
                            {criterion.max_points} pts
                          </span>
                        </div>
                        {criterion.description && (
                          <p style={{
                            margin: 0,
                            fontSize: '14px',
                            color: '#6B7280',
                            lineHeight: '1.6'
                          }}>
                            {criterion.description}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div style={{ textAlign: 'center', padding: '40px' }}>
                  <p style={{ color: '#6B7280' }}>No evaluation form data available</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Project Details Modal */}
      {showProjectDetailsModal && selectedGanttProject && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px'
          }}
          onClick={() => setShowProjectDetailsModal(false)}
        >
          <div
            style={{
              backgroundColor: 'white',
              borderRadius: '16px',
              maxWidth: '700px',
              width: '100%',
              maxHeight: '90vh',
              overflow: 'auto',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'flex-start',
              position: 'sticky',
              top: 0,
              backgroundColor: 'white',
              borderRadius: '16px 16px 0 0',
              zIndex: 1
            }}>
              <div style={{ flex: 1 }}>
                <h2 style={{
                  margin: 0,
                  fontSize: '24px',
                  fontWeight: '700',
                  color: '#111827',
                  marginBottom: '8px'
                }}>
                  {selectedGanttProject.title}
                </h2>
                <div style={{
                  display: 'flex',
                  gap: '12px',
                  flexWrap: 'wrap'
                }}>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    padding: '4px 12px',
                    borderRadius: '6px',
                    backgroundColor: '#10B981',
                    color: 'white'
                  }}>
                    Start: {new Date(selectedGanttProject.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    padding: '4px 12px',
                    borderRadius: '6px',
                    backgroundColor: '#EF4444',
                    color: 'white'
                  }}>
                    End: {new Date(selectedGanttProject.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                </div>
              </div>
              <button
                onClick={() => setShowProjectDetailsModal(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '28px',
                  color: '#6B7280',
                  cursor: 'pointer',
                  padding: '0',
                  width: '32px',
                  height: '32px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '8px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#F3F4F6';
                  e.currentTarget.style.color = '#111827';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.color = '#6B7280';
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {/* Description Section */}
              {selectedGanttProject.description && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: '#111827',
                    marginBottom: '8px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Description
                  </h3>
                  <p style={{
                    fontSize: '14px',
                    color: '#6B7280',
                    lineHeight: '1.6',
                    margin: 0
                  }}>
                    {selectedGanttProject.description}
                  </p>
                </div>
              )}

              {/* Timeline Info */}
              <div style={{ marginBottom: '24px' }}>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: '700',
                  color: '#111827',
                  marginBottom: '12px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Timeline
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '12px'
                }}>
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px',
                    border: '1px solid #E5E7EB'
                  }}>
                    <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>
                      Duration
                    </div>
                    <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827' }}>
                      {Math.ceil((new Date(selectedGanttProject.due_date) - new Date(selectedGanttProject.start_date)) / (1000 * 60 * 60 * 24))} days
                    </div>
                  </div>
                  {selectedGanttProject.breathe_phase_days > 0 && (
                    <div style={{
                      padding: '12px',
                      backgroundColor: '#FEF3C7',
                      borderRadius: '8px',
                      border: '1px solid #FDE68A'
                    }}>
                      <div style={{ fontSize: '12px', color: '#92400E', marginBottom: '4px' }}>
                        Breathe Phase
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: '700', color: '#92400E' }}>
                        {selectedGanttProject.breathe_phase_days} days
                      </div>
                    </div>
                  )}
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px',
                    border: '1px solid #E5E7EB'
                  }}>
                    <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>
                      Total Phases
                    </div>
                    <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827' }}>
                      {selectedGanttProject.project_phases?.length || 0}
                    </div>
                  </div>
                </div>
              </div>

              {/* Requirements Section */}
              <div style={{ marginBottom: '24px' }}>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: '700',
                  color: '#111827',
                  marginBottom: '12px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Requirements
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <span style={{ fontSize: '14px', color: '#6B7280' }}>Min Tasks per Member</span>
                    <span style={{ fontSize: '14px', fontWeight: '700', color: '#111827' }}>
                      {selectedGanttProject.min_tasks_per_member || 'Not set'}
                    </span>
                  </div>
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <span style={{ fontSize: '14px', color: '#6B7280' }}>Max Tasks per Member</span>
                    <span style={{ fontSize: '14px', fontWeight: '700', color: '#111827' }}>
                      {selectedGanttProject.max_tasks_per_member || 'Not set'}
                    </span>
                  </div>
                  {selectedGanttProject.file_types_allowed && (
                    <div style={{
                      padding: '12px',
                      backgroundColor: '#F9FAFB',
                      borderRadius: '8px'
                    }}>
                      <div style={{ fontSize: '14px', color: '#6B7280', marginBottom: '6px' }}>
                        Allowed File Types
                      </div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                        {selectedGanttProject.file_types_allowed}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Evaluation Section */}
              {(selectedGanttProject.rubric_file_url || selectedGanttProject.evaluation_form_type) && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: '#111827',
                    marginBottom: '12px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Evaluation
                  </h3>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {selectedGanttProject.rubric_file_url && (
                      <div style={{
                        padding: '12px',
                        backgroundColor: '#EFF6FF',
                        borderRadius: '8px',
                        border: '1px solid #DBEAFE'
                      }}>
                        <div style={{ fontSize: '12px', color: '#1E40AF', marginBottom: '4px' }}>
                          Rubric Available
                        </div>
                        <a
                          href={selectedGanttProject.rubric_file_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#2563EB',
                            textDecoration: 'none'
                          }}
                        >
                          View Rubric ‚Üí
                        </a>
                      </div>
                    )}
                    {selectedGanttProject.evaluation_form_type && (
                      <div style={{
                        padding: '12px',
                        backgroundColor: '#F9FAFB',
                        borderRadius: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                      }}>
                        <span style={{ fontSize: '14px', color: '#6B7280' }}>Evaluation Form</span>
                        <span style={{ fontSize: '14px', fontWeight: '700', color: '#111827', textTransform: 'capitalize' }}>
                          {selectedGanttProject.evaluation_form_type}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Phase Details Modal */}
      {showPhaseDetailsModal && selectedModalPhase && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px'
          }}
          onClick={() => {
            setShowPhaseDetailsModal(false);
            setSelectedModalPhase(null);
          }}
        >
          <div
            style={{
              backgroundColor: 'white',
              borderRadius: '16px',
              maxWidth: '600px',
              width: '100%',
              maxHeight: '90vh',
              overflow: 'auto',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'flex-start',
              position: 'sticky',
              top: 0,
              backgroundColor: 'white',
              borderRadius: '16px 16px 0 0',
              zIndex: 1
            }}>
              <div style={{ flex: 1 }}>
                <div style={{
                  display: 'inline-block',
                  padding: '4px 12px',
                  borderRadius: '6px',
                  backgroundColor: `hsl(${((selectedModalPhase.phase_number - 1) * 60) % 360}, 70%, 55%)`,
                  color: 'white',
                  fontSize: '12px',
                  fontWeight: '700',
                  marginBottom: '12px'
                }}>
                  PHASE {selectedModalPhase.phase_number}
                </div>
                <h2 style={{
                  margin: 0,
                  fontSize: '24px',
                  fontWeight: '700',
                  color: '#111827',
                  marginBottom: '8px'
                }}>
                  {selectedModalPhase.title}
                </h2>
                <div style={{
                  display: 'flex',
                  gap: '12px',
                  flexWrap: 'wrap'
                }}>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    padding: '4px 12px',
                    borderRadius: '6px',
                    backgroundColor: '#10B981',
                    color: 'white'
                  }}>
                    Start: {new Date(selectedModalPhase.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    padding: '4px 12px',
                    borderRadius: '6px',
                    backgroundColor: '#EF4444',
                    color: 'white'
                  }}>
                    End: {new Date(selectedModalPhase.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                </div>
              </div>
              <button
                onClick={() => {
                  setShowPhaseDetailsModal(false);
                  setSelectedModalPhase(null);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '28px',
                  color: '#6B7280',
                  cursor: 'pointer',
                  padding: '0',
                  width: '32px',
                  height: '32px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '8px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#F3F4F6';
                  e.currentTarget.style.color = '#111827';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.color = '#6B7280';
                }}
              >
                √ó
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {/* Description Section */}
              {selectedModalPhase.description && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: '#111827',
                    marginBottom: '8px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Description
                  </h3>
                  <p style={{
                    fontSize: '14px',
                    color: '#6B7280',
                    lineHeight: '1.6',
                    margin: 0
                  }}>
                    {selectedModalPhase.description}
                  </p>
                </div>
              )}

              {/* Timeline Info */}
              <div style={{ marginBottom: '24px' }}>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: '700',
                  color: '#111827',
                  marginBottom: '12px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Timeline
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                  gap: '12px'
                }}>
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px',
                    border: '1px solid #E5E7EB'
                  }}>
                    <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>
                      Duration
                    </div>
                    <div style={{ fontSize: '16px', fontWeight: '700', color: '#111827' }}>
                      {Math.ceil((new Date(selectedModalPhase.end_date) - new Date(selectedModalPhase.start_date)) / (1000 * 60 * 60 * 24))} days
                    </div>
                  </div>
                  {selectedModalPhase.max_attempts && (
                    <div style={{
                      padding: '12px',
                      backgroundColor: '#FEF3C7',
                      borderRadius: '8px',
                      border: '1px solid #FDE68A'
                    }}>
                      <div style={{ fontSize: '12px', color: '#92400E', marginBottom: '4px' }}>
                        Max Attempts
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: '700', color: '#92400E' }}>
                        {selectedModalPhase.max_attempts}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Requirements Section */}
              {selectedModalPhase.file_types_allowed && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: '#111827',
                    marginBottom: '12px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Requirements
                  </h3>
                  <div style={{
                    padding: '12px',
                    backgroundColor: '#F9FAFB',
                    borderRadius: '8px'
                  }}>
                    <div style={{ fontSize: '14px', color: '#6B7280', marginBottom: '6px' }}>
                      Allowed File Types
                    </div>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      {selectedModalPhase.file_types_allowed}
                    </div>
                  </div>
                </div>
              )}

              {/* Evaluation Section */}
              {(selectedModalPhase.rubric_file_url || selectedModalPhase.evaluation_form_type) && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: '#111827',
                    marginBottom: '12px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Evaluation
                  </h3>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {selectedModalPhase.rubric_file_url && (
                      <div style={{
                        padding: '12px',
                        backgroundColor: '#EFF6FF',
                        borderRadius: '8px',
                        border: '1px solid #DBEAFE'
                      }}>
                        <div style={{ fontSize: '12px', color: '#1E40AF', marginBottom: '4px' }}>
                          Rubric Available
                        </div>
                        <a
                          href={selectedModalPhase.rubric_file_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#2563EB',
                            textDecoration: 'none'
                          }}
                        >
                          View Rubric ‚Üí
                        </a>
                      </div>
                    )}
                    {selectedModalPhase.evaluation_form_type && (
                      <div style={{ 
                        padding: '12px',
                        backgroundColor: '#F9FAFB',
                        borderRadius: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                      }}>
                        <span style={{ fontSize: '14px', color: '#6B7280' }}>Evaluation Form</span>
                        <span style={{ fontSize: '14px', fontWeight: '700', color: '#111827', textTransform: 'capitalize' }}>
                          {selectedModalPhase.evaluation_form_type}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Project Rubric Modal */}
      {showProjectRubricModal && (selectedReportsProject || deliverablesView.selectedProject) && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(9, 18, 44, 0.75)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000,
          padding: '20px'
        }}
        onClick={() => setShowProjectRubricModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '800px',
            width: '100%',
            maxHeight: '90vh',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '0 20px 25px -5px rgba(9, 18, 44, 0.3), 0 10px 10px -5px rgba(135, 35, 65, 0.2)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              backgroundColor: '#ffffff',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              borderTopLeftRadius: '12px',
              borderTopRightRadius: '12px'
            }}>
              <h2 style={{
                fontSize: '24px',
                fontWeight: '700',
                color: '#09122C',
                margin: 0,
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                <FaClipboardList style={{ color: '#872341' }} />
                Project Rubric - {(selectedReportsProject || deliverablesView.selectedProject)?.title}
              </h2>
              <button
                onClick={() => setShowProjectRubricModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  color: '#872341',
                  cursor: 'pointer',
                  padding: '8px',
                  width: '40px',
                  height: '40px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '8px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#BE3144';
                  e.currentTarget.style.color = '#ffffff';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.color = '#872341';
                }}
              >
                <FaTimes />
              </button>
            </div>

            {/* Modal Content */}
            <div style={{
              padding: '24px',
              overflowY: 'auto',
              flex: 1,
              backgroundColor: '#F9FAFB'
            }}>
              {projectRubricData ? (
                <div style={{
                  backgroundColor: 'white',
                  borderRadius: '8px',
                  padding: '24px',
                  border: '2px solid rgba(135, 35, 65, 0.15)'
                }}>
                  {/* Instructions */}
                  {projectRubricData.instructions && (
                    <div style={{
                      backgroundColor: 'rgba(225, 117, 100, 0.1)',
                      border: '2px solid rgba(225, 117, 100, 0.3)',
                      borderRadius: '8px',
                      padding: '16px',
                      marginBottom: '20px'
                    }}>
                      <h4 style={{
                        fontSize: '15px',
                        fontWeight: '700',
                        color: '#872341',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <FaInfoCircle style={{ color: '#BE3144' }} />
                        Instructions
                      </h4>
                      <p style={{
                        fontSize: '15px',
                        color: '#09122C',
                        margin: 0,
                        lineHeight: '1.7',
                        fontWeight: '500'
                      }}>
                        {projectRubricData.instructions}
                      </p>
                    </div>
                  )}

                  {/* Total Points */}
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '24px',
                    padding: '16px 20px',
                    backgroundColor: '#09122C',
                    borderRadius: '10px',
                    border: '2px solid #872341'
                  }}>
                    <span style={{
                      fontSize: '18px',
                      fontWeight: '700',
                      color: '#ffffff',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      <FaStar style={{ color: '#E17564' }} />
                      Total Points:
                    </span>
                    <span style={{
                      fontSize: '28px',
                      fontWeight: '700',
                      color: '#ffffff'
                    }}>
                      {projectRubricData.total_points}
                    </span>
                  </div>

                  {/* Rubric Criteria */}
                  <h3 style={{
                    fontSize: '20px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '20px',
                    paddingBottom: '12px',
                    borderBottom: '2px solid rgba(135, 35, 65, 0.2)'
                  }}>
                    Evaluation Criteria
                  </h3>
                  
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '16px'
                  }}>
                    {projectRubricData.criteria && projectRubricData.criteria.length > 0 ? (
                      projectRubricData.criteria
                        .sort((a, b) => a.order_index - b.order_index)
                        .map((criterion, index) => (
                          <div
                            key={criterion.id}
                            style={{
                              backgroundColor: 'rgba(9, 18, 44, 0.03)',
                              padding: '20px',
                              borderRadius: '10px',
                              border: '2px solid rgba(135, 35, 65, 0.2)',
                              transition: 'all 0.3s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.boxShadow = '0 8px 16px rgba(135, 35, 65, 0.2)';
                              e.currentTarget.style.borderColor = '#872341';
                              e.currentTarget.style.transform = 'translateY(-2px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.boxShadow = 'none';
                              e.currentTarget.style.borderColor = 'rgba(135, 35, 65, 0.2)';
                              e.currentTarget.style.transform = 'translateY(0)';
                            }}
                          >
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'flex-start',
                              marginBottom: '12px'
                            }}>
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                flex: 1
                              }}>
                                <span style={{
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  width: '36px',
                                  height: '36px',
                                  backgroundColor: '#872341',
                                  color: 'white',
                                  borderRadius: '50%',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  flexShrink: 0,
                                  border: '2px solid #BE3144'
                                }}>
                                  {index + 1}
                                </span>
                                <h4 style={{
                                  fontSize: '18px',
                                  fontWeight: '700',
                                  color: '#09122C',
                                  margin: 0
                                }}>
                                  {criterion.name}
                                </h4>
                              </div>
                              <span style={{
                                display: 'inline-block',
                                padding: '8px 16px',
                                backgroundColor: '#BE3144',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '14px',
                                fontWeight: '700',
                                flexShrink: 0,
                                marginLeft: '12px',
                                border: '2px solid #872341'
                              }}>
                                {criterion.max_points} pts
                              </span>
                            </div>
                            <p style={{
                              fontSize: '15px',
                              color: '#09122C',
                              margin: 0,
                              lineHeight: '1.7',
                              paddingLeft: '48px',
                              fontWeight: '500'
                            }}>
                              {criterion.description}
                            </p>
                          </div>
                        ))
                    ) : (
                      <div style={{
                        textAlign: 'center',
                        padding: '40px',
                        color: '#872341',
                        fontSize: '16px',
                        fontWeight: '600'
                      }}>
                        No criteria available
                      </div>
                    )}
                  </div>
                </div>
              ) : projectRubricData?.error === 'not_found' ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  textAlign: 'center'
                }}>
                  <div style={{
                    marginBottom: '24px',
                    color: '#872341'
                  }}>
                    <FaClipboardList size={64} />
                  </div>
                  <h3 style={{
                    fontSize: '22px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '12px'
                  }}>
                    No Rubric Available
                  </h3>
                  <p style={{
                    fontSize: '15px',
                    color: '#872341',
                    margin: 0,
                    maxWidth: '400px',
                    lineHeight: '1.7',
                    fontWeight: '500'
                  }}>
                    The professor hasn't created a rubric for this project yet. Please check back later or contact your professor for more information.
                  </p>
                </div>
              ) : projectRubricData?.error === 'fetch_error' ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  textAlign: 'center'
                }}>
                  <div style={{
                    marginBottom: '24px',
                    color: '#BE3144'
                  }}>
                    <FaExclamationTriangle size={64} />
                  </div>
                  <h3 style={{
                    fontSize: '22px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '12px'
                  }}>
                    Error Loading Rubric
                  </h3>
                  <p style={{
                    fontSize: '15px',
                    color: '#872341',
                    margin: 0,
                    maxWidth: '400px',
                    lineHeight: '1.7',
                    fontWeight: '500'
                  }}>
                    There was an error loading the rubric. Please try again later.
                  </p>
                </div>
              ) : (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  color: '#872341'
                }}>
                  <div style={{
                    marginBottom: '20px',
                    animation: 'spin 1s linear infinite'
                  }}>
                    <FaSpinner size={48} />
                  </div>
                  <p style={{ fontSize: '16px', margin: 0, fontWeight: '600' }}>Loading rubric data...</p>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '20px 24px',
              backgroundColor: '#ffffff',
              display: 'flex',
              justifyContent: 'flex-end',
              borderBottomLeftRadius: '12px',
              borderBottomRightRadius: '12px'
            }}>
              <button
                onClick={() => setShowProjectRubricModal(false)}
                style={{
                  padding: '12px 28px',
                  backgroundColor: '#872341',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '15px',
                  fontWeight: '700',
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  border: '2px solid #BE3144'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#BE3144';
                  e.currentTarget.style.transform = 'translateY(-2px)';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = '#872341';
                  e.currentTarget.style.transform = 'translateY(0)';
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Project Evaluation Modal */}
      {showProjectEvaluationModal && (selectedReportsProject || deliverablesView.selectedProject) && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(9, 18, 44, 0.75)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000,
          padding: '20px'
        }}
        onClick={() => setShowProjectEvaluationModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '800px',
            width: '100%',
            maxHeight: '90vh',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '0 20px 25px -5px rgba(9, 18, 44, 0.3), 0 10px 10px -5px rgba(135, 35, 65, 0.2)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              backgroundColor: '#ffffff',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              borderTopLeftRadius: '12px',
              borderTopRightRadius: '12px'
            }}>
              <h2 style={{
                fontSize: '24px',
                fontWeight: '700',
                color: '#09122C',
                margin: 0,
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                <FaClipboardCheck style={{ color: '#872341' }} />
                Project Evaluation Form - {(selectedReportsProject || deliverablesView.selectedProject)?.title}
              </h2>
              <button
                onClick={() => setShowProjectEvaluationModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  color: '#872341',
                  cursor: 'pointer',
                  padding: '8px',
                  width: '40px',
                  height: '40px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '8px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#BE3144';
                  e.currentTarget.style.color = '#ffffff';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.color = '#872341';
                }}
              >
                <FaTimes />
              </button>
            </div>

            {/* Modal Content */}
            <div style={{
              padding: '24px',
              overflowY: 'auto',
              flex: 1,
              backgroundColor: '#F9FAFB'
            }}>
              {projectEvaluationData ? (
                <div style={{
                  backgroundColor: 'white',
                  borderRadius: '8px',
                  padding: '24px',
                  border: '2px solid rgba(135, 35, 65, 0.15)'
                }}>
                  {/* Instructions */}
                  {projectEvaluationData.instructions && (
                    <div style={{
                      backgroundColor: 'rgba(225, 117, 100, 0.1)',
                      border: '2px solid rgba(225, 117, 100, 0.3)',
                      borderRadius: '8px',
                      padding: '16px',
                      marginBottom: '20px'
                    }}>
                      <h4 style={{
                        fontSize: '15px',
                        fontWeight: '700',
                        color: '#872341',
                        marginBottom: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <FaInfoCircle style={{ color: '#BE3144' }} />
                        Instructions
                      </h4>
                      <p style={{
                        fontSize: '15px',
                        color: '#09122C',
                        margin: 0,
                        lineHeight: '1.7',
                        fontWeight: '500'
                      }}>
                        {projectEvaluationData.instructions}
                      </p>
                    </div>
                  )}

                  {/* Total Points */}
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '24px',
                    padding: '16px 20px',
                    backgroundColor: '#09122C',
                    borderRadius: '10px',
                    border: '2px solid #872341'
                  }}>
                    <span style={{
                      fontSize: '18px',
                      fontWeight: '700',
                      color: '#ffffff',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      <FaStar style={{ color: '#E17564' }} />
                      Total Points:
                    </span>
                    <span style={{
                      fontSize: '28px',
                      fontWeight: '700',
                      color: '#ffffff'
                    }}>
                      {projectEvaluationData.total_points}
                    </span>
                  </div>

                  {/* Evaluation Criteria */}
                  <h3 style={{
                    fontSize: '20px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '20px',
                    paddingBottom: '12px',
                    borderBottom: '2px solid rgba(135, 35, 65, 0.2)'
                  }}>
                    Evaluation Criteria
                  </h3>
                  
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '16px'
                  }}>
                    {projectEvaluationData.criteria && projectEvaluationData.criteria.length > 0 ? (
                      projectEvaluationData.criteria
                        .sort((a, b) => a.order_index - b.order_index)
                        .map((criterion, index) => (
                          <div
                            key={criterion.id}
                            style={{
                              backgroundColor: 'rgba(9, 18, 44, 0.03)',
                              padding: '20px',
                              borderRadius: '10px',
                              border: '2px solid rgba(135, 35, 65, 0.2)',
                              transition: 'all 0.3s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.boxShadow = '0 8px 16px rgba(135, 35, 65, 0.2)';
                              e.currentTarget.style.borderColor = '#872341';
                              e.currentTarget.style.transform = 'translateY(-2px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.boxShadow = 'none';
                              e.currentTarget.style.borderColor = 'rgba(135, 35, 65, 0.2)';
                              e.currentTarget.style.transform = 'translateY(0)';
                            }}
                          >
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'flex-start',
                              marginBottom: '12px'
                            }}>
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                flex: 1
                              }}>
                                <span style={{
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  width: '36px',
                                  height: '36px',
                                  backgroundColor: '#872341',
                                  color: 'white',
                                  borderRadius: '50%',
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  flexShrink: 0,
                                  border: '2px solid #BE3144'
                                }}>
                                  {index + 1}
                                </span>
                                <h4 style={{
                                  fontSize: '18px',
                                  fontWeight: '700',
                                  color: '#09122C',
                                  margin: 0
                                }}>
                                  {criterion.name}
                                </h4>
                              </div>
                              <span style={{
                                display: 'inline-block',
                                padding: '8px 16px',
                                backgroundColor: '#BE3144',
                                color: 'white',
                                borderRadius: '20px',
                                fontSize: '14px',
                                fontWeight: '700',
                                flexShrink: 0,
                                marginLeft: '12px',
                                border: '2px solid #872341'
                              }}>
                                {criterion.max_points} pts
                              </span>
                            </div>
                            <p style={{
                              fontSize: '15px',
                              color: '#09122C',
                              margin: 0,
                              lineHeight: '1.7',
                              paddingLeft: '48px',
                              fontWeight: '500'
                            }}>
                              {criterion.description}
                            </p>
                          </div>
                        ))
                    ) : (
                      <div style={{
                        textAlign: 'center',
                        padding: '40px',
                        color: '#872341',
                        fontSize: '16px',
                        fontWeight: '600'
                      }}>
                        No criteria available
                      </div>
                    )}
                  </div>
                </div>
              ) : projectEvaluationData?.error === 'not_found' ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  textAlign: 'center'
                }}>
                  <div style={{
                    marginBottom: '24px',
                    color: '#872341'
                  }}>
                    <FaFileAlt size={64} />
                  </div>
                  <h3 style={{
                    fontSize: '22px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '12px'
                  }}>
                    No Evaluation Form Available
                  </h3>
                  <p style={{
                    fontSize: '15px',
                    color: '#872341',
                    margin: 0,
                    maxWidth: '400px',
                    lineHeight: '1.7',
                    fontWeight: '500'
                  }}>
                    The professor hasn't created an evaluation form for this project yet. Please check back later or contact your professor for more information.
                  </p>
                </div>
              ) : projectEvaluationData?.error === 'fetch_error' ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  textAlign: 'center'
                }}>
                  <div style={{
                    marginBottom: '24px',
                    color: '#BE3144'
                  }}>
                    <FaExclamationTriangle size={64} />
                  </div>
                  <h3 style={{
                    fontSize: '22px',
                    fontWeight: '700',
                    color: '#09122C',
                    marginBottom: '12px'
                  }}>
                    Error Loading Evaluation Form
                  </h3>
                  <p style={{
                    fontSize: '15px',
                    color: '#872341',
                    margin: 0,
                    maxWidth: '400px',
                    lineHeight: '1.7',
                    fontWeight: '500'
                  }}>
                    There was an error loading the evaluation form. Please try again later.
                  </p>
                </div>
              ) : (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '48px',
                  color: '#872341'
                }}>
                  <div style={{
                    marginBottom: '20px',
                    animation: 'spin 1s linear infinite'
                  }}>
                    <FaSpinner size={48} />
                  </div>
                  <p style={{ fontSize: '16px', margin: 0, fontWeight: '600' }}>Loading evaluation data...</p>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '20px 24px',
              backgroundColor: '#ffffff',
              display: 'flex',
              justifyContent: 'flex-end',
              borderBottomLeftRadius: '12px',
              borderBottomRightRadius: '12px'
            }}>
              <button
                onClick={() => setShowProjectEvaluationModal(false)}
                style={{
                  padding: '12px 28px',
                  backgroundColor: '#872341',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '15px',
                  fontWeight: '700',
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  border: '2px solid #BE3144'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.backgroundColor = '#BE3144';
                  e.currentTarget.style.transform = 'translateY(-2px)';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.backgroundColor = '#872341';
                  e.currentTarget.style.transform = 'translateY(0)';
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Member Evaluation Detail Modal */}
      {showMemberEvaluationModal && selectedMemberEvaluation && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000,
          padding: '20px'
        }}
        onClick={() => setShowMemberEvaluationModal(false)}
        >
          <div style={{
            backgroundColor: 'white',
            borderRadius: '12px',
            maxWidth: '700px',
            width: '100%',
            maxHeight: '90vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid #E5E7EB',
              backgroundColor: '#34656c'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '16px'
              }}>
                <div style={{
                  width: '60px',
                  height: '60px',
                  borderRadius: '50%',
                  overflow: 'hidden',
                  backgroundColor: '#E5E7EB',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  border: '3px solid white'
                }}>
                  {selectedMemberEvaluation.member?.profile_image_url ? (
                    <img
                      src={selectedMemberEvaluation.member.profile_image_url}
                      alt={`${selectedMemberEvaluation.member.first_name} ${selectedMemberEvaluation.member.last_name}`}
                      style={{
                        width: '100%',
                        height: '100%',
                        objectFit: 'cover'
                      }}
                    />
                  ) : (
                    <div style={{
                      fontSize: '24px',
                      fontWeight: '700',
                      color: '#6B7280'
                    }}>
                      {(selectedMemberEvaluation.member?.first_name || 'U').charAt(0).toUpperCase()}
                    </div>
                  )}
                </div>
                <div style={{ flex: 1 }}>
                  <h3 style={{
                    fontSize: '20px',
                    fontWeight: '600',
                    color: 'white',
                    margin: '0 0 4px 0'
                  }}>
                    Evaluation for {selectedMemberEvaluation.member?.first_name} {selectedMemberEvaluation.member?.last_name}
                  </h3>
                  <p style={{
                    fontSize: '13px',
                    color: 'rgba(255, 255, 255, 0.8)',
                    margin: 0
                  }}>
                    Submitted on {new Date(selectedMemberEvaluation.evaluation?.submission_date).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </p>
                </div>
              </div>
            </div>

            {/* Modal Content */}
            <div style={{
              padding: '24px',
              overflowY: 'auto',
              flex: 1
            }}>
              {selectedMemberEvaluation.evaluation?.evaluation_data ? (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '16px'
                }}>
                  {Object.keys(selectedMemberEvaluation.evaluation.evaluation_data).map((criterionId, idx) => {
                    const criterion = selectedMemberEvaluation.evaluation.evaluation_data[criterionId];
                    const score = parseFloat(criterion.score || 0);
                    const maxPoints = parseInt(criterion.maxPoints || 0);
                    const percentage = maxPoints > 0 ? ((score / maxPoints) * 100).toFixed(0) : 0;
                    
                    return (
                      <div key={criterionId} style={{
                        padding: '20px',
                        backgroundColor: '#F9FAFB',
                        border: '1px solid #E5E7EB',
                        borderRadius: '8px'
                      }}>
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          marginBottom: '12px'
                        }}>
                          <div style={{ flex: 1 }}>
                            <div style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px',
                              marginBottom: '8px'
                            }}>
                              <span style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                width: '28px',
                                height: '28px',
                                backgroundColor: '#34656c',
                                color: 'white',
                                borderRadius: '50%',
                                fontSize: '13px',
                                fontWeight: '700'
                              }}>
                                {idx + 1}
                              </span>
                              <span style={{
                                fontSize: '15px',
                                fontWeight: '600',
                                color: '#374151'
                              }}>
                                {criterion.name || `Criterion ${idx + 1}`}
                              </span>
                            </div>
                            {criterion.description && (
                              <p style={{
                                fontSize: '13px',
                                color: '#6B7280',
                                margin: '0 0 12px 36px',
                                lineHeight: '1.5'
                              }}>
                                {criterion.description}
                              </p>
                            )}
                          </div>
                          <div style={{
                            marginLeft: '16px',
                            textAlign: 'right'
                          }}>
                            <div style={{
                              fontSize: '24px',
                              fontWeight: '700',
                              color: percentage >= 80 ? '#10B981' : percentage >= 60 ? '#F59E0B' : '#EF4444',
                              marginBottom: '4px'
                            }}>
                              {score}/{maxPoints}
                            </div>
                            <div style={{
                              fontSize: '12px',
                              fontWeight: '600',
                              color: '#6B7280'
                            }}>
                              {percentage}%
                            </div>
                          </div>
                        </div>
                        
                        {/* Progress Bar */}
                        <div style={{
                          width: '100%',
                          height: '10px',
                          backgroundColor: '#E5E7EB',
                          borderRadius: '5px',
                          overflow: 'hidden',
                          marginLeft: '36px',
                          width: 'calc(100% - 36px)'
                        }}>
                          <div style={{
                            width: `${percentage}%`,
                            height: '100%',
                            backgroundColor: percentage >= 80 ? '#10B981' : percentage >= 60 ? '#F59E0B' : '#EF4444',
                            transition: 'width 0.3s ease'
                          }} />
                        </div>
                      </div>
                    );
                  })}
                  
                  {/* Total Score */}
                  <div style={{
                    marginTop: '8px',
                    padding: '20px',
                    backgroundColor: '#DBEAFE',
                    border: '2px solid #3B82F6',
                    borderRadius: '8px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <div style={{
                      fontSize: '16px',
                      fontWeight: '600',
                      color: '#1E40AF'
                    }}>
                      Total Score
                    </div>
                    <div style={{
                      fontSize: '28px',
                      fontWeight: '700',
                      color: '#1E40AF'
                    }}>
                      {(() => {
                        let total = 0;
                        let maxTotal = 0;
                        Object.keys(selectedMemberEvaluation.evaluation.evaluation_data).forEach(criterionId => {
                          const criterion = selectedMemberEvaluation.evaluation.evaluation_data[criterionId];
                          total += parseFloat(criterion.score || 0);
                          maxTotal += parseInt(criterion.maxPoints || 0);
                        });
                        return `${total.toFixed(1)}/${maxTotal}`;
                      })()}
                    </div>
                  </div>
                  
                  {/* Comments Section */}
                  {selectedMemberEvaluation.evaluation?.comments && (
                    <div style={{
                      marginTop: '8px',
                      padding: '20px',
                      backgroundColor: '#FEF3C7',
                      border: '1px solid #FCD34D',
                      borderRadius: '8px'
                    }}>
                      <div style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#92400E',
                        marginBottom: '8px'
                      }}>
                        üí¨ Comments
                      </div>
                      <p style={{
                        fontSize: '13px',
                        color: '#78350F',
                        margin: 0,
                        lineHeight: '1.6'
                      }}>
                        {selectedMemberEvaluation.evaluation.comments}
                      </p>
                    </div>
                  )}
                </div>
              ) : (
                <div style={{
                  textAlign: 'center',
                  padding: '40px',
                  color: '#9CA3AF'
                }}>
                  No evaluation data available
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: '1px solid #E5E7EB',
              display: 'flex',
              justifyContent: 'flex-end'
            }}>
              <button
                onClick={() => setShowMemberEvaluationModal(false)}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#34656c',
                  color: 'white',
                  border: 'none',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
                onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#2a5259'}
                onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#34656c'}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      </SidebarProvider>
      
      <style>{`
        .timeline-modal-content-styled::-webkit-scrollbar {
          width: 10px;
        }
        
        .timeline-modal-content-styled::-webkit-scrollbar-track {
          background: #f1f1f1;
          borderRadius: '6px';
        }
        
        .timeline-modal-content-styled::-webkit-scrollbar-thumb {
          background: #872341;
          borderRadius: '6px';
        }
        
        .timeline-modal-content-styled::-webkit-scrollbar-thumb:hover {
          background: #6b1a2f;
        }
        
        .timeline-modal-content-styled {
          scrollbar-color: #872341 #f1f1f1;
        }

        /* Extension Request Modal Styles */
        .extension-request-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10001;
          backdrop-filter: blur(4px);
        }

        .extension-request-modal-container {
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 600px;
          max-height: 85vh;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .extension-request-modal-header {
          padding: 1.5rem;
          border-bottom: 1px solid #e5e7eb;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f9fafb;
        }

        .extension-request-modal-header h2 {
          margin: 0;
          font-size: 1.5rem;
          font-weight: 600;
          color: #111827;
        }

        .extension-request-modal-close {
          width: 36px;
          height: 36px;
          border: none;
          border-radius: 8px;
          background: #ef4444;
          color: white;
          font-size: 1.5rem;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .extension-request-modal-close:hover {
          background: #dc2626;
        }

        .extension-request-modal-body {
          padding: 1.5rem;
          overflow-y: auto;
          flex: 1;
        }

        .extension-request-task-info {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 1rem;
          margin-bottom: 1.5rem;
        }

        .extension-request-task-info h3 {
          margin: 0 0 0.75rem 0;
          font-size: 1.125rem;
          font-weight: 600;
          color: #111827;
        }

        .extension-request-task-info p {
          margin: 0.5rem 0;
          font-size: 0.875rem;
          color: #374151;
        }

        .extension-request-form {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .extension-request-form label {
          font-size: 0.875rem;
          font-weight: 500;
          color: #374151;
        }

        .required-field {
          color: #ef4444;
          margin-left: 0.25rem;
        }

        .extension-request-textarea {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          font-size: 0.875rem;
          font-family: inherit;
          resize: vertical;
          min-height: 120px;
          transition: all 0.2s ease;
        }

        .extension-request-textarea:focus {
          outline: none;
          border-color: #34656D;
          box-shadow: 0 0 0 3px rgba(52, 101, 109, 0.1);
        }

        .extension-request-textarea:disabled {
          background: #f3f4f6;
          cursor: not-allowed;
        }

        .extension-request-char-count {
          text-align: right;
          font-size: 0.75rem;
          color: #6b7280;
        }

        .extension-request-modal-footer {
          padding: 1rem 1.5rem;
          border-top: 1px solid #e5e7eb;
          display: flex;
          gap: 1rem;
          justify-content: flex-end;
          background: #f9fafb;
        }

        .extension-request-cancel-btn {
          padding: 0.625rem 1.25rem;
          background: white;
          color: #374151;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          font-size: 0.875rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .extension-request-cancel-btn:hover {
          background: #f3f4f6;
        }

        .extension-request-cancel-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .extension-request-submit-btn {
          padding: 0.625rem 1.25rem;
          background: #f59e0b;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 0.875rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .extension-request-submit-btn:hover {
          background: #d97706;
        }

        .extension-request-submit-btn:disabled {
          background: #9ca3af;
          cursor: not-allowed;
        }
      `}</style>
    </div>
  );
};

export default CourseStudentDashboard;
